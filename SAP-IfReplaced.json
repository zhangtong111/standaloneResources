{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "location": {
            "defaultValue": "[resourceGroup().location]",
            "minLength": 1,
            "type": "String",
            "metadata": {
                "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
            }
        },
        "workspace-location": {
            "defaultValue": "",
            "type": "String",
            "metadata": {
                "description": "[concat('Region to deploy solution resources -- separate from location selection',parameters('location'))]"
            }
        },
        "workspace": {
            "defaultValue": "",
            "type": "String",
            "metadata": {
                "description": "Workspace name for Log Analytics where Microsoft Sentinel is setup"
            }
        },
        "workbook1-name": {
            "defaultValue": "SAP -Audit Controls",
            "minLength": 1,
            "type": "String",
            "metadata": {
                "description": "Name for the workbook"
            }
        },
        "workbook2-name": {
            "defaultValue": "SAP -Monitors- Alerts and Performance",
            "minLength": 1,
            "type": "String",
            "metadata": {
                "description": "Name for the workbook"
            }
        },
        "workbook3-name": {
            "defaultValue": "SAP -Security Audit log and Initial Access",
            "minLength": 1,
            "type": "String",
            "metadata": {
                "description": "Name for the workbook"
            }
        },
        "CWSQSOCIdentifier": {
            "defaultValue": "",
            "type": "String",
            "metadata": {
                "description": "SOC data"
            }
        },
        "CWSQSAPIdentifier": {
            "defaultValue": "",
            "type": "String",
            "metadata": {
                "description": "SAP data"
            }
        },
        "wl_1_creation_required": {
            "defaultValue": true,
            "type": "Bool"
        },
        "wl_2_creation_required": {
            "defaultValue": true,
            "type": "Bool"
        },
        "wl_3_creation_required": {
            "defaultValue": true,
            "type": "Bool"
        },
        "wl_4_creation_required": {
            "defaultValue": true,
            "type": "Bool"
        },
        "wl_5_creation_required": {
            "defaultValue": true,
            "type": "Bool"
        },
        "wl_6_creation_required": {
            "defaultValue": true,
            "type": "Bool"
        },
        "wl_7_creation_required": {
            "defaultValue": true,
            "type": "Bool"
        },
        "wl_8_creation_required": {
            "defaultValue": true,
            "type": "Bool"
        },
        "wl_9_creation_required": {
            "defaultValue": true,
            "type": "Bool"
        },
        "wl_10_creation_required": {
            "defaultValue": true,
            "type": "Bool"
        },
        "wl_11_creation_required": {
            "defaultValue": true,
            "type": "Bool"
        },
        "wl_12_creation_required": {
            "defaultValue": true,
            "type": "Bool"
        },
        "wl_13_creation_required": {
            "defaultValue": true,
            "type": "Bool"
        },
        "wl_14_creation_required": {
            "defaultValue": true,
            "type": "Bool"
        },
        "wl_15_creation_required": {
            "defaultValue": true,
            "type": "Bool"
        },
        "wl_16_creation_required": {
            "defaultValue": true,
            "type": "Bool"
        },
        "wl_17_creation_required": {
            "defaultValue": true,
            "type": "Bool"
        },
        "wl_18_creation_required": {
            "defaultValue": true,
            "type": "Bool"
        },
        "wl_19_creation_required": {
            "defaultValue": true,
            "type": "Bool"
        },
        "wl_20_creation_required": {
            "defaultValue": true,
            "type": "Bool"
        },
        "wl_21_creation_required": {
            "defaultValue": true,
            "type": "Bool"
        }
    },
    "variables": {
        "email": "support@microsoft.com",
        "_email": "[variables('email')]",
        "_solutionName": "SAP",
        "_solutionVersion": "3.0.0",
        "solutionId": "sentinel4sap.sentinel4sap",
        "_solutionId": "[variables('solutionId')]",
        "_uiConfigId1": "SAP",
        "_dataConnectorContentId1": "SAP",
        "dataConnectorId1": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentId1'))]",
        "_dataConnectorId1": "[variables('dataConnectorId1')]",
        "dataConnectorTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentId1'))))]",
        "dataConnectorVersion1": "1.0.0",
        "_dataConnectorcontentProductId1": "[concat(take(variables('_solutionId'),50),'-','dc','-', uniqueString(concat(variables('_solutionId'),'-','DataConnector','-',variables('_dataConnectorContentId1'),'-', variables('dataConnectorVersion1'))))]",
        "workbookVersion1": "2.0.4",
        "workbookContentId1": "SAP-AuditControls",
        "workbookId1": "[resourceId('Microsoft.Insights/workbooks', variables('workbookContentId1'))]",
        "workbookTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-wb-',uniquestring(variables('_workbookContentId1'))))]",
        "_workbookContentId1": "[variables('workbookContentId1')]",
        "workspaceResourceId": "[resourceId('microsoft.OperationalInsights/Workspaces', parameters('workspace'))]",
        "_workbookcontentProductId1": "[concat(take(variables('_solutionId'),50),'-','wb','-', uniqueString(concat(variables('_solutionId'),'-','Workbook','-',variables('_workbookContentId1'),'-', variables('workbookVersion1'))))]",
        "workbookVersion2": "2.0.1",
        "workbookContentId2": "SAP-Monitors-AlertsandPerformance",
        "workbookId2": "[resourceId('Microsoft.Insights/workbooks', variables('workbookContentId2'))]",
        "workbookTemplateSpecName2": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-wb-',uniquestring(variables('_workbookContentId2'))))]",
        "_workbookContentId2": "[variables('workbookContentId2')]",
        "_workbookcontentProductId2": "[concat(take(variables('_solutionId'),50),'-','wb','-', uniqueString(concat(variables('_solutionId'),'-','Workbook','-',variables('_workbookContentId2'),'-', variables('workbookVersion2'))))]",
        "workbookVersion3": "2.0.1",
        "workbookContentId3": "SAP-SecurityAuditlogandInitialAccess",
        "workbookId3": "[resourceId('Microsoft.Insights/workbooks', variables('workbookContentId3'))]",
        "workbookTemplateSpecName3": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-wb-',uniquestring(variables('_workbookContentId3'))))]",
        "_workbookContentId3": "[variables('workbookContentId3')]",
        "_workbookcontentProductId3": "[concat(take(variables('_solutionId'),50),'-','wb','-', uniqueString(concat(variables('_solutionId'),'-','Workbook','-',variables('_workbookContentId3'),'-', variables('workbookVersion3'))))]",
        "analyticRuleObject1": {
            "analyticRuleVersion1": "2.0.67",
            "_analyticRulecontentId1": "7c2d366a-1cb8-41f3-9b0b-a5c469ad467e",
            "analyticRuleId1": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '7c2d366a-1cb8-41f3-9b0b-a5c469ad467e')]",
            "analyticRuleTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('7c2d366a-1cb8-41f3-9b0b-a5c469ad467e')))]",
            "_analyticRulecontentProductId1": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','7c2d366a-1cb8-41f3-9b0b-a5c469ad467e','-', '2.0.67')))]"
        },
        "analyticRuleObject2": {
            "analyticRuleVersion2": "2.0.67",
            "_analyticRulecontentId2": "6e60e742-aef0-47aa-95e5-36a100a4272d",
            "analyticRuleId2": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '6e60e742-aef0-47aa-95e5-36a100a4272d')]",
            "analyticRuleTemplateSpecName2": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('6e60e742-aef0-47aa-95e5-36a100a4272d')))]",
            "_analyticRulecontentProductId2": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','6e60e742-aef0-47aa-95e5-36a100a4272d','-', '2.0.67')))]"
        },
        "analyticRuleObject3": {
            "analyticRuleVersion3": "2.0.67",
            "_analyticRulecontentId3": "4329c5d1-7062-4ec4-8ab8-29846e0e0d9a",
            "analyticRuleId3": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '4329c5d1-7062-4ec4-8ab8-29846e0e0d9a')]",
            "analyticRuleTemplateSpecName3": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('4329c5d1-7062-4ec4-8ab8-29846e0e0d9a')))]",
            "_analyticRulecontentProductId3": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','4329c5d1-7062-4ec4-8ab8-29846e0e0d9a','-', '2.0.67')))]"
        },
        "analyticRuleObject4": {
            "analyticRuleVersion4": "2.0.67",
            "_analyticRulecontentId4": "49fd3399-67c5-47bf-bb61-8b6efa27a5fe",
            "analyticRuleId4": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '49fd3399-67c5-47bf-bb61-8b6efa27a5fe')]",
            "analyticRuleTemplateSpecName4": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('49fd3399-67c5-47bf-bb61-8b6efa27a5fe')))]",
            "_analyticRulecontentProductId4": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','49fd3399-67c5-47bf-bb61-8b6efa27a5fe','-', '2.0.67')))]"
        },
        "analyticRuleObject5": {
            "analyticRuleVersion5": "2.0.67",
            "_analyticRulecontentId5": "5f152aa1-f82c-4789-8dea-d63d7d6bf96b",
            "analyticRuleId5": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '5f152aa1-f82c-4789-8dea-d63d7d6bf96b')]",
            "analyticRuleTemplateSpecName5": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('5f152aa1-f82c-4789-8dea-d63d7d6bf96b')))]",
            "_analyticRulecontentProductId5": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','5f152aa1-f82c-4789-8dea-d63d7d6bf96b','-', '2.0.67')))]"
        },
        "analyticRuleObject6": {
            "analyticRuleVersion6": "2.0.67",
            "_analyticRulecontentId6": "2d7cbb53-cb18-4c9e-8855-c5393aa91db0",
            "analyticRuleId6": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '2d7cbb53-cb18-4c9e-8855-c5393aa91db0')]",
            "analyticRuleTemplateSpecName6": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('2d7cbb53-cb18-4c9e-8855-c5393aa91db0')))]",
            "_analyticRulecontentProductId6": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','2d7cbb53-cb18-4c9e-8855-c5393aa91db0','-', '2.0.67')))]"
        },
        "analyticRuleObject7": {
            "analyticRuleVersion7": "2.0.67",
            "_analyticRulecontentId7": "fe14e4b9-8616-4741-bf6c-2936d30afa65",
            "analyticRuleId7": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'fe14e4b9-8616-4741-bf6c-2936d30afa65')]",
            "analyticRuleTemplateSpecName7": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('fe14e4b9-8616-4741-bf6c-2936d30afa65')))]",
            "_analyticRulecontentProductId7": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','fe14e4b9-8616-4741-bf6c-2936d30afa65','-', '2.0.67')))]"
        },
        "analyticRuleObject8": {
            "analyticRuleVersion8": "2.0.67",
            "_analyticRulecontentId8": "7e5e321a-f6df-434d-b1be-a8d74f696481",
            "analyticRuleId8": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '7e5e321a-f6df-434d-b1be-a8d74f696481')]",
            "analyticRuleTemplateSpecName8": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('7e5e321a-f6df-434d-b1be-a8d74f696481')))]",
            "_analyticRulecontentProductId8": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','7e5e321a-f6df-434d-b1be-a8d74f696481','-', '2.0.67')))]"
        },
        "analyticRuleObject9": {
            "analyticRuleVersion9": "2.0.67",
            "_analyticRulecontentId9": "3ba35622-3071-477e-9af9-5380bce25e1e",
            "analyticRuleId9": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '3ba35622-3071-477e-9af9-5380bce25e1e')]",
            "analyticRuleTemplateSpecName9": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('3ba35622-3071-477e-9af9-5380bce25e1e')))]",
            "_analyticRulecontentProductId9": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','3ba35622-3071-477e-9af9-5380bce25e1e','-', '2.0.67')))]"
        },
        "analyticRuleObject10": {
            "analyticRuleVersion10": "2.0.74",
            "_analyticRulecontentId10": "a4dee43c-f06e-4f6f-8735-db6dec4c5aa3",
            "analyticRuleId10": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'a4dee43c-f06e-4f6f-8735-db6dec4c5aa3')]",
            "analyticRuleTemplateSpecName10": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('a4dee43c-f06e-4f6f-8735-db6dec4c5aa3')))]",
            "_analyticRulecontentProductId10": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','a4dee43c-f06e-4f6f-8735-db6dec4c5aa3','-', '2.0.74')))]"
        },
        "analyticRuleObject11": {
            "analyticRuleVersion11": "2.0.67",
            "_analyticRulecontentId11": "49f11dc5-03c9-4ea3-83ee-33434b42e699",
            "analyticRuleId11": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '49f11dc5-03c9-4ea3-83ee-33434b42e699')]",
            "analyticRuleTemplateSpecName11": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('49f11dc5-03c9-4ea3-83ee-33434b42e699')))]",
            "_analyticRulecontentProductId11": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','49f11dc5-03c9-4ea3-83ee-33434b42e699','-', '2.0.67')))]"
        },
        "analyticRuleObject12": {
            "analyticRuleVersion12": "2.0.67",
            "_analyticRulecontentId12": "bde3ff9b-2b5d-4aec-8402-ac2f9dbbca7e",
            "analyticRuleId12": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'bde3ff9b-2b5d-4aec-8402-ac2f9dbbca7e')]",
            "analyticRuleTemplateSpecName12": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('bde3ff9b-2b5d-4aec-8402-ac2f9dbbca7e')))]",
            "_analyticRulecontentProductId12": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','bde3ff9b-2b5d-4aec-8402-ac2f9dbbca7e','-', '2.0.67')))]"
        },
        "analyticRuleObject13": {
            "analyticRuleVersion13": "2.0.67",
            "_analyticRulecontentId13": "870d9ea0-cd99-4644-9c7a-d7256b0b37e0",
            "analyticRuleId13": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '870d9ea0-cd99-4644-9c7a-d7256b0b37e0')]",
            "analyticRuleTemplateSpecName13": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('870d9ea0-cd99-4644-9c7a-d7256b0b37e0')))]",
            "_analyticRulecontentProductId13": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','870d9ea0-cd99-4644-9c7a-d7256b0b37e0','-', '2.0.67')))]"
        },
        "analyticRuleObject14": {
            "analyticRuleVersion14": "2.0.67",
            "_analyticRulecontentId14": "e35db198-2146-446c-8eb7-a77b6344f1d7",
            "analyticRuleId14": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'e35db198-2146-446c-8eb7-a77b6344f1d7')]",
            "analyticRuleTemplateSpecName14": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('e35db198-2146-446c-8eb7-a77b6344f1d7')))]",
            "_analyticRulecontentProductId14": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','e35db198-2146-446c-8eb7-a77b6344f1d7','-', '2.0.67')))]"
        },
        "analyticRuleObject15": {
            "analyticRuleVersion15": "2.0.67",
            "_analyticRulecontentId15": "e704b794-2f22-417a-b3ac-25e6037e2717",
            "analyticRuleId15": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'e704b794-2f22-417a-b3ac-25e6037e2717')]",
            "analyticRuleTemplateSpecName15": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('e704b794-2f22-417a-b3ac-25e6037e2717')))]",
            "_analyticRulecontentProductId15": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','e704b794-2f22-417a-b3ac-25e6037e2717','-', '2.0.67')))]"
        },
        "analyticRuleObject16": {
            "analyticRuleVersion16": "2.0.67",
            "_analyticRulecontentId16": "4e228f1a-55cc-4abc-8ef4-5e385b60f9c0",
            "analyticRuleId16": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '4e228f1a-55cc-4abc-8ef4-5e385b60f9c0')]",
            "analyticRuleTemplateSpecName16": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('4e228f1a-55cc-4abc-8ef4-5e385b60f9c0')))]",
            "_analyticRulecontentProductId16": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','4e228f1a-55cc-4abc-8ef4-5e385b60f9c0','-', '2.0.67')))]"
        },
        "analyticRuleObject17": {
            "analyticRuleVersion17": "3.0.0",
            "_analyticRulecontentId17": "03b9a2cf-8434-44ad-b42f-9a35701f1c2a",
            "analyticRuleId17": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '03b9a2cf-8434-44ad-b42f-9a35701f1c2a')]",
            "analyticRuleTemplateSpecName17": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('03b9a2cf-8434-44ad-b42f-9a35701f1c2a')))]",
            "_analyticRulecontentProductId17": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','03b9a2cf-8434-44ad-b42f-9a35701f1c2a','-', '3.0.0')))]"
        },
        "analyticRuleObject18": {
            "analyticRuleVersion18": "2.0.67",
            "_analyticRulecontentId18": "c2cc3901-d6bd-4189-bb5f-ab464dcfd079",
            "analyticRuleId18": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'c2cc3901-d6bd-4189-bb5f-ab464dcfd079')]",
            "analyticRuleTemplateSpecName18": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('c2cc3901-d6bd-4189-bb5f-ab464dcfd079')))]",
            "_analyticRulecontentProductId18": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','c2cc3901-d6bd-4189-bb5f-ab464dcfd079','-', '2.0.67')))]"
        },
        "analyticRuleObject19": {
            "analyticRuleVersion19": "2.0.67",
            "_analyticRulecontentId19": "3eab4a41-1d7b-453d-8631-a7d74936973b",
            "analyticRuleId19": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '3eab4a41-1d7b-453d-8631-a7d74936973b')]",
            "analyticRuleTemplateSpecName19": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('3eab4a41-1d7b-453d-8631-a7d74936973b')))]",
            "_analyticRulecontentProductId19": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','3eab4a41-1d7b-453d-8631-a7d74936973b','-', '2.0.67')))]"
        },
        "analyticRuleObject20": {
            "analyticRuleVersion20": "2.0.67",
            "_analyticRulecontentId20": "4258c51d-59db-4502-9b02-fb2ab20e97d4",
            "analyticRuleId20": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '4258c51d-59db-4502-9b02-fb2ab20e97d4')]",
            "analyticRuleTemplateSpecName20": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('4258c51d-59db-4502-9b02-fb2ab20e97d4')))]",
            "_analyticRulecontentProductId20": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','4258c51d-59db-4502-9b02-fb2ab20e97d4','-', '2.0.67')))]"
        },
        "analyticRuleObject21": {
            "analyticRuleVersion21": "2.0.67",
            "_analyticRulecontentId21": "8f9b9576-d0cd-43da-8ea2-d77366d4a70d",
            "analyticRuleId21": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '8f9b9576-d0cd-43da-8ea2-d77366d4a70d')]",
            "analyticRuleTemplateSpecName21": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('8f9b9576-d0cd-43da-8ea2-d77366d4a70d')))]",
            "_analyticRulecontentProductId21": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','8f9b9576-d0cd-43da-8ea2-d77366d4a70d','-', '2.0.67')))]"
        },
        "analyticRuleObject22": {
            "analyticRuleVersion22": "2.0.67",
            "_analyticRulecontentId22": "2af909e9-9c84-4198-b8c7-e80fe9f00ffb",
            "analyticRuleId22": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '2af909e9-9c84-4198-b8c7-e80fe9f00ffb')]",
            "analyticRuleTemplateSpecName22": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('2af909e9-9c84-4198-b8c7-e80fe9f00ffb')))]",
            "_analyticRulecontentProductId22": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','2af909e9-9c84-4198-b8c7-e80fe9f00ffb','-', '2.0.67')))]"
        },
        "analyticRuleObject23": {
            "analyticRuleVersion23": "2.0.67",
            "_analyticRulecontentId23": "9a55136c-fa19-46d4-9376-17c8f96cc2b8",
            "analyticRuleId23": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '9a55136c-fa19-46d4-9376-17c8f96cc2b8')]",
            "analyticRuleTemplateSpecName23": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('9a55136c-fa19-46d4-9376-17c8f96cc2b8')))]",
            "_analyticRulecontentProductId23": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','9a55136c-fa19-46d4-9376-17c8f96cc2b8','-', '2.0.67')))]"
        },
        "analyticRuleObject24": {
            "analyticRuleVersion24": "2.0.67",
            "_analyticRulecontentId24": "45fb7bf5-783b-4a87-897d-b26f5574186b",
            "analyticRuleId24": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '45fb7bf5-783b-4a87-897d-b26f5574186b')]",
            "analyticRuleTemplateSpecName24": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('45fb7bf5-783b-4a87-897d-b26f5574186b')))]",
            "_analyticRulecontentProductId24": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','45fb7bf5-783b-4a87-897d-b26f5574186b','-', '2.0.67')))]"
        },
        "analyticRuleObject25": {
            "analyticRuleVersion25": "2.0.67",
            "_analyticRulecontentId25": "a7babb63-a466-4ec7-a056-a213555f18df",
            "analyticRuleId25": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'a7babb63-a466-4ec7-a056-a213555f18df')]",
            "analyticRuleTemplateSpecName25": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('a7babb63-a466-4ec7-a056-a213555f18df')))]",
            "_analyticRulecontentProductId25": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','a7babb63-a466-4ec7-a056-a213555f18df','-', '2.0.67')))]"
        },
        "analyticRuleObject26": {
            "analyticRuleVersion26": "2.0.67",
            "_analyticRulecontentId26": "db123b5e-bcc2-43a5-9e13-8ac1e1a3c530",
            "analyticRuleId26": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'db123b5e-bcc2-43a5-9e13-8ac1e1a3c530')]",
            "analyticRuleTemplateSpecName26": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('db123b5e-bcc2-43a5-9e13-8ac1e1a3c530')))]",
            "_analyticRulecontentProductId26": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','db123b5e-bcc2-43a5-9e13-8ac1e1a3c530','-', '2.0.67')))]"
        },
        "analyticRuleObject27": {
            "analyticRuleVersion27": "2.0.67",
            "_analyticRulecontentId27": "fd655ec6-cb11-4e79-a825-0935a66596c8",
            "analyticRuleId27": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'fd655ec6-cb11-4e79-a825-0935a66596c8')]",
            "analyticRuleTemplateSpecName27": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('fd655ec6-cb11-4e79-a825-0935a66596c8')))]",
            "_analyticRulecontentProductId27": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','fd655ec6-cb11-4e79-a825-0935a66596c8','-', '2.0.67')))]"
        },
        "analyticRuleObject28": {
            "analyticRuleVersion28": "2.0.67",
            "_analyticRulecontentId28": "68a03140-24bc-4985-8b77-ca5cc8aadeda",
            "analyticRuleId28": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '68a03140-24bc-4985-8b77-ca5cc8aadeda')]",
            "analyticRuleTemplateSpecName28": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('68a03140-24bc-4985-8b77-ca5cc8aadeda')))]",
            "_analyticRulecontentProductId28": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','68a03140-24bc-4985-8b77-ca5cc8aadeda','-', '2.0.67')))]"
        },
        "analyticRuleObject29": {
            "analyticRuleVersion29": "2.0.67",
            "_analyticRulecontentId29": "57e99014-746b-4696-ae6a-447aecc9e800",
            "analyticRuleId29": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '57e99014-746b-4696-ae6a-447aecc9e800')]",
            "analyticRuleTemplateSpecName29": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('57e99014-746b-4696-ae6a-447aecc9e800')))]",
            "_analyticRulecontentProductId29": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','57e99014-746b-4696-ae6a-447aecc9e800','-', '2.0.67')))]"
        },
        "analyticRuleObject30": {
            "analyticRuleVersion30": "2.0.67",
            "_analyticRulecontentId30": "d940bee2-46ff-4bb5-869a-1a54a967977d",
            "analyticRuleId30": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'd940bee2-46ff-4bb5-869a-1a54a967977d')]",
            "analyticRuleTemplateSpecName30": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('d940bee2-46ff-4bb5-869a-1a54a967977d')))]",
            "_analyticRulecontentProductId30": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','d940bee2-46ff-4bb5-869a-1a54a967977d','-', '2.0.67')))]"
        },
        "analyticRuleObject31": {
            "analyticRuleVersion31": "2.0.67",
            "_analyticRulecontentId31": "e0e53cb9-d3f4-47c3-b953-ad62a8414f4f",
            "analyticRuleId31": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'e0e53cb9-d3f4-47c3-b953-ad62a8414f4f')]",
            "analyticRuleTemplateSpecName31": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('e0e53cb9-d3f4-47c3-b953-ad62a8414f4f')))]",
            "_analyticRulecontentProductId31": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','e0e53cb9-d3f4-47c3-b953-ad62a8414f4f','-', '2.0.67')))]"
        },
        "analyticRuleObject32": {
            "analyticRuleVersion32": "2.0.67",
            "_analyticRulecontentId32": "797db008-0a53-4510-9883-b32673f9c3f5",
            "analyticRuleId32": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '797db008-0a53-4510-9883-b32673f9c3f5')]",
            "analyticRuleTemplateSpecName32": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('797db008-0a53-4510-9883-b32673f9c3f5')))]",
            "_analyticRulecontentProductId32": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','797db008-0a53-4510-9883-b32673f9c3f5','-', '2.0.67')))]"
        },
        "analyticRuleObject33": {
            "analyticRuleVersion33": "2.0.67",
            "_analyticRulecontentId33": "45e784d5-0414-4029-8fc6-5f6722abdb5c",
            "analyticRuleId33": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '45e784d5-0414-4029-8fc6-5f6722abdb5c')]",
            "analyticRuleTemplateSpecName33": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('45e784d5-0414-4029-8fc6-5f6722abdb5c')))]",
            "_analyticRulecontentProductId33": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','45e784d5-0414-4029-8fc6-5f6722abdb5c','-', '2.0.67')))]"
        },
        "analyticRuleObject34": {
            "analyticRuleVersion34": "2.0.67",
            "_analyticRulecontentId34": "6a6ff9e7-b167-49a1-bff8-00dadf62b34c",
            "analyticRuleId34": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '6a6ff9e7-b167-49a1-bff8-00dadf62b34c')]",
            "analyticRuleTemplateSpecName34": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('6a6ff9e7-b167-49a1-bff8-00dadf62b34c')))]",
            "_analyticRulecontentProductId34": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','6a6ff9e7-b167-49a1-bff8-00dadf62b34c','-', '2.0.67')))]"
        },
        "analyticRuleObject35": {
            "analyticRuleVersion35": "2.0.67",
            "_analyticRulecontentId35": "bd39a2f0-2eaa-41e6-a071-70c42e42dd21",
            "analyticRuleId35": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'bd39a2f0-2eaa-41e6-a071-70c42e42dd21')]",
            "analyticRuleTemplateSpecName35": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('bd39a2f0-2eaa-41e6-a071-70c42e42dd21')))]",
            "_analyticRulecontentProductId35": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','bd39a2f0-2eaa-41e6-a071-70c42e42dd21','-', '2.0.67')))]"
        },
        "analyticRuleObject36": {
            "analyticRuleVersion36": "2.0.67",
            "_analyticRulecontentId36": "7e6cb00d-d7cb-4411-837f-6e62c2fab6e7",
            "analyticRuleId36": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '7e6cb00d-d7cb-4411-837f-6e62c2fab6e7')]",
            "analyticRuleTemplateSpecName36": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('7e6cb00d-d7cb-4411-837f-6e62c2fab6e7')))]",
            "_analyticRulecontentProductId36": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','7e6cb00d-d7cb-4411-837f-6e62c2fab6e7','-', '2.0.67')))]"
        },
        "analyticRuleObject37": {
            "analyticRuleVersion37": "2.0.67",
            "_analyticRulecontentId37": "78fbdc7d-6136-4afc-9cc5-5e5aff1563ae",
            "analyticRuleId37": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '78fbdc7d-6136-4afc-9cc5-5e5aff1563ae')]",
            "analyticRuleTemplateSpecName37": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('78fbdc7d-6136-4afc-9cc5-5e5aff1563ae')))]",
            "_analyticRulecontentProductId37": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','78fbdc7d-6136-4afc-9cc5-5e5aff1563ae','-', '2.0.67')))]"
        },
        "analyticRuleObject38": {
            "analyticRuleVersion38": "2.0.67",
            "_analyticRulecontentId38": "7f364fac-c6a9-4935-a73b-ba215acace31",
            "analyticRuleId38": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '7f364fac-c6a9-4935-a73b-ba215acace31')]",
            "analyticRuleTemplateSpecName38": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('7f364fac-c6a9-4935-a73b-ba215acace31')))]",
            "_analyticRulecontentProductId38": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','7f364fac-c6a9-4935-a73b-ba215acace31','-', '2.0.67')))]"
        },
        "analyticRuleObject39": {
            "analyticRuleVersion39": "2.0.67",
            "_analyticRulecontentId39": "978e1cc8-f891-41c7-83b8-b21762a2ebb7",
            "analyticRuleId39": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '978e1cc8-f891-41c7-83b8-b21762a2ebb7')]",
            "analyticRuleTemplateSpecName39": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('978e1cc8-f891-41c7-83b8-b21762a2ebb7')))]",
            "_analyticRulecontentProductId39": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','978e1cc8-f891-41c7-83b8-b21762a2ebb7','-', '2.0.67')))]"
        },
        "analyticRuleObject40": {
            "analyticRuleVersion40": "2.0.67",
            "_analyticRulecontentId40": "b0594a30-5da4-4eca-89af-cb8ad111d697",
            "analyticRuleId40": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'b0594a30-5da4-4eca-89af-cb8ad111d697')]",
            "analyticRuleTemplateSpecName40": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('b0594a30-5da4-4eca-89af-cb8ad111d697')))]",
            "_analyticRulecontentProductId40": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','b0594a30-5da4-4eca-89af-cb8ad111d697','-', '2.0.67')))]"
        },
        "analyticRuleObject41": {
            "analyticRuleVersion41": "2.0.67",
            "_analyticRulecontentId41": "4285d707-f969-4a8c-801f-e9c6a328d884",
            "analyticRuleId41": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '4285d707-f969-4a8c-801f-e9c6a328d884')]",
            "analyticRuleTemplateSpecName41": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('4285d707-f969-4a8c-801f-e9c6a328d884')))]",
            "_analyticRulecontentProductId41": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','4285d707-f969-4a8c-801f-e9c6a328d884','-', '2.0.67')))]"
        },
        "analyticRuleObject42": {
            "analyticRuleVersion42": "2.0.67",
            "_analyticRulecontentId42": "e5a176ef-dd12-47a3-a5ef-1900997f1b17",
            "analyticRuleId42": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'e5a176ef-dd12-47a3-a5ef-1900997f1b17')]",
            "analyticRuleTemplateSpecName42": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('e5a176ef-dd12-47a3-a5ef-1900997f1b17')))]",
            "_analyticRulecontentProductId42": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','e5a176ef-dd12-47a3-a5ef-1900997f1b17','-', '2.0.67')))]"
        },
        "analyticRuleObject43": {
            "analyticRuleVersion43": "3.0.0",
            "_analyticRulecontentId43": "c01c6b88-6323-4a71-b981-4bc0ddca88bf",
            "analyticRuleId43": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'c01c6b88-6323-4a71-b981-4bc0ddca88bf')]",
            "analyticRuleTemplateSpecName43": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('c01c6b88-6323-4a71-b981-4bc0ddca88bf')))]",
            "_analyticRulecontentProductId43": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','c01c6b88-6323-4a71-b981-4bc0ddca88bf','-', '3.0.0')))]"
        },
        "analyticRuleObject44": {
            "analyticRuleVersion44": "2.0.67",
            "_analyticRulecontentId44": "dfbcb26d-7b53-41f8-9647-1e158722a80e",
            "analyticRuleId44": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'dfbcb26d-7b53-41f8-9647-1e158722a80e')]",
            "analyticRuleTemplateSpecName44": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('dfbcb26d-7b53-41f8-9647-1e158722a80e')))]",
            "_analyticRulecontentProductId44": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','dfbcb26d-7b53-41f8-9647-1e158722a80e','-', '2.0.67')))]"
        },
        "analyticRuleObject45": {
            "analyticRuleVersion45": "2.0.67",
            "_analyticRulecontentId45": "c123a8d7-f72f-4ba0-8b06-ba5e12043432",
            "analyticRuleId45": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'c123a8d7-f72f-4ba0-8b06-ba5e12043432')]",
            "analyticRuleTemplateSpecName45": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('c123a8d7-f72f-4ba0-8b06-ba5e12043432')))]",
            "_analyticRulecontentProductId45": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','c123a8d7-f72f-4ba0-8b06-ba5e12043432','-', '2.0.67')))]"
        },
        "analyticRuleObject46": {
            "analyticRuleVersion46": "2.0.67",
            "_analyticRulecontentId46": "0079fee8-1ebf-4721-92c2-ac1861a79626",
            "analyticRuleId46": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '0079fee8-1ebf-4721-92c2-ac1861a79626')]",
            "analyticRuleTemplateSpecName46": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('0079fee8-1ebf-4721-92c2-ac1861a79626')))]",
            "_analyticRulecontentProductId46": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','0079fee8-1ebf-4721-92c2-ac1861a79626','-', '2.0.67')))]"
        },
        "analyticRuleObject47": {
            "analyticRuleVersion47": "2.0.67",
            "_analyticRulecontentId47": "45ae0492-fe7d-4ba8-addd-ca984ea30bc1",
            "analyticRuleId47": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '45ae0492-fe7d-4ba8-addd-ca984ea30bc1')]",
            "analyticRuleTemplateSpecName47": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('45ae0492-fe7d-4ba8-addd-ca984ea30bc1')))]",
            "_analyticRulecontentProductId47": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','45ae0492-fe7d-4ba8-addd-ca984ea30bc1','-', '2.0.67')))]"
        },
        "analyticRuleObject48": {
            "analyticRuleVersion48": "2.0.67",
            "_analyticRulecontentId48": "263ea651-10c8-48a6-a5ac-2c9fc0655ebc",
            "analyticRuleId48": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '263ea651-10c8-48a6-a5ac-2c9fc0655ebc')]",
            "analyticRuleTemplateSpecName48": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('263ea651-10c8-48a6-a5ac-2c9fc0655ebc')))]",
            "_analyticRulecontentProductId48": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','263ea651-10c8-48a6-a5ac-2c9fc0655ebc','-', '2.0.67')))]"
        },
        "analyticRuleObject49": {
            "analyticRuleVersion49": "2.0.67",
            "_analyticRulecontentId49": "d83d4699-7bd5-44f1-826a-3bd3501712a9",
            "analyticRuleId49": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'd83d4699-7bd5-44f1-826a-3bd3501712a9')]",
            "analyticRuleTemplateSpecName49": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('d83d4699-7bd5-44f1-826a-3bd3501712a9')))]",
            "_analyticRulecontentProductId49": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','d83d4699-7bd5-44f1-826a-3bd3501712a9','-', '2.0.67')))]"
        },
        "analyticRuleObject50": {
            "analyticRuleVersion50": "2.0.75",
            "_analyticRulecontentId50": "ea0f2cc5-9ee4-45b0-bc19-fdbdf37b4db4",
            "analyticRuleId50": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'ea0f2cc5-9ee4-45b0-bc19-fdbdf37b4db4')]",
            "analyticRuleTemplateSpecName50": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('ea0f2cc5-9ee4-45b0-bc19-fdbdf37b4db4')))]",
            "_analyticRulecontentProductId50": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','ea0f2cc5-9ee4-45b0-bc19-fdbdf37b4db4','-', '2.0.75')))]"
        },
        "analyticRuleObject51": {
            "analyticRuleVersion51": "2.0.67",
            "_analyticRulecontentId51": "97d13311-748b-4016-b095-9100ab00e4db",
            "analyticRuleId51": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '97d13311-748b-4016-b095-9100ab00e4db')]",
            "analyticRuleTemplateSpecName51": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('97d13311-748b-4016-b095-9100ab00e4db')))]",
            "_analyticRulecontentProductId51": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','97d13311-748b-4016-b095-9100ab00e4db','-', '2.0.67')))]"
        },
        "analyticRuleObject52": {
            "analyticRuleVersion52": "2.0.67",
            "_analyticRulecontentId52": "9fadb366-a7ec-474c-90e1-d1a823176a1e",
            "analyticRuleId52": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '9fadb366-a7ec-474c-90e1-d1a823176a1e')]",
            "analyticRuleTemplateSpecName52": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('9fadb366-a7ec-474c-90e1-d1a823176a1e')))]",
            "_analyticRulecontentProductId52": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','9fadb366-a7ec-474c-90e1-d1a823176a1e','-', '2.0.67')))]"
        },
        "analyticRuleObject53": {
            "analyticRuleVersion53": "2.0.67",
            "_analyticRulecontentId53": "940baadd-fe19-4c1a-9680-63a9c5d21e1c",
            "analyticRuleId53": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '940baadd-fe19-4c1a-9680-63a9c5d21e1c')]",
            "analyticRuleTemplateSpecName53": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('940baadd-fe19-4c1a-9680-63a9c5d21e1c')))]",
            "_analyticRulecontentProductId53": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','940baadd-fe19-4c1a-9680-63a9c5d21e1c','-', '2.0.67')))]"
        },
        "analyticRuleObject54": {
            "analyticRuleVersion54": "2.0.67",
            "_analyticRulecontentId54": "2521fd74-79f3-4adc-8350-edf4036913b3",
            "analyticRuleId54": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '2521fd74-79f3-4adc-8350-edf4036913b3')]",
            "analyticRuleTemplateSpecName54": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('2521fd74-79f3-4adc-8350-edf4036913b3')))]",
            "_analyticRulecontentProductId54": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','2521fd74-79f3-4adc-8350-edf4036913b3','-', '2.0.67')))]"
        },
        "analyticRuleObject55": {
            "analyticRuleVersion55": "2.0.67",
            "_analyticRulecontentId55": "4cc23b15-a048-45f1-b1e8-2dfc40013d84",
            "analyticRuleId55": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '4cc23b15-a048-45f1-b1e8-2dfc40013d84')]",
            "analyticRuleTemplateSpecName55": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('4cc23b15-a048-45f1-b1e8-2dfc40013d84')))]",
            "_analyticRulecontentProductId55": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','4cc23b15-a048-45f1-b1e8-2dfc40013d84','-', '2.0.67')))]"
        },
        "analyticRuleObject56": {
            "analyticRuleVersion56": "2.0.67",
            "_analyticRulecontentId56": "47848010-7a36-44f7-96be-d988f3de9421",
            "analyticRuleId56": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '47848010-7a36-44f7-96be-d988f3de9421')]",
            "analyticRuleTemplateSpecName56": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('47848010-7a36-44f7-96be-d988f3de9421')))]",
            "_analyticRulecontentProductId56": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','47848010-7a36-44f7-96be-d988f3de9421','-', '2.0.67')))]"
        },
        "analyticRuleObject57": {
            "analyticRuleVersion57": "2.0.67",
            "_analyticRulecontentId57": "27d73c8f-88fd-41b8-a785-231541aa32a0",
            "analyticRuleId57": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '27d73c8f-88fd-41b8-a785-231541aa32a0')]",
            "analyticRuleTemplateSpecName57": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('27d73c8f-88fd-41b8-a785-231541aa32a0')))]",
            "_analyticRulecontentProductId57": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','27d73c8f-88fd-41b8-a785-231541aa32a0','-', '2.0.67')))]"
        },
        "analyticRuleObject58": {
            "analyticRuleVersion58": "2.0.67",
            "_analyticRulecontentId58": "f4da8e9d-3515-4a2a-8cf0-43334fa29d91",
            "analyticRuleId58": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'f4da8e9d-3515-4a2a-8cf0-43334fa29d91')]",
            "analyticRuleTemplateSpecName58": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('f4da8e9d-3515-4a2a-8cf0-43334fa29d91')))]",
            "_analyticRulecontentProductId58": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','f4da8e9d-3515-4a2a-8cf0-43334fa29d91','-', '2.0.67')))]"
        },
        "analyticRuleObject59": {
            "analyticRuleVersion59": "2.0.67",
            "_analyticRulecontentId59": "35ff4cf7-ed01-4ec2-92e5-ffcbf88fb294",
            "analyticRuleId59": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '35ff4cf7-ed01-4ec2-92e5-ffcbf88fb294')]",
            "analyticRuleTemplateSpecName59": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('35ff4cf7-ed01-4ec2-92e5-ffcbf88fb294')))]",
            "_analyticRulecontentProductId59": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','35ff4cf7-ed01-4ec2-92e5-ffcbf88fb294','-', '2.0.67')))]"
        },
        "analyticRuleObject60": {
            "analyticRuleVersion60": "2.0.74",
            "_analyticRulecontentId60": "8e8a95c5-7f78-435e-9e6a-7e29c0b831c1",
            "analyticRuleId60": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '8e8a95c5-7f78-435e-9e6a-7e29c0b831c1')]",
            "analyticRuleTemplateSpecName60": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('8e8a95c5-7f78-435e-9e6a-7e29c0b831c1')))]",
            "_analyticRulecontentProductId60": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','8e8a95c5-7f78-435e-9e6a-7e29c0b831c1','-', '2.0.74')))]"
        },
        "analyticRuleObject61": {
            "analyticRuleVersion61": "2.0.67",
            "_analyticRulecontentId61": "12509d03-0206-4b85-84b9-6d2349afa42b",
            "analyticRuleId61": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '12509d03-0206-4b85-84b9-6d2349afa42b')]",
            "analyticRuleTemplateSpecName61": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('12509d03-0206-4b85-84b9-6d2349afa42b')))]",
            "_analyticRulecontentProductId61": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','12509d03-0206-4b85-84b9-6d2349afa42b','-', '2.0.67')))]"
        },
        "analyticRuleObject62": {
            "analyticRuleVersion62": "2.0.67",
            "_analyticRulecontentId62": "7224ad22-e2cf-459d-9359-62310555e716",
            "analyticRuleId62": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '7224ad22-e2cf-459d-9359-62310555e716')]",
            "analyticRuleTemplateSpecName62": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('7224ad22-e2cf-459d-9359-62310555e716')))]",
            "_analyticRulecontentProductId62": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','7224ad22-e2cf-459d-9359-62310555e716','-', '2.0.67')))]"
        },
        "SAPLockUser-Advanced": "SAPLockUser-Advanced",
        "_SAPLockUser-Advanced": "[variables('SAPLockUser-Advanced')]",
        "playbookVersion1": "2.0.65",
        "playbookContentId1": "SAPLockUser-Advanced",
        "_playbookContentId1": "[variables('playbookContentId1')]",
        "playbookId1": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId1'))]",
        "playbookTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId1'))))]",
        "_playbookcontentProductId1": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId1'),'-', variables('playbookVersion1'))))]",
        "blanks": "[replace('b', 'b', '')]",
        "SAPLockUser-Basic": "SAPLockUser-Basic",
        "_SAPLockUser-Basic": "[variables('SAPLockUser-Basic')]",
        "playbookVersion2": "2.0.65",
        "playbookContentId2": "SAPLockUser-Basic",
        "_playbookContentId2": "[variables('playbookContentId2')]",
        "playbookId2": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId2'))]",
        "playbookTemplateSpecName2": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId2'))))]",
        "_playbookcontentProductId2": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId2'),'-', variables('playbookVersion2'))))]",
        "SAPReEnableAuditLog": "SAPReEnableAuditLog",
        "_SAPReEnableAuditLog": "[variables('SAPReEnableAuditLog')]",
        "playbookVersion3": "2.0.65",
        "playbookContentId3": "SAPReEnableAuditLog",
        "_playbookContentId3": "[variables('playbookContentId3')]",
        "playbookId3": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId3'))]",
        "playbookTemplateSpecName3": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId3'))))]",
        "_playbookcontentProductId3": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId3'),'-', variables('playbookVersion3'))))]",
        "_parserId1": "[variables('parserObject1').parserId1]",
        "parserTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pr-',uniquestring(variables('parserObject1').parserContentId1)))]",
        "parserObject1": {
            "_parserName1": "[concat(parameters('workspace'),'/','SAPAppLog')]",
            "parserId1": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPAppLog')]",
            "parserVersion1": "3.0.0",
            "parserContentId1": "SAPAppLog-Parser"
        },
        "_parsercontentProductId1": "[concat(take(variables('_solutionId'),50),'-','pr','-', uniqueString(concat(variables('_solutionId'),'-','Parser','-',variables('parserObject1').parserContentId1,'-', variables('parserObject1').parserVersion1)))]",
        "_parserId2": "[variables('parserObject2').parserId2]",
        "parserTemplateSpecName2": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pr-',uniquestring(variables('parserObject2').parserContentId2)))]",
        "parserObject2": {
            "_parserName2": "[concat(parameters('workspace'),'/','SAPAuditLog')]",
            "parserId2": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPAuditLog')]",
            "parserVersion2": "3.0.0",
            "parserContentId2": "SAPAuditLog-Parser"
        },
        "_parsercontentProductId2": "[concat(take(variables('_solutionId'),50),'-','pr','-', uniqueString(concat(variables('_solutionId'),'-','Parser','-',variables('parserObject2').parserContentId2,'-', variables('parserObject2').parserVersion2)))]",
        "_parserId3": "[variables('parserObject3').parserId3]",
        "parserTemplateSpecName3": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pr-',uniquestring(variables('parserObject3').parserContentId3)))]",
        "parserObject3": {
            "_parserName3": "[concat(parameters('workspace'),'/','SAPAuditLogAnomalies')]",
            "parserId3": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPAuditLogAnomalies')]",
            "parserVersion3": "3.0.0",
            "parserContentId3": "SAPAuditLogAnomalies-Parser"
        },
        "_parsercontentProductId3": "[concat(take(variables('_solutionId'),50),'-','pr','-', uniqueString(concat(variables('_solutionId'),'-','Parser','-',variables('parserObject3').parserContentId3,'-', variables('parserObject3').parserVersion3)))]",
        "_parserId4": "[variables('parserObject4').parserId4]",
        "parserTemplateSpecName4": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pr-',uniquestring(variables('parserObject4').parserContentId4)))]",
        "parserObject4": {
            "_parserName4": "[concat(parameters('workspace'),'/','SAPAuditLogConfigRecommend')]",
            "parserId4": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPAuditLogConfigRecommend')]",
            "parserVersion4": "3.0.0",
            "parserContentId4": "SAPAuditLogConfigRecommend-Parser"
        },
        "_parsercontentProductId4": "[concat(take(variables('_solutionId'),50),'-','pr','-', uniqueString(concat(variables('_solutionId'),'-','Parser','-',variables('parserObject4').parserContentId4,'-', variables('parserObject4').parserVersion4)))]",
        "_parserId5": "[variables('parserObject5').parserId5]",
        "parserTemplateSpecName5": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pr-',uniquestring(variables('parserObject5').parserContentId5)))]",
        "parserObject5": {
            "_parserName5": "[concat(parameters('workspace'),'/','SAPAuditLogConfiguration')]",
            "parserId5": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPAuditLogConfiguration')]",
            "parserVersion5": "3.0.0",
            "parserContentId5": "SAPAuditLogConfiguration-Parser"
        },
        "_parsercontentProductId5": "[concat(take(variables('_solutionId'),50),'-','pr','-', uniqueString(concat(variables('_solutionId'),'-','Parser','-',variables('parserObject5').parserContentId5,'-', variables('parserObject5').parserVersion5)))]",
        "_parserId6": "[variables('parserObject6').parserId6]",
        "parserTemplateSpecName6": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pr-',uniquestring(variables('parserObject6').parserContentId6)))]",
        "parserObject6": {
            "_parserName6": "[concat(parameters('workspace'),'/','SAPCRLog')]",
            "parserId6": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPCRLog')]",
            "parserVersion6": "3.0.0",
            "parserContentId6": "SAPCRLog-Parser"
        },
        "_parsercontentProductId6": "[concat(take(variables('_solutionId'),50),'-','pr','-', uniqueString(concat(variables('_solutionId'),'-','Parser','-',variables('parserObject6').parserContentId6,'-', variables('parserObject6').parserVersion6)))]",
        "_parserId7": "[variables('parserObject7').parserId7]",
        "parserTemplateSpecName7": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pr-',uniquestring(variables('parserObject7').parserContentId7)))]",
        "parserObject7": {
            "_parserName7": "[concat(parameters('workspace'),'/','SAPChangeDocsLog')]",
            "parserId7": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPChangeDocsLog')]",
            "parserVersion7": "3.0.0",
            "parserContentId7": "SAPChangeDocsLog-Parser"
        },
        "_parsercontentProductId7": "[concat(take(variables('_solutionId'),50),'-','pr','-', uniqueString(concat(variables('_solutionId'),'-','Parser','-',variables('parserObject7').parserContentId7,'-', variables('parserObject7').parserVersion7)))]",
        "_parserId8": "[variables('parserObject8').parserId8]",
        "parserTemplateSpecName8": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pr-',uniquestring(variables('parserObject8').parserContentId8)))]",
        "parserObject8": {
            "_parserName8": "[concat(parameters('workspace'),'/','SAPConnectorHealth')]",
            "parserId8": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPConnectorHealth')]",
            "parserVersion8": "3.0.0",
            "parserContentId8": "SAPConnectorHealth-Parser"
        },
        "_parsercontentProductId8": "[concat(take(variables('_solutionId'),50),'-','pr','-', uniqueString(concat(variables('_solutionId'),'-','Parser','-',variables('parserObject8').parserContentId8,'-', variables('parserObject8').parserVersion8)))]",
        "_parserId9": "[variables('parserObject9').parserId9]",
        "parserTemplateSpecName9": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pr-',uniquestring(variables('parserObject9').parserContentId9)))]",
        "parserObject9": {
            "_parserName9": "[concat(parameters('workspace'),'/','SAPConnectorOverview')]",
            "parserId9": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPConnectorOverview')]",
            "parserVersion9": "3.0.0",
            "parserContentId9": "SAPConnectorOverview-Parser"
        },
        "_parsercontentProductId9": "[concat(take(variables('_solutionId'),50),'-','pr','-', uniqueString(concat(variables('_solutionId'),'-','Parser','-',variables('parserObject9').parserContentId9,'-', variables('parserObject9').parserVersion9)))]",
        "_parserId10": "[variables('parserObject10').parserId10]",
        "parserTemplateSpecName10": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pr-',uniquestring(variables('parserObject10').parserContentId10)))]",
        "parserObject10": {
            "_parserName10": "[concat(parameters('workspace'),'/','SAPFilesLogs')]",
            "parserId10": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPFilesLogs')]",
            "parserVersion10": "3.0.0",
            "parserContentId10": "SAPFilesLogs-Parser"
        },
        "_parsercontentProductId10": "[concat(take(variables('_solutionId'),50),'-','pr','-', uniqueString(concat(variables('_solutionId'),'-','Parser','-',variables('parserObject10').parserContentId10,'-', variables('parserObject10').parserVersion10)))]",
        "_parserId11": "[variables('parserObject11').parserId11]",
        "parserTemplateSpecName11": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pr-',uniquestring(variables('parserObject11').parserContentId11)))]",
        "parserObject11": {
            "_parserName11": "[concat(parameters('workspace'),'/','SAPGetDataTypes')]",
            "parserId11": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPGetDataTypes')]",
            "parserVersion11": "3.0.0",
            "parserContentId11": "SAPGetDataTypes-Parser"
        },
        "_parsercontentProductId11": "[concat(take(variables('_solutionId'),50),'-','pr','-', uniqueString(concat(variables('_solutionId'),'-','Parser','-',variables('parserObject11').parserContentId11,'-', variables('parserObject11').parserVersion11)))]",
        "_parserId12": "[variables('parserObject12').parserId12]",
        "parserTemplateSpecName12": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pr-',uniquestring(variables('parserObject12').parserContentId12)))]",
        "parserObject12": {
            "_parserName12": "[concat(parameters('workspace'),'/','SAPGetParameters')]",
            "parserId12": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPGetParameters')]",
            "parserVersion12": "3.0.0",
            "parserContentId12": "SAPGetParameters-Parser"
        },
        "_parsercontentProductId12": "[concat(take(variables('_solutionId'),50),'-','pr','-', uniqueString(concat(variables('_solutionId'),'-','Parser','-',variables('parserObject12').parserContentId12,'-', variables('parserObject12').parserVersion12)))]",
        "_parserId13": "[variables('parserObject13').parserId13]",
        "parserTemplateSpecName13": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pr-',uniquestring(variables('parserObject13').parserContentId13)))]",
        "parserObject13": {
            "_parserName13": "[concat(parameters('workspace'),'/','SAPGetSystemParameter')]",
            "parserId13": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPGetSystemParameter')]",
            "parserVersion13": "3.0.0",
            "parserContentId13": "SAPGetSystemParameter-Parser"
        },
        "_parsercontentProductId13": "[concat(take(variables('_solutionId'),50),'-','pr','-', uniqueString(concat(variables('_solutionId'),'-','Parser','-',variables('parserObject13').parserContentId13,'-', variables('parserObject13').parserVersion13)))]",
        "_parserId14": "[variables('parserObject14').parserId14]",
        "parserTemplateSpecName14": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pr-',uniquestring(variables('parserObject14').parserContentId14)))]",
        "parserObject14": {
            "_parserName14": "[concat(parameters('workspace'),'/','SAPHeartBeat')]",
            "parserId14": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPHeartBeat')]",
            "parserVersion14": "3.0.0",
            "parserContentId14": "SAPHeartBeat-Parser"
        },
        "_parsercontentProductId14": "[concat(take(variables('_solutionId'),50),'-','pr','-', uniqueString(concat(variables('_solutionId'),'-','Parser','-',variables('parserObject14').parserContentId14,'-', variables('parserObject14').parserVersion14)))]",
        "_parserId15": "[variables('parserObject15').parserId15]",
        "parserTemplateSpecName15": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pr-',uniquestring(variables('parserObject15').parserContentId15)))]",
        "parserObject15": {
            "_parserName15": "[concat(parameters('workspace'),'/','SAPJAVAFilesLogs')]",
            "parserId15": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPJAVAFilesLogs')]",
            "parserVersion15": "3.0.0",
            "parserContentId15": "SAPJAVAFilesLogs-Parser"
        },
        "_parsercontentProductId15": "[concat(take(variables('_solutionId'),50),'-','pr','-', uniqueString(concat(variables('_solutionId'),'-','Parser','-',variables('parserObject15').parserContentId15,'-', variables('parserObject15').parserVersion15)))]",
        "_parserId16": "[variables('parserObject16').parserId16]",
        "parserTemplateSpecName16": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pr-',uniquestring(variables('parserObject16').parserContentId16)))]",
        "parserObject16": {
            "_parserName16": "[concat(parameters('workspace'),'/','SAPJobLog')]",
            "parserId16": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPJobLog')]",
            "parserVersion16": "3.0.0",
            "parserContentId16": "SAPJobLog-Parser"
        },
        "_parsercontentProductId16": "[concat(take(variables('_solutionId'),50),'-','pr','-', uniqueString(concat(variables('_solutionId'),'-','Parser','-',variables('parserObject16').parserContentId16,'-', variables('parserObject16').parserVersion16)))]",
        "_parserId17": "[variables('parserObject17').parserId17]",
        "parserTemplateSpecName17": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pr-',uniquestring(variables('parserObject17').parserContentId17)))]",
        "parserObject17": {
            "_parserName17": "[concat(parameters('workspace'),'/','SAPOS_GW')]",
            "parserId17": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPOS_GW')]",
            "parserVersion17": "3.0.0",
            "parserContentId17": "SAPOS_GW-Parser"
        },
        "_parsercontentProductId17": "[concat(take(variables('_solutionId'),50),'-','pr','-', uniqueString(concat(variables('_solutionId'),'-','Parser','-',variables('parserObject17').parserContentId17,'-', variables('parserObject17').parserVersion17)))]",
        "_parserId18": "[variables('parserObject18').parserId18]",
        "parserTemplateSpecName18": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pr-',uniquestring(variables('parserObject18').parserContentId18)))]",
        "parserObject18": {
            "_parserName18": "[concat(parameters('workspace'),'/','SAPOS_ICM')]",
            "parserId18": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPOS_ICM')]",
            "parserVersion18": "3.0.0",
            "parserContentId18": "SAPOS_ICM-Parser"
        },
        "_parsercontentProductId18": "[concat(take(variables('_solutionId'),50),'-','pr','-', uniqueString(concat(variables('_solutionId'),'-','Parser','-',variables('parserObject18').parserContentId18,'-', variables('parserObject18').parserVersion18)))]",
        "_parserId19": "[variables('parserObject19').parserId19]",
        "parserTemplateSpecName19": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pr-',uniquestring(variables('parserObject19').parserContentId19)))]",
        "parserObject19": {
            "_parserName19": "[concat(parameters('workspace'),'/','SAPOS_SAPCONTROL')]",
            "parserId19": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPOS_SAPCONTROL')]",
            "parserVersion19": "3.0.0",
            "parserContentId19": "SAPOS_SAPCONTROL-Parser"
        },
        "_parsercontentProductId19": "[concat(take(variables('_solutionId'),50),'-','pr','-', uniqueString(concat(variables('_solutionId'),'-','Parser','-',variables('parserObject19').parserContentId19,'-', variables('parserObject19').parserVersion19)))]",
        "_parserId20": "[variables('parserObject20').parserId20]",
        "parserTemplateSpecName20": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pr-',uniquestring(variables('parserObject20').parserContentId20)))]",
        "parserObject20": {
            "_parserName20": "[concat(parameters('workspace'),'/','SAPOS_Syslog')]",
            "parserId20": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPOS_Syslog')]",
            "parserVersion20": "3.0.0",
            "parserContentId20": "SAPOS_Syslog-Parser"
        },
        "_parsercontentProductId20": "[concat(take(variables('_solutionId'),50),'-','pr','-', uniqueString(concat(variables('_solutionId'),'-','Parser','-',variables('parserObject20').parserContentId20,'-', variables('parserObject20').parserVersion20)))]",
        "_parserId21": "[variables('parserObject21').parserId21]",
        "parserTemplateSpecName21": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pr-',uniquestring(variables('parserObject21').parserContentId21)))]",
        "parserObject21": {
            "_parserName21": "[concat(parameters('workspace'),'/','SAPOS_WP')]",
            "parserId21": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPOS_WP')]",
            "parserVersion21": "3.0.0",
            "parserContentId21": "SAPOS_WP-Parser"
        },
        "_parsercontentProductId21": "[concat(take(variables('_solutionId'),50),'-','pr','-', uniqueString(concat(variables('_solutionId'),'-','Parser','-',variables('parserObject21').parserContentId21,'-', variables('parserObject21').parserVersion21)))]",
        "_parserId22": "[variables('parserObject22').parserId22]",
        "parserTemplateSpecName22": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pr-',uniquestring(variables('parserObject22').parserContentId22)))]",
        "parserObject22": {
            "_parserName22": "[concat(parameters('workspace'),'/','SAPSpoolLog')]",
            "parserId22": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPSpoolLog')]",
            "parserVersion22": "3.0.0",
            "parserContentId22": "SAPSpoolLog-Parser"
        },
        "_parsercontentProductId22": "[concat(take(variables('_solutionId'),50),'-','pr','-', uniqueString(concat(variables('_solutionId'),'-','Parser','-',variables('parserObject22').parserContentId22,'-', variables('parserObject22').parserVersion22)))]",
        "_parserId23": "[variables('parserObject23').parserId23]",
        "parserTemplateSpecName23": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pr-',uniquestring(variables('parserObject23').parserContentId23)))]",
        "parserObject23": {
            "_parserName23": "[concat(parameters('workspace'),'/','SAPSpoolOutputLog')]",
            "parserId23": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPSpoolOutputLog')]",
            "parserVersion23": "3.0.0",
            "parserContentId23": "SAPSpoolOutputLog-Parser"
        },
        "_parsercontentProductId23": "[concat(take(variables('_solutionId'),50),'-','pr','-', uniqueString(concat(variables('_solutionId'),'-','Parser','-',variables('parserObject23').parserContentId23,'-', variables('parserObject23').parserVersion23)))]",
        "_parserId24": "[variables('parserObject24').parserId24]",
        "parserTemplateSpecName24": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pr-',uniquestring(variables('parserObject24').parserContentId24)))]",
        "parserObject24": {
            "_parserName24": "[concat(parameters('workspace'),'/','SAPSyslog')]",
            "parserId24": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPSyslog')]",
            "parserVersion24": "3.0.0",
            "parserContentId24": "SAPSyslog-Parser"
        },
        "_parsercontentProductId24": "[concat(take(variables('_solutionId'),50),'-','pr','-', uniqueString(concat(variables('_solutionId'),'-','Parser','-',variables('parserObject24').parserContentId24,'-', variables('parserObject24').parserVersion24)))]",
        "_parserId25": "[variables('parserObject25').parserId25]",
        "parserTemplateSpecName25": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pr-',uniquestring(variables('parserObject25').parserContentId25)))]",
        "parserObject25": {
            "_parserName25": "[concat(parameters('workspace'),'/','SAPSystems')]",
            "parserId25": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPSystems')]",
            "parserVersion25": "3.0.0",
            "parserContentId25": "SAPSystems-Parser"
        },
        "_parsercontentProductId25": "[concat(take(variables('_solutionId'),50),'-','pr','-', uniqueString(concat(variables('_solutionId'),'-','Parser','-',variables('parserObject25').parserContentId25,'-', variables('parserObject25').parserVersion25)))]",
        "_parserId26": "[variables('parserObject26').parserId26]",
        "parserTemplateSpecName26": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pr-',uniquestring(variables('parserObject26').parserContentId26)))]",
        "parserObject26": {
            "_parserName26": "[concat(parameters('workspace'),'/','SAPTableDataLog')]",
            "parserId26": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPTableDataLog')]",
            "parserVersion26": "3.0.0",
            "parserContentId26": "SAPTableDataLog-Parser"
        },
        "_parsercontentProductId26": "[concat(take(variables('_solutionId'),50),'-','pr','-', uniqueString(concat(variables('_solutionId'),'-','Parser','-',variables('parserObject26').parserContentId26,'-', variables('parserObject26').parserVersion26)))]",
        "_parserId27": "[variables('parserObject27').parserId27]",
        "parserTemplateSpecName27": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pr-',uniquestring(variables('parserObject27').parserContentId27)))]",
        "parserObject27": {
            "_parserName27": "[concat(parameters('workspace'),'/','SAPThreatIntelligenceIndicator')]",
            "parserId27": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPThreatIntelligenceIndicator')]",
            "parserVersion27": "3.0.0",
            "parserContentId27": "SAPThreatIntelligenceIndicator-Parser"
        },
        "_parsercontentProductId27": "[concat(take(variables('_solutionId'),50),'-','pr','-', uniqueString(concat(variables('_solutionId'),'-','Parser','-',variables('parserObject27').parserContentId27,'-', variables('parserObject27').parserVersion27)))]",
        "_parserId28": "[variables('parserObject28').parserId28]",
        "parserTemplateSpecName28": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pr-',uniquestring(variables('parserObject28').parserContentId28)))]",
        "parserObject28": {
            "_parserName28": "[concat(parameters('workspace'),'/','SAPUsersAssignments')]",
            "parserId28": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPUsersAssignments')]",
            "parserVersion28": "3.0.0",
            "parserContentId28": "SAPUsersAssignments-Parser"
        },
        "_parsercontentProductId28": "[concat(take(variables('_solutionId'),50),'-','pr','-', uniqueString(concat(variables('_solutionId'),'-','Parser','-',variables('parserObject28').parserContentId28,'-', variables('parserObject28').parserVersion28)))]",
        "_parserId29": "[variables('parserObject29').parserId29]",
        "parserTemplateSpecName29": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pr-',uniquestring(variables('parserObject29').parserContentId29)))]",
        "parserObject29": {
            "_parserName29": "[concat(parameters('workspace'),'/','SAPUsersAuthorizations')]",
            "parserId29": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPUsersAuthorizations')]",
            "parserVersion29": "3.0.0",
            "parserContentId29": "SAPUsersAuthorizations-Parser"
        },
        "_parsercontentProductId29": "[concat(take(variables('_solutionId'),50),'-','pr','-', uniqueString(concat(variables('_solutionId'),'-','Parser','-',variables('parserObject29').parserContentId29,'-', variables('parserObject29').parserVersion29)))]",
        "_parserId30": "[variables('parserObject30').parserId30]",
        "parserTemplateSpecName30": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pr-',uniquestring(variables('parserObject30').parserContentId30)))]",
        "parserObject30": {
            "_parserName30": "[concat(parameters('workspace'),'/','SAPUsersEmail')]",
            "parserId30": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPUsersEmail')]",
            "parserVersion30": "3.0.0",
            "parserContentId30": "SAPUsersEmail-Parser"
        },
        "_parsercontentProductId30": "[concat(take(variables('_solutionId'),50),'-','pr','-', uniqueString(concat(variables('_solutionId'),'-','Parser','-',variables('parserObject30').parserContentId30,'-', variables('parserObject30').parserVersion30)))]",
        "_parserId31": "[variables('parserObject31').parserId31]",
        "parserTemplateSpecName31": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pr-',uniquestring(variables('parserObject31').parserContentId31)))]",
        "parserObject31": {
            "_parserName31": "[concat(parameters('workspace'),'/','SAPUsersGetPrivileged')]",
            "parserId31": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPUsersGetPrivileged')]",
            "parserVersion31": "3.0.0",
            "parserContentId31": "SAPUsersGetPrivileged-Parser"
        },
        "_parsercontentProductId31": "[concat(take(variables('_solutionId'),50),'-','pr','-', uniqueString(concat(variables('_solutionId'),'-','Parser','-',variables('parserObject31').parserContentId31,'-', variables('parserObject31').parserVersion31)))]",
        "_parserId32": "[variables('parserObject32').parserId32]",
        "parserTemplateSpecName32": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pr-',uniquestring(variables('parserObject32').parserContentId32)))]",
        "parserObject32": {
            "_parserName32": "[concat(parameters('workspace'),'/','SAPUsersGetSensitive')]",
            "parserId32": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPUsersGetSensitive')]",
            "parserVersion32": "3.0.0",
            "parserContentId32": "SAPUsersGetSensitive-Parser"
        },
        "_parsercontentProductId32": "[concat(take(variables('_solutionId'),50),'-','pr','-', uniqueString(concat(variables('_solutionId'),'-','Parser','-',variables('parserObject32').parserContentId32,'-', variables('parserObject32').parserVersion32)))]",
        "_parserId33": "[variables('parserObject33').parserId33]",
        "parserTemplateSpecName33": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pr-',uniquestring(variables('parserObject33').parserContentId33)))]",
        "parserObject33": {
            "_parserName33": "[concat(parameters('workspace'),'/','SAPUsersGetVIP')]",
            "parserId33": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPUsersGetVIP')]",
            "parserVersion33": "3.0.0",
            "parserContentId33": "SAPUsersGetVIP-Parser"
        },
        "_parsercontentProductId33": "[concat(take(variables('_solutionId'),50),'-','pr','-', uniqueString(concat(variables('_solutionId'),'-','Parser','-',variables('parserObject33').parserContentId33,'-', variables('parserObject33').parserVersion33)))]",
        "_parserId34": "[variables('parserObject34').parserId34]",
        "parserTemplateSpecName34": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pr-',uniquestring(variables('parserObject34').parserContentId34)))]",
        "parserObject34": {
            "_parserName34": "[concat(parameters('workspace'),'/','SAPUsersHeader')]",
            "parserId34": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPUsersHeader')]",
            "parserVersion34": "3.0.0",
            "parserContentId34": "SAPUsersHeader-Parser"
        },
        "_parsercontentProductId34": "[concat(take(variables('_solutionId'),50),'-','pr','-', uniqueString(concat(variables('_solutionId'),'-','Parser','-',variables('parserObject34').parserContentId34,'-', variables('parserObject34').parserVersion34)))]",
        "_parserId35": "[variables('parserObject35').parserId35]",
        "parserTemplateSpecName35": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pr-',uniquestring(variables('parserObject35').parserContentId35)))]",
        "parserObject35": {
            "_parserName35": "[concat(parameters('workspace'),'/','SAPWSAlertRuleMetaData')]",
            "parserId35": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPWSAlertRuleMetaData')]",
            "parserVersion35": "3.0.0",
            "parserContentId35": "SAPWSAlertRuleMetaData-Parser"
        },
        "_parsercontentProductId35": "[concat(take(variables('_solutionId'),50),'-','pr','-', uniqueString(concat(variables('_solutionId'),'-','Parser','-',variables('parserObject35').parserContentId35,'-', variables('parserObject35').parserVersion35)))]",
        "_parserId36": "[variables('parserObject36').parserId36]",
        "parserTemplateSpecName36": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pr-',uniquestring(variables('parserObject36').parserContentId36)))]",
        "parserObject36": {
            "_parserName36": "[concat(parameters('workspace'),'/','SAPWSAlertsDetailed')]",
            "parserId36": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPWSAlertsDetailed')]",
            "parserVersion36": "3.0.0",
            "parserContentId36": "SAPWSAlertsDetailed-Parser"
        },
        "_parsercontentProductId36": "[concat(take(variables('_solutionId'),50),'-','pr','-', uniqueString(concat(variables('_solutionId'),'-','Parser','-',variables('parserObject36').parserContentId36,'-', variables('parserObject36').parserVersion36)))]",
        "_parserId37": "[variables('parserObject37').parserId37]",
        "parserTemplateSpecName37": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pr-',uniquestring(variables('parserObject37').parserContentId37)))]",
        "parserObject37": {
            "_parserName37": "[concat(parameters('workspace'),'/','SAPWSIncidentsDetailed')]",
            "parserId37": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPWSIncidentsDetailed')]",
            "parserVersion37": "3.0.0",
            "parserContentId37": "SAPWSIncidentsDetailed-Parser"
        },
        "_parsercontentProductId37": "[concat(take(variables('_solutionId'),50),'-','pr','-', uniqueString(concat(variables('_solutionId'),'-','Parser','-',variables('parserObject37').parserContentId37,'-', variables('parserObject37').parserVersion37)))]",
        "_parserId38": "[variables('parserObject38').parserId38]",
        "parserTemplateSpecName38": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pr-',uniquestring(variables('parserObject38').parserContentId38)))]",
        "parserObject38": {
            "_parserName38": "[concat(parameters('workspace'),'/','SAPWorkflowLog')]",
            "parserId38": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPWorkflowLog')]",
            "parserVersion38": "3.0.0",
            "parserContentId38": "SAPWorkflowLog-Parser"
        },
        "_parsercontentProductId38": "[concat(take(variables('_solutionId'),50),'-','pr','-', uniqueString(concat(variables('_solutionId'),'-','Parser','-',variables('parserObject38').parserContentId38,'-', variables('parserObject38').parserVersion38)))]",
        "_parserId39": "[variables('parserObject39').parserId39]",
        "parserTemplateSpecName39": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pr-',uniquestring(variables('parserObject39').parserContentId39)))]",
        "parserObject39": {
            "_parserName39": "[concat(parameters('workspace'),'/','SAPXalAlerts')]",
            "parserId39": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPXalAlerts')]",
            "parserVersion39": "3.0.0",
            "parserContentId39": "SAPXalAlerts-Parser"
        },
        "_parsercontentProductId39": "[concat(take(variables('_solutionId'),50),'-','pr','-', uniqueString(concat(variables('_solutionId'),'-','Parser','-',variables('parserObject39').parserContentId39,'-', variables('parserObject39').parserVersion39)))]",
        "_parserId40": "[variables('parserObject40').parserId40]",
        "parserTemplateSpecName40": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pr-',uniquestring(variables('parserObject40').parserContentId40)))]",
        "parserObject40": {
            "_parserName40": "[concat(parameters('workspace'),'/','SAPXalMonitorSetsTree')]",
            "parserId40": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPXalMonitorSetsTree')]",
            "parserVersion40": "3.0.0",
            "parserContentId40": "SAPXalMonitorSetsTree-Parser"
        },
        "_parsercontentProductId40": "[concat(take(variables('_solutionId'),50),'-','pr','-', uniqueString(concat(variables('_solutionId'),'-','Parser','-',variables('parserObject40').parserContentId40,'-', variables('parserObject40').parserVersion40)))]",
        "_parserId41": "[variables('parserObject41').parserId41]",
        "parserTemplateSpecName41": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pr-',uniquestring(variables('parserObject41').parserContentId41)))]",
        "parserObject41": {
            "_parserName41": "[concat(parameters('workspace'),'/','SAPXalPerformance')]",
            "parserId41": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPXalPerformance')]",
            "parserVersion41": "3.0.0",
            "parserContentId41": "SAPXalPerformance-Parser"
        },
        "_parsercontentProductId41": "[concat(take(variables('_solutionId'),50),'-','pr','-', uniqueString(concat(variables('_solutionId'),'-','Parser','-',variables('parserObject41').parserContentId41,'-', variables('parserObject41').parserVersion41)))]",
        "_parserId42": "[variables('parserObject42').parserId42]",
        "parserTemplateSpecName42": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pr-',uniquestring(variables('parserObject42').parserContentId42)))]",
        "parserObject42": {
            "_parserName42": "[concat(parameters('workspace'),'/','SAP_ADCP')]",
            "parserId42": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAP_ADCP')]",
            "parserVersion42": "3.0.0",
            "parserContentId42": "SAP_ADCP-Parser"
        },
        "_parsercontentProductId42": "[concat(take(variables('_solutionId'),50),'-','pr','-', uniqueString(concat(variables('_solutionId'),'-','Parser','-',variables('parserObject42').parserContentId42,'-', variables('parserObject42').parserVersion42)))]",
        "_parserId43": "[variables('parserObject43').parserId43]",
        "parserTemplateSpecName43": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pr-',uniquestring(variables('parserObject43').parserContentId43)))]",
        "parserObject43": {
            "_parserName43": "[concat(parameters('workspace'),'/','SAP_ADR6')]",
            "parserId43": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAP_ADR6')]",
            "parserVersion43": "3.0.0",
            "parserContentId43": "SAP_ADR6-Parser"
        },
        "_parsercontentProductId43": "[concat(take(variables('_solutionId'),50),'-','pr','-', uniqueString(concat(variables('_solutionId'),'-','Parser','-',variables('parserObject43').parserContentId43,'-', variables('parserObject43').parserVersion43)))]",
        "_parserId44": "[variables('parserObject44').parserId44]",
        "parserTemplateSpecName44": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pr-',uniquestring(variables('parserObject44').parserContentId44)))]",
        "parserObject44": {
            "_parserName44": "[concat(parameters('workspace'),'/','SAP_AGR_1251')]",
            "parserId44": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAP_AGR_1251')]",
            "parserVersion44": "3.0.0",
            "parserContentId44": "SAP_AGR_1251-Parser"
        },
        "_parsercontentProductId44": "[concat(take(variables('_solutionId'),50),'-','pr','-', uniqueString(concat(variables('_solutionId'),'-','Parser','-',variables('parserObject44').parserContentId44,'-', variables('parserObject44').parserVersion44)))]",
        "_parserId45": "[variables('parserObject45').parserId45]",
        "parserTemplateSpecName45": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pr-',uniquestring(variables('parserObject45').parserContentId45)))]",
        "parserObject45": {
            "_parserName45": "[concat(parameters('workspace'),'/','SAP_AGR_AGRS')]",
            "parserId45": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAP_AGR_AGRS')]",
            "parserVersion45": "3.0.0",
            "parserContentId45": "SAP_AGR_AGRS-Parser"
        },
        "_parsercontentProductId45": "[concat(take(variables('_solutionId'),50),'-','pr','-', uniqueString(concat(variables('_solutionId'),'-','Parser','-',variables('parserObject45').parserContentId45,'-', variables('parserObject45').parserVersion45)))]",
        "_parserId46": "[variables('parserObject46').parserId46]",
        "parserTemplateSpecName46": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pr-',uniquestring(variables('parserObject46').parserContentId46)))]",
        "parserObject46": {
            "_parserName46": "[concat(parameters('workspace'),'/','SAP_AGR_DEFINE')]",
            "parserId46": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAP_AGR_DEFINE')]",
            "parserVersion46": "3.0.0",
            "parserContentId46": "SAP_AGR_DEFINE-Parser"
        },
        "_parsercontentProductId46": "[concat(take(variables('_solutionId'),50),'-','pr','-', uniqueString(concat(variables('_solutionId'),'-','Parser','-',variables('parserObject46').parserContentId46,'-', variables('parserObject46').parserVersion46)))]",
        "_parserId47": "[variables('parserObject47').parserId47]",
        "parserTemplateSpecName47": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pr-',uniquestring(variables('parserObject47').parserContentId47)))]",
        "parserObject47": {
            "_parserName47": "[concat(parameters('workspace'),'/','SAP_AGR_FLAGS')]",
            "parserId47": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAP_AGR_FLAGS')]",
            "parserVersion47": "3.0.0",
            "parserContentId47": "SAP_AGR_FLAGS-Parser"
        },
        "_parsercontentProductId47": "[concat(take(variables('_solutionId'),50),'-','pr','-', uniqueString(concat(variables('_solutionId'),'-','Parser','-',variables('parserObject47').parserContentId47,'-', variables('parserObject47').parserVersion47)))]",
        "_parserId48": "[variables('parserObject48').parserId48]",
        "parserTemplateSpecName48": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pr-',uniquestring(variables('parserObject48').parserContentId48)))]",
        "parserObject48": {
            "_parserName48": "[concat(parameters('workspace'),'/','SAP_AGR_PROF')]",
            "parserId48": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAP_AGR_PROF')]",
            "parserVersion48": "3.0.0",
            "parserContentId48": "SAP_AGR_PROF-Parser"
        },
        "_parsercontentProductId48": "[concat(take(variables('_solutionId'),50),'-','pr','-', uniqueString(concat(variables('_solutionId'),'-','Parser','-',variables('parserObject48').parserContentId48,'-', variables('parserObject48').parserVersion48)))]",
        "_parserId49": "[variables('parserObject49').parserId49]",
        "parserTemplateSpecName49": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pr-',uniquestring(variables('parserObject49').parserContentId49)))]",
        "parserObject49": {
            "_parserName49": "[concat(parameters('workspace'),'/','SAP_AGR_TCODES')]",
            "parserId49": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAP_AGR_TCODES')]",
            "parserVersion49": "3.0.0",
            "parserContentId49": "SAP_AGR_TCODES-Parser"
        },
        "_parsercontentProductId49": "[concat(take(variables('_solutionId'),50),'-','pr','-', uniqueString(concat(variables('_solutionId'),'-','Parser','-',variables('parserObject49').parserContentId49,'-', variables('parserObject49').parserVersion49)))]",
        "_parserId50": "[variables('parserObject50').parserId50]",
        "parserTemplateSpecName50": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pr-',uniquestring(variables('parserObject50').parserContentId50)))]",
        "parserObject50": {
            "_parserName50": "[concat(parameters('workspace'),'/','SAP_AGR_USERS')]",
            "parserId50": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAP_AGR_USERS')]",
            "parserVersion50": "3.0.0",
            "parserContentId50": "SAP_AGR_USERS-Parser"
        },
        "_parsercontentProductId50": "[concat(take(variables('_solutionId'),50),'-','pr','-', uniqueString(concat(variables('_solutionId'),'-','Parser','-',variables('parserObject50').parserContentId50,'-', variables('parserObject50').parserVersion50)))]",
        "_parserId51": "[variables('parserObject51').parserId51]",
        "parserTemplateSpecName51": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pr-',uniquestring(variables('parserObject51').parserContentId51)))]",
        "parserObject51": {
            "_parserName51": "[concat(parameters('workspace'),'/','SAP_DEVACCESS')]",
            "parserId51": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAP_DEVACCESS')]",
            "parserVersion51": "3.0.0",
            "parserContentId51": "SAP_DEVACCESS-Parser"
        },
        "_parsercontentProductId51": "[concat(take(variables('_solutionId'),50),'-','pr','-', uniqueString(concat(variables('_solutionId'),'-','Parser','-',variables('parserObject51').parserContentId51,'-', variables('parserObject51').parserVersion51)))]",
        "_parserId52": "[variables('parserObject52').parserId52]",
        "parserTemplateSpecName52": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pr-',uniquestring(variables('parserObject52').parserContentId52)))]",
        "parserObject52": {
            "_parserName52": "[concat(parameters('workspace'),'/','SAP_PAHI')]",
            "parserId52": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAP_PAHI')]",
            "parserVersion52": "3.0.0",
            "parserContentId52": "SAP_PAHI-Parser"
        },
        "_parsercontentProductId52": "[concat(take(variables('_solutionId'),50),'-','pr','-', uniqueString(concat(variables('_solutionId'),'-','Parser','-',variables('parserObject52').parserContentId52,'-', variables('parserObject52').parserVersion52)))]",
        "_parserId53": "[variables('parserObject53').parserId53]",
        "parserTemplateSpecName53": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pr-',uniquestring(variables('parserObject53').parserContentId53)))]",
        "parserObject53": {
            "_parserName53": "[concat(parameters('workspace'),'/','SAP_USGRP_USER')]",
            "parserId53": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAP_USGRP_USER')]",
            "parserVersion53": "3.0.0",
            "parserContentId53": "SAP_USGRP_USER-Parser"
        },
        "_parsercontentProductId53": "[concat(take(variables('_solutionId'),50),'-','pr','-', uniqueString(concat(variables('_solutionId'),'-','Parser','-',variables('parserObject53').parserContentId53,'-', variables('parserObject53').parserVersion53)))]",
        "_parserId54": "[variables('parserObject54').parserId54]",
        "parserTemplateSpecName54": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pr-',uniquestring(variables('parserObject54').parserContentId54)))]",
        "parserObject54": {
            "_parserName54": "[concat(parameters('workspace'),'/','SAP_USR01')]",
            "parserId54": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAP_USR01')]",
            "parserVersion54": "3.0.0",
            "parserContentId54": "SAP_USR01-Parser"
        },
        "_parsercontentProductId54": "[concat(take(variables('_solutionId'),50),'-','pr','-', uniqueString(concat(variables('_solutionId'),'-','Parser','-',variables('parserObject54').parserContentId54,'-', variables('parserObject54').parserVersion54)))]",
        "_parserId55": "[variables('parserObject55').parserId55]",
        "parserTemplateSpecName55": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pr-',uniquestring(variables('parserObject55').parserContentId55)))]",
        "parserObject55": {
            "_parserName55": "[concat(parameters('workspace'),'/','SAP_USR02')]",
            "parserId55": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAP_USR02')]",
            "parserVersion55": "3.0.0",
            "parserContentId55": "SAP_USR02-Parser"
        },
        "_parsercontentProductId55": "[concat(take(variables('_solutionId'),50),'-','pr','-', uniqueString(concat(variables('_solutionId'),'-','Parser','-',variables('parserObject55').parserContentId55,'-', variables('parserObject55').parserVersion55)))]",
        "_parserId56": "[variables('parserObject56').parserId56]",
        "parserTemplateSpecName56": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pr-',uniquestring(variables('parserObject56').parserContentId56)))]",
        "parserObject56": {
            "_parserName56": "[concat(parameters('workspace'),'/','SAP_USR05')]",
            "parserId56": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAP_USR05')]",
            "parserVersion56": "3.0.0",
            "parserContentId56": "SAP_USR05-Parser"
        },
        "_parsercontentProductId56": "[concat(take(variables('_solutionId'),50),'-','pr','-', uniqueString(concat(variables('_solutionId'),'-','Parser','-',variables('parserObject56').parserContentId56,'-', variables('parserObject56').parserVersion56)))]",
        "_parserId57": "[variables('parserObject57').parserId57]",
        "parserTemplateSpecName57": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pr-',uniquestring(variables('parserObject57').parserContentId57)))]",
        "parserObject57": {
            "_parserName57": "[concat(parameters('workspace'),'/','SAP_USR21')]",
            "parserId57": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAP_USR21')]",
            "parserVersion57": "3.0.0",
            "parserContentId57": "SAP_USR21-Parser"
        },
        "_parsercontentProductId57": "[concat(take(variables('_solutionId'),50),'-','pr','-', uniqueString(concat(variables('_solutionId'),'-','Parser','-',variables('parserObject57').parserContentId57,'-', variables('parserObject57').parserVersion57)))]",
        "_parserId58": "[variables('parserObject58').parserId58]",
        "parserTemplateSpecName58": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pr-',uniquestring(variables('parserObject58').parserContentId58)))]",
        "parserObject58": {
            "_parserName58": "[concat(parameters('workspace'),'/','SAP_UST04')]",
            "parserId58": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAP_UST04')]",
            "parserVersion58": "3.0.0",
            "parserContentId58": "SAP_UST04-Parser"
        },
        "_parsercontentProductId58": "[concat(take(variables('_solutionId'),50),'-','pr','-', uniqueString(concat(variables('_solutionId'),'-','Parser','-',variables('parserObject58').parserContentId58,'-', variables('parserObject58').parserVersion58)))]",
        "SAP - Critical Authorizations": "SAP - Critical Authorizations",
        "_SAP - Critical Authorizations": "[variables('SAP - Critical Authorizations')]",
        "SAP - Excluded Networks": "SAP - Excluded Networks",
        "_SAP - Excluded Networks": "[variables('SAP - Excluded Networks')]",
        "SAP - Excluded Users": "SAP - Excluded Users",
        "_SAP - Excluded Users": "[variables('SAP - Excluded Users')]",
        "SAP - FTP Servers": "SAP - FTP Servers",
        "_SAP - FTP Servers": "[variables('SAP - FTP Servers')]",
        "SAP - Networks": "SAP - Networks",
        "_SAP - Networks": "[variables('SAP - Networks')]",
        "SAP - Obsolete Function Modules": "SAP - Obsolete Function Modules",
        "_SAP - Obsolete Function Modules": "[variables('SAP - Obsolete Function Modules')]",
        "SAP - Obsolete Programs": "SAP - Obsolete Programs",
        "_SAP - Obsolete Programs": "[variables('SAP - Obsolete Programs')]",
        "SAP - Privileged Users": "SAP - Privileged Users",
        "_SAP - Privileged Users": "[variables('SAP - Privileged Users')]",
        "SAP - Sensitive ABAP Programs": "SAP - Sensitive ABAP Programs",
        "_SAP - Sensitive ABAP Programs": "[variables('SAP - Sensitive ABAP Programs')]",
        "SAP - Sensitive Function Modules": "SAP - Sensitive Function Modules",
        "_SAP - Sensitive Function Modules": "[variables('SAP - Sensitive Function Modules')]",
        "SAP - Sensitive Profiles": "SAP - Sensitive Profiles",
        "_SAP - Sensitive Profiles": "[variables('SAP - Sensitive Profiles')]",
        "SAP - Sensitive Roles": "SAP - Sensitive Roles",
        "_SAP - Sensitive Roles": "[variables('SAP - Sensitive Roles')]",
        "SAP - Sensitive Tables": "SAP - Sensitive Tables",
        "_SAP - Sensitive Tables": "[variables('SAP - Sensitive Tables')]",
        "SAP - Sensitive Transactions": "SAP - Sensitive Transactions",
        "_SAP - Sensitive Transactions": "[variables('SAP - Sensitive Transactions')]",
        "SAP - Systems": "SAP - Systems",
        "_SAP - Systems": "[variables('SAP - Systems')]",
        "SAP - Transactions for ABAP Generations": "SAP - Transactions for ABAP Generations",
        "_SAP - Transactions for ABAP Generations": "[variables('SAP - Transactions for ABAP Generations')]",
        "SAPAlertRulesMetadata": "SAPAlertRulesMetadata",
        "_SAPAlertRulesMetadata": "[variables('SAPAlertRulesMetadata')]",
        "SAPSolutionConfig": "SAPSolutionConfig",
        "_SAPSolutionConfig": "[variables('SAPSolutionConfig')]",
        "SAPSystemParameters": "SAPSystemParameters",
        "_SAPSystemParameters": "[variables('SAPSystemParameters')]",
        "SAP_Dynamic_Audit_Log_Monitor_Configuration": "SAP_Dynamic_Audit_Log_Monitor_Configuration",
        "_SAP_Dynamic_Audit_Log_Monitor_Configuration": "[variables('SAP_Dynamic_Audit_Log_Monitor_Configuration')]",
        "SAP_User_Config": "SAP_User_Config",
        "_SAP_User_Config": "[variables('SAP_User_Config')]",
        "_solutioncontentProductId": "[concat(take(variables('_solutionId'),50),'-','sl','-', uniqueString(concat(variables('_solutionId'),'-','Solution','-',variables('_solutionId'),'-', variables('_solutionVersion'))))]",
        "SAPFunctionsSAPAppLogQuery": "//generated function structure for custom log CWSQSAP.ABAPAppLog_CL\n//generated on 2022-05-07\n//Sentinel4SAP solution version 1.2.98\nlet D_ABAPAppLog_CL = datatable(TimeGenerated:datetime\n,ClientID:string\n,LogNumber:string\n,Object:string\n,SubObject:string\n,ExternalID:string\n,AppLogDateTime_t:datetime\n,User:string\n,TransactionCode:string\n,ProgramName:string\n,OperationMode:string\n,StandardText:string\n,CallbackType:string\n,CallbackProgram:string\n,CallbackRoutine:string\n,ProblemClass:string\n,UserChange:string\n,LogHandle:string\n,ContextDDIC:string\n,InternalMessageSerial:real\n,MessageType:string\n,MessageClass:string\n,MessageNumber:string\n,MessageText:string\n,LevelofDetail:string\n,SortCriterion:string\n,SystemID:string\n,SystemNumber:string\n,Instance:string\n,Host:string\n,Type:string\n)['1000-01-01T00:00:00Z','initialString','initialString','initialString','initialString','initialString','1000-01-01T00:00:00Z','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString',1.1111,'initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString'];\n\nlet T_ABAPAppLog_CL = (CWSQSAP.ABAPAppLog_CL | project\nTimeGenerated = column_ifexists('TimeGenerated', '1000-01-01T00:00:00Z')\n,ClientID = column_ifexists('ClientID_s', 'initialString')\n,LogNumber = column_ifexists('LogNumber_s', 'initialString')\n,Object = column_ifexists('Object_s', 'initialString')\n,SubObject = column_ifexists('SubObject_s', 'initialString')\n,ExternalID = column_ifexists('ExternalID_s', 'initialString')\n,AppLogDateTime_t = column_ifexists('AppLogDateTime_t', '1000-01-01T00:00:00Z')\n,User = column_ifexists('User_s', 'initialString')\n,TransactionCode = column_ifexists('TransactionCode_s', 'initialString')\n,ProgramName = column_ifexists('ProgramName_s', 'initialString')\n,OperationMode = column_ifexists('OperationMode_s', 'initialString')\n,StandardText = column_ifexists('StandardText_s', 'initialString')\n,CallbackType = column_ifexists('CallbackType_s', 'initialString')\n,CallbackProgram = column_ifexists('CallbackProgram_s', 'initialString')\n,CallbackRoutine = column_ifexists('CallbackRoutine_s', 'initialString')\n,ProblemClass = column_ifexists('ProblemClass_s', 'initialString')\n,UserChange = column_ifexists('UserChange_s', 'initialString')\n,LogHandle = column_ifexists('LogHandle_s', 'initialString')\n,ContextDDIC = column_ifexists('ContextDDIC_s', 'initialString')\n,InternalMessageSerial = column_ifexists('InternalMessageSerial_d', 1.1111)\n,MessageType = column_ifexists('MessageType_s', 'initialString')\n,MessageClass = column_ifexists('MessageClass_s', 'initialString')\n,MessageNumber = column_ifexists('MessageNumber_s', 'initialString')\n,MessageText = column_ifexists('MessageText_s', 'initialString')\n,LevelofDetail = column_ifexists('LevelofDetail_s', 'initialString')\n,SortCriterion = column_ifexists('SortCriterion_s', 'initialString')\n,SystemID = column_ifexists('SystemID_s', 'initialString')\n,SystemNumber = column_ifexists('SystemNumber_s', 'initialString')\n,Instance = column_ifexists('Instance_s', 'initialString')\n,Host = column_ifexists('Host_s', 'initialString')\n,Type = column_ifexists('Type', 'initialString')\n);\n\nT_ABAPAppLog_CL | union isfuzzy= true (D_ABAPAppLog_CL  | where TimeGenerated != '1000-01-01T00:00:00Z')\n",
        "SAPFunctionsSAPAuditLogQuery": "//generated function structure for custom log CWSQSAP.ABAPAuditLog_CL\n//generated on 2022-05-07\n//Sentinel4SAP solution version 1.2.98\nlet D_ABAPAuditLog_CL = datatable(TimeGenerated:datetime\n,SAL_DATE:string\n,SAL_TIME:string\n,UpdatedOn_t:datetime\n,AuditClassID:real\n,AlertSeverityText:string\n,SystemID:string\n,Instance:string\n,MonitoringObjectName:string\n,MonitorShortName:string\n,MessageText:string\n,MessageClass:string\n,MessageID:string\n,MessageContainerID:string\n,AlertValue:real\n,AlertSeverity:real\n,ClientID:string\n,User:string\n,Variable1:string\n,Variable2:string\n,Variable3:string\n,Variable4:string\n,TerminalIPv6:string\n,TransactionCode:string\n,ABAPProgramName:string\n,SAPProcesType:string\n,SAPWPName:string\n,Email:string\n,SystemNumber:string\n,Host:string\n,Type:string\n,Computer: string\n,TERM_IPV6: string\n)['1000-01-01T00:00:00Z','initialString','initialString','1000-01-01T00:00:00Z',1.1111,'initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString',1.1111,1.1111,'initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString'];\n\nlet T_ABAPAuditLog_CL = (CWSQSAP.ABAPAuditLog_CL | project\nTimeGenerated = column_ifexists('TimeGenerated', '1000-01-01T00:00:00Z')\n,SAL_DATE = strcat(column_ifexists('SAL_DATE_s', ''), column_ifexists('MSCDATE_s', ''))\n,SAL_TIME = strcat(column_ifexists('SAL_TIME_s', ''), column_ifexists('MSCTIME_s', ''))\n,UpdatedOn_t = column_ifexists('UpdatedOn_t', '1000-01-01T00:00:00Z')\n,AuditClassID = column_ifexists('AuditClassID_d', 1.1111)\n,AlertSeverityText = column_ifexists('AlertSeverityText_s', 'initialString')\n,SystemID = column_ifexists('SystemID_s', 'initialString')\n,Instance = column_ifexists('Instance_s', 'initialString')\n,MonitoringObjectName = column_ifexists('MonitoringObjectName_s', 'initialString')\n,MonitorShortName = column_ifexists('MonitorShortName_s', 'initialString')\n,MessageText = column_ifexists('MessageText_s', 'initialString')\n,MessageClass = column_ifexists('MessageClass_s', 'initialString')\n,MessageID = column_ifexists('MessageID_s', 'initialString')\n,MessageContainerID = column_ifexists('MessageContainerID_s', 'initialString')\n,AlertValue = column_ifexists('AlertValue_d', 1.1111)\n,AlertSeverity = column_ifexists('AlertSeverity_d', 1.1111)\n,ClientID = column_ifexists('ClientID_s', 'initialString')\n,User = column_ifexists('User_s', 'initialString')\n,Variable1 = column_ifexists('Variable1_s', 'initialString')\n,Variable2 = column_ifexists('Variable2_s', 'initialString')\n,Variable3 = column_ifexists('Variable3_s', 'initialString')\n,Variable4 = column_ifexists('Variable4_s', 'initialString')\n,TerminalIPv6 = column_ifexists('TerminalIPv6_s', 'initialString')\n,TransactionCode = column_ifexists('TransactionCode_s', 'initialString')\n,ABAPProgramName = column_ifexists('ABAPProgramName_s', 'initialString')\n,SAPProcesType = column_ifexists('SAPProcesType_s', 'initialString')\n,SAPWPName = column_ifexists('SAPWPName_s', 'initialString')\n,Email = column_ifexists('Email_s', 'initialString')\n,SystemNumber = column_ifexists('SystemNumber_s', 'initialString')\n,Host = column_ifexists('Host_s', 'initialString')\n,Type = column_ifexists('Type', 'initialString')\n,Computer= column_ifexists('Computer', 'initialString')\n,TERM_IPV6= column_ifexists('TERM_IPV6_s', 'initialString')\n| extend Email = iff(isempty(Email), User, Email)\n| extend Host = iff(isempty(Host), TerminalIPv6, Host)\n);\n\nT_ABAPAuditLog_CL | union isfuzzy= true (D_ABAPAuditLog_CL  | where SystemID != 'initialString')\n",
        "SAPFunctionsSAPCRLogQuery": "//generated function structure for custom log CWSQSAP.ABAPCRLog_CL\n//generated on 2022-10-13\n//Sentinel4SAP solution version 2.0.30\n\n// CWSQSAP.ABAPCRLog_CL is a custom log that held the change requests coming from S4S agents untill October 2022\nlet D_ABAPCRLog_CL = datatable(TimeGenerated:datetime\n,Request:string\n,Description:string\n,Category:string\n,ClientID:string\n,Owner:string\n,Status:string\n,ObjectType:string\n,ObjectName:string\n,TableName:string\n,ViewName:string\n,TableKey:string\n,SystemID:string\n,SystemNumber:string\n,Instance:string\n,Host:string\n,Type:string\n)['1000-01-01T00:00:00Z','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString'];\nlet T_ABAPCRLog_CL = (CWSQSAP.ABAPCRLog_CL | project\nTimeGenerated = column_ifexists('TimeGenerated', '1000-01-01T00:00:00Z')\n,Request = column_ifexists('Request_s', 'initialString')\n,Description = column_ifexists('Description_s', 'initialString')\n,Category = column_ifexists('Category', 'initialString')\n,ClientID = column_ifexists('ClientID_s', 'initialString')\n,Owner = column_ifexists('Owner_s', 'initialString')\n,Status = column_ifexists('Status_s', 'initialString')\n,ObjectType = column_ifexists('ObjectType_s', 'initialString')\n,ObjectName = column_ifexists('ObjectName_s', 'initialString')\n,TableName = column_ifexists('TableName_s', 'initialString')\n,ViewName = column_ifexists('ViewName_s', 'initialString')\n,TableKey = column_ifexists('TableKey_s', 'initialString')\n,SystemID = column_ifexists('SystemID_s', 'initialString')\n,SystemNumber = column_ifexists('SystemNumber_s', 'initialString')\n,Instance = column_ifexists('Instance_s', 'initialString')\n,Host = column_ifexists('Host_s', 'initialString')\n,Type = column_ifexists('Type', 'initialString')\n);\n// CWSQSAP.ABAPCRLogHeader_CL is a custom log that holds the change requests headers coming from S4S agents starting from October 2022\nlet D_ABAPCRLogHeader_CL = datatable(TimeGeneratedHeader:datetime\n, TimeGenerated: datetime\n,UpdatedOn: datetime\n,Request:string\n,Description:string\n,Category:string\n,ClientID:string\n,Owner:string\n,Status:string\n,SystemID:string\n,SystemNumber:string\n,Instance:string\n,Host:string\n,Type:string\n)['1000-01-01T00:00:00Z', '1000-01-01T00:00:00Z', '1000-01-01T00:00:00Z','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString'];\nlet T_CRHeader= CWSQSAP.ABAPCRLogHeader_CL\n| where TimeGenerated < now()\n// | project-rename TimeGeneratedHeader= TimeGenerated\n| project TimeGeneratedHeader = column_ifexists('TimeGenerated', todatetime('1000-01-01T00:00:00Z'))\n,Request = column_ifexists('Request_s', 'initialString')\n,Description = column_ifexists('Description_s', 'initialString')\n,Category = column_ifexists('Category', 'initialString')\n,ClientID = column_ifexists('ClientID_s', 'initialString')\n,Owner = column_ifexists('Owner_s', 'initialString')\n,Status = column_ifexists('Status_s', 'initialString')\n,SystemID = column_ifexists('SystemID_s', 'initialString')\n,SystemNumber = column_ifexists('SystemNumber_s', 'initialString')\n,Instance = column_ifexists('Instance_s', 'initialString')\n,Host = column_ifexists('Host_s', 'initialString')\n,Type = column_ifexists('Type', 'initialString')\n, UpdatedOn= column_ifexists('UpdatedOn_t', '1000-01-01T00:00:00Z');\n// CWSQSAP.ABAPCRLogLine_CL is a custom log that holds the change requests line items coming from S4S agents starting October 2022\nlet D_ABAPCRLogLine_CL = datatable(TimeGenerated:datetime\n,Request:string\n,ObjectType:string\n,ObjectName:string\n,TableName:string\n,ViewName:string\n,TableKey:string\n,SystemID:string\n)['1000-01-01T00:00:00Z','initialString','initialString','initialString','initialString','initialString','initialString','initialString'];\nlet T_CRLine= CWSQSAP.ABAPCRLogLine_CL\n| where TimeGenerated < now()\n| project-away TenantId, SourceSystem, Host_s, Instance_s, MG, ManagementGroupName, Type, _ResourceId\n| project TimeGenerated = column_ifexists('TimeGenerated', '1000-01-01T00:00:00Z')\n,Request = column_ifexists('Request_s', 'initialString')\n,ObjectType = column_ifexists('ObjectType_s', 'initialString')\n,ObjectName = column_ifexists('ObjectName_s', 'initialString')\n,TableName = column_ifexists('TableName_s', 'initialString')\n,ViewName = column_ifexists('ViewName_s', 'initialString')\n,TableKey = column_ifexists('TableKey_s', 'initialString')\n,SystemID = column_ifexists('SystemID_s', 'initialString');\n// create a view that details that \"stiches\" the CR header and line together\nlet T_CRLogVT = (T_CRHeader | union isfuzzy=true D_ABAPCRLogHeader_CL) | join kind=inner  (T_CRLine | union isfuzzy=true (D_ABAPCRLogLine_CL | project-away TimeGenerated)) on Request, SystemID\n| project-away Request1, SystemID1\n| where TimeGenerated != '1000-01-01T00:00:00Z'\n| where SystemID != 'initialString'\n| extend Type= \"ABAPCRLog_CL_VT\";\n// union the old agent data (CWSQSAP.ABAPCRLog_CL) with newer agents data (CWSQSAP.ABAPCRLogHeader_CL joined with CWSQSAP.ABAPCRLogLine_CL)\nT_ABAPCRLog_CL | union isfuzzy= true D_ABAPCRLog_CL , T_CRLogVT\n| where TimeGenerated != '1000-01-01T00:00:00Z'\n",
        "SAPFunctionsSAPChangeDocsLogQuery": "//generated function structure for custom log CWSQSAP.ABAPChangeDocsLog_CL\n//generated on 2022-05-07\n//Sentinel4SAP solution version 1.2.98\nlet D_ABAPChangeDocsLog_CL = datatable(TimeGenerated:datetime\n,UDATE:string\n,UTIME:string\n,UpdatedOn_t:datetime\n,ClientID:string\n,ObjectClass:string\n,ObjectID:string\n,ChangeNumber:string\n,User:string\n,TransactionCode:string\n,PlannedChangeNum:string\n,ActualChangeNum:string\n,CreatedfromPlannedChange:string\n,TypeofChange_Header:string\n,Language:string\n,Version:string\n,TableName:string\n,ChangedTableKey:string\n,FieldName:string\n,TypeofChange_Item:string\n,FlagText:string\n,UOMOld:string\n,UOMNew:string\n,CurrencyKeyOld:string\n,CurrencyKeyNew:string\n,ValueOld:string\n,ValueNew:string\n,SystemID:string\n,SystemNumber:string\n,Instance:string\n,Host:string\n,Type:string\n)['1000-01-01T00:00:00Z','initialString','initialString','1000-01-01T00:00:00Z','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString'];\n\nlet T_ABAPChangeDocsLog_CL = (CWSQSAP.ABAPChangeDocsLog_CL | project\nTimeGenerated = column_ifexists('TimeGenerated', '1000-01-01T00:00:00Z')\n,UDATE = column_ifexists('UDATE_s', 'initialString')\n,UTIME = column_ifexists('UTIME_s', 'initialString')\n,UpdatedOn_t = column_ifexists('UpdatedOn_t', '1000-01-01T00:00:00Z')\n,ClientID = column_ifexists('ClientID_s', 'initialString')\n,ObjectClass = column_ifexists('ObjectClass_s', 'initialString')\n,ObjectID = column_ifexists('ObjectID_s', 'initialString')\n,ChangeNumber = column_ifexists('ChangeNumber_s', 'initialString')\n,User = column_ifexists('User_s', 'initialString')\n,TransactionCode = column_ifexists('TransactionCode_s', 'initialString')\n,PlannedChangeNum = column_ifexists('PlannedChangeNum_s', 'initialString')\n,ActualChangeNum = column_ifexists('ActualChangeNum_s', 'initialString')\n,CreatedfromPlannedChange = column_ifexists('CreatedfromPlannedChange_s', 'initialString')\n,TypeofChange_Header = column_ifexists('TypeofChange_Header_s', 'initialString')\n,Language = column_ifexists('Language_s', 'initialString')\n,Version = column_ifexists('Version_s', 'initialString')\n,TableName = column_ifexists('TableName_s', 'initialString')\n,ChangedTableKey = column_ifexists('ChangedTableKey_s', 'initialString')\n,FieldName = column_ifexists('FieldName_s', 'initialString')\n,TypeofChange_Item = column_ifexists('TypeofChange_Item_s', 'initialString')\n,FlagText = column_ifexists('FlagText_s', 'initialString')\n,UOMOld = column_ifexists('UOMOld_s', 'initialString')\n,UOMNew = column_ifexists('UOMNew_s', 'initialString')\n,CurrencyKeyOld = column_ifexists('CurrencyKeyOld_s', 'initialString')\n,CurrencyKeyNew = column_ifexists('CurrencyKeyNew_s', 'initialString')\n,ValueOld = column_ifexists('ValueOld_s', 'initialString')\n,ValueNew = column_ifexists('ValueNew_s', 'initialString')\n,SystemID = column_ifexists('SystemID_s', 'initialString')\n,SystemNumber = column_ifexists('SystemNumber_s', 'initialString')\n,Instance = column_ifexists('Instance_s', 'initialString')\n,Host = column_ifexists('Host_s', 'initialString')\n,Type = column_ifexists('Type', 'initialString')\n);\n\nT_ABAPChangeDocsLog_CL | union isfuzzy= true (D_ABAPChangeDocsLog_CL  | where TimeGenerated != '1000-01-01T00:00:00Z')\n",
        "SAPFunctionsSAPConnectorHealthQuery": "// function parameters:\nlet RedAgo = 21d;\nlet YellowAgo = 1d;\nlet GreenAgo= 1h;\nlet DeletionPatience= 30m;\n// let LatestAgentVersion = '${latestAgentVersion}';\nlet WLResponse= datatable(Value:string)[@'${watchlistItems}'];\nlet SystemRolesDictionary= dynamic({\"UD\": \"Unknown (disconnected)\", \"UP\": \"Unknown (Production)\", \"AH\": \"Agent Heartbeat\", \"P\": \"Production\", \"T\": \"Test\", \"C\": \"Customizing\", \"D\": \"Demo\", \"E\": \"Training/Education\", \"S\": \"SAP reference\"});\n// colors are there for the data connector UI\nlet colors = dynamic (['Green', 'Yellow', 'Red', 'Header', 'Unclear', 'Footer']);\n// prepare a template structure in case we are  missing the CWSQSAP.SAP_HeartBeat_CL table\nlet AgentHealthEmpty= datatable (Agent: string, SystemID: string, LastHealthSeen: datetime, LastDataSeen: datetime, TimeGenerated: datetime, LastConfigedOn: datetime, agent_id_s: string, AgentGUID: string, AgentName: string, KeyMode: string, SdkPath: string, VaultId: string, agent_ver_s: string, SncPath: string, SystemGUID: string, Action: string, WLItemID: string, CLientID: string, message_key_s: string, Message: string, sap_control_abap_s:string, sap_control_java_s:string, sap_client_category_s: string) ['Sentinel solution', 'Solution version check', '2021-03-01T00:00:00Z', '2021-03-01T00:00:00Z', '2021-03-01T00:00:00Z', '2021-03-01T00:00:00Z', 'Sentinel solution', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''];\n// get the configuration of the agents created by the data connector UI\nlet WLFromAPI = WLResponse | extend Value= todynamic(column_ifexists(\"Value\",\"{}\"))\n| mv-expand bagexpansion= array Value\n| project itemsKeyValue= Value[\"properties\"][\"itemsKeyValue\"]\n, _DTItemId= tostring(Value[\"properties\"][\"watchlistItemId\"])\n, LastUpdatedTimeUTC= todatetime(Value[\"systemData\"][\"lastModifiedAt\"])\n| evaluate bag_unpack(itemsKeyValue)\n| extend SearchKey= tostring(column_ifexists('AgentGUID', \"\"));\nlet SAPAgentDetailsWL= (_GetWatchlist('SAPAgentDetails') | extend AgentGUID= tostring(column_ifexists('AgentGUID', '')) | extend SystemGUID= tostring(column_ifexists('SystemGUID', '')) | union (WLFromAPI | extend AgentGUID= tostring(column_ifexists('AgentGUID', '')) | extend SystemGUID= tostring(column_ifexists('SystemGUID', '')))\n| project-rename agent_id_s= SearchKey, LastConfigedOn= LastUpdatedTimeUTC , WLItemID= _DTItemId\n| extend system_id_s= tostring(column_ifexists('SystemID', '_')), AgentGUID= tostring(column_ifexists('AgentGUID', '')), SystemGUID=tostring(column_ifexists('SystemGUID', '')), WLItemID= tostring(WLItemID), AgentName= tostring(column_ifexists('AgentName', '')), VaultId= tostring(column_ifexists('VaultId', '')), client_id_s= substring(tostring(column_ifexists('ClientID', '')),0,3)\n// get last action per agent and system\n| summarize LastConfigedOn= arg_max(LastConfigedOn, *) by AgentGUID, SystemGUID);\n// combine the heartbeats and the watchlist data to produce a list of agents and system IDs.\nlet AgentHealth = materialize((union isfuzzy=true AgentHealthEmpty, SAPAgentDetailsWL, (CWSQSAP.SAP_HeartBeat_CL | extend SystemGUID= column_ifexists('system_guid_g','')))\n| where TimeGenerated > ago(RedAgo) or isnull(TimeGenerated) or TimeGenerated == todatetime('2021-03-01T00:00:00Z')\n| extend LastHealthSeen = max_of(TimeGenerated, LastHealthSeen)\n// add agents from the SAPAgentDetails watchlist in case these are not yet sending data\n| extend Agent= iff(isnotempty(agent_id_s), agent_id_s,column_ifexists('agent_id_g','')), ClientID= column_ifexists('client_id_s', '')\n| summarize Action= take_anyif(Action, isnotempty(Action)),  arg_max(LastHealthSeen, *), LastConfigedOn=max(LastConfigedOn) by Agent, system_id_s, ClientID, SystemGUID\n| extend SystemID = iff(system_id_s == 'N/A' or system_id_s == 'AGENT', 'AGENT', substring(system_id_s, 0, 3)), AgentVersion = agent_ver_s, LastConfigedOn=LastConfigedOn1, IsGUID= isnotnull(toguid(Agent))\n| project-rename MessageKey= message_key_s\n| extend sap_control_java_s= replace_string(sap_control_java_s,\"_\",\"\"), sap_control_abap_s= replace_string(sap_control_abap_s, \"_\", \"\")\n| extend SystemClient= case(SystemID == \"AGENT\", \"AGENT\", SystemID != \"J2E\" , strcat(SystemID, '-', ClientID, iff(isnotempty(sap_control_java_s),strcat(\"-\", sap_control_java_s),\"\"), iff(isnotempty(sap_control_abap_s),strcat(\"-\", sap_control_abap_s),\"\"))\n, SystemID == \"J2E\", strcat(\"J2E\", '-', sap_control_java_s), \"SystemClient N/A\"));\n//  find systems that have been converted to persistant GUIDs. their older IDs should be disregarded\nlet GUIDedSystems= AgentHealth | where IsGUID | summarize by SystemID | extend GUIDedSystem= true;\nlet LastKnownCategory= (union isfuzzy=true AgentHealthEmpty, SAPAgentDetailsWL, CWSQSAP.SAP_HeartBeat_CL) | where TimeGenerated > ago(7d)\n| where bag_has_key(SystemRolesDictionary,sap_client_category_s)\n| extend Agent= iff(isnotempty(agent_id_s), agent_id_s, column_ifexists('agent_id_g','')), ClientID= column_ifexists('client_id_s', '')\n| where isnotempty( ClientID)\n| summarize arg_max(TimeGenerated, sap_client_category_s) by Agent, ClientID, SystemID= system_id_s\n| project-rename LastKnownSystemRoleCode=sap_client_category_s;\n// get the version per agent\nlet AgentsHeader = AgentHealth\n| summarize arg_max(LastHealthSeen, Agent, AgentVersion), AssociatedSystems= make_list_if(SystemID,Action==\"System Created\", 20) by Agent\n| project-keep Agent, AgentVersion, LastHealthSeen, AssociatedSystems\n| extend SystemID = 'Agent Version Check', AssociatedSystems= translate('[\"]','',tostring(AssociatedSystems));\n// AgentsHeader\n// prepare a template structure in case we are  missing all ABAP* tables\nlet AgentPotentialEmpty = datatable (PotentialAgent: string, SystemID_s: string, TimeGenerated: date)[];\n// agent potential- we are looking for SAP systems that send data but not heartbeats. a special case of very old agents that did not have heartbeats\nlet AgentPotential = AgentPotentialEmpty\n| project SystemID_s, TimeGenerated\n| extend PotentialAgent = strcat(SystemID_s, ' ')\n| project-rename SystemID = SystemID_s\n, LastDataSeen = TimeGenerated;\n// helper function- handle values and texts for time spans\nlet FtimePassed = (DateTime: datetime, Occured: int = 1) {\ncase(\ndatetime_diff('Hour', now(), DateTime) < 0 or isnull(DateTime), bag_pack(strcat('{TimeSpan', tostring(Occured), '}'), 'is missing', strcat('{TimeScale', tostring(Occured), '}'), '')\n, datetime_diff('Hour', now(), DateTime) < 2, bag_pack(strcat('{TimeSpan', tostring(Occured), '}'), '1', strcat('{TimeScale', tostring(Occured), '}'), 'hour')\n, datetime_diff('Hour', now(), DateTime) < 24, bag_pack(strcat('{TimeSpan', tostring(Occured), '}'), tostring(datetime_diff('Hour', now(), DateTime)), strcat('{TimeScale', tostring(Occured), '}'), 'hours')\n, datetime_diff('Hour', now(), DateTime) < 48, bag_pack(strcat('{TimeSpan', tostring(Occured), '}'), '1', strcat('{TimeScale', tostring(Occured), '}'), 'day')\n, bag_pack(strcat('{TimeSpan', tostring(Occured), '}'), tostring(datetime_diff('Day', now(), DateTime)), strcat('{TimeScale', tostring(Occured), '}'), 'days'))\n};\n// helper function- determine statuses and details per SID\nlet FBaggedDetails = (Agent: string, LastHealthSeen: datetime, LastConfigedOn: datetime, LastHealthSeen4Agent: datetime, GreenAgo: timespan, YellowAgo: timespan, RedAgo: timespan, AgentVersion: string='0.0', SystemID: string='', MessageKey: string, Action: string) {\ncase(\n// helper function- to make judgment on the agent/ SID status/ version\n// handle deletions:\n// deleted and no hearbeat- that is OK!\n((Action == \"System Deleted\" or Action == \"Agent Deleted\") and (LastHealthSeen < ago(DeletionPatience) or isempty(LastHealthSeen) )),bag_pack('Details', strcat(Action, ' and no hearbeat observed'),'ExtendedDetails', 'The deletion is successful', 'Status', 'Remove', 'MessageCode', 'DeletionSuccess', 'Variables','')\n// deleted in the last DeletionPatience minutes and still heartbeat- warning!\n,((Action == \"System Deleted\" or Action == \"Agent Deleted\") and (LastConfigedOn + DeletionPatience) > LastHealthSeen  ),bag_pack('Details', strcat(Action, ' but heartbeat is still observed'),'ExtendedDetails', 'The deletion is still pending', 'Status', 'Yellow', 'MessageCode', 'DeletionPending', 'Variables','')\n// deleted more than DeletionPatience ago and still heartbeat- error!\n,((Action == \"System Deleted\" or Action == \"Agent Deleted\") and (LastConfigedOn + DeletionPatience) < LastHealthSeen ),bag_pack('Details', strcat(Action, ' but heartbeat is still observed'),'ExtendedDetails', 'The deletion has likely failed', 'Status', 'Red', 'MessageCode', 'DeletionFailed', 'Variables','')\n// PYRFC messages from Heartbeat cannot be good!\n,isnotempty(MessageKey) and MessageKey != \"NOT_AUTHORIZED\" and LastHealthSeen > ago(GreenAgo), bag_pack('Details', strcat('error ', MessageKey, ' received from SAP system'),'ExtendedDetails', strcat('Error ', MessageKey, ' received from the agent'), 'Status', 'Red', 'MessageCode', MessageKey, 'Variables','')\n// MessageKey == \"NOT_AUTHORIZED\" , System Connected  unauthorized to collect role, production assumed, Yellow\n,MessageKey == \"NOT_AUTHORIZED\" and LastHealthSeen > ago(GreenAgo), bag_pack('Details', 'System Connected - unauthorized to collect role, production assumed','ExtendedDetails', 'The agent is missing read permissions for SAP table T000', 'Status', 'Yellow', 'MessageCode', 'NOAUTH', 'Variables','')\n// agent version checks:\n// UPAVLA - An upgrade is available for the Microsoft Sentinel for SAP Agent. <br> Current Agent released date {CurrentVersion}, latest version relesed on {LatestVersion}.\n,(SystemID== 'AGENT' and isnotempty(AgentVersion) and strcmp(LatestAgentVersion, AgentVersion) > 0 ), bag_pack('Details', 'Agent update available', 'ExtendedDetails', 'An upgrade is available for the Microsoft Sentinel for SAP Agent', 'Status', 'Header', 'MessageCode', 'UPAVLA', 'Variables', bag_pack('{CurrentVersion}', AgentVersion, '{LatestVersion}', LatestAgentVersion))\n// Agent Configuration checks:\n// ACIOK - Agent configuration is there (since GreenAgo) and so is heartbeat, remove this configuration check (Green)\n, SystemID== 'AGENT' and (isnotempty(LastConfigedOn) and (LastHealthSeen4Agent > ago(GreenAgo))), bag_pack('Details', 'Agent configuration is there', 'ExtendedDetails', strcat('Agent was configured ', FtimePassed(LastConfigedOn)['{TimeSpan1}'], ' ', FtimePassed(LastConfigedOn)['{TimeScale1}'], ' ago, and heartbeat sent since then'), 'Status', 'Green', 'MessageCode', 'ACIOK', 'Variables', FtimePassed(LastConfigedOn))\n// ACCUY - Agent configuration is there, and there is no heartbeat since (between green and yellow).- (Yellow, StatusCode= 1, )\n, ((SystemID== 'AGENT' and isnotempty(LastConfigedOn) and (max_of(LastHealthSeen4Agent, LastConfigedOn) > ago(YellowAgo)))), bag_pack('Details', 'Agent configuration is incomplete', 'ExtendedDetails', strcat('Agent was configured ', FtimePassed(LastConfigedOn)['{TimeSpan1}'], ' ', FtimePassed(LastConfigedOn)['{TimeScale1}'], ' ago, but no heartbeat was recieved since then. Please review configuration'), 'Status', 'Yellow', 'MessageCode', 'ACCUY', 'Variables', FtimePassed(LastConfigedOn))\n// ACCOY - Agent configuration is there, and there is no heartbeat since (between yellow and red).- (Red, StatusCode=2, )\n, (SystemID== 'AGENT' and isnotempty(LastConfigedOn) and max_of(LastHealthSeen4Agent, LastConfigedOn) < ago(YellowAgo)), bag_pack('Details', 'Agent configuration is incomplete', 'ExtendedDetails', strcat('Agent was configured ', FtimePassed(LastConfigedOn)['{TimeSpan1}'], ' ', FtimePassed(LastConfigedOn)['{TimeScale1}'], ' ago, but no heartbeat was recieved since then. Please review configuration'), 'Status', 'Red', 'MessageCode', 'ACCOY', 'Variables', FtimePassed(LastConfigedOn))\n// handle missing heartbeat at the systems ID level:\n// OKOK - HB recieved in the last {TimeSpan1}' ' {TimeScale1}.\n, ((SystemID != 'AGENT' and LastHealthSeen > ago(GreenAgo)) or (SystemID == 'AGENT' and LastHealthSeen4Agent > ago(GreenAgo))), bag_pack('Details', iff(SystemID == 'AGENT', 'Agent healthy','System healthy'), 'ExtendedDetails', strcat('Heartbeat recieved in the last ', FtimePassed(ago(GreenAgo))['{TimeSpan1}'], ' ', FtimePassed(ago(GreenAgo))['{TimeScale1}']), 'Status', 'Green', 'MessageCode', 'OKOK', 'Variables', FtimePassed(ago(GreenAgo)))\n// MDOG - missing hearbeat for over GreenAgo timespan - Missing data and heartbeat for over {TimeSpan1}' ' {TimeScale1}.  Check Connectivity.\n, ((SystemID != 'AGENT' and  LastHealthSeen < ago(GreenAgo)) or (SystemID == 'AGENT' and LastHealthSeen4Agent > ago(YellowAgo))), bag_pack('Details', strcat(iff(SystemID == 'AGENT', 'Agent ','System '), 'unreachable for over 1 hour'), 'ExtendedDetails', strcat('Missing heartbeat for over ', FtimePassed(ago(GreenAgo))['{TimeSpan1}'], ' ', FtimePassed(ago(GreenAgo))['{TimeScale1}']), 'Status', 'Red', 'MessageCode', 'MDOG', 'Variables', FtimePassed(ago(GreenAgo)))\n// // MDOY - missing heartbeat for over YellowAgo timespan - Missing data and heartbeat for over {TimeSpan1}' ' {TimeScale1}.  Check Connectivity.\n// , ((SystemID != 'AGENT' and LastHealthSeen > ago(RedAgo) or (SystemID == 'AGENT' and LastHealthSeen4Agent > ago(RedAgo)))), bag_pack('Details', strcat(iff(SystemID == 'AGENT', 'Agent ','System '), 'unreachable for over 24 hours'), 'ExtendedDetails', strcat('Missing heartbeat for over ', FtimePassed(ago(YellowAgo))['{TimeSpan1}'], ' ', FtimePassed(ago(YellowAgo))['{TimeScale1}']), 'Status', 'Red', 'MessageCode', 'MDOY', 'Variables', FtimePassed(ago(YellowAgo)))\n// UNCLEAR - fallback of all cases, 'Heartbeat Last Recieved %s ago, heartbeat last recieved %s ago' {Variable1, Variable2}\n, bag_pack('Details', 'Status unclear - check system', 'ExtendedDetails', strcat('Heartbeat last recieved ', FtimePassed(LastHealthSeen)['{TimeSpan1}'], ' ', FtimePassed(LastHealthSeen)['{TimeScale1}'], ' ago'), 'Status', 'Unclear', 'MessageCode', 'UNCLEAR', 'Variables', bag_merge(FtimePassed(LastHealthSeen), FtimePassed(DateTime= LastHealthSeen, Occured=2))))\n};\n// gather the heartbeat and configuration and add a line per agent for version check\nAgentHealth\n// remove the WL fields for now, as these are only there on some of the lines (agents only)\n| project-away AgentGUID, AgentName, KeyMode, SdkPath, VaultId, SncPath, WLItemID, Action\n// now join again with agentHeader to get the last heartbeat recieved from the agent and connected systems\n| join kind= leftouter (AgentsHeader\n| project Agent, LastHealthSeen4Agent= LastHealthSeen, AssociatedSystems, AgentVersion)\non Agent\n// SID health inferred from data coming in- #TODO- remove the agent potential as we have the agent health\n| join kind=fullouter AgentPotential on $left.SystemID == $right.SystemID\n| extend\nAgent = iff(isempty(Agent), PotentialAgent, Agent),\nLastSeen = LastHealthSeen\n| extend SystemID = iff(SystemID == SystemID1, SystemID1, strcat(SystemID1, SystemID))\n| extend LastDataSeen = LastDataSeen1 // LastDataSeen1 is the real one coming from AgentPotential\n// get agent attributes from WL\n| join kind= leftouter  (((SAPAgentDetailsWL | where system_id_s == \"AGENT\") | union AgentHealthEmpty)| project AgentGUID, AgentName, KeyMode, SdkPath, VaultId, SncPath, AgentWLItemID= WLItemID, AgentAction= Action )\non $left.Agent== $right.AgentGUID\n// get system attributes from WL\n| join kind= leftouter  (((SAPAgentDetailsWL | where system_id_s != \"AGENT\") | union AgentHealthEmpty)| project SystemWLItemID= WLItemID, SystemAction= Action, SystemGUID, system_id_s, SystemsAgentGUID= AgentGUID)\non $left.Agent== $right.SystemsAgentGUID, SystemGUID\n| extend WLItemID= iff(SystemID==\"AGENT\", AgentWLItemID, SystemWLItemID)\n| extend Action= iff(SystemID==\"AGENT\", AgentAction, SystemAction)\n// disregard non-GUID-like rows for systems that have been upgraded to be GUID-like\n| lookup GUIDedSystems on SystemID\n| where IsGUID == true or (IsGUID == false and GUIDedSystem != true)\n// get the judgement from FBaggedDetails\n| extend BaggedDetails = FBaggedDetails(Agent, LastHealthSeen, LastConfigedOn, LastHealthSeen4Agent, GreenAgo, YellowAgo, RedAgo, AgentVersion, SystemID, MessageKey, Action)\n| evaluate bag_unpack(BaggedDetails)\n| where Status != 'Remove' // not everything is interesting\n| extend StatusCode = array_index_of(colors, Status)\n| extend SystemRoleCode= column_ifexists(\"sap_client_category_s\",\"N/A\")\n| extend SystemRoleCode= iff(bag_has_key(SystemRolesDictionary,SystemRoleCode), SystemRoleCode, \"N/A\")\n| extend SystemRoleCode= case(SystemRoleCode != \"N/A\", SystemRoleCode, MessageKey == \"NOT_AUTHORIZED\", \"UP\", \"N/A\")\n| lookup LastKnownCategory on Agent, ClientID, SystemID\n| extend SystemRoleCode= iff(SystemRoleCode != \"N/A\", SystemRoleCode, LastKnownSystemRoleCode)\n| extend SystemRole= tostring(SystemRolesDictionary[SystemRoleCode])\n| where isnotempty(SystemID)\n| where isnotempty( LastSeen) or LastConfigedOn > ago(180d)\n| project-keep Agent, SystemID, MessageCode, Details, ExtendedDetails, LastSeen, Status, StatusCode, Variables, AgentGUID, AgentName, KeyMode, SdkPath, VaultId, SncPath, SystemRole, SystemRoleCode, WLItemID, Action, ClientID, SystemGUID, AssociatedSystems, MessageKey, Message, AgentVersion, SystemClient, sap_control_java_s\n| order by StatusCode, Agent desc;\n",
        "SAPFunctionsSAPFilesLogsQuery": "//generated function structure for custom log CWSQSAP.ABAPFilesLogs_CL\n//generated on 2022-05-07\n//Sentinel4SAP solution version 1.2.98\nlet D_ABAPFilesLogs_CL = datatable(TimeGenerated:datetime\n,Extracted:string\n,Type:string\n)['1000-01-01T00:00:00Z','initialString','initialString'];\n\nlet T_ABAPFilesLogs_CL = (CWSQSAP.ABAPFilesLogs_CL | project\nTimeGenerated = column_ifexists('TimeGenerated', '1000-01-01T00:00:00Z')\n,Extracted = column_ifexists('Extracted_s', 'initialString')\n,Type = column_ifexists('Type', 'initialString')\n);\n\nT_ABAPFilesLogs_CL | union isfuzzy= true (D_ABAPFilesLogs_CL  | where TimeGenerated != '1000-01-01T00:00:00Z')\n",
        "SAPFunctionsSAPHeartBeatQuery": "//generated function structure for custom log CWSQSAP.SAP_HeartBeat_CL\n//generated on 2022-12-07\n//Sentinel4SAP solution version 2.0.68\nlet SystemRolesDictionary= dynamic({\"unknown\":\"Production\", \"\":\"Production\", \"P\":\"Production\", \"T\": \"Test\", \"C\": \"Customizing\", \"D\": \"Demo\", \"E\": \"Training/Education\", \"S\":\"SAP reference\"});\nlet D_SAP_HeartBeat_CL = datatable(TimeGenerated:datetime\n,agent_id:string\n,agent_ver:string\n,host:string\n,system_id:string\n,push_timestamp:real\n,agent_timezone:string\n,sap_client_category: string\n,sap_rfc_dest: string\n,client_id: string\n,Message: string\n,message_key: string\n,agent_from_ui: bool\n,sap_control_abap: string\n,sap_control_java: string\n,system_guid: string\n,Type:string\n)['1000-01-01T00:00:00Z','initialString','initialString','initialString','initialString',1.1111,'initialString'\n,'initialString','initialString','initialString', 'initialString', 'initialString', false, 'initialString','initialString', 'initialString', 'initialString'];\nlet T_SAP_HeartBeat_CL = (CWSQSAP.SAP_HeartBeat_CL | project\nTimeGenerated = column_ifexists('TimeGenerated', '1000-01-01T00:00:00Z')\n,agent_id = column_ifexists('agent_id_s', column_ifexists('agent_id_g', 'initialString'))\n,agent_ver = column_ifexists('agent_ver_s', 'initialString')\n,host = column_ifexists('host_s', 'initialString')\n,system_id = column_ifexists('system_id_s', 'initialString')\n,push_timestamp = column_ifexists('push_timestamp_d', 1.1111)\n,agent_timezone = column_ifexists('agent_timezone_s', 'initialString')\n,Type = column_ifexists('Type', 'initialString')\n,sap_client_category= column_ifexists('sap_client_category_s','initialString')\n,sap_rfc_dest= column_ifexists('sap_rfc_dest_s','initialString')\n,client_id= column_ifexists('client_id_s', 'initialString')\n,Message= column_ifexists('Message','initialString')\n,message_key= column_ifexists('message_key_s', 'initialString')\n,agent_from_ui= column_ifexists('agent_from_ui', false)\n,sap_control_abap= column_ifexists('sap_control_abap_s', 'initialString')\n,sap_control_java= column_ifexists('sap_control_java_s','initialString')\n,system_guid= column_ifexists('system_guid_s', column_ifexists('system_guid_g', 'initialString'))\n);\nT_SAP_HeartBeat_CL | union isfuzzy= true (D_SAP_HeartBeat_CL  | where Type != 'initialString')\n| extend SystemRole= tostring(SystemRolesDictionary[sap_client_category])\n",
        "SAPFunctionsSAPJobLogQuery": "//generated function structure for custom log CWSQSAP.ABAPJobLog_CL\n//generated on 2022-05-07\n//Sentinel4SAP solution version 1.2.98\nlet D_ABAPJobLog_CL = datatable(TimeGenerated:datetime\n,Instance:string\n,UserReleaseInstance:string\n,JobName:string\n,JobCount:string\n,MessageText:string\n,SchedulingDateTime_t:datetime\n,StartDateTime_t:datetime\n,JobGroup:string\n,SchedulingUser:string\n,LastChangeByUser:string\n,ReleaseUser:string\n,BackgroundUserforAuthChecks:string\n,ClientID:string\n,WorkProcessNumber:real\n,WorkProcessID:real\n,BgdProcessingEvent:string\n,BgdEventParameters:string\n,TargetServer:string\n,JobClassification:string\n,JobPriority:real\n,MessageClass:string\n,MessageNumber:string\n,MessageType:string\n,ABAPProgram:string\n,GUIStatus:string\n,DynproNumber:string\n,SystemID:string\n,SystemNumber:string\n,Host:string\n,Type:string\n)['1000-01-01T00:00:00Z','initialString','initialString','initialString','initialString','initialString','1000-01-01T00:00:00Z','1000-01-01T00:00:00Z','initialString','initialString','initialString','initialString','initialString','initialString',1.1111,1.1111,'initialString','initialString','initialString','initialString',1.1111,'initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString'];\n\nlet T_ABAPJobLog_CL = (CWSQSAP.ABAPJobLog_CL | project\nTimeGenerated = column_ifexists('TimeGenerated', '1000-01-01T00:00:00Z')\n,Instance = column_ifexists('Instance_s', 'initialString')\n,UserReleaseInstance = column_ifexists('UserReleaseInstance_s', 'initialString')\n,JobName = column_ifexists('JobName_s', 'initialString')\n,JobCount = column_ifexists('JobCount_s', 'initialString')\n,MessageText = column_ifexists('MessageText_s', 'initialString')\n,SchedulingDateTime_t = column_ifexists('SchedulingDateTime_t', '1000-01-01T00:00:00Z')\n,StartDateTime_t = column_ifexists('StartDateTime_t', '1000-01-01T00:00:00Z')\n,JobGroup = column_ifexists('JobGroup_s', 'initialString')\n,SchedulingUser = column_ifexists('SchedulingUser_s', 'initialString')\n,LastChangeByUser = column_ifexists('LastChangeByUser_s', 'initialString')\n,ReleaseUser = column_ifexists('ReleaseUser_s', 'initialString')\n,BackgroundUserforAuthChecks = column_ifexists('BackgroundUserforAuthChecks_s', 'initialString')\n,ClientID = column_ifexists('ClientID_s', 'initialString')\n,WorkProcessNumber = column_ifexists('WorkProcessNumber_d', 1.1111)\n,WorkProcessID = column_ifexists('WorkProcessID_d', 1.1111)\n,BgdProcessingEvent = column_ifexists('BgdProcessingEvent_s', 'initialString')\n,BgdEventParameters = column_ifexists('BgdEventParameters_s', 'initialString')\n,TargetServer = column_ifexists('TargetServer_s', 'initialString')\n,JobClassification = column_ifexists('JobClassification_s', 'initialString')\n,JobPriority = column_ifexists('JobPriority_d', 1.1111)\n,MessageClass = column_ifexists('MessageClass_s', 'initialString')\n,MessageNumber = column_ifexists('MessageNumber_s', 'initialString')\n,MessageType = column_ifexists('MessageType_s', 'initialString')\n,ABAPProgram = column_ifexists('ABAPProgram_s', 'initialString')\n,GUIStatus = column_ifexists('GUIStatus_s', 'initialString')\n,DynproNumber = column_ifexists('DynproNumber_s', 'initialString')\n,SystemID = column_ifexists('SystemID_s', 'initialString')\n,SystemNumber = column_ifexists('SystemNumber_s', 'initialString')\n,Host = column_ifexists('Host_s', 'initialString')\n,Type = column_ifexists('Type', 'initialString')\n);\n\nT_ABAPJobLog_CL | union isfuzzy= true (D_ABAPJobLog_CL  | where TimeGenerated != '1000-01-01T00:00:00Z')\n",
        "SAPFunctionsSAPOS_GWQuery": "//generated function structure for custom log CWSQSAP.ABAPOS_GW_CL\n//generated on 2022-05-07\n//Sentinel4SAP solution version 1.2.98\nlet D_ABAPOS_GW_CL = datatable(TimeGenerated:datetime\n,System:string\n,Severity:string\n,MessageText:string\n,Type:string\n)['1000-01-01T00:00:00Z','initialString','initialString','initialString','initialString'];\n\nlet T_ABAPOS_GW_CL = (CWSQSAP.ABAPOS_GW_CL | project\nTimeGenerated = column_ifexists('TimeGenerated', '1000-01-01T00:00:00Z')\n,System = column_ifexists('System_s', 'initialString')\n,Severity = column_ifexists('Severity_s', 'initialString')\n,MessageText = column_ifexists('MessageText_s', 'initialString')\n,Type = column_ifexists('Type', 'initialString')\n);\n\nT_ABAPOS_GW_CL | union isfuzzy= true (D_ABAPOS_GW_CL  | where TimeGenerated != '1000-01-01T00:00:00Z')\n",
        "SAPFunctionsSAPOS_ICMQuery": "//generated function structure for custom log CWSQSAP.ABAPOS_ICM_CL\n//generated on 2022-05-07\n//Sentinel4SAP solution version 1.2.98\nlet D_ABAPOS_ICM_CL = datatable(TimeGenerated:datetime\n,System:string\n,Severity:string\n,MessageText:string\n,Type:string\n)['1000-01-01T00:00:00Z','initialString','initialString','initialString','initialString'];\n\nlet T_ABAPOS_ICM_CL = (CWSQSAP.ABAPOS_ICM_CL | project\nTimeGenerated = column_ifexists('TimeGenerated', '1000-01-01T00:00:00Z')\n,System = column_ifexists('System_s', 'initialString')\n,Severity = column_ifexists('Severity_s', 'initialString')\n,MessageText = column_ifexists('MessageText_s', 'initialString')\n,Type = column_ifexists('Type', 'initialString')\n);\n\nT_ABAPOS_ICM_CL | union isfuzzy= true (D_ABAPOS_ICM_CL  | where TimeGenerated != '1000-01-01T00:00:00Z')\n",
        "SAPFunctionsSAPOS_SyslogQuery": "//generated function structure for custom log CWSQSAP.ABAPOS_Syslog_CL\n//generated on 2022-05-07\n//Sentinel4SAP solution version 1.2.98\nlet D_ABAPOS_Syslog_CL = datatable(TimeGenerated:datetime\n,System:string\n,Client:string\n,User:string\n,MessageNumber:string\n,Text:string\n,Severity:string\n,TransactionCode:string\n,Type:string\n)['1000-01-01T00:00:00Z','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString'];\n\nlet T_ABAPOS_Syslog_CL = (CWSQSAP.ABAPOS_Syslog_CL | project\nTimeGenerated = column_ifexists('TimeGenerated', '1000-01-01T00:00:00Z')\n,System = column_ifexists('System_s', 'initialString')\n,Client = column_ifexists('Client_s', 'initialString')\n,User = column_ifexists('User_s', 'initialString')\n,MessageNumber = column_ifexists('MessageNumber_s', 'initialString')\n,Text = column_ifexists('Text_s', 'initialString')\n,Severity = column_ifexists('Severity_s', 'initialString')\n,TransactionCode = column_ifexists('TransactionCode_s', 'initialString')\n,Type = column_ifexists('Type', 'initialString')\n);\n\nT_ABAPOS_Syslog_CL | union isfuzzy= true (D_ABAPOS_Syslog_CL  | where TimeGenerated != '1000-01-01T00:00:00Z')\n",
        "SAPFunctionsSAPOS_WPQuery": "//generated function structure for custom log CWSQSAP.ABAPOS_WP_CL\n//generated on 2022-05-07\n//Sentinel4SAP solution version 1.2.98\nlet D_ABAPOS_WP_CL = datatable(TimeGenerated:datetime\n,System:string\n,Severity:string\n,MessageText:string\n,WPnumber:string\n,Type:string\n)['1000-01-01T00:00:00Z','initialString','initialString','initialString','initialString','initialString'];\n\nlet T_ABAPOS_WP_CL = (CWSQSAP.ABAPOS_WP_CL | project\nTimeGenerated = column_ifexists('TimeGenerated', '1000-01-01T00:00:00Z')\n,System = column_ifexists('System_s', 'initialString')\n,Severity = column_ifexists('Severity_s', 'initialString')\n,MessageText = column_ifexists('MessageText_s', 'initialString')\n,WPnumber = column_ifexists('WPnumber_s', 'initialString')\n,Type = column_ifexists('Type', 'initialString')\n);\n\nT_ABAPOS_WP_CL | union isfuzzy= true (D_ABAPOS_WP_CL  | where TimeGenerated != '1000-01-01T00:00:00Z')\n",
        "SAPFunctionsSAPSpoolLogQuery": "//generated function structure for custom log CWSQSAP.ABAPSpoolLog_CL\n//generated on 2022-05-07\n//Sentinel4SAP solution version 1.2.98\nlet D_ABAPSpoolLog_CL = datatable(TimeGenerated:datetime\n,ClientID:string\n,SpoolRequestNumber:string\n,SpoolRequestName:string\n,SpoolRequestSuffix1:string\n,SpoolRequestSuffix2:string\n,User:string\n,ExternalMode:string\n,SpoolRequestCompleted:string\n,TemseReadProtectionRule:string\n,TemseNumDeleteProtectionRule:string\n,TemseNumAddProtectionRule:string\n,TemseNumChangeProtectionRule:string\n,PrintImmediately:string\n,DeleteSpoolRequestAuto:string\n,AutoRereoute:string\n,OutputDevice:string\n,NumofCopies:string\n,Priority:string\n,FormatType:string\n,TemSeGeneralcounter:string\n,SpoolErrorStatus:string\n,TemSeObjectName:string\n,TemSeObjectPart:string\n,SpoolRequestTitle:string\n,DelFlag:string\n,PrintSAPCoverPage:string\n,PrintOSCoverPage:string\n,RecipientofSpoolRequest:string\n,Department:string\n,ArchiveType:string\n,ArchivingDevice:string\n,ArchiveStatus:string\n,ValueAuthCheck:string\n,SpoolRequestisALogForAnotherRequest:string\n,CountryKey:string\n,TelecommunicationsPartner:string\n,TelecommunicationsPartnerE:string\n,DocumentType:string\n,PrinterLongName:string\n,DeletedAt_t:datetime\n,SystemID:string\n,SystemNumber:string\n,Instance:string\n,Host:string\n,Type:string\n)['1000-01-01T00:00:00Z','initialString','1.1111','initialString','initialString','initialString','initialString','initialString','initialString','1.1111','1.1111','1.1111','1.1111','initialString','initialString','initialString','initialString','1.1111','1.1111','initialString','1.1111','initialString','initialString','1.1111','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','1000-01-01T00:00:00Z','initialString','initialString','initialString','initialString','initialString'];\n\nlet T_ABAPSpoolLog_CL = (CWSQSAP.ABAPSpoolLog_CL | project\nTimeGenerated = column_ifexists('TimeGenerated', '1000-01-01T00:00:00Z')\n,ClientID = column_ifexists('ClientID_s', 'initialString')\n,SpoolRequestNumber = strcat(column_ifexists('SpoolRequestNumber_d', '1.1111'),column_ifexists('SpoolRequestNumber_s', '1.1111'))\n,SpoolRequestName = column_ifexists('SpoolRequestName_s', 'initialString')\n,SpoolRequestSuffix1 = column_ifexists('SpoolRequestSuffix1_s', 'initialString')\n,SpoolRequestSuffix2 = column_ifexists('SpoolRequestSuffix2_s', 'initialString')\n,User = column_ifexists('User_s', 'initialString')\n,ExternalMode = column_ifexists('ExternalMode_s', 'initialString')\n,SpoolRequestCompleted = column_ifexists('SpoolRequestCompleted_s', 'initialString')\n,TemseReadProtectionRule = strcat(column_ifexists('TemseReadProtectionRule_d', '1.1111'),column_ifexists('TemseReadProtectionRule_s', '1.1111'))\n,TemseNumDeleteProtectionRule = strcat(column_ifexists('TemseNumDeleteProtectionRule_d', '1.1111'),column_ifexists('TemseNumDeleteProtectionRule_s', '1.1111'))\n,TemseNumAddProtectionRule = strcat(column_ifexists('TemseNumAddProtectionRule_d', '1.1111'), column_ifexists('TemseNumAddProtectionRule_s', '1.1111'))\n,TemseNumChangeProtectionRule = strcat(column_ifexists('TemseNumChangeProtectionRule_d', '1.1111'), column_ifexists('TemseNumChangeProtectionRule_s', '1.1111'))\n,PrintImmediately = column_ifexists('PrintImmediately_s', 'initialString')\n,DeleteSpoolRequestAuto = column_ifexists('DeleteSpoolRequestAuto_s', 'initialString')\n,AutoRereoute = column_ifexists('AutoRereoute_s', 'initialString')\n,OutputDevice = column_ifexists('OutputDevice_s', 'initialString')\n,NumofCopies = strcat(column_ifexists('NumofCopies_d', '1.1111'), column_ifexists('NumofCopies_s', '1.1111'))\n,Priority = strcat(column_ifexists('Priority_d', '1.1111'), column_ifexists('Priority_s', '1.1111'))\n,FormatType = column_ifexists('FormatType_s', 'initialString')\n,TemSeGeneralcounter = strcat(column_ifexists('TemSeGeneralcounter_d', '1.1111'), column_ifexists('TemSeGeneralcounter_s', '1.1111'))\n,SpoolErrorStatus = column_ifexists('SpoolErrorStatus_s', 'initialString')\n,TemSeObjectName = column_ifexists('TemSeObjectName_s', 'initialString')\n,TemSeObjectPart = strcat(column_ifexists('TemSeObjectPart_d', '1.1111'),column_ifexists('TemSeObjectPart_s', '1.1111'))\n,SpoolRequestTitle = column_ifexists('SpoolRequestTitle_s', 'initialString')\n,DelFlag = column_ifexists('DelFlag_s', 'initialString')\n,PrintSAPCoverPage = column_ifexists('PrintSAPCoverPage_s', 'initialString')\n,PrintOSCoverPage = column_ifexists('PrintOSCoverPage_s', 'initialString')\n,RecipientofSpoolRequest = column_ifexists('RecipientofSpoolRequest_s', 'initialString')\n,Department = column_ifexists('Department_s', 'initialString')\n,ArchiveType = column_ifexists('ArchiveType_s', 'initialString')\n,ArchivingDevice = column_ifexists('ArchivingDevice_s', 'initialString')\n,ArchiveStatus = column_ifexists('ArchiveStatus_s', 'initialString')\n,ValueAuthCheck = column_ifexists('ValueAuthCheck_s', 'initialString')\n,SpoolRequestisALogForAnotherRequest = column_ifexists('SpoolRequestisALogForAnotherRequest_s', 'initialString')\n,CountryKey = column_ifexists('CountryKey_s', 'initialString')\n,TelecommunicationsPartner = column_ifexists('TelecommunicationsPartner_s', 'initialString')\n,TelecommunicationsPartnerE = column_ifexists('TelecommunicationsPartnerE_s', 'initialString')\n,DocumentType = column_ifexists('DocumentType_s', 'initialString')\n,PrinterLongName = column_ifexists('PrinterLongName_s', 'initialString')\n,DeletedAt_t = column_ifexists('DeletedAt_t', '1000-01-01T00:00:00Z')\n,SystemID = column_ifexists('SystemID_s', 'initialString')\n,SystemNumber = column_ifexists('SystemNumber_s', 'initialString')\n,Instance = column_ifexists('Instance_s', 'initialString')\n,Host = column_ifexists('Host_s', 'initialString')\n,Type = column_ifexists('Type', 'initialString')\n);\n\nT_ABAPSpoolLog_CL | union isfuzzy= true (D_ABAPSpoolLog_CL  | where ClientID != 'initialString')\n",
        "SAPFunctionsSAPSpoolOutputLogQuery": "//generated function structure for custom log CWSQSAP.ABAPSpoolOutputLog_CL\n//generated on 2022-05-07\n//Sentinel4SAP solution version 1.2.98\nlet D_ABAPSpoolOutputLog_CL = datatable(TimeGenerated:datetime\n,SpoolRequestNumber:string\n,OutputRequestNumber:real\n,OutputDevice:string\n,FormatType:string\n,PhysicalFormatType:string\n,OutputRequestStatus:string\n,TemSeGeneralcounter:real\n,NumofCopies:real\n,StartPage:real\n,LastPage:real\n,User:string\n,SpoolNumberofOutputReqProcessed:real\n,SpoolNumberofOutputReqWithProblems:real\n,SpoolNumberofOutputReqWithErrors:real\n,HostSpoolerID:string\n,ClientID:string\n,Comment:string\n,PrintRequestSize:real\n,ErrorSpoolRequestNumber:real\n,Priority:real\n,ReasonforOutputRequest:string\n,Title:string\n,RecipientofSpoolRequest:string\n,Department:string\n,TelecommunicationsPartner:string\n,HostName:string\n,AppServer:string\n,CopyCount:real\n,CopyCounter:real\n,PrinterLongName:string\n,SystemID:string\n,SystemNumber:string\n,Instance:string\n,Host:string\n,Type:string\n)['1000-01-01T00:00:00Z',1.1111,1.1111,'initialString','initialString','initialString','initialString',1.1111,1.1111,1.1111,1.1111,'initialString',1.1111,1.1111,1.1111,'initialString','initialString','initialString',1.1111,1.1111,1.1111,'initialString','initialString','initialString','initialString','initialString','initialString','initialString',1.1111,1.1111,'initialString','initialString','initialString','initialString','initialString','initialString'];\n\nlet T_ABAPSpoolOutputLog_CL = (CWSQSAP.ABAPSpoolOutputLog_CL | project\nTimeGenerated = column_ifexists('TimeGenerated', '1000-01-01T00:00:00Z')\n,SpoolRequestNumber = strcat(column_ifexists('SpoolRequestNumber_d', '1.1111'),column_ifexists('SpoolRequestNumber_s', '1.1111'))\n,OutputRequestNumber = column_ifexists('OutputRequestNumber_d', 1.1111)\n,OutputDevice = column_ifexists('OutputDevice_s', 'initialString')\n,FormatType = column_ifexists('FormatType_s', 'initialString')\n,PhysicalFormatType = column_ifexists('PhysicalFormatType_s', 'initialString')\n,OutputRequestStatus = column_ifexists('OutputRequestStatus_s', 'initialString')\n,TemSeGeneralcounter = column_ifexists('TemSeGeneralcounter_d', 1.1111)\n,NumofCopies = column_ifexists('NumofCopies_d', 1.1111)\n,StartPage = column_ifexists('StartPage_d', 1.1111)\n,LastPage = column_ifexists('LastPage_d', 1.1111)\n,User = column_ifexists('User_s', 'initialString')\n,SpoolNumberofOutputReqProcessed = column_ifexists('SpoolNumberofOutputReqProcessed_d', 1.1111)\n,SpoolNumberofOutputReqWithProblems = column_ifexists('SpoolNumberofOutputReqWithProblems_d', 1.1111)\n,SpoolNumberofOutputReqWithErrors = column_ifexists('SpoolNumberofOutputReqWithErrors_d', 1.1111)\n,HostSpoolerID = column_ifexists('HostSpoolerID_s', 'initialString')\n,ClientID = column_ifexists('ClientID_s', 'initialString')\n,Comment = column_ifexists('Comment_s', 'initialString')\n,PrintRequestSize = column_ifexists('PrintRequestSize_d', 1.1111)\n,ErrorSpoolRequestNumber = column_ifexists('ErrorSpoolRequestNumber_d', 1.1111)\n,Priority = column_ifexists('Priority_d', 1.1111)\n,ReasonforOutputRequest = column_ifexists('ReasonforOutputRequest_s', 'initialString')\n,Title = column_ifexists('Title_s', 'initialString')\n,RecipientofSpoolRequest = column_ifexists('RecipientofSpoolRequest_s', 'initialString')\n,Department = column_ifexists('Department_s', 'initialString')\n,TelecommunicationsPartner = column_ifexists('TelecommunicationsPartner_s', 'initialString')\n,HostName = column_ifexists('HostName_s', 'initialString')\n,AppServer = column_ifexists('AppServer_s', 'initialString')\n,CopyCount = column_ifexists('CopyCount_d', 1.1111)\n,CopyCounter = column_ifexists('CopyCounter_d', 1.1111)\n,PrinterLongName = column_ifexists('PrinterLongName_s', 'initialString')\n,SystemID = column_ifexists('SystemID_s', 'initialString')\n,SystemNumber = column_ifexists('SystemNumber_s', 'initialString')\n,Instance = column_ifexists('Instance_s', 'initialString')\n,Host = column_ifexists('Host_s', 'initialString')\n,Type = column_ifexists('Type', 'initialString')\n);\n\nT_ABAPSpoolOutputLog_CL | union isfuzzy= true (D_ABAPSpoolOutputLog_CL  | where TimeGenerated != '1000-01-01T00:00:00Z')\n",
        "SAPFunctionsSAPSystemsQuery": "// let SelectedSystems =  dynamic([\"All Systems\"]);//can also do:// let SelectedSystems =  dynamic([\"S4P\", \"B4X\", \"ODT\"]);\n// let SelectedSystemRoles =  dynamic([\"All System Roles\"]); //can also do:let SelectedSystemRoles =  dynamic([\"Production\", \"UAT\"]);\n// let SelectedSystemUsage=  dynamic([\"All Usage Types\"]); //can also do// let SelectedSystemUsage =  dynamic([\"ERP\", \"CRM\"]);\n\nlet SystemRolesDictionary= dynamic({\"UP\":\"Unknown (Production)\", \"AH\":\"Agent Heartbeat\",\"P\":\"Production\", \"T\": \"Test\", \"C\": \"Customizing\", \"D\": \"Demo\", \"E\": \"Training/Education\", \"S\": \"SAP reference\"});\nlet EmptySystems= datatable ( TimeGenerated:datetime, system_id_s: string, SearchKey:string, SystemID:string , SystemRole: string, SystemUsage: string, Priority: int, sap_client_category_s:string, InterfaceAttributes: string )[];\n\n// the 'SAP - Systems' watchlist allows for configuring attributes for each system\nlet SAPSystemsFromWL= _GetWatchlist('SAP - Systems')\n| union isfuzzy=true EmptySystems\n// | project-keep SearchKey, SystemRole, SystemUsage\n| extend Priority= int(2)\n| extend SystemID= SearchKey\n| summarize arg_max(LastUpdatedTimeUTC, *) by SystemID;\n\n// As of agent version 64043801 from November 2022, the hearbeat sends the original system role from SAP\nlet SAPSystemsFromHeartbeat= CWSQSAP.SAP_HeartBeat_CL | where system_id_s != \"AGENT\"\n| union isfuzzy=true EmptySystems\n| summarize arg_max(TimeGenerated, *) by system_id_s\n| extend SystemID= substring(system_id_s,0,3)\n| summarize arg_max(TimeGenerated, *) by SystemID\n| order by SystemID\n| extend SystemRoleCode= column_ifexists(\"sap_client_category_s\",\"UP\")\n| extend SystemRoleCode= iff(bag_has_key(SystemRolesDictionary,SystemRoleCode), SystemRoleCode, \"UP\")\n| extend SystemRole= tostring(SystemRolesDictionary[SystemRoleCode])\n| project SearchKey= SystemID, Priority= int(1), SystemID, SystemRole;\n\nunion isfuzzy=true SAPSystemsFromWL, SAPSystemsFromHeartbeat\n// allow SystemRole to be controlled by the watchlist so users can set own system role (not the one coming from the hearbeat)\n| summarize arg_max(Priority, SystemRole), arg_max(Priority, SystemUsage), arg_max(Priority, InterfaceAttributes)\nby SystemID, SearchKey\n| where SearchKey in (SelectedSystems) or tostring(SelectedSystems) contains 'All Systems'\n| where SystemRole in (SelectedSystemRoles) or tostring(SelectedSystemRoles) contains 'All System Roles'\n| where SystemUsage in (SelectedSystemUsage) or tostring(SelectedSystemUsage) contains 'All Usage Types'\n| project DummyJoinField = 1, SearchKey, SystemID, SystemUsage=iff(isempty(SystemUsage), \"Unknown\", SystemUsage)\n// set \"Production\" as default, just in case it cannot be inferred from data. This value is considered for analytics purposes only, and not billing purposes.\n, SystemRole= iff(isempty(SystemRole), \"Production\", SystemRole), InterfaceAttributes\n",
        "SAPFunctionsSAPTableDataLogQuery": "//generated function structure for custom log CWSQSAP.ABAPTableDataLog_CL\n//generated on 2022-05-07\n//Sentinel4SAP solution version 1.2.98\nlet D_ABAPTableDataLog_CL = datatable(TimeGenerated:datetime\n,DBLogID:string\n,LogKey:string\n,Host:string\n,UserName:string\n,TransactionCode:string\n,Program:string\n,OperationTypeSQL:string\n,VersionNumber:string\n,Language:string\n,TableName:string\n,TableField:string\n,OldValue:string\n,NewValue:string\n,SystemID:string\n,SystemNumber:string\n,Instance:string\n,Type:string\n)['1000-01-01T00:00:00Z','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString'];\n\nlet T_ABAPTableDataLog_CL = (CWSQSAP.ABAPTableDataLog_CL | project\nTimeGenerated = column_ifexists('TimeGenerated', '1000-01-01T00:00:00Z')\n,DBLogID = column_ifexists('DBLogID_s', 'initialString')\n,LogKey = column_ifexists('LogKey_s', 'initialString')\n,Host = column_ifexists('Host_s', 'initialString')\n,UserName = column_ifexists('UserName_s', 'initialString')\n,TransactionCode = column_ifexists('TransactionCode_s', 'initialString')\n,Program = column_ifexists('Program_s', 'initialString')\n,OperationTypeSQL = column_ifexists('OperationTypeSQL_s', 'initialString')\n,VersionNumber = column_ifexists('VersionNumber_s', 'initialString')\n,Language = column_ifexists('Language_s', 'initialString')\n,TableName = column_ifexists('TableName_s', 'initialString')\n,TableField = column_ifexists('TableField_s', 'initialString')\n,OldValue = column_ifexists('OldValue_s', 'initialString')\n,NewValue = column_ifexists('NewValue_s', 'initialString')\n,SystemID = column_ifexists('SystemID_s', 'initialString')\n,SystemNumber = column_ifexists('SystemNumber_s', 'initialString')\n,Instance = column_ifexists('Instance_s', 'initialString')\n,Type = column_ifexists('Type', 'initialString')\n);\n\nT_ABAPTableDataLog_CL | union isfuzzy= true (D_ABAPTableDataLog_CL  | where TimeGenerated != '1000-01-01T00:00:00Z')\n",
        "SAPFunctionsSAPThreatIntelligenceIndicatorQuery": "//generated function structure for table CWSQSOC.ThreatIntelligenceIndicator\n//generated on 2022-12-13\n//Sentinel4SAP solution version 2.0.33\nlet D_ThreatIntelligenceIndicator = datatable(TimeGenerated:datetime\n,Action:string\n,ActivityGroupNames:string\n,AdditionalInformation:string\n,ApplicationId:string\n,AzureTenantId:string\n,ConfidenceScore:real\n,Description:string\n,DiamondModel:string\n,ExternalIndicatorId:string\n,ExpirationDateTime:datetime\n,IndicatorId:string\n,ThreatType:string\n,Active:bool\n,KillChainActions:bool\n,KillChainC2:bool\n,KillChainDelivery:bool\n,KillChainExploitation:bool\n,KillChainReconnaissance:bool\n,KillChainWeaponization:bool\n,KnownFalsePositives:string\n,MalwareNames:string\n,PassiveOnly:bool\n,ThreatSeverity:int\n,Tags:string\n,TrafficLightProtocolLevel:string\n,EmailEncoding:string\n,EmailLanguage:string\n,EmailRecipient:string\n,EmailSenderAddress:string\n,EmailSenderName:string\n,EmailSourceDomain:string\n,EmailSourceIpAddress:string\n,EmailSubject:string\n,EmailXMailer:string\n,FileCompileDateTime:datetime\n,FileCreatedDateTime:datetime\n,FileHashType:string\n,FileHashValue:string\n,FileMutexName:string\n,FileName:string\n,FilePacker:string\n,FilePath:string\n,FileSize:int\n,FileType:string\n,DomainName:string\n,NetworkIP:string\n,NetworkPort:int\n,NetworkDestinationAsn:int\n,NetworkDestinationCidrBlock:string\n,NetworkDestinationIP:string\n,NetworkCidrBlock:string\n,NetworkDestinationPort:int\n,NetworkProtocol:int\n,NetworkSourceAsn:int\n,NetworkSourceCidrBlock:string\n,NetworkSourceIP:string\n,NetworkSourcePort:int\n,Url:string\n,UserAgent:string\n,IndicatorProvider:string\n,Type:string\n)[];\nlet T_ThreatIntelligenceIndicator = (CWSQSOC.ThreatIntelligenceIndicator | project\nTimeGenerated = column_ifexists('TimeGenerated', '1000-01-01T00:00:00Z')\n,Action = column_ifexists('Action', 'initialString')\n,ActivityGroupNames = column_ifexists('ActivityGroupNames', 'initialString')\n,AdditionalInformation = column_ifexists('AdditionalInformation', 'initialString')\n,ApplicationId = column_ifexists('ApplicationId', 'initialString')\n,AzureTenantId = column_ifexists('AzureTenantId', 'initialString')\n,ConfidenceScore = column_ifexists('ConfidenceScore', 1.1111)\n,Description = column_ifexists('Description', 'initialString')\n,DiamondModel = column_ifexists('DiamondModel', 'initialString')\n,ExternalIndicatorId = column_ifexists('ExternalIndicatorId', 'initialString')\n,ExpirationDateTime = column_ifexists('ExpirationDateTime', '1000-01-01T00:00:00Z')\n,IndicatorId = column_ifexists('IndicatorId', 'initialString')\n,ThreatType = column_ifexists('ThreatType', 'initialString')\n,Active = column_ifexists('Active', true)\n,KillChainActions = column_ifexists('KillChainActions', true)\n,KillChainC2 = column_ifexists('KillChainC2', true)\n,KillChainDelivery = column_ifexists('KillChainDelivery', true)\n,KillChainExploitation = column_ifexists('KillChainExploitation', true)\n,KillChainReconnaissance = column_ifexists('KillChainReconnaissance', true)\n,KillChainWeaponization = column_ifexists('KillChainWeaponization', true)\n,KnownFalsePositives = column_ifexists('KnownFalsePositives', 'initialString')\n,MalwareNames = column_ifexists('MalwareNames', 'initialString')\n,PassiveOnly = column_ifexists('PassiveOnly', true)\n,ThreatSeverity = column_ifexists('ThreatSeverity', 1)\n,Tags = column_ifexists('Tags', 'initialString')\n,TrafficLightProtocolLevel = column_ifexists('TrafficLightProtocolLevel', 'initialString')\n,EmailEncoding = column_ifexists('EmailEncoding', 'initialString')\n,EmailLanguage = column_ifexists('EmailLanguage', 'initialString')\n,EmailRecipient = column_ifexists('EmailRecipient', 'initialString')\n,EmailSenderAddress = column_ifexists('EmailSenderAddress', 'initialString')\n,EmailSenderName = column_ifexists('EmailSenderName', 'initialString')\n,EmailSourceDomain = column_ifexists('EmailSourceDomain', 'initialString')\n,EmailSourceIpAddress = column_ifexists('EmailSourceIpAddress', 'initialString')\n,EmailSubject = column_ifexists('EmailSubject', 'initialString')\n,EmailXMailer = column_ifexists('EmailXMailer', 'initialString')\n,FileCompileDateTime = column_ifexists('FileCompileDateTime', '1000-01-01T00:00:00Z')\n,FileCreatedDateTime = column_ifexists('FileCreatedDateTime', '1000-01-01T00:00:00Z')\n,FileHashType = column_ifexists('FileHashType', 'initialString')\n,FileHashValue = column_ifexists('FileHashValue', 'initialString')\n,FileMutexName = column_ifexists('FileMutexName', 'initialString')\n,FileName = column_ifexists('FileName', 'initialString')\n,FilePacker = column_ifexists('FilePacker', 'initialString')\n,FilePath = column_ifexists('FilePath', 'initialString')\n,FileSize = column_ifexists('FileSize', 1)\n,FileType = column_ifexists('FileType', 'initialString')\n,DomainName = column_ifexists('DomainName', 'initialString')\n,NetworkIP = column_ifexists('NetworkIP', 'initialString')\n,NetworkPort = column_ifexists('NetworkPort', 1)\n,NetworkDestinationAsn = column_ifexists('NetworkDestinationAsn', 1)\n,NetworkDestinationCidrBlock = column_ifexists('NetworkDestinationCidrBlock', 'initialString')\n,NetworkDestinationIP = column_ifexists('NetworkDestinationIP', 'initialString')\n,NetworkCidrBlock = column_ifexists('NetworkCidrBlock', 'initialString')\n,NetworkDestinationPort = column_ifexists('NetworkDestinationPort', 1)\n,NetworkProtocol = column_ifexists('NetworkProtocol', 1)\n,NetworkSourceAsn = column_ifexists('NetworkSourceAsn', 1)\n,NetworkSourceCidrBlock = column_ifexists('NetworkSourceCidrBlock', 'initialString')\n,NetworkSourceIP = column_ifexists('NetworkSourceIP', 'initialString')\n,NetworkSourcePort = column_ifexists('NetworkSourcePort', 1)\n,Url = column_ifexists('Url', 'initialString')\n,UserAgent = column_ifexists('UserAgent', 'initialString')\n,IndicatorProvider = column_ifexists('IndicatorProvider', 'initialString')\n,Type = column_ifexists('Type', 'initialString')\n);\nT_ThreatIntelligenceIndicator | union isfuzzy= true D_ThreatIntelligenceIndicator\n",
        "SAPFunctionsSAPWorkflowLogQuery": "//generated function structure for custom log CWSQSAP.ABAPWorkflowLog_CL\n//generated on 2022-05-07\n//Sentinel4SAP solution version 1.2.98\nlet D_ABAPWorkflowLog_CL = datatable(TimeGenerated:datetime\n,ClientID:string\n,WorkItemID:string\n,WorkflowAction:string\n,LogCounter:string\n,MethodUser:string\n,ExceptionforMethod:string\n,ErrorType:string\n,ApplicationArea:string\n,MessageNumber:string\n,MessageType:string\n,WIType:string\n,Creator:string\n,Language:string\n,WIText:string\n,TaskText:string\n,Status:string\n,CreationDateTime_t:datetime\n,ActualAgent:string\n,Address:string\n,UserCreated:string\n,CreatorAddress:string\n,SuperWI:string\n,CallbackFunction:string\n,TaskID:string\n,TopTaskID:string\n,Priority:string\n,TasksClassification:string\n,SimpleContainer:string\n,SystemID:string\n,SystemNumber:string\n,Instance:string\n,Host:string\n,Type:string\n)['1000-01-01T00:00:00Z','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','1000-01-01T00:00:00Z','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString'];\n\nlet T_ABAPWorkflowLog_CL = (CWSQSAP.ABAPWorkflowLog_CL | project\nTimeGenerated = column_ifexists('TimeGenerated', '1000-01-01T00:00:00Z')\n,ClientID = column_ifexists('ClientID_s', 'initialString')\n,WorkItemID = column_ifexists('WorkItemID_s', 'initialString')\n,WorkflowAction = column_ifexists('WorkflowAction_s', 'initialString')\n,LogCounter = column_ifexists('LogCounter_s', 'initialString')\n,MethodUser = column_ifexists('MethodUser_s', 'initialString')\n,ExceptionforMethod = column_ifexists('ExceptionforMethod_s', 'initialString')\n,ErrorType = column_ifexists('ErrorType_s', 'initialString')\n,ApplicationArea = column_ifexists('ApplicationArea_s', 'initialString')\n,MessageNumber = column_ifexists('MessageNumber_s', 'initialString')\n,MessageType = column_ifexists('MessageType_s', 'initialString')\n,WIType = column_ifexists('WIType_s', 'initialString')\n,Creator = column_ifexists('Creator_s', 'initialString')\n,Language = column_ifexists('Language_s', 'initialString')\n,WIText = column_ifexists('WIText_s', 'initialString')\n,TaskText = column_ifexists('TaskText_s', 'initialString')\n,Status = column_ifexists('Status_s', 'initialString')\n,CreationDateTime_t = column_ifexists('CreationDateTime_t', '1000-01-01T00:00:00Z')\n,ActualAgent = column_ifexists('ActualAgent_s', 'initialString')\n,Address = column_ifexists('Address_s', 'initialString')\n,UserCreated = column_ifexists('UserCreated_s', 'initialString')\n,CreatorAddress = column_ifexists('CreatorAddress_s', 'initialString')\n,SuperWI = column_ifexists('SuperWI_s', 'initialString')\n,CallbackFunction = column_ifexists('CallbackFunction_s', 'initialString')\n,TaskID = column_ifexists('TaskID_s', 'initialString')\n,TopTaskID = column_ifexists('TopTaskID_s', 'initialString')\n,Priority = column_ifexists('Priority_s', 'initialString')\n,TasksClassification = column_ifexists('TasksClassification_s', 'initialString')\n,SimpleContainer = column_ifexists('SimpleContainer_s', 'initialString')\n,SystemID = column_ifexists('SystemID_s', 'initialString')\n,SystemNumber = column_ifexists('SystemNumber_s', 'initialString')\n,Instance = column_ifexists('Instance_s', 'initialString')\n,Host = column_ifexists('Host_s', 'initialString')\n,Type = column_ifexists('Type', 'initialString')\n);\n\nT_ABAPWorkflowLog_CL | union isfuzzy= true (D_ABAPWorkflowLog_CL  | where TimeGenerated != '1000-01-01T00:00:00Z')\n",
        "SAPFunctionsSAP_ADCPQuery": "//generated function structure for custom log CWSQSAP.ABAP_ADCP_CL\n//generated on 2022-05-07\n//Sentinel4SAP solution version 1.2.98\nlet D_ABAP_ADCP_CL = datatable(TimeGenerated:datetime\n,CLIENT:string\n,ADDRNUMBER:string\n,PERSNUMBER:string\n,DATE_FROM:string\n,NATION:string\n,DATE_TO:string\n,COMP_PERS:string\n,SO_KEY:string\n,DEPARTMENT:string\n,FUNCTION:string\n,BUILDING:string\n,FLOOR:string\n,ROOMNUMBER:string\n,ID_CODE:string\n,IH_MAIL:string\n,SORT1:string\n,SORT2:string\n,SORT_PHN:string\n,ALT_COMPNY:string\n,DEFLT_COMM:string\n,TEL_NUMBER:string\n,TEL_EXTENS:string\n,FAX_NUMBER:string\n,FAX_EXTENS:string\n,FLAGCOMM2:string\n,FLAGCOMM3:string\n,FLAGCOMM4:string\n,FLAGCOMM5:string\n,FLAGCOMM6:string\n,FLAGCOMM7:string\n,FLAGCOMM8:string\n,FLAGCOMM9:string\n,FLAGCOMM10:string\n,FLAGCOMM11:string\n,FLAGCOMM12:string\n,FLAGCOMM13:string\n,UUID_BELATED:string\n,ID_CATEGORY:string\n,ADCP_ERR_STATUS:string\n,XPCPT:string\n,_DATAAGING:string\n,SystemID:string\n,Type:string\n)['1000-01-01T00:00:00Z','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString'];\n\nlet T_ABAP_ADCP_CL = (CWSQSAP.ABAP_ADCP_CL | project\nTimeGenerated = column_ifexists('TimeGenerated', '1000-01-01T00:00:00Z')\n,CLIENT = column_ifexists('CLIENT_s', 'initialString')\n,ADDRNUMBER = column_ifexists('ADDRNUMBER_s', 'initialString')\n,PERSNUMBER = column_ifexists('PERSNUMBER_s', 'initialString')\n,DATE_FROM = column_ifexists('DATE_FROM_s', 'initialString')\n,NATION = column_ifexists('NATION_s', 'initialString')\n,DATE_TO = column_ifexists('DATE_TO_s', 'initialString')\n,COMP_PERS = column_ifexists('COMP_PERS_s', 'initialString')\n,SO_KEY = column_ifexists('SO_KEY_s', 'initialString')\n,DEPARTMENT = column_ifexists('DEPARTMENT_s', 'initialString')\n,FUNCTION = column_ifexists('FUNCTION_s', 'initialString')\n,BUILDING = column_ifexists('BUILDING_s', 'initialString')\n,FLOOR = column_ifexists('FLOOR_s', 'initialString')\n,ROOMNUMBER = column_ifexists('ROOMNUMBER_s', 'initialString')\n,ID_CODE = column_ifexists('ID_CODE_s', 'initialString')\n,IH_MAIL = column_ifexists('IH_MAIL_s', 'initialString')\n,SORT1 = column_ifexists('SORT1_s', 'initialString')\n,SORT2 = column_ifexists('SORT2_s', 'initialString')\n,SORT_PHN = column_ifexists('SORT_PHN_s', 'initialString')\n,ALT_COMPNY = column_ifexists('ALT_COMPNY_s', 'initialString')\n,DEFLT_COMM = column_ifexists('DEFLT_COMM_s', 'initialString')\n,TEL_NUMBER = column_ifexists('TEL_NUMBER_s', 'initialString')\n,TEL_EXTENS = column_ifexists('TEL_EXTENS_s', 'initialString')\n,FAX_NUMBER = column_ifexists('FAX_NUMBER_s', 'initialString')\n,FAX_EXTENS = column_ifexists('FAX_EXTENS_s', 'initialString')\n,FLAGCOMM2 = column_ifexists('FLAGCOMM2_s', 'initialString')\n,FLAGCOMM3 = column_ifexists('FLAGCOMM3_s', 'initialString')\n,FLAGCOMM4 = column_ifexists('FLAGCOMM4_s', 'initialString')\n,FLAGCOMM5 = column_ifexists('FLAGCOMM5_s', 'initialString')\n,FLAGCOMM6 = column_ifexists('FLAGCOMM6_s', 'initialString')\n,FLAGCOMM7 = column_ifexists('FLAGCOMM7_s', 'initialString')\n,FLAGCOMM8 = column_ifexists('FLAGCOMM8_s', 'initialString')\n,FLAGCOMM9 = column_ifexists('FLAGCOMM9_s', 'initialString')\n,FLAGCOMM10 = column_ifexists('FLAGCOMM10_s', 'initialString')\n,FLAGCOMM11 = column_ifexists('FLAGCOMM11_s', 'initialString')\n,FLAGCOMM12 = column_ifexists('FLAGCOMM12_s', 'initialString')\n,FLAGCOMM13 = column_ifexists('FLAGCOMM13_s', 'initialString')\n,UUID_BELATED = column_ifexists('UUID_BELATED_s', 'initialString')\n,ID_CATEGORY = column_ifexists('ID_CATEGORY_s', 'initialString')\n,ADCP_ERR_STATUS = column_ifexists('ADCP_ERR_STATUS_s', 'initialString')\n,XPCPT = column_ifexists('XPCPT_s', 'initialString')\n,_DATAAGING = column_ifexists('_DATAAGING_s', 'initialString')\n,SystemID = column_ifexists('SystemID_s', 'initialString')\n,Type = column_ifexists('Type', 'initialString')\n);\n\nT_ABAP_ADCP_CL | union isfuzzy= true (D_ABAP_ADCP_CL  | where TimeGenerated != '1000-01-01T00:00:00Z')\n",
        "SAPFunctionsSAP_ADR6Query": "// generated function structure for custom log CWSQSAP.ABAP_ADR6_CL\n// generated on 2022-09-12\n// Sentinel4SAP solution version 2.0.20\n// note that CWSQSAP.ABAP_ADR6_CL custom log has been enhanced with the SAP agent version 60075287 to show user names and restricted only to SAP users\n// get the user MD lookback period\nlet UserMDLookBack = totimespan(toscalar(SAPGetParameters('UserMDLookBack')| project-keep ValueLow));\n\nlet D_ABAP_ADR6_CL = datatable(TimeGenerated:datetime\n,CLIENT:string\n,BNAME:string\n,ADDRNUMBER:string\n,PERSNUMBER:string\n,DATE_FROM:string\n,CONSNUMBER:string\n,FLGDEFAULT:string\n,FLG_NOUSE:string\n,HOME_FLAG:string\n,SMTP_ADDR:string\n,SMTP_SRCH:string\n,DFT_RECEIV:string\n,R3_USER:string\n,ENCODE:string\n,TNEF:string\n,VALID_FROM:string\n,VALID_TO:string\n,_DATAAGING:string\n,SystemID:string\n,Type:string\n)['1000-01-01T00:00:00Z','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString'];\n\nlet T_ABAP_ADR6_CL = (CWSQSAP.ABAP_ADR6_CL | where TimeGenerated > ago(UserMDLookBack)\n| project\nTimeGenerated = column_ifexists('TimeGenerated', '1000-01-01T00:00:00Z')\n,CLIENT = column_ifexists('CLIENT_s', 'initialString')\n,BNAME = column_ifexists('BNAME_s', 'initialString')\n,ADDRNUMBER = column_ifexists('ADDRNUMBER_s', 'initialString')\n,PERSNUMBER = column_ifexists('PERSNUMBER_s', 'initialString')\n,DATE_FROM = column_ifexists('DATE_FROM_s', 'initialString')\n,CONSNUMBER = column_ifexists('CONSNUMBER_s', 'initialString')\n,FLGDEFAULT = column_ifexists('FLGDEFAULT_s', 'initialString')\n,FLG_NOUSE = column_ifexists('FLG_NOUSE_s', 'initialString')\n,HOME_FLAG = column_ifexists('HOME_FLAG_s', 'initialString')\n,SMTP_ADDR = column_ifexists('SMTP_ADDR_s', 'initialString')\n,SMTP_SRCH = column_ifexists('SMTP_SRCH_s', 'initialString')\n,DFT_RECEIV = column_ifexists('DFT_RECEIV_s', 'initialString')\n,R3_USER = column_ifexists('R3_USER_s', 'initialString')\n,ENCODE = column_ifexists('ENCODE_s', 'initialString')\n,TNEF = column_ifexists('TNEF_s', 'initialString')\n,VALID_FROM = column_ifexists('VALID_FROM_s', 'initialString')\n,VALID_TO = column_ifexists('VALID_TO_s', 'initialString')\n,_DATAAGING = column_ifexists('_DATAAGING_s', 'initialString')\n,SystemID = column_ifexists('SystemID_s', 'initialString')\n,Type = column_ifexists('Type', 'initialString')\n);\n\nT_ABAP_ADR6_CL | union isfuzzy= true (D_ABAP_ADR6_CL  | where TimeGenerated != '1000-01-01T00:00:00Z')\n",
        "SAPFunctionsSAP_AGR_1251Query": "//generated function structure for custom log CWSQSAP.ABAP_AGR_1251_CL\n//generated on 2022-05-07\n//Sentinel4SAP solution version 1.2.98\nlet D_ABAP_AGR_1251_CL = datatable(TimeGenerated:datetime\n,MANDT:string\n,AGR_NAME:string\n,COUNTER:string\n,OBJECT:string\n,AUTH:string\n,VARIANT:string\n,FIELD:string\n,LOW:string\n,HIGH:string\n,MODIFIED:string\n,DELETED:string\n,COPIED:string\n,NEU:string\n,NODE:string\n,SystemID:string\n,Type:string\n)['1000-01-01T00:00:00Z','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString'];\n\nlet T_ABAP_AGR_1251_CL = (CWSQSAP.ABAP_AGR_1251_CL | project\nTimeGenerated = column_ifexists('TimeGenerated', '1000-01-01T00:00:00Z')\n,MANDT = column_ifexists('MANDT_s', 'initialString')\n,AGR_NAME = column_ifexists('AGR_NAME_s', 'initialString')\n,COUNTER = column_ifexists('COUNTER_s', 'initialString')\n,OBJECT = column_ifexists('OBJECT_s', 'initialString')\n,AUTH = column_ifexists('AUTH_s', 'initialString')\n,VARIANT = column_ifexists('VARIANT_s', 'initialString')\n,FIELD = column_ifexists('FIELD_s', 'initialString')\n,LOW = column_ifexists('LOW_s', 'initialString')\n,HIGH = column_ifexists('HIGH_s', 'initialString')\n,MODIFIED = column_ifexists('MODIFIED_s', 'initialString')\n,DELETED = column_ifexists('DELETED_s', 'initialString')\n,COPIED = column_ifexists('COPIED_s', 'initialString')\n,NEU = column_ifexists('NEU_s', 'initialString')\n,NODE = column_ifexists('NODE_s', 'initialString')\n,SystemID = column_ifexists('SystemID_s', 'initialString')\n,Type = column_ifexists('Type', 'initialString')\n);\n\nT_ABAP_AGR_1251_CL | union isfuzzy= true (D_ABAP_AGR_1251_CL  | where TimeGenerated != '1000-01-01T00:00:00Z')\n",
        "SAPFunctionsSAP_AGR_AGRSQuery": "//generated function structure for custom log CWSQSAP.ABAP_AGR_AGRS_CL\n//generated on 2022-05-07\n//Sentinel4SAP solution version 1.2.98\nlet D_ABAP_AGR_AGRS_CL = datatable(TimeGenerated:datetime\n,MANDT:string\n,AGR_NAME:string\n,CHILD_AGR:string\n,ATTRIBUTES:string\n,SystemID:string\n,Type:string\n)['1000-01-01T00:00:00Z','initialString','initialString','initialString','initialString','initialString','initialString'];\n\nlet T_ABAP_AGR_AGRS_CL = (CWSQSAP.ABAP_AGR_AGRS_CL | project\nTimeGenerated = column_ifexists('TimeGenerated', '1000-01-01T00:00:00Z')\n,MANDT = column_ifexists('MANDT_s', 'initialString')\n,AGR_NAME = column_ifexists('AGR_NAME_s', 'initialString')\n,CHILD_AGR = column_ifexists('CHILD_AGR_s', 'initialString')\n,ATTRIBUTES = column_ifexists('ATTRIBUTES_s', 'initialString')\n,SystemID = column_ifexists('SystemID_s', 'initialString')\n,Type = column_ifexists('Type', 'initialString')\n);\n\nT_ABAP_AGR_AGRS_CL | union isfuzzy= true (D_ABAP_AGR_AGRS_CL  | where TimeGenerated != '1000-01-01T00:00:00Z')\n",
        "SAPFunctionsSAP_AGR_DEFINEQuery": "//generated function structure for custom log CWSQSAP.ABAP_AGR_DEFINE_CL\n//generated on 2022-05-07\n//Sentinel4SAP solution version 1.2.98\nlet D_ABAP_AGR_DEFINE_CL = datatable(TimeGenerated:datetime\n,MANDT:string\n,AGR_NAME:string\n,PARENT_AGR:string\n,CREATE_USR:string\n,CREATE_DAT:string\n,CREATE_TIM:string\n,CREATE_TMP:string\n,CHANGE_USR:string\n,CHANGE_DAT:string\n,CHANGE_TIM:string\n,CHANGE_TMP:string\n,ATTRIBUTES:string\n,SystemID:string\n,Type:string\n)['1000-01-01T00:00:00Z','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString'];\n\nlet T_ABAP_AGR_DEFINE_CL = (CWSQSAP.ABAP_AGR_DEFINE_CL | project\nTimeGenerated = column_ifexists('TimeGenerated', '1000-01-01T00:00:00Z')\n,MANDT = column_ifexists('MANDT_s', 'initialString')\n,AGR_NAME = column_ifexists('AGR_NAME_s', 'initialString')\n,PARENT_AGR = column_ifexists('PARENT_AGR_s', 'initialString')\n,CREATE_USR = column_ifexists('CREATE_USR_s', 'initialString')\n,CREATE_DAT = column_ifexists('CREATE_DAT_s', 'initialString')\n,CREATE_TIM = column_ifexists('CREATE_TIM_s', 'initialString')\n,CREATE_TMP = column_ifexists('CREATE_TMP_s', 'initialString')\n,CHANGE_USR = column_ifexists('CHANGE_USR_s', 'initialString')\n,CHANGE_DAT = column_ifexists('CHANGE_DAT_s', 'initialString')\n,CHANGE_TIM = column_ifexists('CHANGE_TIM_s', 'initialString')\n,CHANGE_TMP = column_ifexists('CHANGE_TMP_s', 'initialString')\n,ATTRIBUTES = column_ifexists('ATTRIBUTES_s', 'initialString')\n,SystemID = column_ifexists('SystemID_s', 'initialString')\n,Type = column_ifexists('Type', 'initialString')\n);\n\nT_ABAP_AGR_DEFINE_CL | union isfuzzy= true (D_ABAP_AGR_DEFINE_CL  | where TimeGenerated != '1000-01-01T00:00:00Z')\n",
        "SAPFunctionsSAP_AGR_FLAGSQuery": "//generated function structure for custom log CWSQSAP.ABAP_AGR_FLAGS_CL\nlet D_ABAP_AGR_FLAGS_CL = datatable(TimeGenerated:datetime\n,FLAG_VALUE_g:string\n,MANDT:string\n,AGR_NAME:string\n,FLAG_TYPE:string\n,CREATE_USR:string\n,CREATE_DAT:string\n,CREATE_TIM:string\n,CHANGE_USR:string\n,CHANGE_DAT:string\n,CHANGE_TIM:string\n,FLAG_VALUE:string\n,SystemID:string\n,Type:string\n)[];\n\nlet T_ABAP_AGR_FLAGS_CL = (CWSQSAP.ABAP_AGR_FLAGS_CL | project\nTimeGenerated = TimeGenerated\n,FLAG_VALUE_g = FLAG_VALUE_g\n,MANDT = MANDT_s\n,AGR_NAME = AGR_NAME_s\n,FLAG_TYPE = FLAG_TYPE_s\n,CREATE_USR = CREATE_USR_s\n,CREATE_DAT = CREATE_DAT_s\n,CREATE_TIM = CREATE_TIM_s\n,CHANGE_USR = CHANGE_USR_s\n,CHANGE_DAT = CHANGE_DAT_s\n,CHANGE_TIM = CHANGE_TIM_s\n,FLAG_VALUE = FLAG_VALUE_s\n,SystemID = SystemID_s\n,Type = Type\n);\n\nT_ABAP_AGR_FLAGS_CL | union isfuzzy= true D_ABAP_AGR_FLAGS_CL\n",
        "SAPFunctionsSAP_AGR_PROFQuery": "//generated function structure for custom log CWSQSAP.ABAP_AGR_PROF_CL\n//generated on 2022-05-07\n//Sentinel4SAP solution version 1.2.98\nlet D_ABAP_AGR_PROF_CL = datatable(TimeGenerated:datetime\n,MANDT:string\n,AGR_NAME:string\n,LANGU:string\n,PROFILE:string\n,PTEXT:string\n,SystemID:string\n,Type:string\n)['1000-01-01T00:00:00Z','initialString','initialString','initialString','initialString','initialString','initialString','initialString'];\n\nlet T_ABAP_AGR_PROF_CL = (CWSQSAP.ABAP_AGR_PROF_CL | project\nTimeGenerated = column_ifexists('TimeGenerated', '1000-01-01T00:00:00Z')\n,MANDT = column_ifexists('MANDT_s', 'initialString')\n,AGR_NAME = column_ifexists('AGR_NAME_s', 'initialString')\n,LANGU = column_ifexists('LANGU_s', 'initialString')\n,PROFILE = column_ifexists('PROFILE_s', 'initialString')\n,PTEXT = column_ifexists('PTEXT_s', 'initialString')\n,SystemID = column_ifexists('SystemID_s', 'initialString')\n,Type = column_ifexists('Type', 'initialString')\n);\n\nT_ABAP_AGR_PROF_CL | union isfuzzy= true (D_ABAP_AGR_PROF_CL  | where TimeGenerated != '1000-01-01T00:00:00Z')\n",
        "SAPFunctionsSAP_AGR_TCODESQuery": "//generated function structure for custom log CWSQSAP.ABAP_AGR_TCODES_CL\n//generated on 2022-05-07\n//Sentinel4SAP solution version 1.2.98\nlet D_ABAP_AGR_TCODES_CL = datatable(TimeGenerated:datetime\n,MANDT:string\n,AGR_NAME:string\n,TYPE:string\n,TCODE:string\n,EXCLUDE:string\n,DIRECT:string\n,INHERITED:string\n,FOLDER:string\n,SystemID:string\n,Type:string\n)['1000-01-01T00:00:00Z','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString'];\n\nlet T_ABAP_AGR_TCODES_CL = (CWSQSAP.ABAP_AGR_TCODES_CL | project\nTimeGenerated = column_ifexists('TimeGenerated', '1000-01-01T00:00:00Z')\n,MANDT = column_ifexists('MANDT_s', 'initialString')\n,AGR_NAME = column_ifexists('AGR_NAME_s', 'initialString')\n,TYPE = column_ifexists('TYPE_s', 'initialString')\n,TCODE = column_ifexists('TCODE_s', 'initialString')\n,EXCLUDE = column_ifexists('EXCLUDE_s', 'initialString')\n,DIRECT = column_ifexists('DIRECT_s', 'initialString')\n,INHERITED = column_ifexists('INHERITED_s', 'initialString')\n,FOLDER = column_ifexists('FOLDER_s', 'initialString')\n,SystemID = column_ifexists('SystemID_s', 'initialString')\n,Type = column_ifexists('Type', 'initialString')\n);\n\nT_ABAP_AGR_TCODES_CL | union isfuzzy= true (D_ABAP_AGR_TCODES_CL  | where TimeGenerated != '1000-01-01T00:00:00Z')\n",
        "SAPFunctionsSAP_AGR_USERSQuery": "//generated function structure for custom log CWSQSAP.ABAP_AGR_USERS_CL\n//generated on 2022-05-07\n//Sentinel4SAP solution version 1.2.98\nlet D_ABAP_AGR_USERS_CL = datatable(TimeGenerated:datetime\n,MANDT:string\n,AGR_NAME:string\n,UNAME:string\n,FROM_DAT:string\n,TO_DAT:string\n,EXCLUDE:string\n,CHANGE_DAT:string\n,CHANGE_TIM:string\n,CHANGE_TST:string\n,ORG_FLAG:string\n,COL_FLAG:string\n,SystemID:string\n,Type:string\n)['1000-01-01T00:00:00Z','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString'];\n\nlet T_ABAP_AGR_USERS_CL = (CWSQSAP.ABAP_AGR_USERS_CL | project\nTimeGenerated = column_ifexists('TimeGenerated', '1000-01-01T00:00:00Z')\n,MANDT = column_ifexists('MANDT_s', 'initialString')\n,AGR_NAME = column_ifexists('AGR_NAME_s', 'initialString')\n,UNAME = column_ifexists('UNAME_s', 'initialString')\n,FROM_DAT = column_ifexists('FROM_DAT_s', 'initialString')\n,TO_DAT = column_ifexists('TO_DAT_s', 'initialString')\n,EXCLUDE = column_ifexists('EXCLUDE_s', 'initialString')\n,CHANGE_DAT = column_ifexists('CHANGE_DAT_s', 'initialString')\n,CHANGE_TIM = column_ifexists('CHANGE_TIM_s', 'initialString')\n,CHANGE_TST = column_ifexists('CHANGE_TST_s', 'initialString')\n,ORG_FLAG = column_ifexists('ORG_FLAG_s', 'initialString')\n,COL_FLAG = column_ifexists('COL_FLAG_s', 'initialString')\n,SystemID = column_ifexists('SystemID_s', 'initialString')\n,Type = column_ifexists('Type', 'initialString')\n);\n\nT_ABAP_AGR_USERS_CL | union isfuzzy= true (D_ABAP_AGR_USERS_CL  | where TimeGenerated != '1000-01-01T00:00:00Z')\n",
        "SAPFunctionsSAP_DEVACCESSQuery": "//generated function structure for custom log CWSQSAP.ABAP_DEVACCESS_CL\n//generated on 2022-05-07\n//Sentinel4SAP solution version 1.2.98\nlet D_ABAP_DEVACCESS_CL = datatable(TimeGenerated:datetime\n,UNAME:string\n,ACCESSKEY:string\n,SystemID:string\n,Type:string\n)['1000-01-01T00:00:00Z','initialString','initialString','initialString','initialString'];\n\nlet T_ABAP_DEVACCESS_CL = (CWSQSAP.ABAP_DEVACCESS_CL | project\nTimeGenerated = column_ifexists('TimeGenerated', '1000-01-01T00:00:00Z')\n,UNAME = column_ifexists('UNAME_s', 'initialString')\n,ACCESSKEY = column_ifexists('ACCESSKEY_s', 'initialString')\n,SystemID = column_ifexists('SystemID_s', 'initialString')\n,Type = column_ifexists('Type', 'initialString')\n);\n\nT_ABAP_DEVACCESS_CL | union isfuzzy= true (D_ABAP_DEVACCESS_CL  | where TimeGenerated != '1000-01-01T00:00:00Z')\n",
        "SAPFunctionsSAP_PAHIQuery": "//generated function structure for custom log CWSQSAP.ABAP_PAHI_CL\n//generated on 2022-05-07\n//Sentinel4SAP solution version 1.2.98\nlet D_ABAP_PAHI_CL = datatable(TimeGenerated:datetime\n,PARTYPE:string\n,HOSTNAME:string\n,SYSTEMID:string\n,PARDATE:string\n,PARNAME:string\n,PARSTATE:string\n,PARVALUE:string\n,SystemID:string\n,Type:string\n)['1000-01-01T00:00:00Z','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString'];\n\nlet T_ABAP_PAHI_CL = (CWSQSAP.ABAP_PAHI_CL | project\nTimeGenerated = column_ifexists('TimeGenerated', '1000-01-01T00:00:00Z')\n,PARTYPE = column_ifexists('PARTYPE_s', 'initialString')\n,HOSTNAME = column_ifexists('HOSTNAME_s', 'initialString')\n,SYSTEMID = column_ifexists('SYSTEMID_s', 'initialString')\n,PARDATE = column_ifexists('PARDATE_s', 'initialString')\n,PARNAME = column_ifexists('PARNAME_s', 'initialString')\n,PARSTATE = column_ifexists('PARSTATE_s', 'initialString')\n,PARVALUE = column_ifexists('PARVALUE_s', 'initialString')\n,SystemID = column_ifexists('SystemID_s', 'initialString')\n,Type = column_ifexists('Type', 'initialString')\n);\n\nT_ABAP_PAHI_CL | union isfuzzy= true (D_ABAP_PAHI_CL  | where TimeGenerated != '1000-01-01T00:00:00Z')\n",
        "SAPFunctionsSAP_USGRP_USERQuery": "//generated function structure for custom log CWSQSAP.ABAP_USGRP_USER_CL\n//generated on 2022-05-07\n//Sentinel4SAP solution version 1.2.98\nlet D_ABAP_USGRP_USER_CL = datatable(TimeGenerated:datetime\n,MANDT:string\n,BNAME:string\n,USERGROUP:string\n,FROM_DAT:string\n,TO_DAT:string\n,ORGFLAG:string\n,SystemID:string\n,Type:string\n)['1000-01-01T00:00:00Z','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString'];\n\nlet T_ABAP_USGRP_USER_CL = (CWSQSAP.ABAP_USGRP_USER_CL | project\nTimeGenerated = column_ifexists('TimeGenerated', '1000-01-01T00:00:00Z')\n,MANDT = column_ifexists('MANDT_s', 'initialString')\n,BNAME = column_ifexists('BNAME_s', 'initialString')\n,USERGROUP = column_ifexists('USERGROUP_s', 'initialString')\n,FROM_DAT = column_ifexists('FROM_DAT_s', 'initialString')\n,TO_DAT = column_ifexists('TO_DAT_s', 'initialString')\n,ORGFLAG = column_ifexists('ORGFLAG_s', 'initialString')\n,SystemID = column_ifexists('SystemID_s', 'initialString')\n,Type = column_ifexists('Type', 'initialString')\n);\n\nT_ABAP_USGRP_USER_CL | union isfuzzy= true (D_ABAP_USGRP_USER_CL  | where TimeGenerated != '1000-01-01T00:00:00Z')\n",
        "SAPFunctionsSAP_USR01Query": "//generated function structure for custom log CWSQSAP.ABAP_USR01_CL\n//generated on 2022-05-07\n//Sentinel4SAP solution version 1.2.98\nlet D_ABAP_USR01_CL = datatable(TimeGenerated:datetime\n,MANDT:string\n,BNAME:string\n,STCOD:string\n,SPLD:string\n,SPLG:string\n,SPDB:string\n,SPDA:string\n,DATFM:string\n,DCPFM:string\n,HDEST:string\n,HMAND:string\n,HNAME:string\n,MENON:string\n,MENUE:string\n,STRTT:string\n,LANGU:string\n,CATTKENNZ:string\n,TIMEFM:string\n,SystemID:string\n,Type:string\n)['1000-01-01T00:00:00Z','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString'];\n\nlet T_ABAP_USR01_CL = (CWSQSAP.ABAP_USR01_CL | project\nTimeGenerated = column_ifexists('TimeGenerated', '1000-01-01T00:00:00Z')\n,MANDT = column_ifexists('MANDT_s', 'initialString')\n,BNAME = column_ifexists('BNAME_s', 'initialString')\n,STCOD = column_ifexists('STCOD_s', 'initialString')\n,SPLD = column_ifexists('SPLD_s', 'initialString')\n,SPLG = column_ifexists('SPLG_s', 'initialString')\n,SPDB = column_ifexists('SPDB_s', 'initialString')\n,SPDA = column_ifexists('SPDA_s', 'initialString')\n,DATFM = column_ifexists('DATFM_s', 'initialString')\n,DCPFM = column_ifexists('DCPFM_s', 'initialString')\n,HDEST = column_ifexists('HDEST_s', 'initialString')\n,HMAND = column_ifexists('HMAND_s', 'initialString')\n,HNAME = column_ifexists('HNAME_s', 'initialString')\n,MENON = column_ifexists('MENON_s', 'initialString')\n,MENUE = column_ifexists('MENUE_s', 'initialString')\n,STRTT = column_ifexists('STRTT_s', 'initialString')\n,LANGU = column_ifexists('LANGU_s', 'initialString')\n,CATTKENNZ = column_ifexists('CATTKENNZ_s', 'initialString')\n,TIMEFM = column_ifexists('TIMEFM_s', 'initialString')\n,SystemID = column_ifexists('SystemID_s', 'initialString')\n,Type = column_ifexists('Type', 'initialString')\n);\n\nT_ABAP_USR01_CL | union isfuzzy= true (D_ABAP_USR01_CL  | where TimeGenerated != '1000-01-01T00:00:00Z')\n",
        "SAPFunctionsSAP_USR02Query": "//generated function structure for custom log CWSQSAP.ABAP_USR02_CL\n//generated on 2022-05-07\n//Sentinel4SAP solution version 1.2.98\nlet D_ABAP_USR02_CL = datatable(TimeGenerated:datetime\n,MANDT:string\n,BNAME:string\n,GLTGV:string\n,GLTGB:string\n,USTYP:string\n,CLASS:string\n,LOCNT:string\n,UFLAG:string\n,ACCNT:string\n,ANAME:string\n,ERDAT:string\n,TRDAT:string\n,LTIME:string\n,BCDA1:string\n,CODV1:string\n,BCDA2:string\n,CODV2:string\n,BCDA3:string\n,CODV3:string\n,BCDA4:string\n,CODV4:string\n,BCDA5:string\n,CODV5:string\n,VERSN:string\n,CODVN:string\n,TZONE:string\n,ZBVMASTER:string\n,PWDCHGDATE:string\n,PWDSTATE:string\n,RESERVED:string\n,PWDHISTORY:string\n,PWDLGNDATE:string\n,PWDSETDATE:string\n,PWDINITIAL:string\n,PWDLOCKDATE:string\n,PWDSALTEDHASH:string\n,SECURITY_POLICY:string\n,SystemID:string\n,Type:string\n)['1000-01-01T00:00:00Z','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString'];\n\nlet T_ABAP_USR02_CL = (CWSQSAP.ABAP_USR02_CL | project\nTimeGenerated = column_ifexists('TimeGenerated', '1000-01-01T00:00:00Z')\n,MANDT = column_ifexists('MANDT_s', 'initialString')\n,BNAME = column_ifexists('BNAME_s', 'initialString')\n,GLTGV = column_ifexists('GLTGV_s', 'initialString')\n,GLTGB = column_ifexists('GLTGB_s', 'initialString')\n,USTYP = column_ifexists('USTYP_s', 'initialString')\n,CLASS = column_ifexists('CLASS_s', 'initialString')\n,LOCNT = column_ifexists('LOCNT_s', 'initialString')\n,UFLAG = column_ifexists('UFLAG_s', 'initialString')\n,ACCNT = column_ifexists('ACCNT_s', 'initialString')\n,ANAME = column_ifexists('ANAME_s', 'initialString')\n,ERDAT = column_ifexists('ERDAT_s', 'initialString')\n,TRDAT = column_ifexists('TRDAT_s', 'initialString')\n,LTIME = column_ifexists('LTIME_s', 'initialString')\n,BCDA1 = column_ifexists('BCDA1_s', 'initialString')\n,CODV1 = column_ifexists('CODV1_s', 'initialString')\n,BCDA2 = column_ifexists('BCDA2_s', 'initialString')\n,CODV2 = column_ifexists('CODV2_s', 'initialString')\n,BCDA3 = column_ifexists('BCDA3_s', 'initialString')\n,CODV3 = column_ifexists('CODV3_s', 'initialString')\n,BCDA4 = column_ifexists('BCDA4_s', 'initialString')\n,CODV4 = column_ifexists('CODV4_s', 'initialString')\n,BCDA5 = column_ifexists('BCDA5_s', 'initialString')\n,CODV5 = column_ifexists('CODV5_s', 'initialString')\n,VERSN = column_ifexists('VERSN_s', 'initialString')\n,CODVN = column_ifexists('CODVN_s', 'initialString')\n,TZONE = column_ifexists('TZONE_s', 'initialString')\n,ZBVMASTER = column_ifexists('ZBVMASTER_s', 'initialString')\n,PWDCHGDATE = column_ifexists('PWDCHGDATE_s', 'initialString')\n,PWDSTATE = column_ifexists('PWDSTATE_s', 'initialString')\n,RESERVED = column_ifexists('RESERVED_s', 'initialString')\n,PWDHISTORY = column_ifexists('PWDHISTORY_s', 'initialString')\n,PWDLGNDATE = column_ifexists('PWDLGNDATE_s', 'initialString')\n,PWDSETDATE = column_ifexists('PWDSETDATE_s', 'initialString')\n,PWDINITIAL = column_ifexists('PWDINITIAL_s', 'initialString')\n,PWDLOCKDATE = column_ifexists('PWDLOCKDATE_s', 'initialString')\n,PWDSALTEDHASH = column_ifexists('PWDSALTEDHASH_s', 'initialString')\n,SECURITY_POLICY = column_ifexists('SECURITY_POLICY_s', 'initialString')\n,SystemID = column_ifexists('SystemID_s', 'initialString')\n,Type = column_ifexists('Type', 'initialString')\n);\n\nT_ABAP_USR02_CL | union isfuzzy= true (D_ABAP_USR02_CL  | where TimeGenerated != '1000-01-01T00:00:00Z')\n",
        "SAPFunctionsSAP_USR05Query": "//generated function structure for custom log CWSQSAP.ABAP_USR05_CL\n//generated on 2022-05-07\n//Sentinel4SAP solution version 1.2.98\nlet D_ABAP_USR05_CL = datatable(TimeGenerated:datetime\n,MANDT:string\n,BNAME:string\n,PARID:string\n,PARVA:string\n,SystemID:string\n,Type:string\n)['1000-01-01T00:00:00Z','initialString','initialString','initialString','initialString','initialString','initialString'];\n\nlet T_ABAP_USR05_CL = (CWSQSAP.ABAP_USR05_CL | project\nTimeGenerated = column_ifexists('TimeGenerated', '1000-01-01T00:00:00Z')\n,MANDT = column_ifexists('MANDT_s', 'initialString')\n,BNAME = column_ifexists('BNAME_s', 'initialString')\n,PARID = column_ifexists('PARID_s', 'initialString')\n,PARVA = column_ifexists('PARVA_s', 'initialString')\n,SystemID = column_ifexists('SystemID_s', 'initialString')\n,Type = column_ifexists('Type', 'initialString')\n);\n\nT_ABAP_USR05_CL | union isfuzzy= true (D_ABAP_USR05_CL  | where TimeGenerated != '1000-01-01T00:00:00Z')\n",
        "SAPFunctionsSAP_USR21Query": "//generated function structure for custom log CWSQSAP.ABAP_USR21_CL\n//generated on 2022-05-07\n//Sentinel4SAP solution version 1.2.98\nlet D_ABAP_USR21_CL = datatable(TimeGenerated:datetime\n,MANDT:string\n,BNAME:string\n,PERSNUMBER:string\n,ADDRNUMBER:string\n,KOSTL:string\n,START_MENU:string\n,IDADTYPE:string\n,RESPONSIBLE:string\n,TECHDESC:string\n,TEMPLATE_ORGTYPE:string\n,TEMPLATE_ORGADDR:string\n,SystemID:string\n,Type:string\n)['1000-01-01T00:00:00Z','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString'];\n\nlet T_ABAP_USR21_CL = (CWSQSAP.ABAP_USR21_CL | project\nTimeGenerated = column_ifexists('TimeGenerated', '1000-01-01T00:00:00Z')\n,MANDT = column_ifexists('MANDT_s', 'initialString')\n,BNAME = column_ifexists('BNAME_s', 'initialString')\n,PERSNUMBER = column_ifexists('PERSNUMBER_s', 'initialString')\n,ADDRNUMBER = column_ifexists('ADDRNUMBER_s', 'initialString')\n,KOSTL = column_ifexists('KOSTL_s', 'initialString')\n,START_MENU = column_ifexists('START_MENU_s', 'initialString')\n,IDADTYPE = column_ifexists('IDADTYPE_s', 'initialString')\n,RESPONSIBLE = column_ifexists('RESPONSIBLE_s', 'initialString')\n,TECHDESC = column_ifexists('TECHDESC_s', 'initialString')\n,TEMPLATE_ORGTYPE = column_ifexists('TEMPLATE_ORGTYPE_s', 'initialString')\n,TEMPLATE_ORGADDR = column_ifexists('TEMPLATE_ORGADDR_s', 'initialString')\n,SystemID = column_ifexists('SystemID_s', 'initialString')\n,Type = column_ifexists('Type', 'initialString')\n);\n\nT_ABAP_USR21_CL | union isfuzzy= true (D_ABAP_USR21_CL  | where TimeGenerated != '1000-01-01T00:00:00Z')\n",
        "SAPFunctionsSAP_UST04Query": "//generated function structure for custom log CWSQSAP.ABAP_UST04_CL\n//generated on 2022-05-07\n//Sentinel4SAP solution version 1.2.98\nlet D_ABAP_UST04_CL = datatable(TimeGenerated:datetime\n,MANDT:string\n,BNAME:string\n,PROFILE:string\n,SystemID:string\n,Type:string\n)['1000-01-01T00:00:00Z','initialString','initialString','initialString','initialString','initialString'];\n\nlet T_ABAP_UST04_CL = (CWSQSAP.ABAP_UST04_CL | project\nTimeGenerated = column_ifexists('TimeGenerated', '1000-01-01T00:00:00Z')\n,MANDT = column_ifexists('MANDT_s', 'initialString')\n,BNAME = column_ifexists('BNAME_s', 'initialString')\n,PROFILE = column_ifexists('PROFILE_s', 'initialString')\n,SystemID = column_ifexists('SystemID_s', 'initialString')\n,Type = column_ifexists('Type', 'initialString')\n);\n\nT_ABAP_UST04_CL | union isfuzzy= true (D_ABAP_UST04_CL  | where TimeGenerated != '1000-01-01T00:00:00Z')\n",
        "CWSQIdentifierPrefix": "workspace(\"",
        "CWQSIdentifierSuffix": "\").",
    },
    "resources": [
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2020-10-01",
            "name": "pid-ee2d31a6-a2e0-4211-aa4a-6c9256ad6fc3-partnercenter",
            "properties": {
                "mode": "Incremental",
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "resources": []
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('dataConnectorTemplateSpecName1')]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP data connector with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('dataConnectorVersion1')]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentId1'))]",
                            "apiVersion": "2021-03-01-preview",
                            "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
                            "location": "[parameters('workspace-location')]",
                            "kind": "StaticUI",
                            "properties": {
                                "connectorUiConfig": {
                                    "id": "SAP",
                                    "title": "Microsoft Sentinel for SAP",
                                    "publisher": "Microsoft",
                                    "descriptionMarkdown": "SAP systems and applications handle massive volumes of business-critical data, hosted on cloud/on-premises infrastructure.\n      Due to the complexity of the SAP ecosystem, security operations (SecOps) teams face the challenge of effectively monitoring and protecting their organization against growing threats.\n      A breach of the SAP system could result in data loss, disruption to business processes, loss of revenue, and major reputation damage.\n      The Microsoft Sentinel SAP connector, part of the Microsoft Sentinel Solution for SAP, ingests SAP logs to Microsoft Sentinel workspaces.\n      You can access raw data using the built-in Microsoft Sentinel Solution for SAP content or using custom content.\n      The connector ingests SAP NetWeaver (RFC) application layer logs, including Security Auditlogs, Application logs, ChangeDocuments, Spool Logs, Change Request data, User masterdata, and more.\n      The Microsoft Sentinel solution for SAP will be billed as an add-on charge from May 2023 per production system ID (SID) per hour in addition to the existing Microsoft Sentinel consumption-billing model.\n      Please see [offer page](https://aka.ms/SAPPromo) for more details.",
                                    "graphQueries": [
                                        {
                                            "metricName": "Total data received",
                                            "legend": "SAP",
                                            "baseQuery": " SAPConnectorOverview() "
                                        }
                                    ],
                                    "connectivityCriterias": [
                                        {
                                            "type": "IsConnectedQuery",
                                            "value": [
                                                " union isfuzzy=true  ABAP*, SAP_HeartBeat_CL, SecurityAlert | where Type != 'SecurityAlert' \n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)"
                                            ]
                                        }
                                    ],
                                    "dataTypes": [
                                        {
                                            "name": "SAPConnectorOverview",
                                            "lastDataReceivedQuery": "  SAPConnectorOverview()  | summarize Time = max(TimeGenerated)| where isnotempty(Time) "
                                        },
                                        {
                                            "name": "SAPAuditLog",
                                            "lastDataReceivedQuery": " SAPAuditLog | summarize Time = max(TimeGenerated)| where isnotempty(Time) "
                                        },
                                        {
                                            "name": "SAPChangeDocsLog",
                                            "lastDataReceivedQuery": " SAPChangeDocsLog | summarize Time = max(TimeGenerated)| where isnotempty(Time) "
                                        },
                                        {
                                            "name": "SAPAppLog",
                                            "lastDataReceivedQuery": " SAPAppLog | summarize Time = max(TimeGenerated)| where isnotempty(Time) "
                                        },
                                        {
                                            "name": "SAPOS_Syslog",
                                            "lastDataReceivedQuery": " SAPOS_Syslog | summarize Time = max(TimeGenerated)| where isnotempty(Time) "
                                        },
                                        {
                                            "name": "SAPSpoolLog",
                                            "lastDataReceivedQuery": " SAPSpoolLog | summarize Time = max(TimeGenerated)| where isnotempty(Time) "
                                        },
                                        {
                                            "name": "SAPSpoolOutputLog",
                                            "lastDataReceivedQuery": " SAPSpoolOutputLog | summarize Time = max(TimeGenerated)| where isnotempty(Time) "
                                        },
                                        {
                                            "name": "SAPTableDataLog",
                                            "lastDataReceivedQuery": " SAPTableDataLog | summarize Time = max(TimeGenerated)| where isnotempty(Time) "
                                        },
                                        {
                                            "name": "SAPWorkflowLog",
                                            "lastDataReceivedQuery": " SAPWorkflowLog | summarize Time = max(TimeGenerated)| where isnotempty(Time) "
                                        },
                                        {
                                            "name": "SAPJAVAFilesLogs",
                                            "lastDataReceivedQuery": " SAPJAVAFilesLogs | summarize Time = max(TimeGenerated)| where isnotempty(Time) "
                                        },
                                        {
                                            "name": "SAPFilesLogs",
                                            "lastDataReceivedQuery": " SAPFilesLogs | summarize Time = max(TimeGenerated)| where isnotempty(Time) "
                                        },
                                        {
                                            "name": "SAP_ADR6",
                                            "lastDataReceivedQuery": " SAP_ADR6 | summarize Time = max(TimeGenerated)| where isnotempty(Time) "
                                        },
                                        {
                                            "name": "SAP_AGR_1251",
                                            "lastDataReceivedQuery": " SAP_AGR_1251 | summarize Time = max(TimeGenerated)| where isnotempty(Time) "
                                        },
                                        {
                                            "name": "SAP_AGR_DEFINE",
                                            "lastDataReceivedQuery": " SAP_AGR_DEFINE | summarize Time = max(TimeGenerated)| where isnotempty(Time) "
                                        },
                                        {
                                            "name": "SAP_AGR_PROF",
                                            "lastDataReceivedQuery": " SAP_AGR_PROF | summarize Time = max(TimeGenerated)| where isnotempty(Time) "
                                        },
                                        {
                                            "name": "SAP_AGR_TCODES",
                                            "lastDataReceivedQuery": " SAP_AGR_TCODES | summarize Time = max(TimeGenerated)| where isnotempty(Time) "
                                        },
                                        {
                                            "name": "SAP_AGR_USERS",
                                            "lastDataReceivedQuery": " SAP_AGR_USERS | summarize Time = max(TimeGenerated)| where isnotempty(Time) "
                                        },
                                        {
                                            "name": "SAP_DEVACCESS",
                                            "lastDataReceivedQuery": " SAP_DEVACCESS | summarize Time = max(TimeGenerated)| where isnotempty(Time) "
                                        },
                                        {
                                            "name": "SAP_PAHI",
                                            "lastDataReceivedQuery": " SAP_PAHI | summarize Time = max(TimeGenerated)| where isnotempty(Time) "
                                        },
                                        {
                                            "name": "SAP_USR01",
                                            "lastDataReceivedQuery": " SAP_USR01 | summarize Time = max(TimeGenerated)| where isnotempty(Time) "
                                        },
                                        {
                                            "name": "SAP_USR02",
                                            "lastDataReceivedQuery": " SAP_USR02 | summarize Time = max(TimeGenerated)| where isnotempty(Time) "
                                        },
                                        {
                                            "name": "SAP_USR21",
                                            "lastDataReceivedQuery": " SAP_USR21 | summarize Time = max(TimeGenerated)| where isnotempty(Time) "
                                        },
                                        {
                                            "name": "SAP_UST04",
                                            "lastDataReceivedQuery": " SAP_UST04 | summarize Time = max(TimeGenerated)| where isnotempty(Time) "
                                        },
                                        {
                                            "name": "SAPCRLog",
                                            "lastDataReceivedQuery": " SAPCRLog | summarize Time = max(TimeGenerated)| where isnotempty(Time) "
                                        },
                                        {
                                            "name": "SAPJobLog",
                                            "lastDataReceivedQuery": " SAPJobLog | summarize Time = max(TimeGenerated)| where isnotempty(Time) "
                                        },
                                        {
                                            "name": "SAPOS_GW",
                                            "lastDataReceivedQuery": " SAPOS_GW | summarize Time = max(TimeGenerated)| where isnotempty(Time) "
                                        },
                                        {
                                            "name": "SAPOS_ICM",
                                            "lastDataReceivedQuery": " SAPOS_ICM | summarize Time = max(TimeGenerated)| where isnotempty(Time) "
                                        },
                                        {
                                            "name": "SAPOS_WP",
                                            "lastDataReceivedQuery": " SAPOS_WP | summarize Time = max(TimeGenerated)| where isnotempty(Time) "
                                        },
                                        {
                                            "name": "SAP_USGRP_USER",
                                            "lastDataReceivedQuery": " SAP_USGRP_USER | summarize Time = max(TimeGenerated)| where isnotempty(Time) "
                                        },
                                        {
                                            "name": "SAP_AGR_AGRS",
                                            "lastDataReceivedQuery": " SAP_AGR_AGRS | summarize Time = max(TimeGenerated)| where isnotempty(Time) "
                                        },
                                        {
                                            "name": "SAP_USR05",
                                            "lastDataReceivedQuery": " SAP_USR05 | summarize Time = max(TimeGenerated)| where isnotempty(Time) "
                                        },
                                        {
                                            "name": "SAP_AGR_FLAGS",
                                            "lastDataReceivedQuery": " SAP_AGR_FLAGS | summarize Time = max(TimeGenerated)| where isnotempty(Time) "
                                        }
                                    ]
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2023-04-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', last(split(variables('_dataConnectorId1'),'/'))))]",
                            "properties": {
                                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentId1'))]",
                                "contentId": "[variables('_dataConnectorContentId1')]",
                                "kind": "DataConnector",
                                "version": "[variables('dataConnectorVersion1')]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SAP",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('_dataConnectorContentId1')]",
                "contentKind": "DataConnector",
                "displayName": "Microsoft Sentinel for SAP",
                "contentProductId": "[variables('_dataConnectorcontentProductId1')]",
                "id": "[variables('_dataConnectorcontentProductId1')]",
                "version": "[variables('dataConnectorVersion1')]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
            "apiVersion": "2023-04-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', last(split(variables('_dataConnectorId1'),'/'))))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[variables('_dataConnectorId1')]"
            ],
            "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentId1'))]",
                "contentId": "[variables('_dataConnectorContentId1')]",
                "kind": "DataConnector",
                "version": "[variables('dataConnectorVersion1')]",
                "source": {
                    "kind": "Solution",
                    "name": "SAP",
                    "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                    "name": "Microsoft",
                    "email": "[variables('_email')]"
                },
                "support": {
                    "tier": "Microsoft",
                    "name": "Microsoft Corporation",
                    "email": "support@microsoft.com",
                    "link": "https://support.microsoft.com/"
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
            "apiVersion": "2021-03-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentId1'))]",
            "location": "[parameters('workspace-location')]",
            "kind": "StaticUI",
            "properties": {
                "connectorUiConfig": {
                    "title": "Microsoft Sentinel for SAP",
                    "publisher": "Microsoft",
                    "descriptionMarkdown": "SAP systems and applications handle massive volumes of business-critical data, hosted on cloud/on-premises infrastructure.\n      Due to the complexity of the SAP ecosystem, security operations (SecOps) teams face the challenge of effectively monitoring and protecting their organization against growing threats.\n      A breach of the SAP system could result in data loss, disruption to business processes, loss of revenue, and major reputation damage.\n      The Microsoft Sentinel SAP connector, part of the Microsoft Sentinel Solution for SAP, ingests SAP logs to Microsoft Sentinel workspaces.\n      You can access raw data using the built-in Microsoft Sentinel Solution for SAP content or using custom content.\n      The connector ingests SAP NetWeaver (RFC) application layer logs, including Security Auditlogs, Application logs, ChangeDocuments, Spool Logs, Change Request data, User masterdata, and more.\n      The Microsoft Sentinel solution for SAP will be billed as an add-on charge from May 2023 per production system ID (SID) per hour in addition to the existing Microsoft Sentinel consumption-billing model.\n      Please see [offer page](https://aka.ms/SAPPromo) for more details.",
                    "graphQueries": [
                        {
                            "metricName": "Total data received",
                            "legend": "SAP",
                            "baseQuery": " SAPConnectorOverview() "
                        }
                    ],
                    "dataTypes": [
                        {
                            "name": "SAPConnectorOverview",
                            "lastDataReceivedQuery": "  SAPConnectorOverview()  | summarize Time = max(TimeGenerated)| where isnotempty(Time) "
                        },
                        {
                            "name": "SAPAuditLog",
                            "lastDataReceivedQuery": " SAPAuditLog | summarize Time = max(TimeGenerated)| where isnotempty(Time) "
                        },
                        {
                            "name": "SAPChangeDocsLog",
                            "lastDataReceivedQuery": " SAPChangeDocsLog | summarize Time = max(TimeGenerated)| where isnotempty(Time) "
                        },
                        {
                            "name": "SAPAppLog",
                            "lastDataReceivedQuery": " SAPAppLog | summarize Time = max(TimeGenerated)| where isnotempty(Time) "
                        },
                        {
                            "name": "SAPOS_Syslog",
                            "lastDataReceivedQuery": " SAPOS_Syslog | summarize Time = max(TimeGenerated)| where isnotempty(Time) "
                        },
                        {
                            "name": "SAPSpoolLog",
                            "lastDataReceivedQuery": " SAPSpoolLog | summarize Time = max(TimeGenerated)| where isnotempty(Time) "
                        },
                        {
                            "name": "SAPSpoolOutputLog",
                            "lastDataReceivedQuery": " SAPSpoolOutputLog | summarize Time = max(TimeGenerated)| where isnotempty(Time) "
                        },
                        {
                            "name": "SAPTableDataLog",
                            "lastDataReceivedQuery": " SAPTableDataLog | summarize Time = max(TimeGenerated)| where isnotempty(Time) "
                        },
                        {
                            "name": "SAPWorkflowLog",
                            "lastDataReceivedQuery": " SAPWorkflowLog | summarize Time = max(TimeGenerated)| where isnotempty(Time) "
                        },
                        {
                            "name": "SAPJAVAFilesLogs",
                            "lastDataReceivedQuery": " SAPJAVAFilesLogs | summarize Time = max(TimeGenerated)| where isnotempty(Time) "
                        },
                        {
                            "name": "SAPFilesLogs",
                            "lastDataReceivedQuery": " SAPFilesLogs | summarize Time = max(TimeGenerated)| where isnotempty(Time) "
                        },
                        {
                            "name": "SAP_ADR6",
                            "lastDataReceivedQuery": " SAP_ADR6 | summarize Time = max(TimeGenerated)| where isnotempty(Time) "
                        },
                        {
                            "name": "SAP_AGR_1251",
                            "lastDataReceivedQuery": " SAP_AGR_1251 | summarize Time = max(TimeGenerated)| where isnotempty(Time) "
                        },
                        {
                            "name": "SAP_AGR_DEFINE",
                            "lastDataReceivedQuery": " SAP_AGR_DEFINE | summarize Time = max(TimeGenerated)| where isnotempty(Time) "
                        },
                        {
                            "name": "SAP_AGR_PROF",
                            "lastDataReceivedQuery": " SAP_AGR_PROF | summarize Time = max(TimeGenerated)| where isnotempty(Time) "
                        },
                        {
                            "name": "SAP_AGR_TCODES",
                            "lastDataReceivedQuery": " SAP_AGR_TCODES | summarize Time = max(TimeGenerated)| where isnotempty(Time) "
                        },
                        {
                            "name": "SAP_AGR_USERS",
                            "lastDataReceivedQuery": " SAP_AGR_USERS | summarize Time = max(TimeGenerated)| where isnotempty(Time) "
                        },
                        {
                            "name": "SAP_DEVACCESS",
                            "lastDataReceivedQuery": " SAP_DEVACCESS | summarize Time = max(TimeGenerated)| where isnotempty(Time) "
                        },
                        {
                            "name": "SAP_PAHI",
                            "lastDataReceivedQuery": " SAP_PAHI | summarize Time = max(TimeGenerated)| where isnotempty(Time) "
                        },
                        {
                            "name": "SAP_USR01",
                            "lastDataReceivedQuery": " SAP_USR01 | summarize Time = max(TimeGenerated)| where isnotempty(Time) "
                        },
                        {
                            "name": "SAP_USR02",
                            "lastDataReceivedQuery": " SAP_USR02 | summarize Time = max(TimeGenerated)| where isnotempty(Time) "
                        },
                        {
                            "name": "SAP_USR21",
                            "lastDataReceivedQuery": " SAP_USR21 | summarize Time = max(TimeGenerated)| where isnotempty(Time) "
                        },
                        {
                            "name": "SAP_UST04",
                            "lastDataReceivedQuery": " SAP_UST04 | summarize Time = max(TimeGenerated)| where isnotempty(Time) "
                        },
                        {
                            "name": "SAPCRLog",
                            "lastDataReceivedQuery": " SAPCRLog | summarize Time = max(TimeGenerated)| where isnotempty(Time) "
                        },
                        {
                            "name": "SAPJobLog",
                            "lastDataReceivedQuery": " SAPJobLog | summarize Time = max(TimeGenerated)| where isnotempty(Time) "
                        },
                        {
                            "name": "SAPOS_GW",
                            "lastDataReceivedQuery": " SAPOS_GW | summarize Time = max(TimeGenerated)| where isnotempty(Time) "
                        },
                        {
                            "name": "SAPOS_ICM",
                            "lastDataReceivedQuery": " SAPOS_ICM | summarize Time = max(TimeGenerated)| where isnotempty(Time) "
                        },
                        {
                            "name": "SAPOS_WP",
                            "lastDataReceivedQuery": " SAPOS_WP | summarize Time = max(TimeGenerated)| where isnotempty(Time) "
                        },
                        {
                            "name": "SAP_USGRP_USER",
                            "lastDataReceivedQuery": " SAP_USGRP_USER | summarize Time = max(TimeGenerated)| where isnotempty(Time) "
                        },
                        {
                            "name": "SAP_AGR_AGRS",
                            "lastDataReceivedQuery": " SAP_AGR_AGRS | summarize Time = max(TimeGenerated)| where isnotempty(Time) "
                        },
                        {
                            "name": "SAP_USR05",
                            "lastDataReceivedQuery": " SAP_USR05 | summarize Time = max(TimeGenerated)| where isnotempty(Time) "
                        },
                        {
                            "name": "SAP_AGR_FLAGS",
                            "lastDataReceivedQuery": " SAP_AGR_FLAGS | summarize Time = max(TimeGenerated)| where isnotempty(Time) "
                        }
                    ],
                    "connectivityCriterias": [
                        {
                            "type": "IsConnectedQuery",
                            "value": [
                                " union isfuzzy=true  ABAP*, SAP_HeartBeat_CL, SecurityAlert | where Type != 'SecurityAlert' \n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(7d)"
                            ]
                        }
                    ],
                    "id": "[variables('_uiConfigId1')]"
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('workbookTemplateSpecName1')]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP -Audit ControlsWorkbook Workbook with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('workbookVersion1')]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.Insights/workbooks",
                            "name": "[variables('workbookContentId1')]",
                            "location": "[parameters('workspace-location')]",
                            "kind": "shared",
                            "apiVersion": "2021-08-01",
                            "metadata": {
                                "description": "SAP -Audit Controls"
                            },
                            "properties": {
                                "displayName": "[parameters('workbook1-name')]",
                                "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"expandable\":true,\"expanded\":true,\"items\":[{\"type\":1,\"content\":{\"json\":\"<img src=\\\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/SAP/Workbooks/SAPVMIcon.svg\\\" width=\\\"30\\\"/> SAP Audit Controls (Preview)\\r\\n---\\r\\n\\r\\nThe workbook provides the following capabilities for your compliance program:\\r\\n\\r\\n* See recommendations on which analytics rules to enable, and enable them in-place with proper pre-set configuration.\\r\\n* Associate your analytics rules to the SOX or NIST control framework, or apply your own custom control framework.\\r\\n* Review incidents and alerts summarized by control, according to the selected control framework.\\r\\n* Export relevant incidents for further analysis, for auditing and reporting purposes.\"},\"name\":\"text - Overview\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"crossComponentResources\":[\"{Subscription}\"],\"parameters\":[{\"id\":\"e2ddac6b-37bc-4c29-8936-cbbfacbfb860\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"DemoMode\",\"type\":10,\"isRequired\":true,\"isHiddenWhenLocked\":true,\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"jsonData\":\"[{\\\"value\\\": \\\"true\\\", \\\"label\\\": \\\"true\\\"}, {\\\"value\\\": \\\"false\\\", \\\"label\\\": \\\"false\\\",\\\"selected\\\": 1}]\"}],\"style\":\"above\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},\"name\":\"parameters - DemoMode\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"crossComponentResources\":[\"{Subscription}\"],\"parameters\":[{\"id\":\"051b8a53-b862-4cc6-afa5-23539c589fb3\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"InternalWSs\",\"type\":1,\"isRequired\":true,\"query\":\"SecurityIncident\\r\\n| take 1\\r\\n| parse IncidentUrl with * \\\"/workspaces/\\\" Workspace \\\"/\\\" *\\r\\n| project Workspace\",\"isHiddenWhenLocked\":true,\"timeContext\":{\"durationMs\":604800000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"ee4e753a-dfd6-41be-bc9d-4309c320006b\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"InternalSub\",\"type\":1,\"isRequired\":true,\"query\":\"where type =~ 'microsoft.operationalinsights/workspaces'\\r\\n| take 1\\r\\n| project subscriptionId\",\"crossComponentResources\":[\"value::selected\"],\"isHiddenWhenLocked\":true,\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},{\"id\":\"0d768227-93ab-483c-bca7-69b3e5bc58d3\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Subscription\",\"type\":6,\"isRequired\":true,\"query\":\"resources\\r\\n| where type =~ 'microsoft.operationalinsights/workspaces'\\r\\n| distinct subscriptionId, location\\r\\n| summarize by value = strcat(\\\"/subscriptions/\\\", subscriptionId), label = subscriptionId, selected = iff(subscriptionId =~ '{InternalSub}', true, false)\\r\\n| order by value asc\\r\\n\",\"crossComponentResources\":[\"value::all\"],\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"value\":\"/subscriptions/d1d8779d-38d7-4f06-91db-9cbc8de0176f\"},{\"id\":\"2e67b1fa-2136-4544-a27f-c8efa6ef077d\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Workspace\",\"type\":5,\"isRequired\":true,\"query\":\"resources | where type =~ 'Microsoft.operationsmanagement/solutions' | where name contains 'SecurityInsights' \\r\\n| parse name with \\\"SecurityInsights(\\\" label \\\")\\\" \\r\\n| project id = tostring(properties.workspaceResourceId), label, selected = iff(label =~ '{InternalWSs}', true, false)\",\"crossComponentResources\":[\"{Subscription}\"],\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"value\":\"/subscriptions/d1d8779d-38d7-4f06-91db-9cbc8de0176f/resourcegroups/SOC/providers/Microsoft.OperationalInsights/workspaces/CyberSecuritySOC\"},{\"id\":\"f6b057f5-e3ed-48a5-a8cb-84c978996b45\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"InternalRG\",\"type\":1,\"isRequired\":true,\"query\":\"where type =~ \\\"microsoft.operationalinsights/workspaces\\\"\\r\\n| where id =~  \\\"{Workspace}\\\"\\r\\n| project resourceGroup\",\"crossComponentResources\":[\"{Workspace}\"],\"isHiddenWhenLocked\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"}],\"style\":\"above\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},\"conditionalVisibility\":{\"parameterName\":\"DemoMode\",\"comparison\":\"isEqualTo\",\"value\":\"false\"},\"name\":\"parameters - connections\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"crossComponentResources\":[\"{Subscription}\"],\"parameters\":[{\"id\":\"7d597ad7-4a2a-45ed-a4fe-7ee32de0fc22\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"label\":\"Incident creation time\",\"type\":4,\"isRequired\":true,\"isGlobal\":true,\"typeSettings\":{\"selectableValues\":[{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2592000000}],\"allowCustom\":true},\"value\":{\"durationMs\":604800000}},{\"id\":\"3a87d4f7-42cc-4c62-b543-6b5d9ab8cf27\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Status\",\"type\":2,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"SecurityIncident\\r\\n| summarize Count = count(IncidentNumber) by Status\\r\\n| project Value = Status, Label = strcat(Status, \\\": \\\", Count)\",\"crossComponentResources\":[\"{Workspace}\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"selectAllValue\":\"*\",\"showDefault\":false},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"defaultValue\":\"value::all\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"7da7946b-548d-4933-ab56-05f460bd8574\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Severity\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"SecurityIncident\\r\\n| summarize Count = count(IncidentNumber) by Severity\\r\\n| project Value = Severity, Label = strcat(Severity, \\\": \\\", Count)\",\"crossComponentResources\":[\"{Workspace}\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"selectAllValue\":\"*\",\"showDefault\":false},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"defaultValue\":\"value::all\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"81085d3a-5aca-488e-b7c6-ecf1167e59f7\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Tactics\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"SecurityIncident\\r\\n| extend Tactics = todynamic(AdditionalData.tactics)\\r\\n| mvexpand Tactics to typeof(string)\\r\\n| summarize Count=count(IncidentNumber) by Tactics\\r\\n| project Value = Tactics, Label = strcat(Tactics, \\\": \\\", Count)\",\"crossComponentResources\":[\"{Workspace}\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"selectAllValue\":\"*\",\"showDefault\":false},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"defaultValue\":\"value::all\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"value\":[\"value::all\"]},{\"id\":\"0f9efb0d-ac34-41d0-8a19-165840eb2a71\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Owner\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"SecurityIncident\\r\\n| extend owner = tostring(Owner.assignedTo) \\r\\n| summarize Count=count(IncidentNumber) by Owner= case(owner==\\\"\\\", \\\"Unassigned\\\",owner)\\r\\n| project Value = Owner, Label = strcat(Owner, \\\": \\\", Count)\",\"crossComponentResources\":[\"{Workspace}\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"selectAllValue\":\"*\",\"showDefault\":false},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"defaultValue\":\"value::all\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"4c106c4f-59b7-40bc-a501-cd6d463ba585\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"SystemRoles\",\"label\":\"System roles\",\"type\":10,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"let EmptySystems= datatable ( SystemID: string, SystemID_s:string , SystemUsage: string, SystemRole: string, Count: long  )['All Systems', 'All Systems', 'All System Usage', 'All System Roles', 1];\\r\\nlet AuditSystems = union isfuzzy= true (SAPAuditLog | distinct SystemID_s= SystemID), (EmptySystems| project SystemID, SystemID_s) | summarize by SystemID= SystemID_s;\\r\\nAuditSystems\\r\\n| lookup kind=inner (SAPSystems() | union isfuzzy=true EmptySystems) on SystemID\\r\\n| extend ranked= iff(SystemRole != \\\"Unknown (Production)\\\",array_sum(to_utf8(SystemRole)), 20.0)\\r\\n| summarize Ranked= any(ranked) by SystemRole\\r\\n| order by Ranked desc\\r\\n| serialize Rank = row_number()\\r\\n| project value= SystemRole, label= strcat('', SystemRole), selected= iff(Rank==1, true, false)\\r\\n\",\"crossComponentResources\":[\"{Workspace}\"],\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"1a31d436-bb4b-469f-94a8-5ad9aa018edd\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"SystemUsage\",\"label\":\"System usage\",\"type\":10,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"let EmptySystems= datatable ( SystemID: string, SystemID_s:string , SystemUsage: string, SystemRole: string, Count: long  )['All Systems', 'All Systems', 'All Usage Types', 'All System Roles', 1];\\r\\nlet AuditSystems = union isfuzzy= true (SAPAuditLog | distinct SystemID_s= SystemID), (EmptySystems| project SystemID, SystemID_s, SystemUsage) | summarize by SystemID= SystemID_s, SystemUsage;\\r\\nAuditSystems\\r\\n| lookup (SAPSystems(SelectedSystemRoles=dynamic(\\\"{SystemRoles}\\\"))) on SystemID\\r\\n| extend SystemUsage= strcat(SystemUsage, SystemUsage1)\\r\\n| extend ranked= array_sum(to_utf8(SystemUsage))\\r\\n| summarize Ranked= any(ranked) by SystemUsage\\r\\n| where isnotempty(SystemUsage)\\r\\n| order by Ranked desc\\r\\n| serialize Rank = row_number()\\r\\n//| where isnotempty(SystemUsage) or SystemID == 'All Systems'\\r\\n| project value= SystemUsage, label= strcat('', SystemUsage), selected= iff(Rank==1, true, false)\\r\\n\\r\\n\",\"crossComponentResources\":[\"{Workspace}\"],\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"timeContext\":{\"durationMs\":259200000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"b5ed6d2c-e44f-48ac-a535-af6f2d7ab53d\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Systems\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"let EmptySystems= datatable ( SystemID: string, SystemID_s:string , SystemUsage: string, SystemRole: string, Count: long  )['All Systems', 'All Systems', 'All System Usage', 'All System Roles', 1];\\r\\nlet AuditSystems = union isfuzzy= true (SAPAuditLog | distinct SystemID_s= SystemID), (EmptySystems| project SystemID, SystemID_s, SystemRole) | summarize SystemRole= any(SystemRole) by SystemID= SystemID_s\\r\\n| extend ranked= array_sum(to_utf8(SystemID));\\r\\nAuditSystems\\r\\n| lookup (SAPSystems(SelectedSystemRoles=dynamic(\\\"{SystemRoles}\\\"), SelectedSystemUsage=dynamic(\\\"{SystemUsage}\\\")) ) on SystemID\\r\\n//| extend SystemRole = strcat(SystemRole, SystemRole1)\\r\\n| extend SystemRole = SystemRole1\\r\\n| where isnotempty(SystemRole)\\r\\n| summarize Ranked= any(ranked) by SystemID, SystemRole, SystemUsage\\r\\n| order by Ranked desc\\r\\n| serialize Rank = row_number()\\r\\n| extend SystemID= iff(\\\"{DemoMode}\\\" == \\\"true\\\", toupper(substring(hash_sha256(SystemID), 0, 3)), SystemID)\\r\\n| project value= SystemID, label= strcat('', SystemID)\\r\\n\\r\\n\\r\\n\\r\\n\",\"crossComponentResources\":[\"{Workspace}\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"selectAllValue\":\"All Systems\",\"showDefault\":false},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"defaultValue\":\"value::all\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"afb8295f-8abc-428c-b81c-04333aa7394b\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"ControlFrameWork\",\"label\":\"Control framework\",\"type\":10,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"let ARMD= materialize(SAPWSAlertRuleMetaData);\\r\\nlet ControlTypes= ARMD\\r\\n| getschema \\r\\n| where ColumnName contains \\\"ControlFamily\\\"\\r\\n| project value= replace_string(ColumnName,\\\"ControlFamily\\\",\\\"\\\"), ColumnName;\\r\\nlet Labels= ARMD | evaluate basket();\\r\\nLabels | evaluate narrow()\\r\\n| where Column in ((ControlTypes | summarize by ColumnName))\\r\\n| where isnotempty( Value)\\r\\n| extend Column= replace_string(Column,\\\"ControlFamily\\\",\\\"\\\")\\r\\n| distinct Column\\r\\n//| summarize label= make_set(Value) by Column\\r\\n//| extend label= strcat(\\\" \\\",\\\" \\\", Column, \\\" \\\", translate('\\\"',' ', tostring(label)))\\r\\n| extend label= Column\\r\\n| project value= Column, label\\r\\n| extend IsSelected= iff(value contains \\\"SOX\\\", 1, 0)\\r\\n| order by IsSelected\\r\\n\",\"crossComponentResources\":[\"{Workspace}\"],\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"f691a328-79f9-4f14-a4b9-859f017e4fd0\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"ControlFamilys\",\"label\":\"Control families\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"let NA = datatable(value: string)[\\\"Not assigned\\\"];\\r\\nSAPWSAlertRuleMetaData\\r\\n| summarize by value= {ControlFrameWork}ControlFamily\\r\\n| union NA\\r\\n| extend label = strcat(\\\"\\\", value)\\r\\n| where value != \\\"Not assigned\\\"\\r\\n\",\"crossComponentResources\":[\"{Workspace}\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"selectAllValue\":\"*\",\"showDefault\":false},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"defaultValue\":\"value::all\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"c52b87eb-f971-4ba1-afe7-00d5d17b8321\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"ControlIDs\",\"label\":\"Control IDs\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"let NA = datatable(value: string, ControlID: string)[\\\"Not assigned\\\", \\\"Not assigned\\\"];\\r\\nSAPWSAlertRuleMetaData\\r\\n| extend ControlFamily= {ControlFrameWork}ControlFamily\\r\\n| where ControlFamily in ({ControlFamilys}) or \\\"*\\\" in ({ControlFamilys})\\r\\n| summarize Count= dcount(RuleID) by value= {ControlFrameWork}ControlID\\r\\n| union NA\\r\\n| project value, label = strcat(\\\"\\\", value, \\\" (\\\",Count, iff(Count > 1,\\\" rules)\\\",\\\" rule)\\\"))\\r\\n| where value != \\\"Not assigned\\\"\\r\\n\",\"crossComponentResources\":[\"{Workspace}\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"selectAllValue\":\"*\",\"showDefault\":false},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"defaultValue\":\"value::all\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"value\":[\"value::all\"]},{\"id\":\"41d7f142-c5e5-45f2-b2f1-3b345ddc4054\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"SelectedTab\",\"type\":11,\"isHiddenWhenLocked\":true,\"typeSettings\":{\"additionalResourceOptions\":[]},\"jsonData\":\"[{\\\"value\\\":\\\"Alert Rules Overview\\\", \\\"selected\\\":\\\"true\\\"}, {\\\"value\\\":\\\"Incidnets\\\"}, {\\\"value\\\":\\\"Alerts\\\"}]\",\"value\":\"Alerts\"},{\"version\":\"KqlParameterItem/1.0\",\"name\":\"DebugMode\",\"type\":10,\"isRequired\":true,\"isHiddenWhenLocked\":true,\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"jsonData\":\"[{\\\"value\\\": true}, {\\\"value\\\": false, \\\"label\\\": \\\"normal\\\",\\\"selected\\\": 1}]\",\"id\":\"1e86a073-ebcb-4f3d-a8a9-12c3be5aacc9\"},{\"id\":\"800f58fd-5831-49fe-8492-841cfaef7f28\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"ItemID\",\"label\":\"Default value for itemID\",\"type\":1,\"isHiddenWhenLocked\":true,\"criteriaData\":[{\"criteriaContext\":{\"operator\":\"Default\",\"resultValType\":\"static\",\"resultVal\":\"*\"}}]},{\"id\":\"e22851f5-fcb1-479e-bbbd-5c071e810d37\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TemplateID\",\"type\":1,\"isHiddenWhenLocked\":true,\"criteriaData\":[{\"criteriaContext\":{\"operator\":\"Default\",\"resultValType\":\"static\",\"resultVal\":\"*\"}}]},{\"id\":\"033f8873-831e-45bb-abbb-422c5183afbc\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"DefaultItemID\",\"type\":1,\"description\":\"This is what we use for getting default values for controls\",\"query\":\"print toscalar(SAPWSAlertRuleMetaData | where RuleID == \\\"DefaultRule\\\" | project ItemId);\\r\\n\",\"crossComponentResources\":[\"{Workspace}\"],\"isHiddenWhenLocked\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"version\":\"KqlParameterItem/1.0\",\"name\":\"RecommendedConfiguration\",\"type\":1,\"isHiddenWhenLocked\":true,\"criteriaData\":[{\"criteriaContext\":{\"operator\":\"Default\",\"resultValType\":\"static\",\"resultVal\":\"*\"}}],\"id\":\"18a30e71-21d4-4a77-95ed-fd0689b56f2e\"}],\"style\":\"above\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},\"name\":\"parameters\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"050c913f-ac87-491b-916e-8be5d11ba154\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"DemoMode\",\"type\":10,\"isRequired\":true,\"query\":\"{\\\"version\\\":\\\"1.0.0\\\",\\\"content\\\":\\\"[{\\\\\\\"value\\\\\\\": true, \\\\\\\"label\\\\\\\":\\\\\\\"true\\\\\\\"},{\\\\\\\"value\\\\\\\":false,\\\\\\\"label\\\\\\\":\\\\\\\"false\\\\\\\", \\\\\\\"selected\\\\\\\": true}]\\\"}\",\"isHiddenWhenLocked\":true,\"typeSettings\":{\"additionalResourceOptions\":[]},\"timeContext\":{\"durationMs\":86400000},\"queryType\":8,\"value\":\"true\"}],\"style\":\"pills\",\"queryType\":8},\"name\":\"parameters - 5\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"crossComponentResources\":[\"{Workspace}\"],\"parameters\":[{\"id\":\"bf80573a-f732-4a47-bcfd-aa4188bb3c0a\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"IncidentsRetentionDays\",\"type\":1,\"isRequired\":true,\"query\":\"print IncidentsRetentionDays= (toscalar(SecurityIncident | summarize MinTG= min(TimeGenerated)\\r\\n| project IncidentsRetentionDays= 1 + datetime_diff('day', now(), MinTG)))\",\"crossComponentResources\":[\"{Workspace}\"],\"isHiddenWhenLocked\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"1a2b71f0-7cc8-4070-b87b-34d9b13cd6a5\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"IncidentsRetentionDaysJudgement\",\"type\":1,\"isRequired\":true,\"query\":\"let IncidentsRetentionDays= {IncidentsRetentionDays};\\r\\nprint(toscalar(iff(IncidentsRetentionDays >= 730, \\\"Good\\\", \\\"Bad\\\")))\",\"isHiddenWhenLocked\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"}],\"style\":\"above\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"customWidth\":\"100\",\"name\":\"parameters-for-warnings\"},{\"type\":1,\"content\":{\"json\":\"#### Oldest incident found in this workspace is {IncidentsRetentionDays} days old.\\r\\nThis dashboard allows for an aggregated view of incidents and alerts based on the *SecurityAlert* and *SecurityIncident* tables, which currently retain {IncidentsRetentionDays} days of data. Consider extending the retention period for these tables to match your organization's compliance requirements. Regardless of the choice you make for the retention policy of these tables, the incident data itself is never deleted, though it might not show up here. Alert data is kept according to the alert table's retention policy.\\r\\n\\r\\nSee [Configure a data retention policy for a table in a Log Analytics workspace](https://learn.microsoft.com/azure/sentinel/configure-data-retention) for more information.\\r\\n\",\"style\":\"info\"},\"conditionalVisibilities\":[{\"parameterName\":\"IncidentsRetentionDaysJudgement\",\"comparison\":\"isEqualTo\",\"value\":\"Bad\"},{\"parameterName\":\"HideWarning\",\"comparison\":\"isNotEqualTo\",\"value\":\"true\"}],\"name\":\"TextWarnAgainstInsufficientRetention\"}]},\"name\":\"group-warning\"}],\"exportParameters\":true},\"name\":\"Header\",\"styleSettings\":{\"showBorder\":true}},{\"type\":11,\"content\":{\"version\":\"LinkItem/1.0\",\"style\":\"tabs\",\"links\":[{\"id\":\"d040197e-8fff-4c36-bbb2-eabd268f361a\",\"cellValue\":\"SelectedTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Configure\",\"subTarget\":\"Configure\",\"preText\":\"Alert Rules\",\"postText\":\"Alert Rules\",\"style\":\"link\"},{\"id\":\"10ad4d18-12cf-4e42-8ef3-a0cd1356bf51\",\"cellValue\":\"SelectedTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Monitor\",\"subTarget\":\"Monitor\",\"style\":\"link\"},{\"id\":\"d4697d8a-d707-4dee-9e00-f6f762d9cd00\",\"cellValue\":\"SelectedTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Report\",\"subTarget\":\"Report\",\"style\":\"link\"}]},\"name\":\"links - 2\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":11,\"content\":{\"version\":\"LinkItem/1.0\",\"style\":\"tabs\",\"links\":[{\"id\":\"e6d3d7a2-00d1-4785-b211-1fc539678978\",\"cellValue\":\"SelectedMinorTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Configure Alerts\",\"subTarget\":\"Alerts\",\"preText\":\"Alert Rules\",\"postText\":\"Alert Rules\",\"style\":\"link\"},{\"id\":\"5b5fadf6-aa3e-413d-8766-8e29d62add8c\",\"cellValue\":\"SelectedMinorTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Configure Teams\",\"subTarget\":\"Teams\",\"style\":\"link\"},{\"id\":\"06bdaec3-e5f5-4d12-9e8e-eba0e3690aba\",\"cellValue\":\"SelectedMinorTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Configure Tasks (Coming soon)\",\"subTarget\":\"Tasks\",\"style\":\"link\"}]},\"conditionalVisibility\":{\"parameterName\":\"1\",\"comparison\":\"isEqualTo\",\"value\":\"2\"},\"name\":\"links -overview-configuration\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"crossComponentResources\":[\"{Subscription}\"],\"parameters\":[{\"id\":\"5ed9d5de-1a80-4931-a56b-61527671c7fb\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Solutions\",\"label\":\"Solution templates to configure\",\"type\":2,\"description\":\"Only Microsoft Sentinel solutions of versions 2.x are shown here. This selector applies only to the \\\"Templates ready to be used\\\" table.\",\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"Resources\\r\\n| where resourceGroup == \\\"{InternalRG}\\\"\\r\\n| where type == \\\"microsoft.resources/templatespecs/versions\\\"\\r\\n| project properties= parse_json(properties)\\r\\n| extend Solution= tostring(properties.template.resources[1].properties.source.name)\\r\\n| distinct Solution\\r\\n| extend label= iff(isempty(Solution), \\\" My own content\\\", strcat(\\\" \\\", Solution))\\r\\n| extend selected= iff(Solution == \\\"SAP\\\", 1, 0)\\r\\n| order by label asc\",\"crossComponentResources\":[\"{Subscription}\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"selectAllValue\":\"*\",\"showDefault\":false},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},{\"id\":\"75a7ed96-5bf3-4026-996a-055e625337fc\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TemplateIDsBySolution\",\"type\":1,\"isRequired\":true,\"query\":\"Resources\\r\\n| where resourceGroup == \\\"{InternalRG}\\\"\\r\\n| where type startswith \\\"microsoft.resources/templatespecs/versions\\\"\\r\\n| extend resource1= parse_json(properties.template.resources[1])\\r\\n| where resource1.properties.kind == \\\"AnalyticsRule\\\"\\r\\n| extend Solution= tostring(resource1.properties.source.name)\\r\\n| where Solution in({Solutions}) or \\\"*\\\" in ({Solutions})\\r\\n| project templateID= tostring(properties.template.resources[0].name)\\r\\n//| extend templateID= iff(\\\"*\\\" in ({Solutions}), \\\"'*'\\\", strcat(\\\"'\\\",templateID,\\\"'\\\"))\\r\\n| extend templateID= iff(\\\"*\\\" in ({Solutions}), \\\"'*'\\\", templateID)\\r\\n| summarize value= makeset(templateID, 2000)\\r\\n| project value= zlib_compress_to_base64_string(tostring(value))\\r\\n\\r\\n\",\"crossComponentResources\":[\"{Subscription}\"],\"isHiddenWhenLocked\":true,\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"}],\"style\":\"formVertical\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},\"name\":\"parameters - solutions\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"Resources\\r\\n| where resourceGroup == \\\"{InternalRG}\\\"\\r\\n| where type startswith \\\"microsoft.resources/templatespecs/versions\\\" or type startswith \\\"microsoft.operationalinsights/workspaces\\\"\\r\\n| extend resource0= parse_json(properties.template.resources[0])\\r\\n| extend resource1= parse_json(properties.template.resources[1])\\r\\n| where resource1.properties.kind == \\\"AnalyticsRule\\\" or type == \\\"microsoft.operationalinsights/workspaces\\\"\\r\\n| extend Solution= tostring(resource1.properties.source.name)\\r\\n| where Solution in({Solutions}) or \\\"*\\\" in ({Solutions})\\r\\n| extend Solution= coalesce(Solution, \\\"My own content\\\")\\r\\n| extend properties= resource0.properties\\r\\n| extend displayName= tostring(properties.displayName)\\r\\n//| where isnotempty(displayName)\\r\\n| extend templateID= coalesce(tostring(resource0.name), \\\"My own content\\\")\\r\\n| extend Version=  tostring(resource1.properties.version)\\r\\n| distinct templateID, displayName, Version, tostring(resource0), tostring(properties), Solution\\r\\n| order by templateID, Version\\r\\n| extend RowRank= row_number(1, prev(templateID)!= templateID )\\r\\n| where RowRank == 1\\r\\n| project-away RowRank\\r\\n| extend resource0= tostring(resource0)\\r\\n\",\"size\":0,\"title\":\"AvailableTemplatesByARG\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\",\"crossComponentResources\":[\"{Subscription}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"templateID\",\"formatter\":1},{\"columnMatch\":\"resource0\",\"formatter\":5}],\"sortBy\":[{\"itemKey\":\"Solution\",\"sortOrder\":2}]},\"sortBy\":[{\"itemKey\":\"Solution\",\"sortOrder\":2}]},\"conditionalVisibility\":{\"parameterName\":\"Now\",\"comparison\":\"isEqualTo\",\"value\":\"*\"},\"name\":\"AvailableTemplatesByARG\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"{\\\"version\\\":\\\"ARMEndpoint/1.0\\\",\\\"headers\\\":[],\\\"method\\\":\\\"GET\\\",\\\"path\\\":\\\"/subscriptions/{Subscription:id}/resourceGroups/{InternalRG}/providers/Microsoft.OperationalInsights/workspaces/{Workspace:name}/providers/Microsoft.SecurityInsights/alertRules\\\",\\\"urlParams\\\":[{\\\"key\\\":\\\"api-version\\\",\\\"value\\\":\\\"2021-10-01-preview\\\"}],\\\"batchDisabled\\\":false,\\\"transformers\\\":[{\\\"type\\\":\\\"jsonpath\\\",\\\"settings\\\":{\\\"tablePath\\\":\\\"$.value\\\",\\\"columns\\\":[{\\\"path\\\":\\\"$.properties.displayName\\\",\\\"columnid\\\":\\\"RuleName\\\"},{\\\"path\\\":\\\"$.id\\\",\\\"columnid\\\":\\\"EditRuleURL\\\",\\\"columnType\\\":\\\"string\\\"},{\\\"path\\\":\\\"$.properties.description\\\",\\\"columnid\\\":\\\"Description\\\"},{\\\"path\\\":\\\"$.properties.enabled\\\",\\\"columnid\\\":\\\"Enabled\\\"},{\\\"path\\\":\\\"$.properties.query\\\",\\\"columnid\\\":\\\"Query\\\"},{\\\"path\\\":\\\"$.properties.incidentConfiguration.createIncident\\\",\\\"columnid\\\":\\\"CreateIncident\\\"},{\\\"path\\\":\\\"$.properties.tactics\\\",\\\"columnid\\\":\\\"Tactics\\\"},{\\\"path\\\":\\\"$.properties.severity\\\",\\\"columnid\\\":\\\"Severity\\\"},{\\\"path\\\":\\\"$.properties.queryPeriod\\\",\\\"columnid\\\":\\\"QueryPeriod\\\"},{\\\"path\\\":\\\"$.properties.queryFrequency\\\",\\\"columnid\\\":\\\"QueryFrequency\\\"},{\\\"path\\\":\\\"$.properties.query\\\",\\\"columnid\\\":\\\"TableUsed\\\"},{\\\"path\\\":\\\"$.properties.alertRuleTemplateName\\\",\\\"columnid\\\":\\\"TemplateID\\\"},{\\\"path\\\":\\\"$.properties.lastModifiedUtc\\\",\\\"columnid\\\":\\\"LastModifiedOn\\\"},{\\\"path\\\":\\\"$.name\\\",\\\"columnid\\\":\\\"RuleID\\\"},{\\\"path\\\":\\\"$.properties\\\",\\\"columnid\\\":\\\"RuleProperties\\\"},{\\\"path\\\":\\\"$.properties.query\\\",\\\"columnid\\\":\\\"QueryHasSAP\\\",\\\"substringRegexMatch\\\":\\\"[\\\\\\\\S\\\\\\\\s]*SAP[\\\\\\\\S\\\\\\\\s]*\\\",\\\"substringReplace\\\":\\\"SAP\\\"}]}}]}\",\"size\":1,\"title\":\"AllAnalyticrules\",\"noDataMessage\":\"No analytic rules are defined \",\"exportToExcelOptions\":\"all\",\"queryType\":12,\"gridSettings\":{\"rowLimit\":512,\"filter\":true,\"sortBy\":[{\"itemKey\":\"Tactics\",\"sortOrder\":1}],\"labelSettings\":[{\"columnId\":\"RuleName\",\"label\":\"Rule name\"},{\"columnId\":\"CreateIncident\",\"label\":\"Incidents\"}]},\"sortBy\":[{\"itemKey\":\"Tactics\",\"sortOrder\":1}],\"graphSettings\":{\"type\":0},\"mapSettings\":{\"locInfo\":\"LatLong\"}},\"conditionalVisibility\":{\"parameterName\":\"DebugMode\",\"comparison\":\"isEqualTo\",\"value\":\"true\"},\"name\":\"AllAnalyticrules\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"### Specific alert rules can be assigned to specific teams\\r\\n\\r\\nEdit the properties of the teams of responders, so you can assign them as defualt responders\"},\"name\":\"text - 2\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SAPGetConfig(IPConfigType= \\\"Teams\\\")\\r\\n| extend Team= ConfigKey \\r\\n| project-reorder Team, Email, LastUpdatedTimeUTC, teamID, channelID\",\"size\":1,\"timeContext\":{\"durationMs\":86400000},\"exportedParameters\":[{\"fieldName\":\"_DTItemId\",\"parameterName\":\"TeamDTItemId\",\"parameterType\":1,\"defaultValue\":\"*\"},{\"fieldName\":\"Team\",\"parameterName\":\"Team\",\"parameterType\":1,\"defaultValue\":\"*\"},{\"fieldName\":\"Email\",\"parameterName\":\"Email\",\"parameterType\":1},{\"fieldName\":\"channelID\",\"parameterName\":\"channelID\",\"parameterType\":1},{\"fieldName\":\"LastUpdatedTimeUTC\",\"parameterName\":\"LastUpdatedTimeUTC\",\"parameterType\":1},{\"fieldName\":\"teamID\",\"parameterName\":\"teamID\",\"parameterType\":1}],\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Team\",\"formatter\":1},{\"columnMatch\":\"Email\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"Default\",\"thresholdValue\":\"[variables('blanks')]\",\"representation\":\"Mail\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"LastUpdatedTimeUTC\",\"formatter\":6,\"dateFormat\":{\"showUtcTime\":\"[variables('blanks')]\",\"formatName\":\"shortDateTimePattern\"}},{\"columnMatch\":\"SearchKey\",\"formatter\":5},{\"columnMatch\":\"ConfigKey\",\"formatter\":5},{\"columnMatch\":\"Priority\",\"formatter\":5},{\"columnMatch\":\"_DTItemId\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"Default\",\"thresholdValue\":\"[variables('blanks')]\",\"representation\":\"Ellipsis\",\"text\":\"\"}]}},{\"columnMatch\":\"ConfigType\",\"formatter\":5}],\"labelSettings\":[{\"columnId\":\"LastUpdatedTimeUTC\",\"label\":\"Last Updated On\"},{\"columnId\":\"teamID\",\"label\":\"Teams ID\",\"comment\":\"Microsoft Teams group identifier\"},{\"columnId\":\"channelID\",\"label\":\"Teams Channel ID\",\"comment\":\"Microsoft Teams channel identifier\"},{\"columnId\":\"_DTItemId\",\"label\":\" \"}]}},\"name\":\"query - Teams\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"### Edit the details for team {Team}\"},\"conditionalVisibility\":{\"parameterName\":\"Team\",\"comparison\":\"isNotEqualTo\",\"value\":\"*\"},\"name\":\"text - edit Team\"},{\"type\":1,\"content\":{\"json\":\"### Select a team from the list to edit its properties\"},\"conditionalVisibility\":{\"parameterName\":\"Team\",\"comparison\":\"isEqualTo\",\"value\":\"*\"},\"name\":\"text - select a rule from the list\"},{\"type\":1,\"content\":{\"json\":\"TeamDTItemId = {TeamDTItemId}\\r\\n\\r\\nteamID= {teamID}\\r\\n\\r\\nchannelID= {channelID}\\r\\n\\r\\nLastUpdatedTimeUTC= {LastUpdatedTimeUTC}\\r\\n\\r\\nEmail= {Email}\\r\\n\\r\\n\\r\\n/subscriptions/{Subscription:id}/resourceGroups/{InternalRG}/providers/Microsoft.OperationalInsights/workspaces/{Workspace:name}/providers/Microsoft.SecurityInsights/watchlists/SAPSolutionConfig/watchlistItems/{TeamDTItemId}\"},\"conditionalVisibility\":{\"parameterName\":\"DebugMode\",\"comparison\":\"isEqualTo\",\"value\":\"true\"},\"name\":\"text - debug\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"db24ec7a-5f5f-406f-9c54-2cf606b65da0\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"GetItemTeam\",\"type\":1,\"query\":\"{\\\"version\\\":\\\"ARMEndpoint/1.0\\\",\\\"method\\\":\\\"GET\\\",\\\"path\\\":\\\"/subscriptions/{Subscription:id}/resourceGroups/{InternalRG}/providers/Microsoft.OperationalInsights/workspaces/{Workspace:name}/providers/Microsoft.SecurityInsights/watchlists/SAPSolutionConfig/watchlistItems/{TeamDTItemId}\\\",\\\"urlParams\\\":[{\\\"key\\\":\\\"api-version\\\",\\\"value\\\":\\\"2023-04-01-preview\\\"}],\\\"batchDisabled\\\":false,\\\"transformers\\\":[{\\\"type\\\":\\\"jsonpath\\\",\\\"settings\\\":{\\\"columns\\\":[{\\\"path\\\":\\\"$\\\",\\\"columnid\\\":\\\"Template\\\"}]}}]}\",\"isHiddenWhenLocked\":true,\"queryType\":12},{\"id\":\"db45b12f-6f8a-4baa-bd04-7ee99f28f262\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"ConfigKey\",\"label\":\"Team\",\"type\":1,\"isRequired\":true,\"criteriaData\":[{\"criteriaContext\":{\"operator\":\"Default\",\"resultValType\":\"param\",\"resultVal\":\"Team\"}}],\"timeContext\":{\"durationMs\":86400000}},{\"version\":\"KqlParameterItem/1.0\",\"name\":\"Email\",\"type\":1,\"isRequired\":true,\"criteriaData\":[{\"criteriaContext\":{\"operator\":\"Default\",\"resultValType\":\"param\",\"resultVal\":\"Email\"}}],\"timeContext\":{\"durationMs\":86400000},\"id\":\"018c9735-84a0-4277-8369-cdf96caafbd7\"},{\"version\":\"KqlParameterItem/1.0\",\"name\":\"TeamID\",\"label\":\"Teams Group ID\",\"type\":1,\"description\":\"The Teams ID can be retrieved\",\"isRequired\":true,\"criteriaData\":[{\"criteriaContext\":{\"operator\":\"Default\",\"resultValType\":\"param\",\"resultVal\":\"teamID\"}}],\"timeContext\":{\"durationMs\":86400000},\"id\":\"ed16cec9-13f7-4e46-bd72-af8cb982a5a9\"},{\"version\":\"KqlParameterItem/1.0\",\"name\":\"ChannelID\",\"label\":\"Channel ID\",\"type\":1,\"description\":\"The Teams ID can be retrieved\",\"isRequired\":true,\"criteriaData\":[{\"criteriaContext\":{\"operator\":\"Default\",\"resultValType\":\"param\",\"resultVal\":\"channelID\"}}],\"timeContext\":{\"durationMs\":86400000},\"id\":\"8ceeda65-d062-4b43-89fa-c3bd5a60788e\"},{\"id\":\"c3f1fd17-9337-40f5-856c-c22cf4c7c5ac\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"NewItemGUID\",\"type\":1,\"query\":\"print(new_guid())\",\"isHiddenWhenLocked\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"}],\"style\":\"formVertical\",\"doNotRunWhenHidden\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"Parameters-Change-Rule-Controls\",\"styleSettings\":{\"margin\":\"5\",\"padding\":\"5\"}},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"4d7cdf15-395e-4d77-a4f6-a487f315e58b\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"SetItemTeam\",\"type\":1,\"query\":\"print Item= todynamic(@'{GetItemTeam}')\\r\\n| evaluate bag_unpack(Item)\\r\\n| project-away etag, systemData, ClientRequestId\\r\\n| evaluate bag_unpack(properties)\\r\\n| evaluate bag_unpack(itemsKeyValue)\\r\\n| extend itemsKeyValue = bag_pack(\\\"ConfigType\\\", \\\"Teams\\\",\\r\\n            \\\"ConfigKey\\\", \\\"{ConfigKey}\\\",\\r\\n            \\\"teamID\\\", \\\"{TeamID}\\\",\\r\\n            \\\"channelID\\\", \\\"{ChannelID}\\\",\\r\\n            \\\"Email\\\", \\\"{Email}\\\")\\r\\n| extend properties= bag_pack(\\\"watchlistItemType\\\", watchlistItemType,\\r\\n        \\\"watchlistItemId\\\", watchlistItemId,\\r\\n        \\\"tenantId\\\", tenantId,\\r\\n        \\\"isDeleted\\\", false,\\r\\n        \\\"created\\\", created,\\r\\n        \\\"updated\\\", updated,\\r\\n        \\\"createdBy\\\", createdBy,\\r\\n        \\\"updatedBy\\\", updatedBy,\\r\\n        \\\"itemsKeyValue\\\",itemsKeyValue)\\r\\n| project out= bag_pack(\\\"id\\\", id, \\\"name\\\", name, \\\"type\\\", type, \\\"properties\\\", properties)\\r\\n\",\"isHiddenWhenLocked\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"0caf5655-4a74-4d18-a842-70ff36b0228a\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"CreateItemTeam\",\"type\":1,\"query\":\"print Item= ''\\r\\n| extend itemsKeyValue = bag_pack(\\\"ConfigType\\\", \\\"Teams\\\",\\r\\n            \\\"ConfigKey\\\", \\\"{ConfigKey}\\\",\\r\\n            \\\"teamID\\\", \\\"{TeamID}\\\",\\r\\n            \\\"channelID\\\", \\\"{ChannelID}\\\",\\r\\n            \\\"Email\\\", \\\"{Email}\\\")\\r\\n| extend properties= bag_pack(\\r\\n        \\\"itemsKeyValue\\\",itemsKeyValue)\\r\\n| project out= bag_pack(\\\"properties\\\", properties)\\r\\n\",\"isHiddenWhenLocked\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"}],\"style\":\"formVertical\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"DebugMode\",\"comparison\":\"isEqualTo\",\"value\":\"true\"},\"name\":\"Parameters-Change-Rule-Controls - Set and Create\",\"styleSettings\":{\"margin\":\"5\",\"padding\":\"5\"}},{\"type\":11,\"content\":{\"version\":\"LinkItem/1.0\",\"style\":\"paragraph\",\"links\":[{\"id\":\"57580a59-508e-47e4-8646-6b08ef65d835\",\"linkTarget\":\"ArmAction\",\"linkLabel\":\" Update team\",\"style\":\"primary\",\"linkIsContextBlade\":true,\"armActionContext\":{\"path\":\"/subscriptions/{Subscription:id}/resourceGroups/{InternalRG}/providers/Microsoft.OperationalInsights/workspaces/{Workspace:name}/providers/Microsoft.SecurityInsights/watchlists/SAPSolutionConfig/watchlistItems/{TeamDTItemId}?api-version=2023-04-01-preview\",\"headers\":[],\"params\":[],\"body\":\"{SetItemTeam}\",\"httpMethod\":\"PUT\",\"title\":\"Update team {Team}\",\"description\":\"### You are about to commit changes to team {Team}.\\r\\n\\r\\nChanges made to a team can take up to 5 minutes to reflect in reporting\",\"actionName\":\"Updating team\",\"runLabel\":\"Update team\"}},{\"id\":\"f5206259-7a27-424a-a768-a96fd0677f92\",\"linkTarget\":\"ArmAction\",\"linkLabel\":\" Create team\",\"style\":\"primary\",\"linkIsContextBlade\":true,\"armActionContext\":{\"path\":\"/subscriptions/{Subscription:id}/resourceGroups/{InternalRG}/providers/Microsoft.OperationalInsights/workspaces/{Workspace:name}/providers/Microsoft.SecurityInsights/watchlists/SAPSolutionConfig/watchlistItems/{NewItemGUID}?api-version=2023-04-01-preview\",\"headers\":[],\"params\":[],\"body\":\"{CreateItemTeam}\",\"httpMethod\":\"PUT\",\"title\":\"Create team {ConfigKey}\",\"description\":\"### You are about to create {ConfigKey}.\\r\\n\\r\\nChanges made to a team can take up to 5 minutes to reflect in reporting\",\"actionName\":\"Creating team\",\"runLabel\":\"Create team\"}},{\"id\":\"09766bd9-cb7b-41fe-ad9f-3d91a927a97d\",\"linkTarget\":\"ArmAction\",\"linkLabel\":\" Delete team\",\"preText\":\"\",\"style\":\"primary\",\"linkIsContextBlade\":true,\"armActionContext\":{\"path\":\"/subscriptions/{Subscription:id}/resourceGroups/{InternalRG}/providers/Microsoft.OperationalInsights/workspaces/{Workspace:name}/providers/Microsoft.SecurityInsights/watchlists/SAPSolutionConfig/watchlistItems/{TeamDTItemId}?api-version=2023-04-01-preview\",\"headers\":[],\"params\":[],\"body\":\"{SetItemTeam}\",\"httpMethod\":\"DELETE\",\"title\":\"Delete team {Team}\",\"description\":\"### You are about delete team {Team}.\\r\\nChanges made to the team can take up to 5 minutes to reflect\",\"actionName\":\"Deleting team\",\"runLabel\":\" Delete team\"}}]},\"name\":\"links - Team actions\",\"styleSettings\":{\"margin\":\"5px\",\"padding\":\"5px\"}}],\"exportParameters\":true},\"conditionalVisibility\":{\"parameterName\":\"Team\",\"comparison\":\"isNotEqualTo\",\"value\":\"*\"},\"name\":\"group - Teams Submit\"}],\"exportParameters\":true},\"customWidth\":\"50\",\"name\":\"Group-config-actions -for Teams\",\"styleSettings\":{\"padding\":\"5px\",\"maxWidth\":\"30%\",\"showBorder\":true}}]},\"conditionalVisibilities\":[{\"parameterName\":\"SelectedMinorTab\",\"comparison\":\"isEqualTo\",\"value\":\"Teams\"},{\"parameterName\":\"SelectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"Alert Rules Overview\"}],\"name\":\"group - configure Teams\",\"styleSettings\":{\"showBorder\":true}},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Templates ready to be used\",\"expandable\":true,\"expanded\":true,\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SAPWSAlertRuleMetaData\\r\\n| project AnalyticRuleName, AnalyticsTemplateId, RecommendedConfiguration\",\"size\":0,\"title\":\"AlertRulesMetaData\",\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"gridSettings\":{\"filter\":true}},\"conditionalVisibility\":{\"parameterName\":\"DebugMode\",\"comparison\":\"isEqualTo\",\"value\":\"true\"},\"name\":\"AlertRulesMetaData\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"{\\\"version\\\":\\\"Merge/1.0\\\",\\\"merges\\\":[{\\\"id\\\":\\\"341cd3e7-c42d-43ed-9c07-c3926eb29963\\\",\\\"mergeType\\\":\\\"leftanti\\\",\\\"leftTable\\\":\\\"AvailableTemplatesByARG\\\",\\\"rightTable\\\":\\\"AllAnalyticrules\\\",\\\"leftColumn\\\":\\\"templateID\\\",\\\"rightColumn\\\":\\\"TemplateID\\\"},{\\\"id\\\":\\\"341cd3e7-c42d-43ed-9c07-c3926eb29c84\\\",\\\"mergeType\\\":\\\"leftouter\\\",\\\"leftTable\\\":\\\"AvailableTemplatesByARG\\\",\\\"rightTable\\\":\\\"AlertRulesMetaData\\\",\\\"leftColumn\\\":\\\"templateID\\\",\\\"rightColumn\\\":\\\"AnalyticsTemplateId\\\"}],\\\"projectRename\\\":[{\\\"originalName\\\":\\\"[AvailableTemplatesByARG].Solution\\\",\\\"mergedName\\\":\\\"Solution\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[AvailableTemplatesByARG].id\\\",\\\"mergedName\\\":\\\"id\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[AvailableTemplatesByARG].name\\\",\\\"mergedName\\\":\\\"name\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[AvailableTemplatesByARG].type\\\",\\\"mergedName\\\":\\\"type\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[AvailableTemplatesByARG].tenantId\\\",\\\"mergedName\\\":\\\"tenantId\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[AvailableTemplatesByARG].kind\\\",\\\"mergedName\\\":\\\"kind\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[AvailableTemplatesByARG].location\\\",\\\"mergedName\\\":\\\"location\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[AvailableTemplatesByARG].resourceGroup\\\",\\\"mergedName\\\":\\\"resourceGroup\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[AvailableTemplatesByARG].subscriptionId\\\",\\\"mergedName\\\":\\\"subscriptionId\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[AvailableTemplatesByARG].managedBy\\\",\\\"mergedName\\\":\\\"managedBy\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[AvailableTemplatesByARG].apiVersion\\\",\\\"mergedName\\\":\\\"apiVersion\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[AvailableTemplatesByARG].sku\\\",\\\"mergedName\\\":\\\"sku\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[AvailableTemplatesByARG].plan\\\",\\\"mergedName\\\":\\\"plan\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[AvailableTemplatesByARG].tags\\\",\\\"mergedName\\\":\\\"tags\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[AvailableTemplatesByARG].identity\\\",\\\"mergedName\\\":\\\"identity\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[AvailableTemplatesByARG].zones\\\",\\\"mergedName\\\":\\\"zones\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[AvailableTemplatesByARG].extendedLocation\\\",\\\"mergedName\\\":\\\"extendedLocation\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[AvailableTemplatesByARG].systemData\\\",\\\"mergedName\\\":\\\"systemData\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[AvailableTemplatesByARG].resource1\\\",\\\"mergedName\\\":\\\"resource1\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[AvailableTemplatesByARG].RowRank\\\",\\\"mergedName\\\":\\\"RowRank\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[AvailableTemplatesByARG].[AvailableTemplatesByARG].templateID\\\",\\\"mergedName\\\":\\\"templateID\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[AvailableTemplatesByARG].[AvailableTemplatesByARG].displayName\\\",\\\"mergedName\\\":\\\"Rule name\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[AvailableTemplatesByARG].[AvailableTemplatesByARG].Version\\\",\\\"mergedName\\\":\\\"Version\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[AvailableTemplatesByARG].[AvailableTemplatesByARG].resource0\\\",\\\"mergedName\\\":\\\"resource0\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[AvailableTemplatesByARG].[AvailableTemplatesByARG].Solution\\\",\\\"mergedName\\\":\\\"Solution\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[AvailableTemplatesByARG].[AlertRulesMetaData].AnalyticRuleName\\\",\\\"mergedName\\\":\\\"AnalyticRuleName\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[AvailableTemplatesByARG].[AlertRulesMetaData].AnalyticsTemplateId\\\",\\\"mergedName\\\":\\\"AnalyticsTemplateId\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[AvailableTemplatesByARG].[AlertRulesMetaData].RecommendedConfiguration\\\",\\\"mergedName\\\":\\\"RecommendedConfiguration\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[AvailableTemplatesByARG].templateID\\\",\\\"mergedName\\\":\\\"templateID\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[AvailableTemplatesByARG].displayName\\\",\\\"mergedName\\\":\\\"displayName\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[AvailableTemplatesByARG].Version\\\",\\\"mergedName\\\":\\\"Version\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[AvailableTemplatesByARG].resource0\\\",\\\"mergedName\\\":\\\"resource0\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[AvailableTemplatesByARG].properties\\\",\\\"mergedName\\\":\\\"properties\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[AlertRulesMetaData].AnalyticRuleName\\\",\\\"mergedName\\\":\\\"AnalyticRuleName\\\",\\\"fromId\\\":\\\"341cd3e7-c42d-43ed-9c07-c3926eb29c84\\\"},{\\\"originalName\\\":\\\"[AlertRulesMetaData].AnalyticsTemplateId\\\",\\\"mergedName\\\":\\\"AnalyticsTemplateId\\\",\\\"fromId\\\":\\\"341cd3e7-c42d-43ed-9c07-c3926eb29c84\\\"},{\\\"originalName\\\":\\\"[AlertRulesMetaData].RecommendedConfiguration\\\",\\\"mergedName\\\":\\\"RecommendedConfiguration\\\",\\\"fromId\\\":\\\"341cd3e7-c42d-43ed-9c07-c3926eb29c84\\\"},{\\\"originalName\\\":\\\"[AvailableTemplatesByARG].[AvailableTemplatesByARG].properties\\\"}]}\",\"size\":1,\"noDataMessage\":\"All set! all alert rules have been activated\",\"noDataMessageStyle\":3,\"exportedParameters\":[{\"fieldName\":\"templateID\",\"parameterName\":\"templateID2Act\",\"parameterType\":1,\"defaultValue\":\"*\"},{\"fieldName\":\"displayName\",\"parameterName\":\"RuleName2\",\"parameterType\":1,\"defaultValue\":\"*\"},{\"fieldName\":\"resource0\",\"parameterName\":\"resource0\",\"parameterType\":1,\"defaultValue\":\"*\"},{\"fieldName\":\"Version\",\"parameterName\":\"Version2\",\"parameterType\":1,\"defaultValue\":\"*\"},{\"fieldName\":\"RecommendedConfiguration\",\"parameterName\":\"RecommendedConfiguration\",\"parameterType\":1,\"defaultValue\":\"*\"}],\"queryType\":7,\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"templateID\",\"formatter\":5},{\"columnMatch\":\"Version\",\"formatter\":5},{\"columnMatch\":\"resource0\",\"formatter\":5},{\"columnMatch\":\"properties\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"CellDetails\",\"linkLabel\":\"view\",\"linkIsContextBlade\":true}},{\"columnMatch\":\"AnalyticRuleName\",\"formatter\":5},{\"columnMatch\":\"AnalyticsTemplateId\",\"formatter\":5}],\"rowLimit\":100,\"labelSettings\":[{\"columnId\":\"displayName\",\"label\":\"Rule name\"},{\"columnId\":\"properties\",\"label\":\"Properties\"},{\"columnId\":\"RecommendedConfiguration\",\"label\":\"Recommended configuration\"}]},\"sortBy\":[],\"tileSettings\":{\"showBorder\":false},\"graphSettings\":{\"type\":0}},\"customWidth\":\"80\",\"name\":\"SAPTemplatesNotUsed - Copy\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"c68fc675-58fb-4ea8-b248-aeefebdb7b17\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"RuleAsTemplate\",\"type\":1,\"query\":\"let resource= parse_json(\\\"{resource0:escapejson}\\\");\\r\\nprint resource= resource\\r\\n| extend resource= bag_remove_keys(resource, dynamic([\\\"name\\\", \\\"type\\\", \\\"apiVersion\\\", \\\"location\\\"])) \\r\\n| extend resource= bag_set_key(resource,\\\"$.properties.alertRuleTemplateName\\\", \\\"{templateID2Act}\\\")\\r\\n| extend resource= bag_set_key(resource,\\\"$.properties.templateVersion\\\", \\\"{Version2}\\\")\\r\\n| extend resource= bag_set_key(resource,\\\"$.properties.enabled\\\", true)\\r\\n| extend createIncident= iff(\\\"{RecommendedConfiguration}\\\" contains(\\\"alert\\\"), false, true)\\r\\n| project resource= bag_set_key(resource,\\\"$.properties.IncidentConfiguration.createIncident\\\", createIncident)\",\"isHiddenWhenLocked\":true,\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"5b79cb5e-0321-479b-b9c4-4e4933889629\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"NewGUID\",\"type\":1,\"query\":\"let DummyCall2Refresh= \\\"{RuleAsTemplate:base64}\\\";\\r\\nlet NewGUID= new_guid();\\r\\nprint NewGUID= NewGUID\",\"isHiddenWhenLocked\":true,\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 3\"},{\"type\":1,\"content\":{\"json\":\"### Select a template from the list to activate it\",\"style\":\"info\"},\"conditionalVisibility\":{\"parameterName\":\"RuleName2\",\"comparison\":\"isEqualTo\",\"value\":\"*\"},\"name\":\"text - select a template\"},{\"type\":1,\"content\":{\"json\":\"### You have selected {RuleName2} \\r\\n\\r\\nClick on \\\"Activate Rule\\\" to have this alert rule created from template\",\"style\":\"info\"},\"conditionalVisibility\":{\"parameterName\":\"RuleName2\",\"comparison\":\"isNotEqualTo\",\"value\":\"*\"},\"name\":\"text - template selected\"},{\"type\":11,\"content\":{\"version\":\"LinkItem/1.0\",\"style\":\"nav\",\"links\":[{\"id\":\"93bf8db3-8a0c-40a9-b6ed-1e2c81effc52\",\"linkTarget\":\"ArmAction\",\"linkLabel\":\"Activate Rule\",\"style\":\"primary\",\"linkIsContextBlade\":true,\"armActionContext\":{\"path\":\"/subscriptions/{Subscription:id}/resourceGroups/{InternalRG}/providers/Microsoft.OperationalInsights/workspaces/{Workspace:name}/providers/Microsoft.SecurityInsights/alertRules/{NewGUID}?api-version=2023-05-01-preview\",\"headers\":[],\"params\":[],\"body\":\"{RuleAsTemplate}\",\"httpMethod\":\"PUT\",\"title\":\"Activate from template\",\"description\":\"#### The alert rule {RuleName2} will be activated from template using version {Version2}\",\"actionName\":\"Activating alert rule {RuleName2}\",\"runLabel\":\"Activate rule from template\"}}]},\"conditionalVisibility\":{\"parameterName\":\"templateID2Act\",\"comparison\":\"isNotEqualTo\",\"value\":\"*\"},\"name\":\"links - 4\"}]},\"customWidth\":\"20\",\"name\":\"group - activate alert rule\"}],\"exportParameters\":true},\"name\":\"group - Templates ready to be used\",\"styleSettings\":{\"showBorder\":true}},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Select a rule to configure\",\"expandable\":true,\"expanded\":true,\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let SelectedSystems= materialize(SAPSystems(SelectedSystemRoles=dynamic(\\\"{SystemRoles}\\\")\\n, SelectedSystems=todynamic(\\\"[{Systems}]\\\")\\n, SelectedSystemUsage= dynamic(\\\"{SystemUsage}\\\")) | project SystemID, SystemRole);\\nlet ARMetaData= materialize(SAPWSAlertRuleMetaData());\\nlet Templates= ARMetaData | summarize makeset(AnalyticsTemplateId);\\n//let DefaultItemID= toscalar(ARMetaData | where RuleID == \\\"DefaultRule\\\" | project ItemId);\\nlet TimeBucket= max_of(1, floor({TimeRange:seconds}/3600/20, 1));\\nlet StepSize= totimespan(strcat(TimeBucket, \\\"h\\\"));\\nSAPWSIncidentsDetailed\\n| where ((CreatedTime >= {TimeRange:start} and CreatedTime <= {TimeRange:end}) or (AlertStartTime >= {TimeRange:start} and AlertStartTime <= {TimeRange:end}))\\n| extend CreatedTime= coalesce(CreatedTime, AlertStartTime)\\n| project IncidentNumber, TimeGenerated, Severity, Status, Product, SAPSystem, Tactics, Owner, CreatedTime, AlertRuleUniqueName, SystemAlertId, AnalyticRuleName, tostring(AnalyticsTemplateId), AnalyticRuleId\\n| where SAPSystem in((SelectedSystems | summarize by SystemID)) or isempty(SAPSystem)\\n| where Severity in ({Severity}) or \\\"*\\\" in ({Severity}) or isempty(IncidentNumber)\\n| where Status in ({Status}) or \\\"*\\\" in ({Status}) or isempty(IncidentNumber)\\n| where Owner in ({Owner}) or \\\"*\\\" in ({Owner}) or isempty(IncidentNumber)\\n| where arraylength(set_intersect(Tactics, dynamic([{Tactics}]))) > 0 or \\\"*\\\" in ({Tactics}) \\n| extend AnalyticsTemplateId= coalesce(tostring(AnalyticsTemplateId), AnalyticRuleId) // to handle non-templates, use alert ID\\n| join kind= fullouter (ARMetaData | extend AnalyticsTemplateId=tostring(AnalyticsTemplateId)) on AnalyticsTemplateId\\n| extend ControlID= {ControlFrameWork}ControlID\\n| extend ControlID= iff(isnotempty(ControlID), ControlID, \\\"Not assigned\\\")\\n| where ControlID in ({ControlIDs}) or \\\"*\\\" in ({ControlIDs})\\n| extend ControlFamily= {ControlFrameWork}ControlFamily\\n| extend ControlFamily= iff(isnotempty(ControlFamily), ControlFamily, \\\"Not assigned\\\")\\n| where ControlFamily in ({ControlFamilys}) or \\\"*\\\" in ({ControlFamilys})\\n| extend CreatedTime= coalesce(CreatedTime, ago(4h))\\n| extend AlertRuleUniqueName= coalesce(AlertRuleUniqueName, RuleID)\\n| extend AnalyticRuleName= coalesce(AnalyticRuleName, AnalyticRuleName1)\\n| extend ItemId= iff(isempty(RuleID), \\\"{DefaultItemID}\\\", coalesce(ItemId, AnalyticRuleId))\\n| extend AnalyticsTemplateId= coalesce(tostring(AnalyticsTemplateId), tostring(AnalyticsTemplateId1))\\n| make-series IncidentCount= dcountif(IncidentNumber, isnotempty(IncidentNumber)) default= 0, AlertCount=dcountif(SystemAlertId, isnotempty(SystemAlertId)) default= 0 on CreatedTime from {TimeRange:start} to {TimeRange:end} step StepSize by AnalyticRuleName, AlertRuleUniqueName, AnalyticsTemplateId, ItemId, IncidentPriority= RecommendedConfiguration, AnalyticRuleId\\n| extend TotalIncidentCount= array_sum(IncidentCount), TotalAlertCount=array_sum(AlertCount), HasTemplate=iff(AnalyticsTemplateId != ItemId, true, false)\\n| extend QueryHasSAP= iff(isnotempty(IncidentPriority),\\\"SAP\\\",\\\"\\\")\\n| order by isnotempty(QueryHasSAP) desc, TotalIncidentCount desc, TotalAlertCount desc\\n\\n\",\"size\":1,\"title\":\"Incidents over time \",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"filter\":true,\"sortBy\":[{\"itemKey\":\"QueryHasSAP\",\"sortOrder\":2}],\"labelSettings\":[{\"columnId\":\"AnalyticRuleName\",\"label\":\"Analytic Rule Name\"}]},\"sortBy\":[{\"itemKey\":\"QueryHasSAP\",\"sortOrder\":2}],\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"AnalyticRuleName\"},\"subtitleContent\":{\"columnMatch\":\"IncidentCount\",\"formatter\":9,\"formatOptions\":{\"palette\":\"blue\"}},\"leftContent\":{\"columnMatch\":\"TotalCount\",\"formatter\":12,\"formatOptions\":{\"palette\":\"blue\"}},\"showBorder\":false,\"sortCriteriaField\":\"TotalCount\",\"sortOrderField\":2},\"graphSettings\":{\"type\":0,\"topContent\":{\"columnMatch\":\"ControlID\",\"formatter\":1},\"centerContent\":{\"columnMatch\":\"IncidentCount\",\"formatter\":1,\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}},\"chartSettings\":{\"xAxis\":\"CreatedTime\",\"yAxis\":[\"IncidentCount\"],\"group\":\"IncidentsTrendDetailLevel\",\"createOtherGroup\":10,\"seriesLabelSettings\":[{\"seriesName\":\"count_\",\"label\":\"Incidents\"}]}},\"customWidth\":\"70\",\"conditionalVisibility\":{\"parameterName\":\"DebugMode\",\"comparison\":\"isEqualTo\",\"value\":\"true\"},\"name\":\"Incidents over time \"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"{\\\"version\\\":\\\"Merge/1.0\\\",\\\"merges\\\":[{\\\"id\\\":\\\"f68fd7c6-7bcb-4b62-a6be-eec3a3f4862d\\\",\\\"mergeType\\\":\\\"leftouter\\\",\\\"leftTable\\\":\\\"AllAnalyticrules\\\",\\\"rightTable\\\":\\\"Incidents over time \\\",\\\"leftColumn\\\":\\\"RuleID\\\",\\\"rightColumn\\\":\\\"AnalyticRuleId\\\"},{\\\"id\\\":\\\"69c2e5f5-2ba0-4401-b634-10644a189e77\\\",\\\"mergeType\\\":\\\"leftouter\\\",\\\"leftTable\\\":\\\"AllAnalyticrules\\\",\\\"rightTable\\\":\\\"AvailableTemplatesByARG\\\",\\\"leftColumn\\\":\\\"TemplateID\\\",\\\"rightColumn\\\":\\\"templateID\\\"}],\\\"projectRename\\\":[{\\\"originalName\\\":\\\"[AllAnalyticrules].Severity\\\",\\\"mergedName\\\":\\\"Severity\\\",\\\"fromId\\\":\\\"f68fd7c6-7bcb-4b62-a6be-eec3a3f4862d\\\"},{\\\"originalName\\\":\\\"[AllAnalyticrules].RuleName\\\",\\\"mergedName\\\":\\\"Rule name\\\",\\\"fromId\\\":\\\"f68fd7c6-7bcb-4b62-a6be-eec3a3f4862d\\\"},{\\\"originalName\\\":\\\"[Incidents over time ].TotalIncidentCount\\\",\\\"mergedName\\\":\\\"TotalIncidentCount\\\",\\\"fromId\\\":\\\"f68fd7c6-7bcb-4b62-a6be-eec3a3f4862d\\\"},{\\\"originalName\\\":\\\"[Incidents over time ].IncidentCount\\\",\\\"mergedName\\\":\\\"IncidentCount\\\",\\\"fromId\\\":\\\"f68fd7c6-7bcb-4b62-a6be-eec3a3f4862d\\\"},{\\\"originalName\\\":\\\"[Incidents over time ].TotalAlertCount\\\",\\\"mergedName\\\":\\\"TotalAlertCount\\\",\\\"fromId\\\":\\\"f68fd7c6-7bcb-4b62-a6be-eec3a3f4862d\\\"},{\\\"originalName\\\":\\\"[Incidents over time ].AlertCount\\\",\\\"mergedName\\\":\\\"AlertCount\\\",\\\"fromId\\\":\\\"f68fd7c6-7bcb-4b62-a6be-eec3a3f4862d\\\"},{\\\"originalName\\\":\\\"[AllAnalyticrules].Enabled\\\",\\\"mergedName\\\":\\\"Enabled\\\",\\\"fromId\\\":\\\"f68fd7c6-7bcb-4b62-a6be-eec3a3f4862d\\\"},{\\\"originalName\\\":\\\"[AllAnalyticrules].CreateIncident\\\",\\\"mergedName\\\":\\\"Enable incidents\\\",\\\"fromId\\\":\\\"f68fd7c6-7bcb-4b62-a6be-eec3a3f4862d\\\"},{\\\"originalName\\\":\\\"[Incidents over time ].HasTemplate\\\",\\\"mergedName\\\":\\\"HasTemplate\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[AllAnalyticrules].TemplateID\\\",\\\"mergedName\\\":\\\"TemplateID\\\",\\\"fromId\\\":\\\"f68fd7c6-7bcb-4b62-a6be-eec3a3f4862d\\\"},{\\\"originalName\\\":\\\"[AllAnalyticrules].LastModifiedOn\\\",\\\"mergedName\\\":\\\"LastModifiedOn\\\",\\\"fromId\\\":\\\"f68fd7c6-7bcb-4b62-a6be-eec3a3f4862d\\\"},{\\\"originalName\\\":\\\"[Incidents over time ].IncidentPriority\\\",\\\"mergedName\\\":\\\"IncidentPriority\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[AllAnalyticrules].EditRuleURL\\\",\\\"mergedName\\\":\\\"EditRuleURL\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[Incidents over time ].PackedDetails\\\",\\\"mergedName\\\":\\\"PackedDetails\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[AllAnalyticrules].RuleID\\\",\\\"mergedName\\\":\\\"RuleID\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[Incidents over time ].ItemId\\\",\\\"mergedName\\\":\\\"ItemId\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[AllAnalyticrules].RuleProperties\\\",\\\"mergedName\\\":\\\"RuleProperties\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[Incidents over time ].SOXControlFamily\\\",\\\"mergedName\\\":\\\"SOXControlFamily\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[Incidents over time ].AnalyticRuleName1\\\",\\\"mergedName\\\":\\\"AnalyticRuleName1\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[Incidents over time ].NISTControlFamily\\\",\\\"mergedName\\\":\\\"NISTControlFamily\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[Incidents over time ].NISTControlID\\\",\\\"mergedName\\\":\\\"NISTControlID\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[Incidents over time ].Priority\\\",\\\"mergedName\\\":\\\"Priority\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[Incidents over time ].IncidentNumber\\\",\\\"mergedName\\\":\\\"IncidentNumber\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[Incidents over time ].TimeGenerated\\\",\\\"mergedName\\\":\\\"TimeGenerated\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[Incidents over time ].Severity\\\",\\\"mergedName\\\":\\\"Severity\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[Incidents over time ].Status\\\",\\\"mergedName\\\":\\\"Status\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[Incidents over time ].Product\\\",\\\"mergedName\\\":\\\"Product\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[Incidents over time ].SAPSystem\\\",\\\"mergedName\\\":\\\"SAPSystem\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[Incidents over time ].Tactics\\\",\\\"mergedName\\\":\\\"Tactics\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[Incidents over time ].Owner\\\",\\\"mergedName\\\":\\\"Owner\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[Incidents over time ].SystemAlertId\\\",\\\"mergedName\\\":\\\"SystemAlertId\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[Incidents over time ].RuleID\\\",\\\"mergedName\\\":\\\"RuleID\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[Incidents over time ].ControlID\\\",\\\"mergedName\\\":\\\"ControlID\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[Incidents over time ].ControlFamily\\\",\\\"mergedName\\\":\\\"ControlFamily\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[Incidents over time ].AnalyticsTemplateId1\\\",\\\"mergedName\\\":\\\"AnalyticsTemplateId1\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[AllAnalyticrules].QueryHasSAP\\\",\\\"mergedName\\\":\\\"QueryHasSAP\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[Incidents over time ].AnalyticRuleId\\\",\\\"mergedName\\\":\\\"AnalyticRuleId\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[Incidents over time ].QueryHasSAP\\\",\\\"mergedName\\\":\\\"QueryHasSAP\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[Incidents over time ].RecommendedConfiguration\\\",\\\"mergedName\\\":\\\"RecommendedConfiguration\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[AllAnalyticrules].Description\\\",\\\"mergedName\\\":\\\"Description\\\",\\\"fromId\\\":\\\"f68fd7c6-7bcb-4b62-a6be-eec3a3f4862d\\\"},{\\\"originalName\\\":\\\"[AllAnalyticrules].Query\\\",\\\"mergedName\\\":\\\"Query\\\",\\\"fromId\\\":\\\"f68fd7c6-7bcb-4b62-a6be-eec3a3f4862d\\\"},{\\\"originalName\\\":\\\"[AllAnalyticrules].Tactics\\\",\\\"mergedName\\\":\\\"Tactics\\\",\\\"fromId\\\":\\\"f68fd7c6-7bcb-4b62-a6be-eec3a3f4862d\\\"},{\\\"originalName\\\":\\\"[AllAnalyticrules].QueryPeriod\\\",\\\"mergedName\\\":\\\"QueryPeriod\\\",\\\"fromId\\\":\\\"f68fd7c6-7bcb-4b62-a6be-eec3a3f4862d\\\"},{\\\"originalName\\\":\\\"[AllAnalyticrules].QueryFrequency\\\",\\\"mergedName\\\":\\\"QueryFrequency\\\",\\\"fromId\\\":\\\"f68fd7c6-7bcb-4b62-a6be-eec3a3f4862d\\\"},{\\\"originalName\\\":\\\"[AllAnalyticrules].TableUsed\\\",\\\"mergedName\\\":\\\"TableUsed\\\",\\\"fromId\\\":\\\"f68fd7c6-7bcb-4b62-a6be-eec3a3f4862d\\\"},{\\\"originalName\\\":\\\"[Incidents over time ].AlertRuleUniqueName\\\",\\\"mergedName\\\":\\\"AlertRuleUniqueName\\\",\\\"fromId\\\":\\\"f68fd7c6-7bcb-4b62-a6be-eec3a3f4862d\\\"},{\\\"originalName\\\":\\\"[Incidents over time ].AnalyticsTemplateId\\\",\\\"mergedName\\\":\\\"AnalyticsTemplateId\\\",\\\"fromId\\\":\\\"f68fd7c6-7bcb-4b62-a6be-eec3a3f4862d\\\"},{\\\"originalName\\\":\\\"[Incidents over time ].CreatedTime\\\",\\\"mergedName\\\":\\\"CreatedTime\\\",\\\"fromId\\\":\\\"f68fd7c6-7bcb-4b62-a6be-eec3a3f4862d\\\"},{\\\"originalName\\\":\\\"[Incidents over time ].AnalyticRuleName\\\",\\\"mergedName\\\":\\\"Analytic Rule Name\\\",\\\"fromId\\\":\\\"f68fd7c6-7bcb-4b62-a6be-eec3a3f4862d\\\"},{\\\"originalName\\\":\\\"[AvailableTemplatesByARG].templateID\\\",\\\"mergedName\\\":\\\"templateID\\\",\\\"fromId\\\":\\\"69c2e5f5-2ba0-4401-b634-10644a189e77\\\"},{\\\"originalName\\\":\\\"[AvailableTemplatesByARG].displayName\\\",\\\"mergedName\\\":\\\"displayName\\\",\\\"fromId\\\":\\\"69c2e5f5-2ba0-4401-b634-10644a189e77\\\"},{\\\"originalName\\\":\\\"[AvailableTemplatesByARG].Version\\\",\\\"mergedName\\\":\\\"Version\\\",\\\"fromId\\\":\\\"69c2e5f5-2ba0-4401-b634-10644a189e77\\\"},{\\\"originalName\\\":\\\"[AvailableTemplatesByARG].resource0\\\",\\\"mergedName\\\":\\\"resource0\\\",\\\"fromId\\\":\\\"69c2e5f5-2ba0-4401-b634-10644a189e77\\\"},{\\\"originalName\\\":\\\"[AvailableTemplatesByARG].properties\\\",\\\"mergedName\\\":\\\"properties\\\",\\\"fromId\\\":\\\"69c2e5f5-2ba0-4401-b634-10644a189e77\\\"},{\\\"originalName\\\":\\\"[AvailableTemplatesByARG].Solution\\\",\\\"mergedName\\\":\\\"Solution\\\",\\\"fromId\\\":\\\"69c2e5f5-2ba0-4401-b634-10644a189e77\\\"},{\\\"originalName\\\":\\\"[Incidents over time ].Tier2TeamsGroup\\\"},{\\\"originalName\\\":\\\"[Incidents over time ].Tier2TeamsChannel\\\"},{\\\"originalName\\\":\\\"[Incidents over time ].Tier2Email\\\"},{\\\"originalName\\\":\\\"[Incidents over time ].Tier1TeamsGroup\\\"},{\\\"originalName\\\":\\\"[Incidents over time ].Tier1TeamsChannel\\\"},{\\\"originalName\\\":\\\"[Incidents over time ].Tier1Email\\\"},{\\\"originalName\\\":\\\"[Incidents over time ].Tier2\\\"},{\\\"originalName\\\":\\\"[Incidents over time ].Tier1\\\"},{\\\"originalName\\\":\\\"[Incidents over time ].Tasks\\\"},{\\\"originalName\\\":\\\"[Incidents over time ].SOXControlID\\\"},{\\\"originalName\\\":\\\"[Incidents over time ].SOXCondition\\\"},{\\\"originalName\\\":\\\"[Incidents over time ].MyOrgControlID\\\"},{\\\"originalName\\\":\\\"[Incidents over time ].MyOrgCondition\\\"},{\\\"originalName\\\":\\\"[Incidents over time ].ControlType\\\"},{\\\"originalName\\\":\\\"[Incidents over time ].CreatedTime\\\"},{\\\"originalName\\\":\\\"[Incidents over time ].AlertRuleUniqueName\\\"},{\\\"originalName\\\":\\\"[Incidents over time ].AnalyticRuleName\\\"},{\\\"originalName\\\":\\\"[AllAnalyticrules].Description\\\"},{\\\"originalName\\\":\\\"[AllAnalyticrules].QueryPeriod\\\"},{\\\"originalName\\\":\\\"[AllAnalyticrules].QueryFrequency\\\"},{\\\"originalName\\\":\\\"[AllAnalyticrules].TableUsed\\\"},{\\\"originalName\\\":\\\"[AllAnalyticrules].TemplateID\\\"},{\\\"originalName\\\":\\\"[Incidents over time ].MyOrgControlFamily\\\"},{\\\"originalName\\\":\\\"[Incidents over time ].CtreateIncidnet\\\"},{\\\"originalName\\\":\\\"[Incidents over time ].AnalyticsTemplateId\\\"}]}\",\"size\":2,\"noDataMessage\":\"No analytic rules are defined \",\"showRefreshButton\":true,\"exportedParameters\":[{\"fieldName\":\"Rule name\",\"parameterName\":\"RuleName\",\"parameterType\":1,\"defaultValue\":\"*\"},{\"fieldName\":\"RuleProperties\",\"parameterName\":\"RuleProperties\",\"parameterType\":1,\"defaultValue\":\"{\\\"Select a rule\\\"}\"},{\"fieldName\":\"EditRuleURL\",\"parameterName\":\"EditRuleURL\",\"parameterType\":1},{\"fieldName\":\"RuleID\",\"parameterName\":\"RuleID\",\"parameterType\":1,\"defaultValue\":\"*\"},{\"fieldName\":\"HasTemplate\",\"parameterName\":\"HasTemplate\",\"parameterType\":1},{\"parameterName\":\"SelectedRule\",\"parameterType\":1,\"defaultValue\":\"null\"},{\"fieldName\":\"TemplateID\",\"parameterName\":\"TemplateID\",\"parameterType\":1,\"defaultValue\":\"*\"}],\"showExportToExcel\":true,\"queryType\":7,\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Severity\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"High\",\"representation\":\"Sev0\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Medium\",\"representation\":\"Sev2\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Low\",\"representation\":\"Sev3\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Informational\",\"representation\":\"Sev4\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":\"[variables('blanks')]\",\"representation\":\"unknown\",\"text\":\"{0}{1}\"}],\"customColumnWidthSetting\":\"14ch\"}},{\"columnMatch\":\"Rule name\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"50ch\"}},{\"columnMatch\":\"TotalIncidentCount\",\"formatter\":4,\"formatOptions\":{\"palette\":\"greenRed\",\"customColumnWidthSetting\":\"100px\"}},{\"columnMatch\":\"IncidentCount\",\"formatter\":9,\"formatOptions\":{\"palette\":\"greenRed\",\"customColumnWidthSetting\":\"100px\"}},{\"columnMatch\":\"TotalAlertCount\",\"formatter\":4,\"formatOptions\":{\"palette\":\"greenRed\",\"customColumnWidthSetting\":\"100px\"}},{\"columnMatch\":\"AlertCount\",\"formatter\":9,\"formatOptions\":{\"palette\":\"greenRed\",\"customColumnWidthSetting\":\"100px\"}},{\"columnMatch\":\"Enabled\",\"formatter\":5},{\"columnMatch\":\"Enable incidents\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"true\",\"representation\":\"success\",\"text\":\"Enabled\"},{\"operator\":\"==\",\"thresholdValue\":\"false\",\"representation\":\"Disable\",\"text\":\"disabled\"},{\"operator\":\"Default\",\"thresholdValue\":\"[variables('blanks')]\",\"representation\":\"unknown\",\"text\":\"{0}{1}\"}],\"customColumnWidthSetting\":\"14ch\"}},{\"columnMatch\":\"HasTemplate\",\"formatter\":5,\"formatOptions\":{\"customColumnWidthSetting\":\"14.5ch\"}},{\"columnMatch\":\"TemplateID\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"is Empty\",\"representation\":\"Canceled\",\"text\":\"Custom\"},{\"operator\":\"Default\",\"thresholdValue\":\"[variables('blanks')]\",\"representation\":\"Available\",\"text\":\"Gallery\"}],\"customColumnWidthSetting\":\"13.7143ch\"}},{\"columnMatch\":\"LastModifiedOn\",\"formatter\":6,\"formatOptions\":{\"customColumnWidthSetting\":\"13.4286ch\"},\"dateFormat\":{\"formatName\":\"shortDatePattern\"}},{\"columnMatch\":\"IncidentPriority\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"27.5714ch\"}},{\"columnMatch\":\"EditRuleURL\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"OpenBlade\",\"linkLabel\":\"Edit  rule\",\"bladeOpenContext\":{\"bladeName\":\"AlertRulesV2WizardBlade\",\"extensionName\":\"Microsoft_Azure_Security_Insights\",\"bladeJsonParameters\":\"{\\r\\n  \\\"kind\\\": \\\"Scheduled\\\",\\r\\n  \\\"editRule\\\": {\\r\\n    \\\"existingAlertRuleId\\\": \\\"{RuleID_column}\\\"\\r\\n  },\\r\\n  \\\"initiator\\\": \\\"AzureSentinel_AlertRulesDetails_EditActionButton\\\"\\r\\n}\"}}},{\"columnMatch\":\"RuleID\",\"formatter\":5},{\"columnMatch\":\"ItemId\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"Default\",\"thresholdValue\":\"[variables('blanks')]\",\"representation\":\"Ellipsis\",\"text\":\"\"}],\"customColumnWidthSetting\":\"5ch\"},\"tooltipFormat\":{\"tooltip\":\"Select this item to configure the SAP aspects \"}},{\"columnMatch\":\"RuleProperties\",\"formatter\":5,\"formatOptions\":{\"linkTarget\":\"CellDetails\",\"linkIsContextBlade\":true}},{\"columnMatch\":\"Query\",\"formatter\":5,\"formatOptions\":{\"linkTarget\":\"GenericDetails\",\"linkLabel\":\"Quick overview\",\"linkIsContextBlade\":true,\"customColumnWidthSetting\":\"15ch\"}},{\"columnMatch\":\"AnalyticRuleId\",\"formatter\":5},{\"columnMatch\":\"Description\",\"formatter\":5},{\"columnMatch\":\"Tactics\",\"formatter\":5},{\"columnMatch\":\"TableUsed\",\"formatter\":5},{\"columnMatch\":\"AlertRuleUniqueName\",\"formatter\":5},{\"columnMatch\":\"AnalyticsTemplateId\",\"formatter\":5},{\"columnMatch\":\"CreatedTime\",\"formatter\":5},{\"columnMatch\":\"Analytic Rule Name\",\"formatter\":5},{\"columnMatch\":\"templateID\",\"formatter\":5},{\"columnMatch\":\"displayName\",\"formatter\":5},{\"columnMatch\":\"Version\",\"formatter\":5},{\"columnMatch\":\"resource0\",\"formatter\":5},{\"columnMatch\":\"properties\",\"formatter\":5},{\"columnMatch\":\"Incidents\",\"formatter\":5,\"formatOptions\":{\"compositeBarSettings\":{\"labelText\":\"\",\"columnSettings\":[]},\"customColumnWidthSetting\":\"14ch\"}},{\"columnMatch\":\"RuleName\",\"formatter\":5,\"formatOptions\":{\"customColumnWidthSetting\":\"45ch\"}},{\"columnMatch\":\"Incident trend\",\"formatter\":5,\"formatOptions\":{\"customColumnWidthSetting\":\"20ch\"}},{\"columnMatch\":\"Alerts\",\"formatter\":5,\"formatOptions\":{\"customColumnWidthSetting\":\"14ch\"}},{\"columnMatch\":\"Alerts trend\",\"formatter\":5,\"formatOptions\":{\"customColumnWidthSetting\":\"20ch\"}},{\"columnMatch\":\"Enable alerts\",\"formatter\":5,\"formatOptions\":{\"customColumnWidthSetting\":\"14ch\"}},{\"columnMatch\":\"PackedDetails\",\"formatter\":5,\"formatOptions\":{\"linkTarget\":\"CellDetails\",\"linkLabel\":\"View SAP Definition\",\"linkIsContextBlade\":true}},{\"columnMatch\":\"RuleURL\",\"formatter\":5,\"formatOptions\":{\"linkTarget\":\"Url\",\"linkIsContextBlade\":false}},{\"columnMatch\":\"Alert Trend\",\"formatter\":5}],\"rowLimit\":600,\"filter\":true,\"sortBy\":[{\"itemKey\":\"$gen_bar_TotalIncidentCount_2\",\"sortOrder\":2}],\"labelSettings\":[{\"columnId\":\"TotalIncidentCount\",\"label\":\"Incidents\"},{\"columnId\":\"IncidentCount\",\"label\":\" \"},{\"columnId\":\"TotalAlertCount\",\"label\":\"Alerts\"},{\"columnId\":\"AlertCount\",\"label\":\" \"},{\"columnId\":\"Enable incidents\",\"label\":\"Incidents\"},{\"columnId\":\"HasTemplate\",\"label\":\"Source\"},{\"columnId\":\"TemplateID\",\"label\":\"Source\"},{\"columnId\":\"LastModifiedOn\",\"label\":\"Last modified\"},{\"columnId\":\"IncidentPriority\",\"label\":\"Recommended configuration\"},{\"columnId\":\"EditRuleURL\",\"label\":\" \"},{\"columnId\":\"Query\",\"label\":\" \"}]},\"sortBy\":[{\"itemKey\":\"$gen_bar_TotalIncidentCount_2\",\"sortOrder\":2}],\"graphSettings\":{\"type\":0},\"mapSettings\":{\"locInfo\":\"LatLong\"}},\"customWidth\":\"80\",\"name\":\"RulesOverview\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"29a7a10d-1803-48f4-a521-73e0dcdb92e1\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"RuleRecommendations\",\"type\":1,\"query\":\"let SelectedRule= \\\"{SelectedRule:escapejson}\\\";\\r\\nprint SelectedRule= SelectedRule\\r\\n| parse-kv SelectedRule as(RuleName:string, RuleID: string, HasTemplate: string, ['Enable alerts']: bool, ['Enable incidents']: bool, IncidentPriority: string) with (pair_delimiter=',', kv_delimiter=':', quote='\\\"')\\r\\n| extend HasTemplate= tobool(replace_string(HasTemplate,\\\"}\\\",\\\"\\\"))\\r\\n//| extend TemplateRecommendation= iff(not(HasTemplate), \\\"Alert rule is missing a template association. \\\\n Follow the steps on \\\\\\\"Associate with template\\\\\\\" \\\", \\\"\\\")\\r\\n| extend IncidentRecommendation= iff(IncidentPriority contains(\\\"Alert\\\") and ['Enable incidents'], \\\"This alert rule is designed to produce alerts to be used for investigation and correlation with other events. \\\\n Consider disabling the creation of incidents for this alert rule \\\", \\\"\\\")\\r\\n| extend AlertRecommendation= iff(not(['Enable alerts']), strcat(\\\"This alert rule is defined with priority '\\\", IncidentPriority, \\\" '.\\\", \\\"\\\\n Consider activating this alert rule from template\\\"), \\\"\\\")\\r\\n| project Recommendation= coalesce(IncidentRecommendation, AlertRecommendation )\",\"isHiddenWhenLocked\":true,\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - Recommendations\"},{\"type\":1,\"content\":{\"json\":\"### Edit the details for \\\"{RuleName}\\\"\",\"style\":\"info\"},\"conditionalVisibility\":{\"parameterName\":\"RuleName\",\"comparison\":\"isNotEqualTo\",\"value\":\"*\"},\"name\":\"text - edit rule name\"},{\"type\":1,\"content\":{\"json\":\"####  {RuleRecommendations}\",\"style\":\"upsell\"},\"conditionalVisibility\":{\"parameterName\":\"RuleRecommendations\",\"comparison\":\"isNotEqualTo\",\"value\":\"\"},\"name\":\"text - edit rule name - Copy\"},{\"type\":1,\"content\":{\"json\":\"### Select a rule from the list to view or edit its properties\",\"style\":\"info\"},\"conditionalVisibility\":{\"parameterName\":\"RuleName\",\"comparison\":\"isEqualTo\",\"value\":\"*\"},\"name\":\"text - select a rule from the list\"},{\"type\":1,\"content\":{\"json\":\"RuleID= {RuleID}\\r\\n\\r\\nItemID= {ItemID}\\r\\n\\r\\nHasTemplate= {HasTemplate}\\r\\n\\r\\nTemplateID= {TemplateID}\\r\\n\\r\\nRuleName= {RuleName}\\r\\n\\r\\n/subscriptions/{Subscription:id}/resourceGroups/{InternalRG}/providers/Microsoft.OperationalInsights/workspaces/{Workspace:name}/providers/Microsoft.SecurityInsights/watchlists/SAPAlertRulesMetadata/watchlistItems/{ItemID}\"},\"conditionalVisibility\":{\"parameterName\":\"DebugMode\",\"comparison\":\"isEqualTo\",\"value\":\"true\"},\"name\":\"text - debug\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"crossComponentResources\":[\"{Workspace}\"],\"parameters\":[{\"id\":\"57d0c599-d37a-45ec-ac62-fd44366b645c\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"ItemID\",\"label\":\"ItemID to be used for getting Control values\",\"type\":1,\"query\":\"// get the itemID that represents a template, or use the default itemID if template is not used\\r\\nlet ARM= materialize(SAPWSAlertRuleMetaData);\\r\\nlet Item4TemplateID= toscalar(ARM | where AnalyticsTemplateId == \\\"{TemplateID}\\\" | project ItemId);\\r\\nlet Item4RuleID= toscalar(ARM | where AnalyticsTemplateId == \\\"{RuleID}\\\" | project ItemId);\\r\\n// use the itemID from the template, rule ID or DefaultItemID if all fails\\r\\nprint ItemID= coalesce(Item4TemplateID,Item4RuleID, \\\"{DefaultItemID}\\\" )\\r\\n| extend Item4RuleID, DefaultItemID= \\\"{DefaultItemID}\\\", TemplateID= \\\"{TemplateID}\\\"\\r\\n\",\"crossComponentResources\":[\"{Workspace}\"],\"isHiddenWhenLocked\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"version\":\"KqlParameterItem/1.0\",\"name\":\"FoundControls\",\"type\":1,\"query\":\"// get the itemID that represents a template, or use the default itemID if template is not used\\r\\nprint FoundControls= iff(\\\"{ItemID}\\\" != \\\"{DefaultItemID}\\\", true, false )\\r\\n\",\"crossComponentResources\":[\"{Workspace}\"],\"isHiddenWhenLocked\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"id\":\"b8882630-efd4-483c-93c1-4352cc462a94\"}],\"style\":\"formVertical\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"ItemID-parameter\",\"styleSettings\":{\"margin\":\"5\",\"padding\":\"5\"}},{\"type\":1,\"content\":{\"json\":\"####  Set controls for alert rule \\\"{RuleName}\\\"\\r\\nNo controls where found for the alert rule. You can set the controls now\",\"style\":\"upsell\"},\"conditionalVisibility\":{\"parameterName\":\"FoundControls\",\"comparison\":\"isNotEqualTo\",\"value\":\"true\"},\"name\":\"text - no controls found, please set\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"crossComponentResources\":[\"{Workspace}\"],\"parameters\":[{\"id\":\"4ae1e7d1-657f-4958-8e79-e58f5edd9855\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"ItemIdOrRuleID\",\"label\":\"Item ID used for setting control values\",\"type\":1,\"query\":\"// get the itemID that represents a template, or use the alert rule ID for setting new values\\r\\nlet ARM= materialize(SAPWSAlertRuleMetaData);\\r\\nlet Item4TemplateID= toscalar(ARM | where AnalyticsTemplateId == \\\"{TemplateID}\\\" | project ItemId);\\r\\n// use the itemID from the template, or rule ID when setting controls values\\r\\nprint ItemID= coalesce(Item4TemplateID, \\\"{RuleID}\\\")\\r\\n\",\"isHiddenWhenLocked\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"db24ec7a-5f5f-406f-9c54-2cf606b65da0\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"GetItem\",\"type\":1,\"query\":\"{\\\"version\\\":\\\"ARMEndpoint/1.0\\\",\\\"method\\\":\\\"GET\\\",\\\"path\\\":\\\"/subscriptions/{Subscription:id}/resourceGroups/{InternalRG}/providers/Microsoft.OperationalInsights/workspaces/{Workspace:name}/providers/Microsoft.SecurityInsights/watchlists/SAPAlertRulesMetadata/watchlistItems/{ItemID}\\\",\\\"urlParams\\\":[{\\\"key\\\":\\\"api-version\\\",\\\"value\\\":\\\"2023-04-01-preview\\\"}],\\\"batchDisabled\\\":false,\\\"transformers\\\":[{\\\"type\\\":\\\"jsonpath\\\",\\\"settings\\\":{\\\"columns\\\":[{\\\"path\\\":\\\"$\\\",\\\"columnid\\\":\\\"Template\\\"}]}}]}\",\"isHiddenWhenLocked\":true,\"queryType\":12,\"value\":\"{\\\"id\\\":\\\"/subscriptions/d1d8779d-38d7-4f06-91db-9cbc8de0176f/resourceGroups/soc/providers/Microsoft.OperationalInsights/workspaces/CyberSecuritySOC/providers/Microsoft.SecurityInsights/Watchlists/SAPAlertRulesMetadata/WatchlistItems/7050bc9a-eb00-420c-9ee8-69842aefdaec\\\",\\\"name\\\":\\\"7050bc9a-eb00-420c-9ee8-69842aefdaec\\\",\\\"etag\\\":\\\"\\\\\\\"480d29a1-0000-0100-0000-64b4fea60000\\\\\\\"\\\",\\\"type\\\":\\\"Microsoft.SecurityInsights/Watchlists/WatchlistItems\\\",\\\"systemData\\\":{\\\"createdAt\\\":\\\"2023-07-17T08:40:52.7434633Z\\\",\\\"createdBy\\\":\\\"tatecksi@microsoft.com\\\",\\\"createdByType\\\":\\\"User\\\",\\\"lastModifiedAt\\\":\\\"2023-07-17T08:40:52.7434633Z\\\",\\\"lastModifiedBy\\\":\\\"tatecksi@microsoft.com\\\",\\\"lastModifiedByType\\\":\\\"User\\\"},\\\"properties\\\":{\\\"watchlistItemType\\\":\\\"watchlist-item\\\",\\\"watchlistItemId\\\":\\\"7050bc9a-eb00-420c-9ee8-69842aefdaec\\\",\\\"tenantId\\\":\\\"4b2462a4-bbee-495a-a0e1-f23ae524cc9c\\\",\\\"isDeleted\\\":false,\\\"created\\\":\\\"2023-07-17T08:40:52.7434633+00:00\\\",\\\"updated\\\":\\\"2023-07-17T08:40:52.7434633+00:00\\\",\\\"createdBy\\\":{\\\"objectId\\\":\\\"7406a3b3-7d00-4547-96b7-80d0ef611ec4\\\",\\\"email\\\":\\\"tatecksi@microsoft.com\\\",\\\"name\\\":\\\"a0965655-eecb-4c9f-8e21-2488aadf59fe\\\"},\\\"updatedBy\\\":{\\\"objectId\\\":\\\"7406a3b3-7d00-4547-96b7-80d0ef611ec4\\\",\\\"email\\\":\\\"tatecksi@microsoft.com\\\",\\\"name\\\":\\\"a0965655-eecb-4c9f-8e21-2488aadf59fe\\\"},\\\"itemsKeyValue\\\":{\\\"RuleID\\\":\\\"DefaultRule\\\",\\\"AnalyticRuleName\\\":\\\"DefaultRule\\\",\\\"AnalyticsTemplateId\\\":\\\"DefaultRule\\\",\\\"RecommendedConfiguration\\\":\\\"As alert only (low fidelity)\\\",\\\"NISTControlFamily\\\":\\\"\\\",\\\"NISTControlID\\\":\\\"\\\",\\\"MyOrgControlFamily\\\":\\\"\\\",\\\"MyOrgControlID\\\":\\\"\\\",\\\"SOXControlFamily\\\":\\\"\\\",\\\"SOXControlID\\\":\\\"\\\",\\\"ControlType\\\":\\\"\\\",\\\"Tasks\\\":\\\"\\\",\\\"Tier1\\\":\\\"\\\",\\\"Tier2\\\":\\\"\\\"}},\\\"ClientRequestId\\\":\\\"b39e35fe-326f-4285-ae24-38fee5a78580\\\"}\"},{\"id\":\"db45b12f-6f8a-4baa-bd04-7ee99f28f262\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"SOXControlFamily\",\"label\":\"SOX Control Family\",\"type\":2,\"isRequired\":true,\"query\":\"let ColumnName= \\\"SOXControlFamily\\\";\\r\\nSAPWSAlertRuleMetaData()\\r\\n| extend selected= iff(ItemId == \\\"{ItemID}\\\", 1, 0)\\r\\n| extend value= column_ifexists(ColumnName, \\\"N/A\\\")\\r\\n| summarize selected=sum(selected) by value\\r\\n| extend label= iff(selected > 0, iff(isempty(value), \\\"N/A\\\", strcat(value, \\\" (original)\\\")), value)\\r\\n| order by selected desc\\r\\n| project-reorder value, label, selected\",\"crossComponentResources\":[\"{Workspace}\"],\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"value\":\"Access Controls\"},{\"id\":\"de94371f-ad7d-4b6a-81af-a41c2ccec1ff\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"SOXControlID\",\"label\":\"SOX Control ID\",\"type\":2,\"isRequired\":true,\"query\":\"let ColumnName= \\\"SOXControlID\\\";\\r\\nSAPWSAlertRuleMetaData()\\r\\n| extend selected= iff(ItemId == \\\"{ItemID}\\\", 1, 0)\\r\\n| extend value= column_ifexists(ColumnName, \\\"N/A\\\")\\r\\n| summarize selected=sum(selected) by value\\r\\n| extend label= iff(selected > 0, iff(isempty(value), \\\"N/A\\\", strcat(value, \\\" (original)\\\")), value)\\r\\n| order by selected desc\\r\\n| project-reorder value, label, selected\\r\\n\",\"crossComponentResources\":[\"{Workspace}\"],\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"value\":\"Sensitive Authorization Monitoring\"},{\"id\":\"1bef957f-bb09-4711-8821-0fb96cd207bc\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"NISTControlFamily\",\"label\":\"NIST Control Family\",\"type\":2,\"isRequired\":true,\"query\":\"let ColumnName= \\\"NISTControlFamily\\\";\\r\\nSAPWSAlertRuleMetaData()\\r\\n| extend selected= iff(ItemId == \\\"{ItemID}\\\", 1, 0)\\r\\n| extend value= column_ifexists(ColumnName, \\\"N/A\\\")\\r\\n| summarize selected=sum(selected) by value\\r\\n| extend label= iff(selected > 0, iff(isempty(value), \\\"N/A\\\", strcat(value, \\\" (original)\\\")), value)\\r\\n| order by selected desc\\r\\n| project-reorder value, label, selected\",\"crossComponentResources\":[\"{Workspace}\"],\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"value\":\"Access Control\"},{\"id\":\"de8fba84-b0c1-49bc-8583-86599823ebc0\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"NISTControlID\",\"label\":\"NIST Control ID\",\"type\":2,\"isRequired\":true,\"query\":\"let ColumnName= \\\"NISTControlID\\\";\\r\\nSAPWSAlertRuleMetaData()\\r\\n| extend selected= iff(ItemId == \\\"{ItemID}\\\", 1, 0)\\r\\n| extend value= column_ifexists(ColumnName, \\\"N/A\\\")\\r\\n| summarize selected=sum(selected) by value\\r\\n| extend label= iff(selected > 0, iff(isempty(value), \\\"N/A\\\", strcat(value, \\\" (original)\\\")), value)\\r\\n| order by selected desc\\r\\n| project-reorder value, label, selected\\r\\n\",\"crossComponentResources\":[\"{Workspace}\"],\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"value\":\"03.01.02\"},{\"id\":\"c0a389ee-5ee8-45ab-8133-3e5f9e3bef3b\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"MyOrgControlFamily\",\"label\":\"MyOrg Control Family\",\"type\":1,\"isRequired\":true,\"query\":\"let ColumnName= \\\"MyOrgControlFamily\\\";\\r\\nSAPWSAlertRuleMetaData()\\r\\n| extend selected= iff(ItemId == \\\"{ItemID}\\\", 1, 0)\\r\\n| extend value= column_ifexists(ColumnName, \\\"N/A\\\")\\r\\n| summarize selected=sum(selected) by value\\r\\n| extend label= iff(selected > 0, iff(isempty(value), \\\"N/A\\\", strcat(value, \\\" (original)\\\")), value)\\r\\n| order by selected desc\\r\\n| project-reorder value, label, selected\\r\\n| where selected > 0    \",\"crossComponentResources\":[\"{Workspace}\"],\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"value\":\"Access controls\"},{\"id\":\"52eaee59-a40b-4ae4-8746-238e4824a69a\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"MyOrgControlID\",\"label\":\"MyOrg Control ID\",\"type\":1,\"isRequired\":true,\"query\":\"let ColumnName= \\\"MyOrgControlID\\\";\\r\\nSAPWSAlertRuleMetaData()\\r\\n| extend selected= iff(ItemId == \\\"{ItemID}\\\", 1, 0)\\r\\n| extend value= column_ifexists(ColumnName, \\\"N/A\\\")\\r\\n| summarize selected=sum(selected) by value\\r\\n| extend label= iff(selected > 0, iff(isempty(value), \\\"N/A\\\", strcat(value, \\\" (original)\\\")), value)\\r\\n| order by selected desc\\r\\n| project-reorder value, label, selected\\r\\n| where selected > 0\",\"crossComponentResources\":[\"{Workspace}\"],\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"value\":\"some control ID\"},{\"id\":\"1aed0816-f7f3-489b-a88f-c3d2318c9c35\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"ControlType\",\"label\":\"Control Type\",\"type\":2,\"isRequired\":true,\"query\":\"let ColumnName= \\\"ControlType\\\";\\r\\nSAPWSAlertRuleMetaData()\\r\\n| extend selected= iff(ItemId == \\\"{ItemID}\\\", 1, 0)\\r\\n| extend value= column_ifexists(ColumnName, \\\"N/A\\\")\\r\\n| summarize selected=sum(selected) by value\\r\\n| extend label= iff(selected > 0, iff(isempty(value), \\\"N/A\\\", strcat(value, \\\" (original)\\\")), value)\\r\\n| order by selected desc\\r\\n| extend value= iff(value == \\\"\\\", \\\"Default\\\", value)\\r\\n| project-reorder value, label, selected\",\"crossComponentResources\":[\"{Workspace}\"],\"isHiddenWhenLocked\":true,\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"a91e3ac7-163f-4be7-92ff-351e10ff80f8\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Tier1\",\"label\":\"Tier 1\",\"type\":2,\"isRequired\":true,\"query\":\"let ColumnName= \\\"Tier1\\\";\\r\\nSAPWSAlertRuleMetaData()\\r\\n| extend selected= iff(ItemId == \\\"{ItemID}\\\", 1, 0)\\r\\n| extend value= column_ifexists(ColumnName, \\\"N/A\\\")\\r\\n| summarize selected=sum(selected) by value\\r\\n| extend label= iff(selected > 0, iff(isempty(value), \\\"N/A\\\", strcat(value, \\\" (original)\\\")), value)\\r\\n| order by selected desc\\r\\n| extend value= iff(value == \\\"\\\", \\\"Default\\\", value)\\r\\n| project-reorder value, label, selected\",\"crossComponentResources\":[\"{Workspace}\"],\"isHiddenWhenLocked\":true,\"typeSettings\":{\"additionalResourceOptions\":[\"value::1\"],\"showDefault\":false},\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"dfd1d0b2-ce8c-4a2e-a3b1-1568cee0a7b0\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Tier2\",\"label\":\"Tier 2\",\"type\":2,\"isRequired\":true,\"query\":\"let ColumnName= \\\"Tier2\\\";\\r\\nSAPWSAlertRuleMetaData()\\r\\n| extend selected= iff(ItemId == \\\"{ItemID}\\\", 1, 0)\\r\\n| extend value= column_ifexists(ColumnName, \\\"N/A\\\")\\r\\n| summarize selected=sum(selected) by value\\r\\n| extend label= iff(selected > 0, iff(isempty(value), \\\"N/A\\\", strcat(value, \\\" (original)\\\")), value)\\r\\n| order by selected desc\\r\\n| extend value= iff(value == \\\"\\\", \\\"Default\\\", value)\\r\\n| project-reorder value, label, selected\",\"crossComponentResources\":[\"{Workspace}\"],\"isHiddenWhenLocked\":true,\"typeSettings\":{\"additionalResourceOptions\":[\"value::1\"],\"showDefault\":false},\"timeContext\":{\"durationMs\":86400000},\"defaultValue\":\"value::1\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"1bd74c9a-c5de-4d7b-8376-355717418f25\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"SetItem\",\"type\":1,\"isRequired\":true,\"query\":\"print Item= todynamic(@'{GetItem}')\\r\\n| evaluate bag_unpack(Item)\\r\\n| project-away etag, systemData, ClientRequestId\\r\\n| evaluate bag_unpack(properties)\\r\\n| evaluate bag_unpack(itemsKeyValue)\\r\\n| extend itemsKeyValue = \\r\\nbag_pack(\\\"RuleID\\\", iff(RuleID contains \\\"DefaultRule\\\", \\\"{RuleName}\\\", RuleID),\\r\\n            \\\"RecommendedConfiguration\\\", RecommendedConfiguration,\\r\\n            \\\"AnalyticRuleName\\\", iff(\\\"{TemplateID}\\\" != \\\"*\\\", AnalyticRuleName, \\\"{RuleName}\\\"),\\r\\n            \\\"AnalyticsTemplateId\\\", iff(\\\"{TemplateID}\\\" != \\\"*\\\", tostring(AnalyticsTemplateId), tostring(\\\"{RuleID}\\\")),\\r\\n            \\\"MyOrgControlFamily\\\", \\\"{MyOrgControlFamily}\\\",\\r\\n            \\\"MyOrgControlID\\\", \\\"{MyOrgControlID}\\\",\\r\\n            \\\"NISTControlFamily\\\", \\\"{NISTControlFamily}\\\",\\r\\n            \\\"NISTControlID\\\", \\\"{NISTControlID}\\\",\\r\\n            \\\"SOXControlFamily\\\", \\\"{SOXControlFamily}\\\",\\r\\n            \\\"SOXControlID\\\", \\\"{SOXControlID}\\\",\\r\\n            \\\"ControlType\\\", \\\"{ControlType}\\\",\\r\\n            \\\"Tasks\\\", Tasks,\\r\\n            \\\"Tier1\\\", \\\"{Tier1}\\\",\\r\\n            \\\"Tier2\\\", \\\"{Tier2}\\\")\\r\\n| extend properties= bag_pack(\\\"watchlistItemType\\\", watchlistItemType,\\r\\n        \\\"watchlistItemId\\\", watchlistItemId,\\r\\n        \\\"tenantId\\\", tenantId,\\r\\n        \\\"isDeleted\\\", false,\\r\\n//        \\\"created\\\", created,\\r\\n//        \\\"updated\\\", updated,\\r\\n//        \\\"createdBy\\\", createdBy,\\r\\n//        \\\"updatedBy\\\", updatedBy,\\r\\n        \\\"itemsKeyValue\\\",itemsKeyValue)\\r\\n| project out= bag_pack(\\\"id\\\", id, \\\"name\\\", name, \\\"type\\\", type, \\\"properties\\\", properties)\\r\\n\",\"crossComponentResources\":[\"{Workspace}\"],\"isHiddenWhenLocked\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"}],\"style\":\"formVertical\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"Parameters-Change-Rule-Controls\",\"styleSettings\":{\"margin\":\"5\",\"padding\":\"5\"}},{\"type\":11,\"content\":{\"version\":\"LinkItem/1.0\",\"style\":\"paragraph\",\"links\":[{\"id\":\"57580a59-508e-47e4-8646-6b08ef65d835\",\"linkTarget\":\"ArmAction\",\"linkLabel\":\"Save Changes\",\"style\":\"primary\",\"linkIsContextBlade\":true,\"armActionContext\":{\"path\":\"/subscriptions/{Subscription:id}/resourceGroups/{InternalRG}/providers/Microsoft.OperationalInsights/workspaces/{Workspace:name}/providers/Microsoft.SecurityInsights/watchlists/SAPAlertRulesMetadata/watchlistItems/{ItemIdOrRuleID}?api-version=2023-04-01-preview\",\"headers\":[],\"params\":[],\"body\":\"{SetItem}\",\"httpMethod\":\"PUT\",\"title\":\"Update Alert Rule {RuleName}\",\"description\":\"### You are about to commit changes to alert rule {RuleName}\\r\\n\\r\\nChanges might take a few miutes to reflect on this dashboard\",\"actionName\":\"Updating SAP alert rule configuration\",\"runLabel\":\"Update SAP alert rule\"}},{\"id\":\"c766274c-f7ec-43f6-80c6-8413363575d9\",\"cellValue\":\"{RuleProperties}\",\"linkTarget\":\"CellDetails\",\"linkLabel\":\"Rule Overview\",\"style\":\"primary\",\"linkIsContextBlade\":true}]},\"name\":\"links - 9\",\"styleSettings\":{\"margin\":\"5px\",\"padding\":\"5px\"}},{\"type\":1,\"content\":{\"json\":\"ItemIdOrRuleID= {ItemIdOrRuleID}\\r\\n\\r\\nItemID= {ItemID}\\r\\n\"},\"conditionalVisibility\":{\"parameterName\":\"DebugMode\",\"comparison\":\"isEqualTo\",\"value\":\"true\"},\"name\":\"text - debug - Copy\"}]},\"conditionalVisibility\":{\"parameterName\":\"RuleID\",\"comparison\":\"isNotEqualTo\",\"value\":\"*\"},\"name\":\"group - SAP Controls\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"db24ec7a-5f5f-406f-9c54-2cf606b65da0\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"GetRule\",\"type\":1,\"query\":\"{\\\"version\\\":\\\"ARMEndpoint/1.0\\\",\\\"headers\\\":[{\\\"key\\\":\\\"\\\",\\\"value\\\":\\\"\\\"}],\\\"method\\\":\\\"GET\\\",\\\"path\\\":\\\"/subscriptions/{Subscription:id}/resourceGroups/{InternalRG}/providers/Microsoft.OperationalInsights/workspaces/{Workspace:name}/providers/Microsoft.SecurityInsights/alertRules/{RuleID}\\\",\\\"urlParams\\\":[{\\\"key\\\":\\\"api-version\\\",\\\"value\\\":\\\"2023-05-01-preview\\\"}],\\\"batchDisabled\\\":false}\",\"isHiddenWhenLocked\":true,\"queryType\":12},{\"id\":\"db45b12f-6f8a-4baa-bd04-7ee99f28f262\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"RuleTemplate\",\"label\":\"Rule Template\",\"type\":2,\"isRequired\":true,\"query\":\"let ColumnName= \\\"AnalyticsTemplateId\\\";\\r\\nlet DummyRefreshCall= \\\"{GetRule:escapejson}\\\";\\r\\nlet DummyEntry= datatable(value: string, label: string, IsSelected: int)[\\\"N/A\\\", \\\"Select A template \\\",1];\\r\\nSAPWSAlertRuleMetaData()\\r\\n| extend value= tostring(column_ifexists(ColumnName, \\\"N/A\\\"))\\r\\n| extend label= AnalyticRuleName\\r\\n| summarize  by value, label\\r\\n| union DummyEntry\\r\\n//| project-reorder value, label\",\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"value\":\"870d9ea0-cd99-4644-9c7a-d7256b0b37e0\"},{\"id\":\"1bd74c9a-c5de-4d7b-8376-355717418f25\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"SetRule\",\"type\":1,\"isRequired\":true,\"query\":\"print Item= todynamic(\\\"{GetRule:escapejson}\\\")\\r\\n| extend Item= bag_set_key(Item,\\\"$.properties.alertRuleTemplateName\\\",\\\"{RuleTemplate}\\\")\\r\\n| extend Item= bag_set_key(Item,\\\"$.properties.templateVersion\\\",\\\"2.0.0\\\")\\r\\n| extend Item= bag_remove_keys(Item,dynamic([\\\"id\\\",\\\"name\\\",\\\"type\\\",\\\"defaultVisualization\\\"\\r\\n,\\\"$.properties.lastModifiedUtc\\\",\\\"etag\\\"]))\\r\\n\",\"isHiddenWhenLocked\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"}],\"style\":\"formVertical\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"Parameters-Change-Rule-Controls\",\"styleSettings\":{\"margin\":\"5\",\"padding\":\"5\"}},{\"type\":1,\"content\":{\"json\":\"Associating an alert rule with a template requires it to be cloned. It starts with deleting the alert rule, and then recreating it with the exact same properties, with the addition of the assigned selected template.\\r\\n\\r\\nClick on the \\\"Delete\\\", and then \\\"Recreate\\\" buttons below.\\r\\n\",\"style\":\"warning\"},\"name\":\"text - 2\"},{\"type\":11,\"content\":{\"version\":\"LinkItem/1.0\",\"style\":\"nav\",\"links\":[{\"id\":\"fc619122-ef3b-44f0-8d9b-769e71573543\",\"linkTarget\":\"ArmAction\",\"linkLabel\":\"Delete\",\"preText\":\"Step 1\",\"style\":\"primary\",\"linkIsContextBlade\":true,\"armActionContext\":{\"path\":\"/subscriptions/{Subscription:id}/resourceGroups/{InternalRG}/providers/Microsoft.OperationalInsights/workspaces/{Workspace:name}/providers/Microsoft.SecurityInsights/alertRules/{RuleID}?api-version=2023-05-01-preview\",\"headers\":[],\"params\":[],\"body\":\"{SetRule}\",\"httpMethod\":\"DELETE\",\"title\":\"Step 1- Delete the rule\",\"description\":\"### You are about to delete the alert rule {RuleName}\\n### Once the deletion is complete, be sure to click on \\\"Recreate as template\\\" to complete the process\",\"actionName\":\"Delete Rule\",\"runLabel\":\"Step 1- delete\"}},{\"id\":\"6389973d-cd45-428f-8192-9f948efa25d7\",\"linkTarget\":\"ArmAction\",\"linkLabel\":\"Recreate\",\"preText\":\"Step 2\",\"style\":\"primary\",\"linkIsContextBlade\":true,\"armActionContext\":{\"path\":\"/subscriptions/{Subscription:id}/resourceGroups/{InternalRG}/providers/Microsoft.OperationalInsights/workspaces/{Workspace:name}/providers/Microsoft.SecurityInsights/alertRules/{RuleID}?api-version=2023-05-01-preview\",\"headers\":[],\"params\":[],\"body\":\"{SetRule}\",\"httpMethod\":\"PUT\",\"title\":\"Recreate alert rule with template\",\"description\":\"### Step 2- recreating the alert rule {RuleName} with template\",\"actionName\":\"Creating rule {RuleName}\",\"runLabel\":\"Recreate rule as templated\"}}]},\"conditionalVisibility\":{\"parameterName\":\"RuleTemplate\",\"comparison\":\"isNotEqualTo\",\"value\":\"N/A\"},\"name\":\"links - Associate with template\",\"styleSettings\":{\"margin\":\"5px\",\"padding\":\"5px\"}}]},\"conditionalVisibilities\":[{\"parameterName\":\"ConfigRuleState\",\"comparison\":\"isEqualTo\",\"value\":\"AssociateWithTemplate\"},{\"parameterName\":\"ItemID\",\"comparison\":\"isEqualTo\"},{\"parameterName\":\"RuleName\",\"comparison\":\"isNotEqualTo\",\"value\":\"*\"}],\"name\":\"group - Associate Rule With Templae\"}],\"exportParameters\":true},\"customWidth\":\"20\",\"name\":\"Group-config-actions\",\"styleSettings\":{\"padding\":\"5px\"}}]},\"conditionalVisibility\":{\"parameterName\":\"SelectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"Configure\"},\"name\":\"Group-Config-alert-rules\",\"styleSettings\":{\"showBorder\":true}}],\"exportParameters\":true},\"conditionalVisibility\":{\"parameterName\":\"SelectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"Configure\"},\"name\":\"GroupAlertRulesOverview\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Incidents\",\"items\":[{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Incidents trend\",\"expandable\":true,\"expanded\":true,\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"6e88f0c3-9d54-416e-87be-3f3752a6a3b1\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"IncidentsTrendDetailLevel\",\"label\":\"Detail incidents by\",\"type\":2,\"isRequired\":true,\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"jsonData\":\"[{\\\"value\\\":\\\"ControlFamily\\\", \\\"label\\\":\\\"Control family\\\", \\\"selected\\\": true}, {\\\"value\\\":\\\"ControlID\\\", \\\"label\\\":\\\"Control ID\\\"},{\\\"value\\\":\\\"AnalyticRuleName\\\", \\\"label\\\": \\\"Analytic rule name\\\"}, {\\\"value\\\":\\\"SystemRole\\\", \\\"label\\\":\\\"System role\\\"}, {\\\"value\\\":\\\"SAPSystem\\\", \\\"label\\\":\\\"System ID\\\"}]\\r\\n\\r\\n\",\"value\":\"ControlID\"}],\"style\":\"formHorizontal\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"customWidth\":\"30\",\"name\":\"parameters - 12 - Copy\",\"styleSettings\":{\"maxWidth\":\"200\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let SelectedSystems= materialize(SAPSystems(SelectedSystemRoles=dynamic(\\\"{SystemRoles}\\\")\\n, SelectedSystems=todynamic(\\\"[{Systems}]\\\")\\n, SelectedSystemUsage= dynamic(\\\"{SystemUsage}\\\")) | project SystemID, SystemRole);\\nlet ARMetaData= SAPWSAlertRuleMetaData() | where RuleID != \\\"DefaultRule\\\";\\nSAPWSIncidentsDetailed\\n| where ((CreatedTime >= {TimeRange:start} and CreatedTime <= {TimeRange:end}) or (AlertStartTime >= {TimeRange:start} and AlertStartTime <= {TimeRange:end}))\\n| extend CreatedTime= coalesce(CreatedTime, AlertStartTime)\\n| project IncidentNumber, TimeGenerated, Severity, Status, Product, SAPSystem, Tactics, Owner, CreatedTime, AlertRuleUniqueName, SystemAlertId, AnalyticRuleName, AnalyticsTemplateId, AnalyticRuleId\\n| extend AnalyticRuleName= replace_string(AnalyticRuleName, \\\"SAP - \\\",\\\"\\\")\\n| where SAPSystem in((SelectedSystems | summarize by SystemID)) or isempty(SAPSystem)\\n| extend SAPSystem= iff(\\\"{DemoMode}\\\" == \\\"true\\\", toupper(substring(hash_sha256(SAPSystem), 0, 3)), SAPSystem)\\n| where Severity in ({Severity}) or \\\"*\\\" in ({Severity}) \\n| where Status in ({Status}) or \\\"*\\\" in ({Status})\\n| where Owner in ({Owner}) or \\\"*\\\" in ({Owner})\\n| where arraylength(set_intersect(Tactics, dynamic([{Tactics}]))) > 0 or \\\"*\\\" in ({Tactics})\\n| extend AnalyticsTemplateId= coalesce(tostring(AnalyticsTemplateId), AnalyticRuleId)\\n| join kind= fullouter (ARMetaData | extend AnalyticsTemplateId=tostring(AnalyticsTemplateId), IncidentPriority= RecommendedConfiguration) on AnalyticsTemplateId\\n| extend ControlID= {ControlFrameWork}ControlID\\n| extend ControlID= iff(isnotempty(ControlID), ControlID, \\\"Not assigned\\\")\\n| where ControlID in ({ControlIDs}) or \\\"*\\\" in ({ControlIDs})\\n| extend ControlFamily= {ControlFrameWork}ControlFamily\\n| extend ControlFamily= iff(isnotempty(ControlFamily), ControlFamily, \\\"Not assigned\\\")\\n| where ControlFamily in ({ControlFamilys}) or \\\"*\\\" in ({ControlFamilys})\\n| lookup SelectedSystems on $left.SAPSystem == $right.SystemID\\n| extend IncidentsTrendDetailLevel= column_ifexists(\\\"{IncidentsTrendDetailLevel}\\\", \\\"N/A\\\")\\n| extend IncidentsTrendDetailLevel= iff(isempty(IncidentsTrendDetailLevel),\\\"N/A\\\", IncidentsTrendDetailLevel)\\n| extend QueryHasSAP= iff(isnotempty(IncidentPriority),\\\"SAP\\\",\\\"\\\")\\n| where (CreatedTime >= {TimeRange:start} and CreatedTime <= {TimeRange:end})\\n| summarize IncidentCount= dcount(IncidentNumber) by bin(CreatedTime, 3h), IncidentsTrendDetailLevel\\n\",\"size\":0,\"timeContextFromParameter\":\"TimeRange\",\"exportFieldName\":\"CreatedTime\",\"exportParameterName\":\"TimePicker\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"areachart\",\"gridSettings\":{\"filter\":true,\"sortBy\":[{\"itemKey\":\"CreatedTime\",\"sortOrder\":2}]},\"sortBy\":[{\"itemKey\":\"CreatedTime\",\"sortOrder\":2}],\"graphSettings\":{\"type\":0,\"topContent\":{\"columnMatch\":\"ControlID\",\"formatter\":1},\"centerContent\":{\"columnMatch\":\"IncidentCount\",\"formatter\":1,\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}},\"chartSettings\":{\"xAxis\":\"CreatedTime\",\"yAxis\":[\"IncidentCount\"],\"group\":\"IncidentsTrendDetailLevel\",\"createOtherGroup\":10,\"seriesLabelSettings\":[{\"seriesName\":\"count_\",\"label\":\"Incidents\"}]}},\"customWidth\":\"100\",\"name\":\"Incidents over time \"}]},\"name\":\"IncidentsTrends\",\"styleSettings\":{\"showBorder\":true}},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Incidents hive\",\"expandable\":true,\"expanded\":true,\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"02eb590e-ec17-440a-9c92-22a05e502c38\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"DrillLevel1\",\"label\":\"Drill by \",\"type\":10,\"isRequired\":true,\"query\":\"let Options= datatable(value:string, label: string, selected: real)\\r\\n[\\\"ControlFamily\\\", \\\"{ControlFrameWork} Control family\\\", 12\\r\\n, \\\"ControlID\\\", \\\"{ControlFrameWork} Control ID\\\", 11\\r\\n, \\\"SystemRole\\\", \\\"System role\\\", 9];\\r\\nOptions\",\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"616c83da-1e0c-4d87-b0cd-864ad6605626\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"DrillLevel2\",\"label\":\"And then by\",\"type\":10,\"isRequired\":true,\"query\":\"let Options= datatable(value:string, label: string, selected: real)\\r\\n[\\\"ControlID\\\", \\\"{ControlFrameWork} Control ID\\\", 10\\r\\n,\\\"AnalyticRuleName\\\", \\\"Analytic rule name\\\", 9\\r\\n, \\\"SAPSystem\\\", \\\"System ID\\\", 8];\\r\\nOptions\\r\\n| where value != \\\"{DrillLevel1}\\\"\\r\\n| order by selected\",\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"}],\"style\":\"above\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 12\"},{\"type\":1,\"content\":{\"json\":\"#### Incidents detailed by {DrillLevel1:label} and {DrillLevel2:label}, {TimeRange:label}\"},\"name\":\"text - 2\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let SelectedSystems= materialize(SAPSystems(SelectedSystemRoles=dynamic(\\\"{SystemRoles}\\\")\\n, SelectedSystems=todynamic(\\\"[{Systems}]\\\")\\n, SelectedSystemUsage= dynamic(\\\"{SystemUsage}\\\")) | project SystemID, SystemRole);\\nlet ARMetaData= SAPWSAlertRuleMetaData() | where RuleID != \\\"DefaultRule\\\";\\nSAPWSIncidentsDetailed\\n| where ((CreatedTime >= {TimeRange:start} and CreatedTime <= {TimeRange:end}) or (AlertStartTime >= {TimeRange:start} and AlertStartTime <= {TimeRange:end}))\\n| extend CreatedTime= coalesce(CreatedTime, AlertStartTime)\\n| project IncidentNumber, TimeGenerated, Severity, Status, Product, SAPSystem, Tactics, Owner, CreatedTime, AlertRuleUniqueName, SystemAlertId, AnalyticRuleName, AnalyticsTemplateId, AnalyticRuleId\\n| extend AnalyticRuleName= replace_string(AnalyticRuleName, \\\"SAP - \\\",\\\"\\\")\\n| where SAPSystem in((SelectedSystems | summarize by SystemID)) or isempty(SAPSystem)\\n| extend SAPSystem= iff(\\\"{DemoMode}\\\" == \\\"true\\\", toupper(substring(hash_sha256(SAPSystem), 0, 3)), SAPSystem)\\n| where Severity in ({Severity}) or \\\"*\\\" in ({Severity}) \\n| where Status in ({Status}) or \\\"*\\\" in ({Status}) \\n| where Owner in ({Owner}) or \\\"*\\\" in ({Owner})\\n| where arraylength(set_intersect(Tactics, dynamic([{Tactics}]))) > 0 or \\\"*\\\" in ({Tactics})\\n| extend AnalyticsTemplateId= coalesce(tostring(AnalyticsTemplateId), AnalyticRuleId)\\n| join kind= fullouter (ARMetaData | extend AnalyticsTemplateId=tostring(AnalyticsTemplateId), IncidentPriority= RecommendedConfiguration) on AnalyticsTemplateId\\n| extend QueryHasSAP= iff(isnotempty(IncidentPriority),\\\"SAP\\\",\\\"\\\")\\n| extend ControlID= {ControlFrameWork}ControlID\\n| extend ControlID= iff(isnotempty(ControlID), ControlID, \\\"Not assigned\\\")\\n| where ControlID in ({ControlIDs}) or \\\"*\\\" in ({ControlIDs})\\n| extend ControlFamily= {ControlFrameWork}ControlFamily\\n| extend ControlFamily= iff(isnotempty(ControlFamily), ControlFamily, \\\"Not assigned\\\")\\n| where ControlFamily in ({ControlFamilys}) or \\\"*\\\" in ({ControlFamilys})\\n| lookup SelectedSystems on $left.SAPSystem == $right.SystemID\\n| extend DrillLevel1= column_ifexists(\\\"{DrillLevel1}\\\", \\\"N/A\\\"), DrillLevel2= column_ifexists(\\\"{DrillLevel2}\\\", \\\"N/A\\\")\\n| extend DrillLevel1= iff(isempty(DrillLevel1),\\\"N/A\\\", DrillLevel1), DrillLevel2= iff(isempty(DrillLevel2),\\\"N/A\\\", DrillLevel2)\\n| summarize IncidentCount= dcount(IncidentNumber), AlertCount= dcount(SystemAlertId) by DrillLevel1, DrillLevel2\\n| extend AlertCount= strcat(AlertCount, \\\" Alerts\\\")\\n| extend Subtitle= \\\"Incidents\\\"\",\"size\":2,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"graph\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"Condition\",\"formatter\":1},\"subtitleContent\":{\"columnMatch\":\"Subtitle\"},\"leftContent\":{\"columnMatch\":\"IncidentCount\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":2,\"maximumSignificantDigits\":3}}},\"rightContent\":{\"columnMatch\":\"Right\"},\"secondaryContent\":{\"columnMatch\":\"AlertCount\",\"formatter\":1},\"showBorder\":false,\"size\":\"auto\"},\"graphSettings\":{\"type\":2,\"topContent\":{\"columnMatch\":\"DrillLevel2\",\"formatter\":1,\"tooltipFormat\":{\"tooltip\":\"{0}\"}},\"centerContent\":{\"columnMatch\":\"IncidentCount\",\"formatter\":12,\"formatOptions\":{\"palette\":\"blue\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":2,\"maximumSignificantDigits\":3}}},\"hivesContent\":{\"columnMatch\":\"DrillLevel1\",\"formatter\":12,\"formatOptions\":{\"palette\":\"blue\"}},\"nodeIdField\":\"DrillLevel2\",\"graphOrientation\":3,\"showOrientationToggles\":false,\"nodeSize\":\"[variables('blanks')]\",\"staticNodeSize\":80,\"colorSettings\":{\"nodeColorField\":\"IncidentCount\",\"type\":4,\"heatmapPalette\":\"greenRed\",\"heatmapMin\":\"[variables('blanks')]\",\"heatmapMax\":\"[variables('blanks')]\"},\"groupByField\":\"DrillLevel1\",\"hivesMargin\":5}},\"name\":\"Incidents by Control ID and Condition\"}]},\"name\":\"GroupIncidentsHive\",\"styleSettings\":{\"showBorder\":true}}]},\"conditionalVisibility\":{\"parameterName\":\"SelectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"Monitor\"},\"name\":\"GroupIncidents\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Incidents\",\"items\":[{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"expandable\":true,\"expanded\":true,\"items\":[{\"type\":1,\"content\":{\"json\":\"#### Incidents analysis, {TimeRange:label}\"},\"name\":\"text - 2\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let SelectedSystems= materialize(SAPSystems(SelectedSystemRoles=dynamic(\\\"{SystemRoles}\\\")\\n, SelectedSystems=todynamic(\\\"[{Systems}]\\\")\\n, SelectedSystemUsage= dynamic(\\\"{SystemUsage}\\\")) | project SystemID, SystemRole);\\nlet ARMetaData= SAPWSAlertRuleMetaData() | where RuleID != \\\"DefaultRule\\\";\\nSAPWSIncidentsDetailed\\n| where CreatedTime >= {TimeRange:start} and CreatedTime <= {TimeRange:end}\\n| project IncidentNumber, TimeGenerated, Severity, Status, Product, SAPSystem, Tactics, Owner, CreatedTime, AlertRuleUniqueName, SystemAlertId, AnalyticRuleName, AnalyticsTemplateId, AnalyticRuleId, Classification\\n| extend AnalyticRuleName= replace_string(AnalyticRuleName, \\\"SAP - \\\",\\\"\\\")\\n| where SAPSystem in((SelectedSystems | summarize by SystemID)) or isempty(SAPSystem)\\n| extend SAPSystem= iff(\\\"{DemoMode}\\\" == \\\"true\\\", toupper(substring(hash_sha256(SAPSystem), 0, 3)), SAPSystem)\\n| where Severity in ({Severity}) or \\\"*\\\" in ({Severity})\\n| where Status in ({Status}) or \\\"*\\\" in ({Status})\\n| where Owner in ({Owner}) or \\\"*\\\" in ({Owner})\\n| where arraylength(set_intersect(Tactics, dynamic([{Tactics}]))) > 0 or \\\"*\\\" in ({Tactics})\\n| extend AnalyticsTemplateId= coalesce(tostring(AnalyticsTemplateId), AnalyticRuleId)\\n| join kind= fullouter (ARMetaData | extend AnalyticsTemplateId=tostring(AnalyticsTemplateId), IncidentPriority= RecommendedConfiguration) on AnalyticsTemplateId\\n| extend QueryHasSAP= iff(isnotempty(IncidentPriority),\\\"SAP\\\",\\\"\\\")\\n| extend ControlID= {ControlFrameWork}ControlID\\n| extend ControlID= iff(isnotempty(ControlID), ControlID, \\\"Not assigned\\\")\\n| where ControlID in ({ControlIDs}) or \\\"*\\\" in ({ControlIDs})\\n| extend ControlFamily= {ControlFrameWork}ControlFamily\\n| extend ControlFamily= iff(isnotempty(ControlFamily), ControlFamily, \\\"Not assigned\\\")\\n| where ControlFamily in ({ControlFamilys}) or \\\"*\\\" in ({ControlFamilys})\\n| lookup SelectedSystems on $left.SAPSystem == $right.SystemID\\n| summarize IncidentCount= dcount(IncidentNumber) by Classification\\n\\n\\n\\n\\n\",\"size\":0,\"title\":\"Incidents by classification \",\"timeContextFromParameter\":\"TimeRange\",\"exportFieldName\":\"CreatedTime\",\"exportParameterName\":\"TimePicker\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\",\"gridSettings\":{\"filter\":true,\"sortBy\":[{\"itemKey\":\"CreatedTime\",\"sortOrder\":2}]},\"sortBy\":[{\"itemKey\":\"CreatedTime\",\"sortOrder\":2}],\"graphSettings\":{\"type\":0,\"topContent\":{\"columnMatch\":\"ControlID\",\"formatter\":1},\"centerContent\":{\"columnMatch\":\"IncidentCount\",\"formatter\":1,\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}},\"chartSettings\":{\"xAxis\":\"CreatedTime\",\"yAxis\":[\"IncidentCount\"],\"group\":\"Classification\",\"createOtherGroup\":10,\"seriesLabelSettings\":[{\"seriesName\":\"count_\",\"label\":\"Incidents\"}]}},\"customWidth\":\"32\",\"name\":\"Incidents by classification \"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let SelectedSystems= materialize(SAPSystems(SelectedSystemRoles=dynamic(\\\"{SystemRoles}\\\")\\n, SelectedSystems=todynamic(\\\"[{Systems}]\\\")\\n, SelectedSystemUsage= dynamic(\\\"{SystemUsage}\\\")) | project SystemID, SystemRole);\\nlet ARMetaData= SAPWSAlertRuleMetaData() | where RuleID != \\\"DefaultRule\\\";\\nSAPWSIncidentsDetailed\\n| where CreatedTime >= {TimeRange:start} and CreatedTime <= {TimeRange:end}\\n| project IncidentNumber, TimeGenerated, Severity, Status, Product, SAPSystem, Tactics, Owner, CreatedTime, AlertRuleUniqueName, SystemAlertId, AnalyticRuleName, AnalyticsTemplateId, AnalyticRuleId\\n| extend AnalyticRuleName= replace_string(AnalyticRuleName, \\\"SAP - \\\",\\\"\\\")\\n| where SAPSystem in((SelectedSystems | summarize by SystemID)) or isempty(SAPSystem)\\n| extend SAPSystem= iff(\\\"{DemoMode}\\\" == \\\"true\\\", toupper(substring(hash_sha256(SAPSystem), 0, 3)), SAPSystem)\\n| where Severity in ({Severity}) or \\\"*\\\" in ({Severity})\\n| where Status in ({Status}) or \\\"*\\\" in ({Status})\\n| where Owner in ({Owner}) or \\\"*\\\" in ({Owner})\\n| where arraylength(set_intersect(Tactics, dynamic([{Tactics}]))) > 0 or \\\"*\\\" in ({Tactics})\\n| extend AnalyticsTemplateId= coalesce(tostring(AnalyticsTemplateId), AnalyticRuleId)\\n| join kind= fullouter (ARMetaData | extend AnalyticsTemplateId=tostring(AnalyticsTemplateId), IncidentPriority= RecommendedConfiguration) on AnalyticsTemplateId\\n| extend QueryHasSAP= iff(isnotempty(IncidentPriority),\\\"SAP\\\",\\\"\\\")\\n| extend ControlID= {ControlFrameWork}ControlID\\n| extend ControlID= iff(isnotempty(ControlID), ControlID, \\\"Not assigned\\\")\\n| where ControlID in ({ControlIDs}) or \\\"*\\\" in ({ControlIDs})\\n| extend ControlFamily= {ControlFrameWork}ControlFamily\\n| extend ControlFamily= iff(isnotempty(ControlFamily), ControlFamily, \\\"Not assigned\\\")\\n| where ControlFamily in ({ControlFamilys}) or \\\"*\\\" in ({ControlFamilys})\\n| lookup SelectedSystems on $left.SAPSystem == $right.SystemID\\n| summarize IncidentCount= dcount(IncidentNumber) by Severity\\n\\n\\n\\n\\n\",\"size\":0,\"title\":\"Incidents by severity\",\"timeContextFromParameter\":\"TimeRange\",\"exportFieldName\":\"CreatedTime\",\"exportParameterName\":\"TimePicker\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\",\"gridSettings\":{\"filter\":true,\"sortBy\":[{\"itemKey\":\"CreatedTime\",\"sortOrder\":2}]},\"sortBy\":[{\"itemKey\":\"CreatedTime\",\"sortOrder\":2}],\"graphSettings\":{\"type\":0,\"topContent\":{\"columnMatch\":\"ControlID\",\"formatter\":1},\"centerContent\":{\"columnMatch\":\"IncidentCount\",\"formatter\":1,\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}},\"chartSettings\":{\"xAxis\":\"CreatedTime\",\"yAxis\":[\"IncidentCount\"],\"group\":\"Severity\",\"createOtherGroup\":10,\"seriesLabelSettings\":[{\"seriesName\":\"count_\",\"label\":\"Incidents\"}]}},\"customWidth\":\"32\",\"name\":\"Incidents by severity\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let SelectedSystems= materialize(SAPSystems(SelectedSystemRoles=dynamic(\\\"{SystemRoles}\\\")\\n, SelectedSystems=todynamic(\\\"[{Systems}]\\\")\\n, SelectedSystemUsage= dynamic(\\\"{SystemUsage}\\\")) | project SystemID, SystemRole);\\nlet ARMetaData= SAPWSAlertRuleMetaData() | where RuleID != \\\"DefaultRule\\\";\\nSAPWSIncidentsDetailed\\n| where CreatedTime >= {TimeRange:start} and CreatedTime <= {TimeRange:end}\\n| where Status == \\\"Closed\\\"\\n| project IncidentNumber, TimeGenerated, Severity, Status, Product, SAPSystem, Tactics, Owner, CreatedTime, AlertRuleUniqueName, SystemAlertId, AnalyticRuleName, AnalyticsTemplateId, AnalyticRuleId\\n| extend AnalyticRuleName= replace_string(AnalyticRuleName, \\\"SAP - \\\",\\\"\\\")\\n| where SAPSystem in((SelectedSystems | summarize by SystemID)) or isempty(SAPSystem)\\n| extend SAPSystem= iff(\\\"{DemoMode}\\\" == \\\"true\\\", toupper(substring(hash_sha256(SAPSystem), 0, 3)), SAPSystem)\\n| where Severity in ({Severity}) or \\\"*\\\" in ({Severity})\\n| where Status in ({Status}) or \\\"*\\\" in ({Status})\\n| where Owner in ({Owner}) or \\\"*\\\" in ({Owner})\\n| where arraylength(set_intersect(Tactics, dynamic([{Tactics}]))) > 0 or \\\"*\\\" in ({Tactics})\\n| extend AnalyticsTemplateId= coalesce(tostring(AnalyticsTemplateId), AnalyticRuleId)\\n| join kind= fullouter (ARMetaData | extend AnalyticsTemplateId=tostring(AnalyticsTemplateId), IncidentPriority= RecommendedConfiguration) on AnalyticsTemplateId\\n| extend QueryHasSAP= iff(isnotempty(IncidentPriority),\\\"SAP\\\",\\\"\\\")\\n| extend ControlID= {ControlFrameWork}ControlID\\n| extend ControlID= iff(isnotempty(ControlID), ControlID, \\\"Not assigned\\\")\\n| where ControlID in ({ControlIDs}) or \\\"*\\\" in ({ControlIDs})\\n| extend ControlFamily= {ControlFrameWork}ControlFamily\\n| extend ControlFamily= iff(isnotempty(ControlFamily), ControlFamily, \\\"Not assigned\\\")\\n| where ControlFamily in ({ControlFamilys}) or \\\"*\\\" in ({ControlFamilys})\\n| lookup SelectedSystems on $left.SAPSystem == $right.SystemID\\n| summarize IncidentCount= dcount(IncidentNumber) by tostring(Owner)\\n\\n\\n\\n\\n\",\"size\":0,\"title\":\"Closed Incidents by owner\",\"timeContextFromParameter\":\"TimeRange\",\"exportFieldName\":\"CreatedTime\",\"exportParameterName\":\"TimePicker\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\",\"gridSettings\":{\"filter\":true,\"sortBy\":[{\"itemKey\":\"CreatedTime\",\"sortOrder\":2}]},\"sortBy\":[{\"itemKey\":\"CreatedTime\",\"sortOrder\":2}],\"graphSettings\":{\"type\":0,\"topContent\":{\"columnMatch\":\"ControlID\",\"formatter\":1},\"centerContent\":{\"columnMatch\":\"IncidentCount\",\"formatter\":1,\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}},\"chartSettings\":{\"xAxis\":\"CreatedTime\",\"yAxis\":[\"IncidentCount\"],\"group\":\"Owner\",\"createOtherGroup\":10,\"seriesLabelSettings\":[{\"seriesName\":\"count_\",\"label\":\"Incidents\"}]}},\"customWidth\":\"32\",\"name\":\"Closed incidents by owner\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let SelectedSystems= materialize(SAPSystems(SelectedSystemRoles=dynamic(\\\"{SystemRoles}\\\")\\n, SelectedSystems=todynamic(\\\"[{Systems}]\\\")\\n, SelectedSystemUsage= dynamic(\\\"{SystemUsage}\\\")) | project SystemID, SystemRole);\\nlet ARMetaData= SAPWSAlertRuleMetaData() | where RuleID != \\\"DefaultRule\\\";\\nSAPWSIncidentsDetailed\\n| where CreatedTime >= {TimeRange:start} and CreatedTime <= {TimeRange:end}\\n| project IncidentNumber, TimeGenerated, Severity, Status, Product, SAPSystem, Tactics, Owner, CreatedTime, AlertRuleUniqueName, SystemAlertId, AnalyticRuleName, AnalyticsTemplateId, AnalyticRuleId\\n| extend AnalyticRuleName= replace_string(AnalyticRuleName, \\\"SAP - \\\",\\\"\\\")\\n| where SAPSystem in((SelectedSystems | summarize by SystemID)) or isempty(SAPSystem)\\n| extend SAPSystem= iff(\\\"{DemoMode}\\\" == \\\"true\\\", toupper(substring(hash_sha256(SAPSystem), 0, 3)), SAPSystem)\\n| where Severity in ({Severity}) or \\\"*\\\" in ({Severity})\\n| where Status in ({Status}) or \\\"*\\\" in ({Status})\\n| where Owner in ({Owner}) or \\\"*\\\" in ({Owner})\\n| where arraylength(set_intersect(Tactics, dynamic([{Tactics}]))) > 0 or \\\"*\\\" in ({Tactics})\\n| extend AnalyticsTemplateId= coalesce(tostring(AnalyticsTemplateId), AnalyticRuleId)\\n| join kind= fullouter (ARMetaData | extend AnalyticsTemplateId=tostring(AnalyticsTemplateId), IncidentPriority= RecommendedConfiguration) on AnalyticsTemplateId\\n| extend QueryHasSAP= iff(isnotempty(IncidentPriority),\\\"SAP\\\",\\\"\\\")\\n| extend ControlID= {ControlFrameWork}ControlID\\n| extend ControlID= iff(isnotempty(ControlID), ControlID, \\\"Not assigned\\\")\\n| where ControlID in ({ControlIDs}) or \\\"*\\\" in ({ControlIDs})\\n| extend ControlFamily= {ControlFrameWork}ControlFamily\\n| extend ControlFamily= iff(isnotempty(ControlFamily), ControlFamily, \\\"Not assigned\\\")\\n| where ControlFamily in ({ControlFamilys}) or \\\"*\\\" in ({ControlFamilys})\\n| lookup SelectedSystems on $left.SAPSystem == $right.SystemID\\n| summarize IncidentCount= dcount(IncidentNumber) by AnalyticRuleName\\n\\n\\n\\n\\n\",\"size\":0,\"timeContextFromParameter\":\"TimeRange\",\"exportFieldName\":\"CreatedTime\",\"exportParameterName\":\"TimePicker\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"tiles\",\"gridSettings\":{\"filter\":true,\"sortBy\":[{\"itemKey\":\"CreatedTime\",\"sortOrder\":2}]},\"sortBy\":[{\"itemKey\":\"CreatedTime\",\"sortOrder\":2}],\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"AnalyticRuleName\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"IncidentCount\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}},\"graphSettings\":{\"type\":0,\"topContent\":{\"columnMatch\":\"ControlID\",\"formatter\":1},\"centerContent\":{\"columnMatch\":\"IncidentCount\",\"formatter\":1,\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}},\"chartSettings\":{\"xAxis\":\"CreatedTime\",\"yAxis\":[\"IncidentCount\"],\"group\":\"Owner\",\"createOtherGroup\":10,\"showLegend\":true,\"seriesLabelSettings\":[{\"seriesName\":\"count_\",\"label\":\"Incidents\"}]}},\"name\":\"Closed Incidents by Owner - Copy\"}]},\"name\":\"Incidents analysis\",\"styleSettings\":{\"showBorder\":true}}]},\"conditionalVisibility\":{\"parameterName\":\"SelectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"Monitor\"},\"name\":\"GroupIncidents - Pies\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Incidents detailed report\",\"expandable\":true,\"expanded\":true,\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let SelectedSystems= SAPSystems(SelectedSystemRoles=dynamic(\\\"{SystemRoles}\\\")\\n, SelectedSystems=todynamic(\\\"[{Systems}]\\\")\\n, SelectedSystemUsage= dynamic(\\\"{SystemUsage}\\\")) | project SystemID;\\nlet ARMetaData= SAPWSAlertRuleMetaData();\\nSAPWSIncidentsDetailed\\n| where CreatedTime >= {TimeRange:start} and CreatedTime <= {TimeRange:end}\\n| project IncidentNumber, TimeGenerated, Severity, Status, Product, SAPSystem, Tactics, Owner, CreatedTime, AlertRuleUniqueName, SystemAlertId, AnalyticsTemplateId, AnalyticRuleId\\n, Title, Description, FirstActivityTime, LastActivityTime, LastModifiedTime, IPAddress, ADAccount, IncidentUrl\\n| where SAPSystem in((SelectedSystems | summarize by SystemID)) or isempty(SAPSystem)\\n| where Severity in ({Severity}) or \\\"*\\\" in ({Severity})\\n| where Status in ({Status}) or \\\"*\\\" in ({Status})\\n| where Owner in ({Owner}) or \\\"*\\\" in ({Owner})\\n| where arraylength(set_intersect(Tactics, dynamic([{Tactics}]))) > 0 or \\\"*\\\" in ({Tactics})\\n| extend AnalyticsTemplateId= coalesce(tostring(AnalyticsTemplateId), AnalyticRuleId) // to handle non-templates, use alert ID\\n| join kind= leftouter (ARMetaData | extend AnalyticsTemplateId=tostring(AnalyticsTemplateId)) on AnalyticsTemplateId\\n| extend ControlID= {ControlFrameWork}ControlID\\n| extend ControlID= iff(isnotempty(ControlID), ControlID, \\\"Not assigned\\\")\\n| where ControlID in ({ControlIDs}) or \\\"*\\\" in ({ControlIDs})\\n| extend ControlFamily= {ControlFrameWork}ControlFamily\\n| extend ControlFamily= iff(isnotempty(ControlFamily), ControlFamily, \\\"Not assigned\\\")\\n| where ControlFamily in ({ControlFamilys}) or \\\"*\\\" in ({ControlFamilys})\\n| project-away AlertRuleUniqueName, TimeGenerated, MyOrgControlFamily, MyOrgControlID, SOXControlFamily, SOXControlID, Tier2Email, Tier2TeamsChannel, Tier2TeamsGroup, Tier1Email, Tier1TeamsChannel, Tier1TeamsGroup, Tasks, Tactics\\n| extend Tier1= iff(isnotempty(Tier1), Tier1, \\\"Not assigned\\\")\\n| extend Tier2= iff(isnotempty(Tier2), Tier2, \\\"Not assigned\\\")\\n| project-reorder Tier1, Tier2, ControlFamily, ControlID, Owner, IncidentUrl, Severity, Status\\n| extend SAPSystem= iff(\\\"{DemoMode}\\\" == \\\"true\\\", toupper(substring(hash_sha256(SAPSystem), 0, 3)), SAPSystem)\",\"size\":2,\"showAnalytics\":true,\"timeContextFromParameter\":\"TimeRange\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"IncidentUrl\",\"formatter\":18,\"formatOptions\":{\"linkTarget\":\"Url\",\"linkIsContextBlade\":false,\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"Default\",\"thresholdValue\":\"[variables('blanks')]\",\"representation\":\"Hyperlink\",\"text\":\"{0} See details\"}],\"customColumnWidthSetting\":\"10ch\"}},{\"columnMatch\":\"Severity\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"High\",\"representation\":\"Sev1\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Medium\",\"representation\":\"Sev2\",\"text\":\"{0}{1}\"},{\"thresholdValue\":\"Low\",\"representation\":\"Sev3\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Informational\",\"representation\":\"1\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":\"[variables('blanks')]\",\"representation\":\"unknown\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"Status\",\"formatter\":1}],\"rowLimit\":200,\"filter\":true,\"labelSettings\":[{\"columnId\":\"Tier1\",\"label\":\"Tier 1\"},{\"columnId\":\"Tier2\",\"label\":\"Tier 2\"},{\"columnId\":\"ControlID\",\"label\":\"Control ID\"},{\"columnId\":\"IncidentUrl\",\"label\":\"Incident Url\"},{\"columnId\":\"IncidentNumber\",\"label\":\"Incident number\"},{\"columnId\":\"SAPSystem\",\"label\":\"SAP system\"},{\"columnId\":\"CreatedTime\",\"label\":\"Created time\"},{\"columnId\":\"SystemAlertId\",\"label\":\"System alert Id\"},{\"columnId\":\"FirstActivityTime\",\"label\":\"First activity time\"},{\"columnId\":\"LastActivityTime\",\"label\":\"Last activity time\"},{\"columnId\":\"LastModifiedTime\",\"label\":\"Last modified time\"},{\"columnId\":\"IPAddress\",\"label\":\"IP address\"},{\"columnId\":\"ADAccount\",\"label\":\"AD account\"},{\"columnId\":\"ControlType\",\"label\":\"Control type\"}]},\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"Condition\",\"formatter\":1},\"subtitleContent\":{\"columnMatch\":\"Subtitle\"},\"leftContent\":{\"columnMatch\":\"IncidentCount\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":2,\"maximumSignificantDigits\":3}}},\"rightContent\":{\"columnMatch\":\"Right\"},\"secondaryContent\":{\"columnMatch\":\"AlertCount\",\"formatter\":1},\"showBorder\":false,\"size\":\"auto\"},\"graphSettings\":{\"type\":2,\"topContent\":{\"columnMatch\":\"Condition\",\"formatter\":1},\"centerContent\":{\"columnMatch\":\"IncidentCount\",\"formatter\":1,\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}},\"bottomContent\":{\"columnMatch\":\"AlertCount\"},\"hivesContent\":{\"columnMatch\":\"ControlID\",\"formatter\":12,\"formatOptions\":{\"palette\":\"blue\"}},\"nodeIdField\":\"Condition\",\"graphOrientation\":3,\"showOrientationToggles\":false,\"nodeSize\":\"[variables('blanks')]\",\"staticNodeSize\":100,\"colorSettings\":{\"nodeColorField\":\"IncidentCount\",\"type\":4,\"heatmapPalette\":\"greenRed\",\"heatmapMin\":\"[variables('blanks')]\",\"heatmapMax\":\"[variables('blanks')]\"},\"groupByField\":\"ControlID\",\"hivesMargin\":5}},\"customWidth\":\"100\",\"name\":\"Incidents detailed\"}]},\"conditionalVisibility\":{\"parameterName\":\"SelectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"Report\"},\"name\":\"GroupIncidentsDetailed\",\"styleSettings\":{\"showBorder\":true}}],\"fromTemplateId\":\"sentinel-SAP-AuditControls\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\",\"fallbackResourceIds\":[]}\n",
                                "version": "1.0",
                                "sourceId": "[variables('workspaceResourceId')]",
                                "category": "sentinel"
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Workbook-', last(split(variables('workbookId1'),'/'))))]",
                            "properties": {
                                "description": "@{workbookKey=SAP-AuditControls; logoFileName=SAPVMIcon.svg; description=SAP -Audit Controls; dataTypesDependencies=System.Object[]; dataConnectorsDependencies=System.Object[]; previewImagesFileNames=System.Object[]; version=2.0.4; title=SAP -Audit Controls; templateRelativePath=SAP -Audit Controls.json; subtitle=; provider=Microsoft}.description",
                                "parentId": "[variables('workbookId1')]",
                                "contentId": "[variables('_workbookContentId1')]",
                                "kind": "Workbook",
                                "version": "[variables('workbookVersion1')]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SAP",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                },
                                "dependencies": {
                                    "operator": "AND",
                                    "criteria": [
                                        {
                                            "contentId": "SAPAuditLog",
                                            "kind": "DataType"
                                        },
                                        {
                                            "contentId": "SAP",
                                            "kind": "DataConnector"
                                        }
                                    ]
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('_workbookContentId1')]",
                "contentKind": "Workbook",
                "displayName": "[parameters('workbook1-name')]",
                "contentProductId": "[variables('_workbookcontentProductId1')]",
                "id": "[variables('_workbookcontentProductId1')]",
                "version": "[variables('workbookVersion1')]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('workbookTemplateSpecName2')]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP -Monitors- Alerts and PerformanceWorkbook Workbook with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('workbookVersion2')]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.Insights/workbooks",
                            "name": "[variables('workbookContentId2')]",
                            "location": "[parameters('workspace-location')]",
                            "kind": "shared",
                            "apiVersion": "2021-08-01",
                            "metadata": {
                                "description": "SAP -Monitors- Alerts and Performance"
                            },
                            "properties": {
                                "displayName": "[parameters('workbook2-name')]",
                                "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"SAP Monitors- Alerts and Performance\\n---\\nThis workbook uses the SAP Alerts (RZ20) data\\nUse the parameters below to select subscription scope, timerange and relevant SAP systems.\"},\"name\":\"text - 2\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"9a199167-2dde-49dd-8f01-23e9d1fa8151\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"InternalWSs\",\"type\":1,\"isRequired\":true,\"query\":\"SecurityIncident\\r\\n| take 1\\r\\n| parse IncidentUrl with * \\\"/workspaces/\\\" Workspace \\\"/\\\" *\\r\\n| project Workspace\",\"isHiddenWhenLocked\":true,\"timeContext\":{\"durationMs\":604800000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"7806fefd-432f-4828-9756-8c0be5c08d07\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"InternalSub\",\"type\":1,\"isRequired\":true,\"query\":\"where type =~ 'microsoft.operationalinsights/workspaces'\\r\\n| where name contains \\\"{InternalWSs}\\\"\\r\\n| take 10\\r\\n| project subscriptionId\",\"crossComponentResources\":[\"value::selected\"],\"isHiddenWhenLocked\":true,\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},{\"id\":\"55d3ab63-6e1f-4d02-8d9e-2225526689c7\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Subscription\",\"label\":\"Subscriptions\",\"type\":6,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"where type =~ 'microsoft.operationalinsights/workspaces'\\r\\n| extend selected= iff(name contains \\\"{InternalWSs}\\\", true, false) \\r\\n| project subscriptionId, selected\\r\\n| summarize selected= max(selected) by subscriptionId\\r\\n\",\"crossComponentResources\":[\"value::all\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::50\"],\"showDefault\":false},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},{\"id\":\"4a62c5aa-0c4c-439a-9977-41cd19a40933\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"SAPWorkspace\",\"label\":\"SAP Workspace\",\"type\":5,\"isRequired\":true,\"isGlobal\":true,\"query\":\"where type =~ 'microsoft.operationalinsights/workspaces'\\r\\n| project value =id, label = name, selected = iff(name =~ '{InternalWSs}', true, false)\\r\\n| order by selected desc\\r\\n\",\"crossComponentResources\":[\"value::all\"],\"typeSettings\":{\"resourceTypeFilter\":{\"microsoft.securityinsightsarg/sentinel\":true,\"microsoft.operationalinsights/workspaces\":true},\"additionalResourceOptions\":[],\"showDefault\":false},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"}],\"style\":\"above\",\"doNotRunWhenHidden\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"customWidth\":\"100\",\"name\":\"Select relevant workspaces\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"a2f453a3-836c-4e70-8840-45a27f6ac30f\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"label\":\"Time Range\",\"type\":4,\"description\":\"Select the time range that will be used for the query's\",\"isRequired\":true,\"typeSettings\":{\"selectableValues\":[{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}],\"allowCustom\":false},\"value\":{\"durationMs\":14400000}},{\"id\":\"4c106c4f-59b7-40bc-a501-cd6d463ba585\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"SystemRoles\",\"label\":\"System Roles\",\"type\":10,\"isRequired\":true,\"isGlobal\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"let EmptySystems= datatable ( SystemID: string, SystemID_s:string , SystemUsage: string, SystemRole: string, Count: long  )['All Systems', 'All Systems', 'All System Usage', 'All System Roles', 1];\\r\\nlet AuditSystems = union isfuzzy= true *ABAPAuditLog_CL, (union Xal* | project-rename SystemID_s= MTSYSID_s), (EmptySystems| project SystemID, SystemID_s) | summarize by SystemID= SystemID_s;\\r\\nAuditSystems\\r\\n| lookup kind=inner (SAPSystems() | union isfuzzy=true EmptySystems) on SystemID\\r\\n| extend ranked= array_sum(to_utf8(SystemRole))\\r\\n| summarize Ranked= any(ranked) by SystemRole\\r\\n| order by Ranked desc\\r\\n| serialize Rank = row_number()\\r\\n| project value= SystemRole, label= strcat('', SystemRole), selected= iff(Rank==1, true, false)\\r\\n\",\"crossComponentResources\":[\"{SAPWorkspace}\"],\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"1a31d436-bb4b-469f-94a8-5ad9aa018edd\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"SystemUsage\",\"label\":\"System Usage\",\"type\":10,\"isRequired\":true,\"isGlobal\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"let EmptySystems= datatable ( SystemID: string, SystemID_s:string , SystemUsage: string, SystemRole: string, Count: long  )['All Systems', 'All Systems', 'All Usage Types', 'All System Roles', 1];\\r\\nlet AuditSystems = union isfuzzy= true *ABAPAuditLog_CL, (union Xal* | project-rename SystemID_s= MTSYSID_s), (EmptySystems| project SystemID, SystemID_s, SystemUsage) | summarize by SystemID= SystemID_s, SystemUsage;\\r\\nAuditSystems\\r\\n| lookup (SAPSystems(SelectedSystemRoles=dynamic(\\\"{SystemRoles}\\\"))) on SystemID\\r\\n| extend SystemUsage= strcat(SystemUsage, SystemUsage1)\\r\\n| extend ranked= array_sum(to_utf8(SystemUsage))\\r\\n| summarize Ranked= any(ranked) by SystemUsage\\r\\n| where isnotempty(SystemUsage)\\r\\n| order by Ranked desc\\r\\n| serialize Rank = row_number()\\r\\n//| where isnotempty(SystemUsage) or SystemID == 'All Systems'\\r\\n| project value= SystemUsage, label= strcat('', SystemUsage), selected= iff(Rank==1, true, false)\\r\\n\\r\\n\",\"crossComponentResources\":[\"{SAPWorkspace}\"],\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"b5ed6d2c-e44f-48ac-a535-af6f2d7ab53d\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Systems\",\"type\":2,\"isRequired\":true,\"isGlobal\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"let EmptySystems= datatable ( SystemID: string, SystemID_s:string , SystemUsage: string, SystemRole: string, Count: long  )['All Systems', 'All Systems', 'All System Usage', 'All System Roles', 1];\\r\\nlet AuditSystems = union isfuzzy= true ABAPAuditLog_CL, (union Xal* | project-rename SystemID_s= MTSYSID_s), (EmptySystems| project SystemID, SystemID_s, SystemRole) | summarize SystemRole= any(SystemRole) by SystemID= SystemID_s\\r\\n| extend ranked= array_sum(to_utf8(SystemID));\\r\\nAuditSystems\\r\\n| lookup (SAPSystems(SelectedSystemRoles=dynamic(\\\"{SystemRoles}\\\"), SelectedSystemUsage=dynamic(\\\"{SystemUsage}\\\")) ) on SystemID\\r\\n//| extend SystemRole = strcat(SystemRole, SystemRole1)\\r\\n| extend SystemRole = SystemRole1\\r\\n| where isnotempty(SystemRole)\\r\\n| summarize Ranked= any(ranked) by SystemID, SystemRole, SystemUsage\\r\\n| order by Ranked desc\\r\\n| serialize Rank = row_number()\\r\\n| project value= SystemID, label= strcat('', SystemID)\\r\\n//, selected= iff(Rank==1, true, false)\\r\\n//| project value, label, Selected= true\\r\\n\\r\\n\\r\\n\\r\\n\",\"crossComponentResources\":[\"{SAPWorkspace}\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"selectAllValue\":\"All Systems\",\"showDefault\":false},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"defaultValue\":\"value::all\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"value\":[\"value::all\"]},{\"id\":\"e336fafe-2ebd-4198-b60d-90ce89fd9944\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"OnlyShowCurrentMonitors\",\"label\":\"Show Monitors\",\"type\":10,\"isRequired\":true,\"isGlobal\":true,\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"jsonData\":\"[ {\\\"value\\\": \\\"false\\\", \\\"label\\\": \\\"Active monitors\\\", \\\"selected\\\": true}, {\\\"value\\\": \\\"true\\\", \\\"label\\\": \\\"All monitors\\\"}]\"}],\"style\":\"above\",\"doNotRunWhenHidden\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SAPSystems(SelectedSystemRoles=dynamic(\\\"{SystemRoles}\\\")\\r\\n, SelectedSystems=todynamic(\\\"[{Systems}]\\\")\\r\\n, SelectedSystemUsage= dynamic(\\\"{SystemUsage}\\\")) \\r\\n| project SystemID\\r\\n| summarize Systems= makeset(SystemID,50)\\r\\n| project text= strcat(\\\"\\\", \\\"Selected SAP Systems: \\\", translate('\\\"[]', ' ', tostring(Systems)))\\r\\n\",\"size\":4,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"card\",\"textSettings\":{\"style\":\"markdown\"}},\"conditionalVisibility\":{\"parameterName\":\"Systems\",\"comparison\":\"isNotEqualTo\",\"value\":\"'All Systems'\"},\"name\":\"query - 10\"},{\"type\":11,\"content\":{\"version\":\"LinkItem/1.0\",\"style\":\"tabs\",\"tabStyle\":\"bigger\",\"links\":[{\"id\":\"a997c6cd-4d82-4fd5-b128-a16fbfd0e421\",\"cellValue\":\"MainTabSelected\",\"linkTarget\":\"parameter\",\"linkLabel\":\" Performance Indicators\",\"subTarget\":\"Performance\",\"preText\":\"Audit log alerts\",\"style\":\"link\",\"icon\":\"Sev2\"},{\"id\":\"3a13be26-b92f-43fb-ac8b-593fadff36e6\",\"cellValue\":\"MainTabSelected\",\"linkTarget\":\"parameter\",\"linkLabel\":\" Alerts\",\"subTarget\":\"Alerts\",\"preText\":\"Logon analysis\",\"style\":\"link\",\"icon\":\"Sev2\",\"tabWidth\":\"200\"},{\"id\":\"c8f34134-31b2-415b-8ea5-2fcbf465b2c4\",\"cellValue\":\"MainTabSelected\",\"linkTarget\":\"parameter\",\"linkLabel\":\" Monitoring Tree\",\"subTarget\":\"MonitoringTree\",\"style\":\"link\"}]},\"customWidth\":\"100\",\"name\":\"tabs main\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let SelectedSystems= SAPSystems(SelectedSystemRoles=dynamic(\\\"{SystemRoles}\\\")\\r\\n, SelectedSystems=todynamic(\\\"[{Systems}]\\\")\\r\\n, SelectedSystemUsage= dynamic(\\\"{SystemUsage}\\\")) | project SystemID;\\r\\n//SelectedSystems\\r\\nSAPXalPerformance\\r\\n| where SystemID in(SelectedSystems)\\r\\n| union (SAPXalMonitorSetsTree | where {OnlyShowCurrentMonitors} | summarize by MonitorSetName , TimeGenerated= now())\\r\\n| make-series TrendList = count()-1 on TimeGenerated in range({TimeRange:start}, {TimeRange:end}, 1h) by MonitorSetName\\r\\n| extend Count= array_sum(TrendList)\",\"size\":0,\"timeContextFromParameter\":\"TimeRange\",\"showRefreshButton\":true,\"exportMultipleValues\":true,\"exportedParameters\":[{\"fieldName\":\"MonitorSetName\",\"parameterName\":\"MonitorSetNames\",\"parameterType\":1,\"quote\":\"'\"}],\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"tiles\",\"gridSettings\":{\"filter\":true},\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"MonitorSetName\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"Count\",\"formatter\":12,\"formatOptions\":{\"palette\":\"blue\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":2,\"maximumSignificantDigits\":3}}},\"secondaryContent\":{\"columnMatch\":\"TrendList\",\"formatter\":9,\"formatOptions\":{\"palette\":\"coldHot\"}},\"showBorder\":false,\"sortCriteriaField\":\"Count\",\"sortOrderField\":2,\"size\":\"auto\"},\"graphSettings\":{\"type\":0,\"topContent\":{\"columnMatch\":\"MonitorSetName\",\"formatter\":1},\"centerContent\":{\"columnMatch\":\"Count\",\"formatter\":1,\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}},\"nodeIdField\":\"MonitorName\",\"sourceIdField\":\"MonitorSetName\",\"targetIdField\":\"MonitorName\",\"graphOrientation\":2,\"showOrientationToggles\":true,\"edgeLabel\":\"MonitorName\",\"nodeSize\":\"\",\"staticNodeSize\":100,\"colorSettings\":\"\",\"hivesMargin\":5}},\"name\":\"MonitoringSetsAndNames\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"fea87446-d53e-4cef-a72c-d8cd9a3e81d5\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"MonitorNames\",\"label\":\"Monitors\",\"type\":2,\"isGlobal\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"let SelectedSystems= SAPSystems(SelectedSystemRoles=dynamic(\\\"{SystemRoles}\\\")\\r\\n, SelectedSystems=todynamic(\\\"[{Systems}]\\\")\\r\\n, SelectedSystemUsage= dynamic(\\\"{SystemUsage}\\\")) | project SystemID;\\r\\nSAPXalPerformance\\r\\n| where SystemID in(SelectedSystems)\\r\\n| where MonitorSetName in (todynamic(\\\"[{MonitorSetNames}]\\\")) or tostring(\\\"{MonitorSetNames}\\\")== \\\"\\\"\\r\\n| where ReverseOrder ==1\\r\\n| summarize Count= count() by value= MonitorName\\r\\n| order by Count desc\\r\\n| extend display= strcat(\\\" \\\", value, \\\" (\\\", Count,\\\")\\\" )\\r\\n| project value, display;\",\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"selectAllValue\":\"All Monitors\",\"showDefault\":false},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"defaultValue\":\"value::all\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"value\":[\"value::all\"]},{\"id\":\"8e0be7b9-2b76-459c-afa3-f4834b457f52\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"OnlyShowLastValues\",\"label\":\"Values\",\"type\":2,\"isRequired\":true,\"isGlobal\":true,\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"jsonData\":\"[{\\\"value\\\": \\\"true\\\", \\\"label\\\": \\\"Most recent values\\\", \\\"selected\\\": true}, {\\\"value\\\": \\\"false\\\", \\\"label\\\": \\\"Include history\\\"}]\",\"timeContext\":{\"durationMs\":86400000}}],\"style\":\"above\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 2\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let SelectedSystems= SAPSystems(SelectedSystemRoles=dynamic(\\\"{SystemRoles}\\\")\\r\\n, SelectedSystems=todynamic(\\\"[{Systems}]\\\")\\r\\n, SelectedSystemUsage= dynamic(\\\"{SystemUsage}\\\")) | project SystemID;\\r\\nlet OnlyShowLastValues= tostring(\\\"{OnlyShowLastValues}\\\");\\r\\nSAPXalPerformance\\r\\n| take 1 | project SystemID\\r\\n| project SelectedMonitors= strcat(\\\"Selected monitors: \\\",replace_string(tostring(\\\"{MonitorNames}\\\"), \\\"'\\\",\\\" \\\"))\",\"size\":4,\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"card\",\"textSettings\":{\"style\":\"header\"}},\"conditionalVisibility\":{\"parameterName\":\"MonitorNames\",\"comparison\":\"isNotEqualTo\",\"value\":\"'All Monitors'\"},\"name\":\"query - 3\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let SelectedSystems= SAPSystems(SelectedSystemRoles=dynamic(\\\"{SystemRoles}\\\")\\r\\n, SelectedSystems=todynamic(\\\"[{Systems}]\\\")\\r\\n, SelectedSystemUsage= dynamic(\\\"{SystemUsage}\\\")) | project SystemID;\\r\\nlet OnlyShowLastValues= tostring(\\\"{OnlyShowLastValues}\\\");\\r\\nlet Performance= SAPXalPerformance\\r\\n| where SystemID in(SelectedSystems)\\r\\n| where MonitorSetName in (todynamic(\\\"[{MonitorSetNames}]\\\")) or tostring(\\\"{MonitorSetNames}\\\")== \\\"\\\"\\r\\n| where MonitorName in (todynamic(\\\"[{MonitorNames}]\\\")) or tostring(\\\"{MonitorNames}\\\")== \\\"'All Monitors'\\\";\\r\\n\\r\\nPerformance \\r\\n| where ReverseOrder == 1 or OnlyShowLastValues == \\\"false\\\"\\r\\n| extend LastReported= iff(ReverseOrder == 1, \\\"Most Recent\\\", \\\"History\\\")\\r\\n| project-reorder Color, LastReported, MonitorSetName, MonitorName, MonitoringTypeName, ObjectName, SystemID, UpdatedOn\\r\\n\\r\\n\",\"size\":2,\"timeContextFromParameter\":\"TimeRange\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Color\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"Green\",\"representation\":\"success\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Yellow\",\"representation\":\"2\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Red\",\"representation\":\"3\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":\"\",\"representation\":\"unknown\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"Group\",\"formatter\":1}],\"rowLimit\":1000,\"filter\":true,\"sortBy\":[{\"itemKey\":\"LastReported\",\"sortOrder\":1}]},\"sortBy\":[{\"itemKey\":\"LastReported\",\"sortOrder\":1}]},\"name\":\"query - 1\"}]},\"conditionalVisibility\":{\"parameterName\":\"MainTabSelected\",\"comparison\":\"isEqualTo\",\"value\":\"Performance\"},\"name\":\"PerformanceGroup\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let SelectedSystems= SAPSystems(SelectedSystemRoles=dynamic(\\\"{SystemRoles}\\\")\\r\\n, SelectedSystems=todynamic(\\\"[{Systems}]\\\")\\r\\n, SelectedSystemUsage= dynamic(\\\"{SystemUsage}\\\")) | project SystemID;\\r\\n//SelectedSystems\\r\\nSAPXalAlerts\\r\\n| where SystemID in(SelectedSystems)\\r\\n| union (SAPXalMonitorSetsTree | where {OnlyShowCurrentMonitors} | summarize by MonitorSetName , TimeGenerated= now())\\r\\n| make-series TrendList = count()-1 on TimeGenerated in range({TimeRange:start}, {TimeRange:end}, 41h) by MonitorSetName\\r\\n| extend Count= array_sum(TrendList)\\r\\n\",\"size\":0,\"timeContextFromParameter\":\"TimeRange\",\"showRefreshButton\":true,\"exportMultipleValues\":true,\"exportedParameters\":[{\"fieldName\":\"MonitorSetName\",\"parameterName\":\"MonitorSetNames\",\"parameterType\":1,\"quote\":\"'\"}],\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"tiles\",\"gridSettings\":{\"filter\":true},\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"MonitorSetName\",\"formatter\":1},\"subtitleContent\":{\"columnMatch\":\"MonitorName\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"Count\",\"formatter\":12,\"formatOptions\":{\"palette\":\"blue\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":2,\"maximumSignificantDigits\":3}}},\"secondaryContent\":{\"columnMatch\":\"TrendList\",\"formatter\":9,\"formatOptions\":{\"palette\":\"coldHot\"}},\"showBorder\":false,\"sortCriteriaField\":\"Count\",\"sortOrderField\":2,\"size\":\"auto\"},\"graphSettings\":{\"type\":0,\"topContent\":{\"columnMatch\":\"MonitorSetName\",\"formatter\":1},\"centerContent\":{\"columnMatch\":\"Count\",\"formatter\":1,\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}},\"nodeIdField\":\"MonitorName\",\"sourceIdField\":\"MonitorSetName\",\"targetIdField\":\"MonitorName\",\"graphOrientation\":2,\"showOrientationToggles\":true,\"edgeLabel\":\"MonitorName\",\"nodeSize\":\"\",\"staticNodeSize\":100,\"colorSettings\":\"\",\"hivesMargin\":5}},\"name\":\"MonitoringSetsAndNames\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"fea87446-d53e-4cef-a72c-d8cd9a3e81d5\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"MonitorNames\",\"label\":\"Monitors\",\"type\":2,\"isGlobal\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"let SelectedSystems= SAPSystems(SelectedSystemRoles=dynamic(\\\"{SystemRoles}\\\")\\r\\n, SelectedSystems=todynamic(\\\"[{Systems}]\\\")\\r\\n, SelectedSystemUsage= dynamic(\\\"{SystemUsage}\\\")) | project SystemID;\\r\\nSAPXalAlerts\\r\\n| where SystemID in(SelectedSystems)\\r\\n| where MonitorSetName in (todynamic(\\\"[{MonitorSetNames}]\\\")) or tostring(\\\"{MonitorSetNames}\\\")== \\\"\\\"\\r\\n| summarize Count= count() by value= MonitorName\\r\\n| order by Count desc\\r\\n| extend display= strcat(\\\" \\\", value, \\\" (\\\", Count,\\\")\\\" )\\r\\n| project value, display;\",\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"selectAllValue\":\"All Monitors\",\"showDefault\":false},\"timeContext\":{\"durationMs\":604800000},\"timeContextFromParameter\":\"TimeRange\",\"defaultValue\":\"value::all\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"}],\"style\":\"above\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 2\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let SelectedSystems= SAPSystems(SelectedSystemRoles=dynamic(\\\"{SystemRoles}\\\")\\r\\n, SelectedSystems=todynamic(\\\"[{Systems}]\\\")\\r\\n, SelectedSystemUsage= dynamic(\\\"{SystemUsage}\\\")) | project SystemID;\\r\\n//SelectedSystems\\r\\nSAPXalAlerts\\r\\n| where SystemID in(SelectedSystems)\\r\\n| where MonitorSetName in (todynamic(\\\"[{MonitorSetNames}]\\\")) or tostring(\\\"{MonitorSetNames}\\\")== \\\"\\\"\\r\\n| where MonitorName in (todynamic(\\\"[{MonitorNames}]\\\")) or tostring(\\\"{MonitorNames}\\\")== \\\"'All Monitors'\\\"\\r\\n| project-reorder MonitorSetName, MonitorName, Color, Severity, STATUS, AlertCompletionStatus\\r\\n\",\"size\":2,\"timeContextFromParameter\":\"TimeRange\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Color\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"Red\",\"representation\":\"failed\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Yellow\",\"representation\":\"2\",\"text\":\"{0}{1}\"},{\"thresholdValue\":\"Green\",\"representation\":\"success\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":\"\",\"representation\":\"unknown\",\"text\":\"{0}{1}\"}]}}],\"filter\":true,\"sortBy\":[{\"itemKey\":\"AlertCompletionStatus\",\"sortOrder\":1}]},\"sortBy\":[{\"itemKey\":\"AlertCompletionStatus\",\"sortOrder\":1}]},\"name\":\"query - 1\"}]},\"conditionalVisibility\":{\"parameterName\":\"MainTabSelected\",\"comparison\":\"isEqualTo\",\"value\":\"Alerts\"},\"name\":\"AlertGroup\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let SelectedSystems= SAPSystems(SelectedSystemRoles=dynamic(\\\"{SystemRoles}\\\")\\r\\n, SelectedSystems=todynamic(\\\"[{Systems}]\\\")\\r\\n, SelectedSystemUsage= dynamic(\\\"{SystemUsage}\\\")) | project SystemID;\\r\\nlet XalUnion= (SAPXalAlerts | where SystemID in(SelectedSystems)\\r\\n| summarize Alerts= count(), AlertColor=max(VALUE) by MonitorSetName, MonitorName, SystemID\\r\\n| extend Source= \\\"Alerts\\\") \\r\\n| union (SAPXalPerformance \\r\\n| where SystemID in(SelectedSystems)\\r\\n| where ReverseOrder == 1\\r\\n| summarize Performance= count(), PerfColor= max(RelevantAlertStatus) by MonitorName, MonitorSetName, SystemID, MonitoringTypeName, ObjectName\\r\\n| extend Source= \\\"Performance\\\")\\r\\n| union (SAPXalMonitorSetsTree | where {OnlyShowCurrentMonitors} | summarize by MonitorSetName , MonitorName, Source= \\\"Tree\\\");\\r\\nXalUnion \\r\\n| summarize Alerts= sum(Alerts), Performance=sum(Performance), AlertColor=max(AlertColor), PerfColor= max(PerfColor) by MonitorSetName , MonitorName, SystemID\\r\\n| project-reorder MonitorSetName , MonitorName, SystemID, Alerts, AlertColor, Performance, PerfColor\\r\\n| order by Performance desc\\r\\n\",\"size\":2,\"title\":\"Alerts & current performance indicators\",\"timeContextFromParameter\":\"TimeRange\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Monitor Set Name\",\"formatter\":1},{\"columnMatch\":\"MonitorSetName\",\"formatter\":5},{\"columnMatch\":\"MonitorName\",\"formatter\":5},{\"columnMatch\":\"Alerts\",\"formatter\":0,\"formatOptions\":{\"aggregation\":\"Sum\"}},{\"columnMatch\":\"AlertColor\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"3\",\"representation\":\"4\",\"text\":\"\"},{\"operator\":\"==\",\"thresholdValue\":\"2\",\"representation\":\"2\",\"text\":\"\"},{\"operator\":\"==\",\"thresholdValue\":\"1\",\"representation\":\"success\",\"text\":\"\"},{\"operator\":\"Default\",\"thresholdValue\":\"\",\"representation\":\"Blank\",\"text\":\"\"}],\"aggregation\":\"Max\"}},{\"columnMatch\":\"Performance\",\"formatter\":0,\"formatOptions\":{\"aggregation\":\"Sum\"}},{\"columnMatch\":\"PerfColor\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"3\",\"representation\":\"4\",\"text\":\"\"},{\"operator\":\"==\",\"thresholdValue\":\"2\",\"representation\":\"2\",\"text\":\"\"},{\"operator\":\"==\",\"thresholdValue\":\"1\",\"representation\":\"success\",\"text\":\"\"},{\"operator\":\"Default\",\"thresholdValue\":\"\",\"representation\":\"Blank\",\"text\":\"\"}],\"aggregation\":\"Max\"}}],\"rowLimit\":10000,\"filter\":true,\"hierarchySettings\":{\"treeType\":1,\"groupBy\":[\"MonitorSetName\",\"MonitorName\"],\"expandTopLevel\":false},\"labelSettings\":[{\"columnId\":\"MonitorSetName\",\"label\":\"Monitor Set Name\"},{\"columnId\":\"MonitorName\",\"label\":\"Monitor Name\"},{\"columnId\":\"SystemID\",\"label\":\"System ID\"},{\"columnId\":\"Alerts\",\"label\":\"Alert Count\"},{\"columnId\":\"AlertColor\",\"label\":\"Alert Highest Severity\"},{\"columnId\":\"Performance\",\"label\":\"Performance\"},{\"columnId\":\"PerfColor\",\"label\":\"latest Performance State\"}]},\"sortBy\":[],\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"MonitorName\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"Performance\",\"formatter\":12,\"formatOptions\":{\"palette\":\"greenRed\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":2,\"maximumSignificantDigits\":3}}},\"rightContent\":{\"columnMatch\":\"Alerts\",\"formatter\":12,\"formatOptions\":{\"palette\":\"blue\"},\"tooltipFormat\":{\"tooltip\":\"\\\\{0}\"}},\"secondaryContent\":{\"columnMatch\":\"Text\"},\"showBorder\":false,\"sortCriteriaField\":\"Total\",\"sortOrderField\":2,\"size\":\"auto\"},\"graphSettings\":{\"type\":2,\"topContent\":{\"columnMatch\":\"MonitorSetName\",\"formatter\":1},\"centerContent\":{\"columnMatch\":\"Alerts\",\"formatter\":1,\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}},\"hivesContent\":{\"columnMatch\":\"MonitorSetName\",\"formatter\":1},\"nodeIdField\":\"MonitorName\",\"sourceIdField\":\"MonitorSetName\",\"targetIdField\":\"MonitorName\",\"graphOrientation\":3,\"showOrientationToggles\":false,\"nodeSize\":\"\",\"staticNodeSize\":100,\"colorSettings\":\"\",\"groupByField\":\"MonitorSetName\",\"hivesMargin\":5}},\"name\":\"query - 1\"}]},\"conditionalVisibility\":{\"parameterName\":\"MainTabSelected\",\"comparison\":\"isEqualTo\",\"value\":\"MonitoringTree\"},\"name\":\"MonitoringTreeGroup\"}],\"fromTemplateId\":\"sentinel-SAP-Monitors-AlertsandPerformance\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\",\"fallbackResourceIds\":[]}\n",
                                "version": "1.0",
                                "sourceId": "[variables('workspaceResourceId')]",
                                "category": "sentinel"
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Workbook-', last(split(variables('workbookId2'),'/'))))]",
                            "properties": {
                                "description": "@{workbookKey=SAP-Monitors-AlertsandPerformance; logoFileName=SAPVMIcon.svg; description=SAP -Monitors- Alerts and Performance; dataTypesDependencies=System.Object[]; dataConnectorsDependencies=System.Object[]; previewImagesFileNames=System.Object[]; version=2.0.1; title=SAP -Monitors- Alerts and Performance; templateRelativePath=SAP -Monitors- Alerts and Performance.json; subtitle=; provider=Microsoft}.description",
                                "parentId": "[variables('workbookId2')]",
                                "contentId": "[variables('_workbookContentId2')]",
                                "kind": "Workbook",
                                "version": "[variables('workbookVersion2')]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SAP",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                },
                                "dependencies": {
                                    "operator": "AND",
                                    "criteria": [
                                        {
                                            "contentId": "SAPAuditLog",
                                            "kind": "DataType"
                                        },
                                        {
                                            "contentId": "SAP",
                                            "kind": "DataConnector"
                                        }
                                    ]
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('_workbookContentId2')]",
                "contentKind": "Workbook",
                "displayName": "[parameters('workbook2-name')]",
                "contentProductId": "[variables('_workbookcontentProductId2')]",
                "id": "[variables('_workbookcontentProductId2')]",
                "version": "[variables('workbookVersion2')]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('workbookTemplateSpecName3')]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP -Security Audit log and Initial AccessWorkbook Workbook with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('workbookVersion3')]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.Insights/workbooks",
                            "name": "[variables('workbookContentId3')]",
                            "location": "[parameters('workspace-location')]",
                            "kind": "shared",
                            "apiVersion": "2021-08-01",
                            "metadata": {
                                "description": "SAP -Security Audit log and Initial Access"
                            },
                            "properties": {
                                "displayName": "[parameters('workbook3-name')]",
                                "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"<img src=\\\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/SAP/Workbooks/SAPVMIcon.svg\\\" width=\\\"100\\\"/>  SAP Security Audit log and Initial Access\\n---\\nThis workbook uses the following data sources:\\n* SAP Audit Log\\n* SAP User Master Data\\n* Sentinel Incidents and Alerts\\n* Azure AuditLogs (optional)\\n* Azure SignIn Activity (optional)\\n\\n\\nUse the parameters below to select subscription scope, timerange and relevant SAP systems. Note that this workbook supports a scenario where different workspaces are used for SAP and azure activity and sigin logs.\"},\"name\":\"text - 2\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"9a199167-2dde-49dd-8f01-23e9d1fa8151\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"InternalWSs\",\"type\":1,\"isRequired\":true,\"query\":\"SecurityIncident\\r\\n| take 1\\r\\n| parse IncidentUrl with * \\\"/workspaces/\\\" Workspace \\\"/\\\" *\\r\\n| project Workspace\",\"isHiddenWhenLocked\":true,\"timeContext\":{\"durationMs\":2592000000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"7806fefd-432f-4828-9756-8c0be5c08d07\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"InternalSub\",\"type\":1,\"isRequired\":true,\"query\":\"where type =~ 'microsoft.operationalinsights/workspaces'\\r\\n| where name contains \\\"{InternalWSs}\\\"\\r\\n| take 10\\r\\n| project subscriptionId\",\"crossComponentResources\":[\"value::selected\"],\"isHiddenWhenLocked\":true,\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},{\"id\":\"55d3ab63-6e1f-4d02-8d9e-2225526689c7\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Subscription\",\"label\":\"Subscriptions\",\"type\":6,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"where type =~ 'microsoft.operationalinsights/workspaces'\\r\\n| extend selected= iff(name contains \\\"{InternalWSs}\\\", true, false) \\r\\n| project subscriptionId, selected\\r\\n| summarize selected= max(selected) by subscriptionId\\r\\n\",\"crossComponentResources\":[\"value::all\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::50\"],\"showDefault\":false},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},{\"id\":\"4a62c5aa-0c4c-439a-9977-41cd19a40933\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"SAPWorkspace\",\"label\":\"SAP Workspace\",\"type\":5,\"isRequired\":true,\"isGlobal\":true,\"query\":\"where type =~ 'microsoft.operationalinsights/workspaces'\\r\\n| project value =id, label = name, selected = iff(name =~ '{InternalWSs}', true, false)\\r\\n| order by selected desc\\r\\n\",\"crossComponentResources\":[\"value::all\"],\"typeSettings\":{\"resourceTypeFilter\":{\"microsoft.securityinsightsarg/sentinel\":true,\"microsoft.operationalinsights/workspaces\":true},\"additionalResourceOptions\":[],\"showDefault\":false},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},{\"id\":\"95a45501-31b5-4ea2-bcb3-eb208e0080e2\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"ADWorkspace\",\"label\":\"Azure audit and activity Workspace\",\"type\":5,\"description\":\"Use this selector when the Azure audit and signin logs are on a different workspace than the one SAP is on\",\"isRequired\":true,\"query\":\"//resources | where type =~ 'Microsoft.operationsmanagement/solutions' | where name contains //'SecurityInsights' | project id //= tostring(properties.workspaceResourceId)\\r\\n\\r\\nwhere type =~ 'microsoft.operationalinsights/workspaces'\\r\\n| project value =id, label = name, selected = iff(name =~ '{InternalWSs}', true, false)\\r\\n\\r\\n\\r\\n\",\"crossComponentResources\":[\"{Subscription}\"],\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},{\"id\":\"9b44ff26-1821-49a8-be2e-31f643ebecba\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"DemoMode\",\"type\":10,\"isHiddenWhenLocked\":true,\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"jsonData\":\"[{\\\"value\\\": \\\"true\\\", \\\"label\\\":\\\"Demo Mode\\\"},{\\\"value\\\": \\\"false\\\", \\\"label\\\":\\\"Default Mode\\\", \\\"selected\\\": true}]\"}],\"style\":\"above\",\"doNotRunWhenHidden\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"customWidth\":\"100\",\"name\":\"Select relevant workspaces\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"crossComponentResources\":[\"{SAPWorkspace}\"],\"parameters\":[{\"id\":\"a2f453a3-836c-4e70-8840-45a27f6ac30f\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"type\":4,\"description\":\"Select the time range that will be used for the query's\",\"value\":{\"durationMs\":1209600000},\"typeSettings\":{\"selectableValues\":[{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}]},\"label\":\"Time Range\"},{\"id\":\"4c106c4f-59b7-40bc-a501-cd6d463ba585\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"SystemRoles\",\"label\":\"System Roles\",\"type\":10,\"isRequired\":true,\"isGlobal\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"let EmptySystems= datatable ( SystemID: string, SystemID_s:string , SystemUsage: string, SystemRole: string, Count: long  )['All Systems', 'All Systems', 'All System Usage', 'All System Roles', 1];\\r\\nlet AuditSystems = union isfuzzy= true *ABAPAuditLog_CL, (EmptySystems| project SystemID, SystemID_s) | summarize by SystemID= SystemID_s;\\r\\nAuditSystems\\r\\n| lookup kind=inner (SAPSystems() | union isfuzzy=true EmptySystems) on SystemID\\r\\n| extend ranked= array_sum(to_utf8(SystemRole))\\r\\n| summarize Ranked= any(ranked) by SystemRole\\r\\n| order by Ranked desc\\r\\n| serialize Rank = row_number()\\r\\n| project value= SystemRole, label= strcat('', SystemRole), selected= iff(Rank==1, true, false)\\r\\n\",\"crossComponentResources\":[\"{SAPWorkspace}\"],\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"1a31d436-bb4b-469f-94a8-5ad9aa018edd\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"SystemUsage\",\"label\":\"System Usage\",\"type\":10,\"isRequired\":true,\"isGlobal\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"let EmptySystems= datatable ( SystemID: string, SystemID_s:string , SystemUsage: string, SystemRole: string, Count: long  )['All Systems', 'All Systems', 'All Usage Types', 'All System Roles', 1];\\r\\nlet AuditSystems = union isfuzzy= true *ABAPAuditLog_CL, (EmptySystems| project SystemID, SystemID_s, SystemUsage) | summarize by SystemID= SystemID_s, SystemUsage;\\r\\nAuditSystems\\r\\n| lookup (SAPSystems(SelectedSystemRoles=dynamic(\\\"{SystemRoles}\\\"))) on SystemID\\r\\n| extend SystemUsage= strcat(SystemUsage, SystemUsage1)\\r\\n| extend ranked= array_sum(to_utf8(SystemUsage))\\r\\n| summarize Ranked= any(ranked) by SystemUsage\\r\\n| where isnotempty(SystemUsage)\\r\\n| order by Ranked desc\\r\\n| serialize Rank = row_number()\\r\\n//| where isnotempty(SystemUsage) or SystemID == 'All Systems'\\r\\n| project value= SystemUsage, label= strcat('', SystemUsage), selected= iff(Rank==1, true, false)\\r\\n\\r\\n\",\"crossComponentResources\":[\"{SAPWorkspace}\"],\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"b5ed6d2c-e44f-48ac-a535-af6f2d7ab53d\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Systems\",\"type\":2,\"isRequired\":true,\"isGlobal\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"let EmptySystems= datatable ( SystemID: string, SystemID_s:string , SystemUsage: string, SystemRole: string, Count: long  )['All Systems', 'All Systems', 'All System Usage', 'All System Roles', 1];\\r\\nlet AuditSystems = union isfuzzy= true *ABAPAuditLog_CL, (EmptySystems| project SystemID, SystemID_s, SystemRole) | summarize SystemRole= any(SystemRole) by SystemID= SystemID_s\\r\\n| extend ranked= array_sum(to_utf8(SystemID));\\r\\nAuditSystems\\r\\n| lookup (SAPSystems(SelectedSystemRoles=dynamic(\\\"{SystemRoles}\\\"), SelectedSystemUsage=dynamic(\\\"{SystemUsage}\\\")) ) on SystemID\\r\\n//| extend SystemRole = strcat(SystemRole, SystemRole1)\\r\\n| extend SystemRole = SystemRole1\\r\\n| where isnotempty(SystemRole)\\r\\n| summarize Ranked= any(ranked) by SystemID, SystemRole, SystemUsage\\r\\n| order by Ranked desc\\r\\n| serialize Rank = row_number()\\r\\n//| extend selected = iff(SystemID == 'All Systems', true, false)\\r\\n| project value= SystemID, label= strcat('', iff({DemoMode}, substring(hash_sha1(SystemID), 0, 3), SystemID))\\r\\n//, selected= iff(Rank==1, true, false)\\r\\n//| project value, label, Selected= true\\r\\n\\r\\n\\r\\n\\r\\n\",\"crossComponentResources\":[\"{SAPWorkspace}\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"selectAllValue\":\"All Systems\",\"showDefault\":false},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"defaultValue\":\"value::all\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"54afea69-d0fa-4c19-ba99-fc442a7004ae\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"NormallyFailingUsers\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"let FailedAuitClasses= dynamic([\\\"AU2\\\", \\\"AUL\\\", \\\"AU6\\\", \\\"AUM\\\"]); // \\\"Failed Dialog Logon\\\", \\\"Failed RFC call\\\", \\\"RFC/CPIC logon failed\\\", \\\"User Locked\\\"\\r\\nlet SelectedSystems= SAPSystems(SelectedSystemRoles=dynamic(\\\"{SystemRoles}\\\")\\r\\n, SelectedSystems=todynamic(\\\"[{Systems}]\\\")\\r\\n, SelectedSystemUsage= dynamic(\\\"{SystemUsage}\\\")) | project SystemID;\\r\\n//SelectedSystems\\r\\nSAPAuditLog\\r\\n| where SystemID in(SelectedSystems)\\r\\n| where  MessageID in (FailedAuitClasses)\\r\\n| where isnotempty( User)\\r\\n| make-series FailedCountArray= count() default=0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step 6h by User\\r\\n//, SystemID\\r\\n| extend FailedAnomalies= series_decompose_anomalies(FailedCountArray, Threshold=2, Test_point= 1)\\r\\n| where array_index_of(FailedAnomalies,1)>= 0\\r\\n| summarize  Users2Exclude= make_set(User)\\r\\n\\r\\n\\r\\n\",\"crossComponentResources\":[\"{SAPWorkspace}\"],\"isHiddenWhenLocked\":true,\"typeSettings\":{\"additionalResourceOptions\":[\"value::1\"],\"showDefault\":false},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"defaultValue\":\"value::1\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"4f7c4505-0fb3-409d-bb8a-bdcdc2a91a25\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"MainTabSelected\",\"type\":9,\"isRequired\":true,\"isGlobal\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"value\":[\"Logon Analysis\"],\"isHiddenWhenLocked\":true,\"jsonData\":\"[{ \\\"value\\\": \\\"Logon Analysis\\\",  \\\"selected\\\":true }]\"},{\"id\":\"c5116ed6-b0e1-496e-b9d9-6264a7d4a030\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"AzureSuspiciousUsers\",\"type\":2,\"description\":\"list of suspicious azure audit and login users\",\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"let SuspicousTestUsers= iff({DemoMode}, dynamic(['saptecops@microsoft.com'\\r\\n,'v-nagupta@microsoft.com']), dynamic([]));\\r\\nlet starttime = {TimeRange:start};\\r\\nlet endtime = {TimeRange:end};\\r\\nlet auditLookback = starttime - 14d;\\r\\n// User Granted Access and Grants others Access\\r\\n\\r\\nlet opName = dynamic([\\\"Add user\\\", \\\"Invite external user\\\"]);\\r\\n// Helper function to extract relevant fields from AuditLog events\\r\\nlet auditLogEvents = view (startTimeSpan: timespan, operation: dynamic) {\\r\\n    AuditLogs\\r\\n    | where TimeGenerated >= auditLookback\\r\\n    | where OperationName in~ (operation)\\r\\n    | extend ModProps = iff(TargetResources.[0].modifiedProperties != \\\"[]\\\", TargetResources.[0].modifiedProperties, todynamic(\\\"NoValues\\\"))\\r\\n    | extend IpAddress = iff(isnotempty(tostring(parse_json(tostring(InitiatedBy.user)).ipAddress)), \\r\\n        tostring(parse_json(tostring(InitiatedBy.user)).ipAddress), tostring(parse_json(tostring(InitiatedBy.app)).ipAddress))\\r\\n    | extend InitiatedByFull = iff(isnotempty(tostring(parse_json(tostring(InitiatedBy.user)).userPrincipalName)), \\r\\n        tostring(parse_json(tostring(InitiatedBy.user)).userPrincipalName), tostring(parse_json(tostring(InitiatedBy.app)).displayName))\\r\\n    | extend InitiatedBy = replace(\\\"_\\\", \\\"@\\\", tostring(split(InitiatedByFull, \\\"#\\\")[0]))\\r\\n    | extend TargetUserPrincipalName = tostring(TargetResources[0].userPrincipalName)\\r\\n    | extend TargetUserName = replace(\\\"_\\\", \\\"@\\\", tostring(split(TargetUserPrincipalName, \\\"#\\\")[0]))\\r\\n    | extend TargetResourceName = case(\\r\\n        isempty(tostring(TargetResources.[0].displayName)), TargetUserPrincipalName,\\r\\n        isnotempty(tostring(TargetResources.[0].displayName)) and tostring(TargetResources.[0].displayName) startswith \\\"upn:\\\", tolower(tostring(TargetResources.[0].displayName)),\\r\\n        tolower(tostring(TargetResources.[0].displayName))\\r\\n        )\\r\\n    | extend TargetUserName = replace(\\\"_\\\", \\\"@\\\", tostring(split(TargetUserPrincipalName, \\\"#\\\")[0]))\\r\\n    | extend TargetUserName = iff(isempty(TargetUserName), tostring(split(split(TargetResourceName, \\\",\\\")[0], \\\" \\\")[1]), TargetUserName) \\r\\n    | mvexpand ModProps\\r\\n    | extend\\r\\n        PropertyName = tostring(ModProps.displayName),\\r\\n        newValue = replace('\\\\\\\"', '', tostring(ModProps.newValue));\\r\\n};\\r\\n// Assigning time for First TargetUserName that was added\\r\\nlet FirstAdd = auditLogEvents(auditLookback, opName)  \\r\\n    | project FirstAddTimeUtc = TimeGenerated, Type, FirstInitiatedBy = InitiatedBy, IpAddress, FirstTargetUserName = TargetUserName, FirstTargetResourceName = TargetResourceName, \\r\\n        FirstOperationName = OperationName, FirstPropertyName = PropertyName, FirstnewValue = newValue, FirstCorrelationId = CorrelationId, FirstId = Id;\\r\\n// Assigning time for second TargetUserName that was added, which will allow us to see if a first TargetUserName added in is the Initiated by on the second in the later join\\r\\nlet SecondAdd = auditLogEvents(auditLookback, opName)  \\r\\n    | project SecondAddTimeUtc = TimeGenerated, Type, SecondInitiatedBy = InitiatedBy, IpAddress, SecondTargetUserName = TargetUserName, SecondTargetResourceName = TargetResourceName, \\r\\n        SecondOperationName = OperationName, SecondPropertyName = PropertyName, SecondnewValue = newValue, SecondCorrelationId = CorrelationId, SecondId = Id;\\r\\n//  Joining the FirstAdd with SecondAdd where the FirstAdd TargetUserName value matches the SecondAdd InitiatedBy.  This shows the new user adding a user.\\r\\nlet NewUserAddsUser = FirstAdd\\r\\n    | join SecondAdd on $left.FirstTargetUserName == $right.SecondInitiatedBy\\r\\n    // we only want items where the FirstAddTimeUtc is before the SecondAddTimeUtc\\r\\n    | where FirstAddTimeUtc < SecondAddTimeUtc\\r\\n;\\r\\n// Build out some of the properties for context\\r\\nlet UserGrantedGrants=(NewUserAddsUser\\r\\n| extend\\r\\n    FirstnewValue = split(FirstnewValue, \\\";\\\"),\\r\\n    SecondnewValue = split(SecondnewValue, \\\";\\\")\\r\\n| extend PropertyUpdate = pack(FirstPropertyName, FirstnewValue, SecondPropertyName, SecondnewValue, \\\"FirstCorrelationId\\\", FirstCorrelationId, \\\"FirstId\\\", FirstId, \\\"SecondCorrelationId\\\", SecondCorrelationId, \\\"SecondId\\\", SecondId)\\r\\n| summarize PropertyUpdateSet = make_bag(PropertyUpdate)\\r\\n    by FirstAddTimeUtc, FirstInitiatedBy, FirstTargetUserName, SecondAddTimeUtc, SecondInitiatedBy, SecondTargetUserName, \\r\\n    IpAddress, FirstTargetResourceName, SecondTargetResourceName, FirstOperationName, SecondOperationName\\r\\n| extend\\r\\n    timestamp = FirstAddTimeUtc,\\r\\n    AccountCustomEntity = FirstInitiatedBy,\\r\\n    HostCustomEntity = FirstTargetResourceName,\\r\\n    IPCustomEntity = IpAddress\\r\\n    | extend UserPrincipalName= SecondTargetUserName)\\r\\n    | extend Risk= 'User Granted Access and Grants others Access';\\r\\n\\r\\n// Anomalous sign-in location by user account and authenticating application - with sign-in details\\r\\nlet AnomalSiginLocAuth= (SigninLogs \\r\\n| where TimeGenerated  > starttime\\r\\n| extend  locationString= strcat(tostring(LocationDetails[\\\"countryOrRegion\\\"]), \\\"/\\\", \\r\\ntostring(LocationDetails[\\\"state\\\"]), \\\"/\\\", tostring(LocationDetails[\\\"city\\\"]), \\\";\\\") \\r\\n| project TimeGenerated, AppDisplayName , UserPrincipalName, locationString \\r\\n// Create time series \\r\\n| make-series dLocationCount = dcount(locationString) on TimeGenerated step 1d \\r\\nby UserPrincipalName, AppDisplayName \\r\\n// Compute best fit line for each entry \\r\\n| extend (RSquare,Slope,Variance,RVariance,Interception,LineFit)=series_fit_line(dLocationCount) \\r\\n// Chart the 3 most interesting lines  \\r\\n// A 0-value slope corresponds to an account being completely stable over time for a given Azure Active Directory application\\r\\n| top 3 by Slope desc  \\r\\n// Extract the set of locations for each top user:\\r\\n| join kind=inner (SigninLogs\\r\\n| extend  locationString= strcat(tostring(LocationDetails[\\\"countryOrRegion\\\"]), \\\"/\\\", \\r\\ntostring(LocationDetails[\\\"state\\\"]), \\\"/\\\", tostring(LocationDetails[\\\"city\\\"]), \\\";\\\")\\r\\n| summarize locationList = makeset(locationString), threeDayWindowLocationCount=dcount(locationString) by AppDisplayName, UserPrincipalName, \\r\\ntimerange=bin(TimeGenerated, 3d)) on AppDisplayName, UserPrincipalName\\r\\n| order by UserPrincipalName, timerange asc\\r\\n| project timerange, AppDisplayName , UserPrincipalName, threeDayWindowLocationCount, locationList \\r\\n| order by AppDisplayName, UserPrincipalName, timerange asc\\r\\n| extend timestamp = timerange, AccountCustomEntity = UserPrincipalName)\\r\\n| extend Risk= 'Anomalous sign-in location by user account and authenticating application';\\r\\n\\r\\n\\r\\n// Failed service logon attempt by user account with available AuditData\\r\\nlet failLimit = 10;\\r\\nlet ipLimit = 3;\\r\\nlet failedSignins = SigninLogs\\r\\n| where TimeGenerated between(starttime..endtime)\\r\\n| where ResultType != \\\"0\\\" and AppDisplayName != \\\"Windows Sign In\\\"\\r\\n| extend UserPrincipalName = tolower(UserPrincipalName)\\r\\n| extend CityState = strcat(tostring(LocationDetails.city),\\\"|\\\", tostring(LocationDetails.state))\\r\\n| extend Result = strcat(ResultType,\\\"-\\\",ResultDescription)\\r\\n| summarize StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated), DistinctIPAddressCount = dcount(IPAddress), IPAddresses = makeset(IPAddress),\\r\\nCityStates = makeset(CityState), DistinctResultCount = dcount(Result), Results = makeset(Result), AppDisplayNames = makeset(AppDisplayName),\\r\\nFailedLogonCount = count() by Type, OperationName, Category, UserPrincipalName = tolower(UserPrincipalName), ClientAppUsed, Location, CorrelationId\\r\\n| project Type, StartTimeUtc, EndTimeUtc, OperationName, Category, UserPrincipalName, AppDisplayNames, DistinctIPAddressCount, IPAddresses, DistinctResultCount,\\r\\nResults, FailedLogonCount, Location, CityStates\\r\\n| where FailedLogonCount >= failLimit or DistinctIPAddressCount >= ipLimit\\r\\n| extend Activity = pack(\\\"IPAddresses\\\", IPAddresses, \\\"AppDisplayNames\\\", AppDisplayNames, \\\"Results\\\", Results, \\\"Location\\\", Location, \\\"CityStates\\\", CityStates)\\r\\n| project Type, StartTimeUtc, EndTimeUtc, OperationName, Category, UserPrincipalName, FailedLogonCount, DistinctIPAddressCount, DistinctResultCount, Activity\\r\\n| extend AccountCustomEntity = UserPrincipalName;\\r\\nlet accountMods = AuditLogs | where TimeGenerated >= auditLookback\\r\\n| where Category == \\\"UserManagement\\\" or Category == \\\"GroupManagement\\\"\\r\\n| extend ModProps = TargetResources.[0].modifiedProperties\\r\\n| extend InitiatedBy = case(\\r\\nisnotempty(tostring(parse_json(tostring(InitiatedBy.user)).userPrincipalName)), tostring(parse_json(tostring(InitiatedBy.user)).userPrincipalName),\\r\\nisnotempty(tostring(parse_json(tostring(InitiatedBy.app)).displayName)), tostring(parse_json(tostring(InitiatedBy.app)).displayName),\\r\\n\\\"\\\")\\r\\n| extend UserPrincipalName = tolower(tostring(TargetResources.[0].userPrincipalName))\\r\\n| mvexpand ModProps\\r\\n| extend PropertyName = tostring(ModProps.displayName), oldValue = tostring(ModProps.oldValue), newValue = tostring(ModProps.newValue)\\r\\n| extend ModifiedProps = pack(\\\"PropertyName\\\",PropertyName,\\\"oldValue\\\",oldValue,\\\"newValue\\\",newValue)\\r\\n| summarize StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated), Activity = make_bag(ModifiedProps) by Type, InitiatedBy, UserPrincipalName, Category, OperationName, CorrelationId, Id\\r\\n| extend AccountCustomEntity = UserPrincipalName;\\r\\n// Gather only Audit data for UserPrincipalNames that we have Audit data for\\r\\nlet accountNameOnly = failedSignins | project UserPrincipalName;\\r\\nlet auditMods = accountNameOnly\\r\\n| join kind= innerunique (\\r\\naccountMods\\r\\n) on UserPrincipalName;\\r\\nlet availableAudits = auditMods | project UserPrincipalName;\\r\\nlet signinsWithAudit = availableAudits\\r\\n| join kind= innerunique (\\r\\nfailedSignins\\r\\n) on UserPrincipalName;\\r\\n// Union the Current Signin failures so we do not lose them with the Auditing data we do have\\r\\nlet activity = (union isfuzzy=true\\r\\nsigninsWithAudit, auditMods)\\r\\n| order by StartTimeUtc, UserPrincipalName;\\r\\n\\r\\nlet FailedServiceLogon= (activity\\r\\n| project StartTimeUtc, EndTimeUtc, DataType = Type, Category, OperationName, UserPrincipalName, InitiatedBy, Activity, FailedLogonCount, DistinctIPAddressCount, DistinctResultCount, CorrelationId, Id\\r\\n| order by UserPrincipalName, StartTimeUtc\\r\\n| extend timestamp = StartTimeUtc, AccountCustomEntity = UserPrincipalName)\\r\\n| extend Risk= 'Failed service logon attempt by user account with available AuditData';\\r\\n\\r\\nUserGrantedGrants | union AnomalSiginLocAuth, FailedServiceLogon\\r\\n| summarize UserPrincipalNames= makeset(UserPrincipalName, 500), FirstInitiatedBys= makeset(FirstInitiatedBy, 500), FirstTargetUserNames= makeset(FirstTargetUserName, 500), SecondInitiatedBys= makeset(SecondInitiatedBy, 500), SecondTargetUserNames= makeset(SecondTargetUserName, 500)\\r\\n| project SuspiciousUsers= set_union(UserPrincipalNames, FirstInitiatedBys, FirstTargetUserNames, SecondInitiatedBys, SecondTargetUserNames, SuspicousTestUsers)\\r\\n\",\"crossComponentResources\":[\"{ADWorkspace}\"],\"isHiddenWhenLocked\":true,\"typeSettings\":{\"additionalResourceOptions\":[\"value::1\"],\"showDefault\":false},\"defaultValue\":\"value::1\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"}],\"style\":\"above\",\"doNotRunWhenHidden\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - Copy\"},{\"type\":1,\"content\":{\"json\":\"You are currently running in demo mode. System IDs and fields containing personally identifiable information are anonymized.\",\"style\":\"upsell\"},\"conditionalVisibility\":{\"parameterName\":\"DemoMode\",\"comparison\":\"isNotEqualTo\",\"value\":\"false\"},\"name\":\"text - 10\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SAPSystems(SelectedSystemRoles=dynamic(\\\"{SystemRoles}\\\")\\r\\n, SelectedSystems=todynamic(\\\"[{Systems}]\\\")\\r\\n, SelectedSystemUsage= dynamic(\\\"{SystemUsage}\\\")) \\r\\n| project SystemID\\r\\n| extend SystemID= iff({DemoMode}, substring(hash_sha1(SystemID), 0, 3), SystemID)\\r\\n| summarize Systems= makeset(SystemID,50)\\r\\n| project text= strcat(\\\"\\\", \\\"Selected SAP Systems: \\\", translate('\\\"[]', ' ', tostring(Systems)))\\r\\n\",\"size\":4,\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"card\",\"textSettings\":{\"style\":\"markdown\"}},\"conditionalVisibility\":{\"parameterName\":\"Systems\",\"comparison\":\"isNotEqualTo\",\"value\":\"'All Systems'\"},\"name\":\"query - 10\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let SystemsConfiguration= (SAPAuditLog| summarize Count= count() by SystemID) | lookup SAPSystems() on SystemID\\r\\n| extend SystemID= iff({DemoMode}, substring(hash_sha1(SystemID), 0, 3), SystemID);\\r\\nSystemsConfiguration\\r\\n| where isempty(SystemRole) or isempty( SystemUsage)\\r\\n| summarize Systems= make_set(SystemID, 50), EventsMissed= sum(Count)\\r\\n| where  array_length( Systems)> 0\\r\\n| extend Description1 = strcat('',  \\\"**The following SAP \\\",iff(array_length( Systems)> 1, \\\"Systems are not\\\", \\\"System is not\\\"),\\\" condigured properly in sentinel: \\\", iff(array_length( Systems)> 1,Systems, Systems[0]),\\\".** <br>\\\")\\r\\n| extend Description2 = strcat(\\\"Please update the 'SAP - Systems' watchlist to include these systems and ensure proper security coverage\\\",\\\". <br>\\\")\\r\\n| extend Description3 = strcat(\\\"Number of events not covered is \\\", EventsMissed,\\\".\\\")\\r\\n| project strcat(Description1, Description2, Description3)\\r\\n\\r\\n\\r\\n\\r\\n\\r\\n\",\"size\":4,\"noDataMessage\":\"All SAP Systems are Configured Properly in Sentinel\",\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"card\",\"textSettings\":{\"style\":\"markdown\"}},\"name\":\"ConfigChecker\"},{\"type\":11,\"content\":{\"version\":\"LinkItem/1.0\",\"style\":\"tabs\",\"tabStyle\":\"bigger\",\"links\":[{\"id\":\"3a13be26-b92f-43fb-ac8b-593fadff36e6\",\"cellValue\":\"MainTabSelected\",\"linkTarget\":\"parameter\",\"linkLabel\":\" Logon analysis report\",\"subTarget\":\"Logon Analysis\",\"preText\":\"Logon analysis\",\"style\":\"link\",\"icon\":\"Sev2\",\"tabWidth\":\"200\"},{\"id\":\"a997c6cd-4d82-4fd5-b128-a16fbfd0e421\",\"cellValue\":\"MainTabSelected\",\"linkTarget\":\"parameter\",\"linkLabel\":\" Audit log alerts  report\",\"subTarget\":\"Audit Log Alerts\",\"preText\":\"Audit log alerts\",\"style\":\"link\",\"icon\":\"Sev2\"}]},\"customWidth\":\"100\",\"name\":\"tabs main\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"----\\n## Logon Analysis\\n\\nLogon activities of the SAP landscape\"},\"name\":\"text - 10\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let SelectedSystems= SAPSystems(SelectedSystemRoles=dynamic(\\\"{SystemRoles}\\\")\\r\\n, SelectedSystems=todynamic(\\\"[{Systems}]\\\")\\r\\n, SelectedSystemUsage= dynamic(\\\"{SystemUsage}\\\")) | project SystemID;\\r\\n//SelectedSystems\\r\\nSAPAuditLog\\r\\n| where SystemID in(SelectedSystems)\\r\\n| where MessageClass contains_cs \\\"Logon\\\"\\r\\n| summarize UniqueUsers= dcount(User) by SystemID\\r\\n//| order by UniqueUsers desc\\r\\n| top-nested 18 of SystemID with others=\\\"Other Systems\\\" by UniqueUsers= sum(UniqueUsers)\\r\\n| join (SAPAuditLog\\r\\n| where SystemID in(SelectedSystems)\\r\\n| where MessageClass contains_cs \\\"Logon\\\"\\r\\n| make-series TrendList = dcount(User) on TimeGenerated in range({TimeRange:start}, {TimeRange:end}, 4h) by SystemID \\r\\n) on SystemID\\r\\n| extend SystemID= iff({DemoMode}, substring(hash_sha1(SystemID), 0, 3), SystemID)\\r\\n| extend Systemlabel= strcat('', SystemID)\\r\\n\\r\\n\\r\\n\",\"size\":1,\"title\":\"Unique User Logons Per System\",\"timeContextFromParameter\":\"TimeRange\",\"showRefreshButton\":true,\"exportFieldName\":\"series\",\"exportParameterName\":\"Systems\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"Systemlabel\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"UniqueUsers\",\"formatter\":12,\"formatOptions\":{\"palette\":\"blue\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":2,\"maximumSignificantDigits\":3}}},\"secondaryContent\":{\"columnMatch\":\"TrendList\",\"formatter\":9,\"formatOptions\":{\"palette\":\"blue\"}},\"showBorder\":false,\"sortCriteriaField\":\"UniqueUsers\",\"size\":\"auto\"},\"graphSettings\":{\"type\":0,\"topContent\":{\"columnMatch\":\"SearchKey\",\"formatter\":1},\"centerContent\":{\"columnMatch\":\"DummyJoinField\",\"formatter\":1,\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}},\"chartSettings\":{\"xAxis\":\"SystemID\",\"yAxis\":[\"UniqueUsers\"],\"group\":\"SystemID\",\"createOtherGroup\":10,\"ySettings\":{\"numberFormatSettings\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"useGrouping\":true}}}}},\"name\":\"UniqueUsers\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let SelectedSystems= SAPSystems(SelectedSystemRoles=dynamic(\\\"{SystemRoles}\\\")\\n, SelectedSystems=todynamic(\\\"[{Systems}]\\\")\\n, SelectedSystemUsage= dynamic(\\\"{SystemUsage}\\\")) | project SystemID;\\n//SelectedSystems\\nSAPAuditLog\\n| where SystemID in(SelectedSystems)\\n| where MessageClass contains_cs \\\"Logon\\\"\\n| summarize Count= count() by MessageClass, User, TimeGenerated= bin(TimeGenerated, 4h)\\n| summarize UniqueUsers= dcount(User), Count= sum(Count) by MessageClass, TimeGenerated\\n\",\"size\":1,\"aggregation\":3,\"showAnalytics\":true,\"title\":\"Login types trend\",\"timeContextFromParameter\":\"TimeRange\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{SAPWorkspace}\"],\"visualization\":\"areachart\",\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"ResultText\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"dcount_CorrelationId\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}},\"chartSettings\":{\"xAxis\":\"TimeGenerated\",\"yAxis\":[\"UniqueUsers\"],\"group\":\"MessageClass\",\"createOtherGroup\":\"\",\"showLegend\":true}},\"customWidth\":\"50\",\"name\":\"query - 4\",\"styleSettings\":{\"maxWidth\":\"100%\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let SuccessAuitClasses= dynamic([\\\"AU1\\\", \\\"AUK\\\", \\\"AU5\\\"]); // \\\"User logged on\\\", \\\"Successful RFC\\\", \\\"RFC/CPIC logon\\\"\\nlet FailedAuitClasses= dynamic([\\\"AU2\\\", \\\"AUL\\\", \\\"AU6\\\", \\\"AUM\\\"]); // \\\"Failed Dialog Logon\\\", \\\"Failed RFC call\\\", \\\"RFC/CPIC logon failed\\\", \\\"User Locked\\\"\\nlet SelectedSystems= SAPSystems(SelectedSystemRoles=dynamic(\\\"{SystemRoles}\\\")\\n, SelectedSystems=todynamic(\\\"[{Systems}]\\\")\\n, SelectedSystemUsage= dynamic(\\\"{SystemUsage}\\\")) | project SystemID;\\n//SelectedSystems\\nSAPAuditLog\\n| where SystemID in(SelectedSystems)\\n| where  MessageID in (array_concat(SuccessAuitClasses, FailedAuitClasses))\\n| summarize Count= count() by MessageID, User, TimeGenerated= bin(TimeGenerated, 4h)\\n| extend Status= iff( SuccessAuitClasses has MessageID, \\\"Success\\\", \\\"Failure\\\")\\n| summarize UniqueUsers= dcount(User), Count= sum(Count) by Status, TimeGenerated\\n| order by Status asc\",\"size\":1,\"aggregation\":3,\"showAnalytics\":true,\"title\":\"Logon failures Vs. success by unique users- trend\",\"timeContextFromParameter\":\"TimeRange\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{SAPWorkspace}\"],\"visualization\":\"areachart\",\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"ResultText\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"dcount_CorrelationId\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}},\"chartSettings\":{\"xAxis\":\"TimeGenerated\",\"yAxis\":[\"UniqueUsers\"],\"group\":\"Status\",\"createOtherGroup\":2,\"showLegend\":true}},\"customWidth\":\"50\",\"name\":\"Failure Trends\",\"styleSettings\":{\"maxWidth\":\"100%\"}}]},\"name\":\"Logon Analysis Buttom\"}],\"exportParameters\":true},\"conditionalVisibility\":{\"parameterName\":\"MainTabSelected\",\"comparison\":\"isEqualTo\",\"value\":\"'Logon Analysis'\"},\"name\":\"Group Signin Logs\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"expandable\":true,\"expanded\":true,\"items\":[{\"type\":1,\"content\":{\"json\":\"----\\n## Logon Failures\\n\\nAn overview of failed logon attempts. \\n\\n### Anomaly detection- filtering out noisy failed logon attempts\\nWe use anomaly detection methods to determine which users fail to logon frequently, e.g., failures related to a scheduled job running with out-of-date user credentials.\\n\\nYou have the option to restrict out repeated failures, by selecting the \\\"Anomalous only\\\" option, allowing you to focus on those out of the ordinary failed logon attempts.\\n\\n### Logon failure rate\\nDefined as the proportion of unique users that failed to logon out of the entire logon population (failed + succeeded).\\nIn this section, you get a look into the logon failure rate per SAP system. \\n\\nSelecting a system will detail all relevant failed logon attempts, respecting the selection made using the \\\"Failed logons\\\" crieria (\\\"All\\\" or \\\"Anomalous only\\\" ).\"},\"customWidth\":\"50\",\"name\":\"text - 10\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"e98b7063-b2c7-443b-9613-6364fbded3c7\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"FailedLogons\",\"label\":\"Failed logons\",\"type\":10,\"isRequired\":true,\"isGlobal\":true,\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"jsonData\":\"[{ \\\"value\\\": [\\\"Anomalous logon failures\\\", \\\"Frequent logon failures\\\"], \\\"label\\\": \\\"All\\\" , \\\"selected\\\":true }, { \\\"value\\\": \\\"Anomalous logon failures\\\", \\\"label\\\": \\\"Anomalous only\\\"}]\",\"timeContext\":{\"durationMs\":86400000}}],\"style\":\"formHorizontal\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"customWidth\":\"35\",\"name\":\"parameters - Anomaly failed logons\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Logon failure anomalies\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let FailedAuitClasses= dynamic([\\\"AU2\\\", \\\"AUL\\\", \\\"AU6\\\", \\\"AUM\\\"]);\\r\\nlet SelectedSystems= SAPSystems(SelectedSystemRoles=dynamic(\\\"{SystemRoles}\\\")\\r\\n, SelectedSystems=todynamic(\\\"[{Systems}]\\\")\\r\\n, SelectedSystemUsage= dynamic(\\\"{SystemUsage}\\\")) | project SystemID;\\r\\n//SelectedSystems\\r\\nSAPAuditLog\\r\\n| where SystemID in(SelectedSystems)\\r\\n| where MessageID in (FailedAuitClasses)\\r\\n| summarize UniqueUsers= dcount(User) by SystemID\\r\\n//| order by UniqueUsers desc\\r\\n| top-nested 18 of SystemID with others=\\\"Other Systems\\\" by UniqueUsers= sum(UniqueUsers)\\r\\n| join (SAPAuditLog\\r\\n| where SystemID in(SelectedSystems)\\r\\n| where MessageID in (FailedAuitClasses)\\r\\n| make-series FailedCountArray = dcount(User) on TimeGenerated in range({TimeRange:start}, {TimeRange:end}, 4h) by SystemID \\r\\n| extend FailedAnomalies= series_decompose_anomalies(FailedCountArray, Threshold=2, Test_point= 1)\\r\\n| extend FailedAnomaly= array_index_of(FailedAnomalies,1)>= 0\\r\\n| extend Anomaly = iff(FailedAnomaly, 'Anomalous logon failures', 'Frequent logon failures')\\r\\n| where  (\\\"{FailedLogons}\\\") contains Anomaly\\r\\n) on SystemID\\r\\n| extend SystemID= iff({DemoMode}, substring(hash_sha1(SystemID), 0, 3), SystemID)\\r\\n| extend Systemlabel= strcat('', SystemID)\\r\\n\\r\\n\\r\\n\\r\\n\\r\\n\\r\\n\\r\\n\",\"size\":1,\"title\":\"Unique User failed logons per SAP system\",\"showRefreshButton\":true,\"exportFieldName\":\"series\",\"exportParameterName\":\"Systems\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{SAPWorkspace}\"],\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"Systemlabel\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"UniqueUsers\",\"formatter\":12,\"formatOptions\":{\"palette\":\"greenRed\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":2,\"maximumSignificantDigits\":3}}},\"secondaryContent\":{\"columnMatch\":\"FailedCountArray\",\"formatter\":9,\"formatOptions\":{\"palette\":\"greenRed\"},\"numberFormat\":{\"unit\":0,\"options\":{\"style\":\"decimal\"},\"missingSparkDataOption\":\"Average\"}},\"showBorder\":false,\"sortCriteriaField\":\"UniqueUsers\",\"size\":\"auto\"},\"graphSettings\":{\"type\":0,\"topContent\":{\"columnMatch\":\"SearchKey\",\"formatter\":1},\"centerContent\":{\"columnMatch\":\"DummyJoinField\",\"formatter\":1,\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}},\"chartSettings\":{\"xAxis\":\"SystemID\",\"yAxis\":[\"UniqueUsers\"],\"group\":\"SystemID\",\"createOtherGroup\":10,\"ySettings\":{\"numberFormatSettings\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"useGrouping\":true}}}}},\"name\":\"UniqueUsers - Failed\"},{\"type\":1,\"content\":{\"json\":\"\\r\\n<svg width=\\\"69.018px\\\" height=\\\"69.018px\\\" viewBox=\\\"-1.63 0 69.018 69.018\\\" xmlns=\\\"http://www.w3.org/2000/svg\\\">\\r\\n\\r\\n    <path d=\\\"m 307.17101,380.86847 -33.37955,40.03036 33.37955,28.9875 32.37565,-29.11299 -32.37565,-39.90487 z m -0.62744,18.00739 c 2.73032,0 4.95674,2.22642 4.95674,4.95673 0,1.21954 -0.46013,2.33784 -1.19213,3.19992 l 7.34099,8.53312 c 0.82348,-0.61334 1.84323,-0.94115 2.94895,-0.94115 2.73031,0 4.95673,2.22642 4.95673,4.95673 0,2.73032 -2.22642,4.894 -4.95673,4.894 -1.60917,0 -2.98736,-0.75469 -3.8901,-1.94505 l -5.7724,5.08222 c 0.3421,0.67225 0.56469,1.39006 0.56469,2.19603 0,2.73031 -2.22642,4.95673 -4.95674,4.95673 -2.73032,0 -4.95674,-2.22642 -4.95674,-4.95673 0,-1.10578 0.3905,-2.12545 1.0039,-2.94895 l -4.3293,-3.95284 c -0.90291,0.97384 -2.20639,1.56859 -3.63913,1.56859 -2.73031,0 -4.95673,-2.16368 -4.95673,-4.894 0,-2.73031 2.22642,-4.95673 4.95673,-4.95673 0.61433,0 1.21416,0.10902 1.75682,0.31371 l 6.39984,-7.90568 c -0.732,-0.86208 -1.19213,-1.98038 -1.19213,-3.19992 0,-2.73031 2.22642,-4.95673 4.95674,-4.95673 z m -2.38425,9.28604 -6.21161,7.78019 c 0.98663,0.90381 1.63133,2.19564 1.63133,3.63912 0,0.68259 -0.12629,1.29085 -0.37646,1.88231 l 4.58028,4.26656 c 0.78902,-0.53305 1.73684,-0.87841 2.76071,-0.87841 1.39702,0 2.67729,0.57417 3.57638,1.50584 l 5.83515,-5.20771 c -0.17548,-0.50687 -0.25098,-1.00205 -0.25098,-1.56859 0,-0.9751 0.26557,-1.93201 0.75292,-2.69797 l -7.59196,-8.72134 c -0.69492,0.37264 -1.47782,0.62743 -2.32151,0.62743 -0.86275,0 -1.67827,-0.23897 -2.38425,-0.62743 z\\\" fill=\\\"#00bcf2\\\" transform=\\\"translate(-273.791 -380.868)\\\"/>\\r\\n\\r\\n</svg>\\r\\n\\r\\n### SAP and Active Directory are better together\\r\\nThe following analysis puts together SAP audit alerts with active directory risk indicators.\\r\\nClick on a user below to search for related Sentinel incidetns and Active directory and sigin logs related indications.\\r\\n\\r\\nIf you have the active directory data reside a different log analytics from the one used for the SAP data- make sure you **select the relevant subscriptions and workspaces** using the parameters at the top of this workbook.\\r\\n\\r\\n#### Anomalous logon failures\\r\\nFailed logons are given with anomaly indicators. Azure active directoty indications are marked with . Select a line to search for related Sentinel security incidents and active directory risk report (where available.) \\r\\n\\r\\n\"},\"name\":\"text - 4\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let FailedAuitClasses= dynamic([\\\"AU2\\\", \\\"AUL\\\", \\\"AU6\\\", \\\"AUM\\\"]); // \\\"Failed Dialog Logon\\\", \\\"Failed RFC call\\\", \\\"RFC/CPIC logon failed\\\", \\\"User Locked\\\"\\r\\nlet UsersEmail= SAPUsersEmail\\r\\n| summarize Email= make_set_if(Email,  Email contains_cs \\\"@\\\", 10)[0] by User;\\r\\nlet UsersEventCount= (SecurityAlert\\r\\n    | summarize hint.strategy = shuffle arg_max(TimeGenerated, Entities), NumberOfUpdates = count() by SystemAlertId\\r\\n    | mv-expand todynamic(Entities)\\r\\n    | where Entities[\\\"Type\\\"] =~ \\\"account\\\"\\r\\n    | where isnotempty( Entities[\\\"Name\\\"]) and isnotempty( Entities[\\\"UPNSuffix\\\"])\\r\\n    | project UserPrincipalName = strcat(tolower(Entities[\\\"Name\\\"]), \\\"@\\\", tolower(Entities[\\\"UPNSuffix\\\"])), AlertID= SystemAlertId\\r\\n    | join kind=inner (SecurityIncident | mv-expand AlertID= AlertIds to typeof(string ) | project AlertID, IncidentName) on AlertID\\r\\n| summarize IncidentCount= dcount(IncidentName, 2) , AlertCount= dcount(AlertID, 2) by Email= UserPrincipalName);\\r\\nlet NormallyFailingUsers= todynamic(\\\"\\\"{NormallyFailingUsers}\\\"\\\");\\r\\nlet RiskyADUsers= todynamic(\\\"\\\"{AzureSuspiciousUsers}\\\"\\\");\\r\\nlet SelectedSystems= SAPSystems(SelectedSystemRoles=dynamic(\\\"{SystemRoles}\\\")\\r\\n, SelectedSystems=todynamic(\\\"[{Systems}]\\\")\\r\\n, SelectedSystemUsage= dynamic(\\\"{SystemUsage}\\\")) | project SystemID;\\r\\nSAPAuditLog\\r\\n| where SystemID in(SelectedSystems)\\r\\n| where  MessageID in (FailedAuitClasses)\\r\\n| where isnotempty( User)\\r\\n| make-series FailedCountArray= count() default=0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step 6h by User\\r\\n| extend FailedAnomalies= series_decompose_anomalies(FailedCountArray, Threshold=2, Test_point= 1)\\r\\n| extend FailedAnomaly= array_index_of(FailedAnomalies,1)>= 0\\r\\n| extend Anomaly = iff(FailedAnomaly, 'Anomalous logon failures', 'Frequent logon failures')\\r\\n| where  (\\\"{FailedLogons}\\\") contains Anomaly\\r\\n| project User\\r\\n, FailedCountArray, FailedAnomalies, TimeGenerated, Anomaly\\r\\n| extend AnomalousFailedLogon = iff(User in(NormallyFailingUsers), 'Anomalous logon failures', 'Frequent logon failures')\\r\\n| lookup UsersEmail on User\\r\\n//| extend Email = iff(isempty(Email), User, Email)\\r\\n| extend Email = iff(isempty(Email), iff({DemoMode}, 'pdemo@seccxpninja.onmicrosoft.com', User), tolower(Email))\\r\\n| extend RiskyADUser = iff(Email in(RiskyADUsers), 'High risk AD user', '')\\r\\n| extend UserAnom= iff({DemoMode}, substring(hash_sha1(User), 0, 12), User)\\r\\n| extend EmailAnom= iff({DemoMode}, strcat(substring(hash_sha1(User), 0, 12), '@seccxpninja.onmicrosoft.com' ), Email)\\r\\n| project User, UserAnom, FailedCountArray, FailedAnomalies, Anomaly, EmailAnom, Email, RiskyADUser\\r\\n| lookup UsersEventCount on Email\\r\\n| order by RiskyADUser desc, IncidentCount desc, User asc\\r\\n\",\"size\":0,\"showAnalytics\":true,\"title\":\"Anomalous logon failures- select a line to search for related events\",\"timeContextFromParameter\":\"TimeRange\",\"showRefreshButton\":true,\"exportedParameters\":[{\"fieldName\":\"Email\",\"parameterName\":\"EntityToCheck\",\"defaultValue\":\" \"},{\"fieldName\":\"EmailAnom\",\"parameterName\":\"AnomEntityToCheck\",\"parameterType\":1,\"defaultValue\":\" \"}],\"showExportToExcel\":true,\"exportToExcelOptions\":\"all\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{SAPWorkspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"User\",\"formatter\":5},{\"columnMatch\":\"UserAnom\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"Default\",\"thresholdValue\":\"\",\"representation\":\"Person\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"FailedCountArray\",\"formatter\":9,\"formatOptions\":{\"min\":0,\"max\":200,\"palette\":\"greenRed\",\"compositeBarSettings\":{\"labelText\":\"\",\"columnSettings\":[]}},\"tooltipFormat\":{\"tooltip\":\"{0}\"}},{\"columnMatch\":\"FailedAnomalies\",\"formatter\":10,\"formatOptions\":{\"min\":0,\"max\":1,\"palette\":\"greenRed\"},\"tooltipFormat\":{\"tooltip\":\"{0}\"}},{\"columnMatch\":\"Anomaly\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"Anomalous logon failures\",\"representation\":\"2\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Frequent logon failures\",\"representation\":\"Noisy\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":\"\",\"representation\":\"more\",\"text\":\"{0}{1}\"}],\"customColumnWidthSetting\":\"28ch\"}},{\"columnMatch\":\"EmailAnom\",\"formatter\":1,\"formatOptions\":{\"workbookContext\":{\"componentIdSource\":\"workbook\",\"resourceIdsSource\":\"default\",\"templateIdSource\":\"static\",\"templateId\":\"/providers/Microsoft.Insights/workbooks/c4862201-6476-4ffa-909d-791c7d159b54\",\"typeSource\":\"static\",\"type\":\"sentinel\",\"gallerySource\":\"static\",\"gallery\":\"Sentinel\",\"locationSource\":\"default\"},\"bladeOpenContext\":{\"bladeParameters\":[]}}},{\"columnMatch\":\"Email\",\"formatter\":5},{\"columnMatch\":\"RiskyADUser\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"High risk AD user\",\"representation\":\"disabled\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":\"\",\"representation\":\"Blank\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"IncidentCount\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"0\",\"representation\":\"Blank\",\"text\":\"{0}{1}\"},{\"operator\":\"<\",\"thresholdValue\":\"5\",\"representation\":\"2\",\"text\":\"{0}{1}\"},{\"operator\":\"<\",\"thresholdValue\":\"10\",\"representation\":\"3\",\"text\":\"{0}{1}\"},{\"operator\":\">=\",\"thresholdValue\":\"10\",\"representation\":\"4\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":\"\",\"representation\":\"Blank\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"AlertCount\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"Default\",\"thresholdValue\":\"\",\"representation\":\"Blank\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"0\",\"representation\":\"Blank\",\"text\":\"{0}{1}\"},{\"operator\":\"<\",\"thresholdValue\":\"5\",\"representation\":\"2\",\"text\":\"{0}{1}\"},{\"operator\":\"<\",\"thresholdValue\":\"10\",\"representation\":\"3\",\"text\":\"{0}{1}\"},{\"operator\":\">=\",\"thresholdValue\":\"10\",\"representation\":\"critical\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"TimeGenerated\",\"formatter\":5},{\"columnMatch\":\"AnomalousFailedLogon\",\"formatter\":5},{\"columnMatch\":\"FailedAnomaly\",\"formatter\":5}],\"filter\":true,\"labelSettings\":[{\"columnId\":\"UserAnom\",\"label\":\"User\"},{\"columnId\":\"FailedCountArray\",\"label\":\"Failed attempts timeline\"},{\"columnId\":\"FailedAnomalies\",\"label\":\"Anomalies timeline\"},{\"columnId\":\"EmailAnom\",\"label\":\"Email\"},{\"columnId\":\"RiskyADUser\",\"label\":\"AD risk ind.\"},{\"columnId\":\"IncidentCount\",\"label\":\"Incidents\"},{\"columnId\":\"AlertCount\",\"label\":\"Alerts\"}]},\"sortBy\":[]},\"customWidth\":\"100\",\"showPin\":false,\"name\":\"Anomalous logon failures with AD risk indications\",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let EntityToCheck= \\\"{EntityToCheck}\\\";\\r\\nlet EmptySet= datatable(AlertName:string) [\\\"No incidents found\\\"];\\r\\nSecurityIncident\\r\\n| summarize arg_max(TimeGenerated,CreatedTime,Status, Severity, Owner, AdditionalData, IncidentUrl, Comments, Classification,ClassificationReason, ClassificationComment,Labels, Title, AlertIds) by IncidentNumber\\r\\n| where array_length(AlertIds) > 0\\r\\n| extend Tactics = todynamic(AdditionalData.tactics)\\r\\n| extend Owner = todynamic(Owner.assignedTo), IncidentCreated = format_datetime(CreatedTime,'yy-MM-dd HH:mm')\\r\\n| extend Product = todynamic((parse_json(tostring(AdditionalData.alertProductNames))[0]))\\r\\n| extend Tags = extract_all('labelName\\\":\\\"(.*?)\\\"',tostring(Labels))\\r\\n| extend Owner = case(tostring(Owner)==\\\"\\\", \\\"Unassigned\\\",tostring(Owner)), Products = strcat_array(AdditionalData.alertProductNames, \\\", \\\"), Alerts = tostring(AdditionalData.alertsCount), Bookmarks = tostring(AdditionalData.bookmarksCount), Comments = tostring(AdditionalData.commentsCount), Tactics = strcat_array(AdditionalData.tactics, \\\", \\\"), Labels = strcat_array(Tags, \\\", \\\")\\r\\n| mv-expand AlertIds to typeof(string)\\r\\n| join kind=inner \\r\\n(SecurityAlert | search Entities:EntityToCheck\\r\\n| summarize arg_max(TimeGenerated,AlertName, Description, AlertType, Entities) by SystemAlertId) on $left.AlertIds == $right.SystemAlertId\\r\\n| extend HoursAgo= datetime_diff('Hour',now(), TimeGenerated)\\r\\n| project AlertName, IncidentUrl, HoursAgo, TimeGenerated, Status, Severity, Owner, Entities, User= \\\"{EntityToCheck}\\\"\\r\\n| order by TimeGenerated\\r\\n\\r\\n\",\"size\":1,\"title\":\"Incidents/ alerts overiew for user {AnomEntityToCheck}\",\"noDataMessage\":\"Couldn't find any incidents/ alerts for user\",\"noDataMessageStyle\":2,\"showExportToExcel\":true,\"exportToExcelOptions\":\"all\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{SAPWorkspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"AlertName\",\"formatter\":1},{\"columnMatch\":\"IncidentUrl\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"Url\",\"linkLabel\":\"Go to incident\"}},{\"columnMatch\":\"HoursAgo\",\"formatter\":5},{\"columnMatch\":\"TimeGenerated\",\"formatter\":6,\"dateFormat\":{\"formatName\":\"shortDateTimePattern\"}},{\"columnMatch\":\"Severity\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"High\",\"representation\":\"Sev0\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Medium\",\"representation\":\"Sev2\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Low\",\"representation\":\"1\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":\"\",\"representation\":\"Unavailable\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"Entities\",\"formatter\":5}],\"labelSettings\":[{\"columnId\":\"AlertName\",\"label\":\"Alert name\"},{\"columnId\":\"IncidentUrl\",\"label\":\"Incident URL\"},{\"columnId\":\"TimeGenerated\",\"label\":\"Created on\"}]}},\"customWidth\":\"100\",\"conditionalVisibility\":{\"parameterName\":\"EntityToCheck\",\"comparison\":\"isNotEqualTo\",\"value\":\" \"},\"showPin\":true,\"name\":\"query - 1\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let starttime = todatetime({TimeRange:start});\\r\\nlet endtime = todatetime({TimeRange:end});\\r\\nlet lookback = totimespan((endtime-starttime)*7);\\r\\n\\r\\nlet auditLookback = starttime - 14d;\\r\\n\\r\\n// User Granted Access and Grants others Access\\r\\n\\r\\nlet opName = dynamic([\\\"Add user\\\", \\\"Invite external user\\\"]);\\r\\n// Helper function to extract relevant fields from AuditLog events\\r\\nlet auditLogEvents = view (startTimeSpan: timespan, operation: dynamic) {\\r\\n    AuditLogs\\r\\n    | where TimeGenerated >= auditLookback\\r\\n    | where OperationName in~ (operation)\\r\\n    | extend ModProps = iff(TargetResources.[0].modifiedProperties != \\\"[]\\\", TargetResources.[0].modifiedProperties, todynamic(\\\"NoValues\\\"))\\r\\n    | extend IpAddress = iff(isnotempty(tostring(parse_json(tostring(InitiatedBy.user)).ipAddress)), \\r\\n        tostring(parse_json(tostring(InitiatedBy.user)).ipAddress), tostring(parse_json(tostring(InitiatedBy.app)).ipAddress))\\r\\n    | extend InitiatedByFull = iff(isnotempty(tostring(parse_json(tostring(InitiatedBy.user)).userPrincipalName)), \\r\\n        tostring(parse_json(tostring(InitiatedBy.user)).userPrincipalName), tostring(parse_json(tostring(InitiatedBy.app)).displayName))\\r\\n    | extend InitiatedBy = replace(\\\"_\\\", \\\"@\\\", tostring(split(InitiatedByFull, \\\"#\\\")[0]))\\r\\n    | extend TargetUserPrincipalName = tostring(TargetResources[0].userPrincipalName)\\r\\n    | extend TargetUserName = replace(\\\"_\\\", \\\"@\\\", tostring(split(TargetUserPrincipalName, \\\"#\\\")[0]))\\r\\n    | extend TargetResourceName = case(\\r\\n        isempty(tostring(TargetResources.[0].displayName)), TargetUserPrincipalName,\\r\\n        isnotempty(tostring(TargetResources.[0].displayName)) and tostring(TargetResources.[0].displayName) startswith \\\"upn:\\\", tolower(tostring(TargetResources.[0].displayName)),\\r\\n        tolower(tostring(TargetResources.[0].displayName))\\r\\n        )\\r\\n    | extend TargetUserName = replace(\\\"_\\\", \\\"@\\\", tostring(split(TargetUserPrincipalName, \\\"#\\\")[0]))\\r\\n    | extend TargetUserName = iff(isempty(TargetUserName), tostring(split(split(TargetResourceName, \\\",\\\")[0], \\\" \\\")[1]), TargetUserName) \\r\\n    | mvexpand ModProps\\r\\n    | extend\\r\\n        PropertyName = tostring(ModProps.displayName),\\r\\n        newValue = replace('\\\\\\\"', '', tostring(ModProps.newValue));\\r\\n};\\r\\n// Assigning time for First TargetUserName that was added\\r\\nlet FirstAdd = auditLogEvents(auditLookback, opName)  \\r\\n    | project FirstAddTimeUtc = TimeGenerated, Type, FirstInitiatedBy = InitiatedBy, IpAddress, FirstTargetUserName = TargetUserName, FirstTargetResourceName = TargetResourceName, \\r\\n        FirstOperationName = OperationName, FirstPropertyName = PropertyName, FirstnewValue = newValue, FirstCorrelationId = CorrelationId, FirstId = Id;\\r\\n// Assigning time for second TargetUserName that was added, which will allow us to see if a first TargetUserName added in is the Initiated by on the second in the later join\\r\\nlet SecondAdd = auditLogEvents(auditLookback, opName)  \\r\\n    | project SecondAddTimeUtc = TimeGenerated, Type, SecondInitiatedBy = InitiatedBy, IpAddress, SecondTargetUserName = TargetUserName, SecondTargetResourceName = TargetResourceName, \\r\\n        SecondOperationName = OperationName, SecondPropertyName = PropertyName, SecondnewValue = newValue, SecondCorrelationId = CorrelationId, SecondId = Id;\\r\\n//  Joining the FirstAdd with SecondAdd where the FirstAdd TargetUserName value matches the SecondAdd InitiatedBy.  This shows the new user adding a user.\\r\\nlet NewUserAddsUser = FirstAdd\\r\\n    | join SecondAdd on $left.FirstTargetUserName == $right.SecondInitiatedBy\\r\\n    // we only want items where the FirstAddTimeUtc is before the SecondAddTimeUtc\\r\\n    | where FirstAddTimeUtc < SecondAddTimeUtc\\r\\n;\\r\\n// Build out some of the properties for context\\r\\nlet UserGrantedGrants=(NewUserAddsUser\\r\\n| extend\\r\\n    FirstnewValue = split(FirstnewValue, \\\";\\\"),\\r\\n    SecondnewValue = split(SecondnewValue, \\\";\\\")\\r\\n| extend PropertyUpdate = pack(FirstPropertyName, FirstnewValue, SecondPropertyName, SecondnewValue, \\\"FirstCorrelationId\\\", FirstCorrelationId, \\\"FirstId\\\", FirstId, \\\"SecondCorrelationId\\\", SecondCorrelationId, \\\"SecondId\\\", SecondId)\\r\\n| summarize PropertyUpdateSet = make_bag(PropertyUpdate)\\r\\n    by FirstAddTimeUtc, FirstInitiatedBy, FirstTargetUserName, SecondAddTimeUtc, SecondInitiatedBy, SecondTargetUserName, \\r\\n    IpAddress, FirstTargetResourceName, SecondTargetResourceName, FirstOperationName, SecondOperationName\\r\\n| extend\\r\\n    timestamp = FirstAddTimeUtc,\\r\\n    AccountCustomEntity = FirstInitiatedBy,\\r\\n    HostCustomEntity = FirstTargetResourceName,\\r\\n    IPCustomEntity = IpAddress\\r\\n    | extend UserPrincipalName= SecondTargetUserName)\\r\\n    | extend Risk= 'User Granted Access and Grants others Access';\\r\\n\\r\\n// Anomalous sign-in location by user account and authenticating application - with sign-in details\\r\\nlet AnomalSiginLocAuth= (SigninLogs \\r\\n| where TimeGenerated  > starttime\\r\\n| extend  locationString= strcat(tostring(LocationDetails[\\\"countryOrRegion\\\"]), \\\"/\\\", \\r\\ntostring(LocationDetails[\\\"state\\\"]), \\\"/\\\", tostring(LocationDetails[\\\"city\\\"]), \\\";\\\") \\r\\n| project TimeGenerated, AppDisplayName , UserPrincipalName, locationString \\r\\n// Create time series \\r\\n| make-series dLocationCount = dcount(locationString) on TimeGenerated step 1d \\r\\nby UserPrincipalName, AppDisplayName \\r\\n// Compute best fit line for each entry \\r\\n| extend (RSquare,Slope,Variance,RVariance,Interception,LineFit)=series_fit_line(dLocationCount) \\r\\n// Chart the 3 most interesting lines  \\r\\n// A 0-value slope corresponds to an account being completely stable over time for a given Azure Active Directory application\\r\\n| top 3 by Slope desc  \\r\\n// Extract the set of locations for each top user:\\r\\n| join kind=inner (SigninLogs\\r\\n| extend  locationString= strcat(tostring(LocationDetails[\\\"countryOrRegion\\\"]), \\\"/\\\", \\r\\ntostring(LocationDetails[\\\"state\\\"]), \\\"/\\\", tostring(LocationDetails[\\\"city\\\"]), \\\";\\\")\\r\\n| summarize locationList = makeset(locationString), threeDayWindowLocationCount=dcount(locationString) by AppDisplayName, UserPrincipalName, \\r\\ntimerange=bin(TimeGenerated, 3d)) on AppDisplayName, UserPrincipalName\\r\\n| order by UserPrincipalName, timerange asc\\r\\n| project timerange, AppDisplayName , UserPrincipalName, threeDayWindowLocationCount, locationList \\r\\n| order by AppDisplayName, UserPrincipalName, timerange asc\\r\\n| extend timestamp = timerange, AccountCustomEntity = UserPrincipalName)\\r\\n| extend Risk= 'Anomalous sign-in location by user account and authenticating application';\\r\\n\\r\\n\\r\\n// Failed service logon attempt by user account with available AuditData\\r\\nlet failLimit = 10;\\r\\nlet ipLimit = 3;\\r\\nlet failedSignins = SigninLogs\\r\\n| where TimeGenerated between(starttime..endtime)\\r\\n| where ResultType != \\\"0\\\" and AppDisplayName != \\\"Windows Sign In\\\"\\r\\n| extend UserPrincipalName = tolower(UserPrincipalName)\\r\\n| extend CityState = strcat(tostring(LocationDetails.city),\\\"|\\\", tostring(LocationDetails.state))\\r\\n| extend Result = strcat(ResultType,\\\"-\\\",ResultDescription)\\r\\n| summarize StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated), DistinctIPAddressCount = dcount(IPAddress), IPAddresses = makeset(IPAddress),\\r\\nCityStates = makeset(CityState), DistinctResultCount = dcount(Result), Results = makeset(Result), AppDisplayNames = makeset(AppDisplayName),\\r\\nFailedLogonCount = count() by Type, OperationName, Category, UserPrincipalName = tolower(UserPrincipalName), ClientAppUsed, Location, CorrelationId\\r\\n| project Type, StartTimeUtc, EndTimeUtc, OperationName, Category, UserPrincipalName, AppDisplayNames, DistinctIPAddressCount, IPAddresses, DistinctResultCount,\\r\\nResults, FailedLogonCount, Location, CityStates\\r\\n| where FailedLogonCount >= failLimit or DistinctIPAddressCount >= ipLimit\\r\\n| extend Activity = pack(\\\"IPAddresses\\\", IPAddresses, \\\"AppDisplayNames\\\", AppDisplayNames, \\\"Results\\\", Results, \\\"Location\\\", Location, \\\"CityStates\\\", CityStates)\\r\\n| project Type, StartTimeUtc, EndTimeUtc, OperationName, Category, UserPrincipalName, FailedLogonCount, DistinctIPAddressCount, DistinctResultCount, Activity\\r\\n| extend AccountCustomEntity = UserPrincipalName;\\r\\nlet accountMods = AuditLogs | where TimeGenerated >= auditLookback\\r\\n| where Category == \\\"UserManagement\\\" or Category == \\\"GroupManagement\\\"\\r\\n| extend ModProps = TargetResources.[0].modifiedProperties\\r\\n| extend InitiatedBy = case(\\r\\nisnotempty(tostring(parse_json(tostring(InitiatedBy.user)).userPrincipalName)), tostring(parse_json(tostring(InitiatedBy.user)).userPrincipalName),\\r\\nisnotempty(tostring(parse_json(tostring(InitiatedBy.app)).displayName)), tostring(parse_json(tostring(InitiatedBy.app)).displayName),\\r\\n\\\"\\\")\\r\\n| extend UserPrincipalName = tolower(tostring(TargetResources.[0].userPrincipalName))\\r\\n| mvexpand ModProps\\r\\n| extend PropertyName = tostring(ModProps.displayName), oldValue = tostring(ModProps.oldValue), newValue = tostring(ModProps.newValue)\\r\\n| extend ModifiedProps = pack(\\\"PropertyName\\\",PropertyName,\\\"oldValue\\\",oldValue,\\\"newValue\\\",newValue)\\r\\n| summarize StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated), Activity = make_bag(ModifiedProps) by Type, InitiatedBy, UserPrincipalName, Category, OperationName, CorrelationId, Id\\r\\n| extend AccountCustomEntity = UserPrincipalName, timestamp= StartTimeUtc;\\r\\n// Gather only Audit data for UserPrincipalNames that we have Audit data for\\r\\nlet accountNameOnly = failedSignins | project UserPrincipalName;\\r\\nlet auditMods = accountNameOnly\\r\\n| join kind= innerunique (\\r\\naccountMods\\r\\n) on UserPrincipalName;\\r\\nlet availableAudits = auditMods | project UserPrincipalName;\\r\\nlet signinsWithAudit = availableAudits\\r\\n| join kind= innerunique (\\r\\nfailedSignins\\r\\n) on UserPrincipalName;\\r\\n// Union the Current Signin failures so we do not lose them with the Auditing data we do have\\r\\nlet activity = (union isfuzzy=true\\r\\nsigninsWithAudit, auditMods)\\r\\n| order by StartTimeUtc, UserPrincipalName;\\r\\n\\r\\nlet FailedServiceLogon= (activity\\r\\n| project StartTimeUtc, EndTimeUtc, DataType = Type, Category, OperationName, UserPrincipalName, InitiatedBy, Activity, FailedLogonCount, DistinctIPAddressCount, DistinctResultCount, CorrelationId, Id\\r\\n| order by UserPrincipalName, StartTimeUtc\\r\\n| extend timestamp = StartTimeUtc, AccountCustomEntity = UserPrincipalName)\\r\\n| extend Risk= 'Failed service logon attempt by user account with available AuditData';\\r\\n\\r\\nUserGrantedGrants | union AnomalSiginLocAuth, FailedServiceLogon\\r\\n| where UserPrincipalName =~ \\\"{EntityToCheck}\\\" or FirstInitiatedBy=~ \\\"{EntityToCheck}\\\" or FirstTargetUserName=~ \\\"{EntityToCheck}\\\" or SecondInitiatedBy=~ \\\"{EntityToCheck}\\\" or SecondTargetUserName=~ \\\"{EntityToCheck}\\\"\\r\\n| project Risk, timestamp, ExtendedDetails= pack_all(true)\\r\\n| order by Risk\\r\\n\",\"size\":1,\"title\":\"Azure audit and sigin risks for user {AnomEntityToCheck}\",\"noDataMessage\":\"No Azure AD and SignIns anomalies found\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{ADWorkspace}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"$gen_group\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"155ch\"}},{\"columnMatch\":\"Risk\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"300ch\"}},{\"columnMatch\":\"timestamp\",\"formatter\":6,\"dateFormat\":{\"formatName\":\"shortDateTimePattern\"}},{\"columnMatch\":\"ExtendedDetails\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"300ch\"}},{\"columnMatch\":\"$gen_group\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"155ch\"}}],\"filter\":true,\"hierarchySettings\":{\"treeType\":1,\"groupBy\":[\"Risk\",\"ExtendedDetails\"],\"expandTopLevel\":false},\"labelSettings\":[{\"columnId\":\"timestamp\",\"label\":\"Date and time\"},{\"columnId\":\"ExtendedDetails\",\"label\":\"Extended details\"}]}},\"customWidth\":\"100\",\"conditionalVisibility\":{\"parameterName\":\"EntityToCheck\",\"comparison\":\"isNotEqualTo\",\"value\":\" \"},\"name\":\"Azure AD risks\"}]},\"name\":\"Logon failure anomalies\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let NormallyFailingUsers= todynamic(\\\"\\\"{NormallyFailingUsers}\\\"\\\");\\nlet SuccessAuitClasses= dynamic([\\\"AU1\\\", \\\"AUK\\\", \\\"AU5\\\"]); // \\\"User logged on\\\", \\\"Successful RFC\\\", \\\"RFC/CPIC logon\\\"\\nlet FailedAuitClasses= dynamic([\\\"AU2\\\", \\\"AUL\\\", \\\"AU6\\\", \\\"AUM\\\"]); // \\\"Failed Dialog Logon\\\", \\\"Failed RFC call\\\", \\\"RFC/CPIC logon failed\\\", \\\"User Locked\\\"\\nlet SelectedSystems= SAPSystems(SelectedSystemRoles=dynamic(\\\"{SystemRoles}\\\")\\n, SelectedSystems=todynamic(\\\"[{Systems}]\\\")\\n, SelectedSystemUsage= dynamic(\\\"{SystemUsage}\\\")) | project SystemID, SystemRole;\\n//SelectedSystems\\nSAPAuditLog\\n| where  MessageID in (array_concat(SuccessAuitClasses, FailedAuitClasses))\\n| summarize Count= count() by MessageID, User, SystemID\\n| lookup SelectedSystems on SystemID\\n| extend Status= iff( SuccessAuitClasses has MessageID, \\\"Success\\\", \\\"Failure\\\")\\n| extend SystemRole= iff(isempty(SystemRole), 'Misconfigured Systems',SystemRole)\\n| extend Anomaly = iff(User in(NormallyFailingUsers), 'Anomalous logon failures', 'Frequent logon failures')\\n| where  (\\\"{FailedLogons}\\\") contains Anomaly\\n| summarize UniqueUsersSucess= dcountif(User, Status == \\\"Success\\\", 1), CountSuccess= sumif(Count, Status == \\\"Success\\\"),\\n            UniqueUsersFail= dcountif(User, Status == \\\"Failure\\\", 1), CountFail= sumif(Count, Status == \\\"Failure\\\")\\nby SystemID, SystemRole\\n| extend UniqueFailRate= 100.0*UniqueUsersFail/(UniqueUsersSucess+UniqueUsersFail)\\n| extend CountFailRate= 100.0*CountFail/(CountSuccess+CountFail)\\n| extend SystemID2= iff({DemoMode}, substring(hash_sha1(SystemID), 0, 3), SystemID)\\n\\n\",\"size\":3,\"showAnalytics\":true,\"title\":\"Logon failure rate per system- click on a cell for a detailed report\",\"timeContextFromParameter\":\"TimeRange\",\"timeBrushParameterName\":\"BrushedTimeRange\",\"timeBrushExportOnlyWhenBrushed\":true,\"exportedParameters\":[{\"fieldName\":\"SystemID\",\"parameterName\":\"SystemIDFromHive\",\"defaultValue\":\"'All Systems'\"},{\"fieldName\":\"SystemID2\",\"parameterName\":\"SystemID2FromHive\",\"parameterType\":1,\"defaultValue\":\"'All Systems'\"}],\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{SAPWorkspace}\"],\"visualization\":\"graph\",\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"ResultText\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"dcount_CorrelationId\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}},\"graphSettings\":{\"type\":2,\"topContent\":{\"columnMatch\":\"SystemID2\",\"formatter\":12,\"formatOptions\":{\"palette\":\"blue\"}},\"centerContent\":{\"columnMatch\":\"UniqueUsersFail\",\"formatter\":1,\"tooltipFormat\":{\"tooltip\":\"Number of unique failing users {0}\"}},\"bottomContent\":{\"columnMatch\":\"UniqueFailRate\",\"formatter\":1,\"tooltipFormat\":{\"tooltip\":\"Rate of logon failure {0} %\"}},\"hivesContent\":{\"columnMatch\":\"SystemRole\",\"formatter\":12,\"formatOptions\":{\"palette\":\"blue\"}},\"nodeIdField\":\"SystemID\",\"sourceIdField\":\"SystemRole\",\"targetIdField\":\"SystemID\",\"graphOrientation\":3,\"showOrientationToggles\":false,\"nodeSize\":\"\",\"staticNodeSize\":70,\"colorSettings\":{\"nodeColorField\":\"UniqueFailRate\",\"type\":4,\"heatmapPalette\":\"greenRed\",\"heatmapMin\":\"\",\"heatmapMax\":\"\"},\"groupByField\":\"SystemRole\",\"hivesMargin\":5},\"chartSettings\":{\"xAxis\":\"TimeGenerated\",\"yAxis\":[\"Count\"],\"group\":\"MessageClass\",\"createOtherGroup\":\"\",\"showLegend\":true},\"mapSettings\":{\"locInfo\":\"LatLong\",\"sizeSettings\":\"UniqueUsers\",\"sizeAggregation\":\"Sum\",\"legendMetric\":\"UniqueUsers\",\"legendAggregation\":\"Sum\",\"itemColorSettings\":{\"type\":\"heatmap\",\"colorAggregation\":\"Sum\",\"nodeColorField\":\"UniqueUsers\",\"heatmapPalette\":\"greenRed\"}}},\"customWidth\":\"64\",\"name\":\"SuccessFailurebyRole\",\"styleSettings\":{\"maxWidth\":\"100\",\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let NormallyFailingUsers= todynamic(\\\"\\\"{NormallyFailingUsers}\\\"\\\");\\r\\nlet DataTypes = materialize(SAPGetDataTypes());\\r\\nlet FailedAuitClasses= dynamic([\\\"AU2\\\", \\\"AUL\\\", \\\"AU6\\\", \\\"AUM\\\"]); // \\\"Failed Dialog Logon\\\", \\\"Failed RFC call\\\", \\\"RFC/CPIC logon failed\\\", \\\"User Locked\\\"\\r\\nSAPAuditLog\\r\\n| where  MessageID in (FailedAuitClasses)\\r\\n| where SystemID == \\\"{SystemIDFromHive}\\\"\\r\\n| summarize Count= count(), MessageText= any(MessageText) by MessageID, User, SystemID, TimeGenerated= startofday(bin(TimeGenerated, 1d)), LogonTypes= Variable1, Reasons= Variable2, LogonMethods= Variable3\\r\\n| extend Anomaly = iff(User in(NormallyFailingUsers), 'Anomalous logon failures', 'Frequent logon failures')\\r\\n| where  (\\\"{FailedLogons}\\\") contains Anomaly\\r\\n| lookup (DataTypes | where DataType == \\\"LogonFailureCause\\\"| project Key, LogonFailureCause= Value) on $left.Reasons == $right.Key\\r\\n| lookup (DataTypes | where DataType == \\\"LogonType\\\"| project Key, LogonType= Value) on $left.LogonTypes == $right.Key\\r\\n| lookup (DataTypes | where DataType == \\\"LogonMethod\\\"| project Key, LogonMethod= Value) on $left.LogonMethods == $right.Key\\r\\n| extend User= iff({DemoMode}, substring(hash_sha1(User), 0, 12), User)\\r\\n| project User, LogonType, LogonMethod, LogonFailureCause, Details= strcat(\\\"User \\\", User, \\\" has failed to logon by \\\", LogonMethod, \\\". A \\\", LogonType, \\\" has failed for \\\", LogonFailureCause )\\r\\n, Count, FormattedDate= format_datetime(TimeGenerated, 'yy-MM-dd')\\r\\n| extend CountPerDay= strcat(Count, ' Times on ', FormattedDate)\\r\\n\\r\\n\\r\\n\\r\\n\",\"size\":0,\"showAnalytics\":true,\"title\":\"Failed logons for system {SystemID2FromHive}\",\"noDataMessage\":\"Click on a system from the hive to see failed logons\",\"noDataMessageStyle\":2,\"timeContextFromParameter\":\"TimeRange\",\"showExportToExcel\":true,\"exportToExcelOptions\":\"all\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{SAPWorkspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"$gen_group\",\"formatter\":1,\"formatOptions\":{\"customColumnWidthSetting\":\"200ch\"}},{\"columnMatch\":\"User\",\"formatter\":5},{\"columnMatch\":\"LogonType\",\"formatter\":5},{\"columnMatch\":\"LogonMethod\",\"formatter\":5},{\"columnMatch\":\"LogonFailureCause\",\"formatter\":5},{\"columnMatch\":\"Details\",\"formatter\":1,\"formatOptions\":{\"customColumnWidthSetting\":\"150ch\"},\"numberFormat\":{\"unit\":0,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Count\",\"formatter\":0,\"formatOptions\":{\"aggregation\":\"Sum\"}},{\"columnMatch\":\"TimeGenerated\",\"formatter\":6,\"formatOptions\":{\"customColumnWidthSetting\":\"15ch\"},\"dateFormat\":{\"formatName\":\"shortDatePattern\"}}],\"filter\":true,\"hierarchySettings\":{\"treeType\":1,\"groupBy\":[\"Details\",\"CountPerDay\"],\"expandTopLevel\":false},\"labelSettings\":[{\"columnId\":\"Details\",\"label\":\"Details\"}]}},\"customWidth\":\"35\",\"conditionalVisibility\":{\"parameterName\":\"SystemIDFromHive\",\"comparison\":\"isNotEqualTo\",\"value\":\"'All Systems'\"},\"name\":\"FailedbyUsersperSystem\"}]},\"customWidth\":\"100\",\"name\":\"group failed logons Drill\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Logon failures trends\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let DataTypes = materialize(SAPGetDataTypes());\\nlet SelectedSystems= SAPSystems(SelectedSystemRoles=dynamic(\\\"{SystemRoles}\\\")\\n, SelectedSystems=todynamic(\\\"[{Systems}]\\\")\\n, SelectedSystemUsage= dynamic(\\\"{SystemUsage}\\\")) | project SystemID;\\nlet NormallyFailingUsers= todynamic(\\\"\\\"{NormallyFailingUsers}\\\"\\\");\\nlet FailedAuitClasses= dynamic([\\\"AU2\\\", \\\"AUL\\\", \\\"AU6\\\", \\\"AUM\\\"]); // \\\"Failed Dialog Logon\\\", \\\"Failed RFC call\\\", \\\"RFC/CPIC logon failed\\\", \\\"User Locked\\\"\\nSAPAuditLog\\n| where SystemID in(SelectedSystems)\\n| where  MessageID in (FailedAuitClasses)\\n| extend TimeGenerated= bin(TimeGenerated, 4h)\\n| extend Anomaly = iff(User in(NormallyFailingUsers), 'Anomalous logon failures', 'Frequent logon failures')\\n| where  (\\\"{FailedLogons}\\\") contains Anomaly\\n| summarize UniqueUsers= dcount(User), Count= count() by TimeGenerated, LogonTypes= Variable1, Reasons= Variable2, LogonMethods= Variable3\\n| lookup (DataTypes | where DataType == \\\"LogonFailureCause\\\"| project Key, LogonFailureCause= Value) on $left.Reasons == $right.Key\\n| lookup (DataTypes | where DataType == \\\"LogonType\\\"| project Key, LogonType= Value) on $left.LogonTypes == $right.Key\\n| lookup (DataTypes | where DataType == \\\"LogonMethod\\\"| project Key, LogonMethod= Value) on $left.LogonMethods == $right.Key\\n| project TimeGenerated, LogonFailureCause, LogonType, LogonMethod, Count, UniqueUsers\\n\",\"size\":1,\"aggregation\":3,\"showAnalytics\":true,\"title\":\"Login failure by cause\",\"timeContextFromParameter\":\"TimeRange\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{SAPWorkspace}\"],\"visualization\":\"areachart\",\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"ResultText\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"dcount_CorrelationId\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}},\"chartSettings\":{\"xAxis\":\"TimeGenerated\",\"yAxis\":[\"UniqueUsers\"],\"group\":\"LogonFailureCause\",\"createOtherGroup\":\"\"}},\"customWidth\":\"100\",\"name\":\"Login failures\",\"styleSettings\":{\"maxWidth\":\"100%\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let DataTypes = materialize(SAPGetDataTypes());\\nlet SelectedSystems= SAPSystems(SelectedSystemRoles=dynamic(\\\"{SystemRoles}\\\")\\n, SelectedSystems=todynamic(\\\"[{Systems}]\\\")\\n, SelectedSystemUsage= dynamic(\\\"{SystemUsage}\\\")) | project SystemID;\\nlet NormallyFailingUsers= todynamic(\\\"\\\"{NormallyFailingUsers}\\\"\\\");\\nlet FailedAuitClasses= dynamic([\\\"AU2\\\", \\\"AUL\\\", \\\"AU6\\\", \\\"AUM\\\"]); // \\\"Failed Dialog Logon\\\", \\\"Failed RFC call\\\", \\\"RFC/CPIC logon failed\\\", \\\"User Locked\\\"\\nSAPAuditLog\\n| where SystemID in(SelectedSystems)\\n| where  MessageID in (FailedAuitClasses)\\n| extend TimeGenerated= bin(TimeGenerated, 4h)\\n| extend Anomaly = iff(User in(NormallyFailingUsers), 'Anomalous logon failures', 'Frequent logon failures')\\n| where  (\\\"{FailedLogons}\\\") contains Anomaly\\n| summarize UniqueUsers= dcount(User), Count= count() by TimeGenerated, LogonTypes= Variable1, Reasons= Variable2, LogonMethods= Variable3\\n| lookup (DataTypes | where DataType == \\\"LogonFailureCause\\\"| project Key, LogonFailureCause= Value) on $left.Reasons == $right.Key\\n| lookup (DataTypes | where DataType == \\\"LogonType\\\"| project Key, LogonType= Value) on $left.LogonTypes == $right.Key\\n| lookup (DataTypes | where DataType == \\\"LogonMethod\\\"| project Key, LogonMethod= Value) on $left.LogonMethods == $right.Key\\n| project TimeGenerated, LogonFailureCause, LogonType, LogonMethod, Count, UniqueUsers\\n\",\"size\":1,\"aggregation\":3,\"showAnalytics\":true,\"title\":\"Login failure by type\",\"timeContextFromParameter\":\"TimeRange\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{SAPWorkspace}\"],\"visualization\":\"areachart\",\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"ResultText\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"dcount_CorrelationId\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}},\"chartSettings\":{\"xAxis\":\"TimeGenerated\",\"yAxis\":[\"UniqueUsers\"],\"group\":\"LogonType\",\"createOtherGroup\":\"\"}},\"customWidth\":\"100\",\"name\":\"Login failures by type\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let DataTypes = materialize(SAPGetDataTypes());\\nlet SelectedSystems= SAPSystems(SelectedSystemRoles=dynamic(\\\"{SystemRoles}\\\")\\n, SelectedSystems=todynamic(\\\"[{Systems}]\\\")\\n, SelectedSystemUsage= dynamic(\\\"{SystemUsage}\\\")) | project SystemID;\\nlet NormallyFailingUsers= todynamic(\\\"\\\"{NormallyFailingUsers}\\\"\\\");\\nlet FailedAuitClasses= dynamic([\\\"AU2\\\", \\\"AUL\\\", \\\"AU6\\\", \\\"AUM\\\"]); // \\\"Failed Dialog Logon\\\", \\\"Failed RFC call\\\", \\\"RFC/CPIC logon failed\\\", \\\"User Locked\\\"\\nSAPAuditLog\\n| where SystemID in(SelectedSystems)\\n| where  MessageID in (FailedAuitClasses)\\n| extend Anomaly = iff(User in(NormallyFailingUsers), 'Anomalous logon failures', 'Frequent logon failures')\\n| where  (\\\"{FailedLogons}\\\") contains Anomaly\\n| extend TimeGenerated= bin(TimeGenerated, 4h)\\n| summarize UniqueUsers= dcount(User), Count= count() by TimeGenerated, LogonTypes= Variable1, Reasons= Variable2, LogonMethods= Variable3\\n| lookup (DataTypes | where DataType == \\\"LogonFailureCause\\\"| project Key, LogonFailureCause= Value) on $left.Reasons == $right.Key\\n| lookup (DataTypes | where DataType == \\\"LogonType\\\"| project Key, LogonType= Value) on $left.LogonTypes == $right.Key\\n| lookup (DataTypes | where DataType == \\\"LogonMethod\\\"| project Key, LogonMethod= Value) on $left.LogonMethods == $right.Key\\n| project TimeGenerated, LogonFailureCause, LogonType, LogonMethod, Count, UniqueUsers\\n\",\"size\":1,\"aggregation\":3,\"showAnalytics\":true,\"title\":\"Login failure by method\",\"timeContextFromParameter\":\"TimeRange\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{SAPWorkspace}\"],\"visualization\":\"areachart\",\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"ResultText\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"dcount_CorrelationId\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}},\"chartSettings\":{\"xAxis\":\"TimeGenerated\",\"yAxis\":[\"UniqueUsers\"],\"group\":\"LogonMethod\",\"createOtherGroup\":\"\"}},\"customWidth\":\"100\",\"name\":\"Login failures by method\"}]},\"name\":\"group failues trends\"}]},\"conditionalVisibility\":{\"parameterName\":\"MainTabSelected\",\"comparison\":\"isEqualTo\",\"value\":\"'Logon Analysis'\"},\"name\":\"Group Logon Failures\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"expandable\":true,\"expanded\":true,\"items\":[{\"type\":1,\"content\":{\"json\":\"----\\n## Audit Log Alerts\\n\\nAn overview of the SAP Audit log events which are watched for. Configuration is based on the \\\"SAP Dynamic Audit Log Monitor Configuration\\\" watchlist. [ Click here for more information ](https://docs.microsoft.com/en-us/azure/sentinel/sap/deployment-solution-configuration#configuring-the-sap-audit-log-monitoring-analytics-rules)\\n### Anomaly detection- filtering out noisy automation activities\\nWe use anomaly detection methods to determine which alerts are caused by automation, allowing us to focus on the events which are anomalous. For the following analysis, we have the \\\"Anomalous only\\\" option selected by default, meaning the events which are examinedt answer one of the conditions below:\\n1. Events marked as \\\"Deteministic\\\" in the \\\"SAP Dynamic Audit Log Monitor Configuration\\\" watchlist, and have crossed relevant thresholds and exclusion rules.\\n2. Events marked as \\\"AnomaliesOnly\\\" in the \\\"SAP Dynamic Audit Log Monitor Configuration\\\" watchlist, have crossed relevant thresholds and exclusion rules and flagged as anomalous by the algorithm. \\n\\nSetting the the \\\"Audit event types\\\" parameter to \\\"All\\\" will include all audit events, including such that were determined as normal by the anomaly detector.\\n\"},\"name\":\"text - 10\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"e98b7063-b2c7-443b-9613-6364fbded3c7\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"AuditEventsType\",\"label\":\"Audit event types\",\"type\":10,\"isRequired\":true,\"isGlobal\":true,\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"jsonData\":\"[{ \\\"value\\\": \\\"Anomalous audit event\\\", \\\"label\\\": \\\"Anomalous only\\\", \\\"selected\\\":true}, { \\\"value\\\": [\\\"Anomalous audit event\\\", \\\"Normal audit event\\\"], \\\"label\\\": \\\"All\\\" }]\",\"timeContext\":{\"durationMs\":86400000}}],\"style\":\"formHorizontal\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"customWidth\":\"35\",\"name\":\"parameters - Anomaly failed logons\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"** Alert severity trends per System ID **\\r\\n\\r\\nHigh severity\\r\\n Mediun severity\\r\\n\"},\"name\":\"text - 3\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"\\r\\nlet SelectedSystems= SAPSystems(SelectedSystemRoles=dynamic(\\\"{SystemRoles}\\\")\\r\\n, SelectedSystems=todynamic(\\\"[{Systems}]\\\")\\r\\n, SelectedSystemUsage= dynamic(\\\"{SystemUsage}\\\")) | project SystemID;\\r\\nlet TimeStep= 4h;\\r\\nlet SelectedSeverities=  dynamic([\\\"High\\\", \\\"Medium\\\"]);//can also do//let SelectedSeverities =  dynamic([\\\"All Severities\\\"])\\r\\nlet SelectedRuleTypes= dynamic([ \\\"Deterministic\\\", \\\"AnomaliesOnly\\\"]); // Rule only goes for deterministic alerting\\r\\nlet AuditConfiguration= materialize(SAPAuditLogConfiguration(SelectedSeverities= SelectedSeverities, SelectedRuleTypes= SelectedRuleTypes)\\r\\n| where SystemID in(SelectedSystems)\\r\\n| project MessageID, SystemID, RolesTagsToExclude, Severity, Threshold, RuleType, MessageText, CategoryName);\\r\\n// get special users for exclusion and in-focus analysis\\r\\nlet SAPUsersGottenVIP = (SAPUsersGetVIP | project User = SAPUser, TagsList, SpecialFocusTagged);\\r\\nlet SAPUserRolesAndProfiles = (SAPUsersAssignments | project-keep User, SystemID, DirectRoles, ChildRoles, Profiles | summarize RolesAndProfiles = make_set(array_concat(DirectRoles, ChildRoles, Profiles), 120) by User, SystemID);\\r\\nSAPAuditLog\\r\\n| where SystemID in(SelectedSystems)\\r\\n| where isnotempty( User)\\r\\n| where AlertSeverityText != \\\"Low\\\"\\r\\n| where MessageID in ((AuditConfiguration | summarize count() by MessageID))\\r\\n| lookup kind=inner (AuditConfiguration| project SystemID, MessageID, Severity, Threshold  ) on\\r\\n$left.MessageID == $right.MessageID\\r\\n,$left.SystemID == $right.SystemID\\r\\n| where SelectedSeverities contains Severity\\r\\n| make-series AuditEventsCounts= count() default=0 on TimeGenerated from startofday({TimeRange:start}) to {TimeRange:end} \\r\\nstep TimeStep by SystemID, MessageID, User, Threshold\\r\\n| extend crossedThreshold= series_greater(AuditEventsCounts, repeat(Threshold* TimeStep/1h, array_length(AuditEventsCounts)) )\\r\\n| where array_sum(crossedThreshold) > 0\\r\\n| extend crossedThreshold = array_iif(crossedThreshold,repeat(1, array_length(AuditEventsCounts)) , repeat(0, array_length(AuditEventsCounts)))\\r\\n| lookup SAPUsersGottenVIP on User\\r\\n| lookup SAPUserRolesAndProfiles on User, SystemID\\r\\n| lookup (AuditConfiguration | project-keep SystemID, MessageID, RuleType, RolesTagsToExclude, MessageText, CategoryName, Severity) on MessageID, SystemID\\r\\n| extend RolesProfilesAndTags = array_concat(RolesAndProfiles, TagsList)\\r\\n| extend TagsIntersect = set_intersect(split(RolesTagsToExclude,\\\";\\\"), RolesProfilesAndTags)\\r\\n| extend IntersectionSize = array_length(TagsIntersect)\\r\\n// keep only non-excluded users that are not under \\\"Special Focus\\\"\\r\\n| where IntersectionSize == 0 or isempty(IntersectionSize) or SpecialFocusTagged == true\\r\\n| extend Anomalies= series_decompose_anomalies(AuditEventsCounts, Threshold=4, Test_point= 1)\\r\\n| extend Anomaly= array_index_of(Anomalies,1)>= 0\\r\\n| extend AnomalSeriesIndicator = iff(RuleType==\\\"Deterministic\\\", \\\"Deterministic threshold crossed\\\", iff(Anomaly, 'Anomalous audit event', 'Normal audit event'))\\r\\n| extend UserMessageSystemCount= 1\\r\\n| mv-expand Anomalies to typeof(double), TimeGenerated to typeof(datetime), crossedThreshold to typeof(int )\\r\\n| where (crossedThreshold > 0) and (( RuleType==\\\"Deterministic\\\") or ( RuleType== \\\"AnomaliesOnly\\\" and (Anomalies > 0 or \\\"{AuditEventsType}\\\" contains \\\"All\\\")))\\r\\n| extend AnomalPointIndicator = iff(RuleType==\\\"Deterministic\\\", \\\"Deterministic threshold crossed\\\", \\\"Anomalous audit event\\\")\\r\\n| make-series  AlertCountsHigh= countif(Severity == \\\"High\\\") default=0, AlertCountsMedium= countif(Severity == \\\"Medium\\\") default=0 on TimeGenerated from startofday({TimeRange:start}) to {TimeRange:end} \\r\\nstep TimeStep by SystemID\\r\\n| extend SystemID= iff({DemoMode}, substring(hash_sha1(SystemID), 0, 3), SystemID)\\r\\n| extend Systemlabel= strcat('', SystemID)\\r\\n//| extend left= \\\"High\\\"\\r\\n//| extend right= \\\"Medium\\\"\\r\\n\\r\\n\\r\\n\",\"size\":1,\"showAnalytics\":true,\"title\":\"Alert severity trends per System ID\",\"timeContextFromParameter\":\"TimeRange\",\"showRefreshButton\":true,\"exportFieldName\":\"series\",\"exportParameterName\":\"Systems\",\"showExportToExcel\":true,\"exportToExcelOptions\":\"all\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{SAPWorkspace}\"],\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"Systemlabel\",\"formatter\":1},\"subtitleContent\":{\"columnMatch\":\"AlertCountsHigh\",\"formatter\":9,\"formatOptions\":{\"palette\":\"red\",\"linkColumn\":\"AlertCountsHigh\",\"linkTarget\":\"GenericDetails\",\"linkIsContextBlade\":true},\"tooltipFormat\":{\"tooltip\":\"High severity alerts\"}},\"secondaryContent\":{\"columnMatch\":\"AlertCountsMedium\",\"formatter\":9,\"formatOptions\":{\"palette\":\"yellow\",\"compositeBarSettings\":{\"labelText\":\"\",\"columnSettings\":[{\"columnName\":\"AlertCountsHigh\",\"color\":\"red\"},{\"columnName\":\"AlertCountsMedium\",\"color\":\"yellow\"}]}},\"tooltipFormat\":{\"tooltip\":\"Medium severity alerts {0}\"}},\"showBorder\":false,\"sortCriteriaField\":\"AlertCountsHigh\",\"sortOrderField\":2,\"size\":\"auto\"},\"graphSettings\":{\"type\":0,\"topContent\":{\"columnMatch\":\"SearchKey\",\"formatter\":1},\"centerContent\":{\"columnMatch\":\"DummyJoinField\",\"formatter\":1,\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}},\"chartSettings\":{\"xAxis\":\"SystemID\",\"yAxis\":[\"UniqueUsers\"],\"group\":\"SystemID\",\"createOtherGroup\":10,\"ySettings\":{\"numberFormatSettings\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"useGrouping\":true}}}}},\"name\":\"Severity trends\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let UsersEmail= SAPUsersEmail\\r\\n| summarize Email= make_set_if(Email,  Email contains_cs \\\"@\\\", 10)[0] by User;\\r\\nlet UsersEventCount= (SecurityAlert\\r\\n    | summarize hint.strategy = shuffle arg_max(TimeGenerated, Entities), NumberOfUpdates = count() by SystemAlertId\\r\\n    | mv-expand todynamic(Entities)\\r\\n    | where Entities[\\\"Type\\\"] =~ \\\"account\\\"\\r\\n    | where isnotempty( Entities[\\\"Name\\\"]) and isnotempty( Entities[\\\"UPNSuffix\\\"])\\r\\n    | project UserPrincipalName = strcat(tolower(Entities[\\\"Name\\\"]), \\\"@\\\", tolower(Entities[\\\"UPNSuffix\\\"])), AlertID= SystemAlertId\\r\\n    | join kind=inner (SecurityIncident | mv-expand AlertID= AlertIds to typeof(string ) | project AlertID, IncidentName) on AlertID\\r\\n| summarize IncidentCount= dcount(IncidentName, 2) , AlertCount= dcount(AlertID, 2) by Email= UserPrincipalName);\\r\\nlet RiskyADUsers= todynamic(\\\"\\\"{AzureSuspiciousUsers}\\\"\\\");\\r\\nlet SelectedSystems= SAPSystems(SelectedSystemRoles=dynamic(\\\"{SystemRoles}\\\")\\r\\n, SelectedSystems=todynamic(\\\"[{Systems}]\\\")\\r\\n, SelectedSystemUsage= dynamic(\\\"{SystemUsage}\\\")) | project SystemID;\\r\\nlet TimeStep= 4h;\\r\\nlet SelectedSeverities=  dynamic([\\\"High\\\", \\\"Medium\\\"]);//can also do//let SelectedSeverities =  dynamic([\\\"All Severities\\\"])\\r\\nlet SelectedRuleTypes= dynamic([ \\\"Deterministic\\\", \\\"AnomaliesOnly\\\"]); // Rule only goes for deterministic alerting\\r\\nlet AuditConfiguration= materialize(SAPAuditLogConfiguration(SelectedSeverities= SelectedSeverities, SelectedRuleTypes= SelectedRuleTypes)\\r\\n| where SystemID in(SelectedSystems)\\r\\n| project MessageID, SystemID, RolesTagsToExclude, Severity, Threshold, RuleType, MessageText, CategoryName);\\r\\n// get special users for exclusion and in-focus analysis\\r\\nlet SAPUsersGottenVIP = (SAPUsersGetVIP | project User = SAPUser, TagsList, SpecialFocusTagged);\\r\\nlet SAPUserRolesAndProfiles = (SAPUsersAssignments | project-keep User, SystemID, DirectRoles, ChildRoles, Profiles | summarize RolesAndProfiles = make_set(array_concat(DirectRoles, ChildRoles, Profiles), 120) by User, SystemID);\\r\\nSAPAuditLog\\r\\n| where SystemID in(SelectedSystems)\\r\\n| where isnotempty( User)\\r\\n| where AlertSeverityText != \\\"Low\\\"\\r\\n| where MessageID in ((AuditConfiguration | summarize count() by MessageID))\\r\\n| lookup kind=inner (AuditConfiguration| project SystemID, MessageID, Severity, Threshold  ) on\\r\\n$left.MessageID == $right.MessageID\\r\\n,$left.SystemID == $right.SystemID\\r\\n| where SelectedSeverities contains Severity\\r\\n| make-series AuditEventsCounts= count() default=0 on TimeGenerated from startofday({TimeRange:start}) to {TimeRange:end} \\r\\nstep TimeStep by SystemID, MessageID, User, Threshold\\r\\n| extend crossedThreshold= series_greater(AuditEventsCounts, repeat(Threshold* TimeStep/1h, array_length(AuditEventsCounts)) )\\r\\n| where array_sum(crossedThreshold) > 0\\r\\n| extend crossedThreshold = array_iif(crossedThreshold,repeat(1, array_length(AuditEventsCounts)) , repeat(0, array_length(AuditEventsCounts)))\\r\\n| lookup SAPUsersGottenVIP on User\\r\\n| lookup SAPUserRolesAndProfiles on User, SystemID\\r\\n| lookup (AuditConfiguration | project-keep SystemID, MessageID, RuleType, RolesTagsToExclude, MessageText, CategoryName, Severity) on MessageID, SystemID\\r\\n| extend RolesProfilesAndTags = array_concat(RolesAndProfiles, TagsList)\\r\\n| extend TagsIntersect = set_intersect(split(RolesTagsToExclude,\\\";\\\"), RolesProfilesAndTags)\\r\\n| extend IntersectionSize = array_length(TagsIntersect)\\r\\n// keep only non-excluded users that are not under \\\"Special Focus\\\"\\r\\n| where IntersectionSize == 0 or isempty(IntersectionSize) or SpecialFocusTagged == true\\r\\n| extend Anomalies= series_decompose_anomalies(AuditEventsCounts, Threshold=4, Test_point= 1)\\r\\n| extend Anomaly= array_index_of(Anomalies,1)>= 0\\r\\n| extend AnomalSeriesIndicator = iff(RuleType==\\\"Deterministic\\\", \\\"Deterministic threshold crossed\\\", iff(Anomaly, 'Anomalous audit event', 'Normal audit event'))\\r\\n| extend UserMessageSystemCount= 1\\r\\n| mv-expand Anomalies to typeof(double), TimeGenerated to typeof(datetime), crossedThreshold to typeof(int )\\r\\n| where (crossedThreshold > 0) and (( RuleType==\\\"Deterministic\\\") or ( RuleType== \\\"AnomaliesOnly\\\" and (Anomalies > 0 or \\\"{AuditEventsType}\\\" contains \\\"All\\\")))\\r\\n| extend AnomalPointIndicator = iff(RuleType==\\\"Deterministic\\\", \\\"Deterministic threshold crossed\\\", \\\"Anomalous audit event\\\")\\r\\n| make-series  AlertCountsHigh= countif(Severity == \\\"High\\\") default=0, AlertCountsMedium= countif(Severity == \\\"Medium\\\") default=0 on TimeGenerated from startofday({TimeRange:start}) to {TimeRange:end} \\r\\nstep TimeStep by User\\r\\n| lookup UsersEmail on User\\r\\n| extend Email = iff(isempty(Email), User, Email)\\r\\n| extend Email = iff(isempty(Email), iff({DemoMode}, 'pdemo@seccxpninja.onmicrosoft.com', User), tolower(Email))\\r\\n| extend RiskyADUser = iff(Email in(RiskyADUsers), 'High risk AD user', '')\\r\\n| extend SumOfHigh = array_sum(AlertCountsHigh)*2 + array_sum(AlertCountsMedium)\\r\\n| order by RiskyADUser desc, SumOfHigh desc\\r\\n| extend UserAnom= iff({DemoMode}, substring(hash_sha1(User), 0, 12), User)\\r\\n| extend EmailAnom= iff({DemoMode}, strcat(substring(hash_sha1(User), 0, 12), '@seccxpninja.onmicrosoft.com' ), Email)\\r\\n| project User, UserAnom, AlertCountsHigh , AlertCountsMedium, EmailAnom, Email, RiskyADUser\\r\\n| lookup UsersEventCount on Email\\r\\n| order by RiskyADUser desc, IncidentCount desc, User asc\\r\\n\\r\\n\\r\\n\\r\\n\\r\\n\\r\\n\",\"size\":0,\"showAnalytics\":true,\"title\":\"Audit trend per user- select a line to see more details\",\"timeContextFromParameter\":\"TimeRange\",\"showRefreshButton\":true,\"exportedParameters\":[{\"fieldName\":\"User\",\"parameterName\":\"SAPUserToCheck\",\"defaultValue\":\" \"},{\"fieldName\":\"Email\",\"parameterName\":\"EntityToCheck\",\"parameterType\":1,\"defaultValue\":\" \"},{\"fieldName\":\"EmailAnom\",\"parameterName\":\"EntityToCheckAnom\",\"parameterType\":1,\"defaultValue\":\" \"}],\"showExportToExcel\":true,\"exportToExcelOptions\":\"all\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{SAPWorkspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"User\",\"formatter\":5},{\"columnMatch\":\"UserAnom\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"Default\",\"thresholdValue\":\"\",\"representation\":\"Person\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"AlertCountsHigh\",\"formatter\":9,\"formatOptions\":{\"palette\":\"red\"}},{\"columnMatch\":\"AlertCountsMedium\",\"formatter\":9,\"formatOptions\":{\"palette\":\"yellow\"}},{\"columnMatch\":\"EmailAnom\",\"formatter\":1,\"formatOptions\":{\"workbookContext\":{\"componentIdSource\":\"workbook\",\"resourceIdsSource\":\"default\",\"templateIdSource\":\"static\",\"templateId\":\"/providers/Microsoft.Insights/workbooks/c4862201-6476-4ffa-909d-791c7d159b54\",\"typeSource\":\"static\",\"type\":\"sentinel\",\"gallerySource\":\"static\",\"gallery\":\"Sentinel\",\"locationSource\":\"default\"},\"bladeOpenContext\":{\"bladeParameters\":[]}}},{\"columnMatch\":\"Email\",\"formatter\":5},{\"columnMatch\":\"RiskyADUser\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"High risk AD user\",\"representation\":\"disabled\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":\"\",\"representation\":\"Blank\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"IncidentCount\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"0\",\"representation\":\"Blank\",\"text\":\"{0}{1}\"},{\"operator\":\"<\",\"thresholdValue\":\"5\",\"representation\":\"2\",\"text\":\"{0}{1}\"},{\"operator\":\"<\",\"thresholdValue\":\"10\",\"representation\":\"3\",\"text\":\"{0}{1}\"},{\"operator\":\">=\",\"thresholdValue\":\"10\",\"representation\":\"4\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":\"\",\"representation\":\"Blank\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"AlertCount\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"0\",\"representation\":\"Blank\",\"text\":\"{0}{1}\"},{\"operator\":\"<\",\"thresholdValue\":\"5\",\"representation\":\"2\",\"text\":\"{0}{1}\"},{\"operator\":\"<\",\"thresholdValue\":\"10\",\"representation\":\"3\",\"text\":\"{0}{1}\"},{\"operator\":\">=\",\"thresholdValue\":\"10\",\"representation\":\"critical\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":\"\",\"representation\":\"Blank\",\"text\":\"{0}{1}\"}]}}],\"filter\":true,\"labelSettings\":[{\"columnId\":\"UserAnom\",\"label\":\"User\"},{\"columnId\":\"AlertCountsHigh\",\"label\":\"High severity\"},{\"columnId\":\"AlertCountsMedium\",\"label\":\"Medium severity\"},{\"columnId\":\"EmailAnom\",\"label\":\"Email\"},{\"columnId\":\"RiskyADUser\",\"label\":\"AD risk ind.\"},{\"columnId\":\"IncidentCount\",\"label\":\"Incident Count\"},{\"columnId\":\"AlertCount\",\"label\":\"Alert Count\"}]},\"sortBy\":[]},\"customWidth\":\"64\",\"showPin\":false,\"name\":\"Audit \",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let EntityToCheck= \\\"{EntityToCheck}\\\";\\r\\nlet EmptySet= datatable(AlertName:string) [\\\"No incidents found\\\"];\\r\\nSecurityIncident\\r\\n| summarize arg_max(TimeGenerated,CreatedTime,Status, Severity, Owner, AdditionalData, IncidentUrl, Comments, Classification,ClassificationReason, ClassificationComment,Labels, Title, AlertIds) by IncidentNumber\\r\\n| where array_length(AlertIds) > 0\\r\\n| extend Tactics = todynamic(AdditionalData.tactics)\\r\\n| extend Owner = todynamic(Owner.assignedTo), IncidentCreated = format_datetime(CreatedTime,'yy-MM-dd HH:mm')\\r\\n| extend Product = todynamic((parse_json(tostring(AdditionalData.alertProductNames))[0]))\\r\\n| extend Tags = extract_all('labelName\\\":\\\"(.*?)\\\"',tostring(Labels))\\r\\n| extend Owner = case(tostring(Owner)==\\\"\\\", \\\"Unassigned\\\",tostring(Owner)), Products = strcat_array(AdditionalData.alertProductNames, \\\", \\\"), Alerts = tostring(AdditionalData.alertsCount), Bookmarks = tostring(AdditionalData.bookmarksCount), Comments = tostring(AdditionalData.commentsCount), Tactics = strcat_array(AdditionalData.tactics, \\\", \\\"), Labels = strcat_array(Tags, \\\", \\\")\\r\\n| mv-expand AlertIds to typeof(string)\\r\\n| join kind=inner \\r\\n(SecurityAlert | search Entities:EntityToCheck\\r\\n| summarize arg_max(TimeGenerated,AlertName, Description, AlertType, Entities) by SystemAlertId) on $left.AlertIds == $right.SystemAlertId\\r\\n| extend HoursAgo= datetime_diff('Hour',now(), TimeGenerated)\\r\\n| project AlertName, IncidentUrl, HoursAgo, TimeGenerated, Status, Severity, Owner, Entities, User= \\\"{EntityToCheckAnom}\\\"\\r\\n| order by TimeGenerated\\r\\n\\r\\n\\r\\n\",\"size\":1,\"title\":\"Incidents/ alerts overiew for user {EntityToCheckAnom}\",\"noDataMessage\":\"Couldn't find any incidents/ alerts for user\",\"noDataMessageStyle\":2,\"showExportToExcel\":true,\"exportToExcelOptions\":\"all\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{SAPWorkspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"AlertName\",\"formatter\":1},{\"columnMatch\":\"IncidentUrl\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"Url\",\"linkLabel\":\"Go to incident\"}},{\"columnMatch\":\"HoursAgo\",\"formatter\":5},{\"columnMatch\":\"TimeGenerated\",\"formatter\":6,\"dateFormat\":{\"formatName\":\"shortDateTimePattern\"}},{\"columnMatch\":\"Severity\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"High\",\"representation\":\"Sev0\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Medium\",\"representation\":\"Sev2\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Low\",\"representation\":\"1\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":\"\",\"representation\":\"Unavailable\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"Entities\",\"formatter\":5}],\"labelSettings\":[{\"columnId\":\"AlertName\",\"label\":\"Alert name\"},{\"columnId\":\"IncidentUrl\",\"label\":\"Incident URL\"},{\"columnId\":\"TimeGenerated\",\"label\":\"Created on\"}]}},\"customWidth\":\"70\",\"conditionalVisibility\":{\"parameterName\":\"EntityToCheck\",\"comparison\":\"isNotEqualTo\",\"value\":\" \"},\"showPin\":true,\"name\":\"query - 1\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let starttime = todatetime({TimeRange:start});\\r\\nlet endtime = todatetime({TimeRange:end});\\r\\nlet lookback = totimespan((endtime-starttime)*7);\\r\\n\\r\\nlet auditLookback = starttime - 14d;\\r\\n\\r\\n// User Granted Access and Grants others Access\\r\\n\\r\\nlet opName = dynamic([\\\"Add user\\\", \\\"Invite external user\\\"]);\\r\\n// Helper function to extract relevant fields from AuditLog events\\r\\nlet auditLogEvents = view (startTimeSpan: timespan, operation: dynamic) {\\r\\n    AuditLogs\\r\\n    | where TimeGenerated >= auditLookback\\r\\n    | where OperationName in~ (operation)\\r\\n    | extend ModProps = iff(TargetResources.[0].modifiedProperties != \\\"[]\\\", TargetResources.[0].modifiedProperties, todynamic(\\\"NoValues\\\"))\\r\\n    | extend IpAddress = iff(isnotempty(tostring(parse_json(tostring(InitiatedBy.user)).ipAddress)), \\r\\n        tostring(parse_json(tostring(InitiatedBy.user)).ipAddress), tostring(parse_json(tostring(InitiatedBy.app)).ipAddress))\\r\\n    | extend InitiatedByFull = iff(isnotempty(tostring(parse_json(tostring(InitiatedBy.user)).userPrincipalName)), \\r\\n        tostring(parse_json(tostring(InitiatedBy.user)).userPrincipalName), tostring(parse_json(tostring(InitiatedBy.app)).displayName))\\r\\n    | extend InitiatedBy = replace(\\\"_\\\", \\\"@\\\", tostring(split(InitiatedByFull, \\\"#\\\")[0]))\\r\\n    | extend TargetUserPrincipalName = tostring(TargetResources[0].userPrincipalName)\\r\\n    | extend TargetUserName = replace(\\\"_\\\", \\\"@\\\", tostring(split(TargetUserPrincipalName, \\\"#\\\")[0]))\\r\\n    | extend TargetResourceName = case(\\r\\n        isempty(tostring(TargetResources.[0].displayName)), TargetUserPrincipalName,\\r\\n        isnotempty(tostring(TargetResources.[0].displayName)) and tostring(TargetResources.[0].displayName) startswith \\\"upn:\\\", tolower(tostring(TargetResources.[0].displayName)),\\r\\n        tolower(tostring(TargetResources.[0].displayName))\\r\\n        )\\r\\n    | extend TargetUserName = replace(\\\"_\\\", \\\"@\\\", tostring(split(TargetUserPrincipalName, \\\"#\\\")[0]))\\r\\n    | extend TargetUserName = iff(isempty(TargetUserName), tostring(split(split(TargetResourceName, \\\",\\\")[0], \\\" \\\")[1]), TargetUserName) \\r\\n    | mvexpand ModProps\\r\\n    | extend\\r\\n        PropertyName = tostring(ModProps.displayName),\\r\\n        newValue = replace('\\\\\\\"', '', tostring(ModProps.newValue));\\r\\n};\\r\\n// Assigning time for First TargetUserName that was added\\r\\nlet FirstAdd = auditLogEvents(auditLookback, opName)  \\r\\n    | project FirstAddTimeUtc = TimeGenerated, Type, FirstInitiatedBy = InitiatedBy, IpAddress, FirstTargetUserName = TargetUserName, FirstTargetResourceName = TargetResourceName, \\r\\n        FirstOperationName = OperationName, FirstPropertyName = PropertyName, FirstnewValue = newValue, FirstCorrelationId = CorrelationId, FirstId = Id;\\r\\n// Assigning time for second TargetUserName that was added, which will allow us to see if a first TargetUserName added in is the Initiated by on the second in the later join\\r\\nlet SecondAdd = auditLogEvents(auditLookback, opName)  \\r\\n    | project SecondAddTimeUtc = TimeGenerated, Type, SecondInitiatedBy = InitiatedBy, IpAddress, SecondTargetUserName = TargetUserName, SecondTargetResourceName = TargetResourceName, \\r\\n        SecondOperationName = OperationName, SecondPropertyName = PropertyName, SecondnewValue = newValue, SecondCorrelationId = CorrelationId, SecondId = Id;\\r\\n//  Joining the FirstAdd with SecondAdd where the FirstAdd TargetUserName value matches the SecondAdd InitiatedBy.  This shows the new user adding a user.\\r\\nlet NewUserAddsUser = FirstAdd\\r\\n    | join SecondAdd on $left.FirstTargetUserName == $right.SecondInitiatedBy\\r\\n    // we only want items where the FirstAddTimeUtc is before the SecondAddTimeUtc\\r\\n    | where FirstAddTimeUtc < SecondAddTimeUtc\\r\\n;\\r\\n// Build out some of the properties for context\\r\\nlet UserGrantedGrants=(NewUserAddsUser\\r\\n| extend\\r\\n    FirstnewValue = split(FirstnewValue, \\\";\\\"),\\r\\n    SecondnewValue = split(SecondnewValue, \\\";\\\")\\r\\n| extend PropertyUpdate = pack(FirstPropertyName, FirstnewValue, SecondPropertyName, SecondnewValue, \\\"FirstCorrelationId\\\", FirstCorrelationId, \\\"FirstId\\\", FirstId, \\\"SecondCorrelationId\\\", SecondCorrelationId, \\\"SecondId\\\", SecondId)\\r\\n| summarize PropertyUpdateSet = make_bag(PropertyUpdate)\\r\\n    by FirstAddTimeUtc, FirstInitiatedBy, FirstTargetUserName, SecondAddTimeUtc, SecondInitiatedBy, SecondTargetUserName, \\r\\n    IpAddress, FirstTargetResourceName, SecondTargetResourceName, FirstOperationName, SecondOperationName\\r\\n| extend\\r\\n    timestamp = FirstAddTimeUtc,\\r\\n    AccountCustomEntity = FirstInitiatedBy,\\r\\n    HostCustomEntity = FirstTargetResourceName,\\r\\n    IPCustomEntity = IpAddress\\r\\n    | extend UserPrincipalName= SecondTargetUserName)\\r\\n    | extend Risk= 'User Granted Access and Grants others Access';\\r\\n\\r\\n// Anomalous sign-in location by user account and authenticating application - with sign-in details\\r\\nlet AnomalSiginLocAuth= (SigninLogs \\r\\n| where TimeGenerated  > starttime\\r\\n| extend  locationString= strcat(tostring(LocationDetails[\\\"countryOrRegion\\\"]), \\\"/\\\", \\r\\ntostring(LocationDetails[\\\"state\\\"]), \\\"/\\\", tostring(LocationDetails[\\\"city\\\"]), \\\";\\\") \\r\\n| project TimeGenerated, AppDisplayName , UserPrincipalName, locationString \\r\\n// Create time series \\r\\n| make-series dLocationCount = dcount(locationString) on TimeGenerated step 1d \\r\\nby UserPrincipalName, AppDisplayName \\r\\n// Compute best fit line for each entry \\r\\n| extend (RSquare,Slope,Variance,RVariance,Interception,LineFit)=series_fit_line(dLocationCount) \\r\\n// Chart the 3 most interesting lines  \\r\\n// A 0-value slope corresponds to an account being completely stable over time for a given Azure Active Directory application\\r\\n| top 3 by Slope desc  \\r\\n// Extract the set of locations for each top user:\\r\\n| join kind=inner (SigninLogs\\r\\n| extend  locationString= strcat(tostring(LocationDetails[\\\"countryOrRegion\\\"]), \\\"/\\\", \\r\\ntostring(LocationDetails[\\\"state\\\"]), \\\"/\\\", tostring(LocationDetails[\\\"city\\\"]), \\\";\\\")\\r\\n| summarize locationList = makeset(locationString), threeDayWindowLocationCount=dcount(locationString) by AppDisplayName, UserPrincipalName, \\r\\ntimerange=bin(TimeGenerated, 3d)) on AppDisplayName, UserPrincipalName\\r\\n| order by UserPrincipalName, timerange asc\\r\\n| project timerange, AppDisplayName , UserPrincipalName, threeDayWindowLocationCount, locationList \\r\\n| order by AppDisplayName, UserPrincipalName, timerange asc\\r\\n| extend timestamp = timerange, AccountCustomEntity = UserPrincipalName)\\r\\n| extend Risk= 'Anomalous sign-in location by user account and authenticating application';\\r\\n\\r\\n\\r\\n// Failed service logon attempt by user account with available AuditData\\r\\nlet failLimit = 10;\\r\\nlet ipLimit = 3;\\r\\nlet failedSignins = SigninLogs\\r\\n| where TimeGenerated between(starttime..endtime)\\r\\n| where ResultType != \\\"0\\\" and AppDisplayName != \\\"Windows Sign In\\\"\\r\\n| extend UserPrincipalName = tolower(UserPrincipalName)\\r\\n| extend CityState = strcat(tostring(LocationDetails.city),\\\"|\\\", tostring(LocationDetails.state))\\r\\n| extend Result = strcat(ResultType,\\\"-\\\",ResultDescription)\\r\\n| summarize StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated), DistinctIPAddressCount = dcount(IPAddress), IPAddresses = makeset(IPAddress),\\r\\nCityStates = makeset(CityState), DistinctResultCount = dcount(Result), Results = makeset(Result), AppDisplayNames = makeset(AppDisplayName),\\r\\nFailedLogonCount = count() by Type, OperationName, Category, UserPrincipalName = tolower(UserPrincipalName), ClientAppUsed, Location, CorrelationId\\r\\n| project Type, StartTimeUtc, EndTimeUtc, OperationName, Category, UserPrincipalName, AppDisplayNames, DistinctIPAddressCount, IPAddresses, DistinctResultCount,\\r\\nResults, FailedLogonCount, Location, CityStates\\r\\n| where FailedLogonCount >= failLimit or DistinctIPAddressCount >= ipLimit\\r\\n| extend Activity = pack(\\\"IPAddresses\\\", IPAddresses, \\\"AppDisplayNames\\\", AppDisplayNames, \\\"Results\\\", Results, \\\"Location\\\", Location, \\\"CityStates\\\", CityStates)\\r\\n| project Type, StartTimeUtc, EndTimeUtc, OperationName, Category, UserPrincipalName, FailedLogonCount, DistinctIPAddressCount, DistinctResultCount, Activity\\r\\n| extend AccountCustomEntity = UserPrincipalName;\\r\\nlet accountMods = AuditLogs | where TimeGenerated >= auditLookback\\r\\n| where Category == \\\"UserManagement\\\" or Category == \\\"GroupManagement\\\"\\r\\n| extend ModProps = TargetResources.[0].modifiedProperties\\r\\n| extend InitiatedBy = case(\\r\\nisnotempty(tostring(parse_json(tostring(InitiatedBy.user)).userPrincipalName)), tostring(parse_json(tostring(InitiatedBy.user)).userPrincipalName),\\r\\nisnotempty(tostring(parse_json(tostring(InitiatedBy.app)).displayName)), tostring(parse_json(tostring(InitiatedBy.app)).displayName),\\r\\n\\\"\\\")\\r\\n| extend UserPrincipalName = tolower(tostring(TargetResources.[0].userPrincipalName))\\r\\n| mvexpand ModProps\\r\\n| extend PropertyName = tostring(ModProps.displayName), oldValue = tostring(ModProps.oldValue), newValue = tostring(ModProps.newValue)\\r\\n| extend ModifiedProps = pack(\\\"PropertyName\\\",PropertyName,\\\"oldValue\\\",oldValue,\\\"newValue\\\",newValue)\\r\\n| summarize StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated), Activity = make_bag(ModifiedProps) by Type, InitiatedBy, UserPrincipalName, Category, OperationName, CorrelationId, Id\\r\\n| extend AccountCustomEntity = UserPrincipalName, timestamp= StartTimeUtc;\\r\\n// Gather only Audit data for UserPrincipalNames that we have Audit data for\\r\\nlet accountNameOnly = failedSignins | project UserPrincipalName;\\r\\nlet auditMods = accountNameOnly\\r\\n| join kind= innerunique (\\r\\naccountMods\\r\\n) on UserPrincipalName;\\r\\nlet availableAudits = auditMods | project UserPrincipalName;\\r\\nlet signinsWithAudit = availableAudits\\r\\n| join kind= innerunique (\\r\\nfailedSignins\\r\\n) on UserPrincipalName;\\r\\n// Union the Current Signin failures so we do not lose them with the Auditing data we do have\\r\\nlet activity = (union isfuzzy=true\\r\\nsigninsWithAudit, auditMods)\\r\\n| order by StartTimeUtc, UserPrincipalName;\\r\\n\\r\\nlet FailedServiceLogon= (activity\\r\\n| project StartTimeUtc, EndTimeUtc, DataType = Type, Category, OperationName, UserPrincipalName, InitiatedBy, Activity, FailedLogonCount, DistinctIPAddressCount, DistinctResultCount, CorrelationId, Id\\r\\n| order by UserPrincipalName, StartTimeUtc\\r\\n| extend timestamp = StartTimeUtc, AccountCustomEntity = UserPrincipalName)\\r\\n| extend Risk= 'Failed service logon attempt by user account with available AuditData';\\r\\n\\r\\nUserGrantedGrants | union AnomalSiginLocAuth, FailedServiceLogon\\r\\n| where UserPrincipalName =~ \\\"{EntityToCheck}\\\" or FirstInitiatedBy=~ \\\"{EntityToCheck}\\\" or FirstTargetUserName=~ \\\"{EntityToCheck}\\\" or SecondInitiatedBy=~ \\\"{EntityToCheck}\\\" or SecondTargetUserName=~ \\\"{EntityToCheck}\\\"\\r\\n| project Risk, timestamp, ExtendedDetails= pack_all(true)\\r\\n| order by Risk\\r\\n\",\"size\":1,\"title\":\"Azure audit and sigin risks for user {EntityToCheckAnom}\",\"noDataMessage\":\"No Azure AD and SignIns anomalies found\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{ADWorkspace}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"$gen_group\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"155ch\"}},{\"columnMatch\":\"Risk\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"300ch\"}},{\"columnMatch\":\"timestamp\",\"formatter\":6,\"dateFormat\":{\"formatName\":\"shortDateTimePattern\"}},{\"columnMatch\":\"ExtendedDetails\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"300ch\"}},{\"columnMatch\":\"$gen_group\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"155ch\"}}],\"filter\":true,\"hierarchySettings\":{\"treeType\":1,\"groupBy\":[\"Risk\",\"ExtendedDetails\"],\"expandTopLevel\":false},\"labelSettings\":[{\"columnId\":\"timestamp\",\"label\":\"Date and time\"},{\"columnId\":\"ExtendedDetails\",\"label\":\"Extended details\"}]}},\"conditionalVisibility\":{\"parameterName\":\"EntityToCheck\",\"comparison\":\"isNotEqualTo\",\"value\":\" \"},\"showPin\":false,\"name\":\"Azure AD risks\"}]},\"name\":\"Event anomalies\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let SelectedSystems= SAPSystems(SelectedSystemRoles=dynamic(\\\"{SystemRoles}\\\")\\n, SelectedSystems=todynamic(\\\"[{Systems}]\\\")\\n, SelectedSystemUsage= dynamic(\\\"{SystemUsage}\\\")) | project SystemID, SystemRole;\\nlet TimeStep= 4h;\\nlet SelectedSeverities=  dynamic([\\\"High\\\", \\\"Medium\\\"]);//can also do//let SelectedSeverities =  dynamic([\\\"All Severities\\\"])\\nlet SelectedRuleTypes= dynamic([ \\\"Deterministic\\\", \\\"AnomaliesOnly\\\"]); // Rule only goes for deterministic alerting\\nlet AuditConfiguration= materialize(SAPAuditLogConfiguration(SelectedSeverities= SelectedSeverities, SelectedRuleTypes= SelectedRuleTypes)\\n| where SystemID in((SelectedSystems | project SystemID))\\n| project MessageID, SystemID, RolesTagsToExclude, Severity, Threshold, RuleType);\\n// get special users for exclusion and in-focus analysis\\nlet SAPUsersGottenVIP = (SAPUsersGetVIP | project User = SAPUser, TagsList, SpecialFocusTagged);\\nlet SAPUserRolesAndProfiles = (SAPUsersAssignments | project-keep User, SystemID, DirectRoles, ChildRoles, Profiles | summarize RolesAndProfiles = make_set(array_concat(DirectRoles, ChildRoles, Profiles), 120) by User, SystemID);\\nlet RelevantEvents =SAPAuditLog\\n| where SystemID in((SelectedSystems | project SystemID))\\n| where isnotempty( User)\\n| where AlertSeverityText != \\\"Low\\\"\\n| where MessageID in ((AuditConfiguration | summarize count() by MessageID))\\n| lookup kind=inner (AuditConfiguration| project SystemID, MessageID, Severity, Threshold  ) on\\n$left.MessageID == $right.MessageID\\n,$left.SystemID == $right.SystemID\\n| where SelectedSeverities contains Severity\\n| make-series AuditEventsCounts= count() default=0 on TimeGenerated from startofday({TimeRange:start}) to {TimeRange:end} \\nstep TimeStep by SystemID, MessageID, User, Threshold;\\nRelevantEvents \\n| extend crossedThreshold= series_greater(AuditEventsCounts, repeat(Threshold* TimeStep/1h, array_length(AuditEventsCounts)) )\\n| where array_sum(crossedThreshold) > 0\\n| extend crossedThreshold = array_iif(crossedThreshold,repeat(1, array_length(AuditEventsCounts)) , repeat(0, array_length(AuditEventsCounts)))\\n| lookup SAPUsersGottenVIP on User\\n| lookup SAPUserRolesAndProfiles on User, SystemID\\n| lookup (AuditConfiguration | project-keep SystemID, MessageID, RuleType, RolesTagsToExclude,  Severity) on MessageID, SystemID\\n| extend RolesProfilesAndTags = array_concat(RolesAndProfiles, TagsList)\\n| extend TagsIntersect = set_intersect(split(RolesTagsToExclude,\\\";\\\"), RolesProfilesAndTags)\\n| extend IntersectionSize = array_length(TagsIntersect)\\n// keep only non-excluded users that are not under \\\"Special Focus\\\"\\n| where IntersectionSize == 0 or isempty(IntersectionSize) or SpecialFocusTagged == true\\n| extend Anomalies= series_decompose_anomalies(AuditEventsCounts, Threshold=4, Test_point= 1)\\n| extend Anomaly= array_index_of(Anomalies,1)>= 0\\n| extend AnomalSeriesIndicator = iff(RuleType==\\\"Deterministic\\\", \\\"Deterministic threshold crossed\\\", iff(Anomaly, 'Anomalous audit event', 'Normal audit event'))\\n| mv-expand Anomalies to typeof(double), TimeGenerated to typeof(datetime), crossedThreshold to typeof(int )\\n| where (crossedThreshold > 0) and (( RuleType==\\\"Deterministic\\\") or ( RuleType== \\\"AnomaliesOnly\\\" and (Anomalies > 0 or \\\"{AuditEventsType}\\\" contains \\\"All\\\")))\\n| summarize SuspiciousScore= floor((countif(Severity==\\\"High\\\") + countif(Severity==\\\"Medium\\\")*0.5),1) by SystemID\\n| join kind= fullouter (RelevantEvents | summarize ActivityScore= count() by SystemID) on SystemID\\n| lookup SelectedSystems on SystemID\\n| extend SystemRole= iff(isempty(SystemRole), 'Misconfigured Systems',SystemRole)\\n| extend RiskScore = floor(100*(SuspiciousScore/ ActivityScore),1)\\n| project SystemID= SystemID1, SystemRole, SuspiciousScore, ActivityScore, RiskScore\\n| extend SAPUserToCheckAlerts = 'No User Selected'\\n| extend SystemID2= iff({DemoMode}, substring(hash_sha1(SystemID), 0, 3), SystemID)\\n\\n\\n\\n\\n\\n\\n\\n\",\"size\":3,\"showAnalytics\":true,\"title\":\"Risk score per system- select a system to search for events\",\"timeContextFromParameter\":\"TimeRange\",\"timeBrushParameterName\":\"BrushedTimeRange\",\"timeBrushExportOnlyWhenBrushed\":true,\"exportedParameters\":[{\"fieldName\":\"SystemID\",\"parameterName\":\"SystemIDFromHiveAlerts\",\"defaultValue\":\"'All Systems'\"},{\"fieldName\":\"SAPUserToCheckAlerts\",\"parameterName\":\"SAPUserToCheckAlerts\",\"parameterType\":1,\"defaultValue\":\"'No User Selected'\"},{\"fieldName\":\"SystemID2\",\"parameterName\":\"SystemID2FromHiveAlerts\",\"parameterType\":1,\"defaultValue\":\"'All Systems'\"}],\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{SAPWorkspace}\"],\"visualization\":\"graph\",\"sortBy\":[],\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"ResultText\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"dcount_CorrelationId\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}},\"graphSettings\":{\"type\":2,\"topContent\":{\"columnMatch\":\"SystemID2\",\"formatter\":12,\"formatOptions\":{\"palette\":\"blue\"}},\"centerContent\":{\"columnMatch\":\"SuspiciousScore\",\"formatter\":1,\"tooltipFormat\":{\"tooltip\":\"Number of unique failing users {0}\"}},\"bottomContent\":{\"columnMatch\":\"RiskScore\",\"formatter\":1,\"tooltipFormat\":{\"tooltip\":\"Rate of logon failure {0} %\"}},\"hivesContent\":{\"columnMatch\":\"SystemRole\",\"formatter\":12,\"formatOptions\":{\"palette\":\"blue\"}},\"nodeIdField\":\"SystemID\",\"sourceIdField\":\"SystemRole\",\"targetIdField\":\"SystemID\",\"graphOrientation\":3,\"showOrientationToggles\":false,\"nodeSize\":\"\",\"staticNodeSize\":70,\"colorSettings\":{\"nodeColorField\":\"RiskScore\",\"type\":4,\"heatmapPalette\":\"greenRed\",\"heatmapMin\":\"\",\"heatmapMax\":\"\",\"emptyValueColor\":\"green\"},\"groupByField\":\"SystemRole\",\"hivesMargin\":5},\"chartSettings\":{\"xAxis\":\"TimeGenerated\",\"yAxis\":[\"Count\"],\"group\":\"MessageClass\",\"createOtherGroup\":\"\",\"showLegend\":true},\"mapSettings\":{\"locInfo\":\"LatLong\",\"sizeSettings\":\"UniqueUsers\",\"sizeAggregation\":\"Sum\",\"legendMetric\":\"UniqueUsers\",\"legendAggregation\":\"Sum\",\"itemColorSettings\":{\"type\":\"heatmap\",\"colorAggregation\":\"Sum\",\"nodeColorField\":\"UniqueUsers\",\"heatmapPalette\":\"greenRed\"}}},\"customWidth\":\"100\",\"name\":\"SuccessFailurebyRole\",\"styleSettings\":{\"maxWidth\":\"100\",\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"\\r\\nlet SelectedSystems= SAPSystems(SelectedSystemRoles=dynamic(\\\"{SystemRoles}\\\")\\r\\n, SelectedSystems=todynamic(\\\"[{Systems}]\\\")\\r\\n, SelectedSystemUsage= dynamic(\\\"{SystemUsage}\\\")) | project SystemID, SystemRole;\\r\\nlet TimeStep= 4h;\\r\\nlet SelectedSeverities=  dynamic([\\\"High\\\", \\\"Medium\\\"]);//can also do//let SelectedSeverities =  dynamic([\\\"All Severities\\\"])\\r\\nlet SelectedRuleTypes= dynamic([ \\\"Deterministic\\\", \\\"AnomaliesOnly\\\"]); // Rule only goes for deterministic alerting\\r\\nlet AuditConfiguration= materialize(SAPAuditLogConfiguration(SelectedSeverities= SelectedSeverities, SelectedRuleTypes= SelectedRuleTypes)\\r\\n| where SystemID in((SelectedSystems | project SystemID))\\r\\n| project MessageID, SystemID, RolesTagsToExclude, Severity, Threshold, RuleType, CategoryName, DetailedDescription);\\r\\n// get special users for exclusion and in-focus analysis\\r\\nlet SAPUsersGottenVIP = (SAPUsersGetVIP | project User = SAPUser, TagsList, SpecialFocusTagged);\\r\\nlet SAPUserRolesAndProfiles = (SAPUsersAssignments | project-keep User, SystemID, DirectRoles, ChildRoles, Profiles | summarize RolesAndProfiles = make_set(array_concat(DirectRoles, ChildRoles, Profiles), 120) by User, SystemID);\\r\\nlet UsersEmail= SAPUsersEmail\\r\\n| summarize Email= make_set_if(Email,  Email contains_cs \\\"@\\\", 10)[0] by User;\\r\\nlet RelevantEvents =SAPAuditLog\\r\\n| where SystemID == \\\"{SystemIDFromHiveAlerts}\\\"\\r\\n| where isnotempty( User)\\r\\n| where AlertSeverityText != \\\"Low\\\"\\r\\n| where MessageID in ((AuditConfiguration | summarize count() by MessageID))\\r\\n| lookup kind=inner (AuditConfiguration| project SystemID, MessageID, Severity, Threshold  ) on\\r\\n$left.MessageID == $right.MessageID\\r\\n,$left.SystemID == $right.SystemID\\r\\n| where SelectedSeverities contains Severity\\r\\n| make-series AuditEventsCounts= count() default=0 on TimeGenerated from startofday({TimeRange:start}) to {TimeRange:end} \\r\\nstep TimeStep by SystemID, MessageID, User, Threshold;\\r\\nRelevantEvents \\r\\n| extend crossedThreshold= series_greater(AuditEventsCounts, repeat(Threshold* TimeStep/1h, array_length(AuditEventsCounts)) )\\r\\n| where array_sum(crossedThreshold) > 0\\r\\n| extend crossedThreshold = array_iif(crossedThreshold,repeat(1, array_length(AuditEventsCounts)) , repeat(0, array_length(AuditEventsCounts)))\\r\\n| lookup SAPUsersGottenVIP on User\\r\\n| lookup SAPUserRolesAndProfiles on User, SystemID\\r\\n| lookup (AuditConfiguration | project-keep SystemID, MessageID, RuleType, RolesTagsToExclude,  Severity) on MessageID, SystemID\\r\\n| extend RolesProfilesAndTags = array_concat(RolesAndProfiles, TagsList)\\r\\n| extend TagsIntersect = set_intersect(split(RolesTagsToExclude,\\\";\\\"), RolesProfilesAndTags)\\r\\n| extend IntersectionSize = array_length(TagsIntersect)\\r\\n// keep only non-excluded users that are not under \\\"Special Focus\\\"\\r\\n| where IntersectionSize == 0 or isempty(IntersectionSize) or SpecialFocusTagged == true\\r\\n| extend Anomalies= series_decompose_anomalies(AuditEventsCounts, Threshold=4, Test_point= 1)\\r\\n| extend Anomaly= array_index_of(Anomalies,1)>= 0\\r\\n| extend AnomalSeriesIndicator = iff(RuleType==\\\"Deterministic\\\", \\\"Deterministic threshold crossed\\\", iff(Anomaly, 'Anomalous audit event', 'Normal audit event'))\\r\\n| mv-expand Anomalies to typeof(double), TimeGenerated to typeof(datetime), crossedThreshold to typeof(int )\\r\\n| where (crossedThreshold > 0) and (( RuleType==\\\"Deterministic\\\") or ( RuleType== \\\"AnomaliesOnly\\\" and (Anomalies > 0 or \\\"{AuditEventsType}\\\" contains \\\"All\\\")))\\r\\n| project User, MessageID, StartOfDay= startofday( TimeGenerated)\\r\\n| join kind= rightsemi (RelevantEvents | project MessageID, User, TimeGenerated, AuditEventsCounts) on User, MessageID\\r\\n| lookup (AuditConfiguration | where SystemID == \\\"{SystemIDFromHiveAlerts}\\\") on MessageID\\r\\n| project User, AuditEventsCounts, Severity, CategoryName, DetailedDescription, ArraySum= array_sum(AuditEventsCounts)\\r\\n| lookup UsersEmail on User\\r\\n| extend Email = iff(isempty(Email), User, Email)\\r\\n| order by ArraySum desc\\r\\n| extend User= iff({DemoMode}, substring(hash_sha1(User), 0, 12), User)\\r\\n| extend Email= iff({DemoMode}, strcat(substring(hash_sha1(User), 0, 12), '@seccxpninja.onmicrosoft.com' ), Email)\\r\\n\\r\\n\\r\\n\\r\\n\\r\\n\",\"size\":0,\"showAnalytics\":true,\"title\":\"SAP events for system {SystemID2FromHiveAlerts}- click a line to search for relevant incidents\",\"noDataMessage\":\"No events found the selected system\",\"noDataMessageStyle\":2,\"timeContextFromParameter\":\"TimeRange\",\"exportFieldName\":\"Email\",\"exportParameterName\":\"SAPUserToCheckAlerts\",\"exportDefaultValue\":\"'No User Selected'\",\"showExportToExcel\":true,\"exportToExcelOptions\":\"all\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{SAPWorkspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"User\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"Default\",\"thresholdValue\":\"\",\"representation\":\"Person\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"AuditEventsCounts\",\"formatter\":9,\"formatOptions\":{\"palette\":\"red\"}},{\"columnMatch\":\"Severity\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"High\",\"representation\":\"Sev1\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Medium\",\"representation\":\"Sev2\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":\"\",\"representation\":\"success\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"ArraySum\",\"formatter\":5}],\"filter\":true,\"labelSettings\":[{\"columnId\":\"AuditEventsCounts\",\"label\":\"Event trend\"},{\"columnId\":\"CategoryName\",\"label\":\"Event category\"},{\"columnId\":\"DetailedDescription\",\"label\":\"Detailed Description\"},{\"columnId\":\"Email\",\"label\":\"User Email\"}]}},\"customWidth\":\"80\",\"conditionalVisibility\":{\"parameterName\":\"SystemIDFromHiveAlerts\",\"comparison\":\"isNotEqualTo\",\"value\":\"'All Systems'\"},\"name\":\"EventsUsersperSystem\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let EntityToCheck= \\\"{SAPUserToCheckAlerts}\\\";\\r\\nlet EmptySet= datatable(AlertName:string) [\\\"No incidents found\\\"];\\r\\nSecurityIncident\\r\\n| summarize arg_max(TimeGenerated,CreatedTime,Status, Severity, Owner, AdditionalData, IncidentUrl, Comments, Classification,ClassificationReason, ClassificationComment,Labels, Title, AlertIds) by IncidentNumber\\r\\n| where array_length(AlertIds) > 0\\r\\n| extend Tactics = todynamic(AdditionalData.tactics)\\r\\n| extend Owner = todynamic(Owner.assignedTo), IncidentCreated = format_datetime(CreatedTime,'yy-MM-dd HH:mm')\\r\\n| extend Product = todynamic((parse_json(tostring(AdditionalData.alertProductNames))[0]))\\r\\n| extend Tags = extract_all('labelName\\\":\\\"(.*?)\\\"',tostring(Labels))\\r\\n| extend Owner = case(tostring(Owner)==\\\"\\\", \\\"Unassigned\\\",tostring(Owner)), Products = strcat_array(AdditionalData.alertProductNames, \\\", \\\"), Alerts = tostring(AdditionalData.alertsCount), Bookmarks = tostring(AdditionalData.bookmarksCount), Comments = tostring(AdditionalData.commentsCount), Tactics = strcat_array(AdditionalData.tactics, \\\", \\\"), Labels = strcat_array(Tags, \\\", \\\")\\r\\n| mv-expand AlertIds to typeof(string)\\r\\n| join kind=inner \\r\\n(SecurityAlert | search Entities:EntityToCheck\\r\\n| summarize arg_max(TimeGenerated,AlertName, Description, AlertType, Entities) by SystemAlertId) on $left.AlertIds == $right.SystemAlertId\\r\\n| extend HoursAgo= datetime_diff('Hour',now(), TimeGenerated)\\r\\n| project AlertName, IncidentUrl, HoursAgo, TimeGenerated, Status, Severity, Owner, Entities, User= EntityToCheck\\r\\n| order by TimeGenerated\\r\\n\\r\\n\",\"size\":0,\"title\":\"Incidents/ alerts overiew for user {SAPUserToCheckAlerts}\",\"noDataMessage\":\"Couldn't find any incidents/ alerts for user\",\"noDataMessageStyle\":2,\"showExportToExcel\":true,\"exportToExcelOptions\":\"all\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{SAPWorkspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"AlertName\",\"formatter\":1},{\"columnMatch\":\"IncidentUrl\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"Url\",\"linkLabel\":\"Go to incident\"}},{\"columnMatch\":\"HoursAgo\",\"formatter\":5},{\"columnMatch\":\"TimeGenerated\",\"formatter\":6,\"dateFormat\":{\"formatName\":\"shortDateTimePattern\"}},{\"columnMatch\":\"Severity\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"High\",\"representation\":\"Sev0\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Medium\",\"representation\":\"Sev2\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Low\",\"representation\":\"1\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":\"\",\"representation\":\"Unavailable\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"Entities\",\"formatter\":5}],\"labelSettings\":[{\"columnId\":\"AlertName\",\"label\":\"Alert name\"},{\"columnId\":\"IncidentUrl\",\"label\":\"Incident URL\"},{\"columnId\":\"TimeGenerated\",\"label\":\"Created on\"}]}},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"SAPUserToCheckAlerts\",\"comparison\":\"isNotEqualTo\",\"value\":\"'No User Selected'\"},\"showPin\":true,\"name\":\"query - 1\"}]},\"customWidth\":\"100\",\"name\":\"group events drill\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let SelectedSystems= SAPSystems(SelectedSystemRoles=dynamic(\\\"{SystemRoles}\\\")\\n, SelectedSystems=todynamic(\\\"[{Systems}]\\\")\\n, SelectedSystemUsage= dynamic(\\\"{SystemUsage}\\\")) | project SystemID, SystemRole;\\nlet TimeStep= 4h;\\nlet SelectedSeverities=  dynamic([\\\"High\\\", \\\"Medium\\\"]);//can also do//let SelectedSeverities =  dynamic([\\\"All Severities\\\"])\\nlet SelectedRuleTypes= dynamic([ \\\"Deterministic\\\", \\\"AnomaliesOnly\\\"]); // Rule only goes for deterministic alerting\\nlet AuditConfiguration= materialize(SAPAuditLogConfiguration(SelectedSeverities= SelectedSeverities, SelectedRuleTypes= SelectedRuleTypes)\\n| where SystemID in((SelectedSystems | project SystemID))\\n| project MessageID, SystemID, RolesTagsToExclude, Severity, Threshold, RuleType, Tactics);\\n// get special users for exclusion and in-focus analysis\\nlet SAPUsersGottenVIP = (SAPUsersGetVIP | project User = SAPUser, TagsList, SpecialFocusTagged);\\nlet SAPUserRolesAndProfiles = (SAPUsersAssignments | project-keep User, SystemID, DirectRoles, ChildRoles, Profiles | summarize RolesAndProfiles = make_set(array_concat(DirectRoles, ChildRoles, Profiles), 120) by User, SystemID);\\nlet RelevantEvents =SAPAuditLog\\n| where SystemID in((SelectedSystems | project SystemID))\\n| where isnotempty( User)\\n| where AlertSeverityText != \\\"Low\\\"\\n| where MessageID in ((AuditConfiguration | summarize count() by MessageID))\\n| lookup kind=inner (AuditConfiguration| project SystemID, MessageID, Severity, Threshold  ) on\\n$left.MessageID == $right.MessageID\\n,$left.SystemID == $right.SystemID\\n| where SelectedSeverities contains Severity\\n| make-series AuditEventsCounts= count() default=0 on TimeGenerated from startofday({TimeRange:start}) to {TimeRange:end} \\nstep TimeStep by SystemID, MessageID, User, Threshold;\\nRelevantEvents \\n| extend crossedThreshold= series_greater(AuditEventsCounts, repeat(Threshold* TimeStep/1h, array_length(AuditEventsCounts)) )\\n| where array_sum(crossedThreshold) > 0\\n| extend crossedThreshold = array_iif(crossedThreshold,repeat(1, array_length(AuditEventsCounts)) , repeat(0, array_length(AuditEventsCounts)))\\n| lookup SAPUsersGottenVIP on User\\n| lookup SAPUserRolesAndProfiles on User, SystemID\\n| lookup (AuditConfiguration | project-keep SystemID, MessageID, RuleType, RolesTagsToExclude,  Severity) on MessageID, SystemID\\n| extend RolesProfilesAndTags = array_concat(RolesAndProfiles, TagsList)\\n| extend TagsIntersect = set_intersect(split(RolesTagsToExclude,\\\";\\\"), RolesProfilesAndTags)\\n| extend IntersectionSize = array_length(TagsIntersect)\\n// keep only non-excluded users that are not under \\\"Special Focus\\\"\\n| where IntersectionSize == 0 or isempty(IntersectionSize) or SpecialFocusTagged == true\\n| extend Anomalies= series_decompose_anomalies(AuditEventsCounts, Threshold=4, Test_point= 1)\\n| extend Anomaly= array_index_of(Anomalies,1)>= 0\\n| extend AnomalSeriesIndicator = iff(RuleType==\\\"Deterministic\\\", \\\"Deterministic threshold crossed\\\", iff(Anomaly, 'Anomalous audit event', 'Normal audit event'))\\n| mv-expand Anomalies to typeof(double), TimeGenerated to typeof(datetime), crossedThreshold to typeof(int )\\n| where (crossedThreshold > 0) and (( RuleType==\\\"Deterministic\\\") or ( RuleType== \\\"AnomaliesOnly\\\" and (Anomalies > 0 or \\\"{AuditEventsType}\\\" contains \\\"All\\\")))\\n| lookup (AuditConfiguration | project-keep SystemID, MessageID, Tactics) on MessageID, SystemID\\n// handle multiple tactics per event\\n| extend SeperatedTactics= split(replace_string(Tactics, \\\"; \\\", \\\";\\\"), \\\";\\\")\\n| mv-expand SeperatedTactics\\n// make sure first char of tactics is capitalized \\n| extend Tactics= strcat(toupper(substring(tostring(SeperatedTactics), 0,1)), substring(tostring(SeperatedTactics), 1)) \\n| extend Tactics= replace_string(Tactics, \\\"Nan\\\", \\\"\\\")\\n| summarize SuspiciousCount= floor((countif(Severity==\\\"High\\\") + countif(Severity==\\\"Medium\\\")*0.5),1) by Tactics\\n\\n\\n\\n\\n\\n\",\"size\":4,\"aggregation\":3,\"showAnalytics\":true,\"title\":\"Event by MITRE ATT&CK tactics\",\"timeContextFromParameter\":\"TimeRange\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{SAPWorkspace}\"],\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"Tactics\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"Credential Access\",\"representation\":\"Credential Access\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Initial Access\",\"representation\":\"Initial_Access\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Impact\",\"representation\":\"Impact\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Reconnaissance\",\"representation\":\"Discovery\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Exfiltration\",\"representation\":\"Exfiltration\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Lateral Movement\",\"representation\":\"Lateral_Movement\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Defense Evasion\",\"representation\":\"Defense Evasion\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Execution\",\"representation\":\"Execution\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Resource Development\",\"representation\":\"resource\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"impact\",\"representation\":\"Impact\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Privilege Escalation\",\"representation\":\"Privilege Escalation\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":\"\",\"representation\":\"1\",\"text\":\"{0}{1}\"}]}},\"leftContent\":{\"columnMatch\":\"SuspiciousCount\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":2,\"maximumSignificantDigits\":3}}},\"showBorder\":false,\"sortCriteriaField\":\"SuspiciousCount\",\"sortOrderField\":2,\"size\":\"auto\"},\"graphSettings\":{\"type\":0,\"topContent\":{\"columnMatch\":\"Tactics\",\"formatter\":1},\"centerContent\":{\"columnMatch\":\"SuspiciousCount\",\"formatter\":1,\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}},\"chartSettings\":{\"xAxis\":\"TimeGenerated\",\"yAxis\":[\"SuspiciousCount\"],\"group\":\"Tactics\",\"createOtherGroup\":\"\",\"showLegend\":true}},\"customWidth\":\"100\",\"name\":\"Events by MITRE ATT&CK tactics\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let SelectedSystems= SAPSystems(SelectedSystemRoles=dynamic(\\\"{SystemRoles}\\\")\\n, SelectedSystems=todynamic(\\\"[{Systems}]\\\")\\n, SelectedSystemUsage= dynamic(\\\"{SystemUsage}\\\")) | project SystemID, SystemRole;\\nlet TimeStep= 4h;\\nlet SelectedSeverities=  dynamic([\\\"High\\\", \\\"Medium\\\"]);//can also do//let SelectedSeverities =  dynamic([\\\"All Severities\\\"])\\nlet SelectedRuleTypes= dynamic([ \\\"Deterministic\\\", \\\"AnomaliesOnly\\\"]); // Rule only goes for deterministic alerting\\nlet AuditConfiguration= materialize(SAPAuditLogConfiguration(SelectedSeverities= SelectedSeverities, SelectedRuleTypes= SelectedRuleTypes)\\n| where SystemID in((SelectedSystems | project SystemID))\\n| project MessageID, SystemID, RolesTagsToExclude, Severity, Threshold, RuleType, CategoryName);\\n// get special users for exclusion and in-focus analysis\\nlet SAPUsersGottenVIP = (SAPUsersGetVIP | project User = SAPUser, TagsList, SpecialFocusTagged);\\nlet SAPUserRolesAndProfiles = (SAPUsersAssignments | project-keep User, SystemID, DirectRoles, ChildRoles, Profiles | summarize RolesAndProfiles = make_set(array_concat(DirectRoles, ChildRoles, Profiles), 120) by User, SystemID);\\nlet RelevantEvents =SAPAuditLog\\n| where SystemID in((SelectedSystems | project SystemID))\\n| where isnotempty( User)\\n| where AlertSeverityText != \\\"Low\\\"\\n| where MessageID in ((AuditConfiguration | summarize count() by MessageID))\\n| lookup kind=inner (AuditConfiguration| project SystemID, MessageID, Severity, Threshold  ) on\\n$left.MessageID == $right.MessageID\\n,$left.SystemID == $right.SystemID\\n| where SelectedSeverities contains Severity\\n| make-series AuditEventsCounts= count() default=0 on TimeGenerated from startofday({TimeRange:start}) to {TimeRange:end} \\nstep TimeStep by SystemID, MessageID, User, Threshold;\\nRelevantEvents \\n| extend crossedThreshold= series_greater(AuditEventsCounts, repeat(Threshold* TimeStep/1h, array_length(AuditEventsCounts)) )\\n| where array_sum(crossedThreshold) > 0\\n| extend crossedThreshold = array_iif(crossedThreshold,repeat(1, array_length(AuditEventsCounts)) , repeat(0, array_length(AuditEventsCounts)))\\n| lookup SAPUsersGottenVIP on User\\n| lookup SAPUserRolesAndProfiles on User, SystemID\\n| lookup (AuditConfiguration | project-keep SystemID, MessageID, RuleType, RolesTagsToExclude,  Severity) on MessageID, SystemID\\n| extend RolesProfilesAndTags = array_concat(RolesAndProfiles, TagsList)\\n| extend TagsIntersect = set_intersect(split(RolesTagsToExclude,\\\";\\\"), RolesProfilesAndTags)\\n| extend IntersectionSize = array_length(TagsIntersect)\\n// keep only non-excluded users that are not under \\\"Special Focus\\\"\\n| where IntersectionSize == 0 or isempty(IntersectionSize) or SpecialFocusTagged == true\\n| extend Anomalies= series_decompose_anomalies(AuditEventsCounts, Threshold=4, Test_point= 1)\\n| extend Anomaly= array_index_of(Anomalies,1)>= 0\\n| extend AnomalSeriesIndicator = iff(RuleType==\\\"Deterministic\\\", \\\"Deterministic threshold crossed\\\", iff(Anomaly, 'Anomalous audit event', 'Normal audit event'))\\n| mv-expand Anomalies to typeof(double), TimeGenerated to typeof(datetime), crossedThreshold to typeof(int )\\n| where (crossedThreshold > 0) and (( RuleType==\\\"Deterministic\\\") or ( RuleType== \\\"AnomaliesOnly\\\" and (Anomalies > 0 or \\\"{AuditEventsType}\\\" contains \\\"All\\\")))\\n| lookup (AuditConfiguration | project-keep SystemID, MessageID, CategoryName) on MessageID, SystemID\\n| summarize SuspiciousCount= floor((countif(Severity==\\\"High\\\") + countif(Severity==\\\"Medium\\\")*0.5),1) by CategoryName, TimeGenerated\\n\\n\\n\\n\\n\",\"size\":1,\"aggregation\":3,\"showAnalytics\":true,\"title\":\"Events by category\",\"timeContextFromParameter\":\"TimeRange\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{SAPWorkspace}\"],\"visualization\":\"areachart\",\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"ResultText\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"dcount_CorrelationId\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}},\"chartSettings\":{\"xAxis\":\"TimeGenerated\",\"yAxis\":[\"SuspiciousCount\"],\"group\":\"CategoryName\",\"createOtherGroup\":\"\"}},\"customWidth\":\"100\",\"name\":\"Events by category\",\"styleSettings\":{\"maxWidth\":\"100%\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let SelectedSystems= SAPSystems(SelectedSystemRoles=dynamic(\\\"{SystemRoles}\\\")\\n, SelectedSystems=todynamic(\\\"[{Systems}]\\\")\\n, SelectedSystemUsage= dynamic(\\\"{SystemUsage}\\\")) | project SystemID, SystemRole;\\nlet UserAssignments= SAPUsersAssignments() | project User, UserAuthGroup= UserGroupAuth;\\nlet TimeStep= 4h;\\nlet SelectedSeverities=  dynamic([\\\"High\\\", \\\"Medium\\\"]);//can also do//let SelectedSeverities =  dynamic([\\\"All Severities\\\"])\\nlet SelectedRuleTypes= dynamic([ \\\"Deterministic\\\", \\\"AnomaliesOnly\\\"]); // Rule only goes for deterministic alerting\\nlet AuditConfiguration= materialize(SAPAuditLogConfiguration(SelectedSeverities= SelectedSeverities, SelectedRuleTypes= SelectedRuleTypes)\\n| where SystemID in((SelectedSystems | project SystemID))\\n| project MessageID, SystemID, RolesTagsToExclude, Severity, Threshold, RuleType, CategoryName);\\n// get special users for exclusion and in-focus analysis\\nlet SAPUsersGottenVIP = (SAPUsersGetVIP | project User = SAPUser, TagsList, SpecialFocusTagged);\\nlet SAPUserRolesAndProfiles = (SAPUsersAssignments | project-keep User, SystemID, DirectRoles, ChildRoles, Profiles | summarize RolesAndProfiles = make_set(array_concat(DirectRoles, ChildRoles, Profiles), 120) by User, SystemID);\\nlet RelevantEvents =SAPAuditLog\\n| where SystemID in((SelectedSystems | project SystemID))\\n| where isnotempty( User)\\n| where AlertSeverityText != \\\"Low\\\"\\n| where MessageID in ((AuditConfiguration | summarize count() by MessageID))\\n| lookup kind=inner (AuditConfiguration| project SystemID, MessageID, Severity, Threshold  ) on\\n$left.MessageID == $right.MessageID\\n,$left.SystemID == $right.SystemID\\n| where SelectedSeverities contains Severity\\n| make-series AuditEventsCounts= count() default=0 on TimeGenerated from startofday({TimeRange:start}) to {TimeRange:end} \\nstep TimeStep by SystemID, MessageID, User, Threshold;\\nRelevantEvents \\n| extend crossedThreshold= series_greater(AuditEventsCounts, repeat(Threshold* TimeStep/1h, array_length(AuditEventsCounts)) )\\n| where array_sum(crossedThreshold) > 0\\n| extend crossedThreshold = array_iif(crossedThreshold,repeat(1, array_length(AuditEventsCounts)) , repeat(0, array_length(AuditEventsCounts)))\\n| lookup SAPUsersGottenVIP on User\\n| lookup SAPUserRolesAndProfiles on User, SystemID\\n| lookup (AuditConfiguration | project-keep SystemID, MessageID, RuleType, RolesTagsToExclude,  Severity) on MessageID, SystemID\\n| extend RolesProfilesAndTags = array_concat(RolesAndProfiles, TagsList)\\n| extend TagsIntersect = set_intersect(split(RolesTagsToExclude,\\\";\\\"), RolesProfilesAndTags)\\n| extend IntersectionSize = array_length(TagsIntersect)\\n// keep only non-excluded users that are not under \\\"Special Focus\\\"\\n| where IntersectionSize == 0 or isempty(IntersectionSize) or SpecialFocusTagged == true\\n| extend Anomalies= series_decompose_anomalies(AuditEventsCounts, Threshold=4, Test_point= 1)\\n| extend Anomaly= array_index_of(Anomalies,1)>= 0\\n| extend AnomalSeriesIndicator = iff(RuleType==\\\"Deterministic\\\", \\\"Deterministic threshold crossed\\\", iff(Anomaly, 'Anomalous audit event', 'Normal audit event'))\\n| mv-expand Anomalies to typeof(double), TimeGenerated to typeof(datetime), crossedThreshold to typeof(int )\\n| where (crossedThreshold > 0) and (( RuleType==\\\"Deterministic\\\") or ( RuleType== \\\"AnomaliesOnly\\\" and (Anomalies > 0 or \\\"{AuditEventsType}\\\" contains \\\"All\\\")))\\n| lookup UserAssignments on User\\n| summarize SuspiciousCount= floor((countif(Severity==\\\"High\\\") + countif(Severity==\\\"Medium\\\")*0.5),1) by UserAuthGroup, TimeGenerated\\n\\n\\n\\n\\n\",\"size\":1,\"aggregation\":3,\"showAnalytics\":true,\"title\":\"Events by authorization group\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{SAPWorkspace}\"],\"visualization\":\"areachart\",\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"ResultText\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"dcount_CorrelationId\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}},\"chartSettings\":{\"xAxis\":\"TimeGenerated\",\"yAxis\":[\"SuspiciousCount\"],\"group\":\"UserAuthGroup\",\"createOtherGroup\":\"\"}},\"customWidth\":\"100\",\"name\":\"Events by authorization group\",\"styleSettings\":{\"maxWidth\":\"100%\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let SelectedSystems= SAPSystems(SelectedSystemRoles=dynamic(\\\"{SystemRoles}\\\")\\n, SelectedSystems=todynamic(\\\"[{Systems}]\\\")\\n, SelectedSystemUsage= dynamic(\\\"{SystemUsage}\\\")) | project SystemID, SystemRole;\\nlet UserAssignments= SAPUsersAssignments() | project User, UserType;\\nlet TimeStep= 4h;\\nlet SelectedSeverities=  dynamic([\\\"High\\\", \\\"Medium\\\"]);//can also do//let SelectedSeverities =  dynamic([\\\"All Severities\\\"])\\nlet SelectedRuleTypes= dynamic([ \\\"Deterministic\\\", \\\"AnomaliesOnly\\\"]); // Rule only goes for deterministic alerting\\nlet AuditConfiguration= materialize(SAPAuditLogConfiguration(SelectedSeverities= SelectedSeverities, SelectedRuleTypes= SelectedRuleTypes)\\n| where SystemID in((SelectedSystems | project SystemID))\\n| project MessageID, SystemID, RolesTagsToExclude, Severity, Threshold, RuleType, CategoryName);\\n// get special users for exclusion and in-focus analysis\\nlet SAPUsersGottenVIP = (SAPUsersGetVIP | project User = SAPUser, TagsList, SpecialFocusTagged);\\nlet SAPUserRolesAndProfiles = (SAPUsersAssignments | project-keep User, SystemID, DirectRoles, ChildRoles, Profiles | summarize RolesAndProfiles = make_set(array_concat(DirectRoles, ChildRoles, Profiles), 120) by User, SystemID);\\nlet RelevantEvents =SAPAuditLog\\n| where SystemID in((SelectedSystems | project SystemID))\\n| where isnotempty( User)\\n| where AlertSeverityText != \\\"Low\\\"\\n| where MessageID in ((AuditConfiguration | summarize count() by MessageID))\\n| lookup kind=inner (AuditConfiguration| project SystemID, MessageID, Severity, Threshold  ) on\\n$left.MessageID == $right.MessageID\\n,$left.SystemID == $right.SystemID\\n| where SelectedSeverities contains Severity\\n| make-series AuditEventsCounts= count() default=0 on TimeGenerated from startofday({TimeRange:start}) to {TimeRange:end} \\nstep TimeStep by SystemID, MessageID, User, Threshold;\\nRelevantEvents \\n| extend crossedThreshold= series_greater(AuditEventsCounts, repeat(Threshold* TimeStep/1h, array_length(AuditEventsCounts)) )\\n| where array_sum(crossedThreshold) > 0\\n| extend crossedThreshold = array_iif(crossedThreshold,repeat(1, array_length(AuditEventsCounts)) , repeat(0, array_length(AuditEventsCounts)))\\n| lookup SAPUsersGottenVIP on User\\n| lookup SAPUserRolesAndProfiles on User, SystemID\\n| lookup (AuditConfiguration | project-keep SystemID, MessageID, RuleType, RolesTagsToExclude,  Severity) on MessageID, SystemID\\n| extend RolesProfilesAndTags = array_concat(RolesAndProfiles, TagsList)\\n| extend TagsIntersect = set_intersect(split(RolesTagsToExclude,\\\";\\\"), RolesProfilesAndTags)\\n| extend IntersectionSize = array_length(TagsIntersect)\\n// keep only non-excluded users that are not under \\\"Special Focus\\\"\\n| where IntersectionSize == 0 or isempty(IntersectionSize) or SpecialFocusTagged == true\\n| extend Anomalies= series_decompose_anomalies(AuditEventsCounts, Threshold=4, Test_point= 1)\\n| extend Anomaly= array_index_of(Anomalies,1)>= 0\\n| extend AnomalSeriesIndicator = iff(RuleType==\\\"Deterministic\\\", \\\"Deterministic threshold crossed\\\", iff(Anomaly, 'Anomalous audit event', 'Normal audit event'))\\n| mv-expand Anomalies to typeof(double), TimeGenerated to typeof(datetime), crossedThreshold to typeof(int )\\n| where (crossedThreshold > 0) and (( RuleType==\\\"Deterministic\\\") or ( RuleType== \\\"AnomaliesOnly\\\" and (Anomalies > 0 or \\\"{AuditEventsType}\\\" contains \\\"All\\\")))\\n| lookup UserAssignments on User\\n| summarize SuspiciousCount= floor((countif(Severity==\\\"High\\\") + countif(Severity==\\\"Medium\\\")*0.5),1) by UserType, TimeGenerated\\n| lookup (SAPGetDataTypes(DataTypes= dynamic([\\\"UserType\\\"]))| project UserType= Key, Value) on UserType\\n| project UserType= iff(isempty(Value), UserType, Value), TimeGenerated, SuspiciousCount\\n\\n\\n\\n\\n\",\"size\":1,\"aggregation\":3,\"showAnalytics\":true,\"title\":\"Events by user type\",\"showExportToExcel\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{SAPWorkspace}\"],\"visualization\":\"areachart\",\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"ResultText\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"dcount_CorrelationId\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}},\"chartSettings\":{\"xAxis\":\"TimeGenerated\",\"yAxis\":[\"SuspiciousCount\"],\"group\":\"UserType\",\"createOtherGroup\":\"\"}},\"customWidth\":\"100\",\"name\":\"Events by user type\",\"styleSettings\":{\"maxWidth\":\"100%\"}}]},\"name\":\"alerts trends\"}]},\"conditionalVisibility\":{\"parameterName\":\"MainTabSelected\",\"comparison\":\"isEqualTo\",\"value\":\"'Audit Log Alerts'\"},\"name\":\"Group Audit Log Alerts\"},{\"type\":11,\"content\":{\"version\":\"LinkItem/1.0\",\"style\":\"nav\",\"links\":[{\"id\":\"547e71ef-1150-4c98-b82e-b0cd0aa1d380\",\"cellValue\":\"MainTabSelected\",\"linkTarget\":\"parameter\",\"linkLabel\":\" click here for more SAP audit log analysis!\",\"subTarget\":\"Audit Log Alerts\",\"preText\":\"There's more! ready for the Audit log alerts report to load?\",\"postText\":\"\",\"style\":\"primary\",\"icon\":\"Sev2\"},{\"id\":\"69e4450d-f926-4cff-a91f-6a011323ef25\",\"cellValue\":\"Select relevant workspaces\",\"linkTarget\":\"step\",\"linkLabel\":\" click here to go back to the top of the report\",\"preText\":\"Had enough? \",\"style\":\"primary\"}]},\"customWidth\":\"100\",\"name\":\"tabs footer\"}],\"fromTemplateId\":\"sentinel-SAP-SecurityAuditlogandInitialAccess\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\",\"fallbackResourceIds\":[]}\n",
                                "version": "1.0",
                                "sourceId": "[variables('workspaceResourceId')]",
                                "category": "sentinel"
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Workbook-', last(split(variables('workbookId3'),'/'))))]",
                            "properties": {
                                "description": "@{workbookKey=SAP-SecurityAuditlogandInitialAccess; logoFileName=SAPVMIcon.svg; description=SAP -Security Audit log and Initial Access; dataTypesDependencies=System.Object[]; dataConnectorsDependencies=System.Object[]; previewImagesFileNames=System.Object[]; version=2.0.1; title=SAP -Security Audit log and Initial Access; templateRelativePath=SAP -Security Audit log and Initial Access.json; subtitle=; provider=Microsoft}.description",
                                "parentId": "[variables('workbookId3')]",
                                "contentId": "[variables('_workbookContentId3')]",
                                "kind": "Workbook",
                                "version": "[variables('workbookVersion3')]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SAP",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                },
                                "dependencies": {
                                    "operator": "AND",
                                    "criteria": [
                                        {
                                            "contentId": "SAPAuditLog",
                                            "kind": "DataType"
                                        },
                                        {
                                            "contentId": "SAP",
                                            "kind": "DataConnector"
                                        }
                                    ]
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('_workbookContentId3')]",
                "contentKind": "Workbook",
                "displayName": "[parameters('workbook3-name')]",
                "contentProductId": "[variables('_workbookcontentProductId3')]",
                "id": "[variables('_workbookcontentProductId3')]",
                "version": "[variables('workbookVersion3')]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('analyticRuleObject1').analyticRuleTemplateSpecName1]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP - (Preview) Capture-replay vulnerability in SAP NetWeaver [CVE-2023-0014]_AnalyticalRules Analytics Rule with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('analyticRuleObject1').analyticRuleVersion1]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                            "name": "[variables('analyticRuleObject1')._analyticRulecontentId1]",
                            "apiVersion": "2022-04-01-preview",
                            "kind": "Scheduled",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "description": "SAP NetWeaver ABAP Server and ABAP Platform creates information about system identity in an ambiguous format.\nThis may be exploited by malicious users to obtain illegitimate access to the system.\nRead SAP note 3281854 - FAQ for Security Note 3089413 for more details. This alert rule helps to identify current risks for systems in the landscape.",
                                "displayName": "SAP - (Preview) Capture-replay vulnerability in SAP NetWeaver [CVE-2023-0014]",
                                "enabled": false,
                                "query": "//  a per SAP note https://launchpad.support.sap.com/#/notes/3089413\n// Systems without this parameter, or with values != \"no\" are vulnerable\n// both (default) - old method allowed as client and server\n// client - old method allowed as client\n// server - old method allowed as server\n// no - old method not allowed\n// CONFIGURATION OPTION- determine which system roles are relevant for this alert\nlet TimeAgo= 7d;\nlet SelectedSystemRoles =  dynamic([\"All System Roles\"]); //can also do// let SelectedSystemRoles =  dynamic([\"Production\", \"UAT\"]);\nlet SelectedSystems = SAPSystems(SelectedSystemRoles= SelectedSystemRoles) | project SystemID= SearchKey, SystemRole, SystemUsage\n| extend SystemRole= replace_string(SystemRole, 'Unknown (Production)', 'Unknown' );\nlet Vulnerability= 'SAP - [CVE-2023-0014] Capture-replay vulnerability in a ';\nlet Remediation= ' SAP NetWeaver ABAP Server and ABAP Platform creates information about system identity in an ambiguous format. <br/> This may be exploited by malicious users to obtain illegitimate access to the system. <br/> Read SAP note 3281854 - FAQ for Security Note 3089413 for more details.';\nlet SafeValues= dynamic(['no']);\nlet MitigatedValues= dynamic(['client']);\nlet ConfiguredSystems= SAP_PAHI\n| where TimeGenerated > ago(TimeAgo)\n| where PARNAME == 'rfc/allowoldticket4tt'\n| where PARSTATE == \"A\"\n| summarize arg_max(PARDATE, PARVALUE, TimeGenerated, SYSTEMID) by SystemID, Host= HOSTNAME, SYSTEMID\n| project-rename SystemNumber= SYSTEMID\n| extend LastChanged= todatetime(PARDATE);\n// ConfiguredSystems\nlet PotentialSystems= SAPAuditLog\n| where TimeGenerated > ago(TimeAgo)\n| project SystemID, Host, SystemNumber\n| summarize by SystemID, Host, SystemNumber\n| join kind= inner SelectedSystems on SystemID;\nPotentialSystems | join kind= inner ConfiguredSystems on SystemID, Host, SystemNumber\n| summarize SystemRole=any(SystemRole), Hosts= makeset(Host), SystemNumbers= makeset(SystemNumber) by SystemID, PARVALUE\n| extend BagODetails= case(\n(PARVALUE in (MitigatedValues)),bag_pack('AlertName', strcat(Vulnerability, SystemRole, ' system- mitigated' ),'AlertDescription', Remediation, 'IsVulnerable', true, 'Severity', 'Medium' ),\n(PARVALUE in (SafeValues)),bag_pack('AlertName', strcat(Vulnerability, SystemRole, ' - system resolved' ),'AlertDescription', Remediation, 'IsVulnerable', false, 'Severity', 'Iformational' ),\n//  else:\nbag_pack('AlertName', strcat(Vulnerability, SystemRole, ' system'),'AlertDescription', Remediation, 'IsVulnerable', true, 'Severity', 'High' ))\n| evaluate bag_unpack(BagODetails)\n| project Hosts, SystemNumbers, PARVALUE, AlertName= columnifexists('AlertName', Vulnerability), AlertDescription= columnifexists('AlertDescription', Remediation), SystemID, Severity= columnifexists('Severity', '')\n| extend ExtendedLink= 'https://www.cve.org/CVERecord?id=CVE-2023-0014', Dummy= ''\n| extend AlertRuleUniqueName = 'capture-replayvulnerabilityinsapnetweaver[cve-2023-0014]'\n",
                                "queryFrequency": "P1D",
                                "queryPeriod": "P7D",
                                "severity": "High",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                    {
                                        "connectorId": "SAP",
                                        "dataTypes": [
                                            "SAP_PAHI",
                                            "SAPAuditLog",
                                            "SAPSystems"
                                        ]
                                    }
                                ],
                                "tactics": [
                                    "CredentialAccess"
                                ],
                                "entityMappings": [
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Name",
                                                "columnName": "SystemID"
                                            }
                                        ],
                                        "entityType": "CloudApplication"
                                    }
                                ],
                                "eventGroupingSettings": {
                                    "aggregationKind": "AlertPerResult"
                                },
                                "alertDetailsOverride": {
                                    "alertDescriptionFormat": "{{AlertDescription}}",
                                    "alertTacticsColumnName": "Dummy",
                                    "alertDisplayNameFormat": "{{AlertName}}",
                                    "alertSeverityColumnName": "Dummy"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject1').analyticRuleId1,'/'))))]",
                            "properties": {
                                "description": "SAP Analytics Rule 1",
                                "parentId": "[variables('analyticRuleObject1').analyticRuleId1]",
                                "contentId": "[variables('analyticRuleObject1')._analyticRulecontentId1]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject1').analyticRuleVersion1]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SAP",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('analyticRuleObject1')._analyticRulecontentId1]",
                "contentKind": "AnalyticsRule",
                "displayName": "SAP - (Preview) Capture-replay vulnerability in SAP NetWeaver [CVE-2023-0014]",
                "contentProductId": "[variables('analyticRuleObject1')._analyticRulecontentProductId1]",
                "id": "[variables('analyticRuleObject1')._analyticRulecontentProductId1]",
                "version": "[variables('analyticRuleObject1').analyticRuleVersion1]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('analyticRuleObject2').analyticRuleTemplateSpecName2]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP - (Preview) Critical authorizations assignment - New Authorization Value_AnalyticalRules Analytics Rule with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('analyticRuleObject2').analyticRuleVersion2]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                            "name": "[variables('analyticRuleObject2')._analyticRulecontentId2]",
                            "apiVersion": "2022-04-01-preview",
                            "kind": "Scheduled",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "description": "Identifies assignment of a critical authorization object value to a new user.\nSource Action: Assign a new authorization object / update existing one in a role using PFCG.\n\nCritical authorization objects should be maintained in watchlist \"\"SAP - Critical Authorization Objects\"\"\n\n*Data Sources: SAPcon -  Change Documents Log*\n*Data Sources: SAPcon -  User MD*",
                                "displayName": "SAP - (Preview) Critical authorizations assignment - New Authorization Value",
                                "enabled": false,
                                "query": "// SAP - Medium - Critical authorizations assignment - New Authorization Value\n// time span for audit events\nlet TimeAgo= 6h;\n// New Assigned Objects\nlet ObjectClassRoles = 'PFCG';\nlet TableName = 'CD1251';\nlet UsersRoles = 'AGR_USERS';\nlet Insert = \"I\";\nlet NotInUse = 'NOT_IN_USE';\nlet logsThreshold = 3600; // 3600 seconds\n// Audit Log Classes - Authorizations for user changed\nlet AuditClasses = dynamic(['AUR','AUT']); // Authorization/Authorization Profile &B created / changed.\n// Roles Change Documents - Extract Auth Object and Obj Field\nlet allHistory = ago(0d);\nlet alertSched = ago(6h); // Please maintain according to schedule\nlet ChangeDocs = SAPChangeDocsLog;\nlet UsersEmails = SAPUsersHeader()| summarize by User, Email, SystemID, Client | project-rename ClientID = Client;\nlet RolesAuthObject = ChangeDocs\n    | where TimeGenerated > ago(TimeAgo)\n    | where TimeGenerated >= alertSched\n    | where ObjectClass == ObjectClassRoles and TableName == TableName // Role-Obj-Profile-ObjField\n    | where TypeofChange_Item in ('J', 'I', 'U') //  Insert\n    | extend RoleObjProfileObjFieldVer = ChangedTableKey, Role = ObjectID\n    | extend ObjFieldValue = ValueNew\n    | extend ObjField = trim(@\"\\s*?\", extract(@\"(^.{1,30})\\s*?(.{1,10})\\s*?(.{1,12})\\s*?(.{1,10})\\s*?\\d{6}\", 4, RoleObjProfileObjFieldVer, typeof(string)))\n    | extend AuthObject = trim(@\"\\s*?\", extract(@\"(^.{1,30})\\s*?(.{1,10})\\s*?(.{1,12})\\s*?(.{1,10})\\s*?\\d{6}\", 2, RoleObjProfileObjFieldVer, typeof(string)))\n    | extend TimeGenRoleAuth = TimeGenerated;\nlet ComplexAuth = _GetWatchlist('SAP - Critical Authorizations');\nlet SimpleAuth = _GetWatchlist('SAP - Critical Authorizations');\nlet usersinRole =\n    ChangeDocs\n    | where TimeGenerated > ago(TimeAgo)\n    | where TimeGenerated <= allHistory\n    | where ObjectClass == ObjectClassRoles // Roles\n        and TableName == UsersRoles // Users Roles\n        and TypeofChange_Item == Insert // Insert\n    | extend UserAssigned = extract(@\"^.{1,33}\\s*?(.{1,12})\\s*?\\d{16}\", 1, ChangedTableKey)\n    | extend Role = ObjectID\n    | summarize by SystemID, Role, UserAssigned;\nlet RolesAuthObjectCheck =\n        RolesAuthObject\n        | extend ObjFieldVal = ObjFieldValue\n        | lookup kind = leftouter\n            (RolesAuthObject\n            | extend ActivityVal = ObjFieldValue)\n            on Role, AuthObject;\nlet complexScenario = ComplexAuth\n    | where ActivityField != NotInUse\n    | summarize by AuthorizationObject, AuthorizationField, AuthorizationValue, ActivityField, Activity\n    | lookup kind = inner (RolesAuthObjectCheck)\n        on $left.AuthorizationObject == $right.AuthObject\n        and $left.AuthorizationField == $right.ObjField\n        and $left.AuthorizationValue == $right.ObjFieldValue\n        and $left.ActivityField == $right.ObjField1\n        and $left.Activity == $right.ActivityVal;\nlet simpleScenario = SimpleAuth\n    | where ActivityField == NotInUse\n    | summarize by AuthorizationObject, AuthorizationField, AuthorizationValue, ActivityField, Activity\n    | lookup  kind = inner (RolesAuthObject)\n        on $left.AuthorizationObject == $right.AuthObject\n        and $left.AuthorizationField == $right.ObjField\n        and $left.AuthorizationValue == $right.ObjFieldValue;\nlet GetEntities =\n    SAPAuditLog\n    | where MessageID in (AuditClasses)\n    | where TimeGenerated > ago(TimeAgo)\n    | summarize by TimeGenerated, ClientID, TerminalIPv6, User, Host, Email\n    | extend TimeGenAudit = TimeGenerated;\nunion complexScenario, simpleScenario\n| lookup kind = inner (usersinRole) on SystemID, Role\n| lookup kind = leftouter (GetEntities) on User\n| where abs(datetime_diff('second', TimeGenRoleAuth, TimeGenAudit)) <= logsThreshold or\nisnull(TimeGenAudit)\n| lookup UsersEmails on SystemID, ClientID, User\n| project\nTimeGenRoleAuth, SystemID, ClientID, Role, User, UserAssigned, AuthorizationObject, AuthorizationField, AuthorizationValue, ActivityField, Activity, Email, TerminalIPv6, Host, UserAssignedEmail=Email1\n| extend AlertRuleUniqueName = 'criticalauthorizationsassignment-newauthorizationvalue'\n",
                                "queryFrequency": "PT6H",
                                "queryPeriod": "P2D",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                    {
                                        "connectorId": "SAP",
                                        "dataTypes": [
                                            "SAPAuditLog",
                                            "SAPChangeDocsLog",
                                            "SAPUsersHeader"
                                        ]
                                    }
                                ],
                                "tactics": [
                                    "PrivilegeEscalation"
                                ],
                                "entityMappings": [
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Email"
                                            }
                                        ],
                                        "entityType": "Account"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Address",
                                                "columnName": "TerminalIPv6"
                                            }
                                        ],
                                        "entityType": "IP"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Host"
                                            }
                                        ],
                                        "entityType": "Host"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Name",
                                                "columnName": "SystemID"
                                            },
                                            {
                                                "identifier": "AppId",
                                                "columnName": "ClientID"
                                            }
                                        ],
                                        "entityType": "CloudApplication"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "UserAssignedEmail"
                                            }
                                        ],
                                        "entityType": "Account"
                                    }
                                ],
                                "eventGroupingSettings": {
                                    "aggregationKind": "SingleAlert"
                                },
                                "customDetails": {
                                    "SAP_UserAssigned": "UserAssigned",
                                    "SAP_User": "User",
                                    "AlertRuleUniqueName": "AlertRuleUniqueName"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject2').analyticRuleId2,'/'))))]",
                            "properties": {
                                "description": "SAP Analytics Rule 2",
                                "parentId": "[variables('analyticRuleObject2').analyticRuleId2]",
                                "contentId": "[variables('analyticRuleObject2')._analyticRulecontentId2]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject2').analyticRuleVersion2]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SAP",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('analyticRuleObject2')._analyticRulecontentId2]",
                "contentKind": "AnalyticsRule",
                "displayName": "SAP - (Preview) Critical authorizations assignment - New Authorization Value",
                "contentProductId": "[variables('analyticRuleObject2')._analyticRulecontentProductId2]",
                "id": "[variables('analyticRuleObject2')._analyticRulecontentProductId2]",
                "version": "[variables('analyticRuleObject2').analyticRuleVersion2]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('analyticRuleObject3').analyticRuleTemplateSpecName3]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP - (Preview) Data exported from a production system using a transport_AnalyticalRules Analytics Rule with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('analyticRuleObject3').analyticRuleVersion3]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                            "name": "[variables('analyticRuleObject3')._analyticRulecontentId3]",
                            "apiVersion": "2022-04-01-preview",
                            "kind": "Scheduled",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "description": "Transports are like pull requests and are normally created in a developement system. This alert rule is triggered when a transport is released from a production system, with data coming from a sensitive table.",
                                "displayName": "SAP - (Preview) Data exported from a production system using a transport",
                                "enabled": false,
                                "query": "// sensitive data was released using transport system\n// here you can exclude system users which are OK to export sensitive data using transport system\n// by adding those users in the SAP_User_Config watchlist with a tag of 'ExportSensitiveDataOK'\n// can also specify SAP Roles or SAP Profiles to exclude\nlet excludeUsersTags= dynamic(['ExportSensitiveDataOK']);\nlet excludedUsers= SAPUsersGetVIP(SearchForTags= excludeUsersTags)| summarize by User2Exclude=SAPUser;\nlet SelectedSystemRoles =  dynamic([\"Production\"]); //can also do// let SelectedSystemRoles =  dynamic([\"Production\", \"UAT\"]); dynamic([\"All System Roles\"])\nlet SelectedSystems = SAPSystems(SelectedSystemRoles= SelectedSystemRoles) | project SystemID= SearchKey;\nlet SensitiveTables = _GetWatchlist('SAP - Sensitive Tables') | summarize by TableName= Table | extend IsSensitive= true;\nlet TransportReleaseTCODEs= dynamic([\"SE10\", \"SE01\"]);\nlet TransportReleasePrograms= dynamic([\"RDDM0001\"]);\nlet SensitiveDataExportViaCR= SAPCRLog\n| where SystemID in (SelectedSystems)\n| where isnotempty( SystemID)\n| where isnotempty(TableName)\n| lookup SensitiveTables on TableName\n| where Status == \"R\" // released\n| where Request startswith_cs SystemID\n| project-rename ExportDT= UpdatedOn\n| summarize Requests= make_set(Request,10), ExportDT= min(ExportDT) by Owner, RequestDescription= Description, TableName, SystemID, Instance, Host, IsSensitive;\nlet TransportReleaseTransactions= SAPAuditLog\n| where  MessageID == \"AU3\"\n| where SystemID in (SelectedSystems)\n| where TransactionCode in(TransportReleaseTCODEs) or ABAPProgramName in (TransportReleasePrograms)\n| join kind=leftantisemi excludedUsers on $left.User == $right.User2Exclude\n| project-rename TransactionStartDT= UpdatedOn_t\n| summarize TransactionCodes= make_set(TransactionCode, 3), ABAPProgramNames= make_set(ABAPProgramName, 3), Email= any(Email), TransactionStartDT= min(TransactionStartDT) by User, TerminalIPv6, Host, SystemID, ClientID, Instance;\nTransportReleaseTransactions\n| join kind= inner SensitiveDataExportViaCR on SystemID\n| extend TimePassed= datetime_diff( \"minute\", ExportDT, TransactionStartDT)\n| where TimePassed between (0 .. 60)\n| extend AlertDescription= strcat(\"User has exported \",iff(IsSensitive, \"sensitive\", \"tabular\") ,\" data from a productive system using a transport\")\n| extend ExtendedDetails= pack(\"TransactionStartDT\" , TransactionStartDT, \"Owner\", Owner, \"RequestDescription\", RequestDescription, 'TransactionCodes', TransactionCodes, 'ABAPProgramNames', ABAPProgramNames)\n| extend Severity= iff(IsSensitive, \"High\", \"Medium\"), Dummy= ''\n| project ExportedOn= ExportDT, User, TerminalIPv6, Host, SystemID, TransactionCode= TransactionCodes[0], ABAPProgramName= ABAPProgramNames[0], Email, ExtendedDetails, Requests, AlertDescription, TableName, IsSensitive, Severity, ClientID, Instance, Dummy\n| extend AlertRuleUniqueName = 'dataexportedfromaproductionsystemusingatransport'\n",
                                "queryFrequency": "PT4H",
                                "queryPeriod": "PT5H",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                    {
                                        "connectorId": "SAP",
                                        "dataTypes": [
                                            "SAPAuditLog",
                                            "SAPCRLog",
                                            "SAPSystems",
                                            "SAPUsersGetVIP"
                                        ]
                                    }
                                ],
                                "tactics": [
                                    "Exfiltration"
                                ],
                                "entityMappings": [
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Email"
                                            }
                                        ],
                                        "entityType": "Account"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Name",
                                                "columnName": "SystemID"
                                            },
                                            {
                                                "identifier": "AppId",
                                                "columnName": "ClientID"
                                            },
                                            {
                                                "identifier": "InstanceName",
                                                "columnName": "Instance"
                                            }
                                        ],
                                        "entityType": "CloudApplication"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Address",
                                                "columnName": "TerminalIPv6"
                                            }
                                        ],
                                        "entityType": "IP"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "HostName",
                                                "columnName": "Host"
                                            }
                                        ],
                                        "entityType": "Host"
                                    }
                                ],
                                "eventGroupingSettings": {
                                    "aggregationKind": "AlertPerResult"
                                },
                                "customDetails": {
                                    "ChangeRequests": "Requests",
                                    "IsSensitive": "IsSensitive",
                                    "ExtendedDetails": "ExtendedDetails",
                                    "SAP_User": "User",
                                    "AlertRuleUniqueName": "AlertRuleUniqueName"
                                },
                                "alertDetailsOverride": {
                                    "alertDescriptionFormat": "{{AlertDescription}}<br/>",
                                    "alertTacticsColumnName": "Dummy",
                                    "alertDisplayNameFormat": "{{AlertDescription}}",
                                    "alertSeverityColumnName": "Severity"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject3').analyticRuleId3,'/'))))]",
                            "properties": {
                                "description": "SAP Analytics Rule 3",
                                "parentId": "[variables('analyticRuleObject3').analyticRuleId3]",
                                "contentId": "[variables('analyticRuleObject3')._analyticRulecontentId3]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject3').analyticRuleVersion3]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SAP",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('analyticRuleObject3')._analyticRulecontentId3]",
                "contentKind": "AnalyticsRule",
                "displayName": "SAP - (Preview) Data exported from a production system using a transport",
                "contentProductId": "[variables('analyticRuleObject3')._analyticRulecontentProductId3]",
                "id": "[variables('analyticRuleObject3')._analyticRulecontentProductId3]",
                "version": "[variables('analyticRuleObject3').analyticRuleVersion3]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('analyticRuleObject4').analyticRuleTemplateSpecName4]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP - (Preview) Dynamic Anomaly based Audit Log Monitor Alerts_AnalyticalRules Analytics Rule with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('analyticRuleObject4').analyticRuleVersion4]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                            "name": "[variables('analyticRuleObject4')._analyticRulecontentId4]",
                            "apiVersion": "2022-04-01-preview",
                            "kind": "Scheduled",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "description": "SAP Audit log events with message IDs preconfigured in Watchlist SAP_Dynamic_Audit_Log_Monitor_Configuration and with RuleType  = \"AnomaliesOnly\" will be shown here.\nSee  [Sentinel4SAP Dcoumentation](https://aka.ms/sapsecdocs) for further information",
                                "displayName": "SAP - (Preview) Dynamic Anomaly based Audit Log Monitor Alerts",
                                "enabled": false,
                                "query": "// SAP - (Preview) Dynamic Anomaly based Audit Log Monitor Alerts\nlet SelectedSystems =  dynamic([\"All Systems\"]);//can also do// let SelectedSystems =  dynamic([\"S4P\", \"B4X\", \"ODT\"]);\nlet SelectedSystemRoles =  dynamic([\"Production\"]); //can also do// let SelectedSystemRoles =  dynamic([\"Production\", \"UAT\"]);\nlet SelectedSeverities=  dynamic([\"High\", \"Medium\"]);//can also do//let SelectedSeverities =  dynamic([\"All Severities\"])\n// let SelectedRuleTypes = dynamic([\"All RuleTypes\"]);\nlet SelectedRuleTypes= dynamic([\"AnomaliesOnly\"]);\nlet SAPAuditAnomal = SAPAuditLogAnomalies(LearningTime = 14d, DetectingTime=1h, SelectedSystems= SelectedSystems,\nSelectedSystemRoles= SelectedSystemRoles, SelectedSeverities= SelectedSeverities, SelectedRuleTypes= SelectedRuleTypes);\n// Query\n// get the anomalies\nSAPAuditAnomal\n// get the user privleged status\n| lookup (SAPUsersGetPrivileged() | extend IsPrivilegedUser = true) on\n$left.SystemID == $right.SystemID\n,$left.User == $right.User\n,$left.ClientID == $right.Client\n| extend DetailedDescription = iff(IsPrivilegedUser, strcat('User ', User,  ' is a privileged user! <br/>', DetailedDescription), DetailedDescription)\n| extend TimeGenerated = MaxTime\n// handle threshold per system (configurable via the SAPAuditLogConfigurator watchlist)\n//  apply the threshold criteria, consider that the watchlist describes hourly thresholds\n| extend MinutesSpan = datetime_diff('Minute', MaxTime, MinTime )\n| where EventCount > (Threshold * max_of(MinutesSpan, 10) / 60)\n| extend DetailedDescription = iff(EventCount > 1, strcat(' Event occured ', EventCount, ' times within ', MinutesSpan + 1, ' minutes.<br/> ', 'The predefined threshold of ', Threshold,  ' Events per hour was exceeded! <br/>', DetailedDescription), DetailedDescription)\n| extend MessageText = iff(MessageText endswith_cs \".\", substring(MessageText, 0, strlen(MessageText)-1), MessageText)\n| project-keep SystemID, Instance, MessageText, MessageClass, MessageID, ClientID, User, TerminalIPv6, TransactionCode, ABAPProgramName, SAPProcesType, SAPWPName, Email, Host, CategoryName, DestinationEmail, DetailedDescription, Tactics, TeamsChannelID, SystemRole, SystemUsage, IsProd, Severity, BagOfDetails, IsPrivilegedUser, EventCount, Threshold, TimeGenerated\n| extend Source= 'SAPAuditAnom1 '\n| extend AlertRuleUniqueName = 'dynamicanomalybasedauditlogmonitoralerts'\n",
                                "queryFrequency": "PT1H",
                                "queryPeriod": "P14D",
                                "severity": "High",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                    {
                                        "connectorId": "SAP",
                                        "dataTypes": [
                                            "SAPAuditLog",
                                            "SAPAuditLogAnomalies",
                                            "SAPUsersGetPrivileged"
                                        ]
                                    }
                                ],
                                "entityMappings": [
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Email"
                                            }
                                        ],
                                        "entityType": "Account"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Name",
                                                "columnName": "SystemID"
                                            },
                                            {
                                                "identifier": "AppId",
                                                "columnName": "ClientID"
                                            },
                                            {
                                                "identifier": "InstanceName",
                                                "columnName": "Instance"
                                            }
                                        ],
                                        "entityType": "CloudApplication"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Address",
                                                "columnName": "TerminalIPv6"
                                            }
                                        ],
                                        "entityType": "IP"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "ProcessId",
                                                "columnName": "TransactionCode"
                                            },
                                            {
                                                "identifier": "CommandLine",
                                                "columnName": "ABAPProgramName"
                                            }
                                        ],
                                        "entityType": "Process"
                                    }
                                ],
                                "eventGroupingSettings": {
                                    "aggregationKind": "AlertPerResult"
                                },
                                "customDetails": {
                                    "BagOfDetails": "BagOfDetails",
                                    "DestinationEmail": "DestinationEmail",
                                    "Source": "Source",
                                    "TeamsChannelID": "TeamsChannelID",
                                    "SAP_User": "User",
                                    "SAPProcessType": "SAPProcesType",
                                    "SystemUsage": "SystemUsage",
                                    "SAPAuditLogMessageID": "MessageID",
                                    "AlertRuleUniqueName": "AlertRuleUniqueName",
                                    "IsProductionEnv": "IsProd",
                                    "SystemRole": "SystemRole"
                                },
                                "alertDetailsOverride": {
                                    "alertDescriptionFormat": "#### Detailed information\n{{DetailedDescription}}\n#### Additional information\n{{BagOfDetails}}<br/>\nAlerts of this type can be configured using watch list SAPAuditLogConfigurator . <br/>\nSee  [Sentinel4SAP Dcoumentation](https://aka.ms/sapsecdocs) for further information\n",
                                    "alertTacticsColumnName": "Tactics",
                                    "alertDisplayNameFormat": "SAP - Anomaly Detected- {{MessageText}} in system {{SystemID}}",
                                    "alertSeverityColumnName": "Severity"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject4').analyticRuleId4,'/'))))]",
                            "properties": {
                                "description": "SAP Analytics Rule 4",
                                "parentId": "[variables('analyticRuleObject4').analyticRuleId4]",
                                "contentId": "[variables('analyticRuleObject4')._analyticRulecontentId4]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject4').analyticRuleVersion4]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SAP",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('analyticRuleObject4')._analyticRulecontentId4]",
                "contentKind": "AnalyticsRule",
                "displayName": "SAP - (Preview) Dynamic Anomaly based Audit Log Monitor Alerts",
                "contentProductId": "[variables('analyticRuleObject4')._analyticRulecontentProductId4]",
                "id": "[variables('analyticRuleObject4')._analyticRulecontentProductId4]",
                "version": "[variables('analyticRuleObject4').analyticRuleVersion4]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('analyticRuleObject5').analyticRuleTemplateSpecName5]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP - (Preview) File Downloaded From a Malicious IP Address_AnalyticalRules Analytics Rule with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('analyticRuleObject5').analyticRuleVersion5]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                            "name": "[variables('analyticRuleObject5')._analyticRulecontentId5]",
                            "apiVersion": "2022-04-01-preview",
                            "kind": "Scheduled",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "description": "User has downloaded a file from an SAP system using an IP address known to be malicious.\nMalicious IP addresses are obtained from threat intelligence services. For additional information visit the [Connect your threat intelligence platform to Microsoft Sentinel]( https://learn.microsoft.com/Azure/sentinel/connect-threat-intelligence-tip) how-to page.\nThis Alert rule allows for a cross-workspace query to accommodate an architecture where the threat intelligence data resides in a different workspace than the one which holds the SAP data.",
                                "displayName": "SAP - (Preview) File Downloaded From a Malicious IP Address",
                                "enabled": false,
                                "query": "let TimeAgo = 65m;\nlet ioc_lookBack = 14d;\n// CONFIGURATION OPTION- determine which system roles are relevant for this alert\nlet SelectedSystemRoles=  dynamic([\"Production\"]); //can also do// let SelectedSystemRoles =  dynamic([\"Production\", \"UAT\"]); dynamic([\"All System Roles\"])\n// let SelectedSystemRoles= dynamic([\"All System Roles\"]);\nlet SelectedSystems = SAPSystems(SelectedSystemRoles= SelectedSystemRoles) | project SystemID= SearchKey;\nlet MaliciousIPs= SAPThreatIntelligenceIndicator\n| where TimeGenerated >= ago(ioc_lookBack) and ExpirationDateTime > now()\n| summarize LatestIndicatorTime = arg_max(TimeGenerated, *) by IndicatorId\n| summarize ConfidenceScore= any(ConfidenceScore) by NetworkIP, EmailSourceIpAddress, NetworkDestinationIP, NetworkSourceIP, Active, Description, ThreatType\n| where Active == true\n// Picking up only IOC's that contain the entities we want\n| where isnotempty(NetworkIP)\n    or isnotempty(EmailSourceIpAddress)\n    or isnotempty(NetworkDestinationIP)\n    or isnotempty(NetworkSourceIP)\n// As there is potentially more than 1 indicator type for matching IP, taking NetworkIP first, then others if that is empty.\n// Taking the first non-empty value based on potential IOC match availability\n| extend TI_ipEntity = iff(isnotempty(NetworkIP), NetworkIP, NetworkDestinationIP)\n| extend TI_ipEntity = iff(isempty(TI_ipEntity) and isnotempty(NetworkSourceIP), NetworkSourceIP, TI_ipEntity)\n| extend TI_ipEntity = iff(isempty(TI_ipEntity) and isnotempty(EmailSourceIpAddress), EmailSourceIpAddress, TI_ipEntity)\n//Exclude local addresses, using the ipv4_is_private operator\n| where TI_ipEntity !startswith \"fe80\"\n    and TI_ipEntity !startswith \"::\"\n    and TI_ipEntity !startswith \"127.\"\n| summarize by TI_ipEntity, TIDescription= Description, ThreatType, ConfidenceScore\n| extend IsPrivate= ipv4_is_private(TI_ipEntity);\n// Get all downloads\nlet FileDownloads= SAPAuditLog\n    | where MessageID == \"AUY\"\n    | where TimeGenerated > ago (TimeAgo*2) and ingestion_time() > ago(TimeAgo)\n    | where SystemID in (SelectedSystems)\n    | join kind=inner (MaliciousIPs) on $left.TerminalIPv6 == $right.TI_ipEntity\n    | extend ByteCount= toint(replace_string(replace_string(Variable1, \".\",\"\"), \",\",\"\")), Code=Variable2, Path= Variable3\n    | summarize ConfidenceScore= any(ConfidenceScore), IsPrivate=any(IsPrivate), TIDescription=any(TIDescription), ThreatType= any(ThreatType), DownloadsByUser = count(), Paths= make_set(Variable3, 10), ByteCount=sum(ByteCount) by SystemID, ClientID, User, TerminalIPv6, Email, Host, TransactionCode, Instance;\n    FileDownloads\n    | extend PackedDetails= pack_all()\n    | extend Details= strcat(\"User \", User, \" has downloaded \", ByteCount, \" bytes data from a malicious \", iff(IsPrivate, \"private\",\"public\"),\" IP address \")\n    | extend AlertDetails= strcat(\"Threat Type: \", ThreatType, \", Threat Description: \", TIDescription), Dummy= ''\n| extend AlertRuleUniqueName = 'filedownloadedfromamaliciousipaddress'\n",
                                "queryFrequency": "PT2H",
                                "queryPeriod": "P14D",
                                "severity": "High",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                    {
                                        "connectorId": "SAP",
                                        "dataTypes": [
                                            "SAPAuditLog",
                                            "SAPSystems",
                                            "SAPThreatIntelligenceIndicator"
                                        ]
                                    }
                                ],
                                "tactics": [
                                    "Exfiltration"
                                ],
                                "entityMappings": [
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Email"
                                            }
                                        ],
                                        "entityType": "Account"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Name",
                                                "columnName": "SystemID"
                                            },
                                            {
                                                "identifier": "AppId",
                                                "columnName": "ClientID"
                                            },
                                            {
                                                "identifier": "InstanceName",
                                                "columnName": "Instance"
                                            }
                                        ],
                                        "entityType": "CloudApplication"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Address",
                                                "columnName": "TerminalIPv6"
                                            }
                                        ],
                                        "entityType": "IP"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "HostName",
                                                "columnName": "Host"
                                            }
                                        ],
                                        "entityType": "Host"
                                    }
                                ],
                                "eventGroupingSettings": {
                                    "aggregationKind": "AlertPerResult"
                                },
                                "customDetails": {
                                    "PackedDetails": "PackedDetails",
                                    "ThreatType": "ThreatType",
                                    "SAP_User": "User",
                                    "AlertRuleUniqueName": "AlertRuleUniqueName"
                                },
                                "alertDetailsOverride": {
                                    "alertDescriptionFormat": "{{AlertDetails}}\n\nUser has downloaded a file from an SAP system using an IP address known to be malicious.\nMalicious IP addresses are obtained from threat intelligence services. For additional information visit the [Connect your threat intelligence platform to Microsoft Sentinel]( https://learn.microsoft.com/Azure/sentinel/connect-threat-intelligence-tip) how-to page.\nThis Alert rule allows for a cross-workspace query to accommodate an architecture where the threat intelligence data resides in a different workspace than the one which holds the SAP data.\n",
                                    "alertTacticsColumnName": "Dummy",
                                    "alertDisplayNameFormat": "{{Details}}",
                                    "alertSeverityColumnName": "Dummy"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject5').analyticRuleId5,'/'))))]",
                            "properties": {
                                "description": "SAP Analytics Rule 5",
                                "parentId": "[variables('analyticRuleObject5').analyticRuleId5]",
                                "contentId": "[variables('analyticRuleObject5')._analyticRulecontentId5]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject5').analyticRuleVersion5]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SAP",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('analyticRuleObject5')._analyticRulecontentId5]",
                "contentKind": "AnalyticsRule",
                "displayName": "SAP - (Preview) File Downloaded From a Malicious IP Address",
                "contentProductId": "[variables('analyticRuleObject5')._analyticRulecontentProductId5]",
                "id": "[variables('analyticRuleObject5')._analyticRulecontentProductId5]",
                "version": "[variables('analyticRuleObject5').analyticRuleVersion5]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('analyticRuleObject6').analyticRuleTemplateSpecName6]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP - (Preview) HANA DB - Assign Admin Authorizations_AnalyticalRules Analytics Rule with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('analyticRuleObject6').analyticRuleVersion6]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                            "name": "[variables('analyticRuleObject6')._analyticRulecontentId6]",
                            "apiVersion": "2022-04-01-preview",
                            "kind": "Scheduled",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "description": "Identifies admin privileges/roles assignment.\n\nSource Action: Assign a user with any Admin role / privileges.\n\n*Data Sources: Linux Agent - Syslog*",
                                "displayName": "SAP - (Preview) HANA DB - Assign Admin Authorizations",
                                "enabled": false,
                                "query": "SAPSyslog\n| where ProcessName startswith \"HDB\"\n| where SyslogMessage contains \"ADMIN\" and (SyslogMessage contains \"GRANT PRIVILEGE\" or SyslogMessage contains \"GRANT ROLE\")\n| extend AlertRuleUniqueName = 'hanadb-assignadminauthorizations'\n",
                                "queryFrequency": "PT3H",
                                "queryPeriod": "PT3H",
                                "severity": "High",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                    {
                                        "connectorId": "SAP",
                                        "dataTypes": [
                                            "SAPSyslog"
                                        ]
                                    }
                                ],
                                "tactics": [
                                    "PrivilegeEscalation"
                                ],
                                "entityMappings": [
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "HostName",
                                                "columnName": "HostName"
                                            }
                                        ],
                                        "entityType": "Host"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "ProcessId",
                                                "columnName": "ProcessID"
                                            }
                                        ],
                                        "entityType": "Process"
                                    }
                                ],
                                "eventGroupingSettings": {
                                    "aggregationKind": "SingleAlert"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject6').analyticRuleId6,'/'))))]",
                            "properties": {
                                "description": "SAP Analytics Rule 6",
                                "parentId": "[variables('analyticRuleObject6').analyticRuleId6]",
                                "contentId": "[variables('analyticRuleObject6')._analyticRulecontentId6]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject6').analyticRuleVersion6]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SAP",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('analyticRuleObject6')._analyticRulecontentId6]",
                "contentKind": "AnalyticsRule",
                "displayName": "SAP - (Preview) HANA DB - Assign Admin Authorizations",
                "contentProductId": "[variables('analyticRuleObject6')._analyticRulecontentProductId6]",
                "id": "[variables('analyticRuleObject6')._analyticRulecontentProductId6]",
                "version": "[variables('analyticRuleObject6').analyticRuleVersion6]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('analyticRuleObject7').analyticRuleTemplateSpecName7]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP - (Preview) HANA DB - Audit Trail Policy Changes_AnalyticalRules Analytics Rule with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('analyticRuleObject7').analyticRuleVersion7]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                            "name": "[variables('analyticRuleObject7')._analyticRulecontentId7]",
                            "apiVersion": "2022-04-01-preview",
                            "kind": "Scheduled",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "description": "Identifies changes for HANA DB audit trail policies.\n\nSource Action: Create / update existing audit policy in security definitions.\n\n*Data Sources: Linux Agent - Syslog*",
                                "displayName": "SAP - (Preview) HANA DB - Audit Trail Policy Changes",
                                "enabled": false,
                                "query": "SAPSyslog\n| where ProcessName startswith \"HDB\"\n| where SyslogMessage contains \"AUDIT POLICY\"\n| extend AlertRuleUniqueName = 'hanadb-audittrailpolicychanges'\n",
                                "queryFrequency": "PT1H",
                                "queryPeriod": "PT1H",
                                "severity": "High",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                    {
                                        "connectorId": "SAP",
                                        "dataTypes": [
                                            "SAPSyslog"
                                        ]
                                    }
                                ],
                                "tactics": [
                                    "LateralMovement",
                                    "DefenseEvasion",
                                    "Persistence"
                                ],
                                "entityMappings": [
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "HostName",
                                                "columnName": "HostName"
                                            }
                                        ],
                                        "entityType": "Host"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "ProcessId",
                                                "columnName": "ProcessID"
                                            }
                                        ],
                                        "entityType": "Process"
                                    }
                                ],
                                "eventGroupingSettings": {
                                    "aggregationKind": "SingleAlert"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject7').analyticRuleId7,'/'))))]",
                            "properties": {
                                "description": "SAP Analytics Rule 7",
                                "parentId": "[variables('analyticRuleObject7').analyticRuleId7]",
                                "contentId": "[variables('analyticRuleObject7')._analyticRulecontentId7]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject7').analyticRuleVersion7]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SAP",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('analyticRuleObject7')._analyticRulecontentId7]",
                "contentKind": "AnalyticsRule",
                "displayName": "SAP - (Preview) HANA DB - Audit Trail Policy Changes",
                "contentProductId": "[variables('analyticRuleObject7')._analyticRulecontentProductId7]",
                "id": "[variables('analyticRuleObject7')._analyticRulecontentProductId7]",
                "version": "[variables('analyticRuleObject7').analyticRuleVersion7]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('analyticRuleObject8').analyticRuleTemplateSpecName8]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP - (Preview) HANA DB - Deactivation of Audit Trail_AnalyticalRules Analytics Rule with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('analyticRuleObject8').analyticRuleVersion8]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                            "name": "[variables('analyticRuleObject8')._analyticRulecontentId8]",
                            "apiVersion": "2022-04-01-preview",
                            "kind": "Scheduled",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "description": "Identifies deactivation of HANA DB audit log.\n\nSource Action: Deactivate Audit Log in HANA DB security defnitions.\n\n*Data Sources: Linux Agent - Syslog*",
                                "displayName": "SAP - (Preview) HANA DB - Deactivation of Audit Trail",
                                "enabled": false,
                                "query": "SAPSyslog\n| where ProcessName startswith \"HDB\"\n| where SyslogMessage contains \"AUDIT CONFIGURATION\" and\n    SyslogMessage contains 'global_auditing_state' and\n    SyslogMessage contains 'False'\n| extend AlertRuleUniqueName = 'hanadb-deactivationofaudittrail'\n",
                                "queryFrequency": "PT1H",
                                "queryPeriod": "PT1H",
                                "severity": "High",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                    {
                                        "connectorId": "SAP",
                                        "dataTypes": [
                                            "SAPSyslog"
                                        ]
                                    }
                                ],
                                "tactics": [
                                    "Persistence",
                                    "LateralMovement",
                                    "DefenseEvasion"
                                ],
                                "entityMappings": [
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "HostName",
                                                "columnName": "HostName"
                                            }
                                        ],
                                        "entityType": "Host"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "ProcessId",
                                                "columnName": "ProcessID"
                                            }
                                        ],
                                        "entityType": "Process"
                                    }
                                ],
                                "eventGroupingSettings": {
                                    "aggregationKind": "SingleAlert"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject8').analyticRuleId8,'/'))))]",
                            "properties": {
                                "description": "SAP Analytics Rule 8",
                                "parentId": "[variables('analyticRuleObject8').analyticRuleId8]",
                                "contentId": "[variables('analyticRuleObject8')._analyticRulecontentId8]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject8').analyticRuleVersion8]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SAP",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('analyticRuleObject8')._analyticRulecontentId8]",
                "contentKind": "AnalyticsRule",
                "displayName": "SAP - (Preview) HANA DB - Deactivation of Audit Trail",
                "contentProductId": "[variables('analyticRuleObject8')._analyticRulecontentProductId8]",
                "id": "[variables('analyticRuleObject8')._analyticRulecontentProductId8]",
                "version": "[variables('analyticRuleObject8').analyticRuleVersion8]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('analyticRuleObject9').analyticRuleTemplateSpecName9]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP - (Preview) HANA DB - User Admin actions_AnalyticalRules Analytics Rule with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('analyticRuleObject9').analyticRuleVersion9]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                            "name": "[variables('analyticRuleObject9')._analyticRulecontentId9]",
                            "apiVersion": "2022-04-01-preview",
                            "kind": "Scheduled",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "description": "Identifies user administration actions.\n\nSouirce Action: Create/Update/Delete a DB User.\n\n*Data Sources: Linux Agent - Syslog*",
                                "displayName": "SAP - (Preview) HANA DB - User Admin actions",
                                "enabled": false,
                                "query": "SAPSyslog\n| where ProcessName startswith \"HDB\"\n| where SyslogMessage contains \"CREATE USER\" or\n    SyslogMessage contains 'ALTER USER' or\n    SyslogMessage contains 'DROP USER' or\n    SyslogMessage contains 'DROP SCHEMA'\n| extend AlertRuleUniqueName = 'hanadb-useradminactions'\n",
                                "queryFrequency": "PT3H",
                                "queryPeriod": "PT3H",
                                "severity": "High",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                    {
                                        "connectorId": "SAP",
                                        "dataTypes": [
                                            "SAPSyslog"
                                        ]
                                    }
                                ],
                                "tactics": [
                                    "PrivilegeEscalation"
                                ],
                                "entityMappings": [
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "HostName",
                                                "columnName": "HostName"
                                            }
                                        ],
                                        "entityType": "Host"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "ProcessId",
                                                "columnName": "ProcessID"
                                            }
                                        ],
                                        "entityType": "Process"
                                    }
                                ],
                                "eventGroupingSettings": {
                                    "aggregationKind": "SingleAlert"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject9').analyticRuleId9,'/'))))]",
                            "properties": {
                                "description": "SAP Analytics Rule 9",
                                "parentId": "[variables('analyticRuleObject9').analyticRuleId9]",
                                "contentId": "[variables('analyticRuleObject9')._analyticRulecontentId9]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject9').analyticRuleVersion9]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SAP",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('analyticRuleObject9')._analyticRulecontentId9]",
                "contentKind": "AnalyticsRule",
                "displayName": "SAP - (Preview) HANA DB - User Admin actions",
                "contentProductId": "[variables('analyticRuleObject9')._analyticRulecontentProductId9]",
                "id": "[variables('analyticRuleObject9')._analyticRulecontentProductId9]",
                "version": "[variables('analyticRuleObject9').analyticRuleVersion9]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('analyticRuleObject10').analyticRuleTemplateSpecName10]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP - (Preview) High volume of potentially sensitive data exported_AnalyticalRules Analytics Rule with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('analyticRuleObject10').analyticRuleVersion10]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                            "name": "[variables('analyticRuleObject10')._analyticRulecontentId10]",
                            "apiVersion": "2022-04-01-preview",
                            "kind": "Scheduled",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "description": "High volume of data exported via files in proximity to an execution of a sensitive transaction, a sensitive program or direct access to sensitive table.",
                                "displayName": "SAP - (Preview) High volume of potentially sensitive data exported",
                                "enabled": false,
                                "query": "// SAP - High volume of potentially sensitive data exported\n// high volume of file downloads by users who were obsereved accessing sensitive data\n// or sensitive programs/ transactions\n// !!!IMPORTANT!!!\n// please make sure \"Lookup data from the last\" parameter is greater than a full user master data update cycle\n// please keep \"Lookup data from the last\" to be 7 days to allow coverage of user master data required\n// actual lookback is set by setting TimeAgo\nlet TimeAgo= 4h;\nlet TimeBetweenAccessAndDownload= 60m;\nlet ByteCountThreshold= 800000; //  Threshold in Bytes for entire lookback period\n// CONFIGURATION OPTION- determine which system roles are relevant for this alert\nlet SelectedSystemRoles=  dynamic([\"Production\"]); //can also do// let SelectedSystemRoles =  dynamic([\"Production\", \"UAT\"]); dynamic([\"All System Roles\"])\n// let SelectedSystemRoles= dynamic([\"All System Roles\"]);\nlet SelectedSystems = SAPSystems(SelectedSystemRoles= SelectedSystemRoles) | project SystemID= SearchKey;\n// Get sensitive Tables\n// CONFIGURATION OPTION- list sensitive tables in the 'SAP - Sensitive Tables' watchlist\nlet SensitiveTables = _GetWatchlist('SAP - Sensitive Tables') | summarize by Table;\nlet TableAccessTcodes= dynamic([\"SE16\", \"SE16N\", \"SE11\", \"SE16H\", \"SM30\", \"SE12\", \"SM31\", \"SE16H\", \"SE14\", \"SE54\",\"SE17\", \"SE16T\", \"DB01\", \"DB02\"]);\n// CONFIGURATION OPTION- list sensitive transactions in the 'SAP - Sensitive Transactions' watchlist\nlet SensitiveTransWL= toscalar(_GetWatchlist('SAP - Sensitive Transactions') | summarize TransactionCodes= make_set(TransactionCode));\n// CONFIGURATION OPTION- exclude TCODEs which are not to be considered\nlet ExcludedTcodes= dynamic([\"S000\", \"\"]);\nlet SensitiveTcodes= (set_difference(set_union(SensitiveTransWL, TableAccessTcodes), ExcludedTcodes));\n// CONFIGURATION OPTION- list sensitive programs in the 'SAP - Sensitive ABAP Programs' watchlist\nlet SensitiveABAPReports = _GetWatchlist('SAP - Sensitive ABAP Programs');\nlet fixedABAPReports = datatable(ABAPProgram:string) [\"RSPFLDOC\"];\nlet UnionABAP = union isfuzzy=true SensitiveABAPReports, fixedABAPReports| summarize by ABAPProgram;\n// CONFIGURATION OPTION- exclude system users which are OK to download massive amounts of sensitive data\n// by adding those users in the SAP_User_Config watchlist with a tag of 'MassiveDownloadsOK'\n// can also specify SAP Roles or Profiles to exclude\nlet excludeUsersTags= dynamic(['MassiveDownloadsOK','SAP_ROLE1', 'SAP_PROFILE1']);\nlet excludedUsers= SAPUsersGetVIP(SearchForTags= excludeUsersTags)| summarize by User2Exclude=SAPUser;\n// Get direct sensitive table access\nlet SensitiveTableAccess= SAPAuditLog\n    | where TimeGenerated > ago (TimeAgo*2) and ingestion_time() > ago(TimeAgo)\n    | where MessageID == \"DU9\" or MessageID == \"CUZ\"\n    | where SystemID in (SelectedSystems)\n    | where Variable1 in (SensitiveTables)\n    | project-rename Table = Variable1, Activity = Variable2\n    | summarize Activities= make_set(Activity, 3) by TimeAccessed= bin(TimeGenerated, TimeBetweenAccessAndDownload), SystemID, ClientID, User, ABAPProgramName\n    , Table, SourceAction= strcat(\"after visiting transaction \", TransactionCode, \" and viewing sensitive table \", Table), TransactionCode, TableOrProgram= Table;\n// get sensitive program execution\nlet SensitiveProgramExec= SAPAuditLog\n    | where TimeGenerated > ago (TimeAgo*2) and ingestion_time() > ago(TimeAgo)\n    | where MessageID == \"AUW\"\n    | where SystemID in (SelectedSystems)\n    | where ABAPProgramName in (UnionABAP)\n    | summarize by TimeAccessed= bin(TimeGenerated, TimeBetweenAccessAndDownload), SystemID, ClientID, User, ABAPProgramName\n    , SourceAction= strcat(\"after executing sensitive program \", ABAPProgramName), TransactionCode, TableOrProgram= ABAPProgramName ;\n// get sensitive transaction execution\nlet SensitiveTcodeExec= SAPAuditLog\n    | where TimeGenerated > ago (TimeAgo*2) and ingestion_time() > ago(TimeAgo)\n    | where MessageID == \"AU3\" or MessageID == \"AU4\"\n    | where SystemID in (SelectedSystems)\n    // make sure sensitive transactions do not contain the TableAccessTcodes which are checked for the specific table name\n    | where TransactionCode in (set_difference(SensitiveTcodes,TableAccessTcodes)) or Variable1 in (set_difference(SensitiveTcodes,TableAccessTcodes))\n    | summarize by TimeAccessed= bin(TimeGenerated, TimeBetweenAccessAndDownload), SystemID, ClientID, User, ABAPProgramName, SourceAction= strcat(\"after executing sensitive transaction \", TransactionCode), TransactionCode, TableOrProgram= TransactionCode;\n// Get all downloads\nlet FileDownloads= SAPAuditLog\n    | where MessageID == \"AUY\"\n    | where TimeGenerated > ago (TimeAgo*2) and ingestion_time() > ago(TimeAgo)\n    | where SystemID in (SelectedSystems)\n    | where TransactionCode in (SensitiveTcodes) or ABAPProgramName in (UnionABAP)\n    | join kind=leftantisemi excludedUsers on $left.User == $right.User2Exclude // exclude specific users\n    | extend ByteCount= toint(replace_string(replace_string(Variable1, \".\",\"\"), \",\",\"\")), Code=Variable2, Path= Variable3\n    | summarize DownloadsByUser = count(), Paths= make_set(Variable3, 10), ByteCount=sum(ByteCount) by TimeDownloaded= bin(TimeGenerated, TimeBetweenAccessAndDownload), SystemID, ClientID, User, TerminalIPv6, Email, Host, TransactionCode, Instance;\n// Time window join to find dowloads after table access\nFileDownloads | join kind=inner (SensitiveTableAccess | union SensitiveProgramExec, SensitiveTcodeExec) on User, SystemID\n    | where (TimeAccessed- TimeDownloaded) between (-(TimeBetweenAccessAndDownload*2) .. 0h)\n    | summarize Activities= tostring( make_set_if(Activities, tostring(Activities) != \"\")), DownloadsByUser= max(DownloadsByUser), ByteCount=max(ByteCount), TablesOrPrograms=make_set(TableOrProgram,10), SourceActions= make_set(SourceAction,10), TimeAccessed= any(TimeAccessed) by TimeDownloaded, User, SystemID, ClientID, Email, Host , TerminalIPv6, Paths= tostring(Paths), Instance\n    | where ByteCount > ByteCountThreshold\n    | extend PackedDetails= pack_all()\n    | extend Details= strcat(\"User \", User, \" has downloaded \", ByteCount, \" bytes of potentially sensitive data \")\n    | extend AlertDetails= strcat(Details , tostring(SourceActions)), Dummy= ''\n| extend AlertRuleUniqueName = 'highvolumeofpotentiallysensitivedataexported'\n",
                                "queryFrequency": "PT4H",
                                "queryPeriod": "P7D",
                                "severity": "High",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                    {
                                        "connectorId": "SAP",
                                        "dataTypes": [
                                            "SAPAuditLog",
                                            "SAPSystems",
                                            "SAPUsersGetVIP"
                                        ]
                                    }
                                ],
                                "tactics": [
                                    "Exfiltration"
                                ],
                                "entityMappings": [
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Email"
                                            }
                                        ],
                                        "entityType": "Account"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Name",
                                                "columnName": "SystemID"
                                            },
                                            {
                                                "identifier": "AppId",
                                                "columnName": "ClientID"
                                            },
                                            {
                                                "identifier": "InstanceName",
                                                "columnName": "Instance"
                                            }
                                        ],
                                        "entityType": "CloudApplication"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Address",
                                                "columnName": "TerminalIPv6"
                                            }
                                        ],
                                        "entityType": "IP"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "HostName",
                                                "columnName": "Host"
                                            }
                                        ],
                                        "entityType": "Host"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "ProcessId",
                                                "columnName": "TablesOrPrograms"
                                            }
                                        ],
                                        "entityType": "Process"
                                    }
                                ],
                                "eventGroupingSettings": {
                                    "aggregationKind": "AlertPerResult"
                                },
                                "customDetails": {
                                    "SourceActions": "SourceActions",
                                    "PackedDetails": "PackedDetails",
                                    "Paths": "Paths",
                                    "SAP_User": "User",
                                    "TablesOrPrograms": "TablesOrPrograms",
                                    "Activities": "Activities",
                                    "AlertRuleUniqueName": "AlertRuleUniqueName"
                                },
                                "alertDetailsOverride": {
                                    "alertDescriptionFormat": "High volume of data exported via files in proximity to an execution of a sensitive transaction, a sensitive program or direct access to sensitive table.\nActions that triggered this alert:\n{{SourceActions}}\n\nThere are a few ways to exclude users, transactions and tables listed in the alert's KQL body.\n",
                                    "alertTacticsColumnName": "Dummy",
                                    "alertDisplayNameFormat": "{{Details}}",
                                    "alertSeverityColumnName": "Dummy"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject10').analyticRuleId10,'/'))))]",
                            "properties": {
                                "description": "SAP Analytics Rule 10",
                                "parentId": "[variables('analyticRuleObject10').analyticRuleId10]",
                                "contentId": "[variables('analyticRuleObject10')._analyticRulecontentId10]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject10').analyticRuleVersion10]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SAP",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('analyticRuleObject10')._analyticRulecontentId10]",
                "contentKind": "AnalyticsRule",
                "displayName": "SAP - (Preview) High volume of potentially sensitive data exported",
                "contentProductId": "[variables('analyticRuleObject10')._analyticRulecontentProductId10]",
                "id": "[variables('analyticRuleObject10')._analyticRulecontentProductId10]",
                "version": "[variables('analyticRuleObject10').analyticRuleVersion10]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('analyticRuleObject11').analyticRuleTemplateSpecName11]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP - (Preview) Printing of potentially sensitive data_AnalyticalRules Analytics Rule with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('analyticRuleObject11').analyticRuleVersion11]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                            "name": "[variables('analyticRuleObject11')._analyticRulecontentId11]",
                            "apiVersion": "2022-04-01-preview",
                            "kind": "Scheduled",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "description": "User has requested printing or has printed data which is potentially sensitive.\nData is considered sensitive if it is obtained by using a sensitive transaction, by executing a sensitive program or by directly accessing a sensitive table.",
                                "displayName": "SAP - (Preview) Printing of potentially sensitive data",
                                "enabled": false,
                                "query": "// SAP - Potentially sensitive data exported via spool request\n// Spool requests made by users who were obsereved accessing sensitive data\n// or sensitive programs/ transactions\n// actual lookback is set by setting TimeAgo\nlet TimeAgo= 4h;\nlet TimeBetweenAccessAndDownload= 30m;\n// CONFIGURATION OPTION- determine which system roles are relevant for this alert\nlet SelectedSystemRoles=  dynamic([\"Production\"]); //can also do// let SelectedSystemRoles =  dynamic([\"Production\", \"UAT\"]); dynamic([\"All System Roles\"])\n// let SelectedSystemRoles= dynamic([\"All System Roles\"]);\nlet SelectedSystems = SAPSystems(SelectedSystemRoles= SelectedSystemRoles)\n    | project SystemID= SearchKey;\n// Get sensitive Tables\n// CONFIGURATION OPTION- list sensitive tables in the 'SAP - Sensitive Tables' watchlist\nlet SensitiveTables = _GetWatchlist('SAP - Sensitive Tables')\n    | summarize by Table;\nlet TableAccessTcodes= dynamic([\"SE16\", \"SE16N\", \"SE11\", \"SE16H\", \"SM30\", \"SE12\", \"SM31\", \"SE16H\", \"SE14\", \"SE54\", \"SE17\", \"SE16T\", \"DB01\", \"DB02\"]);\n// CONFIGURATION OPTION- list sensitive transactions in the 'SAP - Sensitive Transactions' watchlist\nlet SensitiveTransWL= toscalar(_GetWatchlist('SAP - Sensitive Transactions')\n    | summarize TransactionCodes= make_set(TransactionCode));\n// CONFIGURATION OPTION- exclude TCODEs which are not to be considered\nlet ExcludedTcodes= dynamic([\"S000\", \"\"]);\nlet SensitiveTcodes= (set_difference(set_union(SensitiveTransWL, TableAccessTcodes), ExcludedTcodes));\n// CONFIGURATION OPTION- list sensitive programs in the 'SAP - Sensitive ABAP Programs' watchlist\nlet SensitiveABAPReports = _GetWatchlist('SAP - Sensitive ABAP Programs');\nlet fixedABAPReports = datatable(ABAPProgram: string) [\"RSPFLDOC\"];\nlet UnionABAP = union isfuzzy=true SensitiveABAPReports, fixedABAPReports\n    | summarize by ABAPProgram;\n// CONFIGURATION OPTION- exclude system users which are OK to print sensitive data\n// by adding those users in the SAP_User_Config watchlist with a tag of 'PrintSensitivesOK'\n// can also specify SAP Roles or Profiles to exclude\nlet excludeUsersTags= dynamic(['PrintSensitivesOK', 'SAP_ROLE1', 'SAP_PROFILE1']);\nlet excludedUsers= SAPUsersGetVIP(SearchForTags= excludeUsersTags)\n    | summarize by User2Exclude=SAPUser;\n// Get direct sensitive table access\nlet SensitiveTableAccess= SAPAuditLog\n    | where TimeGenerated > ago (TimeAgo * 2) and ingestion_time() > ago(TimeAgo)\n    | where MessageID == \"DU9\"\n    | where SystemID in (SelectedSystems)\n    | where Variable1 in (SensitiveTables)\n    | project-rename Table = Variable1, Activity = Variable2\n    | summarize Activities= make_set(Activity, 3)\n        by TimeAccessed= bin(TimeGenerated, TimeBetweenAccessAndDownload), SystemID, ClientID, User, ABAPProgramName, Email, Host, TerminalIPv6\n        , Table, SourceAction= strcat(\"after visiting transaction \", TransactionCode, \" and viewing sensitive table \", Table), TransactionCode, TableOrProgram= Table, Instance;\n// get sensitive program execution\nlet SensitiveProgramExec= SAPAuditLog\n    | where TimeGenerated > ago (TimeAgo * 2) and ingestion_time() > ago(TimeAgo)\n    | where MessageID == \"AUW\"\n    | where SystemID in (SelectedSystems)\n    | where ABAPProgramName in (UnionABAP)\n    | summarize\n        by\n        TimeAccessed= bin(TimeGenerated, TimeBetweenAccessAndDownload),\n        SystemID,\n        ClientID,\n        User,\n        ABAPProgramName,\n        Email,\n        Host,\n        TerminalIPv6,\n        SourceAction= strcat(\"after executing sensitive program \", ABAPProgramName),\n        TransactionCode,\n        TableOrProgram= ABAPProgramName,\n        Instance;\n// get sensitive transaction execution\nlet SensitiveTcodeExec= SAPAuditLog\n    | where TimeGenerated > ago (TimeAgo * 2) and ingestion_time() > ago(TimeAgo)\n    | where MessageID == \"AU3\"\n    | where SystemID in (SelectedSystems)\n    // make sure sensitive transactions do not contain the TableAccessTcodes which are checked for the specific table name\n    | where TransactionCode in (set_difference(SensitiveTcodes, TableAccessTcodes))\n    | summarize\n        by\n        TimeAccessed= bin(TimeGenerated, TimeBetweenAccessAndDownload),\n        SystemID,\n        ClientID,\n        User,\n        ABAPProgramName,\n        SourceAction= strcat(\"after executing sensitive transaction \", TransactionCode),\n        TransactionCode,\n        TableOrProgram= TransactionCode,\n        Email,\n        Host,\n        TerminalIPv6,\n        Instance;\n// Get all spool requests\nlet SpoolRequests= SAPSpoolLog\n    | where TimeGenerated > ago (TimeAgo * 2) and ingestion_time() > ago(TimeAgo)\n    | summarize\n        by\n        SpoolRequestNumber,\n        ClientID,\n        User,\n        RecipientofSpoolRequest,\n        SpoolRequestSuffix2,\n        SpoolRequestTitle,\n        SystemID,\n        OutputDevice,\n        DeleteSpoolRequestAuto,\n        TimeRequested= TimeGenerated,\n        ValueAuthCheck;\nlet SpoolOutputs= SAPSpoolOutputLog\n    | where TimeGenerated > ago (TimeAgo * 2) and ingestion_time() > ago(TimeAgo)\n    | summarize\n        by\n        SpoolRequestNumber,\n        User,\n        RecipientofSpoolRequest,\n        PhysicalFormatType,\n        SystemID,\n        ClientID,\n        TimePrinted= TimeGenerated\n    | lookup (SAP_USR02\n        | summarize by SystemID, RecipientofSpoolRequest= BNAME, USTYP, ClientID= MANDT)\n        on RecipientofSpoolRequest, SystemID, ClientID\n    | extend\n        HasPrinted= true,\n        PrintRecievedByAnother= iff(User == RecipientofSpoolRequest, false, iff(isempty(USTYP), false, true));\nSpoolRequests\n| join kind=inner (SensitiveTableAccess\n    | union SensitiveProgramExec, SensitiveTcodeExec)\n    on User, SystemID\n| where (TimeAccessed - TimeRequested) between (-(TimeBetweenAccessAndDownload * 2) .. 0h)\n| lookup SpoolOutputs on SpoolRequestNumber, SystemID, ClientID\n| summarize Activities= tostring(make_set_if(Activities, tostring(Activities) != \"\"))\n    , TablesOrPrograms=make_set(TableOrProgram, 10), SourceActions= make_set(SourceAction, 10)\n    , TimeAccessed= min(TimeAccessed), TimeRequested= min(TimeRequested), HasPrinted=max(HasPrinted)\n    , PrintRecievedByAnother=max(PrintRecievedByAnother), RecipientofSpoolRequest= max(RecipientofSpoolRequest)\n    by\n    User,\n    SystemID,\n    Email,\n    Host,\n    TerminalIPv6,\n    ClientID,\n    Instance\n| extend PackedDetails= pack_all()\n| extend Details= strcat(\"User \", User, \" has \", iff(HasPrinted, \"printed\", \"requested printing of\"), \" potentially sensitive data \")\n| extend AlertDetails= strcat(Details, tostring(SourceActions), iff(PrintRecievedByAnother, strcat(\"<br/> Print has been pulled by another User \", RecipientofSpoolRequest), \"\")), Dummy= ''\n| extend AlertRuleUniqueName = 'printingofpotentiallysensitivedata'\n",
                                "queryFrequency": "PT4H",
                                "queryPeriod": "PT5H",
                                "severity": "High",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                    {
                                        "connectorId": "SAP",
                                        "dataTypes": [
                                            "SAP_USR02",
                                            "SAPAuditLog",
                                            "SAPSpoolLog",
                                            "SAPSpoolOutputLog",
                                            "SAPSystems",
                                            "SAPUsersGetVIP"
                                        ]
                                    }
                                ],
                                "tactics": [
                                    "Exfiltration"
                                ],
                                "entityMappings": [
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Email"
                                            }
                                        ],
                                        "entityType": "Account"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Name",
                                                "columnName": "SystemID"
                                            },
                                            {
                                                "identifier": "AppId",
                                                "columnName": "ClientID"
                                            },
                                            {
                                                "identifier": "InstanceName",
                                                "columnName": "Instance"
                                            }
                                        ],
                                        "entityType": "CloudApplication"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Address",
                                                "columnName": "TerminalIPv6"
                                            }
                                        ],
                                        "entityType": "IP"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "HostName",
                                                "columnName": "Host"
                                            }
                                        ],
                                        "entityType": "Host"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "ProcessId",
                                                "columnName": "TablesOrPrograms"
                                            }
                                        ],
                                        "entityType": "Process"
                                    }
                                ],
                                "eventGroupingSettings": {
                                    "aggregationKind": "AlertPerResult"
                                },
                                "customDetails": {
                                    "SourceActions": "SourceActions",
                                    "PackedDetails": "PackedDetails",
                                    "SAP_User": "User",
                                    "TablesOrPrograms": "TablesOrPrograms",
                                    "Activities": "Activities",
                                    "AlertRuleUniqueName": "AlertRuleUniqueName"
                                },
                                "alertDetailsOverride": {
                                    "alertDescriptionFormat": "Printing requested in proximity to an execution of a sensitive transaction, a sensitive program or direct access to sensitive table.\nActions that triggered this alert:\n{{SourceActions}}\nThere are a few ways to exclude users, transactions and tables listed in the alert's KQL body.\n",
                                    "alertTacticsColumnName": "Dummy",
                                    "alertDisplayNameFormat": "{{Details}}",
                                    "alertSeverityColumnName": "Dummy"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject11').analyticRuleId11,'/'))))]",
                            "properties": {
                                "description": "SAP Analytics Rule 11",
                                "parentId": "[variables('analyticRuleObject11').analyticRuleId11]",
                                "contentId": "[variables('analyticRuleObject11')._analyticRulecontentId11]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject11').analyticRuleVersion11]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SAP",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('analyticRuleObject11')._analyticRulecontentId11]",
                "contentKind": "AnalyticsRule",
                "displayName": "SAP - (Preview) Printing of potentially sensitive data",
                "contentProductId": "[variables('analyticRuleObject11')._analyticRulecontentProductId11]",
                "id": "[variables('analyticRuleObject11')._analyticRulecontentProductId11]",
                "version": "[variables('analyticRuleObject11').analyticRuleVersion11]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('analyticRuleObject12').analyticRuleTemplateSpecName12]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP - (Preview) Sensitive Static Parameter Has Changed_AnalyticalRules Analytics Rule with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('analyticRuleObject12').analyticRuleVersion12]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                            "name": "[variables('analyticRuleObject12')._analyticRulecontentId12]",
                            "apiVersion": "2022-04-01-preview",
                            "kind": "Scheduled",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "description": "Produces alerts on static parameter changes which are considered as risky",
                                "displayName": "SAP - (Preview) Sensitive Static Parameter Has Changed",
                                "enabled": false,
                                "query": "// Risky static parameter changes\n// IMPORTANT!!!!! Please set the alert lookback period for at least 7 days, to make sure that the activities of server restart and parameter historical changes are detected.\n// this is the actual lookback period for parameter changes\nlet LookBack4Changes= 2h;\nlet SelectedSystemRoles =  dynamic([\"All System Roles\"]); //can also do// let SelectedSystemRoles =  dynamic([\"Production\", \"UAT\"]);\n// we need to look back in PAHI 1d as PAHI updates are full dialy + hourly deltas\nlet PAHILookBack= 36h;\n// get the alert relevant parameters\nlet GetSystemParams= materialize(SAPGetSystemParameter()\n| where EnableAlerts\n| project-away SearchKey, EnableAlerts, DummyJoinField, LastUpdatedTimeUTC);\nlet ParameterSets= GetSystemParams |summarize RelevantParams= make_set(ParameterName, 1000);\nlet StateDescriptions= dynamic({\"A\":\"Active\", \"C\": \"Changed\", \"O\": \"Original\", \"D\": \"<<parameter inactive>>\" });\n// CONFIGURATION OPTION- determine which system roles are relevant for this alert\nlet SelectedSystems = SAPSystems(SelectedSystemRoles= SelectedSystemRoles)\n    | project SystemID= SearchKey, SystemRole, SystemUsage\n    | extend SystemRole= replace_string(SystemRole, 'Unknown (Production)', 'Unknown');\nlet RiskyParameterChanges= materialize(SAP_PAHI\n| where SystemID in (SelectedSystems)\n| where PARNAME in (ParameterSets)\n| where TimeGenerated > ago(PAHILookBack) // PAHI is loaded in full mode daily with entire history\n| summarize LastObserved= max(TimeGenerated), FirstObserved= min(TimeGenerated) by PARNAME, PARTYPE, HOSTNAME, SYSTEMID, PARDATE, PARSTATE, PARVALUE, SystemID\n| extend ChangeDay= todatetime(PARDATE)\n| extend FirstObserved= iff(startofday(FirstObserved)== ChangeDay,FirstObserved, ChangeDay));\n// recently changed\nlet RecentlyChangedParameters= RiskyParameterChanges\n| where PARSTATE != \"C\" // latest state can't be \"Changed\"\n| where strcmp( PARDATE, format_datetime(ago(LookBack4Changes), \"yyyyMMdd\")) >= 0\n| where FirstObserved > ago(LookBack4Changes + 60m)\n| project-rename LastChangedOn= ChangeDay, LatestParValue= PARVALUE, LatestParState= PARSTATE;\n// look for application server starts, as the static parameters take effect after restart\nlet ApplicationServerRestarts= (SAPAuditLog\n| where SystemID in (SelectedSystems)\n| where MessageID == \"AUH\"\n| summarize by ServerStartTimeDT= UpdatedOn_t, SystemID) ;\n// look for executions of transaction which are used for parameter changes\nlet ParameterChangeActions= (SAPAuditLog\n| where SystemID in (SelectedSystems)\n| where MessageID == \"AU3\"\n| where (Variable1 == \"RZ10\" or Variable1 == \"RZ10\") or (TransactionCode == \"RZ10\" or TransactionCode == \"RZ10\"))\n| project ParameterChangeActionDT= UpdatedOn_t, User, SystemID, MessageText, TransactionCode= Variable1, Email;\nRecentlyChangedParameters\n// get all matching parameters so we can look for previous values\n| join kind= leftouter (RiskyParameterChanges | project PARNAME, PARVALUE, HOSTNAME, SystemID, PreviousChangeDate= ChangeDay, PARSTATE, SYSTEMID) on PARNAME, SystemID, SYSTEMID, HOSTNAME\n| project-away PARNAME1, HOSTNAME1, SystemID1\n| where LastChangedOn > PreviousChangeDate\n| where PARVALUE != LatestParValue or PARSTATE !=  LatestParState\n// keep the latest record from the PreviousChangeDate history\n| summarize FirstObserved= min(FirstObserved), PreviousChangeDate= arg_max(PreviousChangeDate, *) by ParameterName= PARNAME, SystemID, PARTYPE, LatestParState, SYSTEMID, LastObserved , LastChangedOn, HOSTNAME\n| summarize FirstObserved= min(FirstObserved) by ParameterName, LatestParValue, LatestParState, SystemID, PreviousChangeDate, PreviousParValue= PARVALUE, PreviousParState= PARSTATE, SystemNumber= SYSTEMID, Host= HOSTNAME\n| lookup GetSystemParams on SystemID, ParameterName\n| join kind= leftouter ApplicationServerRestarts on SystemID\n| where (FirstObserved > ServerStartTimeDT or isnull(ServerStartTimeDT))\n| join kind= leftouter ParameterChangeActions on SystemID\n| where (FirstObserved > ParameterChangeActionDT or isnull(ParameterChangeActionDT))\n| summarize ServerStartTimeDT= arg_max(ServerStartTimeDT, *) by ParameterName, SystemID, ParameterChangeActionDT, SystemNumber, Host\n| summarize ParameterChangeActionDT= arg_max(ParameterChangeActionDT, *) by ParameterName, SystemID, SystemNumber, Host\n| project-rename ParameterDescription= Comment\n| project-away SystemID1, SystemID2\n| extend LatestParState= tostring(StateDescriptions[LatestParState]), PreviousParState= tostring(StateDescriptions[PreviousParState])\n| extend ChangeScope= case((LatestParState == \"Active\" and PreviousParState == \"<<parameter inactive>>\"),strcat(\"activated\")\n,(LatestParValue == PreviousParValue and LatestParState == \"Active\" and PreviousParState == \"Changed\"),\"No changes detected\"\n,(LatestParValue != PreviousParValue and LatestParState == \"Active\"),\"changed\"\n, (LatestParState == \"<<parameter inactive>>\" and PreviousParState != \"<<parameter inactive>>\"),\"deactivated\", \"Not sure\")\n| where ChangeScope != \"No changes detected\"\n| extend LatestNumeric= extract(\"([0-9.]+)\", 1, replace(\",\",\".\", LatestParValue), typeof(real))\n| extend LatestAlpha= extract(\"([A-Z]+[a-z])\", 1, LatestParValue, typeof(string))\n| extend ValueComparison= case(ExpectedValue == LatestParValue and (Option in(dynamic([\"LE\", \"GE\", \"EQ\"])) or isempty( Option)), \"OK\"\n, (Option == \"AlertOnAnyChange\" and LatestParValue != PreviousParValue), \"Not OK\"\n, LatestAlpha != ExpectedAlpha, \"Cannot compare values of different units\"\n, LatestNumeric >= ExpectedNumeric and Option in(dynamic([\"GT\", \"GE\"])), \"OK\"\n, LatestNumeric <= ExpectedNumeric and Option in(dynamic([\"LT\", \"LE\"])), \"OK\"\n, \"Not OK\")\n| extend ExpectedValue= iff(Option == \"AlertOnAnyChange\", \"alert on any value changes \",strcat(\"Expected value is \", Option, \" '\", ExpectedValue, \"'\"))\n| extend AlertName= strcat(\"SAP Parameter '\", ParameterName, \"' was  \", ChangeScope, iff(isnotempty( SystemRole),strcat(\" in a \", tolower(SystemRole), \" system\"), \"\"),\".\")\n| extend Details= strcat(AlertName, iff(ChangeScope == \"activated\", strcat(\", value set to '\", LatestParValue, \"'\"), iff(ChangeScope == \"deactivated\", strcat(\" Previous values was '\", PreviousParValue,\"'\")\n, iff(ChangeScope == \"changed\", strcat(\" Value changed from '\", PreviousParValue, \"'\", \" to '\", LatestParValue, \"'\"),\"'\"))),\".\")\n| extend ExtendedDetails= strcat(\"The parameter \", ParameterName, \" is described as '\", ParameterDescription,\"'. This parameter change is a static change. Parameter change was first observed on \"\n, format_datetime(FirstObserved,\"yy-MM-dd [HH:mm:ss]\"), \" , and has likely taken effect after an application server start.\"\n, iff(isnotnull(ServerStartTimeDT), strcat(\" A server restart was reported on \", format_datetime(ServerStartTimeDT,\"yy-MM-dd [HH:mm:ss]\"),\".\"),\"\")\n, iff(isnotnull(ParameterChangeActionDT), strcat(\" The last parameter change detected on the sytem was performed on \", format_datetime(ParameterChangeActionDT,\"yy-MM-dd [HH:mm:ss]\"), \" by user \", User,\".\"),\"\"),\". \", ExpectedValue)\n| project-reorder ValueComparison, ExpectedValue, ChangeScope, Details, LatestParValue, PreviousParValue, LatestParState, PreviousParState\n| where ValueComparison != \"OK\"\n| extend Dummy= \"\"\n| extend AlertRuleUniqueName = 'sensitivestaticparameterhaschanged'\n",
                                "queryFrequency": "PT1H",
                                "queryPeriod": "P7D",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                    {
                                        "connectorId": "SAP",
                                        "dataTypes": [
                                            "SAP_PAHI",
                                            "SAPAuditLog",
                                            "SAPGetSystemParameter",
                                            "SAPSystems"
                                        ]
                                    }
                                ],
                                "tactics": [
                                    "Impact"
                                ],
                                "entityMappings": [
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Name",
                                                "columnName": "SystemID"
                                            }
                                        ],
                                        "entityType": "CloudApplication"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "HostName",
                                                "columnName": "Host"
                                            }
                                        ],
                                        "entityType": "Host"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Email"
                                            }
                                        ],
                                        "entityType": "Account"
                                    }
                                ],
                                "eventGroupingSettings": {
                                    "aggregationKind": "AlertPerResult"
                                },
                                "customDetails": {
                                    "SystemRole": "SystemRole",
                                    "LatestParValue": "LatestParValue",
                                    "ParameterName": "ParameterName",
                                    "AlertRuleUniqueName": "AlertRuleUniqueName",
                                    "SystemNumber": "SystemNumber",
                                    "SAPUser": "User"
                                },
                                "alertDetailsOverride": {
                                    "alertDescriptionFormat": "<img src=\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/SAP/Workbooks/SAPVMIcon.svg\" width=\"30\"/>\n  </br>\n{{Details}}.\n{{ExtendedDetails}}.\n</br>\nFor more troubleshooting guidance, visit the [documentation](https://aka.ms/Sentinel4SAPDocsParameterChanges).\n",
                                    "alertTacticsColumnName": "Dummy",
                                    "alertDisplayNameFormat": "{{AlertName}}",
                                    "alertSeverityColumnName": "Severity"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject12').analyticRuleId12,'/'))))]",
                            "properties": {
                                "description": "SAP Analytics Rule 12",
                                "parentId": "[variables('analyticRuleObject12').analyticRuleId12]",
                                "contentId": "[variables('analyticRuleObject12')._analyticRulecontentId12]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject12').analyticRuleVersion12]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SAP",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('analyticRuleObject12')._analyticRulecontentId12]",
                "contentKind": "AnalyticsRule",
                "displayName": "SAP - (Preview) Sensitive Static Parameter Has Changed",
                "contentProductId": "[variables('analyticRuleObject12')._analyticRulecontentProductId12]",
                "id": "[variables('analyticRuleObject12')._analyticRulecontentProductId12]",
                "version": "[variables('analyticRuleObject12').analyticRuleVersion12]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('analyticRuleObject13').analyticRuleTemplateSpecName13]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP - (Preview) Sensitive data saved into a USB drive_AnalyticalRules Analytics Rule with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('analyticRuleObject13').analyticRuleVersion13]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                            "name": "[variables('analyticRuleObject13')._analyticRulecontentId13]",
                            "apiVersion": "2022-04-01-preview",
                            "kind": "Scheduled",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "description": "SAP data exported via files and saved into a recently mounted USB drive in proximity to an execution of a sensitive transaction, a sensitive program or direct access to a sensitive table.",
                                "displayName": "SAP - (Preview) Sensitive data saved into a USB drive",
                                "enabled": false,
                                "query": "// SAP - Sensitive data saved into a USB drive\n// Data exported via files and saved into a recently mounted USB drive in proximity to an execution of a sensitive transaction, a sensitive program or direct access to sensitive table.\n// !!!IMPORTANT!!!\n// please keep \"Lookup data from the last\" to be 14 days to allow coverage of USB drive mount events\n// actual lookback is set by setting TimeAgo\nlet TimeAgo= 4h;\nlet TimeBetweenAccessAndDownload= 60m;\nlet FilesDownloadedToUSB= DeviceFileEvents\n    | where ingestion_time() >= ago(TimeAgo)\n    | join kind=inner  (DeviceEvents\n    | where ActionType == \"UsbDriveMounted\"\n    | extend DriveLetter = tostring(AdditionalFields.DriveLetter)\n    | summarize MountedDriveLetters = make_set(DriveLetter, 26) by DeviceId, DeviceName)\n    on DeviceId\n| extend TargetDriveLetter = tostring(split(FolderPath, \"\\\\\")[0])\n| where set_has_element(MountedDriveLetters, TargetDriveLetter)\n| project USBFileSize= FileSize, USBFolderPath= FolderPath;\n// CONFIGURATION OPTION- determine which system roles are relevant for this alert\nlet SelectedSystemRoles=  dynamic([\"Production\"]); //can also do// let SelectedSystemRoles =  dynamic([\"Production\", \"UAT\"]); dynamic([\"All System Roles\"])\n// let SelectedSystemRoles= dynamic([\"All System Roles\"]);\nlet SelectedSystems = SAPSystems(SelectedSystemRoles= SelectedSystemRoles) | project SystemID= SearchKey;\n// Get sensitive Tables\n// CONFIGURATION OPTION- list sensitive tables in the 'SAP - Sensitive Tables' watchlist\nlet SensitiveTables = _GetWatchlist('SAP - Sensitive Tables') | summarize by Table;\nlet TableAccessTcodes= dynamic([\"SE16\", \"SE16N\", \"SE11\", \"SE16H\", \"SM30\", \"SE12\", \"SM31\", \"SE16H\", \"SE14\", \"SE54\",\"SE17\", \"SE16T\", \"DB01\", \"DB02\"]);\n// CONFIGURATION OPTION- list sensitive transactions in the 'SAP - Sensitive Transactions' watchlist\nlet SensitiveTransWL= toscalar(_GetWatchlist('SAP - Sensitive Transactions') | summarize TransactionCodes= make_set(TransactionCode));\n// CONFIGURATION OPTION- exclude TCODEs which are not to be considered\nlet ExcludedTcodes= dynamic([\"S000\", \"\"]);\nlet SensitiveTcodes= (set_difference(set_union(SensitiveTransWL, TableAccessTcodes), ExcludedTcodes));\n// CONFIGURATION OPTION- list sensitive programs in the 'SAP - Sensitive ABAP Programs' watchlist\nlet SensitiveABAPReports = _GetWatchlist('SAP - Sensitive ABAP Programs');\nlet fixedABAPReports = datatable(ABAPProgram:string) [\"RSPFLDOC\"];\nlet UnionABAP = union isfuzzy=true SensitiveABAPReports, fixedABAPReports| summarize by ABAPProgram;\n// Get direct sensitive table access\nlet SensitiveTableAccess= SAPAuditLog\n    | where TimeGenerated > ago (TimeAgo*2) and ingestion_time() > ago(TimeAgo)\n    | where MessageID == \"DU9\"\n    | where SystemID in (SelectedSystems)\n    | where Variable1 in (SensitiveTables)\n    | project-rename Table = Variable1, Activity = Variable2\n    | summarize Activities= make_set(Activity, 3) by TimeAccessed= bin(TimeGenerated, TimeBetweenAccessAndDownload), SystemID, ClientID, User, ABAPProgramName\n    , Table, SourceAction= strcat(\"after visiting transaction \", TransactionCode, \" and viewing sensitive table \", Table), TransactionCode, TableOrProgram= Table;\n// get sensitive program execution\nlet SensitiveProgramExec= SAPAuditLog\n    | where TimeGenerated > ago (TimeAgo*2) and ingestion_time() > ago(TimeAgo)\n    | where MessageID == \"AUW\"\n    | where SystemID in (SelectedSystems)\n    | where ABAPProgramName in (UnionABAP)\n    | summarize by TimeAccessed= bin(TimeGenerated, TimeBetweenAccessAndDownload), SystemID, ClientID, User, ABAPProgramName\n    , SourceAction= strcat(\"after executing sensitive program \", ABAPProgramName), TransactionCode, TableOrProgram= ABAPProgramName ;\n// get sensitive transaction execution\nlet SensitiveTcodeExec= SAPAuditLog\n    | where TimeGenerated > ago (TimeAgo*2) and ingestion_time() > ago(TimeAgo)\n    | where MessageID == \"AU3\"\n    | where SystemID in (SelectedSystems)\n    // make sure sensitive transactions do not contain the TableAccessTcodes which are checked for the specific table name\n    | where TransactionCode in (set_difference(SensitiveTcodes,TableAccessTcodes))\n    | summarize by TimeAccessed= bin(TimeGenerated, TimeBetweenAccessAndDownload), SystemID, ClientID, User, ABAPProgramName, SourceAction= strcat(\"after executing sensitive transaction \", TransactionCode), TransactionCode, TableOrProgram= TransactionCode;\n// Get all downloads\nlet FileDownloads= SAPAuditLog\n    | where MessageID == \"AUY\"\n    | where TimeGenerated > ago (TimeAgo*2) and ingestion_time() > ago(TimeAgo)\n    | where SystemID in (SelectedSystems)\n    | where TransactionCode in (SensitiveTcodes) or ABAPProgramName in (UnionABAP)\n    | join kind= innerunique FilesDownloadedToUSB on $left.Variable3== $right.USBFolderPath\n    | extend ByteCount= toint(replace_string(replace_string(Variable1, \".\",\"\"), \",\",\"\")), Code=Variable2, Path= Variable3\n    | summarize DownloadsByUser = count(), Paths= make_set(Variable3, 10), ByteCount=sum(ByteCount) by TimeDownloaded= bin(TimeGenerated, TimeBetweenAccessAndDownload), SystemID, ClientID, User, TerminalIPv6, Email, Host, TransactionCode, Instance;\n// Time window join to find dowloads after table access\nFileDownloads | join kind=inner (SensitiveTableAccess | union SensitiveProgramExec, SensitiveTcodeExec) on User, SystemID\n    | where (TimeAccessed- TimeDownloaded) between (-(TimeBetweenAccessAndDownload*2) .. 0h)\n    | summarize Activities= tostring( make_set_if(Activities, tostring(Activities) != \"\")), DownloadsByUser= max(DownloadsByUser), ByteCount=max(ByteCount), TablesOrPrograms=make_set(TableOrProgram,10), SourceActions= make_set(SourceAction,10), TimeAccessed= any(TimeAccessed) by TimeDownloaded, User, SystemID, ClientID, Email, Host , TerminalIPv6, Paths= tostring(Paths), Instance\n    | extend PackedDetails= pack_all()\n    | extend Details= strcat(\"User \", User, \" has downloaded \", ByteCount, \" bytes of potentially sensitive data \")\n    | extend AlertDetails= strcat(Details , tostring(SourceActions)), Dummy= ''\n| extend AlertRuleUniqueName = 'sensitivedatasavedintoausbdrive'\n",
                                "queryFrequency": "PT4H",
                                "queryPeriod": "P7D",
                                "severity": "High",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                    {
                                        "connectorId": "SAP",
                                        "dataTypes": [
                                            "SAPAuditLog",
                                            "SAPSystems"
                                        ]
                                    }
                                ],
                                "tactics": [
                                    "Exfiltration"
                                ],
                                "entityMappings": [
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Email"
                                            }
                                        ],
                                        "entityType": "Account"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Name",
                                                "columnName": "SystemID"
                                            },
                                            {
                                                "identifier": "AppId",
                                                "columnName": "ClientID"
                                            },
                                            {
                                                "identifier": "InstanceName",
                                                "columnName": "Instance"
                                            }
                                        ],
                                        "entityType": "CloudApplication"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Address",
                                                "columnName": "TerminalIPv6"
                                            }
                                        ],
                                        "entityType": "IP"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "HostName",
                                                "columnName": "Host"
                                            }
                                        ],
                                        "entityType": "Host"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "ProcessId",
                                                "columnName": "TablesOrPrograms"
                                            }
                                        ],
                                        "entityType": "Process"
                                    }
                                ],
                                "eventGroupingSettings": {
                                    "aggregationKind": "AlertPerResult"
                                },
                                "customDetails": {
                                    "SourceActions": "SourceActions",
                                    "PackedDetails": "PackedDetails",
                                    "Paths": "Paths",
                                    "SAP_User": "User",
                                    "TablesOrPrograms": "TablesOrPrograms",
                                    "Activities": "Activities",
                                    "AlertRuleUniqueName": "AlertRuleUniqueName"
                                },
                                "alertDetailsOverride": {
                                    "alertDescriptionFormat": "High volume of data exported via files in proximity to an execution of a sensitive transaction, a sensitive program or direct access to sensitive table.\nActions that triggered this alert:\n{{SourceActions}}\n\nThere are a few ways to exclude users, transactions and tables listed in the alert's KQL body.\n",
                                    "alertTacticsColumnName": "Dummy",
                                    "alertDisplayNameFormat": "{{Details}}",
                                    "alertSeverityColumnName": "Dummy"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject13').analyticRuleId13,'/'))))]",
                            "properties": {
                                "description": "SAP Analytics Rule 13",
                                "parentId": "[variables('analyticRuleObject13').analyticRuleId13]",
                                "contentId": "[variables('analyticRuleObject13')._analyticRulecontentId13]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject13').analyticRuleVersion13]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SAP",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('analyticRuleObject13')._analyticRulecontentId13]",
                "contentKind": "AnalyticsRule",
                "displayName": "SAP - (Preview) Sensitive data saved into a USB drive",
                "contentProductId": "[variables('analyticRuleObject13')._analyticRulecontentProductId13]",
                "id": "[variables('analyticRuleObject13')._analyticRulecontentProductId13]",
                "version": "[variables('analyticRuleObject13').analyticRuleVersion13]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('analyticRuleObject14').analyticRuleTemplateSpecName14]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP - (Preview) Trusted RFC connection created or modified in SAP NetWeaver [CVE-2023-0014] _AnalyticalRules Analytics Rule with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('analyticRuleObject14').analyticRuleVersion14]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                            "name": "[variables('analyticRuleObject14')._analyticRulecontentId14]",
                            "apiVersion": "2022-04-01-preview",
                            "kind": "Scheduled",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "description": "SAP NetWeaver ABAP Server and ABAP Platform creates information about system identity in an ambiguous format.\nThis may be exploited by malicious users to obtain illegitimate access to the system.\nRead SAP note 3281854 - FAQ for Security Note 3089413 for more details. This alert rule helps to identify newly added trusted RFC relationships.",
                                "displayName": "SAP - (Preview) Trusted RFC connection created or modified in SAP NetWeaver [CVE-2023-0014] ",
                                "enabled": false,
                                "query": "//  a per SAP note https://launchpad.support.sap.com/#/notes/3089413\nlet TimeAgo= 1h;\nlet Vulnerability= \"SAP - [CVE-2023-0014] Capture-replay vulnerability in a \";\n// CONFIGURATION OPTION- determine which system roles are relevant for this alert\nlet SelectedSystemRoles =  dynamic([\"All System Roles\"]); //can also do// let SelectedSystemRoles =  dynamic([\"Production\", \"UAT\"]);\nlet SelectedSystems = SAPSystems(SelectedSystemRoles= SelectedSystemRoles)\n    | project SystemID= SearchKey, SystemRole, SystemUsage\n    | extend SystemRole= replace_string(SystemRole, \"Unknown (Production)\", \"Unknown\");\nSAPTableDataLog\n| where TimeGenerated > ago(TimeAgo * 2)\n| where ingestion_time() > ago(TimeAgo)\n// | where isempty(OldValue)\n| where TableName == \"RFCTRUST\" or TableName == \"RFCSYSACL\"\n| join kind = inner SelectedSystems on SystemID\n| extend ScopeOfChange= case(isempty(OldValue) and isnotempty( NewValue),\"created\", OldValue != NewValue and isnotempty( NewValue), \"changed\", isempty(NewValue) and isnotempty(OldValue), \"deleted\" ,\"none\")\n| extend Change= case(ScopeOfChange== \"created\", strcat(ScopeOfChange,\" \",TableField,\"= \",NewValue)\n,ScopeOfChange== \"changed\", strcat(ScopeOfChange,\" \",TableField,\" from \", OldValue,\" to \",NewValue)\n, ScopeOfChange== \"deleted\", strcat(ScopeOfChange,\" \",TableField,\"= \",OldValue), \"No changes\")\n| summarize\n    UserName= any(UserName), SystemChanges=make_set_if(replace_string(Change, \"No changes\", \"Modified\"), TableField == \"RFCSYSID\" or TableField == \"RFCTRUSTID\"),\n    Changes= make_set_if(Change, ScopeOfChange!=\"none\"),\n    TimeStarted= any(TimeGenerated),\n    SystemRole= any(SystemRole),\n    RFCSYSID= make_set_if(NewValue, TableField == \"RFCSYSID\" and isnotempty( NewValue) ),\n    RFCTRUSTID= make_set_if(NewValue, TableField == \"RFCTRUSTID\" and isnotempty( NewValue) ),\n    ScopeOfChanges= make_set_if(ScopeOfChange, ScopeOfChange != \"none\")\n    by SystemID, DBLogID, LogKey, TableName\n| extend\n    RFCSYSID= RFCSYSID[0], RFCTRUSTID= RFCTRUSTID[0], SystemChanges= SystemChanges[0]\n| where isnotempty(RFCSYSID) or isnotempty(RFCTRUSTID)\n| extend AlertName = strcat(\"SAP RFC \", iff(TableName == \"RFCTRUST\", \"trusting \", \"trusted \"), \"system \", SystemChanges, \" for a  \", tolower(SystemRole), \" system\")\n| extend AlertDescription= strcat(iff(TableName == \"RFCTRUST\", strcat(\"System \", RFCSYSID, \" is now trusting system \", RFCTRUSTID), strcat(\"System \", SystemID, \" is now being trusted by system \", RFCSYSID)), \". <br/> Scope of changes:  \",ScopeOfChanges , \". <br/> Changes:  \",Changes ,\". <br/> see  \", Vulnerability)\n| project-away Changes, ScopeOfChanges, SystemChanges, LogKey\n| extend OtherSystem= iff(TableName == \"RFCTRUST\", RFCTRUSTID, RFCSYSID)\n| extend ExtendedLink= \"https://www.cve.org/CVERecord?id=CVE-2023-0014\" , Dummy= \"\"\n\n| extend AlertRuleUniqueName = 'newtrustedrfcconnectioncapture-replayvulnerabilityinsapnetweaver[cve-2023-0014]'\n",
                                "queryFrequency": "PT1H",
                                "queryPeriod": "PT12H",
                                "severity": "High",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                    {
                                        "connectorId": "SAP",
                                        "dataTypes": [
                                            "SAPSystems",
                                            "SAPTableDataLog"
                                        ]
                                    }
                                ],
                                "tactics": [
                                    "CredentialAccess"
                                ],
                                "entityMappings": [
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Name",
                                                "columnName": "SystemID"
                                            }
                                        ],
                                        "entityType": "CloudApplication"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Name",
                                                "columnName": "OtherSystem"
                                            }
                                        ],
                                        "entityType": "CloudApplication"
                                    }
                                ],
                                "eventGroupingSettings": {
                                    "aggregationKind": "AlertPerResult"
                                },
                                "customDetails": {
                                    "AlertRuleUniqueName": "AlertRuleUniqueName",
                                    "SAP_User": "UserName"
                                },
                                "alertDetailsOverride": {
                                    "alertDescriptionFormat": "{{AlertDescription}}",
                                    "alertTacticsColumnName": "Dummy",
                                    "alertDisplayNameFormat": "SAP - {{AlertName}} [CVE-2023-0014] ",
                                    "alertSeverityColumnName": "Dummy"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject14').analyticRuleId14,'/'))))]",
                            "properties": {
                                "description": "SAP Analytics Rule 14",
                                "parentId": "[variables('analyticRuleObject14').analyticRuleId14]",
                                "contentId": "[variables('analyticRuleObject14')._analyticRulecontentId14]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject14').analyticRuleVersion14]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SAP",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('analyticRuleObject14')._analyticRulecontentId14]",
                "contentKind": "AnalyticsRule",
                "displayName": "SAP - (Preview) Trusted RFC connection created or modified in SAP NetWeaver [CVE-2023-0014] ",
                "contentProductId": "[variables('analyticRuleObject14')._analyticRulecontentProductId14]",
                "id": "[variables('analyticRuleObject14')._analyticRulecontentProductId14]",
                "version": "[variables('analyticRuleObject14').analyticRuleVersion14]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('analyticRuleObject15').analyticRuleTemplateSpecName15]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP - Activation or Deactivation of ICF Service_AnalyticalRules Analytics Rule with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('analyticRuleObject15').analyticRuleVersion15]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                            "name": "[variables('analyticRuleObject15')._analyticRulecontentId15]",
                            "apiVersion": "2022-04-01-preview",
                            "kind": "Scheduled",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "description": "Identifies activation or deactivation of ICF Services.\nSource Action: Activate or deactivate a service using SICF.\n*Data Sources: SAPcon - Table Data Log*",
                                "displayName": "SAP - Activation or Deactivation of ICF Service",
                                "enabled": false,
                                "query": "// Activation or Deactivation of ICF Service\n// Materialize the data for self join to be esier\nlet TimeAgo= 2h;\nlet ICFDataChanges = materialize(SAPTableDataLog\n| where TimeGenerated > TimeAgo\n| where TableName == \"ICFSERVLOC\"\n| where NewValue == \"X\" or NewValue ==\"\" or isempty( NewValue)// X - Status is activated, \"\" Not activated now\n| where TableField == \"ICF_NAME\" or TableField == \"ICFACTIVE\"// Service name// Active status\n| project OldValue, NewValue, LogKey, DBLogID, SystemID, TimeGenerated, UserName, Host, Instance);\nlet ActDeactICF =\nICFDataChanges\n| where OldValue == NewValue and OldValue != \"\"\n| lookup ICFDataChanges on\nLogKey, DBLogID // Lookup for combining the data\n| extend ICFServiceStatus = iff(NewValue1 == \"X\", \"Activated\", iff(NewValue1 == \"\" or isempty( NewValue1) and OldValue1 == \"X\" ,\"Deactivated\",\"No Activity\"))\n| extend Service = split(LogKey,\" \")[0];\nActDeactICF\n| lookup SAPUsersHeader() on SystemID, $left.UserName== $right.User\n| extend AlertText= strcat(\"Service \", Service, \" \", ICFServiceStatus, \" by User \", UserName, \" in System \", SystemID)//{{Service}} {{ICFServiceStatus}} by User {{User}} in System {{SystemID}}\n| project TimeGenerated, Service, PrimaryIP, PrimaryEmail, KnownIPs, KnownEmails, LastKnownIP, User= UserName, Host, SystemID, Client, Instance, ICFServiceStatus, AlertText\n| extend Dummy = ''\n| extend AlertRuleUniqueName = 'activationordeactivationoficfservice'\n",
                                "queryFrequency": "PT2H",
                                "queryPeriod": "P2D",
                                "severity": "High",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                    {
                                        "connectorId": "SAP",
                                        "dataTypes": [
                                            "SAPTableDataLog",
                                            "SAPUsersHeader"
                                        ]
                                    }
                                ],
                                "tactics": [
                                    "CommandAndControl",
                                    "LateralMovement",
                                    "Persistence"
                                ],
                                "entityMappings": [
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "PrimaryEmail"
                                            }
                                        ],
                                        "entityType": "Account"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Name",
                                                "columnName": "SystemID"
                                            },
                                            {
                                                "identifier": "AppId",
                                                "columnName": "Client"
                                            },
                                            {
                                                "identifier": "InstanceName",
                                                "columnName": "Instance"
                                            }
                                        ],
                                        "entityType": "CloudApplication"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Address",
                                                "columnName": "LastKnownIP"
                                            }
                                        ],
                                        "entityType": "IP"
                                    }
                                ],
                                "eventGroupingSettings": {
                                    "aggregationKind": "SingleAlert"
                                },
                                "customDetails": {
                                    "AlertRuleUniqueName": "AlertRuleUniqueName",
                                    "SAP_User": "User"
                                },
                                "alertDetailsOverride": {
                                    "alertDescriptionFormat": "Identifies activation or deactivation of ICF Services.\nSource Action: Activate or deactivate a service using SICF.\n*Data Sources: SAPcon - Table Data Log*\n",
                                    "alertTacticsColumnName": "Dummy",
                                    "alertDisplayNameFormat": "SAP - High - {{AlertText}}",
                                    "alertSeverityColumnName": "Dummy"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject15').analyticRuleId15,'/'))))]",
                            "properties": {
                                "description": "SAP Analytics Rule 15",
                                "parentId": "[variables('analyticRuleObject15').analyticRuleId15]",
                                "contentId": "[variables('analyticRuleObject15')._analyticRulecontentId15]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject15').analyticRuleVersion15]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SAP",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('analyticRuleObject15')._analyticRulecontentId15]",
                "contentKind": "AnalyticsRule",
                "displayName": "SAP - Activation or Deactivation of ICF Service",
                "contentProductId": "[variables('analyticRuleObject15')._analyticRulecontentProductId15]",
                "id": "[variables('analyticRuleObject15')._analyticRulecontentProductId15]",
                "version": "[variables('analyticRuleObject15').analyticRuleVersion15]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('analyticRuleObject16').analyticRuleTemplateSpecName16]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP - Assignment of a sensitive profile_AnalyticalRules Analytics Rule with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('analyticRuleObject16').analyticRuleVersion16]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                            "name": "[variables('analyticRuleObject16')._analyticRulecontentId16]",
                            "apiVersion": "2022-04-01-preview",
                            "kind": "Scheduled",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "description": "Identifies new assignments of a sensitive profile to a user.\n\nSource Action: Assign a profile to a User using SU01.\n\nSensitive profiles can be maintained using the \"SAP - Sensitive Profiles\" watchlist\n\n*Data Sources: SAPcon -  Change Documents Log*",
                                "displayName": "SAP - Assignment of a sensitive profile",
                                "enabled": false,
                                "query": "// Define Variables\n// Audit Log Classes - Authorizations for user changed\n// the actual lookback period is 1h. The alert looks back further to allow for user master data to be built slowly\nlet TimeAgo= 12h;\nlet Identity = 'IDENTITY';\nlet ProfileChangeDoc = 'SUSR_UST04';\nlet Insert = \"I\";\nlet logsThreshold = 3600; // 3600 seconds\nlet AuditClasses = dynamic(['AUB']); // Authorizations for user &A changed.\n// Maintain these if WatchList is not available\nlet SensitiveProfiles =  _GetWatchlist('SAP - Sensitive Profiles');\nlet fixedProfile = datatable(Profile:string)['SAP_ALL','SAP_NEW'];// Maintain these if System doesn't have CR's\n// here you can exclude system users which are OK to assign a Sensitive profile\n// by adding those users in the SAP_User_Config watchlist with a tag of 'AssignSensitiveProfileOK'\n// can also specify SAP Roles or Profiles to exclude\nlet excludeUsersTags= dynamic(['AssignSensitiveProfileOK']);\nlet excludedUsers= SAPUsersGetVIP(SearchForTags= excludeUsersTags)| summarize by User2Exclude=SAPUser;\nlet fixedChangeDocs = datatable(User : string, ObjectClass : string, TableName : string, TypeofChange_Item : string , ChangedTableKey : string, ObjectID : string, TimeGenerated : datetime, ValueNew : string, SystemID : string, Instance: string, ClientID: string, UpdatedOn_t: datetime)[];\nlet ChangeDocs =\n(union isfuzzy=true table(\"SAPChangeDocsLog\"), fixedChangeDocs)\n| where ingestion_time() > ago(TimeAgo)\n| project-rename ChangedOn= UpdatedOn_t;\nlet IdentityChangeDocuments =\n// Identity Change documents which represents profiles assignment\n    ChangeDocs\n    | where ObjectClass == Identity // Identity\n    and TableName == ProfileChangeDoc // Profile Change Doc\n    and TypeofChange_Item == Insert // Insert\n    | extend Profile = ChangedTableKey\n    | extend UserAssigned = ObjectID;\nlet UnitedProfiles =\ntoscalar(union fixedProfile, SensitiveProfiles\n| summarize Profiles = make_list(Profile));\n// Query logic\nSAPAuditLog\n| where ingestion_time() > ago(TimeAgo)\n| where MessageID in (AuditClasses)\n| project-rename AuditedOn= UpdatedOn_t\n| summarize by AuditedOn, TerminalIPv6, User, Host, Email\n| join kind=leftantisemi excludedUsers on $left.User == $right.User2Exclude\n| lookup kind = leftouter (IdentityChangeDocuments) on User\n| where Profile in (UnitedProfiles)\n| where abs(datetime_diff('second',ChangedOn,AuditedOn)) <= logsThreshold\nor isnull(AuditedOn)\n| project\n// Details\nChangedOn, Instance , SystemID, ClientID, Profile, User,  UserAssigned,\nEmail, TerminalIPv6, Host, AuditedOn\n| extend Dummy= '',  PackedDetails= pack_all()\n| extend AlertRuleUniqueName = 'assignmentofasensitiveprofile'\n",
                                "queryFrequency": "PT12H",
                                "queryPeriod": "P7D",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                    {
                                        "connectorId": "SAP",
                                        "dataTypes": [
                                            "SAPAuditLog",
                                            "SAPChangeDocsLog",
                                            "SAPUsersGetVIP"
                                        ]
                                    }
                                ],
                                "tactics": [
                                    "PrivilegeEscalation"
                                ],
                                "entityMappings": [
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Email"
                                            }
                                        ],
                                        "entityType": "Account"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Address",
                                                "columnName": "TerminalIPv6"
                                            }
                                        ],
                                        "entityType": "IP"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Host"
                                            }
                                        ],
                                        "entityType": "Host"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Name",
                                                "columnName": "SystemID"
                                            },
                                            {
                                                "identifier": "AppId",
                                                "columnName": "ClientID"
                                            },
                                            {
                                                "identifier": "InstanceName",
                                                "columnName": "Instance"
                                            }
                                        ],
                                        "entityType": "CloudApplication"
                                    }
                                ],
                                "eventGroupingSettings": {
                                    "aggregationKind": "AlertPerResult"
                                },
                                "customDetails": {
                                    "SAP_Profile": "Profile",
                                    "UserAssigned": "UserAssigned",
                                    "PackedDetails": "PackedDetails",
                                    "SAP_User": "User",
                                    "AlertRuleUniqueName": "AlertRuleUniqueName"
                                },
                                "alertDetailsOverride": {
                                    "alertDescriptionFormat": "Sensitive profiles are maintained in watchlist 'SAP - Sensitive Profiles' in System {{SystemID}}.\n{PackedDetails}\nIdentifies new assignments of a sensitive profile to a user.\n\nSource Action: Assign a profile to a User using SU01.\n\nSensitive profiles can be maintained using the \"SAP - Sensitive Profiles\" watchlist\n\n\n",
                                    "alertTacticsColumnName": "Dummy",
                                    "alertDisplayNameFormat": "SAP - Sensitive profile {{Profile}} has been assigned by user {{User}} to user {{UserAssigned}}",
                                    "alertSeverityColumnName": "Dummy"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject16').analyticRuleId16,'/'))))]",
                            "properties": {
                                "description": "SAP Analytics Rule 16",
                                "parentId": "[variables('analyticRuleObject16').analyticRuleId16]",
                                "contentId": "[variables('analyticRuleObject16')._analyticRulecontentId16]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject16').analyticRuleVersion16]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SAP",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('analyticRuleObject16')._analyticRulecontentId16]",
                "contentKind": "AnalyticsRule",
                "displayName": "SAP - Assignment of a sensitive profile",
                "contentProductId": "[variables('analyticRuleObject16')._analyticRulecontentProductId16]",
                "id": "[variables('analyticRuleObject16')._analyticRulecontentProductId16]",
                "version": "[variables('analyticRuleObject16').analyticRuleVersion16]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('analyticRuleObject17').analyticRuleTemplateSpecName17]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP - Assignment of a sensitive role_AnalyticalRules Analytics Rule with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('analyticRuleObject17').analyticRuleVersion17]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                            "name": "[variables('analyticRuleObject17')._analyticRulecontentId17]",
                            "apiVersion": "2022-04-01-preview",
                            "kind": "Scheduled",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "description": "Identifies new assignments of a sensitive role to a user, and can also be used to detect any assignment to any role. Allows to exclude users by tag, role and profile, to support a central user administration scenario. By default, this alert rule will trigger on production and UAT environments.\nSource Action: Assign a role to a User using SU01 / PFCG.\n\nSensitive roles should be maintained in watchlist \"SAP -  Sensitive Roles\"\n*Data Sources: SAPcon -  Change Documents Log, Audit Log*",
                                "displayName": "SAP - Assignment of a sensitive role",
                                "enabled": false,
                                "query": " // Assignment of a sensitive role\n // !!!IMPORTANT!!!\n// please make sure \"Lookup data from the last\" parameter is greater than a full user master data update cycle\n// please keep \"Lookup data from the last\" to be 7 days to allow coverage of user master data required\n// actual lookback is set by setting TimeAgo\nlet TimeAgo= 2h;\n// CONFIGURATION OPTION- determine which system roles are relevant for this alert\nlet SelectedSystemRoles =  dynamic([\"Production\", \"UAT\"]); //can also do// let SelectedSystemRoles =  dynamic([\"All System Roles\"];\nlet SelectedSystems = SAPSystems(SelectedSystemRoles= SelectedSystemRoles)\n    | project SystemID= SearchKey, SystemRole, SystemUsage;\nlet Roles = 'PFCG';\nlet UsersRoles = 'AGR_USERS';\nlet Insert = \"I\";\nlet logsThreshold = 180; // max time in seconds between audit record and change record\n// Audit Log Classes - Authorizations for user changed\nlet AuditClasses = dynamic(['AUB', 'AUD']); // Authorizations for user &A changed.\n// Maintain these if WatchList is not available\nlet SensitiveRoles =  _GetWatchlist('SAP - Sensitive Roles');\nlet fixedRoles = datatable(Role: string)['SAP_BC_BASIS_ADMIN', 'SAP_BC_AUTH_PROFILE_ADMIN'];\n// here you can exclude system users which are OK to assign sensitive roles\n// by adding those users in the SAP_User_Config watchlist with a tag of 'SensitiveRoleOK'\nlet excludeUsersTags= dynamic(['SensitiveRoleOK']);\nlet excludedUsers= _GetWatchlist('SAP_User_Config')| where Tags has_any (excludeUsersTags)| summarize by User2Exclude=SAPUser;\nlet UnitedRoles = toscalar(union fixedRoles, SensitiveRoles\n| summarize Roles = make_list(Role));\n// get the assignments made\nlet ChangeCheck =SAPChangeDocsLog\n| where TimeGenerated > ago(TimeAgo+ 1h)\n| where UpdatedOn_t > ago(TimeAgo)\n| join kind=inner SelectedSystems on SystemID\n| where ObjectClass == Roles // Roles\n    and TableName == UsersRoles // Users Roles\n    and TypeofChange_Item == Insert // Insert\n| extend IsSensitive= ObjectID in (UnitedRoles)\n| join kind=leftantisemi excludedUsers on $left.User == $right.User2Exclude\n| extend UserAssigned = trim_end(@\"[^\\w]+\" ,extract(@\"^.{1,33}\\s*?(.{1,12})\\s*?\\d{16}\", 1, ChangedTableKey))\n| project-rename Role=ObjectID, ChangedOn= UpdatedOn_t;\n// enrich with the host and IP address from the audit log\nSAPAuditLog\n| where TimeGenerated > ago(TimeAgo+ 1h)\n| where UpdatedOn_t > ago(TimeAgo)\n| join kind=inner SelectedSystems on SystemID\n| where MessageID in (AuditClasses)\n| summarize by UpdatedOn_t, TerminalIPv6, User, Host, Email, ClientID, SystemID\n| extend User= trim_end(@\"[^\\w]+\" , User)\n| join kind=leftantisemi excludedUsers on $left.User == $right.User2Exclude\n| lookup kind = inner ChangeCheck on User, ClientID, SystemID\n| extend TimeDiff= abs(datetime_diff('second', ChangedOn, UpdatedOn_t))\n| where TimeDiff <= logsThreshold\n// determine severity- self assignment is high, sensitive role is medium, not sensitive is low\n| extend Severity= case(User == UserAssigned, \"High\", IsSensitive, \"Medium\",\"Low\")\n// remove this filter if you need to be informed on non-sensitive role assignment as well:\n| where Severity != \"Low\"\n| order by ChangeNumber, SystemID, ClientID, TimeDiff asc\n| extend RowRank= row_number(0, prev(ChangeNumber) != ChangeNumber)\n| where RowRank == 0 // only the closest audit record\n| project ChangedOn, UpdatedOn_t, Instance , SystemID, ClientID, Role, User, UserAssigned, Email, TerminalIPv6, Host, Severity, IsSensitive, SystemRole\n| extend PackedDetails= pack_all(), Dummy=' '\n| extend AlertDescription= iff(User == UserAssigned,strcat('User ', User, ' has self-assigned a ', iff(IsSensitive,'sensitive',''),' role '),strcat('User ', User, ' has Assigned a ',  iff(IsSensitive,'sensitive',''),' role to User ', UserAssigned))\n| extend AlertDescription= strcat(AlertDescription, \" in a \", tolower(SystemRole), \" system\")\n| lookup (SAPUsersEmail | project SystemID, ClientID, UserAssigned= User, UserAssignedEmail= Email) on UserAssigned, SystemID, ClientID\n| extend Tactics= \"Privilege Escalation\"\n",
                                "queryFrequency": "PT2H",
                                "queryPeriod": "P7D",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                    {
                                        "connectorId": "SAP",
                                        "dataTypes": [
                                            "SAPAuditLog",
                                            "SAPChangeDocsLog",
                                            "SAPSystems",
                                            "SAPUsersEmail"
                                        ]
                                    }
                                ],
                                "tactics": [
                                    "PrivilegeEscalation"
                                ],
                                "entityMappings": [
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Email"
                                            }
                                        ],
                                        "entityType": "Account"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Address",
                                                "columnName": "TerminalIPv6"
                                            }
                                        ],
                                        "entityType": "IP"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "HostName",
                                                "columnName": "Host"
                                            }
                                        ],
                                        "entityType": "Host"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Name",
                                                "columnName": "SystemID"
                                            },
                                            {
                                                "identifier": "AppId",
                                                "columnName": "ClientID"
                                            },
                                            {
                                                "identifier": "InstanceName",
                                                "columnName": "Instance"
                                            }
                                        ],
                                        "entityType": "CloudApplication"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "UserAssignedEmail"
                                            }
                                        ],
                                        "entityType": "Account"
                                    }
                                ],
                                "eventGroupingSettings": {
                                    "aggregationKind": "AlertPerResult"
                                },
                                "customDetails": {
                                    "UserAssigned": "UserAssigned",
                                    "SAP_User": "User",
                                    "Role": "Role"
                                },
                                "alertDetailsOverride": {
                                    "alertDescriptionFormat": "Identifies new assignments for a sensitive role to a user.\n\nSource Action: Assign a role to a User using SU01 / PFCG.\n\nSensitive roles should be maintained in watchlist \"SAP -  Sensitive Roles\"\n\n*Data Sources: SAPcon -  Change Documents Log, Audit Log*\n{{PackedDetails}}\n",
                                    "alertTacticsColumnName": "Tactics",
                                    "alertDisplayNameFormat": "{{AlertDescription}}",
                                    "alertSeverityColumnName": "Severity"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject17').analyticRuleId17,'/'))))]",
                            "properties": {
                                "description": "SAP Analytics Rule 17",
                                "parentId": "[variables('analyticRuleObject17').analyticRuleId17]",
                                "contentId": "[variables('analyticRuleObject17')._analyticRulecontentId17]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject17').analyticRuleVersion17]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SAP",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('analyticRuleObject17')._analyticRulecontentId17]",
                "contentKind": "AnalyticsRule",
                "displayName": "SAP - Assignment of a sensitive role",
                "contentProductId": "[variables('analyticRuleObject17')._analyticRulecontentProductId17]",
                "id": "[variables('analyticRuleObject17')._analyticRulecontentProductId17]",
                "version": "[variables('analyticRuleObject17').analyticRuleVersion17]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('analyticRuleObject18').analyticRuleTemplateSpecName18]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP - Brute Force (RFC)_AnalyticalRules Analytics Rule with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('analyticRuleObject18').analyticRuleVersion18]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                            "name": "[variables('analyticRuleObject18')._analyticRulecontentId18]",
                            "apiVersion": "2022-04-01-preview",
                            "kind": "Scheduled",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "description": "Identifies brute force attacks on the SAP system using RFC logons\nSource Action: Attempt to login from the same IP to several systems/clients within the scheduled time interval using RFC\n\n*Data Sources: SAPcon -  Audit Log*",
                                "displayName": "SAP - Brute Force (RFC)",
                                "enabled": false,
                                "query": "// SAP - Brute Force (RFC)\n// Define constants\nlet TimeAgo= 60m;//time to look for brute forcing\nlet LearningTime= 3d;// history to learn\nlet Threshold= 0.5; // 0.1 is sensitive, 2 is indifferent\nlet PerIPPerMinute = 60; // number of calls permitted per minute from a single source\n// determine which system roles are relevant for this alert\nlet SelectedSystemRoles =  dynamic([\"All System Roles\"]); //can also do// let SelectedSystemRoles =  dynamic([\"Production\", \"UAT\"]);\nlet SelectedSystems = SAPSystems(SelectedSystemRoles= SelectedSystemRoles)\n    | project SystemID= SearchKey, SystemRole, SystemUsage\n    | extend SystemRole= replace_string(SystemRole, 'Unknown (Production)', 'Unknown');\n// here you can exclude system users which are OK to use RFC heavily\n// by adding those users in the SAP_User_Config watchlist with a tag of 'MultipleRFCOK'\n// can also specify SAP Roles or Profiles to exclude\nlet excludeUsersTags= dynamic(['MultipleRFCOK', 'SAP_ROLE', 'SAPPROFILE']);\nlet excludedUsers= SAPUsersGetVIP(SearchForTags= excludeUsersTags)\n    | summarize by User2Exclude=SAPUser;\n// COCan also exclude users by user classes\nlet UserClassesToExclude= dynamic([\"Class2Exclude\"]);\nlet UsersByClass= (SAP_USR02\n| where CLASS in (UserClassesToExclude)\n| summarize arg_max(TimeGenerated, *) by GLTGB, SystemID, User=BNAME, ClientID= MANDT\n| summarize arg_max(GLTGB, CLASS) by SystemID, User, ClientID);\n// Query logic\nlet RFCLogons= SAPAuditLog\n| where MessageID == \"AU6\" // RFC Logon Failed\n| where SystemID in (SelectedSystems)\n| where TimeGenerated > ago (LearningTime)\n| extend IngestionTime= ingestion_time()\n| join kind= leftantisemi UsersByClass on User, SystemID, ClientID\n| join kind=leftantisemi excludedUsers on $left.User == $right.User2Exclude;\n// get current excessive callers\nlet PotentialExcessiveCallers= RFCLogons\n| where TimeGenerated > ago(TimeAgo + 1h)\n| where IngestionTime > ago(TimeAgo)\n| extend IP= coalesce(TerminalIPv6, Computer, TERM_IPV6)\n| summarize CallCount= count(), StartTime = min(UpdatedOn_t), EndTime = max(UpdatedOn_t) by IP\n| where CallCount > PerIPPerMinute* TimeAgo/ (1m);\n// build series of logons from these addresses\nlet RFCLogonHistory= RFCLogons\n| project TerminalIPv6, Computer, TERM_IPV6, UpdatedOn_t\n| extend IP= coalesce(TerminalIPv6, Computer, TERM_IPV6)\n| where IP in ((PotentialExcessiveCallers | summarize IPs= makeset(IP,1000)))\n| make-series CallCount = count() on UpdatedOn_t from ago(LearningTime) to now() step TimeAgo by IP;\n// learn the history and perform judgement\nlet ExcessiveCallers= RFCLogonHistory\n| extend (CallCountAnome, score, baseline) = series_decompose_anomalies(CallCount, Threshold= Threshold, Test_points= 1)\n// | where CallCountAnome[-1] > 0 // only excessive\n| summarize IPs= makeset(IP,1000);\n// get the actual call from these IPs\nRFCLogons\n| where TimeGenerated > ago(TimeAgo + 1h)\n| where IngestionTime > ago(TimeAgo)\n| where TerminalIPv6 in ((ExcessiveCallers)) or Computer in ((ExcessiveCallers)) or TERM_IPV6 in((ExcessiveCallers))\n| extend IP= coalesce(TerminalIPv6, Computer, TERM_IPV6)\n| lookup PotentialExcessiveCallers on IP\n| summarize LoginAttemptsMadebyIP= any(CallCount), CallCountPerUserSystem= count(), StartTime= any(StartTime), EndTime=any(EndTime) by IP, Email, User, SystemID, ClientID, Host\n| extend ActivityDetailed= bag_pack(\"Email\", Email, \"User\", User, \"SystemID\", SystemID, \"ClientID\", ClientID, \"Host\", Host, \"CallCountPerUserSystem\", CallCountPerUserSystem)\n| summarize LoginAttemptsMadebyIP= any(LoginAttemptsMadebyIP), Activities= make_set(ActivityDetailed, 30), StartTime =any(StartTime), EndTime = any(EndTime)\n, (CallCountPerUserSystem, User, Email, SystemID, ClientID, Host)= argmax(CallCountPerUserSystem, User, Email, SystemID, ClientID, Host) by IP\n| lookup SelectedSystems on SystemID\n| extend AlertName= strcat(\"SAP - Potential brute force attack (RFC) on a \", tolower(SystemRole), \" system, \", LoginAttemptsMadebyIP, \" calls within \", datetime_diff(\"minute\", EndTime, StartTime), \" minutes\")\n| extend AlertDescription= strcat(\"Source has produced \", LoginAttemptsMadebyIP, \" calls within \", datetime_diff(\"minute\", EndTime, StartTime),\" minutes, most of which were made to system \", SystemID, \". The permitted limit of calls per minute is \", PerIPPerMinute , \". \")\n| extend AlertRuleUniqueName = 'bruteforce(rfc)'\n",
                                "queryFrequency": "PT1H",
                                "queryPeriod": "P3D",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                    {
                                        "connectorId": "SAP",
                                        "dataTypes": [
                                            "SAP_USR02",
                                            "SAPAuditLog",
                                            "SAPSystems",
                                            "SAPUsersGetVIP"
                                        ]
                                    }
                                ],
                                "tactics": [
                                    "CredentialAccess"
                                ],
                                "entityMappings": [
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Email"
                                            }
                                        ],
                                        "entityType": "Account"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Address",
                                                "columnName": "IP"
                                            }
                                        ],
                                        "entityType": "IP"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Name",
                                                "columnName": "SystemID"
                                            },
                                            {
                                                "identifier": "AppId",
                                                "columnName": "ClientID"
                                            }
                                        ],
                                        "entityType": "CloudApplication"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "HostName",
                                                "columnName": "Host"
                                            }
                                        ],
                                        "entityType": "Host"
                                    }
                                ],
                                "eventGroupingSettings": {
                                    "aggregationKind": "AlertPerResult"
                                },
                                "customDetails": {
                                    "AlertRuleUniqueName": "AlertRuleUniqueName",
                                    "SAP_User": "User"
                                },
                                "alertDetailsOverride": {
                                    "alertDescriptionFormat": "{{AlertDescription}}",
                                    "alertTacticsColumnName": "IP",
                                    "alertDisplayNameFormat": "{{AlertName}}",
                                    "alertSeverityColumnName": "IP"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject18').analyticRuleId18,'/'))))]",
                            "properties": {
                                "description": "SAP Analytics Rule 18",
                                "parentId": "[variables('analyticRuleObject18').analyticRuleId18]",
                                "contentId": "[variables('analyticRuleObject18')._analyticRulecontentId18]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject18').analyticRuleVersion18]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SAP",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('analyticRuleObject18')._analyticRulecontentId18]",
                "contentKind": "AnalyticsRule",
                "displayName": "SAP - Brute Force (RFC)",
                "contentProductId": "[variables('analyticRuleObject18')._analyticRulecontentProductId18]",
                "id": "[variables('analyticRuleObject18')._analyticRulecontentProductId18]",
                "version": "[variables('analyticRuleObject18').analyticRuleVersion18]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('analyticRuleObject19').analyticRuleTemplateSpecName19]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP - Change in a Sensitive Privileged User_AnalyticalRules Analytics Rule with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('analyticRuleObject19').analyticRuleVersion19]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                            "name": "[variables('analyticRuleObject19')._analyticRulecontentId19]",
                            "apiVersion": "2022-04-01-preview",
                            "kind": "Scheduled",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "description": "Identifies changes of sensitive privileged users.\nSource Action: Change user details / authorizations using SU01.\n<p>Users are considered as Privileged when one of these conditions apply: </p>\n<li>If they are named in the SAP - Privileged Users Watchlist\n<li>If they have a profile which is included in the SAP - Sensitive Profiles watchlist\n<li>If they have a role which is included in the SAP - Sensitive Roles watchlist\nThis Rule requires a fresh full reload of SAP user master data to be performed daily.\n*Data Sources: SAPcon -  Audit Log*\n*Data Sources: SAPcon -  User MD*",
                                "displayName": "SAP - Change in a Sensitive Privileged User",
                                "enabled": false,
                                "query": "// Change in a Sensitive Privileged User\n// time span for audit events\nlet AuditTimeAgo= 75m;\n// Audit Log Classes - User Master Changes\nlet AuditClasses = dynamic(['AU7', 'AU8', 'AU9', 'AUA', 'AUB', 'AUD', 'BU2']);\n// here you can exclude system users which are OK to modify other users' master data\n// by adding those users in the SAP_User_Config watchlist with a tag of 'ChangeUserMasterDataOK'\nlet excludeUsersTags= dynamic(['ChangeUserMasterDataOK']);\nlet excludedUsers= _GetWatchlist('SAP_User_Config')| where Tags has_any (excludeUsersTags)| summarize by User2Exclude=SAPUser;\nlet UsersEmails = SAPUsersHeader()\n| project-keep User, SystemID, Client, Email\n| project-rename ClientID= Client, ChangedEmail=Email, ChangedUser=User;\nSAPAuditLog\n| where TimeGenerated > ago(AuditTimeAgo)\n| where MessageID in (AuditClasses)\n| join kind=leftantisemi excludedUsers on $left.User == $right.User2Exclude\n// The user that we are making change in is a sensitive privileged user\n| extend ChangedUser = Variable1\n| join kind= inner (SAPUsersGetPrivileged())\non $left.ClientID == $right.Client\n, $left.SystemID == $right.SystemID\n, $left.ChangedUser == $right.User\n| extend MessageText = iff(MessageText endswith_cs \".\", substring(MessageText, 0, strlen(MessageText)-1), MessageText)\n| extend MessageTextDyna = replace_string(MessageText, \"User\", \"Privileged User\")\n| extend MessageTextDyna = replace_string(MessageTextDyna, \"user\", \"Privileged User\")\n| lookup UsersEmails\non SystemID, ClientID, ChangedUser\n| project-keep TimeGenerated, Instance,  SystemID, ClientID, User, MessageText, MessageID, Email,  TerminalIPv6, Host, ChangedUser, ChangedEmail, MessageTextDyna\n| extend Email= iff(isempty(Email),User, Email), Host= iff(isempty(Host), TerminalIPv6, Host), Dummy= ''\n| extend ChangedEmail= iff(isempty(ChangedEmail),ChangedUser, ChangedEmail)\n| extend PackedDetails= pack_all()\n| extend AlertRuleUniqueName = 'changeinasensitiveprivilegeduser'\n",
                                "queryFrequency": "PT1H",
                                "queryPeriod": "P2D",
                                "severity": "High",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                    {
                                        "connectorId": "SAP",
                                        "dataTypes": [
                                            "SAPAuditLog",
                                            "SAPUsersGetPrivileged",
                                            "SAPUsersHeader"
                                        ]
                                    }
                                ],
                                "tactics": [
                                    "PrivilegeEscalation",
                                    "CredentialAccess"
                                ],
                                "entityMappings": [
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Email"
                                            }
                                        ],
                                        "entityType": "Account"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Host"
                                            }
                                        ],
                                        "entityType": "Host"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Address",
                                                "columnName": "TerminalIPv6"
                                            }
                                        ],
                                        "entityType": "IP"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Name",
                                                "columnName": "SystemID"
                                            },
                                            {
                                                "identifier": "AppId",
                                                "columnName": "ClientID"
                                            },
                                            {
                                                "identifier": "InstanceName",
                                                "columnName": "Instance"
                                            }
                                        ],
                                        "entityType": "CloudApplication"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "ChangedEmail"
                                            }
                                        ],
                                        "entityType": "Account"
                                    }
                                ],
                                "eventGroupingSettings": {
                                    "aggregationKind": "AlertPerResult"
                                },
                                "customDetails": {
                                    "SAPChangedUser": "ChangedUser",
                                    "SAP_User": "User",
                                    "AlertRuleUniqueName": "AlertRuleUniqueName"
                                },
                                "alertDetailsOverride": {
                                    "alertDescriptionFormat": "Identifies changes of sensitive privileged users.\nSource Action: Change user details / authorizations using SU01.\n<p>Users are considered as Privileged when one of these conditions apply: </p>\n<li>If they are named in the SAP - Privileged Users Watchlist\n<li>If they have a profile which is included in the SAP - Sensitive Profiles watchlist\n<li>If they have a role which is included in the SAP - Sensitive Roles watchlist\nPacked Details - {{PackedDetails}}\n*Data Sources: SAPcon -  User MD*\n",
                                    "alertTacticsColumnName": "Dummy",
                                    "alertDisplayNameFormat": "SAP - High -{{MessageTextDyna}} in system {{SystemID}}",
                                    "alertSeverityColumnName": "Dummy"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject19').analyticRuleId19,'/'))))]",
                            "properties": {
                                "description": "SAP Analytics Rule 19",
                                "parentId": "[variables('analyticRuleObject19').analyticRuleId19]",
                                "contentId": "[variables('analyticRuleObject19')._analyticRulecontentId19]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject19').analyticRuleVersion19]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SAP",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('analyticRuleObject19')._analyticRulecontentId19]",
                "contentKind": "AnalyticsRule",
                "displayName": "SAP - Change in a Sensitive Privileged User",
                "contentProductId": "[variables('analyticRuleObject19')._analyticRulecontentProductId19]",
                "id": "[variables('analyticRuleObject19')._analyticRulecontentProductId19]",
                "version": "[variables('analyticRuleObject19').analyticRuleVersion19]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('analyticRuleObject20').analyticRuleTemplateSpecName20]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP - Client Configuration Change_AnalyticalRules Analytics Rule with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('analyticRuleObject20').analyticRuleVersion20]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                            "name": "[variables('analyticRuleObject20')._analyticRulecontentId20]",
                            "apiVersion": "2022-04-01-preview",
                            "kind": "Scheduled",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "description": "Identifies changes for client configuration such as: Client role, Changes recording mode.\n\nSource Action:  Perofrm client configurations changes using SCC4 transaction code.\n\n*Data Sources: SAPcon -  Audit Log*",
                                "displayName": "SAP - Client Configuration Change",
                                "enabled": false,
                                "query": "// Audit Log Classes - Client Change Configuration\nlet AuditClasses = dynamic(['EU2']); // Relevent message\nlet SelectedSystemRoles=dynamic([\"Production\", \"UAT\"]);\nlet SelectedSystems= SAPSystems(SelectedSystemRoles=SelectedSystemRoles) | summarize by SystemRole, SystemID= SearchKey;\nSAPAuditLog\n| where MessageID in (AuditClasses)\n| join kind=inner SelectedSystems on SystemID\n| project-rename ClientIDTemp = ClientID\n| project-rename ClientID= Variable1\n| parse Variable2 with Currency \"|\" ClientRole \"|\" RecordingChanges \"|\" CrossClientObjectChanges \"|\" ClientCopyProtectionLevel \"|\" ProtectionSAPUpgrade \"|\" CATTeCATT \"|\"  LockedforCopy // Parse every object before the | char\n| project TimeGenerated, Instance, SystemID, SystemRole, User, ClientID,\nCurrency,ClientRole,RecordingChanges,CrossClientObjectChanges,ClientCopyProtectionLevel,CATTeCATT,LockedforCopy,ProtectionSAPUpgrade,\nMessageText, Email, TerminalIPv6, Host\n| extend Severity= iff(SystemRole==\"Production\",\"High\",\"Medium\"), Dummy= \"\"\n| extend AlertRuleUniqueName = 'clientconfigurationchange'\n",
                                "queryFrequency": "PT15M",
                                "queryPeriod": "PT25M",
                                "severity": "High",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                    {
                                        "connectorId": "SAP",
                                        "dataTypes": [
                                            "SAPAuditLog",
                                            "SAPSystems"
                                        ]
                                    }
                                ],
                                "tactics": [
                                    "DefenseEvasion",
                                    "Exfiltration",
                                    "Persistence"
                                ],
                                "entityMappings": [
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Email"
                                            }
                                        ],
                                        "entityType": "Account"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Address",
                                                "columnName": "TerminalIPv6"
                                            }
                                        ],
                                        "entityType": "IP"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Host"
                                            }
                                        ],
                                        "entityType": "Host"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Name",
                                                "columnName": "SystemID"
                                            },
                                            {
                                                "identifier": "AppId",
                                                "columnName": "ClientID"
                                            },
                                            {
                                                "identifier": "InstanceName",
                                                "columnName": "Instance"
                                            }
                                        ],
                                        "entityType": "CloudApplication"
                                    }
                                ],
                                "eventGroupingSettings": {
                                    "aggregationKind": "AlertPerResult"
                                },
                                "customDetails": {
                                    "SystemRole": "SystemRole",
                                    "SAP_User": "User",
                                    "AlertRuleUniqueName": "AlertRuleUniqueName"
                                },
                                "alertDetailsOverride": {
                                    "alertDescriptionFormat": "System {SystemID} configuration has changed by user {{User}}",
                                    "alertTacticsColumnName": "Dummy",
                                    "alertDisplayNameFormat": "SAP - Client Configuration Change for a {{SystemRole}} System",
                                    "alertSeverityColumnName": "Severity"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject20').analyticRuleId20,'/'))))]",
                            "properties": {
                                "description": "SAP Analytics Rule 20",
                                "parentId": "[variables('analyticRuleObject20').analyticRuleId20]",
                                "contentId": "[variables('analyticRuleObject20')._analyticRulecontentId20]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject20').analyticRuleVersion20]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SAP",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('analyticRuleObject20')._analyticRulecontentId20]",
                "contentKind": "AnalyticsRule",
                "displayName": "SAP - Client Configuration Change",
                "contentProductId": "[variables('analyticRuleObject20')._analyticRulecontentProductId20]",
                "id": "[variables('analyticRuleObject20')._analyticRulecontentProductId20]",
                "version": "[variables('analyticRuleObject20').analyticRuleVersion20]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('analyticRuleObject21').analyticRuleTemplateSpecName21]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP - Critical authorizations assignment - New User Assignment_AnalyticalRules Analytics Rule with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('analyticRuleObject21').analyticRuleVersion21]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                            "name": "[variables('analyticRuleObject21')._analyticRulecontentId21]",
                            "apiVersion": "2022-04-01-preview",
                            "kind": "Scheduled",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "description": "Identifies assignment of a critical authorization object value to a new user.\n\nSource Action: Assign a new user to a role which holds critical authorization values using SU01/PFCG.\n\nCritical authorization objects should be maintained in watchlist \"\"SAP - Critical Authorization Objects\"\"\n\n*Data Sources: SAPcon -  Change Documents Log*",
                                "displayName": "SAP - Critical authorizations assignment - New User Assignment",
                                "enabled": false,
                                "query": "// New Assigned Users\nlet ObjectClassRoles = 'PFCG';\nlet TableName = 'CD1251';\nlet UsersRoles = 'AGR_USERS';\nlet Insert = \"I\";\nlet NotInUse = 'NOT_IN_USE';\nlet logsThreshold = 3600; // 3600 seconds\n// Audit Log Classes - Authorizations for user changed\nlet AuditClasses = dynamic(['AUB','AUD']); // Authorizations for user &A changed. User Master Record Changed\n// Roles Change Documents - Extract Auth Object and Obj Field\nlet allHistory = ago(0d);\nlet alertSched = ago(6h); // Please maintain according to schedule\n// Maintain these if System doesn't have CR's\nlet fixedChangeDocs = datatable(User : string, ObjectClass : string, TableName : string, TypeofChange_Item : string , ChangedTableKey : string, ObjectID : string, TimeGenerated : datetime, ValueNew : string, SystemID : string)[];\nlet ChangeDocs =\nunion isfuzzy=true table(\"SAPChangeDocsLog\"), fixedChangeDocs;\nlet RolesAuthObject = ChangeDocs\n    | where TimeGenerated <= allHistory\n    | where ObjectClass == ObjectClassRoles and TableName == TableName // Role-Obj-Profile-ObjField\n    | where TypeofChange_Item in ('J', 'I', 'U') //  Insert\n    | extend RoleObjProfileObjFieldVer = ChangedTableKey, Role = ObjectID\n    | extend ObjFieldValue = ValueNew\n    | extend ObjField = trim(@\"\\s*?\", extract(@\"(^.{1,30})\\s*?(.{1,10})\\s*?(.{1,12})\\s*?(.{1,10})\\s*?\\d{6}\", 4, RoleObjProfileObjFieldVer, typeof(string)))\n    | extend AuthObject = trim(@\"\\s*?\", extract(@\"(^.{1,30})\\s*?(.{1,10})\\s*?(.{1,12})\\s*?(.{1,10})\\s*?\\d{6}\", 2, RoleObjProfileObjFieldVer, typeof(string)))\n    | summarize by SystemID, Role, AuthObject, ObjField, ObjFieldValue;\nlet ComplexAuth = _GetWatchlist('SAP - Critical Authorizations');\nlet SimpleAuth = _GetWatchlist('SAP - Critical Authorizations');\nlet fixedComplexAuth = datatable(AuthorizationObject: string, AuthorizationField: string, AuthorizationValue: string, ActivityField: string, Activity: string)\n    ['S_DEVELOP', 'OBJTYPE', 'DEBUG', 'ACTVT', '*',\n    'S_DEVELOP', 'OBJTYPE', 'DEBUG', 'ACTVT', '02']; // Maintain these if WatchList is not available\nlet fixedSimpleAuth = datatable(AuthorizationObject: string, AuthorizationField: string, AuthorizationValue: string, ActivityField: string, Activity: string)\n    ['S_TCODE', 'TCD', '*', 'NOT_IN_USE', '',\n    'S_TZONE', 'ACTVT', '*', 'NOT_IN_USE', '']; // Maintain these if WatchList is not available\nlet usersinRole =\n    ChangeDocs\n    | where TimeGenerated >= alertSched\n    | where ObjectClass == ObjectClassRoles // Roles\n        and TableName == UsersRoles // Users Roles\n        and TypeofChange_Item == Insert // Insert\n    | extend UserAssigned = extract(@\"^.{1,33}\\s*?(.{1,12})\\s*?\\d{16}\", 1, ChangedTableKey)\n    | extend Role = ObjectID\n    | extend TimeGenUserinRole = TimeGenerated;\n    //| summarize by TimeGenerated, SystemID, ClientID, Role, UserAssigned, User\nlet RolesAuthObjectCheck =\n        RolesAuthObject\n        | extend ObjFieldVal = ObjFieldValue\n        | lookup kind = leftouter\n            (RolesAuthObject\n            | extend ActivityVal = ObjFieldValue)\n            on Role, AuthObject;\nlet complexScenario =\n    union ComplexAuth, fixedComplexAuth\n    | where ActivityField != NotInUse\n    | summarize by AuthorizationObject, AuthorizationField, AuthorizationValue, ActivityField, Activity\n    | lookup kind = inner (RolesAuthObjectCheck)\n        on $left.AuthorizationObject == $right.AuthObject\n        and $left.AuthorizationField == $right.ObjField\n        and $left.AuthorizationValue == $right.ObjFieldValue\n        and $left.ActivityField == $right.ObjField1\n        and $left.Activity == $right.ActivityVal;\nlet simpleScenario =\n    union SimpleAuth, fixedSimpleAuth\n    | where ActivityField == NotInUse\n    | summarize by AuthorizationObject, AuthorizationField, AuthorizationValue, ActivityField, Activity\n    | lookup kind = inner (RolesAuthObject)\n        on $left.AuthorizationObject == $right.AuthObject\n        and $left.AuthorizationField == $right.ObjField\n        and $left.AuthorizationValue == $right.ObjFieldValue;\nlet GetEntites =\n    SAPAuditLog\n    | where TimeGenerated >= alertSched\n    | where MessageID in (AuditClasses)\n    | summarize by TimeGenerated, TerminalIPv6, ClientID, User, Host, Email\n    | extend TimeGenAudit = TimeGenerated;\nunion complexScenario, simpleScenario\n| lookup kind = inner (usersinRole) on SystemID, Role\n| lookup kind = leftouter (GetEntites) on User\n| where abs(datetime_diff('second', TimeGenUserinRole, TimeGenAudit)) <= logsThreshold or\nisnull(TimeGenAudit)\n| project\n    // Details\nTimeGenUserinRole , SystemID, ClientID, Role, User, UserAssigned, AuthorizationObject, AuthorizationField, AuthorizationValue, ActivityField, Activity, Email, TerminalIPv6, Host\n| extend AlertRuleUniqueName = 'criticalauthorizationsassignment-newuserassignment'\n",
                                "queryFrequency": "PT6H",
                                "queryPeriod": "PT6H",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                    {
                                        "connectorId": "SAP",
                                        "dataTypes": [
                                            "SAPAuditLog",
                                            "SAPChangeDocsLog"
                                        ]
                                    }
                                ],
                                "tactics": [
                                    "PrivilegeEscalation"
                                ],
                                "entityMappings": [
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Email"
                                            }
                                        ],
                                        "entityType": "Account"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Address",
                                                "columnName": "TerminalIPv6"
                                            }
                                        ],
                                        "entityType": "IP"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Host"
                                            }
                                        ],
                                        "entityType": "Host"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Name",
                                                "columnName": "SystemID"
                                            },
                                            {
                                                "identifier": "AppId",
                                                "columnName": "ClientID"
                                            }
                                        ],
                                        "entityType": "CloudApplication"
                                    }
                                ],
                                "eventGroupingSettings": {
                                    "aggregationKind": "SingleAlert"
                                },
                                "customDetails": {
                                    "AlertRuleUniqueName": "AlertRuleUniqueName",
                                    "SAP_User": "User"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject21').analyticRuleId21,'/'))))]",
                            "properties": {
                                "description": "SAP Analytics Rule 21",
                                "parentId": "[variables('analyticRuleObject21').analyticRuleId21]",
                                "contentId": "[variables('analyticRuleObject21')._analyticRulecontentId21]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject21').analyticRuleVersion21]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SAP",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('analyticRuleObject21')._analyticRulecontentId21]",
                "contentKind": "AnalyticsRule",
                "displayName": "SAP - Critical authorizations assignment - New User Assignment",
                "contentProductId": "[variables('analyticRuleObject21')._analyticRulecontentProductId21]",
                "id": "[variables('analyticRuleObject21')._analyticRulecontentProductId21]",
                "version": "[variables('analyticRuleObject21').analyticRuleVersion21]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('analyticRuleObject22').analyticRuleTemplateSpecName22]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP - Data collection health check_AnalyticalRules Analytics Rule with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('analyticRuleObject22').analyticRuleVersion22]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                            "name": "[variables('analyticRuleObject22')._analyticRulecontentId22]",
                            "apiVersion": "2022-04-01-preview",
                            "kind": "Scheduled",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "description": "Produces insights on potential SAP agent connectivity issues.",
                                "displayName": "SAP - Data collection health check",
                                "enabled": false,
                                "query": "// ***IMPORTANT***- Lookback period is maintained in the KQL\n// please keep the Query scheduling parameter of \"Lookup data from the last\" to be 14 days so\n// the algorithm can detect anomalies across history\nlet LogLookBack= 14d;\nlet StepSize= 1d;\n// handle the TimeGenerated -> ingestion gap\nlet Tolerance= 15m;\nlet SelectedSystemRoles =  dynamic([\"All System Roles\"]); //can also do// let SelectedSystemRoles =  dynamic([\"Production\", \"UAT\"]);\nlet SelectedSystems = SAPSystems(SelectedSystemRoles= SelectedSystemRoles)\n    | project SystemID= SearchKey, SystemRole, SystemUsage\n    | extend SystemRole= replace_string(SystemRole, 'Unknown (Production)', 'Unknown');\n// 0.1 is very sensitive and is required for low activity workspaces with under 1M events a day.\n// 0.5 can work better for high scale WSs (between 1M and 10M records a day). 1 can be used for WSs with over 10m records a day\nlet Threshold= 0.1;\nlet SystemLevelIssues= SAPConnectorHealth()\n    | summarize arg_max(LastSeen, *) by SystemID // last status per SystemID\n    | where SystemID !in (dynamic([\"N/A\", \"AGE\", \"Agent Version Check\"])) // agents checks are not interesting\n    | where MessageCode != \"OKOK\" // only show problems\n    | where Status == \"Yellow\" or Status == \"Red\"\n    | extend Severity= case(Status == \"Yellow\", \"Medium\", Status == \"Red\", \"High\", \"Unknown\")\n    | extend Log= 'Entire system'\n    | extend Details= replace_string(Details, \"System\", strcat(\"SAP System \", SystemID));\nlet LogContinuationTS=  SAPConnectorOverview()\n    | where TimeGenerated > ago(LogLookBack)\n    | project Type, TimeGenerated, SystemID= SystemID_s\n    | make-series RecordCount= count(), LastSeen= max(TimeGenerated) on TimeGenerated from ago(LogLookBack) to now() step StepSize by Log= Type, SystemID;\n// LogContinuationTS\nlet LogContinuationAnomal= LogContinuationTS\n    | extend (RecordCountAnomalies, score, baseline) = series_decompose_anomalies(RecordCount, Threshold= Threshold, Test_points= 1)\n    | where array_index_of(RecordCountAnomalies, -1, -1) > 0 // some log is missing in the last bucket\n    // to allow for some tolerance, check if last seen is in the previous bin\n    | extend LastSeen= (max_of(todatetime(LastSeen[-1]),todatetime(LastSeen[-2])))\n    | extend IsTolerable= now() < (LastSeen + Tolerance + 1d)\n    | extend Severity= iff(RecordCount[-1] == 0 and not(IsTolerable), \"Low\", \"Informational\") // determine severity according to certainty\n    | extend Details= strcat('SAP- Potential log loss for log ', Log, ' from System ', SystemID)\n    | extend ExtendedDetails= strcat('Log ', Log, ' from System ', SystemID, ' has produced ', RecordCount[-1], ' recods since ', format_datetime(todatetime(TimeGenerated[-1]), 'yy-MM-dd [hh:mm:ss tt]'), '. Expected number of records is ', round(toint(baseline[-1]), 0));\n(LogContinuationAnomal\n| join kind=leftantisemi (SystemLevelIssues\n    | where Status == \"Red\"\n    | summarize by SystemID)\n    on SystemID) // System-wide issues should overtake log level issues\n| union SystemLevelIssues\n| join kind= inner SelectedSystems on SystemID\n| where Severity != \"Informational\" // optionally can have these cases produce alerts by deleting this filter\n| where not (SystemRole == \"Production\" and Log startswith(\"ABAPCR\")) // CR logs coming from production systems are unpredictable\n| project Log, SystemID, SystemRole, LastSeen, Severity, Details, ExtendedDetails\n    , Agent, MessageCode, AgentVersion\n| extend Dummy= ''\n| extend AlertRuleUniqueName = 'datacollectionhealthcheck'\n",
                                "queryFrequency": "PT1H",
                                "queryPeriod": "P14D",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                    {
                                        "connectorId": "SAP",
                                        "dataTypes": [
                                            "SAPConnectorHealth",
                                            "SAPConnectorOverview",
                                            "SAPSystems"
                                        ]
                                    }
                                ],
                                "tactics": [
                                    "Impact"
                                ],
                                "entityMappings": [
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Name",
                                                "columnName": "SystemID"
                                            }
                                        ],
                                        "entityType": "CloudApplication"
                                    }
                                ],
                                "eventGroupingSettings": {
                                    "aggregationKind": "AlertPerResult"
                                },
                                "customDetails": {
                                    "Log": "Log",
                                    "MessageCode": "MessageCode",
                                    "AlertRuleUniqueName": "AlertRuleUniqueName"
                                },
                                "alertDetailsOverride": {
                                    "alertDescriptionFormat": "<img src=\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/SAP/Workbooks/SAPVMIcon.svg\" width=\"30\"/>\n  </br>\n{{ExtendedDetails}}.\n</br>\nFor more troubleshooting guidance, visit the  [Troubleshooting your Microsoft Sentinel Solution for SAP deployment](https://learn.microsoft.com/azure/sentinel/sap/sap-deploy-troubleshoot) guide.\n",
                                    "alertTacticsColumnName": "Dummy",
                                    "alertDisplayNameFormat": "{{Details}}",
                                    "alertSeverityColumnName": "Severity"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject22').analyticRuleId22,'/'))))]",
                            "properties": {
                                "description": "SAP Analytics Rule 22",
                                "parentId": "[variables('analyticRuleObject22').analyticRuleId22]",
                                "contentId": "[variables('analyticRuleObject22')._analyticRulecontentId22]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject22').analyticRuleVersion22]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SAP",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('analyticRuleObject22')._analyticRulecontentId22]",
                "contentKind": "AnalyticsRule",
                "displayName": "SAP - Data collection health check",
                "contentProductId": "[variables('analyticRuleObject22')._analyticRulecontentProductId22]",
                "id": "[variables('analyticRuleObject22')._analyticRulecontentProductId22]",
                "version": "[variables('analyticRuleObject22').analyticRuleVersion22]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('analyticRuleObject23').analyticRuleTemplateSpecName23]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP - Data has Changed during Debugging Activity_AnalyticalRules Analytics Rule with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('analyticRuleObject23').analyticRuleVersion23]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                            "name": "[variables('analyticRuleObject23')._analyticRulecontentId23]",
                            "apiVersion": "2022-04-01-preview",
                            "kind": "Scheduled",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "description": "Identifies changes for runtime data during a debugging activity.\nSource Action: Activate Debug (\"/h\"), Select a field for change and update it's value.\n\n**Recommended for Production only**\n\n*Data Sources: SAPcon -  Audit Log*",
                                "displayName": "SAP - Data has Changed during Debugging Activity",
                                "enabled": false,
                                "query": "let Role = 'Production';\nlet AuditClasses = dynamic(['CUL']); // Audit Log Classes - Debug Change\nlet allSystemRoles = dynamic(['Sandbox','Developement','QualityAssurance','Training','Production']); // Available System Roles\nlet allSystemUsage = dynamic (['ERP','CRM','BW','Solman','Gateway','Enterprise Portal']); // Available System Usages\n// Get Relevant Systems from WatchList\nlet systemID = _GetWatchlist('SAP - Systems');\nlet fixedSID = datatable(SystemID:string, SystemRole:string, SystemUsage:string)\n// Maintain these if WatchList is not available\n    [\"S4H\",\"Production\",\"ERP\",\n    \"XXX\",\"Sandbox\",\"BW\"]\n;\nlet UnitedSystem =\nunion systemID, fixedSID\n| summarize by SystemID, SystemRole, SystemUsage\n| where SystemRole == Role; // Recommended  is Production only\n//| where SystemRole in (allSystemRoles); // Use this for all system roles\nSAPAuditLog\n| where MessageID in (AuditClasses)\n| project-rename SystemIDTemp = SystemID\n| project-rename SystemID= SystemIDTemp\n| project-rename SystemID= SystemID\n| lookup kind = inner    (UnitedSystem) on SystemID\n| extend  ChangeDetails = pack_array(Variable1, Variable2, Variable3, Variable4)\n| project TimeGenerated,ClientID, Instance, User, MessageText, ChangeDetails, ABAPProgramName, TransactionCode, SystemID, SystemRole, SystemUsage, Email,TerminalIPv6, Host\n| extend AlertRuleUniqueName = 'datahaschangedduringdebuggingactivity'\n",
                                "queryFrequency": "PT1H",
                                "queryPeriod": "PT1H",
                                "severity": "High",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                    {
                                        "connectorId": "SAP",
                                        "dataTypes": [
                                            "SAPAuditLog"
                                        ]
                                    }
                                ],
                                "tactics": [
                                    "Execution",
                                    "LateralMovement"
                                ],
                                "entityMappings": [
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Email"
                                            }
                                        ],
                                        "entityType": "Account"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Address",
                                                "columnName": "TerminalIPv6"
                                            }
                                        ],
                                        "entityType": "IP"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Host"
                                            }
                                        ],
                                        "entityType": "Host"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Name",
                                                "columnName": "SystemID"
                                            },
                                            {
                                                "identifier": "AppId",
                                                "columnName": "ClientID"
                                            },
                                            {
                                                "identifier": "InstanceName",
                                                "columnName": "Instance"
                                            }
                                        ],
                                        "entityType": "CloudApplication"
                                    }
                                ],
                                "eventGroupingSettings": {
                                    "aggregationKind": "AlertPerResult"
                                },
                                "customDetails": {
                                    "AlertRuleUniqueName": "AlertRuleUniqueName",
                                    "SAP_User": "User"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject23').analyticRuleId23,'/'))))]",
                            "properties": {
                                "description": "SAP Analytics Rule 23",
                                "parentId": "[variables('analyticRuleObject23').analyticRuleId23]",
                                "contentId": "[variables('analyticRuleObject23')._analyticRulecontentId23]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject23').analyticRuleVersion23]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SAP",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('analyticRuleObject23')._analyticRulecontentId23]",
                "contentKind": "AnalyticsRule",
                "displayName": "SAP - Data has Changed during Debugging Activity",
                "contentProductId": "[variables('analyticRuleObject23')._analyticRulecontentProductId23]",
                "id": "[variables('analyticRuleObject23')._analyticRulecontentProductId23]",
                "version": "[variables('analyticRuleObject23').analyticRuleVersion23]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('analyticRuleObject24').analyticRuleTemplateSpecName24]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP - Deactivation of Security Audit Log_AnalyticalRules Analytics Rule with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('analyticRuleObject24').analyticRuleVersion24]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                            "name": "[variables('analyticRuleObject24')._analyticRulecontentId24]",
                            "apiVersion": "2022-04-01-preview",
                            "kind": "Scheduled",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "description": "Identifies deactivation of Security Audit Log\n\nSource Action: Disable secruity Audit Log using SM19/RSAU_CONFIG.\n\n*Data Sources: SAPcon -  Audit Log*",
                                "displayName": "SAP - Deactivation of Security Audit Log",
                                "enabled": false,
                                "query": "// Audit Log Classes - Audit Log Active Status Events\nlet AuditClasses = dynamic(['AUJ']);\nSAPAuditLog\n| where MessageID in (AuditClasses)\n| where Variable1 == '0' // Audit Active Status = 0\n| project\n// Details\nTimeGenerated, Instance ,SystemID, ClientID, User, MessageText, Email, TerminalIPv6, Host\n| extend AlertRuleUniqueName = 'deactivationofsecurityauditlog'\n",
                                "queryFrequency": "PT1H",
                                "queryPeriod": "PT2H",
                                "severity": "High",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                    {
                                        "connectorId": "SAP",
                                        "dataTypes": [
                                            "SAPAuditLog"
                                        ]
                                    }
                                ],
                                "tactics": [
                                    "Exfiltration",
                                    "DefenseEvasion",
                                    "Persistence"
                                ],
                                "entityMappings": [
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Email"
                                            }
                                        ],
                                        "entityType": "Account"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Address",
                                                "columnName": "TerminalIPv6"
                                            }
                                        ],
                                        "entityType": "IP"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Host"
                                            }
                                        ],
                                        "entityType": "Host"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Name",
                                                "columnName": "SystemID"
                                            },
                                            {
                                                "identifier": "AppId",
                                                "columnName": "ClientID"
                                            },
                                            {
                                                "identifier": "InstanceName",
                                                "columnName": "Instance"
                                            }
                                        ],
                                        "entityType": "CloudApplication"
                                    }
                                ],
                                "eventGroupingSettings": {
                                    "aggregationKind": "SingleAlert"
                                },
                                "customDetails": {
                                    "AlertRuleUniqueName": "AlertRuleUniqueName",
                                    "SAP_User": "User"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject24').analyticRuleId24,'/'))))]",
                            "properties": {
                                "description": "SAP Analytics Rule 24",
                                "parentId": "[variables('analyticRuleObject24').analyticRuleId24]",
                                "contentId": "[variables('analyticRuleObject24')._analyticRulecontentId24]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject24').analyticRuleVersion24]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SAP",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('analyticRuleObject24')._analyticRulecontentId24]",
                "contentKind": "AnalyticsRule",
                "displayName": "SAP - Deactivation of Security Audit Log",
                "contentProductId": "[variables('analyticRuleObject24')._analyticRulecontentProductId24]",
                "id": "[variables('analyticRuleObject24')._analyticRulecontentProductId24]",
                "version": "[variables('analyticRuleObject24').analyticRuleVersion24]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('analyticRuleObject25').analyticRuleTemplateSpecName25]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP - Debugging Activities_AnalyticalRules Analytics Rule with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('analyticRuleObject25').analyticRuleVersion25]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                            "name": "[variables('analyticRuleObject25')._analyticRulecontentId25]",
                            "apiVersion": "2022-04-01-preview",
                            "kind": "Scheduled",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "description": "Identifies all debugging related activities.\n\nSource Action: Activate Debug (\"/h\") in system, debug an active process, add breakpoint to source code etc.\n\n**Recommended for Production only**\n\n*Data Sources: SAPcon -  Audit Log*",
                                "displayName": "SAP - Debugging Activities",
                                "enabled": false,
                                "query": "let Role = 'Production';\nlet DebuggerProgram = 'RSTPDAMAIN';\nlet AuditClasses = dynamic(['CUK','CUL','CUM','CUN','CUO','CUP']); // Audit Log Classes - Debug Activities\nlet allSystemRoles = dynamic(['Sandbox','Developement','QualityAssurance','Training','Production']); // Available System Roles\nlet allSystemUsage = dynamic (['ERP','CRM','BW','Solman','Gateway','Enterprise Portal']); // Available System Usages\n// Get Relevant Systems from WatchList\nlet systemID = _GetWatchlist('SAP - Systems')\n| where SystemRole == Role; // Reccommended is Production only\nlet fixedSID = datatable(SystemID:string, SystemRole:string, SystemUsage:string)\n// Maintain these if WatchList is not available\n    [\"S4H\",\"Production\",\"ERP\",\n    \"XXX\",\"Sandbox\",\"BW\"]\n    | where SystemRole == Role // Reccommended is Production only\n;\nlet SystemUnited = union systemID, fixedSID\n| summarize by SystemID, SystemRole, SystemUsage;\n//| where SystemRole in (allSystemRoles); // Use this for all system roles\nSAPAuditLog\n    | where MessageID in (AuditClasses) or ABAPProgramName == DebuggerProgram // Get logs by messege ID or program name\n    | extend Object = extract(@\":\\s\\(?(\\w{1,}\\s?-?\\w{1,})\", 1, MessageText, typeof(string)) // Extract Object\n    | extend Action = extract(@\":\\s\\(?(\\w{1,}\\s?-?\\w{1,}.{1,}?)\\)?\\(\", 1, MessageText, typeof(string)) // Extract Action\n    | extend Program = extract(@\"Prgm:(\\w{1,})\", 1, MessageText, typeof(string)) // Extract Program\n    | extend Function = extract(@\"Funct:(\\w{1,})\", 1, MessageText, typeof(string)) // Extract Function\n    | extend Include = extract(@\"Incl:(\\w{1,})\", 1, MessageText, typeof(string)) // Extract Include\n    | extend Line = extract(@\"Line:(\\w{1,})\", 1, MessageText, typeof(string)) // Extract Line\n    | project-rename SystemIDTemp = SystemID\n| project-rename SystemID= SystemIDTemp\n| project-rename SystemID= SystemID\n    | lookup kind=inner (SystemUnited) on SystemID\n    | order by TimeGenerated asc\n    | project TimeGenerated, Instance, ClientID ,User, MessageText, ABAPProgramName, TransactionCode, SystemID, SystemRole, SystemUsage,MessageID, Email, TerminalIPv6, Host, Object , Action, Program, Function, Include, Line\n| extend AlertRuleUniqueName = 'debuggingactivities'\n",
                                "queryFrequency": "PT3H",
                                "queryPeriod": "PT3H",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                    {
                                        "connectorId": "SAP",
                                        "dataTypes": [
                                            "SAPAuditLog"
                                        ]
                                    }
                                ],
                                "tactics": [
                                    "Discovery"
                                ],
                                "entityMappings": [
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Email"
                                            }
                                        ],
                                        "entityType": "Account"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Address",
                                                "columnName": "TerminalIPv6"
                                            }
                                        ],
                                        "entityType": "IP"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Host"
                                            }
                                        ],
                                        "entityType": "Host"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Name",
                                                "columnName": "SystemID"
                                            },
                                            {
                                                "identifier": "AppId",
                                                "columnName": "ClientID"
                                            },
                                            {
                                                "identifier": "InstanceName",
                                                "columnName": "Instance"
                                            }
                                        ],
                                        "entityType": "CloudApplication"
                                    }
                                ],
                                "eventGroupingSettings": {
                                    "aggregationKind": "SingleAlert"
                                },
                                "customDetails": {
                                    "AlertRuleUniqueName": "AlertRuleUniqueName",
                                    "SAP_User": "User"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject25').analyticRuleId25,'/'))))]",
                            "properties": {
                                "description": "SAP Analytics Rule 25",
                                "parentId": "[variables('analyticRuleObject25').analyticRuleId25]",
                                "contentId": "[variables('analyticRuleObject25')._analyticRulecontentId25]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject25').analyticRuleVersion25]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SAP",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('analyticRuleObject25')._analyticRulecontentId25]",
                "contentKind": "AnalyticsRule",
                "displayName": "SAP - Debugging Activities",
                "contentProductId": "[variables('analyticRuleObject25')._analyticRulecontentProductId25]",
                "id": "[variables('analyticRuleObject25')._analyticRulecontentProductId25]",
                "version": "[variables('analyticRuleObject25').analyticRuleVersion25]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('analyticRuleObject26').analyticRuleTemplateSpecName26]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP - Dialog logon attempt from a privileged user_AnalyticalRules Analytics Rule with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('analyticRuleObject26').analyticRuleVersion26]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                            "name": "[variables('analyticRuleObject26')._analyticRulecontentId26]",
                            "apiVersion": "2022-04-01-preview",
                            "kind": "Scheduled",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "description": "Identifies dialog logon (Type AUM) attempts by priviledged users (See Function SAPUsersGetPrivileged) on SAP system .\nSource Action: Attempt to login from the same IP to several systems/clients within the scheduled time interval.\n\n*Data Sources: SAPcon -  Audit Log*",
                                "displayName": "SAP - Dialog logon attempt from a privileged user",
                                "enabled": false,
                                "query": "// SAP - High- Dialog logon attempt from a privileged user\n// time span for audit events\nlet AuditTimeAgo= 6h;\n// Define variables\nlet AuditClasses = dynamic(['AUM']);//Dialog only\nlet perIPLimit = 1;\n// Query logic\nSAPAuditLog\n| where TimeGenerated > ago(AuditTimeAgo)\n| where MessageID in (AuditClasses)\n| extend DetailsBy = pack(\"User\", User, \"Email\", Email, \"SystemID\", SystemID, \"ClientID\", ClientID)\n| summarize LoginbyIPAttempts = count(), Details = make_set(DetailsBy), StartTime = min(TimeGenerated), EndTime = max(TimeGenerated)\n    by TerminalIPv6\n// Check if number of login attempts per IP is higher than limit\n| where LoginbyIPAttempts > perIPLimit\n| mv-expand Details\n| evaluate bag_unpack(Details, \"Details_\")\n| project\n    StartTime, EndTime,  TerminalIPv6,\n    Email = column_ifexists(\"Details_Email\", \"\"), User = column_ifexists(\"Details_User\", \"\"),\n    SysetmID = column_ifexists(\"Details_SystemID\", \"\"),\n   ClientID = column_ifexists(\"Details_ClientID\", \"\")\n| join kind= inner (SAPUsersGetPrivileged | project User ) on $left.User == $right.User\n| extend AlertRuleUniqueName = 'dialoglogonattemptfromaprivilegeduser'\n",
                                "queryFrequency": "PT6H",
                                "queryPeriod": "P2D",
                                "severity": "High",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                    {
                                        "connectorId": "SAP",
                                        "dataTypes": [
                                            "SAPAuditLog",
                                            "SAPUsersGetPrivileged"
                                        ]
                                    }
                                ],
                                "tactics": [
                                    "CredentialAccess"
                                ],
                                "entityMappings": [
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Email"
                                            }
                                        ],
                                        "entityType": "Account"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Address",
                                                "columnName": "TerminalIPv6"
                                            }
                                        ],
                                        "entityType": "IP"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Name",
                                                "columnName": "SysetmID"
                                            },
                                            {
                                                "identifier": "AppId",
                                                "columnName": "ClientID"
                                            }
                                        ],
                                        "entityType": "CloudApplication"
                                    }
                                ],
                                "eventGroupingSettings": {
                                    "aggregationKind": "SingleAlert"
                                },
                                "customDetails": {
                                    "AlertRuleUniqueName": "AlertRuleUniqueName",
                                    "SAP_User": "User"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject26').analyticRuleId26,'/'))))]",
                            "properties": {
                                "description": "SAP Analytics Rule 26",
                                "parentId": "[variables('analyticRuleObject26').analyticRuleId26]",
                                "contentId": "[variables('analyticRuleObject26')._analyticRulecontentId26]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject26').analyticRuleVersion26]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SAP",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('analyticRuleObject26')._analyticRulecontentId26]",
                "contentKind": "AnalyticsRule",
                "displayName": "SAP - Dialog logon attempt from a privileged user",
                "contentProductId": "[variables('analyticRuleObject26')._analyticRulecontentProductId26]",
                "id": "[variables('analyticRuleObject26')._analyticRulecontentProductId26]",
                "version": "[variables('analyticRuleObject26').analyticRuleVersion26]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('analyticRuleObject27').analyticRuleTemplateSpecName27]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP - Dynamic ABAP Program_AnalyticalRules Analytics Rule with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('analyticRuleObject27').analyticRuleVersion27]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                            "name": "[variables('analyticRuleObject27')._analyticRulecontentId27]",
                            "apiVersion": "2022-04-01-preview",
                            "kind": "Scheduled",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "description": "Identifies execution of dynamic ABAP programming. For example, ABAP code was dynamically created/changed/deleted. Source Action: Create an ABAP Report which uses ABAP program generation commands such as \"INSERT REPORT\" and execute it. Excluded Transaction Codes can be maintained in \"SAP - Transactions for ABAP Generations\" watchlist. *Data Sources: SAPcon - Audit Log*",
                                "displayName": "SAP - Dynamic ABAP Program",
                                "enabled": false,
                                "query": "// Define variables\n// here you can exclude system users which are OK to execute a Dynamic ABAP Program\n// by adding those users in the SAP_User_Config watchlist with a tag of 'DynamicABAPProgramOK'\n// can also specify SAP Roles or Profiles to exclude\nlet excludeUsersTags= dynamic(['DynamicABAPProgramOK','SAP_ALL']);\nlet excludedUsers= SAPUsersGetVIP(SearchForTags= excludeUsersTags)| summarize by User2Exclude=SAPUser;\nlet AuditClasses = dynamic(['BU4']); // Message of dynamic ABAP program\nlet TranForABAPGen = _GetWatchlist(\"SAP - Transactions for ABAP Generations\"); // Transactions to exclude\n// Maintain if watchlist is not available\nlet fixedTran = datatable(TransactionCode:string)['SE11','SE12', \"SE16\", \"SE16N\"];\nlet UnitedTransactions =\ntoscalar(union TranForABAPGen, fixedTran\n| summarize Transactions = make_set(TransactionCode));\n// Query logic\nSAPAuditLog\n| where MessageID in (AuditClasses)\n| join kind=leftantisemi excludedUsers on $left.User == $right.User2Exclude\n| where TransactionCode !in (UnitedTransactions) // Exclude transactions\n| project TimeGenerated, Instance, User, SystemID, ClientID, Email, TerminalIPv6, Host, ABAPProgramName\n| extend AlertRuleUniqueName = 'dynamicabapprogram'\n",
                                "queryFrequency": "PT6H",
                                "queryPeriod": "PT6H",
                                "severity": "Low",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                    {
                                        "connectorId": "SAP",
                                        "dataTypes": [
                                            "SAPAuditLog",
                                            "SAPUsersGetVIP"
                                        ]
                                    }
                                ],
                                "tactics": [
                                    "Discovery",
                                    "CommandAndControl",
                                    "Impact"
                                ],
                                "entityMappings": [
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Email"
                                            }
                                        ],
                                        "entityType": "Account"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Address",
                                                "columnName": "TerminalIPv6"
                                            }
                                        ],
                                        "entityType": "IP"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "HostName",
                                                "columnName": "Host"
                                            }
                                        ],
                                        "entityType": "Host"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Name",
                                                "columnName": "SystemID"
                                            },
                                            {
                                                "identifier": "AppId",
                                                "columnName": "ClientID"
                                            },
                                            {
                                                "identifier": "InstanceName",
                                                "columnName": "Instance"
                                            }
                                        ],
                                        "entityType": "CloudApplication"
                                    }
                                ],
                                "eventGroupingSettings": {
                                    "aggregationKind": "SingleAlert"
                                },
                                "customDetails": {
                                    "AlertRuleUniqueName": "AlertRuleUniqueName",
                                    "SAP_User": "User"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject27').analyticRuleId27,'/'))))]",
                            "properties": {
                                "description": "SAP Analytics Rule 27",
                                "parentId": "[variables('analyticRuleObject27').analyticRuleId27]",
                                "contentId": "[variables('analyticRuleObject27')._analyticRulecontentId27]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject27').analyticRuleVersion27]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SAP",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('analyticRuleObject27')._analyticRulecontentId27]",
                "contentKind": "AnalyticsRule",
                "displayName": "SAP - Dynamic ABAP Program",
                "contentProductId": "[variables('analyticRuleObject27')._analyticRulecontentProductId27]",
                "id": "[variables('analyticRuleObject27')._analyticRulecontentProductId27]",
                "version": "[variables('analyticRuleObject27').analyticRuleVersion27]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('analyticRuleObject28').analyticRuleTemplateSpecName28]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP - Dynamic Deterministic Audit Log Monitor_AnalyticalRules Analytics Rule with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('analyticRuleObject28').analyticRuleVersion28]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                            "name": "[variables('analyticRuleObject28')._analyticRulecontentId28]",
                            "apiVersion": "2022-04-01-preview",
                            "kind": "Scheduled",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "description": "SAP Audit log events with message IDs preconfigured in Watchlist SAP_Dynamic_Audit_Log_Monitor_Configuration\nwill be shown here.\nSee  [Sentinel4SAP Dcoumentation](https://aka.ms/sapsecdocs) for further information",
                                "displayName": "SAP - Dynamic Deterministic Audit Log Monitor",
                                "enabled": false,
                                "query": "// Sentinel4SAP solution version 1.2.98\n// populate static selections for workspace level configuration\n// time span for audit events\nlet AuditTimeAgo= 65m;\nlet SelectedSystems =  dynamic([\"All Systems\"]);//can also do// let SelectedSystems =  dynamic([\"S4P\", \"B4X\", \"ODT\"]);\nlet SelectedSystemRoles =  dynamic([\"All System Roles\"]); //can also do// let SelectedSystemRoles =  dynamic([\"Production\", \"UAT\"]);\nlet SelectedSeverities=  dynamic([\"High\", \"Medium\"]);//can also do//let SelectedSeverities =  dynamic([\"All Severities\"])\nlet SelectedRuleTypes= dynamic([ \"Deterministic\"]); // Rule only goes for deterministic alerting\n// users that are tagged with these tags in the SAP_User_Config WL will produce high severity incidents on all activities\nlet SpecialFocusTags=dynamic([\"SoonToLeave\"]); // can also do dynamic([\"SoonToLeave\", \"Compromised\"])\nlet AuditConfiguration= materialize(SAPAuditLogConfiguration(SelectedSystems, SelectedSystemRoles, SelectedSeverities= dynamic([\"All Severities\"]), SelectedRuleTypes= SelectedRuleTypes));\n// get special users for exclusion and in-focus analysis\nlet SAPUsersGottenVIP = (SAPUsersGetVIP(SpecialFocusTags= SpecialFocusTags) | project-rename User = SAPUser);\nlet SAPUserRolesAndProfiles = (SAPUsersAssignments | project-keep User, SystemID, DirectRoles, ChildRoles, Profiles | summarize RolesAndProfiles = make_set(array_concat(DirectRoles, ChildRoles, Profiles), 120) by User, SystemID | where SystemID in ((AuditConfiguration | summarize  by SystemID)));\nlet AuditEvents = (SAPAuditLog\n| where TimeGenerated > ago(AuditTimeAgo)\n| where SystemID in ((AuditConfiguration | summarize  by SystemID))\n| where MessageID in ((AuditConfiguration | summarize  by MessageID))\n// Alerts coming from SAP as \"Low\" aren't very intersting\n| where AlertSeverityText != \"Low\"\n// get the configuration from the \"SAPAuditLogConfiguration\" watchlist which allows\n// assigning severity levels per system Role (Production/ non-production), automatic team assignments and other configuration options\n// we'll fetch all severities to allow for alerting on \"Special Focus\" users regardless of severity\n| lookup kind=inner AuditConfiguration on\n$left.MessageID == $right.MessageID\n,$left.SystemID == $right.SystemID\n);\n// Query\nAuditEvents\n// get the user privleged status\n| lookup (SAPUsersGetPrivileged() | extend IsPrivilegedUser = true) on\n$left.SystemID == $right.SystemID\n,$left.User == $right.User\n,$left.ClientID == $right.Client\n| extend DetailedDescription = iff(IsPrivilegedUser, strcat('User ', User,  ' is a privileged user! <br/>', DetailedDescription), DetailedDescription)\n| extend BagOfDetails = tostring(BagOfDetails)\n// handle threshold per system (configurable via the SAPAuditLogConfigurator watchlist)\n// calculate the timespan for analysis for thresholding\n| summarize EventCount= count(),  Threshold = max( Threshold), MinTime= min(TimeGenerated), MaxTime = max(TimeGenerated)\nby AuditClassID, AlertSeverityText, SystemID, Instance, MonitoringObjectName, MonitorShortName, MessageText, MessageClass, MessageID, AlertValue, AlertSeverity, ClientID, User, Variable1, Variable2, Variable3, Variable4, TerminalIPv6, TransactionCode, ABAPProgramName, SAPProcesType, SAPWPName, Email, SystemNumber, Host, Type, CategoryName, DestinationEmail, DetailedDescription, Tactics, TeamsChannelID, SystemRole, SystemUsage, IsProd, Severity, BagOfDetails, IsPrivilegedUser, RolesTagsToExclude\n| extend  TimeGenerated = MaxTime\n| extend MessageText = iff(MessageText endswith_cs \".\", substring(MessageText, 0, strlen(MessageText)-1), MessageText)\n// To reduce false positives, exclude users whos tags in the SAP_User_Config watchlist\n// match tags in the RolesTagsToExclude column in the SAP_Dynamic_Audit_Log_Monitor_Configuration\n// tags can be either strings representing a group such as Batch; Sensitive; Super; MassiveLogonsOK; MassiveRFCOK; GenericTablebyRFCOK\n// or SAP roles such as SAP_BC_TRANSPORT_ADMINISTRATOR, or SAP profiles like SAP_ALL\n| lookup SAPUsersGottenVIP on User\n| lookup SAPUserRolesAndProfiles on User, SystemID\n| extend RolesProfilesAndTags = array_concat(RolesAndProfiles, TagsList)\n| extend TagsIntersect = set_intersect(split(RolesTagsToExclude,\";\"), RolesProfilesAndTags)\n| extend IntersectionSize = array_length(TagsIntersect)\n// keep only non-excluded users that are not under \"Special Focus\"\n| where IntersectionSize == 0 or isempty(IntersectionSize) or SpecialFocusTagged == true\n| extend DetailedDescription = iff(SpecialFocusTagged, strcat('User ', User,  ' is a specially tagged User with tags ', TagsList ,'<br/>', DetailedDescription), DetailedDescription)\n// Special Focus users production alerts are considered as high\n| extend Severity = iff(SpecialFocusTagged,'High',Severity)\n// | where SelectedSeverities contains Severity\n//  apply the threshold criteria, consider that the watchlist describes hourly thresholds\n| extend MinutesSpan = datetime_diff('Minute', MaxTime, MinTime )\n// | where EventCount > (Threshold * max_of(MinutesSpan, 10) / 60) or SpecialFocusTagged == true\n| extend DetailedDescription = iff(EventCount > 1, strcat(' Event occured ', EventCount, ' times within ', MinutesSpan + 1, ' minutes.<br/> ', 'The predefined threshold of ', Threshold,  ' Events per hour was exceeded! <br/>', DetailedDescription), DetailedDescription)\n| extend MessageText = iff(MessageText endswith_cs \".\", substring(MessageText, 0, strlen(MessageText)-1), MessageText)\n| project-keep AuditClassID, AlertSeverityText, SystemID, Instance, MessageText, MessageClass, MessageID, AlertValue, AlertSeverity, ClientID, User, Variable1, Variable2, Variable3, Variable4, TerminalIPv6, TransactionCode, ABAPProgramName, SAPProcesType, SAPWPName, Email, SystemNumber, Host, CategoryName, DestinationEmail, DetailedDescription, Tactics, TeamsChannelID, SystemRole, SystemUsage, IsProd, Severity, BagOfDetails, IsPrivilegedUser, EventCount, Threshold, TimeGenerated\n| extend AlertRuleUniqueName = 'dynamicdeterministicauditlogmonitor'\n",
                                "queryFrequency": "PT1H",
                                "queryPeriod": "P7D",
                                "severity": "High",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                    {
                                        "connectorId": "SAP",
                                        "dataTypes": [
                                            "SAPAuditLog",
                                            "SAPAuditLogConfiguration",
                                            "SAPUsersAssignments",
                                            "SAPUsersGetPrivileged",
                                            "SAPUsersGetVIP"
                                        ]
                                    }
                                ],
                                "entityMappings": [
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Email"
                                            }
                                        ],
                                        "entityType": "Account"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Name",
                                                "columnName": "SystemID"
                                            },
                                            {
                                                "identifier": "AppId",
                                                "columnName": "ClientID"
                                            },
                                            {
                                                "identifier": "InstanceName",
                                                "columnName": "Instance"
                                            }
                                        ],
                                        "entityType": "CloudApplication"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Address",
                                                "columnName": "TerminalIPv6"
                                            }
                                        ],
                                        "entityType": "IP"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "ProcessId",
                                                "columnName": "TransactionCode"
                                            },
                                            {
                                                "identifier": "CommandLine",
                                                "columnName": "ABAPProgramName"
                                            }
                                        ],
                                        "entityType": "Process"
                                    }
                                ],
                                "eventGroupingSettings": {
                                    "aggregationKind": "AlertPerResult"
                                },
                                "customDetails": {
                                    "BagOfDetails": "BagOfDetails",
                                    "DestinationEmail": "DestinationEmail",
                                    "TeamsChannelID": "TeamsChannelID",
                                    "SAP_User": "User",
                                    "SAPProcessType": "SAPProcesType",
                                    "AuditClassID": "AuditClassID",
                                    "SystemUsage": "SystemUsage",
                                    "SAPAuditLogMessageID": "MessageID",
                                    "AlertRuleUniqueName": "AlertRuleUniqueName",
                                    "IsProductionEnv": "IsProd",
                                    "SystemRole": "SystemRole"
                                },
                                "alertDetailsOverride": {
                                    "alertDescriptionFormat": "#### Detailed information\n{{DetailedDescription}}\n#### Additional information\n{{BagOfDetails}}<br/>\nAlerts of this type can be configured using watch list SAPAuditLogConfigurator . <br/>\nSee  [Sentinel4SAP Dcoumentation](https://aka.ms/sapsecdocs) for further information\n",
                                    "alertTacticsColumnName": "Tactics",
                                    "alertDisplayNameFormat": "SAP - {{MessageText}} in system {{SystemID}}",
                                    "alertSeverityColumnName": "Severity"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject28').analyticRuleId28,'/'))))]",
                            "properties": {
                                "description": "SAP Analytics Rule 28",
                                "parentId": "[variables('analyticRuleObject28').analyticRuleId28]",
                                "contentId": "[variables('analyticRuleObject28')._analyticRulecontentId28]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject28').analyticRuleVersion28]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SAP",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('analyticRuleObject28')._analyticRulecontentId28]",
                "contentKind": "AnalyticsRule",
                "displayName": "SAP - Dynamic Deterministic Audit Log Monitor",
                "contentProductId": "[variables('analyticRuleObject28')._analyticRulecontentProductId28]",
                "id": "[variables('analyticRuleObject28')._analyticRulecontentProductId28]",
                "version": "[variables('analyticRuleObject28').analyticRuleVersion28]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('analyticRuleObject29').analyticRuleTemplateSpecName29]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP - Dynamic RFC Destination_AnalyticalRules Analytics Rule with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('analyticRuleObject29').analyticRuleVersion29]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                            "name": "[variables('analyticRuleObject29')._analyticRulecontentId29]",
                            "apiVersion": "2022-04-01-preview",
                            "kind": "Scheduled",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "description": "Identifies execution of RFC using dynamic destinations. Source Action: Execute an ABAP report which is using dynamic destinations (cl_dynamic_destination). Sample report: DEMO_RFC_DYNAMIC_DEST. *Data Sources: SAPcon - Audit Log*",
                                "displayName": "SAP - Dynamic RFC Destination",
                                "enabled": false,
                                "query": "// Define variables\nlet AuditClasses = dynamic(['FU1']); // Message of dynamic RFC execution using dynamic destination\n// Query logic\nSAPAuditLog\n| where MessageID in (AuditClasses)\n| parse Variable3 with \"id=\" Created_RFC_Name\n| project TimeGenerated,Instance, SystemID, ClientID, User, Email, TerminalIPv6, Host, ABAPProgramName, ExecutedProgram = Variable2, Created_RFC_Name\n| extend AlertRuleUniqueName = 'dynamicrfcdestination'\n",
                                "queryFrequency": "PT6H",
                                "queryPeriod": "PT6H",
                                "severity": "Low",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                    {
                                        "connectorId": "SAP",
                                        "dataTypes": [
                                            "SAPAuditLog"
                                        ]
                                    }
                                ],
                                "tactics": [
                                    "Collection",
                                    "Exfiltration"
                                ],
                                "entityMappings": [
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Email"
                                            }
                                        ],
                                        "entityType": "Account"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Address",
                                                "columnName": "TerminalIPv6"
                                            }
                                        ],
                                        "entityType": "IP"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Host"
                                            }
                                        ],
                                        "entityType": "Host"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Name",
                                                "columnName": "SystemID"
                                            },
                                            {
                                                "identifier": "AppId",
                                                "columnName": "ClientID"
                                            },
                                            {
                                                "identifier": "InstanceName",
                                                "columnName": "Instance"
                                            }
                                        ],
                                        "entityType": "CloudApplication"
                                    }
                                ],
                                "eventGroupingSettings": {
                                    "aggregationKind": "SingleAlert"
                                },
                                "customDetails": {
                                    "AlertRuleUniqueName": "AlertRuleUniqueName",
                                    "SAP_User": "User"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject29').analyticRuleId29,'/'))))]",
                            "properties": {
                                "description": "SAP Analytics Rule 29",
                                "parentId": "[variables('analyticRuleObject29').analyticRuleId29]",
                                "contentId": "[variables('analyticRuleObject29')._analyticRulecontentId29]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject29').analyticRuleVersion29]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SAP",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('analyticRuleObject29')._analyticRulecontentId29]",
                "contentKind": "AnalyticsRule",
                "displayName": "SAP - Dynamic RFC Destination",
                "contentProductId": "[variables('analyticRuleObject29')._analyticRulecontentProductId29]",
                "id": "[variables('analyticRuleObject29')._analyticRulecontentProductId29]",
                "version": "[variables('analyticRuleObject29').analyticRuleVersion29]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('analyticRuleObject30').analyticRuleTemplateSpecName30]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP - Execution of Sensitive Function Module_AnalyticalRules Analytics Rule with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('analyticRuleObject30').analyticRuleVersion30]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                            "name": "[variables('analyticRuleObject30')._analyticRulecontentId30]",
                            "apiVersion": "2022-04-01-preview",
                            "kind": "Scheduled",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "description": "Identifies execution of a sensitive ABAP Function Module.\n\nSource Action: Execute a sensitive function module directly using SE37.\n\n**Recommended for Production only**\n\nSensitive functions should be maintained in \"SAP - Sensitive Function Modules\" Watchlist.\nTable logging changes should be activated for table \"EUFUNC\" in backend. (SE13)\n\n*Data Sources: SAPcon -  Table Data Log*",
                                "displayName": "SAP - Execution of Sensitive Function Module",
                                "enabled": false,
                                "query": "// SAP - Execution of Sensitive Function Module\n// Define variables\nlet RelTable = \"EUFUNC\"; // Relevant table\nlet AuditLogIn = dynamic(['AU1', 'AU5']); // Messages of connect with user\nlet SenseModules =  _GetWatchlist('SAP - Sensitive Function Modules');\nlet fixedModules = datatable(FunctionModule:string)['RSAU_CLEAR_AUDIT_LOG','BAPI_USER_CREATE', 'RFC_GET_TABLE_ENTRIES'];\nlet UnitedModules =\ntoscalar(union fixedModules, SenseModules\n| summarize FunctionModules =  make_set(FunctionModule));\n// here you can exclude system users which are OK to execute a Sensitive function module\n// by adding those users in the SAP_User_Config watchlist with a tag of 'ExecuteSensitiveFMOK'\n// can also specify SAP Roles or Profiles to exclude\nlet excludeUsersTags= dynamic(['ExecuteSensitiveFMOK','SAP_ALL']);\nlet excludedUsers= SAPUsersGetVIP(SearchForTags= excludeUsersTags)| summarize by User2Exclude=SAPUser;\n// Query logic\nlet LastLogin = SAPAuditLog\n| where MessageID in (AuditLogIn)\n| summarize TimeGenerated = arg_max(TimeGenerated, *) by SystemID, ClientID, User; // Get last connection date for user\nSAPTableDataLog\n| where TableName == RelTable\n| extend Module = extract(@\"\\s+(.{1,}\\b)\\s+\", 1, LogKey, typeof(string)) // Extract Function Module\n| extend FunctionGroup = extract(@\"^FL([^\\s]*)\\s\", 1, LogKey, typeof(string)) // Extract Function Group\n| extend ExecutionVariant = extract(@\"\\b(\\w+)$\", 1, LogKey, typeof(string)) // Extract Execution Varient\n| where Module in (UnitedModules) // Module is sensitive\n| lookup kind=inner LastLogin on $left.UserName == $right.User\n| join kind=leftantisemi excludedUsers on $left.UserName == $right.User2Exclude\n| project TimeGenerated, Instance ,SystemID, UserName, ClientID, Email, TerminalIPv6, Host, Module, FunctionGroup, ExecutionVariant\n| extend AlertRuleUniqueName = 'executionofsensitivefunctionmodule'\n",
                                "queryFrequency": "PT2H",
                                "queryPeriod": "PT2H",
                                "severity": "High",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                    {
                                        "connectorId": "SAP",
                                        "dataTypes": [
                                            "SAPAuditLog",
                                            "SAPTableDataLog",
                                            "SAPUsersGetVIP"
                                        ]
                                    }
                                ],
                                "tactics": [
                                    "Discovery",
                                    "CommandAndControl"
                                ],
                                "entityMappings": [
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Email"
                                            }
                                        ],
                                        "entityType": "Account"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Address",
                                                "columnName": "TerminalIPv6"
                                            }
                                        ],
                                        "entityType": "IP"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Host"
                                            }
                                        ],
                                        "entityType": "Host"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Name",
                                                "columnName": "SystemID"
                                            },
                                            {
                                                "identifier": "AppId",
                                                "columnName": "ClientID"
                                            },
                                            {
                                                "identifier": "InstanceName",
                                                "columnName": "Instance"
                                            }
                                        ],
                                        "entityType": "CloudApplication"
                                    }
                                ],
                                "eventGroupingSettings": {
                                    "aggregationKind": "AlertPerResult"
                                },
                                "customDetails": {
                                    "AlertRuleUniqueName": "AlertRuleUniqueName",
                                    "SAP_User": "UserName"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject30').analyticRuleId30,'/'))))]",
                            "properties": {
                                "description": "SAP Analytics Rule 30",
                                "parentId": "[variables('analyticRuleObject30').analyticRuleId30]",
                                "contentId": "[variables('analyticRuleObject30')._analyticRulecontentId30]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject30').analyticRuleVersion30]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SAP",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('analyticRuleObject30')._analyticRulecontentId30]",
                "contentKind": "AnalyticsRule",
                "displayName": "SAP - Execution of Sensitive Function Module",
                "contentProductId": "[variables('analyticRuleObject30')._analyticRulecontentProductId30]",
                "id": "[variables('analyticRuleObject30')._analyticRulecontentProductId30]",
                "version": "[variables('analyticRuleObject30').analyticRuleVersion30]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('analyticRuleObject31').analyticRuleTemplateSpecName31]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP - Execution of a Sensitive ABAP Program_AnalyticalRules Analytics Rule with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('analyticRuleObject31').analyticRuleVersion31]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                            "name": "[variables('analyticRuleObject31')._analyticRulecontentId31]",
                            "apiVersion": "2022-04-01-preview",
                            "kind": "Scheduled",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "description": "Identifies direct execution of a sensitive ABAP program.\n\nSource Action: Execute a program directly using SE38/SA38/SE80.\n\n**Recommended for Production only**\n\nABAP Programs should be maintained in watchlist \"SAP - Sensitive ABAP Programs\"\n\n*Data Sources: SAPcon -  Audit Log*",
                                "displayName": "SAP - Execution of a Sensitive ABAP Program",
                                "enabled": false,
                                "query": "// SAP - Execution of a Sensitive ABAP Program\n// this alert rule requires the \"look back\" period to be greater than 2 days to include a full user master data load\n// the actual lookback period for the events is determined using the TimeAgo parameter\nlet TimeAgo= 60m;\n// determine which system roles are relevant for this alert\nlet SelectedSystemRoles =  dynamic([\"Production\"]); //can also do// let SelectedSystemRoles =  dynamic([\"All System Roles\"]);\nlet SelectedSystems = SAPSystems(SelectedSystemRoles= SelectedSystemRoles)\n    | project SystemID= SearchKey, SystemRole, SystemUsage\n    | extend SystemRole= replace_string(SystemRole, 'Unknown (Production)', 'Unknown');\n// here you can exclude system users which are OK to execute a Sensitive ABAP Program\n// by adding those users in the SAP_User_Config watchlist with a tag of 'SensitiveABAPProgramOK'\n// can also specify SAP Roles or Profiles to exclude\nlet excludeUsersTags= dynamic(['SensitiveABAPProgramOK','SAPRole','SAPProfile']);\nlet excludedUsers= SAPUsersGetVIP(SearchForTags= excludeUsersTags)| summarize by User2Exclude=SAPUser;\n// Get Relevant ABAP Programs, along with users which are OK to execute them. if the 'SAP - Sensitive ABAP Programs' watchlist is missing the UsersExcluded column,\n// add the column manually, or force this watchlist to refresh using a fresh install of the solution, using the\nlet SensitiveABAPReports = _GetWatchlist('SAP - Sensitive ABAP Programs')\n| extend UsersExcluded= replace_string(column_ifexists(\"UsersExcluded\",\"\"), \" \",\"\")\n| extend UsersExcluded= parse_csv(UsersExcluded)\n| summarize UsersExcluded= make_set(UsersExcluded, 1000), Description=take_anyif(Description, isnotempty(Description)) by ABAPProgramName= SearchKey;\nlet fixedABAPReports = datatable(ABAPProgramName:string, Description:string , UsersExcluded: dynamic)\n// Maintain these if WatchList is not available\n    [\"RSPFLDOC\", \"Profile Parameter Maintenance\", \"DummyUser\"];\nlet UnionAbap =\n    union SensitiveABAPReports, fixedABAPReports\n    | summarize UsersExcluded= make_set(UsersExcluded, 1000), Description=any(Description)  by ABAPProgramName;\n// Query logic\nSAPAuditLog\n| where TimeGenerated > ago(TimeAgo + 1h)\n| where MessageID == 'AUW'\n| where ingestion_time() > ago(TimeAgo)\n| join kind= inner UnionAbap on ABAPProgramName\n| where UsersExcluded !has User\n| where SystemID in ((SelectedSystems | project SystemID))\n| join kind=leftantisemi excludedUsers on $left.User == $right.User2Exclude\n| order by TimeGenerated asc\n| project TimeGenerated, Instance , SystemID, ClientID, User, ABAPProgramName, MessageText, TransactionCode, MessageID, Email, TerminalIPv6, Host\n| extend AlertRuleUniqueName = 'executionofasensitiveabapprogram'\n",
                                "queryFrequency": "PT1H",
                                "queryPeriod": "PT1H",
                                "severity": "High",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                    {
                                        "connectorId": "SAP",
                                        "dataTypes": [
                                            "SAPAuditLog",
                                            "SAPSystems",
                                            "SAPUsersGetVIP"
                                        ]
                                    }
                                ],
                                "tactics": [
                                    "Exfiltration",
                                    "LateralMovement",
                                    "Execution"
                                ],
                                "entityMappings": [
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Email"
                                            }
                                        ],
                                        "entityType": "Account"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Address",
                                                "columnName": "TerminalIPv6"
                                            }
                                        ],
                                        "entityType": "IP"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Host"
                                            }
                                        ],
                                        "entityType": "Host"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Name",
                                                "columnName": "SystemID"
                                            },
                                            {
                                                "identifier": "AppId",
                                                "columnName": "ClientID"
                                            },
                                            {
                                                "identifier": "InstanceName",
                                                "columnName": "Instance"
                                            }
                                        ],
                                        "entityType": "CloudApplication"
                                    }
                                ],
                                "eventGroupingSettings": {
                                    "aggregationKind": "SingleAlert"
                                },
                                "customDetails": {
                                    "AlertRuleUniqueName": "AlertRuleUniqueName",
                                    "SAP_User": "User"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject31').analyticRuleId31,'/'))))]",
                            "properties": {
                                "description": "SAP Analytics Rule 31",
                                "parentId": "[variables('analyticRuleObject31').analyticRuleId31]",
                                "contentId": "[variables('analyticRuleObject31')._analyticRulecontentId31]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject31').analyticRuleVersion31]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SAP",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('analyticRuleObject31')._analyticRulecontentId31]",
                "contentKind": "AnalyticsRule",
                "displayName": "SAP - Execution of a Sensitive ABAP Program",
                "contentProductId": "[variables('analyticRuleObject31')._analyticRulecontentProductId31]",
                "id": "[variables('analyticRuleObject31')._analyticRulecontentProductId31]",
                "version": "[variables('analyticRuleObject31').analyticRuleVersion31]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('analyticRuleObject32').analyticRuleTemplateSpecName32]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP - Execution of a Sensitive Transaction Code_AnalyticalRules Analytics Rule with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('analyticRuleObject32').analyticRuleVersion32]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                            "name": "[variables('analyticRuleObject32')._analyticRulecontentId32]",
                            "apiVersion": "2022-04-01-preview",
                            "kind": "Scheduled",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "description": "Identifies execution of a sensitive Transaction Code.\n\nSource Action: Execute a sensitive Transaction Code.\n\n**Recommended for Production only**\n\nTransaction Codes should be maintained in watchlist \"\"SAP - Sensitive Transaction Codes\"\"\n\n*Data Sources: SAPcon -  Audit Log*",
                                "displayName": "SAP - Execution of a Sensitive Transaction Code",
                                "enabled": false,
                                "query": "// SAP - Execution of a Sensitive Transaction Code\n// Define Variables\n// the actual lookback period is 1h. The alert looks back further to allow for user master data to be built slowly\nlet TimeAgo= 75m;\n// let AuditClasses = dynamic(['AU3']); // Audit Log Classes - Transaction Started\nlet SelectedSystemRoles =  dynamic([\"Production\"]); //can also do// let SelectedSystemRoles =  dynamic([\"Production\", \"UAT\"]); dynamic([\"All System Roles\"])\nlet SelectedSystems = SAPSystems(SelectedSystemRoles= SelectedSystemRoles) | project SystemID= SearchKey, SystemRole;\n// Get Relevant Transaction Codes\nlet SensitiveTcode = _GetWatchlist('SAP - Sensitive Transactions') | summarize by TransactionCode;\n// here you can exclude system users which are OK to execute a Sensitive Transaction Code\n// by adding those users in the SAP_User_Config watchlist with a tag of 'ExecuteSensitiveOK'\n// can also specify SAP Roles or Profiles to exclude\nlet excludeUsersTags= dynamic(['ExecuteSensitiveOK','SAP_ALL']);\nlet excludedUsers= SAPUsersGetVIP(SearchForTags= excludeUsersTags)| summarize by User2Exclude=SAPUser;\n// Query logic\nSAPAuditLog\n| where ingestion_time() > ago(TimeAgo)\n| where MessageID == 'AU3'\n| join kind=inner SelectedSystems on SystemID\n| where TransactionCode in (SensitiveTcode) or Variable1 in (SensitiveTcode)\n| join kind=leftantisemi excludedUsers on $left.User == $right.User2Exclude\n| order by TimeGenerated asc\n| project TimeGenerated,Instance ,SystemID, ClientID, User, TransactionCode, MessageText, MessageID, Email, TerminalIPv6, Host, TCODE=Variable1, SystemRole\n| extend AlertName= strcat(\"SAP - \", replace_string(MessageText, \".\",\"\"), \" by user \", User,\" in a \", tolower(SystemRole), \" system\")\n| extend AlertDescription= strcat(iff(TCODE in (SensitiveTcode), \"Sensitive transaction code \", \"Transaction code \"), TCODE,\n\" was started from \", iff(TransactionCode in (SensitiveTcode), \" the sensitive context of \", \" from the context of \"),TransactionCode, \". Sensitive transactions are being maintained in the 'SAP - Sensitive Transactions' watchlist.\")\n| extend Dummy= \"\"\n| extend AlertRuleUniqueName = 'executionofasensitivetransactioncode'\n",
                                "queryFrequency": "PT1H",
                                "queryPeriod": "P2D",
                                "severity": "High",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                    {
                                        "connectorId": "SAP",
                                        "dataTypes": [
                                            "SAPAuditLog",
                                            "SAPSystems",
                                            "SAPUsersGetVIP"
                                        ]
                                    }
                                ],
                                "tactics": [
                                    "Discovery",
                                    "Execution"
                                ],
                                "entityMappings": [
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Email"
                                            }
                                        ],
                                        "entityType": "Account"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Address",
                                                "columnName": "TerminalIPv6"
                                            }
                                        ],
                                        "entityType": "IP"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Host"
                                            }
                                        ],
                                        "entityType": "Host"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Name",
                                                "columnName": "SystemID"
                                            },
                                            {
                                                "identifier": "AppId",
                                                "columnName": "ClientID"
                                            },
                                            {
                                                "identifier": "InstanceName",
                                                "columnName": "Instance"
                                            }
                                        ],
                                        "entityType": "CloudApplication"
                                    }
                                ],
                                "eventGroupingSettings": {
                                    "aggregationKind": "AlertPerResult"
                                },
                                "customDetails": {
                                    "TransactionCode": "TransactionCode",
                                    "SAP_User": "User",
                                    "AlertRuleUniqueName": "AlertRuleUniqueName"
                                },
                                "alertDetailsOverride": {
                                    "alertDescriptionFormat": "{{AlertDescription}}",
                                    "alertTacticsColumnName": "Dummy",
                                    "alertDisplayNameFormat": "{{AlertName}}",
                                    "alertSeverityColumnName": "Dummy"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject32').analyticRuleId32,'/'))))]",
                            "properties": {
                                "description": "SAP Analytics Rule 32",
                                "parentId": "[variables('analyticRuleObject32').analyticRuleId32]",
                                "contentId": "[variables('analyticRuleObject32')._analyticRulecontentId32]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject32').analyticRuleVersion32]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SAP",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('analyticRuleObject32')._analyticRulecontentId32]",
                "contentKind": "AnalyticsRule",
                "displayName": "SAP - Execution of a Sensitive Transaction Code",
                "contentProductId": "[variables('analyticRuleObject32')._analyticRulecontentProductId32]",
                "id": "[variables('analyticRuleObject32')._analyticRulecontentProductId32]",
                "version": "[variables('analyticRuleObject32').analyticRuleVersion32]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('analyticRuleObject33').analyticRuleTemplateSpecName33]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP - Execution of an Obsolete or an Insecure Function Module_AnalyticalRules Analytics Rule with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('analyticRuleObject33').analyticRuleVersion33]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                            "name": "[variables('analyticRuleObject33')._analyticRulecontentId33]",
                            "apiVersion": "2022-04-01-preview",
                            "kind": "Scheduled",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "description": "Identifies execution of an obsolete/insecure ABAP Function Module.\n\nSource Action: Execute an obsolete/insecure function module directly using SE37.\n\n**Recommended for Production only**\n\nObsolete functions should be maintained in \"SAP - Obsolete Function Modules\" Watchlist.",
                                "displayName": "SAP - Execution of an Obsolete or an Insecure Function Module",
                                "enabled": false,
                                "query": "// Execution of Obsolete or Insecure Function Module\n// AUK - Successful RFC call &C (function group = A) (C)\n// AUL - Failed RFC call &C (function group = &A)  (C)\n// DUI - RFC callback executed (destination &A, called &B, callback &C) (B)\n// DUJ - RFC callback rejected (destination &A, called &B, callback &C) (B)\n// DUK - RFC callback rejected (destination &A, called &B, callback &C) (B)\n// DUR - JSON RPC call of function module &A succeeded  (A)\n// DUS - SON RPC call of function module &A failed  (A)\n// DUT - Critical JSON RPC call of function module &A (S_RFC * authorization) (A)\n// EUE - RFC function module &A called successfully (A)\n// EUF - Could not call RFC function module &A  (A)\n// EUG - User does not have authorization to run RFC function module &A (A)\n// FU1 - FC function &B with dynamic destination &C was called in program &A (B)\nlet SelectedSystemRoles =  dynamic([\"Production\"]); //can also do// let SelectedSystemRoles =  dynamic([\"Production\", \"UAT\"]); dynamic([\"All System Roles\"])\nlet SelectedSystems = SAPSystems(SelectedSystemRoles= SelectedSystemRoles) | project SystemID= SearchKey;\n// here you can exclude system users which are OK to run obolete/ sensitive function modules\n// by adding those users in the SAP_User_Config watchlist with a tag of 'RunObsoleteFMOK'\nlet excludeUsersTags= dynamic(['RunObsoleteFMOK']);\nlet excludedUsers= _GetWatchlist('SAP_User_Config')| where Tags has_any (excludeUsersTags)| summarize by User2Exclude=SAPUser;\nlet AuditClassesA= dynamic(['DUR', 'DUS', 'DUT', 'EUE', 'EUF', 'EUG']);\nlet AuditClassesB= dynamic(['DUI', 'DUJ', 'DUK', 'FU1']);\nlet AuditClassesC= dynamic(['AUK', 'AUL']);\nlet ObsoleteModules =  _GetWatchlist('SAP - Obsolete Function Modules');\n// Maintain if watchlist is not available\nlet fixedModules = datatable(FunctionModule:string)['TH_SAPREL','TH_SAPREL2', 'TH_SAPREL3','SUSR_RFC_USER_INTERFACE','RFC_ABAP_INSTALL_AND_RUN'];\nlet UnitedModules =\ntoscalar(union fixedModules, ObsoleteModules\n| summarize FunctionModules =  make_set(FunctionModule));\n// Query logic\nlet FunctionRuns =\nSAPAuditLog\n| where MessageID in (array_concat(AuditClassesA, AuditClassesB, AuditClassesC))\n| join kind= inner SelectedSystems on SystemID\n| extend Module = case(MessageID in (AuditClassesA), Variable1, MessageID in (AuditClassesB), Variable2, MessageID in (AuditClassesC), Variable3, 'Could Not find function module')\n| where Module in (UnitedModules);\nFunctionRuns\n| project TimeGenerated, SystemID, ClientID, User, Email= iff(isempty(Email),User, Email), TerminalIPv6, Host= iff(isempty(Host), TerminalIPv6, Host), Module\n| extend UserName= User\n| join kind=leftantisemi excludedUsers on $left.User == $right.User2Exclude\n| extend AlertDescription= strcat('Sensitive Function Module ' , Module, ' was executed by ', UserName), Dummy=' '\n| extend PackedDetails= pack_all()\n| extend AlertRuleUniqueName = 'executionofanobsoleteoraninsecurefunctionmodule'\n",
                                "queryFrequency": "PT2H",
                                "queryPeriod": "PT2H",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                    {
                                        "connectorId": "SAP",
                                        "dataTypes": [
                                            "SAPAuditLog",
                                            "SAPSystems"
                                        ]
                                    }
                                ],
                                "tactics": [
                                    "Discovery",
                                    "CommandAndControl"
                                ],
                                "entityMappings": [
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Email"
                                            }
                                        ],
                                        "entityType": "Account"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Address",
                                                "columnName": "TerminalIPv6"
                                            }
                                        ],
                                        "entityType": "IP"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Host"
                                            }
                                        ],
                                        "entityType": "Host"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Name",
                                                "columnName": "SystemID"
                                            },
                                            {
                                                "identifier": "AppId",
                                                "columnName": "ClientID"
                                            }
                                        ],
                                        "entityType": "CloudApplication"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "ProcessId",
                                                "columnName": "Module"
                                            }
                                        ],
                                        "entityType": "Process"
                                    }
                                ],
                                "eventGroupingSettings": {
                                    "aggregationKind": "AlertPerResult"
                                },
                                "customDetails": {
                                    "AlertRuleUniqueName": "AlertRuleUniqueName",
                                    "SAP_User": "UserName"
                                },
                                "alertDetailsOverride": {
                                    "alertDescriptionFormat": "Identifies execution of an obsolete/insecure ABAP Function Module.\n\nSource Action: Execute an obsolete/insecure function module directly using SE37.\n\n**Recommended for Production only**\n\nObsolete functions should be maintained in \"SAP - Obsolete Function Modules\" Watchlist.\n{{PackedDetails}}\n",
                                    "alertTacticsColumnName": "Dummy",
                                    "alertDisplayNameFormat": "{{AlertDescription}}",
                                    "alertSeverityColumnName": "Dummy"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject33').analyticRuleId33,'/'))))]",
                            "properties": {
                                "description": "SAP Analytics Rule 33",
                                "parentId": "[variables('analyticRuleObject33').analyticRuleId33]",
                                "contentId": "[variables('analyticRuleObject33')._analyticRulecontentId33]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject33').analyticRuleVersion33]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SAP",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('analyticRuleObject33')._analyticRulecontentId33]",
                "contentKind": "AnalyticsRule",
                "displayName": "SAP - Execution of an Obsolete or an Insecure Function Module",
                "contentProductId": "[variables('analyticRuleObject33')._analyticRulecontentProductId33]",
                "id": "[variables('analyticRuleObject33')._analyticRulecontentProductId33]",
                "version": "[variables('analyticRuleObject33').analyticRuleVersion33]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('analyticRuleObject34').analyticRuleTemplateSpecName34]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP - Execution of an Obsolete or an Insecure Program_AnalyticalRules Analytics Rule with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('analyticRuleObject34').analyticRuleVersion34]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                            "name": "[variables('analyticRuleObject34')._analyticRulecontentId34]",
                            "apiVersion": "2022-04-01-preview",
                            "kind": "Scheduled",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "description": "Identifies execution of an obsolete insecure ABAP program.\nSource Action: Execute a program directly using SE38/SA38/SE80 or by using a background job.\n**Recommended for Production only**\nObsolete programs should be maintained in \"SAP - Obsolete Programs\" Watchlist\n*Data Sources: SAPcon -  Audit Log*",
                                "displayName": "SAP - Execution of an Obsolete or an Insecure Program",
                                "enabled": false,
                                "query": "// Execution of Obsolete/Insecure Program\n// Define Variables\nlet AuditClasses = dynamic(['AUW']); // Audit Log Classes - Report Started\nlet ObsoletePrograms = _GetWatchlist(\"SAP - Obsolete Programs\");\n// Maintain if watchlist is not available\nlet fixedObPrograms = datatable(ABAPProgram:string)['RSAU_READ_LOG'];\nlet UnitedPrograms =\ntoscalar(union fixedObPrograms, ObsoletePrograms\n| summarize Programs = make_set(ABAPProgram));\nlet SelectedSystemRoles =  dynamic([\"Production\"]); //can also do// let SelectedSystemRoles =  dynamic([\"Production\", \"UAT\"]); dynamic([\"All System Roles\"])\nlet SelectedSystems = SAPSystems(SelectedSystemRoles=SelectedSystemRoles) | project SystemID= SearchKey;\n// here you can exclude system users which are OK to run obsolete/ sensitive programs\n// by adding those users in the SAP_User_Config watchlist with a tag of 'RunObsoleteProgOK'\nlet excludeUsersTags= dynamic(['RunObsoleteProgOK']);\nlet excludedUsers= SAPUsersGetVIP(SearchForTags= dynamic([\"RunObsoleteProgOK\"]))| summarize by User2Exclude=SAPUser;\n// Query logic\nSAPAuditLog\n| where MessageID in (AuditClasses)\n| where ABAPProgramName in (UnitedPrograms) // The program is obsolete\n| join kind= inner  SelectedSystems on SystemID\n| join kind=leftantisemi excludedUsers on $left.User == $right.User2Exclude\n| project TimeGenerated, Instance,SystemID, ClientID, User, ABAPProgramName, MessageText, TransactionCode, MessageID\n, Email= iff(isempty(Email),User, Email), TerminalIPv6, Host= iff(isempty(Host), TerminalIPv6, Host)\n| extend AlertDescription= strcat('Obsolete/ Insecure Program ' , ABAPProgramName, ' was executed by ', User), Dummy=' '\n| extend PackedDetails= pack_all()\n| extend AlertRuleUniqueName = 'executionofanobsoleteoraninsecureprogram'\n",
                                "queryFrequency": "PT2H",
                                "queryPeriod": "PT2H",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                    {
                                        "connectorId": "SAP",
                                        "dataTypes": [
                                            "SAPAuditLog",
                                            "SAPSystems",
                                            "SAPUsersGetVIP"
                                        ]
                                    }
                                ],
                                "tactics": [
                                    "Discovery",
                                    "CommandAndControl"
                                ],
                                "entityMappings": [
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Email"
                                            }
                                        ],
                                        "entityType": "Account"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Address",
                                                "columnName": "TerminalIPv6"
                                            }
                                        ],
                                        "entityType": "IP"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Host"
                                            }
                                        ],
                                        "entityType": "Host"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Name",
                                                "columnName": "SystemID"
                                            },
                                            {
                                                "identifier": "AppId",
                                                "columnName": "ClientID"
                                            },
                                            {
                                                "identifier": "InstanceName",
                                                "columnName": "Instance"
                                            }
                                        ],
                                        "entityType": "CloudApplication"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "ProcessId",
                                                "columnName": "TransactionCode"
                                            },
                                            {
                                                "identifier": "CommandLine",
                                                "columnName": "ABAPProgramName"
                                            }
                                        ],
                                        "entityType": "Process"
                                    }
                                ],
                                "eventGroupingSettings": {
                                    "aggregationKind": "AlertPerResult"
                                },
                                "customDetails": {
                                    "AlertRuleUniqueName": "AlertRuleUniqueName",
                                    "SAP_User": "User"
                                },
                                "alertDetailsOverride": {
                                    "alertDescriptionFormat": "Identifies execution of an obsolete/insecure ABAP program.\nSource Action: Execute a program directly using SE38/SA38/SE80 or by using a background job.\n**Recommended for Production only**\nObsolete programs should be maintained in \"SAP - Obsolete Programs\" Watchlist\n*Data Sources: SAPcon -  Audit Log*\n{{PackedDetails}}\n",
                                    "alertTacticsColumnName": "Dummy",
                                    "alertDisplayNameFormat": "{{AlertDescription}}",
                                    "alertSeverityColumnName": "Dummy"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject34').analyticRuleId34,'/'))))]",
                            "properties": {
                                "description": "SAP Analytics Rule 34",
                                "parentId": "[variables('analyticRuleObject34').analyticRuleId34]",
                                "contentId": "[variables('analyticRuleObject34')._analyticRulecontentId34]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject34').analyticRuleVersion34]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SAP",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('analyticRuleObject34')._analyticRulecontentId34]",
                "contentKind": "AnalyticsRule",
                "displayName": "SAP - Execution of an Obsolete or an Insecure Program",
                "contentProductId": "[variables('analyticRuleObject34')._analyticRulecontentProductId34]",
                "id": "[variables('analyticRuleObject34')._analyticRulecontentProductId34]",
                "version": "[variables('analyticRuleObject34').analyticRuleVersion34]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('analyticRuleObject35').analyticRuleTemplateSpecName35]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP - FTP for non authorized servers_AnalyticalRules Analytics Rule with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('analyticRuleObject35').analyticRuleVersion35]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                            "name": "[variables('analyticRuleObject35')._analyticRulecontentId35]",
                            "apiVersion": "2022-04-01-preview",
                            "kind": "Scheduled",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "description": "Identifies FTP connection for non authorized server.\nMaintain new Watchlist, similar to SAPFTP_SERVERS\nSource Action: Create a new FTP connection e.g. by using Function Module FTP_CONNECT.\n\n*Data Sources: SAPcon -  Audit Log*",
                                "displayName": "SAP - FTP for non authorized servers",
                                "enabled": false,
                                "query": "// Define variables\nlet AuditClasses = dynamic(['DU8']); // Message of Successfull FTP Connection\nlet FTPSafeConnections = _GetWatchlist(\"SAP - FTP Servers\");\nlet fixedConnections = datatable(Client: string, Description: string,\nFTP_Server_Name: string, FTP_Server_Port: string)\n    // Maintain these if WatchList is not available\n    [100, \"description\", \"http://ourorgftpserver.com/\", 22]\n;\nlet UnitedConnections = toscalar(union kind=outer isfuzzy=true FTPSafeConnections, fixedConnections | summarize Connections = make_set(FTP_Server_Name));\n// Query logic\nSAPAuditLog\n| where MessageID in (AuditClasses)\n| extend TerminalIPv6 = Variable1\n| where TerminalIPv6 !in (UnitedConnections) // The IP is unknown\n| project TimeGenerated, Instance ,User, SystemID, ClientID, Email, TerminalIPv6, Host\n| extend AlertRuleUniqueName = 'ftpfornonauthorizedservers'\n",
                                "queryFrequency": "PT6H",
                                "queryPeriod": "PT6H",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                    {
                                        "connectorId": "SAP",
                                        "dataTypes": [
                                            "SAPAuditLog"
                                        ]
                                    }
                                ],
                                "tactics": [
                                    "Discovery",
                                    "InitialAccess",
                                    "CommandAndControl"
                                ],
                                "entityMappings": [
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Email"
                                            }
                                        ],
                                        "entityType": "Account"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Address",
                                                "columnName": "TerminalIPv6"
                                            }
                                        ],
                                        "entityType": "IP"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Host"
                                            }
                                        ],
                                        "entityType": "Host"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Name",
                                                "columnName": "SystemID"
                                            },
                                            {
                                                "identifier": "AppId",
                                                "columnName": "ClientID"
                                            },
                                            {
                                                "identifier": "InstanceName",
                                                "columnName": "Instance"
                                            }
                                        ],
                                        "entityType": "CloudApplication"
                                    }
                                ],
                                "eventGroupingSettings": {
                                    "aggregationKind": "SingleAlert"
                                },
                                "customDetails": {
                                    "AlertRuleUniqueName": "AlertRuleUniqueName",
                                    "SAP_User": "User"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject35').analyticRuleId35,'/'))))]",
                            "properties": {
                                "description": "SAP Analytics Rule 35",
                                "parentId": "[variables('analyticRuleObject35').analyticRuleId35]",
                                "contentId": "[variables('analyticRuleObject35')._analyticRulecontentId35]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject35').analyticRuleVersion35]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SAP",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('analyticRuleObject35')._analyticRulecontentId35]",
                "contentKind": "AnalyticsRule",
                "displayName": "SAP - FTP for non authorized servers",
                "contentProductId": "[variables('analyticRuleObject35')._analyticRulecontentProductId35]",
                "id": "[variables('analyticRuleObject35')._analyticRulecontentProductId35]",
                "version": "[variables('analyticRuleObject35').analyticRuleVersion35]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('analyticRuleObject36').analyticRuleTemplateSpecName36]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP - Function Module tested_AnalyticalRules Analytics Rule with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('analyticRuleObject36').analyticRuleVersion36]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                            "name": "[variables('analyticRuleObject36')._analyticRulecontentId36]",
                            "apiVersion": "2022-04-01-preview",
                            "kind": "Scheduled",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "description": "Identifies testing of a function module.\n\nSource Action: Test a function module using  SE37 / SE80.\n\n**Recommended for Production only**\n\n*Data Sources: SAPcon -  Audit Log*",
                                "displayName": "SAP - Function Module tested",
                                "enabled": false,
                                "query": "let Role = 'Production';\nlet ProgramName = 'RS_TESTFRAME_CALL';\nlet AuditClasses = dynamic(['AUW']); // Audit Log Classes - Report Started\nlet allSystemRoles = dynamic(['Sandbox', 'Developement', 'QualityAssurance', 'Training', 'Production']); // Available System Roles\nlet allSystemUsage = dynamic (['ERP', 'CRM', 'BW', 'Solman', 'Gateway', 'Enterprise Portal']); // Available System Usages\n// Get Relevant Systems from WatchList\nlet systemID = _GetWatchlist('SAP - Systems');\nlet fixedSID = datatable(SystemID: string, SystemRole: string, SystemUsage: string)\n    // Maintain these if WatchList is not available\n    [\"S4H\", \"Production\", \"ERP\",\n    \"XXX\", \"Sandbox\", \"BW\"]\n;\nlet UnitedSystem =\nunion systemID, fixedSID\n| summarize by SystemID, SystemRole, SystemUsage\n| where SystemRole == Role; // Reccommended is Production only\n//| where SystemRole in (allSystemRoles); // Use this for all system roles\nSAPAuditLog\n| where MessageID in (AuditClasses)\n| where ABAPProgramName == ProgramName\n| project-rename SystemIDTemp = SystemID\n| project-rename SystemID= SystemIDTemp\n| project-rename SystemID= SystemID\n| lookup kind = inner (UnitedSystem) on SystemID\n| order by TimeGenerated asc\n| project TimeGenerated, Instance ,User, SystemID, ClientID, MessageText, MessageID,\nEmail, TerminalIPv6, Host\n| extend AlertRuleUniqueName = 'functionmoduletested'\n",
                                "queryFrequency": "PT6H",
                                "queryPeriod": "PT6H",
                                "severity": "High",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                    {
                                        "connectorId": "SAP",
                                        "dataTypes": [
                                            "SAPAuditLog"
                                        ]
                                    }
                                ],
                                "tactics": [
                                    "Collection",
                                    "DefenseEvasion",
                                    "LateralMovement"
                                ],
                                "entityMappings": [
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Email"
                                            }
                                        ],
                                        "entityType": "Account"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Address",
                                                "columnName": "TerminalIPv6"
                                            }
                                        ],
                                        "entityType": "IP"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Host"
                                            }
                                        ],
                                        "entityType": "Host"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Name",
                                                "columnName": "SystemID"
                                            },
                                            {
                                                "identifier": "AppId",
                                                "columnName": "ClientID"
                                            },
                                            {
                                                "identifier": "InstanceName",
                                                "columnName": "Instance"
                                            }
                                        ],
                                        "entityType": "CloudApplication"
                                    }
                                ],
                                "eventGroupingSettings": {
                                    "aggregationKind": "AlertPerResult"
                                },
                                "customDetails": {
                                    "AlertRuleUniqueName": "AlertRuleUniqueName",
                                    "SAP_User": "User"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject36').analyticRuleId36,'/'))))]",
                            "properties": {
                                "description": "SAP Analytics Rule 36",
                                "parentId": "[variables('analyticRuleObject36').analyticRuleId36]",
                                "contentId": "[variables('analyticRuleObject36')._analyticRulecontentId36]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject36').analyticRuleVersion36]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SAP",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('analyticRuleObject36')._analyticRulecontentId36]",
                "contentKind": "AnalyticsRule",
                "displayName": "SAP - Function Module tested",
                "contentProductId": "[variables('analyticRuleObject36')._analyticRulecontentProductId36]",
                "id": "[variables('analyticRuleObject36')._analyticRulecontentProductId36]",
                "version": "[variables('analyticRuleObject36').analyticRuleVersion36]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('analyticRuleObject37').analyticRuleTemplateSpecName37]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP - Insecure FTP servers configuration_AnalyticalRules Analytics Rule with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('analyticRuleObject37').analyticRuleVersion37]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                            "name": "[variables('analyticRuleObject37')._analyticRulecontentId37]",
                            "apiVersion": "2022-04-01-preview",
                            "kind": "Scheduled",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "description": " Identifies Insecure FTP servers configuration - FTP Whitelist is empty / Contains Placeholders.\n\nSource Action: Do not maintain / maintain values which contains placeholders in table SAPFTP_SERVERS using maintenance view SAPFTP_SERVERS_V. (SM30)\n\n*Data Sources: SAPcon -  Audit Log*",
                                "displayName": "SAP - Insecure FTP servers configuration",
                                "enabled": false,
                                "query": "// Define variables\nlet AuditClasses = dynamic(['DU1', 'DU2']); // Messages of FTP Whitelist is empty / Contains Placeholders\n// Query logic\nSAPAuditLog\n| where MessageID in (AuditClasses)\n| project TimeGenerated, Instance, SystemID, ClientID, User, Email, TerminalIPv6, Host, Reason = MessageText\n| extend AlertRuleUniqueName = 'insecureftpserversconfiguration'\n",
                                "queryFrequency": "PT6H",
                                "queryPeriod": "PT6H",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                    {
                                        "connectorId": "SAP",
                                        "dataTypes": [
                                            "SAPAuditLog"
                                        ]
                                    }
                                ],
                                "tactics": [
                                    "InitialAccess",
                                    "CommandAndControl"
                                ],
                                "entityMappings": [
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Email"
                                            }
                                        ],
                                        "entityType": "Account"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Address",
                                                "columnName": "TerminalIPv6"
                                            }
                                        ],
                                        "entityType": "IP"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Host"
                                            }
                                        ],
                                        "entityType": "Host"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Name",
                                                "columnName": "SystemID"
                                            },
                                            {
                                                "identifier": "AppId",
                                                "columnName": "ClientID"
                                            },
                                            {
                                                "identifier": "InstanceName",
                                                "columnName": "Instance"
                                            }
                                        ],
                                        "entityType": "CloudApplication"
                                    }
                                ],
                                "eventGroupingSettings": {
                                    "aggregationKind": "SingleAlert"
                                },
                                "customDetails": {
                                    "AlertRuleUniqueName": "AlertRuleUniqueName",
                                    "SAP_User": "User"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject37').analyticRuleId37,'/'))))]",
                            "properties": {
                                "description": "SAP Analytics Rule 37",
                                "parentId": "[variables('analyticRuleObject37').analyticRuleId37]",
                                "contentId": "[variables('analyticRuleObject37')._analyticRulecontentId37]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject37').analyticRuleVersion37]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SAP",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('analyticRuleObject37')._analyticRulecontentId37]",
                "contentKind": "AnalyticsRule",
                "displayName": "SAP - Insecure FTP servers configuration",
                "contentProductId": "[variables('analyticRuleObject37')._analyticRulecontentProductId37]",
                "id": "[variables('analyticRuleObject37')._analyticRulecontentProductId37]",
                "version": "[variables('analyticRuleObject37').analyticRuleVersion37]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('analyticRuleObject38').analyticRuleTemplateSpecName38]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP - Lifecycle - SAP Notes were implemented in system_AnalyticalRules Analytics Rule with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('analyticRuleObject38').analyticRuleVersion38]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                            "name": "[variables('analyticRuleObject38')._analyticRulecontentId38]",
                            "apiVersion": "2022-04-01-preview",
                            "kind": "Scheduled",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "description": "Identifies SAP Notes implementation in the system.\n\nSource Action: Implement SAP Note using SNOTE/TCI.\n\n*Data Sources: SAPcon -  Change Requests*",
                                "displayName": "SAP - Lifecycle - SAP Notes were implemented in system",
                                "enabled": false,
                                "query": "// Define variables\nlet VarNote = \"NOTE\";\nlet AuditLogIn = dynamic(['AU1', 'AU5']); // Messages of connect with user\n// Query logic\nlet LastLogin =\nSAPAuditLog\n| where MessageID in (AuditLogIn)\n| summarize TimeGenerated = arg_max(TimeGenerated, *) by SystemID, ClientID, User; // Get last connection date for user\nSAPCRLog\n| where ObjectType == VarNote // Type is NOTE\n| lookup kind=inner LastLogin on $left.Owner == $right.User // Get last login details\n| summarize by TimeGenerated, Instance, SystemID, SystemNumber, ClientID, Owner, Request, Description, ObjectName, Category, Status, Email, TerminalIPv6, Host\n| extend AlertRuleUniqueName = 'lifecycle-sapnoteswereimplementedinsystem'\n",
                                "queryFrequency": "PT1H",
                                "queryPeriod": "PT1H",
                                "severity": "Informational",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                    {
                                        "connectorId": "SAP",
                                        "dataTypes": [
                                            "SAPAuditLog",
                                            "SAPCRLog"
                                        ]
                                    }
                                ],
                                "entityMappings": [
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Email"
                                            }
                                        ],
                                        "entityType": "Account"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Address",
                                                "columnName": "TerminalIPv6"
                                            }
                                        ],
                                        "entityType": "IP"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Host"
                                            }
                                        ],
                                        "entityType": "Host"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Name",
                                                "columnName": "SystemID"
                                            },
                                            {
                                                "identifier": "AppId",
                                                "columnName": "ClientID"
                                            },
                                            {
                                                "identifier": "InstanceName",
                                                "columnName": "Instance"
                                            }
                                        ],
                                        "entityType": "CloudApplication"
                                    }
                                ],
                                "eventGroupingSettings": {
                                    "aggregationKind": "SingleAlert"
                                },
                                "customDetails": {
                                    "AlertRuleUniqueName": "AlertRuleUniqueName",
                                    "SAP_User": "Owner"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject38').analyticRuleId38,'/'))))]",
                            "properties": {
                                "description": "SAP Analytics Rule 38",
                                "parentId": "[variables('analyticRuleObject38').analyticRuleId38]",
                                "contentId": "[variables('analyticRuleObject38')._analyticRulecontentId38]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject38').analyticRuleVersion38]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SAP",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('analyticRuleObject38')._analyticRulecontentId38]",
                "contentKind": "AnalyticsRule",
                "displayName": "SAP - Lifecycle - SAP Notes were implemented in system",
                "contentProductId": "[variables('analyticRuleObject38')._analyticRulecontentProductId38]",
                "id": "[variables('analyticRuleObject38')._analyticRulecontentProductId38]",
                "version": "[variables('analyticRuleObject38').analyticRuleVersion38]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('analyticRuleObject39').analyticRuleTemplateSpecName39]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP - Login from unexpected network_AnalyticalRules Analytics Rule with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('analyticRuleObject39').analyticRuleVersion39]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                            "name": "[variables('analyticRuleObject39')._analyticRulecontentId39]",
                            "apiVersion": "2022-04-01-preview",
                            "kind": "Scheduled",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "description": "Identifies logons from an unexpected network.\n\nSource Action: Logon to the backend system from an IP address which is not assigned to one of the netwroks.\n\nNetworks should be maintained in watchlist \"SAP - Networks\"\n\n*Data Sources: SAPcon -  Audit Log*",
                                "displayName": "SAP - Login from unexpected network",
                                "enabled": false,
                                "query": "let AuditClasses = dynamic(['AU1','AU5']); // Audit Log Classes - Dialog Logon Successful, RFC Logon Successful\n// Dialog / CPIC / RFC Int / RFC Ext / SRFC / User Switch / HTTP / Restore Session / API Call\nlet DialogLogonTypes = dynamic(['A', 'C', 'F', 'R', 'S', 'U', 'H', 'u', ' ']);\nlet Networks = _GetWatchlist('SAP - Networks');\nlet fixedNetworks = datatable(Network: string)['111.68.128.0/17']; // Maintain these if watchlist is not available\nlet allNetworks = union Networks, fixedNetworks\n    | summarize by Network;\nSAPAuditLog\n// Add audit classes\n| where MessageID in (AuditClasses)\n| where Variable1 in (DialogLogonTypes) // Is a dialog logon type from the list\n| where isnotempty(TerminalIPv6) // There is a Ipv6 address\n// if you wish to allow all private adreesses\n| where not (ipv4_is_private(TerminalIPv6 ))\n| evaluate ipv4_lookup(allNetworks, TerminalIPv6, Network, return_unmatched = true)\n// Similar to regular lookup, by ipv4 address, unmatched is like left join\n| where isempty(Network) // Network is not familiar\n// Details\n| project TimeGenerated, SystemID, ClientID, User, TransactionCode, MessageText, Email , TerminalIPv6, Host\n| extend AlertRuleUniqueName = 'loginfromunexpectednetwork'\n",
                                "queryFrequency": "PT1H",
                                "queryPeriod": "PT1H",
                                "severity": "High",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                    {
                                        "connectorId": "SAP",
                                        "dataTypes": [
                                            "SAPAuditLog"
                                        ]
                                    }
                                ],
                                "tactics": [
                                    "InitialAccess"
                                ],
                                "entityMappings": [
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Email"
                                            }
                                        ],
                                        "entityType": "Account"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Address",
                                                "columnName": "TerminalIPv6"
                                            }
                                        ],
                                        "entityType": "IP"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Host"
                                            }
                                        ],
                                        "entityType": "Host"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Name",
                                                "columnName": "SystemID"
                                            },
                                            {
                                                "identifier": "AppId",
                                                "columnName": "ClientID"
                                            }
                                        ],
                                        "entityType": "CloudApplication"
                                    }
                                ],
                                "eventGroupingSettings": {
                                    "aggregationKind": "SingleAlert"
                                },
                                "customDetails": {
                                    "AlertRuleUniqueName": "AlertRuleUniqueName",
                                    "SAP_User": "User"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject39').analyticRuleId39,'/'))))]",
                            "properties": {
                                "description": "SAP Analytics Rule 39",
                                "parentId": "[variables('analyticRuleObject39').analyticRuleId39]",
                                "contentId": "[variables('analyticRuleObject39')._analyticRulecontentId39]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject39').analyticRuleVersion39]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SAP",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('analyticRuleObject39')._analyticRulecontentId39]",
                "contentKind": "AnalyticsRule",
                "displayName": "SAP - Login from unexpected network",
                "contentProductId": "[variables('analyticRuleObject39')._analyticRulecontentProductId39]",
                "id": "[variables('analyticRuleObject39')._analyticRulecontentProductId39]",
                "version": "[variables('analyticRuleObject39').analyticRuleVersion39]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('analyticRuleObject40').analyticRuleTemplateSpecName40]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP - Missing configuration in the Dynamic Security Audit Log Monitor_AnalyticalRules Analytics Rule with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('analyticRuleObject40').analyticRuleVersion40]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                            "name": "[variables('analyticRuleObject40')._analyticRulecontentId40]",
                            "apiVersion": "2022-04-01-preview",
                            "kind": "Scheduled",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "description": "An SAP audit log event has occurred bearing a message ID which was not maintained in the SAP_Dynamic_Audit_Log_Monitor_Configuration watchlist.\nThe SAP_Dynamic_Audit_Log_Monitor_Configuration watchlist allows for dynamically alerting on SAP audit log events.\nRecommended solution - go to the SAP_Dynamic_Audit_Log_Monitor_Configuration and add the missing SAP audit log message ID.  Specify a severity level of medium or high to have this message ID covered by the alerts based on rule \"Dynamic Security Audit Log Monitor\".",
                                "displayName": "SAP - Missing configuration in the Dynamic Security Audit Log Monitor",
                                "enabled": false,
                                "query": "let MissingMessagesinSystems = SAPAuditLog\n| summarize LastSeenMessageOn = arg_max(TimeGenerated, MessageID) by MessageID, SystemID, ClientID\n| join kind = leftanti (SAPAuditLogConfiguration(SelectedSeverities =  dynamic([\"All Severities\"])) | summarize by MessageID) on MessageID\n| project-keep LastSeenMessageOn, MessageID, SystemID, ClientID\n| project-rename MissingMessageID = MessageID, ComingFromSystemID = SystemID\n| extend Dummy = 1;\nlet MissingSummary = MissingMessagesinSystems\n| summarize\n  ComingFromSystemIDs =  make_set(ComingFromSystemID)\n, MissingMessageIDs = make_set(MissingMessageID)\n| extend ComingFromSystemIDs = iff(array_length(ComingFromSystemIDs) > 1, strcat('Systems ', strcat_array(ComingFromSystemIDs,\", \")), strcat('System ',strcat_array(ComingFromSystemIDs,\", \")))\n| extend MissingMessageIDs = iff(array_length(MissingMessageIDs) > 1, strcat('Message IDs ', strcat_array(MissingMessageIDs,\", \"), \" have occured in \"), strcat('Message ID ',strcat_array(MissingMessageIDs,\", \"), \" has occured in \"))\n| extend Dummy = 1;\nMissingMessagesinSystems | join kind= inner MissingSummary on Dummy\n| project-away Dummy, Dummy1\n| extend AlertRuleUniqueName = 'missingconfigurationinthedynamicsecurityauditlogmonitor'\n",
                                "queryFrequency": "P1D",
                                "queryPeriod": "P1D",
                                "severity": "Informational",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                    {
                                        "connectorId": "SAP",
                                        "dataTypes": [
                                            "SAPAuditLog",
                                            "SAPAuditLogConfiguration"
                                        ]
                                    }
                                ],
                                "entityMappings": [
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Name",
                                                "columnName": "ComingFromSystemID"
                                            },
                                            {
                                                "identifier": "AppId",
                                                "columnName": "ClientID"
                                            }
                                        ],
                                        "entityType": "CloudApplication"
                                    }
                                ],
                                "eventGroupingSettings": {
                                    "aggregationKind": "SingleAlert"
                                },
                                "customDetails": {
                                    "SAPAuditLogMessageID": "MissingMessageID",
                                    "AlertRuleUniqueName": "AlertRuleUniqueName"
                                },
                                "alertDetailsOverride": {
                                    "alertDescriptionFormat": "An SAP audit log event with {{MissingMessageIDs}}{{ComingFromSystemIDs}}, for which a configuration in the SAPAuditLogConfigurator watchlist could not be found.</br>\nThe SAPAuditLogConfigurator watchlist allows for dynamically alerting on SAP audit log events. </br>\nRecommended solution - go to the SAPAuditLogConfigurator and add the missing SAP audit log message ID.\nSpecify a severity level of medium or high to have this message ID covered by the alerts based on rule \"SAP - Dynamic Alerts for Configured Audit Log Events\".\n\n",
                                    "alertTacticsColumnName": "ClientID",
                                    "alertDisplayNameFormat": "SAP - Missing configuration for SAP's audit log, {{ComingFromSystemIDs}}",
                                    "alertSeverityColumnName": "ClientID"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject40').analyticRuleId40,'/'))))]",
                            "properties": {
                                "description": "SAP Analytics Rule 40",
                                "parentId": "[variables('analyticRuleObject40').analyticRuleId40]",
                                "contentId": "[variables('analyticRuleObject40')._analyticRulecontentId40]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject40').analyticRuleVersion40]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SAP",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('analyticRuleObject40')._analyticRulecontentId40]",
                "contentKind": "AnalyticsRule",
                "displayName": "SAP - Missing configuration in the Dynamic Security Audit Log Monitor",
                "contentProductId": "[variables('analyticRuleObject40')._analyticRulecontentProductId40]",
                "id": "[variables('analyticRuleObject40')._analyticRulecontentProductId40]",
                "version": "[variables('analyticRuleObject40').analyticRuleVersion40]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('analyticRuleObject41').analyticRuleTemplateSpecName41]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP - Multiple Files Download_AnalyticalRules Analytics Rule with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('analyticRuleObject41').analyticRuleVersion41]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                            "name": "[variables('analyticRuleObject41')._analyticRulecontentId41]",
                            "apiVersion": "2022-04-01-preview",
                            "kind": "Scheduled",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "description": "Identifies multiple files downloads for a user within a specific timerange.\n\nSource Action: Download multiple files while using SAPGui to Excel/Lists etc.\n\n*Data Sources: SAPcon -  Audit Log*",
                                "displayName": "SAP - Multiple Files Download",
                                "enabled": false,
                                "query": "// Define variables\nlet NumberOfDownloads = 10; // Number of downloads of user as threshold\nlet HoursBucket = 2h; // How much time between buckets\nlet AuditClasses = dynamic([\"AUY\"]); // Relevant message\n// Query logic\nSAPAuditLog // Get all downloads\n| where MessageID in (AuditClasses)\n| summarize DownloadsByUser = count() by bin(TimeGenerated, HoursBucket), SystemID, ClientID, User, TerminalIPv6, Email, Host\n| where DownloadsByUser >= NumberOfDownloads // User downloaded more than threshold\n| project SystemID, ClientID, User, Email, TerminalIPv6, Host,DownloadsByUser\n| extend AlertRuleUniqueName = 'multiplefilesdownload'\n",
                                "queryFrequency": "PT12H",
                                "queryPeriod": "PT12H",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                    {
                                        "connectorId": "SAP",
                                        "dataTypes": [
                                            "SAPAuditLog"
                                        ]
                                    }
                                ],
                                "tactics": [
                                    "Collection",
                                    "Exfiltration",
                                    "CredentialAccess"
                                ],
                                "entityMappings": [
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Email"
                                            }
                                        ],
                                        "entityType": "Account"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Address",
                                                "columnName": "TerminalIPv6"
                                            }
                                        ],
                                        "entityType": "IP"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Host"
                                            }
                                        ],
                                        "entityType": "Host"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Name",
                                                "columnName": "SystemID"
                                            },
                                            {
                                                "identifier": "AppId",
                                                "columnName": "ClientID"
                                            }
                                        ],
                                        "entityType": "CloudApplication"
                                    }
                                ],
                                "eventGroupingSettings": {
                                    "aggregationKind": "AlertPerResult"
                                },
                                "customDetails": {
                                    "AlertRuleUniqueName": "AlertRuleUniqueName",
                                    "SAP_User": "User"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject41').analyticRuleId41,'/'))))]",
                            "properties": {
                                "description": "SAP Analytics Rule 41",
                                "parentId": "[variables('analyticRuleObject41').analyticRuleId41]",
                                "contentId": "[variables('analyticRuleObject41')._analyticRulecontentId41]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject41').analyticRuleVersion41]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SAP",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('analyticRuleObject41')._analyticRulecontentId41]",
                "contentKind": "AnalyticsRule",
                "displayName": "SAP - Multiple Files Download",
                "contentProductId": "[variables('analyticRuleObject41')._analyticRulecontentProductId41]",
                "id": "[variables('analyticRuleObject41')._analyticRulecontentProductId41]",
                "version": "[variables('analyticRuleObject41').analyticRuleVersion41]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('analyticRuleObject42').analyticRuleTemplateSpecName42]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP - Multiple Logons by IP_AnalyticalRules Analytics Rule with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('analyticRuleObject42').analyticRuleVersion42]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                            "name": "[variables('analyticRuleObject42')._analyticRulecontentId42]",
                            "apiVersion": "2022-04-01-preview",
                            "kind": "Scheduled",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "description": "Identifies logon of several users from same IP within scheduled time interval.\n\nSource Action: Logon using several users thorugh the same IP.\nNetworks can be excluded from this alert by specifying ranges in the 'SAP - Excluded Networks' watchlist.\nThis rule alerts on \"empty\" IP addresses as well- Add an entry with serachkey= 000.00.000.0 and Description= EmptyIPAddressesShouldBeExcluded in the 'SAP - Excluded Networks' watchlist to avoid alerting on empty IP addresses\n*Data Sources: SAPcon -  Audit Log*",
                                "displayName": "SAP - Multiple Logons by IP",
                                "enabled": false,
                                "query": "// SAP - Medium - Multiple Logons by IP\n// CONFIGURATION OPTION- determine which system roles are relevant for this alert\nlet TimeAgo= 75m;\nlet SelectedSystemRoles =  dynamic([\"All System Roles\"]); //can also do// let SelectedSystemRoles =  dynamic([\"Production\", \"UAT\"]);\nlet SelectedSystems = SAPSystems(SelectedSystemRoles= SelectedSystemRoles)\n    | project SystemID= SearchKey, SystemRole, SystemUsage\n    | extend SystemRole= replace_string(SystemRole, 'Unknown (Production)', 'Unknown');\n// here you can exclude system users which are OK to share IP addresses\n// by adding those users in the SAP_User_Config watchlist with a tag of 'MultipleLogonsOK'\n// can also specify SAP Roles or Profiles to exclude\nlet excludeUsersTags= dynamic(['MultipleLogonsOK', 'SAP_ALL']);\nlet excludedUsers= SAPUsersGetVIP(SearchForTags= excludeUsersTags)\n    | summarize by User2Exclude=SAPUser;\n// CONFIG OPTION - include users by types ([\"A\", \"Dialog\", \"B\", \"System\", \"C\", \"Communications Data\", \"L\", \"Reference (Logon not possible)\", \"S\", \"Service\"])\nlet UsersTypeToInclude= dynamic([\"A\"]);// Dialog Only\n// CONFIG OPTION - exclude users by user classes\nlet UserClassesToExclude= dynamic([\"RFC\", \"BATCH\"]);\nlet UserInFocus= (SAP_USR02\n| where CLASS !in (UserClassesToExclude)\n// | where USTYP in (UsersTypeToInclude)\n| summarize arg_max(TimeGenerated, *) by GLTGB, SystemID, User=BNAME, ClientID= MANDT, UserType=USTYP\n| summarize arg_max(GLTGB, CLASS) by SystemID, User, ClientID, UserType);\nlet AuditClasses = dynamic(['AU1', 'AU5']); // Audit Log Classes - Dialog Logon Successful, RFC Logon Successful\nlet DialogLogonTypes = dynamic(['A', 'C', 'F', 'R', 'S', 'U', 'H', 'u', ' ']); // Dialog / CPIC / RFC Int / RFC Ext / SRFC / User Switch / HTTP / Restore Session / API Call\nlet excNetworks = materialize(_GetWatchlist('SAP - Excluded Networks')); // Networks that should be removed from query\n// add an entry with serachkey= 000.00.000.0 and Description= EmptyIPAddressesShouldBeExcluded in the 'SAP - Excluded Networks' watchlist\n// to avoid alerting on empty IP addresses\nlet EmptyIPAddressesShouldBeExcluded = toscalar(excNetworks\n    | where Description == 'EmptyIPAddressesShouldBeExcluded'\n    | summarize Count =count()\n    | project IfEmptyIPAddressesShouldBeExcluded = iff(Count > 0, true, false));\nlet fixedNetworks =\n    datatable(Network: string) [\n    \"255.68.255.0/32\", \"\"];\nlet UnitedNetworks = union excNetworks, fixedNetworks\n    | summarize by Network\n    | where isnotempty(Network)\n    | extend DummyJoinField= 1;\nlet UsersPerIP = 1;\n// Query logic\nSAPAuditLog\n| where TimeGenerated > ago(TimeAgo + 1h)\n| where ingestion_time() > ago(TimeAgo)\n| where SystemID in (SelectedSystems)\n// rule only cares for audit records with IP addresses\n| where isnotempty(TerminalIPv6) or EmptyIPAddressesShouldBeExcluded == false\n// exclude users by type/ class\n| join kind= inner UserInFocus on SystemID, ClientID, User\n//comment the next line if private IP addresses are relevant\n| where not (ipv4_is_private(TerminalIPv6 ))\n| where MessageID in (AuditClasses)\n| where Variable1 in (DialogLogonTypes)\n| join kind=leftantisemi excludedUsers on $left.User == $right.User2Exclude\n| extend DummyJoinField= 1\n| join kind= inner UnitedNetworks on DummyJoinField\n// check if IP is in one of the ranges of the watchlist\n| extend IPIsInRange= ipv4_is_in_range(TerminalIPv6, Network)\n| extend UserandEmail = pack(\"ID\", User, \"Email\", Email)\n// count cases in which an IP address shows in any of the ranges in the watchlist\n| summarize CountUsers = dcount(strcat(User, \"_&_\", Email)), Users = make_set(UserandEmail), StartTime = min(TimeGenerated), EndTime = max(TimeGenerated)\n    , IPIsInRange= countif(IPIsInRange)\n    by SystemID, ClientID, TerminalIPv6\n// filter out matches of IPs and excluded networks\n| where IPIsInRange == 0\n| where CountUsers > UsersPerIP\n| mv-expand Users\n| evaluate bag_unpack(Users, \"User_\")\n| project SystemID, ClientID, TerminalIPv6, StartTime, EndTime,\n    User = column_ifexists(\"User_ID\", \"\"),\n    Email = column_ifexists(\"User_Email\", \"\")\n| extend Email= iff(isempty(Email), User, Email)\n| lookup UserInFocus on User, SystemID, ClientID\n| extend AlertRuleUniqueName = 'multiplelogonsbyip'\n",
                                "queryFrequency": "PT1H",
                                "queryPeriod": "PT1H",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                    {
                                        "connectorId": "SAP",
                                        "dataTypes": [
                                            "SAP_USR02",
                                            "SAPAuditLog",
                                            "SAPSystems",
                                            "SAPUsersGetVIP"
                                        ]
                                    }
                                ],
                                "tactics": [
                                    "InitialAccess"
                                ],
                                "entityMappings": [
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Email"
                                            }
                                        ],
                                        "entityType": "Account"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Address",
                                                "columnName": "TerminalIPv6"
                                            }
                                        ],
                                        "entityType": "IP"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Name",
                                                "columnName": "SystemID"
                                            },
                                            {
                                                "identifier": "AppId",
                                                "columnName": "ClientID"
                                            }
                                        ],
                                        "entityType": "CloudApplication"
                                    }
                                ],
                                "eventGroupingSettings": {
                                    "aggregationKind": "AlertPerResult"
                                },
                                "customDetails": {
                                    "AlertRuleUniqueName": "AlertRuleUniqueName",
                                    "SAP_User": "User"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject42').analyticRuleId42,'/'))))]",
                            "properties": {
                                "description": "SAP Analytics Rule 42",
                                "parentId": "[variables('analyticRuleObject42').analyticRuleId42]",
                                "contentId": "[variables('analyticRuleObject42')._analyticRulecontentId42]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject42').analyticRuleVersion42]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SAP",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('analyticRuleObject42')._analyticRulecontentId42]",
                "contentKind": "AnalyticsRule",
                "displayName": "SAP - Multiple Logons by IP",
                "contentProductId": "[variables('analyticRuleObject42')._analyticRulecontentProductId42]",
                "id": "[variables('analyticRuleObject42')._analyticRulecontentProductId42]",
                "version": "[variables('analyticRuleObject42').analyticRuleVersion42]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('analyticRuleObject43').analyticRuleTemplateSpecName43]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP - Multiple Password Changes_AnalyticalRules Analytics Rule with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('analyticRuleObject43').analyticRuleVersion43]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                            "name": "[variables('analyticRuleObject43')._analyticRulecontentId43]",
                            "apiVersion": "2022-04-01-preview",
                            "kind": "Scheduled",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "description": "Identifies multiple password changes at different levels:\n1. Users across systems\n2. Per user performing the password change\n3. Per user who's password is being changed\n\nSource Action: Change user password",
                                "displayName": "SAP - Multiple Password Changes",
                                "enabled": false,
                                "query": "// Multiple Password Changes by User\n// !!!IMPORTANT!!!\n// please make sure \"Lookup data from the last\" parameter is greater than a full user master data update cycle\n// this is critical so we can infer the changed user AD account ID\n// actual lookback period is maintained by the TimeAgo parameter\nlet TimeAgo= 3h;\nlet SelectedSystemRoles =  dynamic([\"Production\"]); //can also do// let SelectedSystemRoles =  dynamic([\"Production\", \"UAT\"]); dynamic([\"All System Roles\"])\nlet SelectedSystems = SAPSystems(SelectedSystemRoles=SelectedSystemRoles) | project SystemID= SearchKey;\n// here you can exclude system users which are OK to perform multiple password changes\n// by adding those users in the SAP_User_Config watchlist with a tag of 'UpdateMultiPassOK'\nlet excludeUsersTags= dynamic(['UpdateMultiPassOK']);\nlet excludedUsers= _GetWatchlist('SAP_User_Config')| where Tags has_any (excludeUsersTags)| summarize by User2Exclude=SAPUser;\nlet PasswordChanges = materialize(SAPAuditLog\n| where TimeGenerated > ago(1d)\n| where ingestion_time() > ago(TimeAgo)\n| where MessageID == \"BU2\" // Audit Log Classes - Password Changed\n| join kind= inner  SelectedSystems on SystemID\n| join kind=leftantisemi excludedUsers on $left.User == $right.User2Exclude\n| extend UserReset= Variable2\n| extend Email= iff(isempty(Email), User, Email)\n| extend Host= iff(isempty(Host), TerminalIPv6, Host)\n| summarize Count= count(), Email =any(Email), Host=any(Host), StartTime = min(TimeGenerated), EndTime = max(TimeGenerated)  by User, UserReset, TerminalIPv6, ClientID, SystemID) ;\nlet PerUserSysClient = 3; // Systems & Clients per User\nlet TPerUserSysClient= PasswordChanges\n| extend DetailsBy = pack(\"SystemID\", SystemID, \"ClientID\", ClientID, 'UserChanging', User, 'Email', Email)\n| summarize CountPerUserSysClient = dcount(strcat(SystemID, ClientID)), User= any(User), StartTime = min(StartTime), EndTime = max(EndTime), Details = make_set(DetailsBy, 10)\nby UserReset\n| where  CountPerUserSysClient>= PerUserSysClient\n| where isnotempty(UserReset)\n| extend AlertDescription= strcat('User\\'s ',UserReset, ' password was reset across ', CountPerUserSysClient, ' systems '), Source= 'PerUserSysClient';\nlet PerUserChanged = 3;  // password changes across all systems and scenarios\nlet TPerUserChanged = PasswordChanges\n| extend DetailsBy = pack(\"SystemID\", SystemID, \"ClientID\", ClientID, 'UserChanging', User, 'Email', Email)\n| summarize CountPerUserChanged = sum(Count), User= any(User), StartTime = min(StartTime), EndTime = max(EndTime) , Details = make_set(DetailsBy, 10)\nby UserReset\n| where  CountPerUserChanged >= PerUserChanged\n| extend AlertDescription= strcat('User\\'s ',UserReset, ' password was reset ', CountPerUserChanged, ' times', ' by user ', User), Source= 'PerUserChanged';\nlet PerUserChanging = 3; // user changing across all systems\nlet TPerUserChanging = PasswordChanges\n| extend DetailsBy = pack(\"SystemID\", SystemID, \"ClientID\", ClientID, 'UserReset', UserReset)\n| summarize CountPerUserChanging = sum(Count), StartTime = min(StartTime), EndTime = max(EndTime), Details = make_set(DetailsBy, 10), ResetUsers= make_set(UserReset, 10)\n, Email= anyif(Email, isnotempty(Email)), TerminalIPv6= anyif(TerminalIPv6, isnotempty(TerminalIPv6))\nby User\n| where  CountPerUserChanging >= PerUserChanging\n| extend AlertDescription= strcat('User ',User, ' has changed passwords ', CountPerUserChanging, ' times to user ', tostring(ResetUsers)), Source= 'PerUserChanging';\n TPerUserSysClient | union TPerUserChanged, TPerUserChanging\n| extend Dummy=' ', PackedDetails= pack_all()\n| mv-expand Details\n| evaluate bag_unpack(Details, \"Details_\") // Unpack the details to a couple of fields\n| project\n    StartTime, EndTime, User, TerminalIPv6, AlertDescription\n    , Count= CountPerUserSysClient + CountPerUserChanged + CountPerUserChanging, PackedDetails,\n    SystemID = column_ifexists(\"Details_SystemID\", \"\"),\n    ClientID = column_ifexists(\"Details_ClientID\", \"\"),\n    UserReset= strcat(column_ifexists(\"Details_UserReset\", \"\"), column_ifexists(\"UserReset\", \"\") ),\n    Email= strcat(column_ifexists(\"Details_Email\", \"\"), column_ifexists(\"Email\", \"\") )\n | join kind= leftouter  (SAPUsersEmail | project SystemID, ClientID, UserReset= User, EmailReset= Email) on UserReset, SystemID, ClientID\n | extend EmailReset= iff(isempty(EmailReset), UserReset, EmailReset), Dummy= ''\n | project-away ClientID1, SystemID1, UserReset1\n",
                                "queryFrequency": "PT3H",
                                "queryPeriod": "P7D",
                                "severity": "Low",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                    {
                                        "connectorId": "SAP",
                                        "dataTypes": [
                                            "SAPAuditLog",
                                            "SAPSystems",
                                            "SAPUsersEmail"
                                        ]
                                    }
                                ],
                                "tactics": [
                                    "CredentialAccess"
                                ],
                                "entityMappings": [
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Email"
                                            }
                                        ],
                                        "entityType": "Account"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Address",
                                                "columnName": "TerminalIPv6"
                                            }
                                        ],
                                        "entityType": "IP"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Name",
                                                "columnName": "SystemID"
                                            },
                                            {
                                                "identifier": "AppId",
                                                "columnName": "ClientID"
                                            }
                                        ],
                                        "entityType": "CloudApplication"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "EmailReset"
                                            }
                                        ],
                                        "entityType": "Account"
                                    }
                                ],
                                "eventGroupingSettings": {
                                    "aggregationKind": "AlertPerResult"
                                },
                                "customDetails": {
                                    "UserReset": "UserReset",
                                    "SAP_User": "User"
                                },
                                "alertDetailsOverride": {
                                    "alertDescriptionFormat": "Identifies multiple password changes at different levels:\n1. Users across systems\n2. Per user performing the password change\n3. Per user who's password is being changed\n\nSource Action: Change user password\n\n{{PackedDetails}}\n",
                                    "alertTacticsColumnName": "Dummy",
                                    "alertDisplayNameFormat": "{{AlertDescription}}",
                                    "alertSeverityColumnName": "Dummy"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject43').analyticRuleId43,'/'))))]",
                            "properties": {
                                "description": "SAP Analytics Rule 43",
                                "parentId": "[variables('analyticRuleObject43').analyticRuleId43]",
                                "contentId": "[variables('analyticRuleObject43')._analyticRulecontentId43]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject43').analyticRuleVersion43]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SAP",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('analyticRuleObject43')._analyticRulecontentId43]",
                "contentKind": "AnalyticsRule",
                "displayName": "SAP - Multiple Password Changes",
                "contentProductId": "[variables('analyticRuleObject43')._analyticRulecontentProductId43]",
                "id": "[variables('analyticRuleObject43')._analyticRulecontentProductId43]",
                "version": "[variables('analyticRuleObject43').analyticRuleVersion43]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('analyticRuleObject44').analyticRuleTemplateSpecName44]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP - Multiple Spool Executions_AnalyticalRules Analytics Rule with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('analyticRuleObject44').analyticRuleVersion44]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                            "name": "[variables('analyticRuleObject44')._analyticRulecontentId44]",
                            "apiVersion": "2022-04-01-preview",
                            "kind": "Scheduled",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "description": "Identifies multiple spools for a user within a specific timerange.\n\nSource Action: Create and execute multiple Spool Jobs from any type by a user. (SP01)\n\n*Data Sources: SAPcon -  Spool Log*",
                                "displayName": "SAP - Multiple Spool Executions",
                                "enabled": false,
                                "query": "// Define variables\nlet AuditLogIn = dynamic(['AU1', 'AU5']); // Messages of connect with user\nlet NumberOfRequests = 3; // Number of requests as threshold\nlet HoursBucket = 2h; // // How much time between buckets\n// Query logic\nlet LastLogin =\nSAPAuditLog\n| where MessageID in (AuditLogIn)\n| summarize TimeGenerated = arg_max(TimeGenerated, *) by SystemID, ClientID, User, Instance; // Get last connection date for user\nSAPSpoolLog // Get all spool requests\n| summarize UserRequests = count() by bin(TimeGenerated, HoursBucket), SystemID, ClientID, User, Instance\n| where UserRequests >= NumberOfRequests // User requested to print more than threshold\n| lookup kind=inner LastLogin on User // Check IP of last login\n| project TimeGenerated, Instance, SystemID, ClientID, User, Email, TerminalIPv6, Host, UserRequests\n| extend AlertRuleUniqueName = 'multiplespoolexecutions'\n",
                                "queryFrequency": "PT12H",
                                "queryPeriod": "PT12H",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                    {
                                        "connectorId": "SAP",
                                        "dataTypes": [
                                            "SAPAuditLog",
                                            "SAPSpoolLog"
                                        ]
                                    }
                                ],
                                "tactics": [
                                    "CredentialAccess",
                                    "Collection",
                                    "Exfiltration"
                                ],
                                "entityMappings": [
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Email"
                                            }
                                        ],
                                        "entityType": "Account"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Address",
                                                "columnName": "TerminalIPv6"
                                            }
                                        ],
                                        "entityType": "IP"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Host"
                                            }
                                        ],
                                        "entityType": "Host"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Name",
                                                "columnName": "SystemID"
                                            },
                                            {
                                                "identifier": "AppId",
                                                "columnName": "ClientID"
                                            },
                                            {
                                                "identifier": "InstanceName",
                                                "columnName": "Instance"
                                            }
                                        ],
                                        "entityType": "CloudApplication"
                                    }
                                ],
                                "eventGroupingSettings": {
                                    "aggregationKind": "SingleAlert"
                                },
                                "customDetails": {
                                    "AlertRuleUniqueName": "AlertRuleUniqueName",
                                    "SAP_User": "User"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject44').analyticRuleId44,'/'))))]",
                            "properties": {
                                "description": "SAP Analytics Rule 44",
                                "parentId": "[variables('analyticRuleObject44').analyticRuleId44]",
                                "contentId": "[variables('analyticRuleObject44')._analyticRulecontentId44]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject44').analyticRuleVersion44]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SAP",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('analyticRuleObject44')._analyticRulecontentId44]",
                "contentKind": "AnalyticsRule",
                "displayName": "SAP - Multiple Spool Executions",
                "contentProductId": "[variables('analyticRuleObject44')._analyticRulecontentProductId44]",
                "id": "[variables('analyticRuleObject44')._analyticRulecontentProductId44]",
                "version": "[variables('analyticRuleObject44').analyticRuleVersion44]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('analyticRuleObject45').analyticRuleTemplateSpecName45]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP - Multiple Spool Output Executions_AnalyticalRules Analytics Rule with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('analyticRuleObject45').analyticRuleVersion45]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                            "name": "[variables('analyticRuleObject45')._analyticRulecontentId45]",
                            "apiVersion": "2022-04-01-preview",
                            "kind": "Scheduled",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "description": "Identifies multiple spools for a user within a specific timerange.\n\nSource Action: Create and execute multiple Spool Jobs from any type by a user. (SP01)\n\n*Data Sources: SAPcon -  Spool Log*",
                                "displayName": "SAP - Multiple Spool Output Executions",
                                "enabled": false,
                                "query": "// Define variables\nlet AuditLogIn = dynamic(['AU1', 'AU5']); // Messeges of connect with user\nlet NumberOfPrints = 3; // Number of prints as threshold\nlet HoursBucket = 2h; // // How much time between buckets\n// Query logic\nlet LastLogin =\nSAPAuditLog\n| where MessageID in (AuditLogIn)\n| summarize arg_max(TimeGenerated, *) by SystemID, ClientID, User, Instance; // Get last connection date for user\nSAPSpoolOutputLog // Get all spool outputs\n| summarize UserPrints = count() by bin(TimeGenerated, HoursBucket), SystemID, ClientID, User, Instance\n| where UserPrints >= NumberOfPrints // User requested to print more than threshold\n| lookup kind=inner LastLogin on User // Get IP of last login\n| project TimeGenerated, Instance, SystemID, ClientID, User, Email, TerminalIPv6,  Host, UserPrints\n| extend AlertRuleUniqueName = 'multiplespooloutputexecutions'\n",
                                "queryFrequency": "PT12H",
                                "queryPeriod": "PT12H",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                    {
                                        "connectorId": "SAP",
                                        "dataTypes": [
                                            "SAPAuditLog",
                                            "SAPSpoolOutputLog"
                                        ]
                                    }
                                ],
                                "tactics": [
                                    "CredentialAccess",
                                    "Collection",
                                    "Exfiltration"
                                ],
                                "entityMappings": [
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Email"
                                            }
                                        ],
                                        "entityType": "Account"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Host"
                                            }
                                        ],
                                        "entityType": "Host"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Address",
                                                "columnName": "TerminalIPv6"
                                            }
                                        ],
                                        "entityType": "IP"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Name",
                                                "columnName": "SystemID"
                                            },
                                            {
                                                "identifier": "AppId",
                                                "columnName": "ClientID"
                                            },
                                            {
                                                "identifier": "InstanceName",
                                                "columnName": "Instance"
                                            }
                                        ],
                                        "entityType": "CloudApplication"
                                    }
                                ],
                                "eventGroupingSettings": {
                                    "aggregationKind": "SingleAlert"
                                },
                                "customDetails": {
                                    "AlertRuleUniqueName": "AlertRuleUniqueName",
                                    "SAP_User": "User"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject45').analyticRuleId45,'/'))))]",
                            "properties": {
                                "description": "SAP Analytics Rule 45",
                                "parentId": "[variables('analyticRuleObject45').analyticRuleId45]",
                                "contentId": "[variables('analyticRuleObject45')._analyticRulecontentId45]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject45').analyticRuleVersion45]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SAP",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('analyticRuleObject45')._analyticRulecontentId45]",
                "contentKind": "AnalyticsRule",
                "displayName": "SAP - Multiple Spool Output Executions",
                "contentProductId": "[variables('analyticRuleObject45')._analyticRulecontentProductId45]",
                "id": "[variables('analyticRuleObject45')._analyticRulecontentProductId45]",
                "version": "[variables('analyticRuleObject45').analyticRuleVersion45]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('analyticRuleObject46').analyticRuleTemplateSpecName46]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP - Multiple Subnets by User_AnalyticalRules Analytics Rule with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('analyticRuleObject46').analyticRuleVersion46]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                            "name": "[variables('analyticRuleObject46')._analyticRulecontentId46]",
                            "apiVersion": "2022-04-01-preview",
                            "kind": "Scheduled",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "description": "Identifies logon of the same user from several subnets within scheduled time interval.\nMultiple configuration options available within the query.\n\nSource Action: Logon using the same user thorugh different IP's.\n\n*Data Sources: SAPcon -  Audit Log*",
                                "displayName": "SAP - Multiple Subnets by User",
                                "enabled": false,
                                "query": "// SAP - Multiple Subnets by User (previously named as SAP - Multiple Logons by User)\n// !!!IMPORTANT!!!\n// please make sure \"Lookup data from the last\" parameter is greater than a full user master data update cycle\n// please keep \"Lookup data from the last\" to be 7 days to allow coverage of user master data required\n// actual lookback is set by setting TimeAgo\n// Define variables\n// CONFIG OPTION time ago is same as lookback\nlet TimeAgo= 1h;\n// CONFIG OPTION Mask is a number between 0 and 32 representing sensitivity to network changes\n// Mask= 32 means '192.168.1.255' and '192.168.1.254' are different addresses.\n// Mask= 24 means '255.255.255.0' and '255.255.255.255' are considered as same address.\nlet Mask= 24;\nlet AuditClasses = dynamic(['AU1', 'AU5']); // Logon successful, RFC/CPIC logon successful\n// CONFIG OPTION - include users by types ([\"A\", \"Dialog\", \"B\", \"System\", \"C\", \"Communications Data\", \"L\", \"Reference (Logon not possible)\", \"S\", \"Service\"])\nlet UsersTypeToInclude= dynamic([\"A\"]);// Dialog Only\n// CONFIG OPTION - exclude users by user classes\nlet UserClassesToExclude= dynamic([\"SYSTEM\"]);\nlet UserInFocus= (SAP_USR02\n| where CLASS !in (UserClassesToExclude)\n| where USTYP in (UsersTypeToInclude)\n| summarize arg_max(TimeGenerated, *) by GLTGB, SystemID, User=BNAME, ClientID= MANDT, UserType=USTYP\n| summarize arg_max(GLTGB, *) by SystemID, User, ClientID, UserType);\n// Dialog / CPIC / RFC Int / RFC Ext / SRFC / User Switch / HTTP / Restore Session / API Call\nlet DialogLogonTypes = dynamic(['A', 'C', 'F', 'R', 'S', 'U', 'H', 'u', ' ']);\nlet excUsers = _GetWatchlist('SAP - Excluded Users'); // Users that should be removed from query\nlet fixedExcUsers = datatable(User: string) [\"SYSWF\"];\n// CONFIG OPTION- exclude user by SAP roles, profiles or tags\n// here you can exclude system users which are OK to logon from multiple IPs\n// by adding those users in the SAP_User_Config watchlist with a tag of 'MultipleIPsOK'\n// can also specify SAP Roles or Profiles to exclude\nlet excludeUsersTags= dynamic(['MultipleIPsOK', \"SAPRole1\", \"SAPProfile1\"]);\nlet excludedUsers= SAPUsersGetVIP(SearchForTags= excludeUsersTags)| summarize by User2Exclude=SAPUser;\nlet UnitedExcUsers =\n    toscalar(union excUsers, fixedExcUsers\n    | summarize Users = make_set(User));\n// CONFIG OPTION- set the threshold of the number of unique IP addresses per user\nlet IPThreshold = 1;\n// CONFIG OPTION- exclude networks (or ranges) using the watchlist\nlet ExcNetworks = toscalar(_GetWatchlist('SAP - Excluded Networks') // Networks that should be removed from query\n| where isnotempty(Network)\n| summarize make_set(Network));\n// CONFIG OPTION- exclude blank IP addresses\n// add an entry with serachkey= 000.00.000.0 and Description= EmptyIPAddressesShouldBeExcluded in the 'SAP - Excluded Networks' watchlist\n// to avoid alerting on empty IP addresses\nlet EmptyIPAddressesShouldBeExcluded = toscalar(_GetWatchlist('SAP - Excluded Networks')\n| where Description == 'EmptyIPAddressesShouldBeExcluded' and SearchKey == \"000.00.000.0\" | take 1\n| project IfEmptyIPAddressesShouldBeExcluded = true);\n// Query Logic\nlet LogOns= materialize(SAPAuditLog\n| where TimeGenerated > ago(1d)\n// actual lookback is set by setting TimeAgo\n| where ingestion_time() > ago(TimeAgo)\n| where MessageID in (AuditClasses)\n| where isnotempty(TerminalIPv6) or  EmptyIPAddressesShouldBeExcluded != true\n| where ipv4_is_in_any_range(TerminalIPv6, ExcNetworks) == false\n| where Variable1 in (DialogLogonTypes)\n| where User !in (UnitedExcUsers)\n| join kind=leftantisemi excludedUsers on $left.User == $right.User2Exclude\n| join kind= inner UserInFocus on SystemID, ClientID, User\n| summarize LogonCount= count(), StartTime = min(TimeGenerated), UserType= any(UserType)\n    ,EndTime = max(TimeGenerated), Email= any(Email), Instance= any(Instance), Host= any(Host) by SystemID, ClientID, User, TerminalIPv6) ;\n// aggregate the number of subnets (not IP addresses) by user\nlet UsersWithTooManySubnets= LogOns\n| extend MaskedIP= format_ipv4_mask(TerminalIPv6, Mask)\n| summarize CountSubnets= dcount(MaskedIP) by User\n| where CountSubnets > IPThreshold;\nUsersWithTooManySubnets | join kind = inner LogOns on User\n| project SystemID, ClientID, User, StartTime, EndTime, Email, TerminalIPv6, Instance, LogonCount, Host, CountSubnets, UserType\n| extend PackedDetails= pack_all()\n| extend AlertName= strcat('SAP - User ',User, ' has logged on from ', CountSubnets, ' different subnets'), Dummy= ''\n| extend AlertRuleUniqueName = 'multiplesubnetsbyuser'\n",
                                "queryFrequency": "PT1H",
                                "queryPeriod": "P7D",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                    {
                                        "connectorId": "SAP",
                                        "dataTypes": [
                                            "SAP_USR02",
                                            "SAPAuditLog",
                                            "SAPUsersGetVIP"
                                        ]
                                    }
                                ],
                                "tactics": [
                                    "CredentialAccess",
                                    "InitialAccess",
                                    "Collection"
                                ],
                                "entityMappings": [
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Email"
                                            }
                                        ],
                                        "entityType": "Account"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Address",
                                                "columnName": "TerminalIPv6"
                                            }
                                        ],
                                        "entityType": "IP"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Name",
                                                "columnName": "SystemID"
                                            },
                                            {
                                                "identifier": "AppId",
                                                "columnName": "ClientID"
                                            },
                                            {
                                                "identifier": "InstanceName",
                                                "columnName": "Instance"
                                            }
                                        ],
                                        "entityType": "CloudApplication"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "HostName",
                                                "columnName": "Host"
                                            }
                                        ],
                                        "entityType": "Host"
                                    }
                                ],
                                "eventGroupingSettings": {
                                    "aggregationKind": "AlertPerResult"
                                },
                                "customDetails": {
                                    "AlertRuleUniqueName": "AlertRuleUniqueName",
                                    "SAP_User": "User"
                                },
                                "alertDetailsOverride": {
                                    "alertDescriptionFormat": "Multipls subnets obsereved for user {{User}}.\n{{PackedDetails}}\n",
                                    "alertTacticsColumnName": "Dummy",
                                    "alertDisplayNameFormat": "{{AlertName}}",
                                    "alertSeverityColumnName": "Dummy"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject46').analyticRuleId46,'/'))))]",
                            "properties": {
                                "description": "SAP Analytics Rule 46",
                                "parentId": "[variables('analyticRuleObject46').analyticRuleId46]",
                                "contentId": "[variables('analyticRuleObject46')._analyticRulecontentId46]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject46').analyticRuleVersion46]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SAP",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('analyticRuleObject46')._analyticRulecontentId46]",
                "contentKind": "AnalyticsRule",
                "displayName": "SAP - Multiple Subnets by User",
                "contentProductId": "[variables('analyticRuleObject46')._analyticRulecontentProductId46]",
                "id": "[variables('analyticRuleObject46')._analyticRulecontentProductId46]",
                "version": "[variables('analyticRuleObject46').analyticRuleVersion46]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('analyticRuleObject47').analyticRuleTemplateSpecName47]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP - New ICF Service Handlers_AnalyticalRules Analytics Rule with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('analyticRuleObject47').analyticRuleVersion47]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                            "name": "[variables('analyticRuleObject47')._analyticRulecontentId47]",
                            "apiVersion": "2022-04-01-preview",
                            "kind": "Scheduled",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "description": "Identifies creation of ICF Handlers.\nSource Action: Assign a new handler to a service using SICF.\n*Data Sources: SAPcon - Table Data Log*",
                                "displayName": "SAP - New ICF Service Handlers",
                                "enabled": false,
                                "query": "// New ICF Service Handlers\nlet TimeAgo= 2h;\nSAPTableDataLog\n| where TimeGenerated > TimeAgo\n| where TableName == \"ICFHANDLER\"\n| where TableField == \"ICF_NAME\" // Service name\n| where OldValue == \"\" and NewValue != \"\" // New value is inserted in name -> new service\n| order by TimeGenerated desc\n| project-rename Service = NewValue\n| lookup SAPUsersHeader() on SystemID, $left.UserName== $right.User\n| extend TerminalIPv6= iff(isnotempty( LastKnownIP), LastKnownIP, PrimaryIP)\n| project TimeGenerated, Service, PrimaryIP, PrimaryEmail, KnownIPs, KnownEmails, LastKnownIP, User= UserName, Host, SystemID, Client, Instance\n| extend Dummy= ''\n| extend AlertRuleUniqueName = 'newicfservicehandlers'\n",
                                "queryFrequency": "PT2H",
                                "queryPeriod": "PT2H",
                                "severity": "High",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                    {
                                        "connectorId": "SAP",
                                        "dataTypes": [
                                            "SAPTableDataLog",
                                            "SAPUsersHeader"
                                        ]
                                    }
                                ],
                                "tactics": [
                                    "Persistence",
                                    "LateralMovement",
                                    "CommandAndControl"
                                ],
                                "entityMappings": [
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "PrimaryEmail"
                                            }
                                        ],
                                        "entityType": "Account"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Name",
                                                "columnName": "SystemID"
                                            },
                                            {
                                                "identifier": "AppId",
                                                "columnName": "Client"
                                            },
                                            {
                                                "identifier": "InstanceName",
                                                "columnName": "Instance"
                                            }
                                        ],
                                        "entityType": "CloudApplication"
                                    }
                                ],
                                "eventGroupingSettings": {
                                    "aggregationKind": "SingleAlert"
                                },
                                "customDetails": {
                                    "AlertRuleUniqueName": "AlertRuleUniqueName",
                                    "SAP_User": "User"
                                },
                                "alertDetailsOverride": {
                                    "alertDescriptionFormat": "Identifies creation of ICF Handlers.\nSource Action: Assign a new handler to a service using SICF.\n*Data Sources: SAPcon - Table Data Log*\n",
                                    "alertTacticsColumnName": "Dummy",
                                    "alertDisplayNameFormat": "SAP - High - New Handlers for  ICF Service {{Service}} created by {{User}} in System {{SystemID}}",
                                    "alertSeverityColumnName": "Dummy"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject47').analyticRuleId47,'/'))))]",
                            "properties": {
                                "description": "SAP Analytics Rule 47",
                                "parentId": "[variables('analyticRuleObject47').analyticRuleId47]",
                                "contentId": "[variables('analyticRuleObject47')._analyticRulecontentId47]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject47').analyticRuleVersion47]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SAP",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('analyticRuleObject47')._analyticRulecontentId47]",
                "contentKind": "AnalyticsRule",
                "displayName": "SAP - New ICF Service Handlers",
                "contentProductId": "[variables('analyticRuleObject47')._analyticRulecontentProductId47]",
                "id": "[variables('analyticRuleObject47')._analyticRulecontentProductId47]",
                "version": "[variables('analyticRuleObject47').analyticRuleVersion47]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('analyticRuleObject48').analyticRuleTemplateSpecName48]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP - New ICF Services_AnalyticalRules Analytics Rule with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('analyticRuleObject48').analyticRuleVersion48]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                            "name": "[variables('analyticRuleObject48')._analyticRulecontentId48]",
                            "apiVersion": "2022-04-01-preview",
                            "kind": "Scheduled",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "description": "Identifies creation of ICF Services.\nSource Action: Create a service using SICF.\n*Data Sources: SAPcon - Table Data Log*",
                                "displayName": "SAP - New ICF Services",
                                "enabled": false,
                                "query": "// New ICF Services\nlet TimeAgo= 2h;\nSAPTableDataLog\n| where TableName == \"ICFSERVLOC\"\n| where TimeGenerated > TimeAgo\n| where TableField == \"ICF_NAME\" // Service name\n| where OldValue == \"\" and NewValue != \"\" // New value is inserted in name -> new service\n| order by TimeGenerated desc\n| lookup SAPUsersHeader() on SystemID, $left.UserName== $right.User\n| extend TerminalIPv6= iff(isnotempty( LastKnownIP), LastKnownIP, PrimaryIP)\n| project TimeGenerated, Service = NewValue, PrimaryIP, PrimaryEmail, KnownIPs, KnownEmails, LastKnownIP, User= UserName, Host, SystemID, Client, Instance\n| extend Dummy= ''\n| extend AlertRuleUniqueName = 'newicfservices'\n",
                                "queryFrequency": "PT2H",
                                "queryPeriod": "P2D",
                                "severity": "High",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                    {
                                        "connectorId": "SAP",
                                        "dataTypes": [
                                            "SAPTableDataLog",
                                            "SAPUsersHeader"
                                        ]
                                    }
                                ],
                                "tactics": [
                                    "CommandAndControl",
                                    "Persistence",
                                    "LateralMovement"
                                ],
                                "entityMappings": [
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "PrimaryEmail"
                                            }
                                        ],
                                        "entityType": "Account"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Name",
                                                "columnName": "SystemID"
                                            },
                                            {
                                                "identifier": "AppId",
                                                "columnName": "Client"
                                            },
                                            {
                                                "identifier": "InstanceName",
                                                "columnName": "Instance"
                                            }
                                        ],
                                        "entityType": "CloudApplication"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Address",
                                                "columnName": "LastKnownIP"
                                            }
                                        ],
                                        "entityType": "IP"
                                    }
                                ],
                                "eventGroupingSettings": {
                                    "aggregationKind": "SingleAlert"
                                },
                                "customDetails": {
                                    "AlertRuleUniqueName": "AlertRuleUniqueName",
                                    "SAP_User": "User"
                                },
                                "alertDetailsOverride": {
                                    "alertDescriptionFormat": "Identifies creation of ICF Services.\nSource Action: Create a service using SICF.\n*Data Sources: SAPcon - Table Data Log*\n",
                                    "alertTacticsColumnName": "Dummy",
                                    "alertDisplayNameFormat": "(Preview) SAP - High - New ICF Services created by {{User}} in system {{SystemID}}",
                                    "alertSeverityColumnName": "Dummy"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject48').analyticRuleId48,'/'))))]",
                            "properties": {
                                "description": "SAP Analytics Rule 48",
                                "parentId": "[variables('analyticRuleObject48').analyticRuleId48]",
                                "contentId": "[variables('analyticRuleObject48')._analyticRulecontentId48]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject48').analyticRuleVersion48]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SAP",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('analyticRuleObject48')._analyticRulecontentId48]",
                "contentKind": "AnalyticsRule",
                "displayName": "SAP - New ICF Services",
                "contentProductId": "[variables('analyticRuleObject48')._analyticRulecontentProductId48]",
                "id": "[variables('analyticRuleObject48')._analyticRulecontentProductId48]",
                "version": "[variables('analyticRuleObject48').analyticRuleVersion48]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('analyticRuleObject49').analyticRuleTemplateSpecName49]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP - SPNego Attack_AnalyticalRules Analytics Rule with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('analyticRuleObject49').analyticRuleVersion49]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                            "name": "[variables('analyticRuleObject49')._analyticRulecontentId49]",
                            "apiVersion": "2022-04-01-preview",
                            "kind": "Scheduled",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "description": "Identifies SPNego Replay Attack.\n\n*Data Sources: SAPcon -  Audit Log*",
                                "displayName": "SAP - SPNego Attack",
                                "enabled": false,
                                "query": "// Define variables\nlet AuditClasses = dynamic(['BUI']); // Message of SPNego\n// Query logic\nSAPAuditLog\n| where MessageID in (AuditClasses)\n| project TimeGenerated, Instance , SystemID, ClientID, User ,  Email, TerminalIPv6, Host\n| extend AlertRuleUniqueName = 'spnegoattack'\n",
                                "queryFrequency": "PT1H",
                                "queryPeriod": "PT1H",
                                "severity": "High",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                    {
                                        "connectorId": "SAP",
                                        "dataTypes": [
                                            "SAPAuditLog"
                                        ]
                                    }
                                ],
                                "tactics": [
                                    "Impact",
                                    "LateralMovement"
                                ],
                                "entityMappings": [
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Email"
                                            }
                                        ],
                                        "entityType": "Account"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Address",
                                                "columnName": "TerminalIPv6"
                                            }
                                        ],
                                        "entityType": "IP"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Host"
                                            }
                                        ],
                                        "entityType": "Host"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Name",
                                                "columnName": "SystemID"
                                            },
                                            {
                                                "identifier": "AppId",
                                                "columnName": "ClientID"
                                            },
                                            {
                                                "identifier": "InstanceName",
                                                "columnName": "Instance"
                                            }
                                        ],
                                        "entityType": "CloudApplication"
                                    }
                                ],
                                "eventGroupingSettings": {
                                    "aggregationKind": "SingleAlert"
                                },
                                "customDetails": {
                                    "AlertRuleUniqueName": "AlertRuleUniqueName",
                                    "SAP_User": "User"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject49').analyticRuleId49,'/'))))]",
                            "properties": {
                                "description": "SAP Analytics Rule 49",
                                "parentId": "[variables('analyticRuleObject49').analyticRuleId49]",
                                "contentId": "[variables('analyticRuleObject49')._analyticRulecontentId49]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject49').analyticRuleVersion49]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SAP",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('analyticRuleObject49')._analyticRulecontentId49]",
                "contentKind": "AnalyticsRule",
                "displayName": "SAP - SPNego Attack",
                "contentProductId": "[variables('analyticRuleObject49')._analyticRulecontentProductId49]",
                "id": "[variables('analyticRuleObject49')._analyticRulecontentProductId49]",
                "version": "[variables('analyticRuleObject49').analyticRuleVersion49]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('analyticRuleObject50').analyticRuleTemplateSpecName50]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP - Security Audit Log Configuration Change_AnalyticalRules Analytics Rule with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('analyticRuleObject50').analyticRuleVersion50]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                            "name": "[variables('analyticRuleObject50')._analyticRulecontentId50]",
                            "apiVersion": "2022-04-01-preview",
                            "kind": "Scheduled",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "description": "Identifies changes for configuration in the Security Audit Log\n\nSource Action: change any dynamic Security Audit Log Configuration using SM19/RSAU_CONFIG.(Filters/Status/Recording mode etc..).\n\n*Data Sources: SAPcon -  Audit Log*",
                                "displayName": "SAP - Security Audit Log Configuration Change",
                                "enabled": false,
                                "query": "// SAP - Security Audit Log Configuration Change\n// !!!IMPORTANT!!!\n// please make sure \"Lookup data from the last\" parameter is greater than a full user master data update cycle\n// please keep \"Lookup data from the last\" to be 7 days to allow coverage of user master data required\n// actual lookback is set by setting TimeAgo\nlet TimeAgo= 75m;\n// Audit Log Classes - Audit Log Configuration Events\n// determine which system roles are relevant for this alert\nlet SelectedSystemRoles =  dynamic([\"Production\", \"UAT\"]); //can also do// let SelectedSystemRoles =  dynamic([\"All System Roles\"]);\nlet SelectedSystems = SAPSystems(SelectedSystemRoles= SelectedSystemRoles)\n    | project SystemID= SearchKey, SystemRole, SystemUsage;\n// here you can exclude system users which are OK to execute a configuration change\n// by adding those users in the SAP_User_Config watchlist with a tag of 'AuditLogConfigOK'\n// can also specify SAP Roles or Profiles to exclude\nlet excludeUsersTags= dynamic(['AuditLogConfigOK','SAP_ALL']);\nlet excludedUsers= SAPUsersGetVIP(SearchForTags= excludeUsersTags)| summarize by User2Exclude=SAPUser;\nlet AuditClasses = dynamic(['AUE', 'AUF', 'AUI', 'AUJ', 'FU0', 'E05', 'AUG']); // Relevant messages\n// gather all audit log configuration changes\nlet ConfigChanges= materialize(SAPAuditLog\n| where TimeGenerated > ago(TimeAgo)\n| where MessageID in (AuditClasses)\n| where SystemID in ((SelectedSystems | project SystemID))\n| join kind=leftantisemi excludedUsers on $left.User == $right.User2Exclude\n| project TimeGenerated, Instance, SystemID, User, MessageText, Email, TerminalIPv6, Host, MessageID, UpdatedOn_t);\nlet SystemRestarts= ConfigChanges | where MessageID == \"AUG\"\n| distinct SystemID, Instance, Host, UpdatedOn_t;\nConfigChanges\n// disregard changes that got applied when system restarted\n| join kind =leftanti SystemRestarts on SystemID, Instance, Host, UpdatedOn_t\n| lookup (SelectedSystems | project SystemID, SystemRole) on SystemID\n| summarize FirstChangedOn=min(UpdatedOn_t), LastChangedOn=max(UpdatedOn_t), Events=make_set(MessageText), SystemRole=any(SystemRole) by SystemID, User, Email, TerminalIPv6, BinTime= bin(UpdatedOn_t,1h), Host, Instance\n| extend AlertName= strcat(\"SAP audit log configuration change detected in a \", tolower(SystemRole),\" system\")\n| extend Dummy= \"\"\n| extend AlertRuleUniqueName = 'securityauditlogconfigurationchange'\n",
                                "queryFrequency": "PT1H",
                                "queryPeriod": "P7D",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                    {
                                        "connectorId": "SAP",
                                        "dataTypes": [
                                            "SAPAuditLog",
                                            "SAPSystems",
                                            "SAPUsersGetVIP"
                                        ]
                                    }
                                ],
                                "tactics": [
                                    "Persistence",
                                    "Exfiltration",
                                    "DefenseEvasion"
                                ],
                                "entityMappings": [
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Address",
                                                "columnName": "TerminalIPv6"
                                            }
                                        ],
                                        "entityType": "IP"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Email"
                                            }
                                        ],
                                        "entityType": "Account"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Host"
                                            }
                                        ],
                                        "entityType": "Host"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Name",
                                                "columnName": "SystemID"
                                            },
                                            {
                                                "identifier": "InstanceName",
                                                "columnName": "Instance"
                                            }
                                        ],
                                        "entityType": "CloudApplication"
                                    }
                                ],
                                "eventGroupingSettings": {
                                    "aggregationKind": "AlertPerResult"
                                },
                                "customDetails": {
                                    "AlertRuleUniqueName": "AlertRuleUniqueName",
                                    "SAP_User": "User"
                                },
                                "alertDetailsOverride": {
                                    "alertDescriptionFormat": "Identifies changes for configuration in the Security Audit Log\n\nSource Action: change any dynamic Security Audit Log Configuration using SM19/RSAU_CONFIG.(Filters/Status/Recording mode etc..).\n\n*Data Sources: SAPcon -  Audit Log*\n",
                                    "alertTacticsColumnName": "Dummy",
                                    "alertDisplayNameFormat": "{{AlertName}}",
                                    "alertSeverityColumnName": "Dummy"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject50').analyticRuleId50,'/'))))]",
                            "properties": {
                                "description": "SAP Analytics Rule 50",
                                "parentId": "[variables('analyticRuleObject50').analyticRuleId50]",
                                "contentId": "[variables('analyticRuleObject50')._analyticRulecontentId50]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject50').analyticRuleVersion50]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SAP",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('analyticRuleObject50')._analyticRulecontentId50]",
                "contentKind": "AnalyticsRule",
                "displayName": "SAP - Security Audit Log Configuration Change",
                "contentProductId": "[variables('analyticRuleObject50')._analyticRulecontentProductId50]",
                "id": "[variables('analyticRuleObject50')._analyticRulecontentProductId50]",
                "version": "[variables('analyticRuleObject50').analyticRuleVersion50]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('analyticRuleObject51').analyticRuleTemplateSpecName51]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP - Sensitive Privileged User Logged in_AnalyticalRules Analytics Rule with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('analyticRuleObject51').analyticRuleVersion51]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                            "name": "[variables('analyticRuleObject51')._analyticRulecontentId51]",
                            "apiVersion": "2022-04-01-preview",
                            "kind": "Scheduled",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "description": "Identifies Dialog logon of a sensitive privileged user.\nSource Action: Logon to the backend system using SAP* or anoter privileged user.\n\nPriveleged users should be maintained in \"SAP - Privileged Users\" Watchlist\n\nThis rule requires a fresh full reload of the SAP user master data to be performed daily.\n*Data Sources: SAPcon -  Audit Log*\n*Data Sources: SAPcon -  User MD*",
                                "displayName": "SAP - Sensitive Privileged User Logged in",
                                "enabled": false,
                                "query": "// SAP - Sensitive Privileged User Logged in\n// !!!IMPORTANT!!!\n// please make sure \"Lookup data from the last\" parameter is greater than a full user master data update cycle\n// please keep \"Lookup data from the last\" to be 7 days to allow coverage of user master data required\n// actual lookback is set by setting TimeAgo\n// time span for audit events\nlet AuditTimeAgo= 75m;\nlet SelectedSystemRoles =  dynamic([\"Production\"]); //can also do// let SelectedSystemRoles =  dynamic([\"Production\", \"UAT\"]); dynamic([\"All System Roles\"])\nlet SelectedSystems = SAPSystems(SelectedSystemRoles= SelectedSystemRoles) | project SystemID= SearchKey, SystemRole;\n// here you can exclude system users which are OK to execute a Sensitive Transaction Code\n// by adding those users in the SAP_User_Config watchlist with a tag of 'SensitiveLogOnOK'\n// can also specify SAP Roles or Profiles to exclude\nlet excludeUsersTags= dynamic(['SensitiveLogOnOK']);// dynamic(['SensitiveLogOnOK','SAP_ALL']);\nlet excludedUsers= SAPUsersGetVIP(SearchForTags= excludeUsersTags)| summarize by User2Exclude=SAPUser;\n// Audit Log Classes - Dialog Logon Successful\nlet AuditClassesSuccess = dynamic(['AU1']);\nlet AuditClassesFail = dynamic(['AU2']);\nlet LogonTypes = dynamic(['A','H', 'R', 'S']); // Dialog / HTTP\nlet DataTypes = materialize(SAPGetDataTypes());\n// Query logic\nSAPAuditLog\n| where TimeGenerated > ago(AuditTimeAgo)\n| join kind= inner SelectedSystems on SystemID\n| join kind=leftantisemi excludedUsers on $left.User == $right.User2Exclude\n| where (MessageID in (AuditClassesSuccess) and Variable1 in (LogonTypes)) or // Success login\nMessageID in (AuditClassesFail)\n|join kind = inner (SAPUsersGetPrivileged())\non $left.ClientID == $right.Client\n, $left.SystemID == $right.SystemID\n, $left.User == $right.User\n| project-rename LogonTypeKey = Variable1, ReasonKey= Variable2, LogonMethodKey= Variable3\n| lookup (DataTypes | where DataType == \"LogonFailureCause\"| project Key, LogonFailureCause= Value) on $left.ReasonKey == $right.Key\n| lookup (DataTypes | where DataType == \"LogonType\"| project Key, LogonType= Value) on $left.LogonTypeKey == $right.Key\n| lookup (DataTypes | where DataType == \"LogonMethod\"| project Key, LogonMethod= Value) on $left.LogonMethodKey == $right.Key\n| project TimeGenerated, Instance ,SystemID, ClientID, LogonType, User, MessageText,\nEmail, TerminalIPv6, Host, SystemRole, LogonFailureCause, LogonMethod, MessageID\n| extend PackedDetails= pack_all()\n| extend AlertName= strcat(\"SAP - Privileged User \", User, iff(MessageID==\"AU1\",\" Has Logged into a \", \" Has Failed to Log into a \"), SystemRole, \" System\" )\n| extend AlertDescription= strcat(\" LogonType: \", LogonType, \". LogonFailureCause: \", LogonFailureCause, \". LogonMethod: \", LogonMethod), Dummy= ''\n| extend AlertRuleUniqueName = 'sensitiveprivilegeduserloggedin'\n",
                                "queryFrequency": "PT1H",
                                "queryPeriod": "P7D",
                                "severity": "High",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                    {
                                        "connectorId": "SAP",
                                        "dataTypes": [
                                            "SAPAuditLog",
                                            "SAPGetDataTypes",
                                            "SAPSystems",
                                            "SAPUsersGetPrivileged",
                                            "SAPUsersGetVIP"
                                        ]
                                    }
                                ],
                                "tactics": [
                                    "InitialAccess",
                                    "CredentialAccess"
                                ],
                                "entityMappings": [
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Email"
                                            }
                                        ],
                                        "entityType": "Account"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Address",
                                                "columnName": "TerminalIPv6"
                                            }
                                        ],
                                        "entityType": "IP"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Host"
                                            }
                                        ],
                                        "entityType": "Host"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Name",
                                                "columnName": "SystemID"
                                            },
                                            {
                                                "identifier": "AppId",
                                                "columnName": "ClientID"
                                            },
                                            {
                                                "identifier": "InstanceName",
                                                "columnName": "Instance"
                                            }
                                        ],
                                        "entityType": "CloudApplication"
                                    }
                                ],
                                "eventGroupingSettings": {
                                    "aggregationKind": "AlertPerResult"
                                },
                                "customDetails": {
                                    "PackedDetails": "PackedDetails",
                                    "SAP_User": "User",
                                    "ClientID": "ClientID",
                                    "LogonType": "LogonType",
                                    "AlertRuleUniqueName": "AlertRuleUniqueName",
                                    "LogonMethod": "LogonMethod",
                                    "LogonFailureCause": "LogonFailureCause"
                                },
                                "alertDetailsOverride": {
                                    "alertDescriptionFormat": "{{AlertDescription}}\nIdentifies Dialog logon of a sensitive privileged user.\nSource Action: Logon to the backend system using SAP* or anoter privileged user.\nPriveleged users should be maintained in \"SAP - Privileged Users\" Watchlist\nThis rule requires a fresh full reload of the SAP user master data to be performed daily.\n*Data Sources: SAPcon -  Audit Log*\n*Data Sources: SAPcon -  User MD*\n",
                                    "alertTacticsColumnName": "Dummy",
                                    "alertDisplayNameFormat": "{{AlertName}}",
                                    "alertSeverityColumnName": "Dummy"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject51').analyticRuleId51,'/'))))]",
                            "properties": {
                                "description": "SAP Analytics Rule 51",
                                "parentId": "[variables('analyticRuleObject51').analyticRuleId51]",
                                "contentId": "[variables('analyticRuleObject51')._analyticRulecontentId51]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject51').analyticRuleVersion51]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SAP",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('analyticRuleObject51')._analyticRulecontentId51]",
                "contentKind": "AnalyticsRule",
                "displayName": "SAP - Sensitive Privileged User Logged in",
                "contentProductId": "[variables('analyticRuleObject51')._analyticRulecontentProductId51]",
                "id": "[variables('analyticRuleObject51')._analyticRulecontentProductId51]",
                "version": "[variables('analyticRuleObject51').analyticRuleVersion51]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('analyticRuleObject52').analyticRuleTemplateSpecName52]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP - Sensitive Role Changes_AnalyticalRules Analytics Rule with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('analyticRuleObject52').analyticRuleVersion52]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                            "name": "[variables('analyticRuleObject52')._analyticRulecontentId52]",
                            "apiVersion": "2022-04-01-preview",
                            "kind": "Scheduled",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "description": "Identifies changes in sensitive roles.\nSource Action: Change a role using PFCG.\nSensitive roles should be maintained in \"SAP - Sensitive Roles\" Watchlist\n\n*Data Sources: SAPcon - Change Documents Log*",
                                "displayName": "SAP - Sensitive Role Changes",
                                "enabled": false,
                                "query": "// Sensitive Roles Changes\n// Define variables\nlet TimeAgo= 2h;\nlet RoleObjectClass = \"PFCG\";\nlet ChangeType = \"U\";\nlet AuditLogIn = dynamic(['AU1', 'AU5']); // Messages of connect with user\nlet SensitiveRoles = _GetWatchlist(\"SAP - Sensitive Roles\");\n// Maintain if watchlist is not available\nlet fixedRoles = datatable(Role: string)['SAP_BC_BASIS_ADMIN', 'SAP_BC_AUTH_PROFILE_ADMIN'];\nlet UnitedRoles =toscalar(union fixedRoles, SensitiveRoles\n| summarize Roles = make_list(Role));\nlet SelectedSystemRoles =  dynamic([\"Production\"]); //can also do// let SelectedSystemRoles =  dynamic([\"Production\", \"UAT\"]); dynamic([\"All System Roles\"])\nlet SelectedSystems = SAPSystems(SelectedSystemRoles=SelectedSystemRoles) | project SystemID= SearchKey, SystemRole;\n// here you can exclude system users which are OK to run sensitive role updates\n// by adding those users in the SAP_User_Config watchlist with a tag of 'UpdateSensitiveAuthOK'\nlet excludeUsersTags= dynamic(['UpdateSensitiveAuthOK']);\nlet excludedUsers= _GetWatchlist('SAP_User_Config')| where Tags has_any (excludeUsersTags)| summarize by User2Exclude=SAPUser;\n// Query logic\nlet RoleChanges= SAPChangeDocsLog\n| where TimeGenerated> ago(TimeAgo+ 1h)\n| where ingestion_time() > ago(TimeAgo)\n| where TableName contains (\"1251\")\n| where ObjectClass == RoleObjectClass // Relevant role object class\n| where TypeofChange_Header == ChangeType\n| join kind= inner  SelectedSystems on SystemID\n| join kind=leftantisemi excludedUsers on $left.User == $right.User2Exclude\n| extend AuthorizationObj = extract(@\"\\S+\\s+(\\S+)\\s+\", 1, ChangedTableKey, typeof(string)) // Extract Authorization Object\n| extend Authorization = extract(@\"\\S+\\s+\\S+\\s+(\\S+\\d+)\", 1, ChangedTableKey, typeof(string)) // Extract Authorization\n| where ObjectID in (UnitedRoles) // Role is sensitive\n| project-rename ChangedOn= UpdatedOn_t\n| extend BagOfChange= bag_pack(\"Authorization\",Authorization, \"AuthorizationObj\", AuthorizationObj, \"FieldName\", FieldName, \"OldValue\", ValueOld,\"NewValue\", ValueNew )\n| summarize TableName=any(TableName), TransactionCode=any(TransactionCode), SystemRole=any(SystemRole), Host=any(Host), Instance=any(Instance), Authorizations= makeset(Authorization), BagOfChanges= make_set(BagOfChange, 30) by ChangedOn , SystemID, ClientID, ChangedRole= ObjectID, User;\nlet RoleChangesEarliest= toscalar(RoleChanges | summarize EarliestChange= min(ChangedOn));\nlet Logins = SAPAuditLog\n| where TimeGenerated> RoleChangesEarliest - 1h\n| where MessageID in (AuditLogIn)\n| where User in((RoleChanges | distinct User))\n| project-rename LoggedOn= UpdatedOn_t\n| summarize count() by Email, TerminalIPv6, User, SystemID, ClientID, bin(LoggedOn, 1h); // Get last connection date for user\nRoleChanges\n| lookup kind=inner Logins on User, ClientID, SystemID // Get IP\n| where ChangedOn > LoggedOn\n| extend ChangeKey=strcat(ChangedRole, User, SystemID, ChangedOn)\n| order by ChangeKey\n| extend UpdatedOnDiff= datetime_diff('minute', ChangedOn, LoggedOn)\n| extend Rank=row_number(1, prev(ChangeKey) != ChangeKey)\n| where Rank< 3 // allow up to 2 IP addresses per 1h for capture replay scenarios\n| project Authorizations, TimeGenerated= ChangedOn, Instance, SystemID, ClientID, Email, User, TerminalIPv6, Host, ChangedRole, BagOfChanges, SystemRole\n| extend Email= iff(isempty(Email),User, Email), Host= iff(isempty(Host), TerminalIPv6, Host)\n| extend AlertName= strcat('Sensitive Role ' , ChangedRole, ' was updated by ', User, \" in a \", tolower(SystemRole), \" system\"), Dummy=' '\n| extend PackedDetails= pack_all()\n| extend AlertDescription= strcat(\" The sensitive role \", ChangedRole, \" was changed by user \", User,\". Changed authorizations: \", Authorizations,\". The list of changes detected: \", BagOfChanges)\n| extend AlertRuleUniqueName = 'sensitiverolechanges'\n",
                                "queryFrequency": "PT12H",
                                "queryPeriod": "PT12H",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                    {
                                        "connectorId": "SAP",
                                        "dataTypes": [
                                            "SAPAuditLog",
                                            "SAPChangeDocsLog",
                                            "SAPSystems"
                                        ]
                                    }
                                ],
                                "tactics": [
                                    "Impact",
                                    "PrivilegeEscalation",
                                    "Persistence"
                                ],
                                "entityMappings": [
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Email"
                                            }
                                        ],
                                        "entityType": "Account"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Address",
                                                "columnName": "TerminalIPv6"
                                            }
                                        ],
                                        "entityType": "IP"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Host"
                                            }
                                        ],
                                        "entityType": "Host"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Name",
                                                "columnName": "SystemID"
                                            },
                                            {
                                                "identifier": "AppId",
                                                "columnName": "ClientID"
                                            },
                                            {
                                                "identifier": "InstanceName",
                                                "columnName": "Instance"
                                            }
                                        ],
                                        "entityType": "CloudApplication"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "DistinguishedName",
                                                "columnName": "ChangedRole"
                                            }
                                        ],
                                        "entityType": "SecurityGroup"
                                    }
                                ],
                                "eventGroupingSettings": {
                                    "aggregationKind": "AlertPerResult"
                                },
                                "customDetails": {
                                    "AlertRuleUniqueName": "AlertRuleUniqueName",
                                    "SAP_User": "User"
                                },
                                "alertDetailsOverride": {
                                    "alertDescriptionFormat": "{{AlertDescription}}\nIdentifies changes in sensitive roles.\nSource Action: Change a role using PFCG.\nSensitive roles should be maintained in \"SAP - Sensitive Roles\" Watchlist\n\n*Data Sources: SAPcon - Change Documents Log*\n{{PackedDetails}}\n",
                                    "alertTacticsColumnName": "Dummy",
                                    "alertDisplayNameFormat": "{{AlertName}}",
                                    "alertSeverityColumnName": "Dummy"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject52').analyticRuleId52,'/'))))]",
                            "properties": {
                                "description": "SAP Analytics Rule 52",
                                "parentId": "[variables('analyticRuleObject52').analyticRuleId52]",
                                "contentId": "[variables('analyticRuleObject52')._analyticRulecontentId52]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject52').analyticRuleVersion52]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SAP",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('analyticRuleObject52')._analyticRulecontentId52]",
                "contentKind": "AnalyticsRule",
                "displayName": "SAP - Sensitive Role Changes",
                "contentProductId": "[variables('analyticRuleObject52')._analyticRulecontentProductId52]",
                "id": "[variables('analyticRuleObject52')._analyticRulecontentProductId52]",
                "version": "[variables('analyticRuleObject52').analyticRuleVersion52]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('analyticRuleObject53').analyticRuleTemplateSpecName53]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP - Sensitive Tables Direct Access By Dialog Logon_AnalyticalRules Analytics Rule with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('analyticRuleObject53').analyticRuleVersion53]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                            "name": "[variables('analyticRuleObject53')._analyticRulecontentId53]",
                            "apiVersion": "2022-04-01-preview",
                            "kind": "Scheduled",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "description": "Identifies generic table access by dialog logon\n\nSource Action: Open table contents using SE11/SE16/SE16N.\n\n**Recommended for Production only**\n\nTables should be maintained in \"\"SAP - Sensitive Tables\"\" Watchlist.\n\n*Data Sources: SAPcon -  Audit Log*",
                                "displayName": "SAP - Sensitive Tables Direct Access By Dialog Logon",
                                "enabled": false,
                                "query": "// Define variables\nlet Role = \"Production\";\nlet AuditClasses = dynamic(['DU9']); // Dialog, Audit Log Classes - Generic Table Access\nlet allSystemRoles = dynamic(['Sandbox','Developement','QualityAssurance','Training','Production']); // Available System Roles\nlet allSystemUsage = dynamic (['ERP','CRM','BW','Solman','Gateway','Enterprise Portal']); // Available System Usages\n// Get Relevant Systems from WatchList\nlet systemID = _GetWatchlist('SAP - Systems');\nlet fixedSID = datatable(SystemID:string, SystemRole:string, SystemUsage:string)\n// Maintain these if WatchList is not available\n    [\"S4H\",\"Production\",\"ERP\",\n    \"XXX\",\"Sandbox\",\"BW\"]\n;\n// Get Relevant Tables\nlet SensitiveTables = _GetWatchlist('SAP - Sensitive Tables');\nlet fixedTables = datatable(Table:string)\n// Maintain these if WatchList is not available\n    [\"USR02\"]\n;\nlet RelSystemID = union systemID, fixedSID // Create a variable that stores relevant Systems\n| where SystemRole == Role // Recommended  is Production only\n//| where SystemRole in (allSystemRoles); // Use this for all system roles\n| summarize by SystemID;\nlet SensitiveUnionTables = union SensitiveTables, fixedTables // Create a variable that stores relevant sensitive tables\n    | summarize by Table;\n// Query logic\nSAPAuditLog\n    | project-rename Table = Variable1, Activity = Variable2\n    | where MessageID in (AuditClasses)\n    | where SystemID in (RelSystemID)\n    | where Table in (SensitiveUnionTables)\n    | order by TimeGenerated asc\n    | project TimeGenerated, Instance, SystemID, ClientID, User, TransactionCode, ABAPProgramName, Table,   Activity, MessageText, MessageID,\nEmail, TerminalIPv6, Host\n| extend AlertRuleUniqueName = 'sensitivetablesdirectaccessbydialoglogon'\n",
                                "queryFrequency": "PT12H",
                                "queryPeriod": "PT12H",
                                "severity": "Low",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                    {
                                        "connectorId": "SAP",
                                        "dataTypes": [
                                            "SAPAuditLog"
                                        ]
                                    }
                                ],
                                "tactics": [
                                    "Discovery"
                                ],
                                "entityMappings": [
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Email"
                                            }
                                        ],
                                        "entityType": "Account"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Address",
                                                "columnName": "TerminalIPv6"
                                            }
                                        ],
                                        "entityType": "IP"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Host"
                                            }
                                        ],
                                        "entityType": "Host"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Name",
                                                "columnName": "SystemID"
                                            },
                                            {
                                                "identifier": "AppId",
                                                "columnName": "ClientID"
                                            },
                                            {
                                                "identifier": "InstanceName",
                                                "columnName": "Instance"
                                            }
                                        ],
                                        "entityType": "CloudApplication"
                                    }
                                ],
                                "eventGroupingSettings": {
                                    "aggregationKind": "SingleAlert"
                                },
                                "customDetails": {
                                    "AlertRuleUniqueName": "AlertRuleUniqueName",
                                    "SAP_User": "User"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject53').analyticRuleId53,'/'))))]",
                            "properties": {
                                "description": "SAP Analytics Rule 53",
                                "parentId": "[variables('analyticRuleObject53').analyticRuleId53]",
                                "contentId": "[variables('analyticRuleObject53')._analyticRulecontentId53]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject53').analyticRuleVersion53]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SAP",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('analyticRuleObject53')._analyticRulecontentId53]",
                "contentKind": "AnalyticsRule",
                "displayName": "SAP - Sensitive Tables Direct Access By Dialog Logon",
                "contentProductId": "[variables('analyticRuleObject53')._analyticRulecontentProductId53]",
                "id": "[variables('analyticRuleObject53')._analyticRulecontentProductId53]",
                "version": "[variables('analyticRuleObject53').analyticRuleVersion53]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('analyticRuleObject54').analyticRuleTemplateSpecName54]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP - Sensitive Tables Direct Access By RFC Logon_AnalyticalRules Analytics Rule with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('analyticRuleObject54').analyticRuleVersion54]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                            "name": "[variables('analyticRuleObject54')._analyticRulecontentId54]",
                            "apiVersion": "2022-04-01-preview",
                            "kind": "Scheduled",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "description": "Identifies generic table access by RFC logon\n\nSource Action: Open table contents using SE11/SE16/SE16N.\n\n**Recommended for Production only**\n\nTables should be maintained in \"SAP - Sensitive Tables\" Watchlist.\n\n*Data Sources: SAPcon -  Audit Log*",
                                "displayName": "SAP - Sensitive Tables Direct Access By RFC Logon",
                                "enabled": false,
                                "query": "// SAP - Sensitive Tables Direct Access By RFC Logon\n// CONFIGURATION OPTION- determine which system roles are relevant for this alert\nlet SelectedSystemRoles =  dynamic([\"Production\"]); //can also do// let SelectedSystemRoles =  dynamic([\"Production\", \"UAT\"]); dynamic([\"All System Roles\"])\nlet SelectedSystems = SAPSystems(SelectedSystemRoles= SelectedSystemRoles) | project SystemID= SearchKey;\n// Get Relevant Tables\nlet SensitiveTables = _GetWatchlist('SAP - Sensitive Tables')| project Table;\n// here you can exclude system users which are OK to access sensitive tables via RFC\n// by adding those users in the SAP_User_Config watchlist with a tag of 'SensitiveTablebyRFCOK'\n// can also specify SAP Roles or Profiles to exclude\nlet excludeUsersTags= dynamic(['SensitiveTablebyRFCOK','SAP_ALL']);\nlet excludedUsers= SAPUsersGetVIP(SearchForTags= excludeUsersTags)| summarize by User2Exclude=SAPUser;\n// Query logic\nSAPAuditLog\n    | where SystemID in (SelectedSystems)\n    | where MessageID == 'CUZ'\n    | where Variable1 in (SensitiveTables)\n    | project-rename Table = Variable1, Activity = Variable2\n    | join kind=leftantisemi excludedUsers on $left.User == $right.User2Exclude\n    | order by TimeGenerated asc\n    | project TimeGenerated,Instance, SystemID, ClientID, User, TransactionCode, ABAPProgramName, Table, Activity, MessageText, MessageID,\nEmail, TerminalIPv6, Host\n    | extend PackedDetails= pack_all()\n    | extend AlertDescription= strcat('SAP - User ', User, ' has accessed sensitive table ', Table, ' using RFC'), Dummy=''\n    | extend RemediationSteps= strcat(\"Consult with the SAP security team to determine if user \", User, \" is OK to perform this action. If the activity is benign, assign the user with the SensitiveTablebyRFCOK tag in SAP_User_Config watchlist. Otherwise, lock the SAP user in system \", SystemID), Dummy= ''\n| extend AlertRuleUniqueName = 'sensitivetablesdirectaccessbyrfclogon'\n",
                                "queryFrequency": "PT12H",
                                "queryPeriod": "PT13H",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                    {
                                        "connectorId": "SAP",
                                        "dataTypes": [
                                            "SAPAuditLog",
                                            "SAPSystems",
                                            "SAPUsersGetVIP"
                                        ]
                                    }
                                ],
                                "tactics": [
                                    "Collection",
                                    "Exfiltration",
                                    "CredentialAccess"
                                ],
                                "entityMappings": [
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Email"
                                            }
                                        ],
                                        "entityType": "Account"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Address",
                                                "columnName": "TerminalIPv6"
                                            }
                                        ],
                                        "entityType": "IP"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Host"
                                            }
                                        ],
                                        "entityType": "Host"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Name",
                                                "columnName": "SystemID"
                                            },
                                            {
                                                "identifier": "AppId",
                                                "columnName": "ClientID"
                                            },
                                            {
                                                "identifier": "InstanceName",
                                                "columnName": "Instance"
                                            }
                                        ],
                                        "entityType": "CloudApplication"
                                    }
                                ],
                                "eventGroupingSettings": {
                                    "aggregationKind": "AlertPerResult"
                                },
                                "customDetails": {
                                    "Table": "Table",
                                    "PackedDetails": "PackedDetails",
                                    "SAP_User": "User",
                                    "AlertRuleUniqueName": "AlertRuleUniqueName"
                                },
                                "alertDetailsOverride": {
                                    "alertDescriptionFormat": "Identifies generic table access by RFC logon\n\nSource Action: Open table contents using SE11/SE16/SE16N.\nRFC is a Remote Function Call protocol used in SAP to transfer data between systems. This analytics rule alerts on  calls made to retrieve sensite table data.\nThere are a few configuration options here:\n*Configure sensitive tables* using the \"SAP - Sensitive Tables\" watchlist <br\\>\n*Exclude system users* - you can exclude system users which are OK to access sensitive tables via RFC by adding those users in the SAP_User_Config watchlist with a tag of 'SensitiveTablebyRFCOK'. Yoy can also specify SAP Roles or Profiles- this will prevented alerts from being raised on any user carrying these roles or profiles.\n\n{{PackedDetails}}\n",
                                    "alertTacticsColumnName": "Dummy",
                                    "alertDisplayNameFormat": "{{AlertDescription}}",
                                    "alertSeverityColumnName": "Dummy"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject54').analyticRuleId54,'/'))))]",
                            "properties": {
                                "description": "SAP Analytics Rule 54",
                                "parentId": "[variables('analyticRuleObject54').analyticRuleId54]",
                                "contentId": "[variables('analyticRuleObject54')._analyticRulecontentId54]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject54').analyticRuleVersion54]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SAP",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('analyticRuleObject54')._analyticRulecontentId54]",
                "contentKind": "AnalyticsRule",
                "displayName": "SAP - Sensitive Tables Direct Access By RFC Logon",
                "contentProductId": "[variables('analyticRuleObject54')._analyticRulecontentProductId54]",
                "id": "[variables('analyticRuleObject54')._analyticRulecontentProductId54]",
                "version": "[variables('analyticRuleObject54').analyticRuleVersion54]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('analyticRuleObject55').analyticRuleTemplateSpecName55]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP - Sensitive User's Password Change and Log in_AnalyticalRules Analytics Rule with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('analyticRuleObject55').analyticRuleVersion55]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                            "name": "[variables('analyticRuleObject55')._analyticRulecontentId55]",
                            "apiVersion": "2022-04-01-preview",
                            "kind": "Scheduled",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "description": "Identifies password changes for privileged users.\n\nSource Action: Change Password for a user and login to the system.\n\nPriveleged users should be maintained in \"SAP - Privileged Users\" Watchlist\n\nThis rule requires a fresh full reload of SAP user master data to be performed daily.\n*Data Sources: SAPcon -  Audit Log*\n*Data Sources: SAPcon -  User MD*",
                                "displayName": "SAP - Sensitive User's Password Change and Log in",
                                "enabled": false,
                                "query": "// SAP - High - Sensitive Users Password Change and Login\n// Define variables\n// time span for audit events\nlet AuditTimeAgo= 90m;\nlet ChangeAndLoginThreshold = 30; // Difference by minutes between Change in user to connect\nlet LoginAndRestThreshold = 30; // Difference by minutes between Connect and password reset\nlet AuditUserChange = dynamic(['AUD']); // Message of change in user\nlet AuditLogIn = dynamic(['AU1', 'AU5']); // Messages of connect with user\nlet AuditUserPassReset = dynamic(['BU2']); // Message of user password change\n// Query Logic\nlet UserChange = // Get users change activity\nSAPAuditLog\n| where MessageID in (AuditUserChange)\n| where TimeGenerated > ago(AuditTimeAgo)\n|join kind= inner (SAPUsersGetPrivileged()) // The user with the changed password is privileged user\non $left.ClientID == $right.Client\n, $left.SystemID == $right.SystemID\n, $left.Variable1 == $right.User\n| project-rename UserChangeTimeGenerated = TimeGenerated, UserPassChanged = Variable1;\nlet UserLogIn = // Get users connections\nSAPAuditLog\n| where MessageID in (AuditLogIn)\n| where TimeGenerated > ago(AuditTimeAgo)\n| project-rename UserLogInTimeGenerated = TimeGenerated;\nSAPAuditLog // Get users password reset\n| where MessageID in (AuditUserPassReset)\n| where TimeGenerated > ago(AuditTimeAgo)\n|join kind= inner (SAPUsersGetPrivileged()) // The user with the changed password is privileged user\non $left.User == $right.Client\n, $left.SystemID == $right.SystemID\n, $left.Variable1 == $right.User\n| lookup kind=inner UserLogIn on TerminalIPv6, User // Lookup of user reset to user login\n| lookup kind=inner UserChange on TerminalIPv6, $left.User == $right.UserPassChanged // Lookup of user reset to user change\n| where abs(datetime_diff('Minute', UserChangeTimeGenerated, UserLogInTimeGenerated)) <= ChangeAndLoginThreshold // Connect after a change in user\n| where abs(datetime_diff('Minute', TimeGenerated, UserLogInTimeGenerated)) <= LoginAndRestThreshold // Change password after connection\n| summarize by TimeGenerated, Instance ,SystemID, ClientID, UserAction = User1, PrivUserPassChanged = User, Email, TerminalIPv6, Host\n| extend AlertRuleUniqueName = 'sensitiveuserspasswordchangeandlogin'\n",
                                "queryFrequency": "PT1H",
                                "queryPeriod": "P2D",
                                "severity": "High",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                    {
                                        "connectorId": "SAP",
                                        "dataTypes": [
                                            "SAPAuditLog",
                                            "SAPUsersGetPrivileged"
                                        ]
                                    }
                                ],
                                "tactics": [
                                    "Impact",
                                    "CommandAndControl",
                                    "PrivilegeEscalation"
                                ],
                                "entityMappings": [
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Email"
                                            }
                                        ],
                                        "entityType": "Account"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Host"
                                            }
                                        ],
                                        "entityType": "Host"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Address",
                                                "columnName": "TerminalIPv6"
                                            }
                                        ],
                                        "entityType": "IP"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Name",
                                                "columnName": "SystemID"
                                            },
                                            {
                                                "identifier": "AppId",
                                                "columnName": "ClientID"
                                            },
                                            {
                                                "identifier": "InstanceName",
                                                "columnName": "Instance"
                                            }
                                        ],
                                        "entityType": "CloudApplication"
                                    }
                                ],
                                "eventGroupingSettings": {
                                    "aggregationKind": "SingleAlert"
                                },
                                "customDetails": {
                                    "AlertRuleUniqueName": "AlertRuleUniqueName",
                                    "SAP_User": "UserAction"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject55').analyticRuleId55,'/'))))]",
                            "properties": {
                                "description": "SAP Analytics Rule 55",
                                "parentId": "[variables('analyticRuleObject55').analyticRuleId55]",
                                "contentId": "[variables('analyticRuleObject55')._analyticRulecontentId55]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject55').analyticRuleVersion55]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SAP",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('analyticRuleObject55')._analyticRulecontentId55]",
                "contentKind": "AnalyticsRule",
                "displayName": "SAP - Sensitive User's Password Change and Log in",
                "contentProductId": "[variables('analyticRuleObject55')._analyticRulecontentProductId55]",
                "id": "[variables('analyticRuleObject55')._analyticRulecontentProductId55]",
                "version": "[variables('analyticRuleObject55').analyticRuleVersion55]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('analyticRuleObject56').analyticRuleTemplateSpecName56]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP - Sensitive privileged user makes a change in another user_AnalyticalRules Analytics Rule with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('analyticRuleObject56').analyticRuleVersion56]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                            "name": "[variables('analyticRuleObject56')._analyticRulecontentId56]",
                            "apiVersion": "2022-04-01-preview",
                            "kind": "Scheduled",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "description": "Identifies changes  of sensitive privileged users in other users.\n\nSource Action: Change user details / authorizations using SU01.\n\nPriveleged users should be maintained in \"SAP - Privileged Users\" Watchlist\n\nThis rule requires a fresh full reload of SAP user master data to be performed daily.\n*Data Sources: SAPcon -  Audit Log*\n*Data Sources: SAPcon -  User MD*",
                                "displayName": "SAP - Sensitive privileged user makes a change in another user",
                                "enabled": false,
                                "query": "// SAP - High - Sensitive privileged user makes a change in another user\n// time span for audit events\nlet AuditTimeAgo= 75m;\n// Audit Log Classes - User Master Changes\nlet AuditClasses = dynamic(['AU7', 'AU8', 'AU9', 'AUA', 'AUB', 'AUD', 'BU2']);\n// here you can exclude system users which are OK to modify other users' master data\n// by adding those users in the SAP_User_Config watchlist with a tag of 'ChangeUserMasterDataOK'\nlet excludeUsersTags= dynamic(['ChangeUserMasterDataOK']);\nlet excludedUsers= _GetWatchlist('SAP_User_Config')| where Tags has_any (excludeUsersTags)| summarize by User2Exclude=SAPUser;\n// Query Logic\nSAPAuditLog\n| where TimeGenerated > ago(AuditTimeAgo)\n| where MessageID in (AuditClasses)\n| join kind=leftantisemi excludedUsers on $left.User == $right.User2Exclude\n| join kind= leftsemi  SAPUsersGetPrivileged on // The user that makes a change is a sensitive privileged user\n$left.User == $right.User\n,$left.SystemID == $right.SystemID\n,$left.ClientID == $right.Client\n| extend ChangedUser= iff(MessageID == \"BU2\", Variable2, Variable1)\n| lookup  (SAPUsersEmail()| project ChangedEmail= Email, ChangedUser= User, SystemID, ClientID)\n on SystemID, ClientID, ChangedUser\n| project TimeGenerated, Instance ,SystemID, ClientID, User, MessageText, MessageID,\n     Email= iff(isempty(Email),User, Email), TerminalIPv6, Host= iff(isempty(Host), TerminalIPv6, Host), ChangedUser, ChangedEmail\n| extend AlertRuleUniqueName = 'sensitiveprivilegedusermakesachangeinanotheruser'\n",
                                "queryFrequency": "PT1H",
                                "queryPeriod": "P2D",
                                "severity": "High",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                    {
                                        "connectorId": "SAP",
                                        "dataTypes": [
                                            "SAPAuditLog",
                                            "SAPUsersEmail",
                                            "SAPUsersGetPrivileged"
                                        ]
                                    }
                                ],
                                "tactics": [
                                    "PrivilegeEscalation",
                                    "CredentialAccess"
                                ],
                                "entityMappings": [
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Email"
                                            }
                                        ],
                                        "entityType": "Account"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Host"
                                            }
                                        ],
                                        "entityType": "Host"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Address",
                                                "columnName": "TerminalIPv6"
                                            }
                                        ],
                                        "entityType": "IP"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Name",
                                                "columnName": "SystemID"
                                            },
                                            {
                                                "identifier": "AppId",
                                                "columnName": "ClientID"
                                            },
                                            {
                                                "identifier": "InstanceName",
                                                "columnName": "Instance"
                                            }
                                        ],
                                        "entityType": "CloudApplication"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "ChangedEmail"
                                            }
                                        ],
                                        "entityType": "Account"
                                    }
                                ],
                                "eventGroupingSettings": {
                                    "aggregationKind": "AlertPerResult"
                                },
                                "customDetails": {
                                    "ChangedUser": "ChangedUser",
                                    "SAP_User": "User",
                                    "AlertRuleUniqueName": "AlertRuleUniqueName"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject56').analyticRuleId56,'/'))))]",
                            "properties": {
                                "description": "SAP Analytics Rule 56",
                                "parentId": "[variables('analyticRuleObject56').analyticRuleId56]",
                                "contentId": "[variables('analyticRuleObject56')._analyticRulecontentId56]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject56').analyticRuleVersion56]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SAP",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('analyticRuleObject56')._analyticRulecontentId56]",
                "contentKind": "AnalyticsRule",
                "displayName": "SAP - Sensitive privileged user makes a change in another user",
                "contentProductId": "[variables('analyticRuleObject56')._analyticRulecontentProductId56]",
                "id": "[variables('analyticRuleObject56')._analyticRulecontentProductId56]",
                "version": "[variables('analyticRuleObject56').analyticRuleVersion56]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('analyticRuleObject57').analyticRuleTemplateSpecName57]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP - Spool Takeover_AnalyticalRules Analytics Rule with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('analyticRuleObject57').analyticRuleVersion57]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                            "name": "[variables('analyticRuleObject57')._analyticRulecontentId57]",
                            "apiVersion": "2022-04-01-preview",
                            "kind": "Scheduled",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "description": "Identifies a user printing a spool request which was created by someone else.\n\nSource Action: Create a Spool Request using one user, Output it in using another user.\n\n*Data Sources: SAPcon -  Spool Log*\n*Data Sources: SAPcon -  Spool Output Log*",
                                "displayName": "SAP - Spool Takeover",
                                "enabled": false,
                                "query": "// Define variables\nlet AuditLogIn = dynamic(['AU1', 'AU5']); // Messages of connect with user\n// Query logic\nlet LastLogin =\nSAPAuditLog\n| where MessageID in (AuditLogIn)\n| summarize TimeGenerated = arg_max(TimeGenerated, *) by SystemID, ClientID, User; // Get last connection date for user\n// Query Logic\nSAPSpoolOutputLog // Get all spool outputs\n| lookup kind=inner SAPSpoolLog on SpoolRequestNumber\n| lookup kind=inner LastLogin on User, SystemID\n| where User != User1 // The user that created the request is not the one that printed it\n| project TimeGenerated, Instance, SystemID, ClientID, UserCreated = User1, UserPrinted = User, SpoolRequestNumber, Email, TerminalIPv6, Host\n| extend AlertRuleUniqueName = 'spooltakeover'\n",
                                "queryFrequency": "PT12H",
                                "queryPeriod": "PT12H",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                    {
                                        "connectorId": "SAP",
                                        "dataTypes": [
                                            "SAPAuditLog",
                                            "SAPSpoolLog",
                                            "SAPSpoolOutputLog"
                                        ]
                                    }
                                ],
                                "tactics": [
                                    "Collection",
                                    "Exfiltration",
                                    "CommandAndControl"
                                ],
                                "entityMappings": [
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Email"
                                            }
                                        ],
                                        "entityType": "Account"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Address",
                                                "columnName": "TerminalIPv6"
                                            }
                                        ],
                                        "entityType": "IP"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Host"
                                            }
                                        ],
                                        "entityType": "Host"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Name",
                                                "columnName": "SystemID"
                                            },
                                            {
                                                "identifier": "AppId",
                                                "columnName": "ClientID"
                                            },
                                            {
                                                "identifier": "InstanceName",
                                                "columnName": "Instance"
                                            }
                                        ],
                                        "entityType": "CloudApplication"
                                    }
                                ],
                                "eventGroupingSettings": {
                                    "aggregationKind": "SingleAlert"
                                },
                                "customDetails": {
                                    "AlertRuleUniqueName": "AlertRuleUniqueName",
                                    "SAP_User": "UserPrinted"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject57').analyticRuleId57,'/'))))]",
                            "properties": {
                                "description": "SAP Analytics Rule 57",
                                "parentId": "[variables('analyticRuleObject57').analyticRuleId57]",
                                "contentId": "[variables('analyticRuleObject57')._analyticRulecontentId57]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject57').analyticRuleVersion57]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SAP",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('analyticRuleObject57')._analyticRulecontentId57]",
                "contentKind": "AnalyticsRule",
                "displayName": "SAP - Spool Takeover",
                "contentProductId": "[variables('analyticRuleObject57')._analyticRulecontentProductId57]",
                "id": "[variables('analyticRuleObject57')._analyticRulecontentProductId57]",
                "version": "[variables('analyticRuleObject57').analyticRuleVersion57]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('analyticRuleObject58').analyticRuleTemplateSpecName58]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP - System Configuration Change_AnalyticalRules Analytics Rule with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('analyticRuleObject58').analyticRuleVersion58]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                            "name": "[variables('analyticRuleObject58')._analyticRulecontentId58]",
                            "apiVersion": "2022-04-01-preview",
                            "kind": "Scheduled",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "description": "Identifies changes for system configuration.\n\nSource Action:  Adapt system change options or software components modifcation using SE06 transaction code.\n\n*Data Sources: SAPcon -  Audit Log*",
                                "displayName": "SAP - System Configuration Change",
                                "enabled": false,
                                "query": "// Audit Log Classes - System Change Configuration\n// !!!IMPORTANT!!!\n// please make sure \"Lookup data from the last\" parameter is greater than a full user master data update cycle\n// please keep \"Lookup data from the last\" to be 7 days to allow coverage of user master data required\n// actual lookback is set by setting TimeAgo\nlet TimeAgo= 20m;\n// CONFIGURATION OPTION- determine which system roles are relevant for this alert\nlet SelectedSystemRoles =  dynamic([\"All System Roles\"]); //can also do// let SelectedSystemRoles =  dynamic([\"Production\", \"UAT\"]);\nlet SelectedSystems = SAPSystems(SelectedSystemRoles= SelectedSystemRoles)\n    | project SystemID= SearchKey, SystemRole, SystemUsage\n    | extend SystemRole= replace_string(SystemRole, 'Unknown (Production)', 'Unknown');\n// here you can exclude system users which are OK to perform this action\n// by adding those users in the SAP_User_Config watchlist with a tag of 'SystemConfigOK'\n// can also specify SAP Roles or Profiles to exclude\nlet excludeUsersTags= dynamic(['SystemConfigOK']); // can also do dynamic(['SystemConfigOK','SAP_ALL'])\nlet excludedUsers= SAPUsersGetVIP(SearchForTags= excludeUsersTags)| summarize by User2Exclude=SAPUser;\nlet AuditClasses = dynamic(['EU1']); // Relevant message\nSAPAuditLog\n| where TimeGenerated > ago(TimeAgo)\n| where MessageID in (AuditClasses)\n| where SystemID in (SelectedSystems)\n| join kind=leftantisemi excludedUsers on $left.User == $right.User2Exclude\n| project\n// Details\nTimeGenerated,Instance, ClientID ,SystemID, User, TransactionCode, SoftwareComponent = Variable1, NewModifiabilityStatus = Variable2, MessageText,\nEmail, TerminalIPv6, Host\n| extend AlertRuleUniqueName = 'systemconfigurationchange'\n",
                                "queryFrequency": "PT15M",
                                "queryPeriod": "PT23H",
                                "severity": "High",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                    {
                                        "connectorId": "SAP",
                                        "dataTypes": [
                                            "SAPAuditLog",
                                            "SAPSystems",
                                            "SAPUsersGetVIP"
                                        ]
                                    }
                                ],
                                "tactics": [
                                    "Exfiltration",
                                    "DefenseEvasion",
                                    "Persistence"
                                ],
                                "entityMappings": [
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Email"
                                            }
                                        ],
                                        "entityType": "Account"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Address",
                                                "columnName": "TerminalIPv6"
                                            }
                                        ],
                                        "entityType": "IP"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Host"
                                            }
                                        ],
                                        "entityType": "Host"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Name",
                                                "columnName": "SystemID"
                                            },
                                            {
                                                "identifier": "AppId",
                                                "columnName": "ClientID"
                                            },
                                            {
                                                "identifier": "InstanceName",
                                                "columnName": "Instance"
                                            }
                                        ],
                                        "entityType": "CloudApplication"
                                    }
                                ],
                                "eventGroupingSettings": {
                                    "aggregationKind": "AlertPerResult"
                                },
                                "customDetails": {
                                    "AlertRuleUniqueName": "AlertRuleUniqueName",
                                    "SAP_User": "User"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject58').analyticRuleId58,'/'))))]",
                            "properties": {
                                "description": "SAP Analytics Rule 58",
                                "parentId": "[variables('analyticRuleObject58').analyticRuleId58]",
                                "contentId": "[variables('analyticRuleObject58')._analyticRulecontentId58]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject58').analyticRuleVersion58]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SAP",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('analyticRuleObject58')._analyticRulecontentId58]",
                "contentKind": "AnalyticsRule",
                "displayName": "SAP - System Configuration Change",
                "contentProductId": "[variables('analyticRuleObject58')._analyticRulecontentProductId58]",
                "id": "[variables('analyticRuleObject58')._analyticRulecontentProductId58]",
                "version": "[variables('analyticRuleObject58').analyticRuleVersion58]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('analyticRuleObject59').analyticRuleTemplateSpecName59]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP - Transaction is unlocked_AnalyticalRules Analytics Rule with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('analyticRuleObject59').analyticRuleVersion59]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                            "name": "[variables('analyticRuleObject59')._analyticRulecontentId59]",
                            "apiVersion": "2022-04-01-preview",
                            "kind": "Scheduled",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "description": "Identifies unlocking of a transaction.\n\nSource Action: Unlock a transaction code using SM01/SM01_DEV/SM01_CUS.\n\n*Data Sources: SAPcon -  Audit Log*",
                                "displayName": "SAP - Transaction is unlocked",
                                "enabled": false,
                                "query": "// Audit Log Classes - Transaction UnLock Events\n// AUP - Transaction Locked\nlet AuditClasses = dynamic(['AUQ']); // AUQ - Transaction Unlocked\nSAPAuditLog\n| where MessageID in (AuditClasses)\n| project-rename TransactionCodeTemp = TransactionCode\n| project-rename TransactionCode= Variable1\n| parse TransactionCode with \"( TR ) \" _TCODE \" - \" ClientTR // Parse to _TCODE and ClientTR\n// Specific Client Action (SM01_CUS) / Cross Client (SM01_DEV)\n| extend TransactionCode = iif(_TCODE != \"\",_TCODE, TransactionCode) // Check if _TCODE is not empty\n| extend ClientTR = iif(ClientTR != \"\",ClientTR, \"CrossClient\") // Check if ClientTR is not empty\n| project\n// Details\nTimeGenerated, Instance, SystemID, User, MessageText,TransactionCode, ClientTR,\nEmail, TerminalIPv6, Host\n| extend AlertRuleUniqueName = 'transactionisunlocked'\n",
                                "queryFrequency": "P1D",
                                "queryPeriod": "P1D",
                                "severity": "Medium",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                    {
                                        "connectorId": "SAP",
                                        "dataTypes": [
                                            "SAPAuditLog"
                                        ]
                                    }
                                ],
                                "tactics": [
                                    "Persistence",
                                    "Execution"
                                ],
                                "entityMappings": [
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Email"
                                            }
                                        ],
                                        "entityType": "Account"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Address",
                                                "columnName": "TerminalIPv6"
                                            }
                                        ],
                                        "entityType": "IP"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Host"
                                            }
                                        ],
                                        "entityType": "Host"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Name",
                                                "columnName": "SystemID"
                                            },
                                            {
                                                "identifier": "AppId",
                                                "columnName": "ClientTR"
                                            },
                                            {
                                                "identifier": "InstanceName",
                                                "columnName": "Instance"
                                            }
                                        ],
                                        "entityType": "CloudApplication"
                                    }
                                ],
                                "eventGroupingSettings": {
                                    "aggregationKind": "SingleAlert"
                                },
                                "customDetails": {
                                    "AlertRuleUniqueName": "AlertRuleUniqueName",
                                    "SAP_User": "User"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject59').analyticRuleId59,'/'))))]",
                            "properties": {
                                "description": "SAP Analytics Rule 59",
                                "parentId": "[variables('analyticRuleObject59').analyticRuleId59]",
                                "contentId": "[variables('analyticRuleObject59')._analyticRulecontentId59]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject59').analyticRuleVersion59]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SAP",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('analyticRuleObject59')._analyticRulecontentId59]",
                "contentKind": "AnalyticsRule",
                "displayName": "SAP - Transaction is unlocked",
                "contentProductId": "[variables('analyticRuleObject59')._analyticRulecontentProductId59]",
                "id": "[variables('analyticRuleObject59')._analyticRulecontentProductId59]",
                "version": "[variables('analyticRuleObject59').analyticRuleVersion59]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('analyticRuleObject60').analyticRuleTemplateSpecName60]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP - Unauthorized Remote Execution of a Sensitive Function Module_AnalyticalRules Analytics Rule with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('analyticRuleObject60').analyticRuleVersion60]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                            "name": "[variables('analyticRuleObject60')._analyticRulecontentId60]",
                            "apiVersion": "2022-04-01-preview",
                            "kind": "Scheduled",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "description": "Detects an unauthorized execution of a sensitive function module using RFC.\nSource Action: Execute a function module using RFC.\n**Recommended for Production only**\nFunction Modules should be maintained in watchlist \"SAP - Sensitive Function Modules\"\n*Data Sources: SAPcon -  Audit Log*",
                                "displayName": "SAP - Unauthorized Remote Execution of a Sensitive Function Module",
                                "enabled": false,
                                "query": "// RFC Execution of a Sensitive Function Module\nlet TimeAgo= 60m;\n// determine which system roles are relevant for this alert\nlet SelectedSystemRoles =  dynamic([\"Production\", \"UAT\"]); //can also do// let SelectedSystemRoles =  dynamic([\"All System Roles\"]);\nlet SelectedSystems = SAPSystems(SelectedSystemRoles= SelectedSystemRoles)\n    | project SystemID= SearchKey, SystemRole, SystemUsage\n    | extend SystemRole= replace_string(SystemRole, 'Unknown (Production)', 'Unknown');\n// here you can exclude system users which are OK to execute a Sensitive function module\n// by adding those users in the SAP_User_Config watchlist with a tag of 'ExecuteSensitiveFMOK'\n// can also specify SAP Roles or Profiles to exclude\nlet excludeUsersTags= dynamic(['ExecuteSensitiveFMOK','SAP_ALL']);\nlet excludedUsers= SAPUsersGetVIP(SearchForTags= excludeUsersTags)| summarize by User2Exclude=SAPUser;\n// this watchlist lists the sensitive function modules, along with users that are OK to run those.\n// if you don't see a column named \"UsersExcluded\" in this WL, add one\nlet SensitiveFMs = _GetWatchlist('SAP - Sensitive Function Modules')\n| extend UsersExcluded= replace_string(column_ifexists(\"UsersExcluded\",\"\"), \" \",\"\")\n| extend UsersExcluded= parse_csv(UsersExcluded)\n| summarize UsersExcluded= make_set(UsersExcluded, 1000), Description=take_anyif(Description, isnotempty(Description)) by SearchKey;\nlet SensitiveFMExecs= materialize(SAPAuditLog\n| where TimeGenerated > ago(TimeAgo + 1h)\n| where ingestion_time() > ago(TimeAgo)\n| where MessageID == \"AUK\"\n| where SystemID in ((SelectedSystems | project SystemID))\n| where Variable3 in ((SensitiveFMs | summarize make_set(SearchKey)))\n| join kind = inner SensitiveFMs on $left.Variable3 == $right.SearchKey\n// exclude users which are OK to run the specific FM\n| where UsersExcluded !has User\n| project-rename FunctionModule = Variable3, FunctionGroup = Variable1\n| order by TimeGenerated asc\n| project TimeGenerated,Instance ,User, SystemID, ClientID, FunctionGroup, FunctionModule, Description, MessageID, Email, TerminalIPv6, Host);\nlet UsersExecuted= (SensitiveFMExecs | summarize make_set(User,1000));\n// let's see if the auth was there yesterday\nlet UsersAuth= SAPUsersAuthorizations(SnapshotAge= 1d)\n| where User in (UsersExecuted) and Field == \"RFC_NAME\" and SystemID in ((SelectedSystems | project SystemID))\n| summarize EQs= make_set(EQs) by User, ClientID, SystemID;\nlet UserMDSystems= SAP_AGR_AGRS | where TimeGenerated > 1d | summarize by SystemID, ClientID= MANDT | extend IsUserMDThere= true;\n// now we check if the user had permisions to perform the RFC call yesterday\nlet UnAuthFMExec= SensitiveFMExecs | lookup UsersAuth on SystemID, ClientID, User\n| where not(EQs has FunctionModule or EQs has FunctionGroup or EQs has \"*\");\nUnAuthFMExec\n| lookup (SelectedSystems | project SystemID, SystemRole) on SystemID\n| lookup UserMDSystems on SystemID, ClientID\n| join kind=leftantisemi excludedUsers on $left.User == $right.User2Exclude\n| extend AlertName= strcat(\"SAP - Unauthorized RFC Execution of a Sensitive Function Module in a \", tolower(SystemRole), \" system\")\n| extend AlertDescription = strcat(\"The Function module \", FunctionModule, \" of the function group \", FunctionGroup, iff(isnotempty(Description), strcat(\", described as '\", Description, \"',\"), \"\"), \" was executed by user \", User, iff(IsUserMDThere, \". No authorization for this execution was found in the user master data profile gathered from SAP system \", \". Sentinel could not verify the authorization for this action as no user master data found for SAP system \"), SystemID, \", Client \", ClientID, \". If this execution is benign, consider checking if the relevant system is configured to send the user master data profile. If you wish to allow this activity, add the specific user USER as UsersExcluded in the SAP - Sensitive Function Modules watchlist. If you wish to allow this user to perform all sensitive FM calls (not recommended), add the user to the SAP_User_Config watchlist with a tag of 'ExecuteSensitiveFMOK'.\")\n| extend Dummy= \"\"\n// | summarize by User, SystemID, ClientID, FunctionGroup, FunctionModule\n| extend AlertRuleUniqueName = 'rfcexecutionofasensitivefunctionmodule'\n",
                                "queryFrequency": "PT1H",
                                "queryPeriod": "P2D",
                                "severity": "High",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                    {
                                        "connectorId": "SAP",
                                        "dataTypes": [
                                            "SAP_AGR_AGRS",
                                            "SAPAuditLog",
                                            "SAPSystems",
                                            "SAPUsersAuthorizations",
                                            "SAPUsersGetVIP"
                                        ]
                                    }
                                ],
                                "tactics": [
                                    "Discovery",
                                    "Exfiltration",
                                    "LateralMovement"
                                ],
                                "entityMappings": [
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Email"
                                            }
                                        ],
                                        "entityType": "Account"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Address",
                                                "columnName": "TerminalIPv6"
                                            }
                                        ],
                                        "entityType": "IP"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Host"
                                            }
                                        ],
                                        "entityType": "Host"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Name",
                                                "columnName": "SystemID"
                                            },
                                            {
                                                "identifier": "AppId",
                                                "columnName": "ClientID"
                                            },
                                            {
                                                "identifier": "InstanceName",
                                                "columnName": "Instance"
                                            }
                                        ],
                                        "entityType": "CloudApplication"
                                    }
                                ],
                                "eventGroupingSettings": {
                                    "aggregationKind": "AlertPerResult"
                                },
                                "customDetails": {
                                    "FunctionModule": "FunctionModule",
                                    "SAP_User": "User",
                                    "AlertRuleUniqueName": "AlertRuleUniqueName"
                                },
                                "alertDetailsOverride": {
                                    "alertDescriptionFormat": "<img src=\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/SAP/Workbooks/SAPVMIcon.svg\" width=\"30\"/>\n  </br>\n{{AlertDescription}}\n</br>\nFor more information on enabling user master data visit  [Select the SAP ingestion profile for your Microsoft Sentinel for SAP solution](https://learn.microsoft.com/en-us/azure/sentinel/sap/select-ingestion-profiles) guide.\n",
                                    "alertTacticsColumnName": "Dummy",
                                    "alertDisplayNameFormat": "{{AlertName}}",
                                    "alertSeverityColumnName": "Dummy"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject60').analyticRuleId60,'/'))))]",
                            "properties": {
                                "description": "SAP Analytics Rule 60",
                                "parentId": "[variables('analyticRuleObject60').analyticRuleId60]",
                                "contentId": "[variables('analyticRuleObject60')._analyticRulecontentId60]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject60').analyticRuleVersion60]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SAP",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('analyticRuleObject60')._analyticRulecontentId60]",
                "contentKind": "AnalyticsRule",
                "displayName": "SAP - Unauthorized Remote Execution of a Sensitive Function Module",
                "contentProductId": "[variables('analyticRuleObject60')._analyticRulecontentProductId60]",
                "id": "[variables('analyticRuleObject60')._analyticRulecontentProductId60]",
                "version": "[variables('analyticRuleObject60').analyticRuleVersion60]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('analyticRuleObject61').analyticRuleTemplateSpecName61]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP - User Creates and uses new user_AnalyticalRules Analytics Rule with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('analyticRuleObject61').analyticRuleVersion61]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                            "name": "[variables('analyticRuleObject61')._analyticRulecontentId61]",
                            "apiVersion": "2022-04-01-preview",
                            "kind": "Scheduled",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "description": "Identifies a user creating and using other users.\n\nSource Action: Create a user using SU01. Login using the newly created user from the same IP.\n\n*Data Sources: SAPcon -  Audit Log*",
                                "displayName": "SAP - User Creates and uses new user",
                                "enabled": false,
                                "query": "// Define Variables\nlet MinutesThreshold = 15; // Difference by minutes between Create and Connect\nlet AuditUserCreated = dynamic(['AU7']); // Message of create user\nlet AuditLogIn = dynamic(['AU1', 'AU5']); // Messages of connect with user\n// here you can exclude system users which are OK to Create Other Users\n// by adding those users in the SAP_User_Config watchlist with a tag of 'CreateUserOK'\n// can also specify SAP Roles or Profiles to exclude\nlet excludeUsersTags= dynamic(['CreateUserOK','SAP_ROLE', 'SAP_PROFILE']);\nlet excludedUsers= SAPUsersGetVIP(SearchForTags= excludeUsersTags)| summarize by User2Exclude=SAPUser;\n// Query Logic\nlet UserCreated = // Get users created\nSAPAuditLog\n| join kind=leftantisemi excludedUsers on $left.User == $right.User2Exclude\n| where MessageID in (AuditUserCreated)\n| project-rename UserCreationTimeGenerated = TimeGenerated, UserCreated = Variable1;\nSAPAuditLog // Get users connections\n| where MessageID in (AuditLogIn)\n| lookup kind=inner UserCreated on TerminalIPv6,$left.User == $right.UserCreated, SystemID, ClientID // Lookup of user created to user log in\n| where abs(datetime_diff('Minute', TimeGenerated, UserCreationTimeGenerated)) <= MinutesThreshold // Connect after creation\n| summarize by TimeGenerated, Instance ,SystemID, ClientID, UserActing = User1, UserActingEmail= Email1, UserCreated = User, UserCreatedEmail= Email, TerminalIPv6, Host\n| extend AlertRuleUniqueName = 'usercreatesandusesnewuser'\n",
                                "queryFrequency": "PT1H",
                                "queryPeriod": "PT1H",
                                "severity": "High",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                    {
                                        "connectorId": "SAP",
                                        "dataTypes": [
                                            "SAPAuditLog",
                                            "SAPUsersGetVIP"
                                        ]
                                    }
                                ],
                                "tactics": [
                                    "Discovery",
                                    "InitialAccess"
                                ],
                                "entityMappings": [
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "UserActingEmail"
                                            }
                                        ],
                                        "entityType": "Account"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Address",
                                                "columnName": "TerminalIPv6"
                                            }
                                        ],
                                        "entityType": "IP"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Host"
                                            }
                                        ],
                                        "entityType": "Host"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Name",
                                                "columnName": "SystemID"
                                            },
                                            {
                                                "identifier": "AppId",
                                                "columnName": "ClientID"
                                            },
                                            {
                                                "identifier": "InstanceName",
                                                "columnName": "Instance"
                                            }
                                        ],
                                        "entityType": "CloudApplication"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "UserCreatedEmail"
                                            }
                                        ],
                                        "entityType": "Account"
                                    }
                                ],
                                "eventGroupingSettings": {
                                    "aggregationKind": "SingleAlert"
                                },
                                "customDetails": {
                                    "SAP_UserCreated": "UserCreated",
                                    "SAP_User": "UserActing",
                                    "AlertRuleUniqueName": "AlertRuleUniqueName"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject61').analyticRuleId61,'/'))))]",
                            "properties": {
                                "description": "SAP Analytics Rule 61",
                                "parentId": "[variables('analyticRuleObject61').analyticRuleId61]",
                                "contentId": "[variables('analyticRuleObject61')._analyticRulecontentId61]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject61').analyticRuleVersion61]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SAP",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('analyticRuleObject61')._analyticRulecontentId61]",
                "contentKind": "AnalyticsRule",
                "displayName": "SAP - User Creates and uses new user",
                "contentProductId": "[variables('analyticRuleObject61')._analyticRulecontentProductId61]",
                "id": "[variables('analyticRuleObject61')._analyticRulecontentProductId61]",
                "version": "[variables('analyticRuleObject61').analyticRuleVersion61]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('analyticRuleObject62').analyticRuleTemplateSpecName62]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP - User Unlocks and uses other users_AnalyticalRules Analytics Rule with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('analyticRuleObject62').analyticRuleVersion62]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
                            "name": "[variables('analyticRuleObject62')._analyticRulecontentId62]",
                            "apiVersion": "2022-04-01-preview",
                            "kind": "Scheduled",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "description": "A user unlocked another, and then used the other's user credentials.\n\nSource Action: Unlock a user using SU01. Login using the unlocked user from the same IP.\n\n*Data Sources: SAPcon -  Audit Log*\n*Data Sources: SAPcon -  Change Documents Log*",
                                "displayName": "SAP - User Unlocks and uses other users",
                                "enabled": false,
                                "query": "// SAP - User Unlocks and uses other users\n// Define variables\nlet MinutesThreshold = 30; // Difference by minutes between Unlock and Connect\nlet AuditLogIn = dynamic(['AU1', 'AU5']); // Messages of connect with user\n// here you can exclude system users which are OK to Unlock Other Users\n// by adding those users in the SAP_User_Config watchlist with a tag of 'UnlockUserOK'\n// can also specify SAP Roles or Profiles to exclude\nlet excludeUsersTags= dynamic(['UnlockUserOK','SAP_ROLE', 'SAP_PROFILE']);\nlet excludedUsers= SAPUsersGetVIP(SearchForTags= excludeUsersTags)| summarize by User2Exclude=SAPUser;\n// Get users which were unlocked\nlet UsersUnlocked = SAPAuditLog\n| where MessageID == 'AUA' // Message of unlock user\n| where isnotempty( TerminalIPv6)\n| join kind=leftantisemi excludedUsers on $left.User == $right.User2Exclude\n| project-rename UserUnlockTimeGenerated = TimeGenerated, UserThatWasUnlocked = Variable1, EmailWhoUnlocked = Email, UserWhoUnlocked= User\n| project-keep UserUnlockTimeGenerated, UserThatWasUnlocked, EmailWhoUnlocked, SystemID, ClientID, TerminalIPv6, Instance, Host, UserWhoUnlocked;\n// Query Logic\nlet ActionUsers = SAPAuditLog\n| where isnotempty( TerminalIPv6)\n| project-keep MessageID, User, Email, SystemID, TimeGenerated, ClientID, TerminalIPv6// Get users connections\n| project-rename UserAction = User, EmailAction= Email\n| where MessageID in (AuditLogIn);\n // check if the locked was user was unlocked and then used from the same IP address\n//  as the unlocker\nUsersUnlocked | join kind=inner ActionUsers on\nTerminalIPv6, SystemID, ClientID, $left.UserThatWasUnlocked==$right.UserAction\n| where abs(datetime_diff('Minute', TimeGenerated, UserUnlockTimeGenerated)) <= MinutesThreshold // Connect after unlock\n| summarize Count=count(), TimeGenerated= max(TimeGenerated) by Instance ,SystemID, ClientID, UserWhoUnlocked , UserThatWasUnlocked, EmailWhoUnlocked, EmailThatWasUnLocked= EmailAction, TerminalIPv6, Host\n| extend AlertRuleUniqueName = 'userunlocksandusesotherusers'\n",
                                "queryFrequency": "PT1H",
                                "queryPeriod": "PT1H",
                                "severity": "High",
                                "suppressionDuration": "PT1H",
                                "suppressionEnabled": false,
                                "triggerOperator": "GreaterThan",
                                "triggerThreshold": 0,
                                "status": "Available",
                                "requiredDataConnectors": [
                                    {
                                        "connectorId": "SAP",
                                        "dataTypes": [
                                            "SAPAuditLog",
                                            "SAPUsersGetVIP"
                                        ]
                                    }
                                ],
                                "tactics": [
                                    "InitialAccess",
                                    "Discovery",
                                    "LateralMovement"
                                ],
                                "entityMappings": [
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "EmailWhoUnlocked"
                                            }
                                        ],
                                        "entityType": "Account"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "Host"
                                            }
                                        ],
                                        "entityType": "Host"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Address",
                                                "columnName": "TerminalIPv6"
                                            }
                                        ],
                                        "entityType": "IP"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "Name",
                                                "columnName": "SystemID"
                                            },
                                            {
                                                "identifier": "AppId",
                                                "columnName": "ClientID"
                                            },
                                            {
                                                "identifier": "InstanceName",
                                                "columnName": "Instance"
                                            }
                                        ],
                                        "entityType": "CloudApplication"
                                    },
                                    {
                                        "fieldMappings": [
                                            {
                                                "identifier": "FullName",
                                                "columnName": "EmailThatWasUnLocked"
                                            }
                                        ],
                                        "entityType": "Account"
                                    }
                                ],
                                "eventGroupingSettings": {
                                    "aggregationKind": "SingleAlert"
                                },
                                "customDetails": {
                                    "UserWhoUnlocked": "UserWhoUnlocked",
                                    "AlertRuleUniqueName": "AlertRuleUniqueName",
                                    "UserThatWasUnlocked": "UserThatWasUnlocked"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject62').analyticRuleId62,'/'))))]",
                            "properties": {
                                "description": "SAP Analytics Rule 62",
                                "parentId": "[variables('analyticRuleObject62').analyticRuleId62]",
                                "contentId": "[variables('analyticRuleObject62')._analyticRulecontentId62]",
                                "kind": "AnalyticsRule",
                                "version": "[variables('analyticRuleObject62').analyticRuleVersion62]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SAP",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('analyticRuleObject62')._analyticRulecontentId62]",
                "contentKind": "AnalyticsRule",
                "displayName": "SAP - User Unlocks and uses other users",
                "contentProductId": "[variables('analyticRuleObject62')._analyticRulecontentProductId62]",
                "id": "[variables('analyticRuleObject62')._analyticRulecontentProductId62]",
                "version": "[variables('analyticRuleObject62').analyticRuleVersion62]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('playbookTemplateSpecName1')]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAPLockUser-Advanced Playbook with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('playbookVersion1')]",
                    "parameters": {
                        "PlaybookName": {
                            "defaultValue": "SAPLockUser-Advanced",
                            "type": "string"
                        },
                        "DefaultAdminEmail": {
                            "type": "string",
                            "metadata": {
                                "description": "Enter value for DefaultAdminEmail"
                            }
                        },
                        "SAP-SOAP-KeyVault-Credential-Name": {
                            "type": "string",
                            "metadata": {
                                "description": "Enter value for SAP-SOAP-KeyVault-Credential-Name"
                            }
                        },
                        "TeamsChannel": {
                            "type": "string",
                            "metadata": {
                                "description": "Enter value for TeamsChannel"
                            }
                        }
                    },
                    "variables": {
                        "AzureadConnectionName": "[[concat('Azuread-', parameters('PlaybookName'))]",
                        "AzuremonitorlogsConnectionName": "[[concat('Azuremonitorlogs-', parameters('PlaybookName'))]",
                        "MicrosoftSentinelConnectionName": "[[concat('MicrosoftSentinel-', parameters('PlaybookName'))]",
                        "KeyvaultConnectionName": "[[concat('Keyvault-', parameters('PlaybookName'))]",
                        "Office365ConnectionName": "[[concat('Office365-', parameters('PlaybookName'))]",
                        "TeamsConnectionName": "[[concat('Teams-', parameters('PlaybookName'))]",
                        "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Azuread')]",
                        "_connection-2": "[[variables('connection-2')]",
                        "connection-3": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Azuremonitorlogs')]",
                        "_connection-3": "[[variables('connection-3')]",
                        "connection-4": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Azuresentinel')]",
                        "_connection-4": "[[variables('connection-4')]",
                        "connection-5": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Keyvault')]",
                        "_connection-5": "[[variables('connection-5')]",
                        "connection-6": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Office365')]",
                        "_connection-6": "[[variables('connection-6')]",
                        "connection-7": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Teams')]",
                        "_connection-7": "[[variables('connection-7')]",
                        "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
                        "workspace-name": "[parameters('workspace')]",
                        "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
                    },
                    "resources": [
                        {
                            "properties": {
                                "provisioningState": "Succeeded",
                                "state": "Enabled",
                                "definition": {
                                    "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                                    "contentVersion": "1.0.0.0",
                                    "parameters": {
                                        "$connections": {
                                            "type": "Object"
                                        },
                                        "DefaultAdminEmail": {
                                            "type": "string",
                                            "defaultValue": "[[parameters('DefaultAdminEmail')]"
                                        },
                                        "SAP-SOAP-KeyVault-Credential-Name": {
                                            "type": "string",
                                            "defaultValue": "[[parameters('SAP-SOAP-KeyVault-Credential-Name')]"
                                        },
                                        "TeamsChannel": {
                                            "type": "string",
                                            "defaultValue": "[[parameters('TeamsChannel')]"
                                        }
                                    },
                                    "triggers": {
                                        "Microsoft_Sentinel_incident": {
                                            "type": "ApiConnectionWebhook",
                                            "inputs": {
                                                "body": {
                                                    "callback_url": "@{listCallbackUrl()}"
                                                },
                                                "host": {
                                                    "connection": {
                                                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                    }
                                                },
                                                "path": "/incident-creation"
                                            }
                                        }
                                    },
                                    "actions": {
                                        "Incident_response_Scope": {
                                            "actions": {
                                                "Condition_block_or_flag": {
                                                    "actions": {
                                                        "Switch_lock_target_environment": {
                                                            "cases": {
                                                                "Case_AAD": {
                                                                    "case": "aad",
                                                                    "actions": {
                                                                        "Reply_with_a_message_in_a_channel": {
                                                                            "runAfter": {
                                                                                "Update_user_with_disabled_flag": [
                                                                                    "Succeeded"
                                                                                ]
                                                                            },
                                                                            "type": "ApiConnection",
                                                                            "inputs": {
                                                                                "body": {
                                                                                    "messageBody": "<p>Account @{variables('account')} disabled on Azure AD!</p>",
                                                                                    "parentMessageId": "@body('Parse_JSON')?['messageId']",
                                                                                    "recipient": {
                                                                                        "channelId": "@{variables('TeamsChannel')?['channelID']}",
                                                                                        "groupId": "@{variables('TeamsChannel')?['teamID']}"
                                                                                    }
                                                                                },
                                                                                "host": {
                                                                                    "connection": {
                                                                                        "name": "@parameters('$connections')['teams_1']['connectionId']"
                                                                                    }
                                                                                },
                                                                                "method": "post",
                                                                                "path": "/v1.0/teams/conversation/replyWithMessage/poster/Flow bot/location/@{encodeURIComponent('Channel')}"
                                                                            }
                                                                        },
                                                                        "Update_user_with_disabled_flag": {
                                                                            "type": "ApiConnection",
                                                                            "inputs": {
                                                                                "body": {
                                                                                    "accountEnabled": false
                                                                                },
                                                                                "host": {
                                                                                    "connection": {
                                                                                        "name": "@parameters('$connections')['azuread']['connectionId']"
                                                                                    }
                                                                                },
                                                                                "method": "patch",
                                                                                "path": "/v1.0/users/@{encodeURIComponent(variables('account'))}"
                                                                            }
                                                                        }
                                                                    }
                                                                },
                                                                "Case_BTP": {
                                                                    "case": "btp",
                                                                    "actions": {
                                                                        "Reply_with_a_message_in_a_channel_2": {
                                                                            "type": "ApiConnection",
                                                                            "inputs": {
                                                                                "body": {
                                                                                    "messageBody": "<p>Implement SAP REST interfaces with SAP IAS or OAuth2 flow to lock users on XSUAA with property \"active:false\"</p>",
                                                                                    "parentMessageId": "@body('Parse_JSON')?['messageId']",
                                                                                    "recipient": {
                                                                                        "channelId": "@{variables('TeamsChannel')?['channelID']}",
                                                                                        "groupId": "@{variables('TeamsChannel')?['teamID']}"
                                                                                    }
                                                                                },
                                                                                "host": {
                                                                                    "connection": {
                                                                                        "name": "@parameters('$connections')['teams_1']['connectionId']"
                                                                                    }
                                                                                },
                                                                                "method": "post",
                                                                                "path": "/v1.0/teams/conversation/replyWithMessage/poster/Flow bot/location/@{encodeURIComponent('Channel')}"
                                                                            }
                                                                        }
                                                                    }
                                                                },
                                                                "Case_ERP": {
                                                                    "case": "erp",
                                                                    "actions": {
                                                                        "Block_User_via_SOAP_exposed_BAPI": {
                                                                            "runAfter": {
                                                                                "Get_secret": [
                                                                                    "Succeeded"
                                                                                ]
                                                                            },
                                                                            "type": "Http",
                                                                            "inputs": {
                                                                                "authentication": {
                                                                                    "password": "@body('Get_secret')?['value']",
                                                                                    "type": "Basic",
                                                                                    "username": "@body('Get_secret')?['name']"
                                                                                },
                                                                                "body": {
                                                                                    "bAPI_USER_LOCK": {
                                                                                        "uSERNAME": "@{variables('SAP_User')}"
                                                                                    }
                                                                                },
                                                                                "headers": {
                                                                                    "Content-Type": "application/json"
                                                                                },
                                                                                "method": "POST",
                                                                                "uri": "@{variables('basePath')}lockme/sap-com:document:sap:rfc:functions:ZWS_BAPI_USER_LOCK:BAPI_USER_LOCKRequest?sap-client=@{variables('sap-client-id')}"
                                                                            }
                                                                        },
                                                                        "Condition_SOAP_success": {
                                                                            "actions": {
                                                                                "Condition": {
                                                                                    "actions": {
                                                                                        "Close_Sentinel_incident": {
                                                                                            "runAfter": {
                                                                                                "Reply_with_SAP_lock_message_in_channel": [
                                                                                                    "Succeeded"
                                                                                                ]
                                                                                            },
                                                                                            "type": "ApiConnection",
                                                                                            "inputs": {
                                                                                                "body": {
                                                                                                    "classification": {
                                                                                                        "ClassificationAndReason": "TruePositive - SuspiciousActivity",
                                                                                                        "ClassificationReasonText": "@{body('Parse_JSON')?['data']?['blockComment']}"
                                                                                                    },
                                                                                                    "incidentArmId": "@triggerBody()?['object']?['id']",
                                                                                                    "status": "Closed"
                                                                                                },
                                                                                                "host": {
                                                                                                    "connection": {
                                                                                                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                                                                    }
                                                                                                },
                                                                                                "method": "put",
                                                                                                "path": "/Incidents"
                                                                                            }
                                                                                        },
                                                                                        "Reply_with_SAP_lock_message_in_channel": {
                                                                                            "type": "ApiConnection",
                                                                                            "inputs": {
                                                                                                "body": {
                                                                                                    "messageBody": "<p>SAP User @{variables('SAP_User')} (@{variables('account')}) locked!<br>\n<br>\nSAP response: @{body('Parse_SAP_response_as_JSON')?['bAPI_USER_LOCKResponse']?['RETURN'][0]?['mESSAGE']}</p>",
                                                                                                    "parentMessageId": "@body('Parse_JSON')?['messageId']",
                                                                                                    "recipient": {
                                                                                                        "channelId": "@{variables('TeamsChannel')?['channelID']}",
                                                                                                        "groupId": "@{variables('TeamsChannel')?['teamID']}"
                                                                                                    }
                                                                                                },
                                                                                                "host": {
                                                                                                    "connection": {
                                                                                                        "name": "@parameters('$connections')['teams_1']['connectionId']"
                                                                                                    }
                                                                                                },
                                                                                                "method": "post",
                                                                                                "path": "/v1.0/teams/conversation/replyWithMessage/poster/Flow bot/location/@{encodeURIComponent('Channel')}"
                                                                                            }
                                                                                        }
                                                                                    },
                                                                                    "runAfter": {
                                                                                        "Terminate_active_user_session_of_locked_SAP_user": [
                                                                                            "Succeeded"
                                                                                        ]
                                                                                    },
                                                                                    "else": {
                                                                                        "actions": {
                                                                                            "Reply_with_SAP_lock_error_message_in_channel": {
                                                                                                "type": "ApiConnection",
                                                                                                "inputs": {
                                                                                                    "body": {
                                                                                                        "messageBody": "<p>SAP User @{variables('SAP_User')} (@{variables('account')}) locked!<br>\n<br>\nSAP response: @{body('Parse_SAP_response_as_JSON')?['bAPI_USER_LOCKResponse']?['RETURN'][0]?['mESSAGE']}</p>",
                                                                                                        "parentMessageId": "@body('Parse_JSON')?['messageId']",
                                                                                                        "recipient": {
                                                                                                            "channelId": "@{variables('TeamsChannel')?['channelID']}",
                                                                                                            "groupId": "@{variables('TeamsChannel')?['teamID']}"
                                                                                                        }
                                                                                                    },
                                                                                                    "host": {
                                                                                                        "connection": {
                                                                                                            "name": "@parameters('$connections')['teams_1']['connectionId']"
                                                                                                        }
                                                                                                    },
                                                                                                    "method": "post",
                                                                                                    "path": "/v1.0/teams/conversation/replyWithMessage/poster/Flow bot/location/@{encodeURIComponent('Channel')}"
                                                                                                }
                                                                                            }
                                                                                        }
                                                                                    },
                                                                                    "expression": {
                                                                                        "and": [
                                                                                            {
                                                                                                "less": [
                                                                                                    "@outputs('Terminate_active_user_session_of_locked_SAP_user')['statusCode']",
                                                                                                    400
                                                                                                ]
                                                                                            }
                                                                                        ]
                                                                                    },
                                                                                    "type": "If"
                                                                                },
                                                                                "Notify_impacted_colleague_working_with_SAP": {
                                                                                    "type": "ApiConnection",
                                                                                    "inputs": {
                                                                                        "body": {
                                                                                            "messageBody": "<p>Your SAP user in System @{variables('SID')} has been locked due to a security signal! Please reach out to your SAP Basis colleagues for further info.</p>",
                                                                                            "recipient": "@variables('account')"
                                                                                        },
                                                                                        "host": {
                                                                                            "connection": {
                                                                                                "name": "@parameters('$connections')['teams_1']['connectionId']"
                                                                                            }
                                                                                        },
                                                                                        "method": "post",
                                                                                        "path": "/beta/teams/conversation/message/poster/Flow bot/location/@{encodeURIComponent('Chat with Flow bot')}"
                                                                                    }
                                                                                },
                                                                                "Terminate_active_user_session_of_locked_SAP_user": {
                                                                                    "runAfter": {
                                                                                        "Notify_impacted_colleague_working_with_SAP": [
                                                                                            "Succeeded"
                                                                                        ]
                                                                                    },
                                                                                    "type": "Http",
                                                                                    "inputs": {
                                                                                        "authentication": {
                                                                                            "password": "@body('Get_secret')?['value']",
                                                                                            "type": "Basic",
                                                                                            "username": "@body('Get_secret')?['name']"
                                                                                        },
                                                                                        "body": {
                                                                                            "tH_DELETE_USER": {
                                                                                                "cLIENT": "@{variables('sap-client-id')}",
                                                                                                "uSER": "@{variables('SAP_User')}"
                                                                                            }
                                                                                        },
                                                                                        "headers": {
                                                                                            "Content-Type": "application/json"
                                                                                        },
                                                                                        "method": "POST",
                                                                                        "uri": "@{variables('basePath')}/go/sap-com:document:sap:rfc:functions:ZWS_DELETE_USER_SESSION:TH_DELETE_USERRequest?sap-client=@{variables('sap-client-id')}"
                                                                                    }
                                                                                }
                                                                            },
                                                                            "runAfter": {
                                                                                "Parse_SAP_response_as_JSON": [
                                                                                    "Succeeded"
                                                                                ]
                                                                            },
                                                                            "else": {
                                                                                "actions": {
                                                                                    "Reply_to_Admins_with_lock_error_in_Channel": {
                                                                                        "type": "ApiConnection",
                                                                                        "inputs": {
                                                                                            "body": {
                                                                                                "messageBody": "<p>User could not be locked. Error message (code @{outputs('Block_User_via_SOAP_exposed_BAPI')['statusCode']}): @{body('Block_User_via_SOAP_exposed_BAPI')}</p>",
                                                                                                "parentMessageId": "@body('Parse_JSON')?['messageId']",
                                                                                                "recipient": {
                                                                                                    "channelId": "@{variables('TeamsChannel')?['channelID']}",
                                                                                                    "groupId": "@{variables('TeamsChannel')?['teamID']}"
                                                                                                }
                                                                                            },
                                                                                            "host": {
                                                                                                "connection": {
                                                                                                    "name": "@parameters('$connections')['teams_1']['connectionId']"
                                                                                                }
                                                                                            },
                                                                                            "method": "post",
                                                                                            "path": "/v1.0/teams/conversation/replyWithMessage/poster/Flow bot/location/@{encodeURIComponent('Channel')}"
                                                                                        }
                                                                                    }
                                                                                }
                                                                            },
                                                                            "expression": {
                                                                                "and": [
                                                                                    {
                                                                                        "equals": [
                                                                                            "@outputs('Block_User_via_SOAP_exposed_BAPI')['statusCode']",
                                                                                            200
                                                                                        ]
                                                                                    }
                                                                                ]
                                                                            },
                                                                            "type": "If"
                                                                        },
                                                                        "Get_secret": {
                                                                            "type": "ApiConnection",
                                                                            "inputs": {
                                                                                "host": {
                                                                                    "connection": {
                                                                                        "name": "@parameters('$connections')['keyvault_2']['connectionId']"
                                                                                    }
                                                                                },
                                                                                "method": "get",
                                                                                "path": "/secrets/@{encodeURIComponent(parameters('SAP-SOAP-KeyVault-Credential-Name'))}/value"
                                                                            }
                                                                        },
                                                                        "Parse_SAP_response_as_JSON": {
                                                                            "runAfter": {
                                                                                "Block_User_via_SOAP_exposed_BAPI": [
                                                                                    "Succeeded",
                                                                                    "Failed"
                                                                                ]
                                                                            },
                                                                            "type": "ParseJson",
                                                                            "inputs": {
                                                                                "content": "@body('Block_User_via_SOAP_exposed_BAPI')",
                                                                                "schema": {
                                                                                    "properties": {
                                                                                        "bAPI_USER_LOCKResponse": {
                                                                                            "properties": {
                                                                                                "RETURN": {
                                                                                                    "items": {
                                                                                                        "properties": {
                                                                                                            "fIELD": {
                                                                                                                "type": "string"
                                                                                                            },
                                                                                                            "iD": {
                                                                                                                "type": "string"
                                                                                                            },
                                                                                                            "lOG_MSG_NO": {
                                                                                                                "type": "string"
                                                                                                            },
                                                                                                            "lOG_NO": {
                                                                                                                "type": "string"
                                                                                                            },
                                                                                                            "mESSAGE": {
                                                                                                                "type": "string"
                                                                                                            },
                                                                                                            "mESSAGE_V1": {
                                                                                                                "type": "string"
                                                                                                            },
                                                                                                            "mESSAGE_V2": {
                                                                                                                "type": "string"
                                                                                                            },
                                                                                                            "mESSAGE_V3": {
                                                                                                                "type": "string"
                                                                                                            },
                                                                                                            "mESSAGE_V4": {
                                                                                                                "type": "string"
                                                                                                            },
                                                                                                            "nUMBER": {
                                                                                                                "type": "string"
                                                                                                            },
                                                                                                            "pARAMETER": {
                                                                                                                "type": "string"
                                                                                                            },
                                                                                                            "rOW": {
                                                                                                                "type": "integer"
                                                                                                            },
                                                                                                            "sYSTEM": {
                                                                                                                "type": "string"
                                                                                                            },
                                                                                                            "tYPE": {
                                                                                                                "type": "string"
                                                                                                            }
                                                                                                        },
                                                                                                        "required": [
                                                                                                            "tYPE",
                                                                                                            "iD",
                                                                                                            "nUMBER",
                                                                                                            "mESSAGE",
                                                                                                            "lOG_NO",
                                                                                                            "lOG_MSG_NO",
                                                                                                            "mESSAGE_V1",
                                                                                                            "mESSAGE_V2",
                                                                                                            "mESSAGE_V3",
                                                                                                            "mESSAGE_V4",
                                                                                                            "pARAMETER",
                                                                                                            "rOW",
                                                                                                            "fIELD",
                                                                                                            "sYSTEM"
                                                                                                        ],
                                                                                                        "type": "object"
                                                                                                    },
                                                                                                    "type": "array"
                                                                                                }
                                                                                            },
                                                                                            "type": "object"
                                                                                        }
                                                                                    },
                                                                                    "type": "object"
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            },
                                                            "expression": "@body('Parse_JSON')?['data']?['WhereToLockUser']",
                                                            "type": "Switch"
                                                        }
                                                    },
                                                    "runAfter": {
                                                        "Parse_JSON": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "else": {
                                                        "actions": {
                                                            "Flag_false_positive": {
                                                                "type": "ApiConnection",
                                                                "inputs": {
                                                                    "body": {
                                                                        "classification": {
                                                                            "ClassificationAndReason": "FalsePositive - IncorrectAlertLogic",
                                                                            "ClassificationReasonText": "@body('Parse_JSON')?['data']?['flagComment']"
                                                                        },
                                                                        "incidentArmId": "@triggerBody()?['object']?['id']",
                                                                        "status": "Closed"
                                                                    },
                                                                    "host": {
                                                                        "connection": {
                                                                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                                        }
                                                                    },
                                                                    "method": "put",
                                                                    "path": "/Incidents"
                                                                }
                                                            }
                                                        }
                                                    },
                                                    "expression": {
                                                        "and": [
                                                            {
                                                                "equals": [
                                                                    "@body('Parse_JSON')?['submitActionId']",
                                                                    "block"
                                                                ]
                                                            }
                                                        ]
                                                    },
                                                    "type": "If"
                                                },
                                                "Parse_JSON": {
                                                    "runAfter": {
                                                        "Post_incident_as_adaptive_card_and_wait_for_a_response": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "ParseJson",
                                                    "inputs": {
                                                        "content": "@body('Post_incident_as_adaptive_card_and_wait_for_a_response')",
                                                        "schema": {
                                                            "properties": {
                                                                "data": {
                                                                    "properties": {
                                                                        "WhereToLockUser": {
                                                                            "type": "string"
                                                                        }
                                                                    },
                                                                    "type": "object"
                                                                },
                                                                "messageId": {
                                                                    "type": "string"
                                                                },
                                                                "messageLink": {
                                                                    "type": "string"
                                                                },
                                                                "responder": {
                                                                    "properties": {
                                                                        "displayName": {
                                                                            "type": "string"
                                                                        },
                                                                        "email": {
                                                                            "type": "string"
                                                                        },
                                                                        "objectId": {
                                                                            "type": "string"
                                                                        },
                                                                        "tenantId": {
                                                                            "type": "string"
                                                                        },
                                                                        "userPrincipalName": {
                                                                            "type": "string"
                                                                        }
                                                                    },
                                                                    "type": "object"
                                                                },
                                                                "responseTime": {
                                                                    "type": "string"
                                                                },
                                                                "submitActionId": {
                                                                    "type": "string"
                                                                }
                                                            },
                                                            "type": "object"
                                                        }
                                                    }
                                                },
                                                "Post_incident_as_adaptive_card_and_wait_for_a_response": {
                                                    "runAfter": {
                                                        "Send_SAP_incident_with_Microsoft_Teams_link_via_email": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "limit": {
                                                        "timeout": "PT1H"
                                                    },
                                                    "type": "ApiConnectionWebhook",
                                                    "inputs": {
                                                        "body": {
                                                            "body": {
                                                                "messageBody": "{\n    \"type\": \"AdaptiveCard\",\n    \"body\": [\n        {\n            \"type\": \"Container\",\n            \"style\": \"emphasis\",\n            \"items\": [\n                {\n                    \"type\": \"ColumnSet\",\n                    \"columns\": [\n                        {\n                            \"type\": \"Column\",\n                            \"items\": [\n                                {\n                                    \"type\": \"TextBlock\",\n                                    \"size\": \"Large\",\n                                    \"weight\": \"Bolder\",\n                                    \"text\": \"New incident from Azure Sentinel!\"\n                                }\n                            ],\n                            \"width\": \"stretch\"\n                        },\n                        {\n                            \"type\": \"Column\",\n                            \"width\": \"auto\",\n                            \"style\": \"attention\",\n                            \"items\": [\n                                {\n                                    \"type\": \"RichTextBlock\",\n                                    \"inlines\": [\n                                        {\n                                            \"type\": \"TextRun\",\n                                            \"text\": \"@{triggerBody()?['object']?['properties']?['severity']}\"\n                                        }\n                                    ]\n                                }\n                            ]\n                        }\n                    ]\n                },\n                {\n                    \"type\": \"TextBlock\",\n                    \"spacing\": \"Medium\",\n                    \"size\": \"Medium\",\n                    \"weight\": \"Bolder\",\n                    \"color\": \"Accent\",\n                    \"text\": \"@{triggerBody()?['object']?['properties']?['title']}\"\n                },\n                {\n                    \"type\": \"ActionSet\",\n                    \"actions\": [\n                        {\n                            \"type\": \"Action.OpenUrl\",\n                            \"title\": \"View incident\",\n                            \"url\": \"@{triggerBody()?['object']?['properties']?['incidentUrl']}\",\n                            \"id\": \"openSentinel\"\n                        }\n                    ]\n                }\n            ],\n            \"bleed\": true\n        },\n        {\n            \"type\": \"Container\",\n            \"items\": [\n                {\n                    \"type\": \"FactSet\",\n                    \"spacing\": \"Large\",\n                    \"facts\": [\n                        {\n                            \"title\": \"Creation time (UTC)\",\n                            \"value\": \"@{triggerBody()?['object']?['properties']?['createdTimeUtc']}\"\n                        },\n                        {\n                            \"title\": \"Tactics\",\n                            \"value\":\"@{variables('Sentinel-Tactics')}\"\n                        }\n                    ]\n                },\n                {\n                    \"type\": \"TextBlock\",\n                    \"text\": \"@{replace(replace(triggerBody()?['object']?['properties']?['description'],'\"','\\\"'),'\\\\','\\')}\",\n                    \"wrap\": true\n                }\n            ]\n        },\n        {\n            \"type\": \"Container\",\n            \"spacing\": \"Large\",\n            \"style\": \"emphasis\",\n            \"items\": [\n                {\n                    \"type\": \"TextBlock\",\n                    \"text\": \"Related Entities\",\n                    \"wrap\": true,\n                    \"separator\": true,\n                    \"fontType\": \"Default\",\n                    \"size\": \"Medium\",\n                    \"weight\": \"Bolder\"\n                },\n                {\n                    \"type\": \"ColumnSet\",\n                    \"columns\": @{outputs('Compose_dynamic_json_for_entities_table')}\n                }\n            ],\n            \"bleed\": true\n        }\n    ],\n    \"actions\": [\n        {\n            \"type\": \"Action.ShowCard\",\n            \"title\": \"Block User on...\",\n            \"style\": \"destructive\",\n            \"card\": {\n                \"type\": \"AdaptiveCard\",\n                \"body\": [\n                    {\n                        \"type\": \"Input.ChoiceSet\",\n                        \"id\": \"WhereToLockUser\",\n                        \"label\": \"On which system?\",\n                        \"style\": \"expanded\",\n                        \"choices\": [\n                            {\n                                \"title\": \"SAP ERP\",\n                                \"value\": \"erp\"\n                            },\n                            {\n                                \"title\": \"SAP BTP Cloud Identity Service\",\n                                \"value\": \"btp\"\n                            },\n                            {\n                                \"title\": \"Azure AD (globally)\",\n                                \"value\": \"aad\"\n                            }\n                        ],\n                        \"value\": \"erp\",\n                        \"isRequired\": true,\n                        \"errorMessage\": \"Given choice unknown!\"\n                    },\n                    {\n                        \"type\": \"Input.Text\",\n                        \"id\": \"blockComment\",\n                        \"placeholder\": \"Add a comment\",\n                        \"isMultiline\": true\n                    }\n                ],\n                \"actions\": [\n                    {\n                        \"type\": \"Action.Submit\",\n                        \"id\": \"block\",\n                        \"title\": \"Submit\"\n                    }\n                ],\n                \"$schema\": \"http://adaptivecards.io/schemas/adaptive-card.json\",\n                \"version\": \"1.4\"\n            }\n        },\n        {\n            \"type\": \"Action.ShowCard\",\n            \"title\": \"Flag as false positive\",\n            \"card\": {\n                \"type\": \"AdaptiveCard\",\n                \"body\": [\n                    {\n                        \"type\": \"Input.Text\",\n                        \"id\": \"flagComment\",\n                        \"placeholder\": \"Add a comment\",\n                        \"isMultiline\": true\n                    }\n                ],\n                \"actions\": [\n                    {\n                        \"type\": \"Action.Submit\",\n                        \"id\": \"flag\",\n                        \"title\": \"Submit\"\n                    }\n                ],\n                \"$schema\": \"http://adaptivecards.io/schemas/adaptive-card.json\",\n                \"version\": \"1.4\"\n            }\n        }\n    ],\n    \"$schema\": \"http://adaptivecards.io/schemas/adaptive-card.json\",\n    \"version\": \"1.4\",\n    \"fallbackText\": \"This card requires Adaptive Cards v1.4 support to be rendered properly.\"\n}",
                                                                "recipient": {
                                                                    "channelId": "@{variables('TeamsChannel')?['channelID']}",
                                                                    "groupId": "@{variables('TeamsChannel')?['teamID']}"
                                                                },
                                                                "updateMessage": "Thanks for keeping SAP on Azure secure!"
                                                            },
                                                            "notificationUrl": "@{listCallbackUrl()}"
                                                        },
                                                        "host": {
                                                            "connection": {
                                                                "name": "@parameters('$connections')['teams_1']['connectionId']"
                                                            }
                                                        },
                                                        "path": "/v1.0/teams/conversation/gatherinput/poster/Flow bot/location/@{encodeURIComponent('Channel')}/$subscriptions"
                                                    }
                                                },
                                                "Post_timeout_message_in_Channel": {
                                                    "runAfter": {
                                                        "Post_incident_as_adaptive_card_and_wait_for_a_response": [
                                                            "TimedOut",
                                                            "Skipped",
                                                            "Failed"
                                                        ]
                                                    },
                                                    "type": "ApiConnection",
                                                    "inputs": {
                                                        "body": {
                                                            "messageBody": "<p>Incident notification timed out after 1h!&nbsp;</p>",
                                                            "recipient": {
                                                                "channelId": "@{variables('TeamsChannel')?['channelID']}",
                                                                "groupId": "@{variables('TeamsChannel')?['teamID']}"
                                                            }
                                                        },
                                                        "host": {
                                                            "connection": {
                                                                "name": "@parameters('$connections')['teams_1']['connectionId']"
                                                            }
                                                        },
                                                        "method": "post",
                                                        "path": "/beta/teams/conversation/message/poster/Flow bot/location/@{encodeURIComponent('Channel')}"
                                                    }
                                                },
                                                "Send_SAP_incident_with_Microsoft_Teams_link_via_email": {
                                                    "type": "ApiConnection",
                                                    "inputs": {
                                                        "body": {
                                                            "Body": "<p>@{variables('email-body')}</p>",
                                                            "Cc": "@variables('account')",
                                                            "Importance": "High",
                                                            "Subject": "@{triggerBody()?['object']?['properties']?['title']}, block SAP user @{variables('SAP_User')}?",
                                                            "To": "@variables('DefaultAdminEmail')"
                                                        },
                                                        "host": {
                                                            "connection": {
                                                                "name": "@parameters('$connections')['office365']['connectionId']"
                                                            }
                                                        },
                                                        "method": "post",
                                                        "path": "/v2/Mail"
                                                    }
                                                }
                                            },
                                            "runAfter": {
                                                "Payload_parsing_Scope": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "Scope"
                                        },
                                        "Initialize_Custom_Details_JSON_string": {
                                            "type": "InitializeVariable",
                                            "inputs": {
                                                "variables": [
                                                    {
                                                        "name": "custom-details-json-string",
                                                        "type": "string",
                                                        "value": "@{replace(replace(replace(replace(triggerBody()?['object']?['properties']?['alerts'][0]?['properties']?['additionalData']?['Custom Details'],'}\"','}'),'\"{','{'),'\\',''),'\"}]}','}]}')}"
                                                    }
                                                ]
                                            }
                                        },
                                        "Initialize_Entities__Kind_for_dynamic_json": {
                                            "runAfter": {
                                                "Initialize_base_path_from_query": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "InitializeVariable",
                                            "inputs": {
                                                "variables": [
                                                    {
                                                        "name": "entitiesKindArray",
                                                        "type": "array"
                                                    }
                                                ]
                                            }
                                        },
                                        "Initialize_Entities__Name_for_dynamic_json": {
                                            "runAfter": {
                                                "Initialize_Entities__Kind_for_dynamic_json": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "InitializeVariable",
                                            "inputs": {
                                                "variables": [
                                                    {
                                                        "name": "entitiesNameArray",
                                                        "type": "array"
                                                    }
                                                ]
                                            }
                                        },
                                        "Initialize_SAPClientId_variable": {
                                            "runAfter": {
                                                "Initialize_SID_variable": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "InitializeVariable",
                                            "inputs": {
                                                "variables": [
                                                    {
                                                        "name": "sap-client-id",
                                                        "type": "string"
                                                    }
                                                ]
                                            }
                                        },
                                        "Initialize_SAP_user_to_be_locked": {
                                            "runAfter": {
                                                "Initialize_account_variable": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "InitializeVariable",
                                            "inputs": {
                                                "variables": [
                                                    {
                                                        "name": "SAP_User",
                                                        "type": "string"
                                                    }
                                                ]
                                            }
                                        },
                                        "Initialize_SID_variable": {
                                            "runAfter": {
                                                "Initialize_default_admin_email": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "InitializeVariable",
                                            "inputs": {
                                                "variables": [
                                                    {
                                                        "name": "SID",
                                                        "type": "string"
                                                    }
                                                ]
                                            }
                                        },
                                        "Initialize_account_variable": {
                                            "runAfter": {
                                                "Initialize_SAPClientId_variable": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "InitializeVariable",
                                            "inputs": {
                                                "variables": [
                                                    {
                                                        "name": "account",
                                                        "type": "string"
                                                    }
                                                ]
                                            }
                                        },
                                        "Initialize_actionable_message_for_outlook": {
                                            "runAfter": {
                                                "Initialize_Entities__Name_for_dynamic_json": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "InitializeVariable",
                                            "inputs": {
                                                "variables": [
                                                    {
                                                        "name": "adaptiveCard",
                                                        "type": "string"
                                                    }
                                                ]
                                            }
                                        },
                                        "Initialize_base_path_from_query": {
                                            "runAfter": {
                                                "Initialize_SAP_user_to_be_locked": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "InitializeVariable",
                                            "inputs": {
                                                "variables": [
                                                    {
                                                        "name": "basePath",
                                                        "type": "string"
                                                    }
                                                ]
                                            }
                                        },
                                        "Initialize_default_admin_email": {
                                            "runAfter": {
                                                "Initialize_target_TeamsChannel": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "InitializeVariable",
                                            "inputs": {
                                                "variables": [
                                                    {
                                                        "name": "DefaultAdminEmail",
                                                        "type": "string",
                                                        "value": "@parameters('DefaultAdminEmail')"
                                                    }
                                                ]
                                            }
                                        },
                                        "Initialize_email_body": {
                                            "runAfter": {
                                                "Initialize_actionable_message_for_outlook": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "InitializeVariable",
                                            "inputs": {
                                                "variables": [
                                                    {
                                                        "name": "email-body",
                                                        "type": "string"
                                                    }
                                                ]
                                            }
                                        },
                                        "Initialize_sentinel_incident_tactics_for_adaptive_card": {
                                            "runAfter": {
                                                "Initialize_email_body": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "InitializeVariable",
                                            "inputs": {
                                                "variables": [
                                                    {
                                                        "name": "Sentinel-Tactics",
                                                        "type": "string",
                                                        "value": "@{replace(replace(replace(string(triggerBody()?['object']?['properties']?['additionalData']?['tactics']),'[',''),']',''),'\"','')}"
                                                    }
                                                ]
                                            }
                                        },
                                        "Initialize_target_TeamsChannel": {
                                            "runAfter": {
                                                "Initialize_Custom_Details_JSON_string": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "InitializeVariable",
                                            "inputs": {
                                                "variables": [
                                                    {
                                                        "name": "TeamsChannel",
                                                        "type": "object",
                                                        "value": "@parameters('TeamsChannel')"
                                                    }
                                                ]
                                            }
                                        },
                                        "Payload_parsing_Scope": {
                                            "actions": {
                                                "Compose_dynamic_json_for_entities_table": {
                                                    "runAfter": {
                                                        "Iterate_related_incident_entities": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "Compose",
                                                    "inputs": [
                                                        {
                                                            "items": "@variables('entitiesKindArray')",
                                                            "type": "Column",
                                                            "width": 40
                                                        },
                                                        {
                                                            "items": "@variables('entitiesNameArray')",
                                                            "type": "Column",
                                                            "width": 60
                                                        }
                                                    ]
                                                },
                                                "Iterate_related_incident_entities": {
                                                    "foreach": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                                                    "actions": {
                                                        "Append_to_kind_array": {
                                                            "type": "AppendToArrayVariable",
                                                            "inputs": {
                                                                "name": "entitiesKindArray",
                                                                "value": {
                                                                    "text": "@{items('Iterate_related_Incident_entities')?['kind']}",
                                                                    "type": "TextBlock",
                                                                    "weight": "Default"
                                                                }
                                                            }
                                                        },
                                                        "Append_to_name_array": {
                                                            "runAfter": {
                                                                "Append_to_kind_array": [
                                                                    "Succeeded"
                                                                ]
                                                            },
                                                            "type": "AppendToArrayVariable",
                                                            "inputs": {
                                                                "name": "entitiesNameArray",
                                                                "value": {
                                                                    "text": "@{items('Iterate_related_incident_entities')?['properties']?['friendlyName']}",
                                                                    "type": "TextBlock",
                                                                    "weight": "Default"
                                                                }
                                                            }
                                                        }
                                                    },
                                                    "runAfter": {
                                                        "Select_base_path_from_query": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "Foreach",
                                                    "runtimeConfiguration": {
                                                        "concurrency": {
                                                            "repetitions": 1
                                                        }
                                                    }
                                                },
                                                "Parse_Incident_Custom_Details": {
                                                    "runAfter": {
                                                        "Select_related_entities": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "ParseJson",
                                                    "inputs": {
                                                        "content": "@variables('custom-details-json-string')",
                                                        "schema": {
                                                            "properties": {
                                                                "AuditClassID": {
                                                                    "items": {
                                                                        "type": "string"
                                                                    },
                                                                    "type": "array"
                                                                },
                                                                "BagOfDetails": {
                                                                    "items": {
                                                                        "properties": {
                                                                            "DestinationEmail": {
                                                                                "type": "string"
                                                                            },
                                                                            "MessageID": {
                                                                                "type": "string"
                                                                            },
                                                                            "Severity": {
                                                                                "type": "string"
                                                                            },
                                                                            "SystemID": {
                                                                                "type": "string"
                                                                            },
                                                                            "Tactics": {
                                                                                "type": "string"
                                                                            },
                                                                            "TeamsChannelID": {
                                                                                "properties": {
                                                                                    "channelID": {
                                                                                        "type": "string"
                                                                                    },
                                                                                    "teamID": {
                                                                                        "type": "string"
                                                                                    }
                                                                                },
                                                                                "type": "object"
                                                                            }
                                                                        },
                                                                        "required": [
                                                                            "MessageID",
                                                                            "Tactics",
                                                                            "SystemID",
                                                                            "Severity",
                                                                            "DestinationEmail",
                                                                            "TeamsChannelID"
                                                                        ],
                                                                        "type": "object"
                                                                    },
                                                                    "type": "array"
                                                                },
                                                                "DestinationEmail": {
                                                                    "items": {
                                                                        "type": "string"
                                                                    },
                                                                    "type": "array"
                                                                },
                                                                "IsProductionEnv": {
                                                                    "items": {
                                                                        "type": "string"
                                                                    },
                                                                    "type": "array"
                                                                },
                                                                "SAPAuditLogMessageID": {
                                                                    "items": {
                                                                        "type": "string"
                                                                    },
                                                                    "type": "array"
                                                                },
                                                                "SAPProcessType": {
                                                                    "items": {
                                                                        "type": "string"
                                                                    },
                                                                    "type": "array"
                                                                },
                                                                "SAPUser": {
                                                                    "items": {
                                                                        "type": "string"
                                                                    },
                                                                    "type": "array"
                                                                },
                                                                "SystemRole": {
                                                                    "items": {
                                                                        "type": "string"
                                                                    },
                                                                    "type": "array"
                                                                },
                                                                "SystemUsage": {
                                                                    "items": {
                                                                        "type": "string"
                                                                    },
                                                                    "type": "array"
                                                                },
                                                                "TeamsChannelID": {
                                                                    "items": {
                                                                        "properties": {
                                                                            "channelID": {
                                                                                "type": "string"
                                                                            },
                                                                            "teamID": {
                                                                                "type": "string"
                                                                            }
                                                                        },
                                                                        "required": [
                                                                            "teamID",
                                                                            "channelID"
                                                                        ],
                                                                        "type": "object"
                                                                    },
                                                                    "type": "array"
                                                                }
                                                            },
                                                            "type": "object"
                                                        }
                                                    }
                                                },
                                                "Run_query_to_select_sap_basepath": {
                                                    "runAfter": {
                                                        "Set_SAP_user_to_be_locked": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "ApiConnection",
                                                    "inputs": {
                                                        "body": "SAPSystems(SelectedSystems='@{variables('SID')}')| project tostring(todynamic(InterfaceAttributes).BasePath)",
                                                        "host": {
                                                            "connection": {
                                                                "name": "@parameters('$connections')['azuremonitorlogs']['connectionId']"
                                                            }
                                                        },
                                                        "method": "post",
                                                        "path": "/queryData",
                                                        "queries": {
                                                            "resourcegroups": "@triggerBody()?['workspaceInfo']?['ResourceGroupName']",
                                                            "resourcename": "@triggerBody()?['workspaceInfo']?['WorkspaceName']",
                                                            "resourcetype": "Log Analytics Workspace",
                                                            "subscriptions": "@triggerBody()?['workspaceInfo']?['SubscriptionId']",
                                                            "timerange": "Last 24 hours"
                                                        }
                                                    }
                                                },
                                                "Select_base_path_from_query": {
                                                    "runAfter": {
                                                        "Run_query_to_select_sap_basepath": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "SetVariable",
                                                    "inputs": {
                                                        "name": "basePath",
                                                        "value": "@{body('Run_query_to_select_sap_basepath')?['value'][0]?['InterfaceAttributes_BasePath']}"
                                                    }
                                                },
                                                "Select_entities": {
                                                    "runAfter": {
                                                        "Parse_Incident_Custom_Details": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "Select",
                                                    "inputs": {
                                                        "from": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                                                        "select": {
                                                            "entity": "@item()?['properties']?['friendlyName']",
                                                            "entity-type": "@item()?['kind']"
                                                        }
                                                    }
                                                },
                                                "Select_related_entities": {
                                                    "foreach": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                                                    "actions": {
                                                        "Switch": {
                                                            "cases": {
                                                                "Case": {
                                                                    "case": "CloudApplication",
                                                                    "actions": {
                                                                        "Select_SID_from_Incident": {
                                                                            "type": "SetVariable",
                                                                            "inputs": {
                                                                                "name": "SID",
                                                                                "value": "@{items('Select_related_entities')?['properties']?['friendlyName']}"
                                                                            }
                                                                        },
                                                                        "Set_SAP_client_id": {
                                                                            "runAfter": {
                                                                                "Select_SID_from_Incident": [
                                                                                    "Succeeded"
                                                                                ]
                                                                            },
                                                                            "type": "SetVariable",
                                                                            "inputs": {
                                                                                "name": "sap-client-id",
                                                                                "value": "@{string(formatNumber(items('Select_related_entities')?['properties']?['appId'],'000'))}"
                                                                            }
                                                                        }
                                                                    }
                                                                },
                                                                "Case_2": {
                                                                    "case": "Account",
                                                                    "actions": {
                                                                        "Set_account_from_incident": {
                                                                            "type": "SetVariable",
                                                                            "inputs": {
                                                                                "name": "account",
                                                                                "value": "@{items('Select_related_entities')?['properties']?['friendlyName']}"
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            },
                                                            "expression": "@items('Select_related_entities')?['kind']",
                                                            "type": "Switch"
                                                        }
                                                    },
                                                    "type": "Foreach",
                                                    "runtimeConfiguration": {
                                                        "concurrency": {
                                                            "repetitions": 2
                                                        }
                                                    }
                                                },
                                                "Set_SAP_user_to_be_locked": {
                                                    "runAfter": {
                                                        "Select_entities": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "SetVariable",
                                                    "inputs": {
                                                        "name": "SAP_User",
                                                        "value": "@{body('Parse_Incident_Custom_Details')?['SAP_User'][0]}"
                                                    }
                                                },
                                                "Set_actionable_message_for_outlook": {
                                                    "runAfter": {
                                                        "Compose_dynamic_json_for_entities_table": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "SetVariable",
                                                    "inputs": {
                                                        "name": "adaptiveCard",
                                                        "value": "{\n    \"type\": \"AdaptiveCard\",\n    \"body\": [\n        {\n            \"type\": \"Container\",\n            \"style\": \"emphasis\",\n            \"items\": [\n                {\n                    \"type\": \"ColumnSet\",\n                    \"columns\": [\n                        {\n                            \"type\": \"Column\",\n                            \"items\": [\n                                {\n                                    \"type\": \"TextBlock\",\n                                    \"size\": \"large\",\n                                    \"weight\": \"bolder\",\n                                    \"text\": \"New incident from Azure Sentinel!\"\n                                }\n                            ],\n                            \"width\": \"stretch\"\n                        },\n                        {\n                            \"type\": \"Column\",\n                            \"width\": \"auto\",\n                            \"style\": \"attention\",\n                            \"items\": [\n                                {\n                                    \"type\": \"TextBlock\",\n                                    \"text\": \"@{triggerBody()?['object']?['properties']?['severity']}\"\n                                }\n                            ]\n                        }\n                    ]\n                },\n                {\n                    \"type\": \"TextBlock\",\n                    \"spacing\": \"Medium\",\n                    \"size\": \"Medium\",\n                    \"weight\": \"Bolder\",\n                    \"color\": \"Accent\",\n                    \"text\": \"@{triggerBody()?['object']?['properties']?['title']}\"\n                },\n                {\n                    \"type\": \"ActionSet\",\n                    \"actions\": [\n                        {\n                            \"type\": \"Action.OpenUrl\",\n                            \"title\": \"Navigate to Microsoft Teams to act\",\n                            \"url\": \"https://teams.microsoft.com/l/channel/19%3afebede5de91d4198bd0f75be9047d029%40thread.tacv2/Notifications?groupId=f812e2e3-8e37-475a-9d82-3d7297e9ead1&tenantId=72f988bf-86f1-41af-91ab-2d7cd011db47\",\n                            \"id\": \"openTeamsChannel\"\n                        }\n                    ]\n                }\n            ],\n            \"bleed\": true\n        },\n        {\n            \"type\": \"Container\",\n            \"items\": [\n                {\n                    \"type\": \"FactSet\",\n                    \"spacing\": \"Large\",\n                    \"facts\": [\n                        {\n                            \"title\": \"Creation time\",\n                            \"value\": \"@{triggerBody()?['object']?['properties']?['createdTimeUtc']}\"\n                        },\n                        {\n                            \"title\": \"Tactics\",\n                            \"value\": @{variables('Sentinel-Tactics')}\n                        }\n                    ]\n                },\n                {\n                    \"type\": \"TextBlock\",\n                    \"text\": \"@{replace(replace(triggerBody()?['object']?['properties']?['description'],'\"','\\\"'),'\\\\','\\')}\",\n                    \"wrap\": true\n                }\n            ]\n        },\n        {\n            \"type\": \"Container\",\n            \"spacing\": \"Large\",\n            \"style\": \"emphasis\",\n            \"items\": [\n                {\n                    \"type\": \"TextBlock\",\n                    \"text\": \"Related Entities\",\n                    \"wrap\": true,\n                    \"separator\": true,\n                    \"fontType\": \"Default\",\n                    \"size\": \"Medium\",\n                    \"weight\": \"Bolder\"\n                },\n                {\n                    \"type\": \"ColumnSet\",\n                    \"columns\": @{outputs('Compose_dynamic_json_for_entities_table')}\n                }\n            ],\n            \"bleed\": true\n        }\n    ],\n    \"$schema\": \"http://adaptivecards.io/schemas/adaptive-card.json\",\n    \"version\": \"1.4\",\n    \"fallbackText\": \"This card requires Adaptive Cards v1.4 support to be rendered properly.\"\n}"
                                                    }
                                                },
                                                "Set_email_body": {
                                                    "runAfter": {
                                                        "Set_actionable_message_for_outlook": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "SetVariable",
                                                    "inputs": {
                                                        "name": "email-body",
                                                        "value": "<html>\n<head>\n  <meta http-equiv=\"Content-Type\" content=\"text/html; charset=utf-8\">\n<script type=\"application/adaptivecard+json\">\n@{variables('adaptiveCard')}\n</script>\n</head>\n<body>\nVisit the <a href=\"https://learn.microsoft.com/outlook/actionable-messages\">Outlook Dev Portal</a> to learn more about Actionable Messages.\n</body>\n</html>"
                                                    }
                                                }
                                            },
                                            "runAfter": {
                                                "Initialize_sentinel_incident_tactics_for_adaptive_card": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "Scope"
                                        },
                                        "Post_parsing_error_message_to_Logic_App_admin": {
                                            "runAfter": {
                                                "Payload_parsing_Scope": [
                                                    "Failed",
                                                    "Skipped",
                                                    "TimedOut"
                                                ]
                                            },
                                            "type": "ApiConnection",
                                            "inputs": {
                                                "body": {
                                                    "isAlert": true,
                                                    "messageBody": "<p>Sentinel SAP Incident parsing failed or timed out (after 1h)! Please verify your logic and process the incident from Sentinel manually till resolved.</p>",
                                                    "recipient": "admin@contoso.com"
                                                },
                                                "host": {
                                                    "connection": {
                                                        "name": "@parameters('$connections')['teams_1']['connectionId']"
                                                    }
                                                },
                                                "method": "post",
                                                "path": "/beta/teams/conversation/message/poster/Flow bot/location/@{encodeURIComponent('Chat with Flow bot')}"
                                            }
                                        },
                                        "Post_processing_error_message_to_Logic_App_admin": {
                                            "runAfter": {
                                                "Incident_response_Scope": [
                                                    "Failed",
                                                    "Skipped",
                                                    "TimedOut"
                                                ]
                                            },
                                            "type": "ApiConnection",
                                            "inputs": {
                                                "body": {
                                                    "isAlert": true,
                                                    "messageBody": "<p>Sentinel SAP Incident workflow action failed! Please verify your logic and process the incident from Sentinel manually till resolved.<br>\n<br>\n<a href=\"https://portal.azure.com/\">Link</a>&nbsp;</p>",
                                                    "recipient": "@variables('DefaultAdminEmail')"
                                                },
                                                "host": {
                                                    "connection": {
                                                        "name": "@parameters('$connections')['teams_1']['connectionId']"
                                                    }
                                                },
                                                "method": "post",
                                                "path": "/beta/teams/conversation/message/poster/Flow bot/location/@{encodeURIComponent('Chat with Flow bot')}"
                                            }
                                        },
                                        "Terminate": {
                                            "runAfter": {
                                                "Incident_response_Scope": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "Terminate",
                                            "inputs": {
                                                "runStatus": "Succeeded"
                                            }
                                        }
                                    }
                                },
                                "parameters": {
                                    "$connections": {
                                        "value": {
                                            "azuread": {
                                                "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureadConnectionName'))]",
                                                "connectionName": "[[variables('AzureadConnectionName')]",
                                                "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Azuread')]"
                                            },
                                            "azuremonitorlogs": {
                                                "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzuremonitorlogsConnectionName'))]",
                                                "connectionName": "[[variables('AzuremonitorlogsConnectionName')]",
                                                "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Azuremonitorlogs')]"
                                            },
                                            "azuresentinel": {
                                                "connectionId": "[[resourceId('Microsoft.Web/connections', variables('MicrosoftSentinelConnectionName'))]",
                                                "connectionName": "[[variables('MicrosoftSentinelConnectionName')]",
                                                "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Azuresentinel')]",
                                                "connectionProperties": {
                                                    "authentication": {
                                                        "type": "ManagedServiceIdentity"
                                                    }
                                                }
                                            },
                                            "keyvault_2": {
                                                "connectionId": "[[resourceId('Microsoft.Web/connections', variables('KeyvaultConnectionName'))]",
                                                "connectionName": "[[variables('KeyvaultConnectionName')]",
                                                "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Keyvault')]"
                                            },
                                            "office365": {
                                                "connectionId": "[[resourceId('Microsoft.Web/connections', variables('Office365ConnectionName'))]",
                                                "connectionName": "[[variables('Office365ConnectionName')]",
                                                "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Office365')]"
                                            },
                                            "teams_1": {
                                                "connectionId": "[[resourceId('Microsoft.Web/connections', variables('TeamsConnectionName'))]",
                                                "connectionName": "[[variables('TeamsConnectionName')]",
                                                "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Teams')]"
                                            }
                                        }
                                    }
                                }
                            },
                            "name": "[[parameters('PlaybookName')]",
                            "type": "Microsoft.Logic/workflows",
                            "location": "[[variables('workspace-location-inline')]",
                            "identity": {
                                "type": "SystemAssigned"
                            },
                            "apiVersion": "2017-07-01",
                            "dependsOn": [
                                "[[resourceId('Microsoft.Web/connections', variables('AzureadConnectionName'))]",
                                "[[resourceId('Microsoft.Web/connections', variables('AzuremonitorlogsConnectionName'))]",
                                "[[resourceId('Microsoft.Web/connections', variables('MicrosoftSentinelConnectionName'))]",
                                "[[resourceId('Microsoft.Web/connections', variables('KeyvaultConnectionName'))]",
                                "[[resourceId('Microsoft.Web/connections', variables('Office365ConnectionName'))]",
                                "[[resourceId('Microsoft.Web/connections', variables('TeamsConnectionName'))]"
                            ],
                            "tags": {
                                "hidden-SentinelTemplateVersion": "2.0.65",
                                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
                            }
                        },
                        {
                            "type": "Microsoft.Web/connections",
                            "apiVersion": "2016-06-01",
                            "name": "[[variables('AzureadConnectionName')]",
                            "location": "[[variables('workspace-location-inline')]",
                            "kind": "V1",
                            "properties": {
                                "displayName": "[[variables('AzureadConnectionName')]",
                                "api": {
                                    "id": "[[variables('_connection-2')]"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.Web/connections",
                            "apiVersion": "2016-06-01",
                            "name": "[[variables('AzuremonitorlogsConnectionName')]",
                            "location": "[[variables('workspace-location-inline')]",
                            "kind": "V1",
                            "properties": {
                                "displayName": "[[variables('AzuremonitorlogsConnectionName')]",
                                "api": {
                                    "id": "[[variables('_connection-3')]"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.Web/connections",
                            "apiVersion": "2016-06-01",
                            "name": "[[variables('MicrosoftSentinelConnectionName')]",
                            "location": "[[variables('workspace-location-inline')]",
                            "kind": "V1",
                            "properties": {
                                "displayName": "[[variables('MicrosoftSentinelConnectionName')]",
                                "parameterValueType": "Alternative",
                                "api": {
                                    "id": "[[variables('_connection-4')]"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.Web/connections",
                            "apiVersion": "2016-06-01",
                            "name": "[[variables('KeyvaultConnectionName')]",
                            "location": "[[variables('workspace-location-inline')]",
                            "kind": "V1",
                            "properties": {
                                "displayName": "[[variables('KeyvaultConnectionName')]",
                                "api": {
                                    "id": "[[variables('_connection-5')]"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.Web/connections",
                            "apiVersion": "2016-06-01",
                            "name": "[[variables('Office365ConnectionName')]",
                            "location": "[[variables('workspace-location-inline')]",
                            "kind": "V1",
                            "properties": {
                                "displayName": "[[variables('Office365ConnectionName')]",
                                "api": {
                                    "id": "[[variables('_connection-6')]"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.Web/connections",
                            "apiVersion": "2016-06-01",
                            "name": "[[variables('TeamsConnectionName')]",
                            "location": "[[variables('workspace-location-inline')]",
                            "kind": "V1",
                            "properties": {
                                "displayName": "[[variables('TeamsConnectionName')]",
                                "api": {
                                    "id": "[[variables('_connection-7')]"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId1'),'/'))))]",
                            "properties": {
                                "parentId": "[variables('playbookId1')]",
                                "contentId": "[variables('_playbookContentId1')]",
                                "kind": "Playbook",
                                "version": "[variables('playbookVersion1')]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SAP",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ],
                    "metadata": {
                        "title": "SAP Incident Response- lock User from Teams- Advanced",
                        "description": "This Playbook provides the automation for the SAP incidents. It allows for automatically pop a Teams message or an email to the user to notify them of the incident. It also allows for the user to be blocked on AAD or SAP, for the incident to be closed. The same functionality is also offered in a standard logic app, which allows enterprise features such as private VNet injection, tenant isolation and more. See [SAP automation scenarios on GitHub](https://github.com/Azure/Azure-Sentinel/blob/master/Solutions/SAP/Playbooks/README.md) for more information.",
                        "prerequisites": [
                            "1. Update your SAP alert rules to the latest version.",
                            "2. Assign the relevant Teams or email addresses to be used as responders.",
                            "3. Optional- set your SAP system to allow user locking from Sentinel, See more details at https://aka.ms/sentinel4sapintro."
                        ],
                        "postDeployment": [
                            "1. Once deployment is complete, you will need to authorize each connection.",
                            "2. Navigate to playbook --> API Connections --> Select connections one by one --> Edit API Connection --> (if required) Enter API key or credentials --> Save"
                        ],
                        "lastUpdateTime": "2023-05-17T00:00:00Z",
                        "entities": [
                            "ip",
                            "Account"
                        ],
                        "tags": [
                            "workflow",
                            "SAP",
                            "Active directory",
                            "SAP User",
                            "Block SAP User",
                            "Block AD User"
                        ],
                        "releaseNotes": {
                            "version": "2.0.65",
                            "title": "[variables('blanks')]",
                            "notes": [
                                "Initial version"
                            ]
                        }
                    }
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('_playbookContentId1')]",
                "contentKind": "Playbook",
                "displayName": "SAPLockUser-Advanced",
                "contentProductId": "[variables('_playbookcontentProductId1')]",
                "id": "[variables('_playbookcontentProductId1')]",
                "version": "[variables('playbookVersion1')]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('playbookTemplateSpecName2')]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAPLockUser-Basic Playbook with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('playbookVersion2')]",
                    "parameters": {
                        "PlaybookName": {
                            "defaultValue": "SAPLockUser-Basic",
                            "type": "string"
                        },
                        "DefaultEmail": {
                            "type": "string",
                            "metadata": {
                                "description": "Enter value for DefaultEmail"
                            }
                        },
                        "SAP-SOAP-User-Password": {
                            "type": "string",
                            "metadata": {
                                "description": "Enter value for SAP-SOAP-User-Password"
                            }
                        },
                        "SAP-SOAP-Username": {
                            "type": "string",
                            "metadata": {
                                "description": "Enter value for SAP-SOAP-Username"
                            }
                        },
                        "SOAPApiBasePath": {
                            "type": "string",
                            "metadata": {
                                "description": "Enter value for SOAPApiBasePath"
                            }
                        },
                        "TeamsChannel": {
                            "type": "string",
                            "metadata": {
                                "description": "Enter value for TeamsChannel"
                            }
                        }
                    },
                    "variables": {
                        "MicrosoftSentinelConnectionName": "[[concat('MicrosoftSentinel-', parameters('PlaybookName'))]",
                        "TeamsConnectionName": "[[concat('Teams-', parameters('PlaybookName'))]",
                        "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Azuresentinel')]",
                        "_connection-2": "[[variables('connection-2')]",
                        "connection-3": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Teams')]",
                        "_connection-3": "[[variables('connection-3')]",
                        "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
                        "workspace-name": "[parameters('workspace')]",
                        "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
                    },
                    "resources": [
                        {
                            "properties": {
                                "provisioningState": "Succeeded",
                                "state": "Enabled",
                                "definition": {
                                    "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                                    "contentVersion": "1.0.0.0",
                                    "parameters": {
                                        "$connections": {
                                            "type": "Object"
                                        },
                                        "DefaultEmail": {
                                            "type": "string",
                                            "defaultValue": "[[parameters('DefaultEmail')]"
                                        },
                                        "SAP-SOAP-User-Password": {
                                            "type": "string",
                                            "defaultValue": "[[parameters('SAP-SOAP-User-Password')]"
                                        },
                                        "SAP-SOAP-Username": {
                                            "type": "string",
                                            "defaultValue": "[[parameters('SAP-SOAP-Username')]"
                                        },
                                        "SOAPApiBasePath": {
                                            "type": "string",
                                            "defaultValue": "[[parameters('SOAPApiBasePath')]"
                                        },
                                        "TeamsChannel": {
                                            "type": "string",
                                            "defaultValue": "[[parameters('TeamsChannel')]"
                                        }
                                    },
                                    "triggers": {
                                        "Microsoft_Sentinel_incident": {
                                            "type": "ApiConnectionWebhook",
                                            "inputs": {
                                                "body": {
                                                    "callback_url": "@{listCallbackUrl()}"
                                                },
                                                "host": {
                                                    "connection": {
                                                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                    }
                                                },
                                                "path": "/incident-creation"
                                            }
                                        }
                                    },
                                    "actions": {
                                        "Incident_response_Scope": {
                                            "actions": {
                                                "Condition_block_or_flag": {
                                                    "actions": {
                                                        "Switch_lock_target_environment": {
                                                            "cases": {
                                                                "Case_AAD": {
                                                                    "case": "aad",
                                                                    "actions": {
                                                                        "Reply_with_a_message_in_a_channel": {
                                                                            "type": "ApiConnection",
                                                                            "inputs": {
                                                                                "body": {
                                                                                    "messageBody": "<p>Account @{variables('account')} would be disabled on Azure AD! Add connector for Azure AD task \"Update user\" to the playbook.</p>",
                                                                                    "parentMessageId": "@body('Parse_JSON')?['messageId']",
                                                                                    "recipient": {
                                                                                        "channelId": "@{variables('TeamsChannel')?['channelID']}",
                                                                                        "groupId": "@{variables('TeamsChannel')?['teamID']}"
                                                                                    }
                                                                                },
                                                                                "host": {
                                                                                    "connection": {
                                                                                        "name": "@parameters('$connections')['teams_1']['connectionId']"
                                                                                    }
                                                                                },
                                                                                "method": "post",
                                                                                "path": "/v1.0/teams/conversation/replyWithMessage/poster/Flow bot/location/@{encodeURIComponent('Channel')}"
                                                                            }
                                                                        }
                                                                    }
                                                                },
                                                                "Case_BTP": {
                                                                    "case": "btp",
                                                                    "actions": {
                                                                        "Reply_with_a_message_in_a_channel_2": {
                                                                            "type": "ApiConnection",
                                                                            "inputs": {
                                                                                "body": {
                                                                                    "messageBody": "<p>Implement SAP REST interfaces with SAP IAS or OAuth2 flow to lock users on XSUAA with property \"active:false\". See advanced version of this playbook as a blueprint.</p>",
                                                                                    "parentMessageId": "@body('Parse_JSON')?['messageId']",
                                                                                    "recipient": {
                                                                                        "channelId": "@{variables('TeamsChannel')?['channelID']}",
                                                                                        "groupId": "@{variables('TeamsChannel')?['teamID']}"
                                                                                    }
                                                                                },
                                                                                "host": {
                                                                                    "connection": {
                                                                                        "name": "@parameters('$connections')['teams_1']['connectionId']"
                                                                                    }
                                                                                },
                                                                                "method": "post",
                                                                                "path": "/v1.0/teams/conversation/replyWithMessage/poster/Flow bot/location/@{encodeURIComponent('Channel')}"
                                                                            }
                                                                        }
                                                                    }
                                                                },
                                                                "Case_ERP": {
                                                                    "case": "erp",
                                                                    "actions": {
                                                                        "Block_User_via_SOAP_exposed_BAPI": {
                                                                            "type": "Http",
                                                                            "inputs": {
                                                                                "authentication": {
                                                                                    "password": "@parameters('SAP-SOAP-User-Password')",
                                                                                    "type": "Basic",
                                                                                    "username": "@parameters('SAP-SOAP-Username')"
                                                                                },
                                                                                "body": {
                                                                                    "bAPI_USER_LOCK": {
                                                                                        "uSERNAME": "@{variables('SAP_User')}"
                                                                                    }
                                                                                },
                                                                                "headers": {
                                                                                    "Content-Type": "application/json"
                                                                                },
                                                                                "method": "POST",
                                                                                "uri": "@{parameters('SOAPApiBasePath')}lockme/sap-com:document:sap:rfc:functions:ZWS_BAPI_USER_LOCK:BAPI_USER_LOCKRequest?sap-client=@{variables('sap-client-id')}"
                                                                            }
                                                                        },
                                                                        "Condition_SOAP_success": {
                                                                            "actions": {
                                                                                "Close_Sentinel_incident": {
                                                                                    "runAfter": {
                                                                                        "Notify_impacted_colleague_working_with_SAP": [
                                                                                            "Succeeded"
                                                                                        ]
                                                                                    },
                                                                                    "type": "ApiConnection",
                                                                                    "inputs": {
                                                                                        "body": {
                                                                                            "classification": {
                                                                                                "ClassificationAndReason": "TruePositive - SuspiciousActivity",
                                                                                                "ClassificationReasonText": "@{body('Parse_JSON')?['data']?['blockComment']}"
                                                                                            },
                                                                                            "incidentArmId": "@triggerBody()?['object']?['id']",
                                                                                            "status": "Closed"
                                                                                        },
                                                                                        "host": {
                                                                                            "connection": {
                                                                                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                                                            }
                                                                                        },
                                                                                        "method": "put",
                                                                                        "path": "/Incidents"
                                                                                    }
                                                                                },
                                                                                "Notify_impacted_colleague_working_with_SAP": {
                                                                                    "runAfter": {
                                                                                        "Reply_with_SAP_lock_message_in_channel": [
                                                                                            "Succeeded"
                                                                                        ]
                                                                                    },
                                                                                    "type": "ApiConnection",
                                                                                    "inputs": {
                                                                                        "body": {
                                                                                            "messageBody": "<p>Your SAP user in System @{variables('SID')} has been locked due to a security signal! Please reach out to your SAP Basis colleagues for further info.</p>",
                                                                                            "recipient": "@variables('account')"
                                                                                        },
                                                                                        "host": {
                                                                                            "connection": {
                                                                                                "name": "@parameters('$connections')['teams_1']['connectionId']"
                                                                                            }
                                                                                        },
                                                                                        "method": "post",
                                                                                        "path": "/beta/teams/conversation/message/poster/Flow bot/location/@{encodeURIComponent('Chat with Flow bot')}"
                                                                                    }
                                                                                },
                                                                                "Reply_with_SAP_lock_message_in_channel": {
                                                                                    "type": "ApiConnection",
                                                                                    "inputs": {
                                                                                        "body": {
                                                                                            "messageBody": "<p>SAP User @{variables('SAP_User')} (@{variables('account')}) locked!<br>\n<br>\nSAP response: @{body('Parse_SAP_response_as_JSON')?['bAPI_USER_LOCKResponse']?['RETURN'][0]?['mESSAGE']}</p>",
                                                                                            "parentMessageId": "@body('Parse_JSON')?['messageId']",
                                                                                            "recipient": {
                                                                                                "channelId": "@{variables('TeamsChannel')?['channelID']}",
                                                                                                "groupId": "@{variables('TeamsChannel')?['teamID']}"
                                                                                            }
                                                                                        },
                                                                                        "host": {
                                                                                            "connection": {
                                                                                                "name": "@parameters('$connections')['teams_1']['connectionId']"
                                                                                            }
                                                                                        },
                                                                                        "method": "post",
                                                                                        "path": "/v1.0/teams/conversation/replyWithMessage/poster/Flow bot/location/@{encodeURIComponent('Channel')}"
                                                                                    }
                                                                                }
                                                                            },
                                                                            "runAfter": {
                                                                                "Parse_SAP_response_as_JSON": [
                                                                                    "Succeeded"
                                                                                ]
                                                                            },
                                                                            "else": {
                                                                                "actions": {
                                                                                    "Reply_to_Admins_with_lock_error_in_Channel": {
                                                                                        "type": "ApiConnection",
                                                                                        "inputs": {
                                                                                            "body": {
                                                                                                "messageBody": "<p>User could not be locked. Error message (code @{outputs('Block_User_via_SOAP_exposed_BAPI')['statusCode']}): @{body('Block_User_via_SOAP_exposed_BAPI')}</p>",
                                                                                                "parentMessageId": "@body('Parse_JSON')?['messageId']",
                                                                                                "recipient": {
                                                                                                    "channelId": "@{variables('TeamsChannel')?['channelID']}",
                                                                                                    "groupId": "@{variables('TeamsChannel')?['teamID']}"
                                                                                                }
                                                                                            },
                                                                                            "host": {
                                                                                                "connection": {
                                                                                                    "name": "@parameters('$connections')['teams_1']['connectionId']"
                                                                                                }
                                                                                            },
                                                                                            "method": "post",
                                                                                            "path": "/v1.0/teams/conversation/replyWithMessage/poster/Flow bot/location/@{encodeURIComponent('Channel')}"
                                                                                        }
                                                                                    }
                                                                                }
                                                                            },
                                                                            "expression": {
                                                                                "and": [
                                                                                    {
                                                                                        "equals": [
                                                                                            "@outputs('Block_User_via_SOAP_exposed_BAPI')['statusCode']",
                                                                                            200
                                                                                        ]
                                                                                    }
                                                                                ]
                                                                            },
                                                                            "type": "If"
                                                                        },
                                                                        "Parse_SAP_response_as_JSON": {
                                                                            "runAfter": {
                                                                                "Block_User_via_SOAP_exposed_BAPI": [
                                                                                    "Succeeded",
                                                                                    "Failed"
                                                                                ]
                                                                            },
                                                                            "type": "ParseJson",
                                                                            "inputs": {
                                                                                "content": "@body('Block_User_via_SOAP_exposed_BAPI')",
                                                                                "schema": {
                                                                                    "properties": {
                                                                                        "bAPI_USER_LOCKResponse": {
                                                                                            "properties": {
                                                                                                "RETURN": {
                                                                                                    "items": {
                                                                                                        "properties": {
                                                                                                            "fIELD": {
                                                                                                                "type": "string"
                                                                                                            },
                                                                                                            "iD": {
                                                                                                                "type": "string"
                                                                                                            },
                                                                                                            "lOG_MSG_NO": {
                                                                                                                "type": "string"
                                                                                                            },
                                                                                                            "lOG_NO": {
                                                                                                                "type": "string"
                                                                                                            },
                                                                                                            "mESSAGE": {
                                                                                                                "type": "string"
                                                                                                            },
                                                                                                            "mESSAGE_V1": {
                                                                                                                "type": "string"
                                                                                                            },
                                                                                                            "mESSAGE_V2": {
                                                                                                                "type": "string"
                                                                                                            },
                                                                                                            "mESSAGE_V3": {
                                                                                                                "type": "string"
                                                                                                            },
                                                                                                            "mESSAGE_V4": {
                                                                                                                "type": "string"
                                                                                                            },
                                                                                                            "nUMBER": {
                                                                                                                "type": "string"
                                                                                                            },
                                                                                                            "pARAMETER": {
                                                                                                                "type": "string"
                                                                                                            },
                                                                                                            "rOW": {
                                                                                                                "type": "integer"
                                                                                                            },
                                                                                                            "sYSTEM": {
                                                                                                                "type": "string"
                                                                                                            },
                                                                                                            "tYPE": {
                                                                                                                "type": "string"
                                                                                                            }
                                                                                                        },
                                                                                                        "required": [
                                                                                                            "tYPE",
                                                                                                            "iD",
                                                                                                            "nUMBER",
                                                                                                            "mESSAGE",
                                                                                                            "lOG_NO",
                                                                                                            "lOG_MSG_NO",
                                                                                                            "mESSAGE_V1",
                                                                                                            "mESSAGE_V2",
                                                                                                            "mESSAGE_V3",
                                                                                                            "mESSAGE_V4",
                                                                                                            "pARAMETER",
                                                                                                            "rOW",
                                                                                                            "fIELD",
                                                                                                            "sYSTEM"
                                                                                                        ],
                                                                                                        "type": "object"
                                                                                                    },
                                                                                                    "type": "array"
                                                                                                }
                                                                                            },
                                                                                            "type": "object"
                                                                                        }
                                                                                    },
                                                                                    "type": "object"
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            },
                                                            "expression": "@body('Parse_JSON')?['data']?['WhereToLockUser']",
                                                            "type": "Switch"
                                                        }
                                                    },
                                                    "runAfter": {
                                                        "Parse_JSON": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "else": {
                                                        "actions": {
                                                            "Flag_false_positive": {
                                                                "type": "ApiConnection",
                                                                "inputs": {
                                                                    "body": {
                                                                        "classification": {
                                                                            "ClassificationAndReason": "FalsePositive - IncorrectAlertLogic",
                                                                            "ClassificationReasonText": "@body('Parse_JSON')?['data']?['flagComment']"
                                                                        },
                                                                        "incidentArmId": "@triggerBody()?['object']?['id']",
                                                                        "status": "Closed"
                                                                    },
                                                                    "host": {
                                                                        "connection": {
                                                                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                                        }
                                                                    },
                                                                    "method": "put",
                                                                    "path": "/Incidents"
                                                                }
                                                            }
                                                        }
                                                    },
                                                    "expression": {
                                                        "and": [
                                                            {
                                                                "equals": [
                                                                    "@body('Parse_JSON')?['submitActionId']",
                                                                    "block"
                                                                ]
                                                            }
                                                        ]
                                                    },
                                                    "type": "If"
                                                },
                                                "Parse_JSON": {
                                                    "runAfter": {
                                                        "Post_incident_as_adaptive_card_and_wait_for_a_response": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "ParseJson",
                                                    "inputs": {
                                                        "content": "@body('Post_incident_as_adaptive_card_and_wait_for_a_response')",
                                                        "schema": {
                                                            "properties": {
                                                                "data": {
                                                                    "properties": {
                                                                        "WhereToLockUser": {
                                                                            "type": "string"
                                                                        }
                                                                    },
                                                                    "type": "object"
                                                                },
                                                                "messageId": {
                                                                    "type": "string"
                                                                },
                                                                "messageLink": {
                                                                    "type": "string"
                                                                },
                                                                "responder": {
                                                                    "properties": {
                                                                        "displayName": {
                                                                            "type": "string"
                                                                        },
                                                                        "email": {
                                                                            "type": "string"
                                                                        },
                                                                        "objectId": {
                                                                            "type": "string"
                                                                        },
                                                                        "tenantId": {
                                                                            "type": "string"
                                                                        },
                                                                        "userPrincipalName": {
                                                                            "type": "string"
                                                                        }
                                                                    },
                                                                    "type": "object"
                                                                },
                                                                "responseTime": {
                                                                    "type": "string"
                                                                },
                                                                "submitActionId": {
                                                                    "type": "string"
                                                                }
                                                            },
                                                            "type": "object"
                                                        }
                                                    }
                                                },
                                                "Post_incident_as_adaptive_card_and_wait_for_a_response": {
                                                    "limit": {
                                                        "timeout": "PT1H"
                                                    },
                                                    "type": "ApiConnectionWebhook",
                                                    "inputs": {
                                                        "body": {
                                                            "body": {
                                                                "messageBody": "{\n    \"type\": \"AdaptiveCard\",\n    \"body\": [\n        {\n            \"type\": \"Container\",\n            \"style\": \"emphasis\",\n            \"items\": [\n                {\n                    \"type\": \"ColumnSet\",\n                    \"columns\": [\n                        {\n                            \"type\": \"Column\",\n                            \"items\": [\n                                {\n                                    \"type\": \"TextBlock\",\n                                    \"size\": \"Large\",\n                                    \"weight\": \"Bolder\",\n                                    \"text\": \"New incident from Azure Sentinel!\"\n                                }\n                            ],\n                            \"width\": \"stretch\"\n                        },\n                        {\n                            \"type\": \"Column\",\n                            \"width\": \"auto\",\n                            \"style\": \"attention\",\n                            \"items\": [\n                                {\n                                    \"type\": \"RichTextBlock\",\n                                    \"inlines\": [\n                                        {\n                                            \"type\": \"TextRun\",\n                                            \"text\": \"@{triggerBody()?['object']?['properties']?['severity']}\"\n                                        }\n                                    ]\n                                }\n                            ]\n                        }\n                    ]\n                },\n                {\n                    \"type\": \"TextBlock\",\n                    \"spacing\": \"Medium\",\n                    \"size\": \"Medium\",\n                    \"weight\": \"Bolder\",\n                    \"color\": \"Accent\",\n                    \"text\": \"@{triggerBody()?['object']?['properties']?['title']}\"\n                },\n                {\n                    \"type\": \"ActionSet\",\n                    \"actions\": [\n                        {\n                            \"type\": \"Action.OpenUrl\",\n                            \"title\": \"View incident\",\n                            \"url\": \"@{triggerBody()?['object']?['properties']?['incidentUrl']}\",\n                            \"id\": \"openSentinel\"\n                        }\n                    ]\n                }\n            ],\n            \"bleed\": true\n        },\n        {\n            \"type\": \"Container\",\n            \"items\": [\n                {\n                    \"type\": \"FactSet\",\n                    \"spacing\": \"Large\",\n                    \"facts\": [\n                        {\n                            \"title\": \"Creation time (UTC)\",\n                            \"value\": \"@{triggerBody()?['object']?['properties']?['createdTimeUtc']}\"\n                        },\n                        {\n                            \"title\": \"Tactics\",\n                            \"value\": \"@{variables('Sentinel-Tactics')}\"\n                        }\n                    ]\n                },\n                {\n                    \"type\": \"TextBlock\",\n                    \"text\": \"@{replace(replace(triggerBody()?['object']?['properties']?['description'],'\"','\\\"'),'\\\\','\\')}\",\n                    \"wrap\": true\n                }\n            ]\n        },\n        {\n            \"type\": \"Container\",\n            \"spacing\": \"Large\",\n            \"style\": \"emphasis\",\n            \"items\": [\n                {\n                    \"type\": \"TextBlock\",\n                    \"text\": \"Related Entities\",\n                    \"wrap\": true,\n                    \"separator\": true,\n                    \"fontType\": \"Default\",\n                    \"size\": \"Medium\",\n                    \"weight\": \"Bolder\"\n                },\n                {\n                    \"type\": \"ColumnSet\",\n                    \"columns\": @{outputs('Compose_dynamic_json_for_entities_table')}\n                }\n            ],\n            \"bleed\": true\n        }\n    ],\n    \"actions\": [\n        {\n            \"type\": \"Action.ShowCard\",\n            \"title\": \"Block User on...\",\n            \"style\": \"destructive\",\n            \"card\": {\n                \"type\": \"AdaptiveCard\",\n                \"body\": [\n                    {\n                        \"type\": \"Input.ChoiceSet\",\n                        \"id\": \"WhereToLockUser\",\n                        \"label\": \"On which system?\",\n                        \"style\": \"expanded\",\n                        \"choices\": [\n                            {\n                                \"title\": \"SAP ERP\",\n                                \"value\": \"erp\"\n                            },\n                            {\n                                \"title\": \"SAP BTP Cloud Identity Service\",\n                                \"value\": \"btp\"\n                            },\n                            {\n                                \"title\": \"Azure AD (globally)\",\n                                \"value\": \"aad\"\n                            }\n                        ],\n                        \"value\": \"erp\",\n                        \"isRequired\": true,\n                        \"errorMessage\": \"Given choice unknown!\"\n                    },\n                    {\n                        \"type\": \"Input.Text\",\n                        \"id\": \"blockComment\",\n                        \"placeholder\": \"Add a comment\",\n                        \"isMultiline\": true\n                    }\n                ],\n                \"actions\": [\n                    {\n                        \"type\": \"Action.Submit\",\n                        \"id\": \"block\",\n                        \"title\": \"Submit\"\n                    }\n                ],\n                \"$schema\": \"http://adaptivecards.io/schemas/adaptive-card.json\",\n                \"version\": \"1.4\"\n            }\n        },\n        {\n            \"type\": \"Action.ShowCard\",\n            \"title\": \"Flag as false positive\",\n            \"card\": {\n                \"type\": \"AdaptiveCard\",\n                \"body\": [\n                    {\n                        \"type\": \"Input.Text\",\n                        \"id\": \"flagComment\",\n                        \"placeholder\": \"Add a comment\",\n                        \"isMultiline\": true\n                    }\n                ],\n                \"actions\": [\n                    {\n                        \"type\": \"Action.Submit\",\n                        \"id\": \"flag\",\n                        \"title\": \"Submit\"\n                    }\n                ],\n                \"$schema\": \"http://adaptivecards.io/schemas/adaptive-card.json\",\n                \"version\": \"1.4\"\n            }\n        }\n    ],\n    \"$schema\": \"http://adaptivecards.io/schemas/adaptive-card.json\",\n    \"version\": \"1.4\",\n    \"fallbackText\": \"This card requires Adaptive Cards v1.4 support to be rendered properly.\"\n}",
                                                                "recipient": {
                                                                    "channelId": "@{parameters('TeamsChannel')?['channelID']}",
                                                                    "groupId": "@{parameters('TeamsChannel')?['teamID']}"
                                                                },
                                                                "updateMessage": "Thanks for keeping SAP on Azure secure!"
                                                            },
                                                            "notificationUrl": "@{listCallbackUrl()}"
                                                        },
                                                        "host": {
                                                            "connection": {
                                                                "name": "@parameters('$connections')['teams_1']['connectionId']"
                                                            }
                                                        },
                                                        "path": "/v1.0/teams/conversation/gatherinput/poster/Flow bot/location/@{encodeURIComponent('Channel')}/$subscriptions"
                                                    }
                                                },
                                                "Post_timeout_message_in_Channel": {
                                                    "runAfter": {
                                                        "Post_incident_as_adaptive_card_and_wait_for_a_response": [
                                                            "TimedOut",
                                                            "Skipped",
                                                            "Failed"
                                                        ]
                                                    },
                                                    "type": "ApiConnection",
                                                    "inputs": {
                                                        "body": {
                                                            "messageBody": "<p>Incident notification timed out after 1h!&nbsp;</p>",
                                                            "recipient": {
                                                                "channelId": "@{variables('TeamsChannel')?['channelID']}",
                                                                "groupId": "@{variables('TeamsChannel')?['teamID']}"
                                                            }
                                                        },
                                                        "host": {
                                                            "connection": {
                                                                "name": "@parameters('$connections')['teams_1']['connectionId']"
                                                            }
                                                        },
                                                        "method": "post",
                                                        "path": "/beta/teams/conversation/message/poster/Flow bot/location/@{encodeURIComponent('Channel')}"
                                                    }
                                                }
                                            },
                                            "runAfter": {
                                                "Payload_parsing_Scope": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "Scope"
                                        },
                                        "Initialize_Custom_Details_JSON_string": {
                                            "type": "InitializeVariable",
                                            "inputs": {
                                                "variables": [
                                                    {
                                                        "name": "custom-details-json-string",
                                                        "type": "string",
                                                        "value": "@{replace(replace(replace(replace(triggerBody()?['object']?['properties']?['alerts'][0]?['properties']?['additionalData']?['Custom Details'],'}\"','}'),'\"{','{'),'\\',''),'\"}]}','}]}')}"
                                                    }
                                                ]
                                            }
                                        },
                                        "Initialize_Entities__Kind_for_dynamic_json": {
                                            "runAfter": {
                                                "Initialize_base_path_from_query": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "InitializeVariable",
                                            "inputs": {
                                                "variables": [
                                                    {
                                                        "name": "entitiesKindArray",
                                                        "type": "array"
                                                    }
                                                ]
                                            }
                                        },
                                        "Initialize_Entities__Name_for_dynamic_json": {
                                            "runAfter": {
                                                "Initialize_Entities__Kind_for_dynamic_json": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "InitializeVariable",
                                            "inputs": {
                                                "variables": [
                                                    {
                                                        "name": "entitiesNameArray",
                                                        "type": "array"
                                                    }
                                                ]
                                            }
                                        },
                                        "Initialize_SAPClientId_variable": {
                                            "runAfter": {
                                                "Initialize_SID_variable": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "InitializeVariable",
                                            "inputs": {
                                                "variables": [
                                                    {
                                                        "name": "sap-client-id",
                                                        "type": "string"
                                                    }
                                                ]
                                            }
                                        },
                                        "Initialize_SAP_user_to_be_locked": {
                                            "runAfter": {
                                                "Initialize_account_variable": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "InitializeVariable",
                                            "inputs": {
                                                "variables": [
                                                    {
                                                        "name": "SAP_User",
                                                        "type": "string"
                                                    }
                                                ]
                                            }
                                        },
                                        "Initialize_SID_variable": {
                                            "runAfter": {
                                                "Initialize_default_admin_email": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "InitializeVariable",
                                            "inputs": {
                                                "variables": [
                                                    {
                                                        "name": "SID",
                                                        "type": "string"
                                                    }
                                                ]
                                            }
                                        },
                                        "Initialize_account_variable": {
                                            "runAfter": {
                                                "Initialize_SAPClientId_variable": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "InitializeVariable",
                                            "inputs": {
                                                "variables": [
                                                    {
                                                        "name": "account",
                                                        "type": "string"
                                                    }
                                                ]
                                            }
                                        },
                                        "Initialize_base_path_from_query": {
                                            "runAfter": {
                                                "Initialize_SAP_user_to_be_locked": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "InitializeVariable",
                                            "inputs": {
                                                "variables": [
                                                    {
                                                        "name": "basePath",
                                                        "type": "string"
                                                    }
                                                ]
                                            }
                                        },
                                        "Initialize_default_admin_email": {
                                            "runAfter": {
                                                "Initialize_target_TeamsChannel": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "InitializeVariable",
                                            "inputs": {
                                                "variables": [
                                                    {
                                                        "name": "DefaultAdminEmail",
                                                        "type": "string",
                                                        "value": "@parameters('DefaultEmail')"
                                                    }
                                                ]
                                            }
                                        },
                                        "Initialize_sentinel_incident_tactics_for_adaptive_card": {
                                            "runAfter": {
                                                "Initialize_Entities__Name_for_dynamic_json": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "InitializeVariable",
                                            "inputs": {
                                                "variables": [
                                                    {
                                                        "name": "Sentinel-Tactics",
                                                        "type": "string",
                                                        "value": "@{replace(replace(replace(string(triggerBody()?['object']?['properties']?['additionalData']?['tactics']),'[',''),']',''),'\"','')}"
                                                    }
                                                ]
                                            }
                                        },
                                        "Initialize_target_TeamsChannel": {
                                            "runAfter": {
                                                "Initialize_Custom_Details_JSON_string": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "InitializeVariable",
                                            "inputs": {
                                                "variables": [
                                                    {
                                                        "name": "TeamsChannel",
                                                        "type": "object",
                                                        "value": "@parameters('TeamsChannel')"
                                                    }
                                                ]
                                            }
                                        },
                                        "Payload_parsing_Scope": {
                                            "actions": {
                                                "Compose_dynamic_json_for_entities_table": {
                                                    "runAfter": {
                                                        "Iterate_related_incident_entities": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "Compose",
                                                    "inputs": [
                                                        {
                                                            "items": "@variables('entitiesKindArray')",
                                                            "type": "Column",
                                                            "width": 40
                                                        },
                                                        {
                                                            "items": "@variables('entitiesNameArray')",
                                                            "type": "Column",
                                                            "width": 60
                                                        }
                                                    ]
                                                },
                                                "Iterate_related_incident_entities": {
                                                    "foreach": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                                                    "actions": {
                                                        "Append_to_kind_array": {
                                                            "type": "AppendToArrayVariable",
                                                            "inputs": {
                                                                "name": "entitiesKindArray",
                                                                "value": {
                                                                    "text": "@{items('Iterate_related_Incident_entities')?['kind']}",
                                                                    "type": "TextBlock",
                                                                    "weight": "Default"
                                                                }
                                                            }
                                                        },
                                                        "Append_to_name_array": {
                                                            "runAfter": {
                                                                "Append_to_kind_array": [
                                                                    "Succeeded"
                                                                ]
                                                            },
                                                            "type": "AppendToArrayVariable",
                                                            "inputs": {
                                                                "name": "entitiesNameArray",
                                                                "value": {
                                                                    "text": "@{items('Iterate_related_incident_entities')?['properties']?['friendlyName']}",
                                                                    "type": "TextBlock",
                                                                    "weight": "Default"
                                                                }
                                                            }
                                                        }
                                                    },
                                                    "runAfter": {
                                                        "Select_related_entities": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "Foreach",
                                                    "runtimeConfiguration": {
                                                        "concurrency": {
                                                            "repetitions": 1
                                                        }
                                                    }
                                                },
                                                "Parse_Incident_Custom_Details": {
                                                    "type": "ParseJson",
                                                    "inputs": {
                                                        "content": "@variables('custom-details-json-string')",
                                                        "schema": {
                                                            "properties": {
                                                                "AuditClassID": {
                                                                    "items": {
                                                                        "type": "string"
                                                                    },
                                                                    "type": "array"
                                                                },
                                                                "BagOfDetails": {
                                                                    "items": {
                                                                        "properties": {
                                                                            "DestinationEmail": {
                                                                                "type": "string"
                                                                            },
                                                                            "MessageID": {
                                                                                "type": "string"
                                                                            },
                                                                            "Severity": {
                                                                                "type": "string"
                                                                            },
                                                                            "SystemID": {
                                                                                "type": "string"
                                                                            },
                                                                            "Tactics": {
                                                                                "type": "string"
                                                                            },
                                                                            "TeamsChannelID": {
                                                                                "properties": {
                                                                                    "channelID": {
                                                                                        "type": "string"
                                                                                    },
                                                                                    "teamID": {
                                                                                        "type": "string"
                                                                                    }
                                                                                },
                                                                                "type": "object"
                                                                            }
                                                                        },
                                                                        "required": [
                                                                            "MessageID",
                                                                            "Tactics",
                                                                            "SystemID",
                                                                            "Severity",
                                                                            "DestinationEmail",
                                                                            "TeamsChannelID"
                                                                        ],
                                                                        "type": "object"
                                                                    },
                                                                    "type": "array"
                                                                },
                                                                "DestinationEmail": {
                                                                    "items": {
                                                                        "type": "string"
                                                                    },
                                                                    "type": "array"
                                                                },
                                                                "IsProductionEnv": {
                                                                    "items": {
                                                                        "type": "string"
                                                                    },
                                                                    "type": "array"
                                                                },
                                                                "SAPAuditLogMessageID": {
                                                                    "items": {
                                                                        "type": "string"
                                                                    },
                                                                    "type": "array"
                                                                },
                                                                "SAPProcessType": {
                                                                    "items": {
                                                                        "type": "string"
                                                                    },
                                                                    "type": "array"
                                                                },
                                                                "SAPUser": {
                                                                    "items": {
                                                                        "type": "string"
                                                                    },
                                                                    "type": "array"
                                                                },
                                                                "SystemRole": {
                                                                    "items": {
                                                                        "type": "string"
                                                                    },
                                                                    "type": "array"
                                                                },
                                                                "SystemUsage": {
                                                                    "items": {
                                                                        "type": "string"
                                                                    },
                                                                    "type": "array"
                                                                },
                                                                "TeamsChannelID": {
                                                                    "items": {
                                                                        "properties": {
                                                                            "channelID": {
                                                                                "type": "string"
                                                                            },
                                                                            "teamID": {
                                                                                "type": "string"
                                                                            }
                                                                        },
                                                                        "required": [
                                                                            "teamID",
                                                                            "channelID"
                                                                        ],
                                                                        "type": "object"
                                                                    },
                                                                    "type": "array"
                                                                }
                                                            },
                                                            "type": "object"
                                                        }
                                                    }
                                                },
                                                "Select_entities": {
                                                    "runAfter": {
                                                        "Parse_Incident_Custom_Details": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "Select",
                                                    "inputs": {
                                                        "from": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                                                        "select": {
                                                            "entity": "@item()?['properties']?['friendlyName']",
                                                            "entity-type": "@item()?['kind']"
                                                        }
                                                    }
                                                },
                                                "Select_related_entities": {
                                                    "foreach": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                                                    "actions": {
                                                        "Switch": {
                                                            "cases": {
                                                                "Case": {
                                                                    "case": "CloudApplication",
                                                                    "actions": {
                                                                        "Select_SID_from_Incident": {
                                                                            "type": "SetVariable",
                                                                            "inputs": {
                                                                                "name": "SID",
                                                                                "value": "@{items('Select_related_entities')?['properties']?['friendlyName']}"
                                                                            }
                                                                        },
                                                                        "Set_SAP_client_id": {
                                                                            "runAfter": {
                                                                                "Select_SID_from_Incident": [
                                                                                    "Succeeded"
                                                                                ]
                                                                            },
                                                                            "type": "SetVariable",
                                                                            "inputs": {
                                                                                "name": "sap-client-id",
                                                                                "value": "@{string(formatNumber(items('Select_related_entities')?['properties']?['appId'],'000'))}"
                                                                            }
                                                                        }
                                                                    }
                                                                },
                                                                "Case_2": {
                                                                    "case": "Account",
                                                                    "actions": {
                                                                        "Set_account_from_incident": {
                                                                            "type": "SetVariable",
                                                                            "inputs": {
                                                                                "name": "account",
                                                                                "value": "@{items('Select_related_entities')?['properties']?['friendlyName']}"
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            },
                                                            "expression": "@items('Select_related_entities')?['kind']",
                                                            "type": "Switch"
                                                        }
                                                    },
                                                    "runAfter": {
                                                        "Set_SAP_user_to_be_locked": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "Foreach",
                                                    "runtimeConfiguration": {
                                                        "concurrency": {
                                                            "repetitions": 2
                                                        }
                                                    }
                                                },
                                                "Set_SAP_user_to_be_locked": {
                                                    "runAfter": {
                                                        "Select_entities": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "SetVariable",
                                                    "inputs": {
                                                        "name": "SAP_User",
                                                        "value": "@{body('Parse_Incident_Custom_Details')?['SAP_User'][0]}"
                                                    }
                                                }
                                            },
                                            "runAfter": {
                                                "Initialize_sentinel_incident_tactics_for_adaptive_card": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "Scope"
                                        },
                                        "Post_parsing_error_message_to_Logic_App_admin": {
                                            "runAfter": {
                                                "Payload_parsing_Scope": [
                                                    "Failed",
                                                    "Skipped",
                                                    "TimedOut"
                                                ]
                                            },
                                            "type": "ApiConnection",
                                            "inputs": {
                                                "body": {
                                                    "isAlert": true,
                                                    "messageBody": "<p>Sentinel SAP Incident parsing failed or timed out (after 1h)! Please verify your logic and process the incident from Sentinel manually till resolved.<br>\n<br>\nLink</p>",
                                                    "recipient": "@variables('DefaultAdminEmail')"
                                                },
                                                "host": {
                                                    "connection": {
                                                        "name": "@parameters('$connections')['teams_1']['connectionId']"
                                                    }
                                                },
                                                "method": "post",
                                                "path": "/beta/teams/conversation/message/poster/Flow bot/location/@{encodeURIComponent('Chat with Flow bot')}"
                                            }
                                        },
                                        "Post_processing_error_message_to_Logic_App_admin": {
                                            "runAfter": {
                                                "Incident_response_Scope": [
                                                    "Failed",
                                                    "Skipped",
                                                    "TimedOut"
                                                ]
                                            },
                                            "type": "ApiConnection",
                                            "inputs": {
                                                "body": {
                                                    "isAlert": true,
                                                    "messageBody": "<p>Sentinel SAP Incident workflow action failed! Please verify your logic and process the incident from Sentinel manually till resolved<br>\n<br>\n<a href=\"https://portal.azure.com/\">Link</a>&nbsp;</p>",
                                                    "recipient": "@variables('DefaultAdminEmail')"
                                                },
                                                "host": {
                                                    "connection": {
                                                        "name": "@parameters('$connections')['teams_1']['connectionId']"
                                                    }
                                                },
                                                "method": "post",
                                                "path": "/beta/teams/conversation/message/poster/Flow bot/location/@{encodeURIComponent('Chat with Flow bot')}"
                                            }
                                        },
                                        "Terminate": {
                                            "runAfter": {
                                                "Incident_response_Scope": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "Terminate",
                                            "inputs": {
                                                "runStatus": "Succeeded"
                                            }
                                        }
                                    }
                                },
                                "parameters": {
                                    "$connections": {
                                        "value": {
                                            "azuresentinel": {
                                                "connectionId": "[[resourceId('Microsoft.Web/connections', variables('MicrosoftSentinelConnectionName'))]",
                                                "connectionName": "[[variables('MicrosoftSentinelConnectionName')]",
                                                "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Azuresentinel')]",
                                                "connectionProperties": {
                                                    "authentication": {
                                                        "type": "ManagedServiceIdentity"
                                                    }
                                                }
                                            },
                                            "teams_1": {
                                                "connectionId": "[[resourceId('Microsoft.Web/connections', variables('TeamsConnectionName'))]",
                                                "connectionName": "[[variables('TeamsConnectionName')]",
                                                "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Teams')]"
                                            }
                                        }
                                    }
                                }
                            },
                            "name": "[[parameters('PlaybookName')]",
                            "type": "Microsoft.Logic/workflows",
                            "location": "[[variables('workspace-location-inline')]",
                            "identity": {
                                "type": "SystemAssigned"
                            },
                            "apiVersion": "2017-07-01",
                            "dependsOn": [
                                "[[resourceId('Microsoft.Web/connections', variables('MicrosoftSentinelConnectionName'))]",
                                "[[resourceId('Microsoft.Web/connections', variables('TeamsConnectionName'))]"
                            ],
                            "tags": {
                                "hidden-SentinelTemplateVersion": "2.0.65",
                                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
                            }
                        },
                        {
                            "type": "Microsoft.Web/connections",
                            "apiVersion": "2016-06-01",
                            "name": "[[variables('MicrosoftSentinelConnectionName')]",
                            "location": "[[variables('workspace-location-inline')]",
                            "kind": "V1",
                            "properties": {
                                "displayName": "[[variables('MicrosoftSentinelConnectionName')]",
                                "parameterValueType": "Alternative",
                                "api": {
                                    "id": "[[variables('_connection-2')]"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.Web/connections",
                            "apiVersion": "2016-06-01",
                            "name": "[[variables('TeamsConnectionName')]",
                            "location": "[[variables('workspace-location-inline')]",
                            "kind": "V1",
                            "properties": {
                                "displayName": "[[variables('TeamsConnectionName')]",
                                "api": {
                                    "id": "[[variables('_connection-3')]"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId2'),'/'))))]",
                            "properties": {
                                "parentId": "[variables('playbookId2')]",
                                "contentId": "[variables('_playbookContentId2')]",
                                "kind": "Playbook",
                                "version": "[variables('playbookVersion2')]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SAP",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ],
                    "metadata": {
                        "title": "SAP Incident Response- lock User from Teams- Basic",
                        "description": "This Playbook Provides the automation for the SAP incidents. It allows for automatically pop a Teams message or an email to the user to notify them of the incident. It also allows for the user to be blocked on AAD or SAP, for the incident to be closed. The same functionality is also offered in a standard logic app, which allows enterprise features such as private VNet injection, tenant isolation and more. See [SAP automation scenarios on GitHub](https://github.com/Azure/Azure-Sentinel/blob/master/Solutions/SAP/Playbooks/README.md) for more information.",
                        "prerequisites": [
                            "1. Update your SAP alert rules to the latest version.",
                            "2. Assign the releavnt Teams or email addresses to be used as responders.",
                            "3. Optional- set your SAP system to allow user locking from Sentinel, See more details at https://aka.ms/sentinel4sapintro."
                        ],
                        "postDeployment": [
                            "1. Once deployment is complete, you will need to authorize each connection.",
                            "2. Navigate to playbook --> API Connections --> Select connections one by one --> Edit API Connection --> (if required) Enter API key or credentials --> Save"
                        ],
                        "lastUpdateTime": "2023-05-17T00:00:00Z",
                        "entities": [
                            "ip",
                            "Account"
                        ],
                        "tags": [
                            "workflow",
                            "SAP",
                            "Active directory",
                            "SAP User",
                            "Block SAP User",
                            "Block AD User"
                        ],
                        "releaseNotes": {
                            "version": "2.0.65",
                            "title": "[variables('blanks')]",
                            "notes": [
                                "Initial version"
                            ]
                        }
                    }
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('_playbookContentId2')]",
                "contentKind": "Playbook",
                "displayName": "SAPLockUser-Basic",
                "contentProductId": "[variables('_playbookcontentProductId2')]",
                "id": "[variables('_playbookcontentProductId2')]",
                "version": "[variables('playbookVersion2')]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('playbookTemplateSpecName3')]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAPReEnableAuditLog Playbook with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('playbookVersion3')]",
                    "parameters": {
                        "PlaybookName": {
                            "defaultValue": "SAPReEnableAuditLog",
                            "type": "string"
                        },
                        "DefaultAdminEmail": {
                            "type": "string",
                            "metadata": {
                                "description": "Enter value for DefaultAdminEmail"
                            }
                        },
                        "SAP-SOAP-KeyVault-Credential-Name": {
                            "type": "string",
                            "metadata": {
                                "description": "Enter value for SAP-SOAP-KeyVault-Credential-Name"
                            }
                        },
                        "TeamsChannel": {
                            "type": "string",
                            "metadata": {
                                "description": "Enter value for TeamsChannel"
                            }
                        }
                    },
                    "variables": {
                        "AzuremonitorlogsConnectionName": "[[concat('Azuremonitorlogs-', parameters('PlaybookName'))]",
                        "MicrosoftSentinelConnectionName": "[[concat('MicrosoftSentinel-', parameters('PlaybookName'))]",
                        "KeyvaultConnectionName": "[[concat('Keyvault-', parameters('PlaybookName'))]",
                        "TeamsConnectionName": "[[concat('Teams-', parameters('PlaybookName'))]",
                        "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Azuremonitorlogs')]",
                        "_connection-2": "[[variables('connection-2')]",
                        "connection-3": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Azuresentinel')]",
                        "_connection-3": "[[variables('connection-3')]",
                        "connection-4": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Keyvault')]",
                        "_connection-4": "[[variables('connection-4')]",
                        "connection-5": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Teams')]",
                        "_connection-5": "[[variables('connection-5')]",
                        "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
                        "workspace-name": "[parameters('workspace')]",
                        "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
                    },
                    "resources": [
                        {
                            "properties": {
                                "provisioningState": "Succeeded",
                                "state": "Enabled",
                                "definition": {
                                    "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                                    "contentVersion": "1.0.0.0",
                                    "parameters": {
                                        "$connections": {
                                            "type": "Object"
                                        },
                                        "DefaultAdminEmail": {
                                            "type": "string",
                                            "defaultValue": "[[parameters('DefaultAdminEmail')]"
                                        },
                                        "SAP-SOAP-KeyVault-Credential-Name": {
                                            "type": "string",
                                            "defaultValue": "[[parameters('SAP-SOAP-KeyVault-Credential-Name')]"
                                        },
                                        "TeamsChannel": {
                                            "type": "string",
                                            "defaultValue": "[[parameters('TeamsChannel')]"
                                        }
                                    },
                                    "triggers": {
                                        "Microsoft_Sentinel_incident": {
                                            "type": "ApiConnectionWebhook",
                                            "inputs": {
                                                "body": {
                                                    "callback_url": "@{listCallbackUrl()}"
                                                },
                                                "host": {
                                                    "connection": {
                                                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                    }
                                                },
                                                "path": "/incident-creation"
                                            }
                                        }
                                    },
                                    "actions": {
                                        "Get_latest_SAP_Audit_Log_parameter": {
                                            "runAfter": {
                                                "Get_secret_for_SAP_SOAP": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "Http",
                                            "inputs": {
                                                "authentication": {
                                                    "password": "@body('Get_secret_for_SAP_SOAP')?['value']",
                                                    "type": "Basic",
                                                    "username": "@body('Get_secret_for_SAP_SOAP')?['name']"
                                                },
                                                "body": {
                                                    "rSAU_API_GET_PARAM": {
                                                        "iD_GET_FROM_KP": "X"
                                                    }
                                                },
                                                "headers": {
                                                    "Content-Type": "application/json"
                                                },
                                                "method": "POST",
                                                "uri": "@{variables('basePath')}auditlog/param/sap-com:document:sap:rfc:functions:ZWS_RSAU_API_GET_PARAM:RSAU_API_GET_PARAMRequest"
                                            }
                                        },
                                        "Get_secret_for_SAP_SOAP": {
                                            "runAfter": {
                                                "Payload_parsing_Scope": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "ApiConnection",
                                            "inputs": {
                                                "host": {
                                                    "connection": {
                                                        "name": "@parameters('$connections')['keyvault']['connectionId']"
                                                    }
                                                },
                                                "method": "get",
                                                "path": "/secrets/@{encodeURIComponent(parameters('SAP-SOAP-KeyVault-Credential-Name'))}/value"
                                            }
                                        },
                                        "Initialize_Custom_Details_JSON_string": {
                                            "type": "InitializeVariable",
                                            "inputs": {
                                                "variables": [
                                                    {
                                                        "name": "custom-details-json-string",
                                                        "type": "string",
                                                        "value": "@{replace(replace(replace(replace(triggerBody()?['object']?['properties']?['alerts'][0]?['properties']?['additionalData']?['Custom Details'],'}\"','}'),'\"{','{'),'\\',''),'\"}]}','}]}')}"
                                                    }
                                                ]
                                            }
                                        },
                                        "Initialize_Entities__Kind_for_dynamic_json": {
                                            "runAfter": {
                                                "Initialize_base_path_from_query": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "InitializeVariable",
                                            "inputs": {
                                                "variables": [
                                                    {
                                                        "name": "entitiesKindArray",
                                                        "type": "array"
                                                    }
                                                ]
                                            }
                                        },
                                        "Initialize_Entities__Name_for_dynamic_json": {
                                            "runAfter": {
                                                "Initialize_Entities__Kind_for_dynamic_json": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "InitializeVariable",
                                            "inputs": {
                                                "variables": [
                                                    {
                                                        "name": "entitiesNameArray",
                                                        "type": "array"
                                                    }
                                                ]
                                            }
                                        },
                                        "Initialize_SAPClientId_variable": {
                                            "runAfter": {
                                                "Initialize_SID_variable": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "InitializeVariable",
                                            "inputs": {
                                                "variables": [
                                                    {
                                                        "name": "sap-client-id",
                                                        "type": "string"
                                                    }
                                                ]
                                            }
                                        },
                                        "Initialize_SAP_user_to_be_locked": {
                                            "runAfter": {
                                                "Initialize_account_variable": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "InitializeVariable",
                                            "inputs": {
                                                "variables": [
                                                    {
                                                        "name": "SAP-user",
                                                        "type": "string"
                                                    }
                                                ]
                                            }
                                        },
                                        "Initialize_SID_variable": {
                                            "runAfter": {
                                                "Initialize_default_admin_email": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "InitializeVariable",
                                            "inputs": {
                                                "variables": [
                                                    {
                                                        "name": "SID",
                                                        "type": "string"
                                                    }
                                                ]
                                            }
                                        },
                                        "Initialize_account_variable": {
                                            "runAfter": {
                                                "Initialize_SAPClientId_variable": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "InitializeVariable",
                                            "inputs": {
                                                "variables": [
                                                    {
                                                        "name": "account",
                                                        "type": "string"
                                                    }
                                                ]
                                            }
                                        },
                                        "Initialize_actionable_message_for_outlook": {
                                            "runAfter": {
                                                "Initialize_Entities__Name_for_dynamic_json": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "InitializeVariable",
                                            "inputs": {
                                                "variables": [
                                                    {
                                                        "name": "adaptiveCard",
                                                        "type": "string"
                                                    }
                                                ]
                                            }
                                        },
                                        "Initialize_base_path_from_query": {
                                            "runAfter": {
                                                "Initialize_SAP_user_to_be_locked": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "InitializeVariable",
                                            "inputs": {
                                                "variables": [
                                                    {
                                                        "name": "basePath",
                                                        "type": "string"
                                                    }
                                                ]
                                            }
                                        },
                                        "Initialize_default_admin_email": {
                                            "runAfter": {
                                                "Initialize_target_TeamsChannel": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "InitializeVariable",
                                            "inputs": {
                                                "variables": [
                                                    {
                                                        "name": "DefaultAdminEmail",
                                                        "type": "string",
                                                        "value": "@parameters('DefaultAdminEmail')"
                                                    }
                                                ]
                                            }
                                        },
                                        "Initialize_email_body": {
                                            "runAfter": {
                                                "Initialize_actionable_message_for_outlook": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "InitializeVariable",
                                            "inputs": {
                                                "variables": [
                                                    {
                                                        "name": "email-body",
                                                        "type": "string"
                                                    }
                                                ]
                                            }
                                        },
                                        "Initialize_target_TeamsChannel": {
                                            "runAfter": {
                                                "Initialize_Custom_Details_JSON_string": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "InitializeVariable",
                                            "inputs": {
                                                "variables": [
                                                    {
                                                        "name": "TeamsChannel",
                                                        "type": "object",
                                                        "value": "@parameters('TeamsChannel')"
                                                    }
                                                ]
                                            }
                                        },
                                        "Parse_JSON": {
                                            "runAfter": {
                                                "Get_latest_SAP_Audit_Log_parameter": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "ParseJson",
                                            "inputs": {
                                                "content": "@body('Get_latest_SAP_Audit_Log_parameter')?['rSAU_API_GET_PARAMResponse']",
                                                "schema": {
                                                    "properties": {
                                                        "eD_ACTIV": {
                                                            "type": "string"
                                                        },
                                                        "eD_DBMODE": {
                                                            "type": "string"
                                                        },
                                                        "eD_GEN_USER": {
                                                            "type": "string"
                                                        },
                                                        "eD_INTEGRITY": {
                                                            "type": "string"
                                                        },
                                                        "eD_MBYTE_DAY": {
                                                            "type": "integer"
                                                        },
                                                        "eD_MBYTE_FILE": {
                                                            "type": "integer"
                                                        },
                                                        "eD_MBYTE_SGL": {
                                                            "type": "integer"
                                                        },
                                                        "eD_PEER_ADR": {
                                                            "type": "string"
                                                        },
                                                        "eD_SLOTS": {
                                                            "type": "integer"
                                                        },
                                                        "eD_TARGET": {
                                                            "type": "string"
                                                        }
                                                    },
                                                    "type": "object"
                                                }
                                            }
                                        },
                                        "Payload_parsing_Scope": {
                                            "actions": {
                                                "Compose_dynamic_json_for_entities_table": {
                                                    "runAfter": {
                                                        "Iterate_related_incident_entities": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "Compose",
                                                    "inputs": [
                                                        {
                                                            "items": "@variables('entitiesKindArray')",
                                                            "type": "Column",
                                                            "width": 40
                                                        },
                                                        {
                                                            "items": "@variables('entitiesNameArray')",
                                                            "type": "Column",
                                                            "width": 60
                                                        }
                                                    ]
                                                },
                                                "Iterate_related_incident_entities": {
                                                    "foreach": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                                                    "actions": {
                                                        "Append_to_kind_array": {
                                                            "type": "AppendToArrayVariable",
                                                            "inputs": {
                                                                "name": "entitiesKindArray",
                                                                "value": {
                                                                    "text": "@{items('Iterate_related_Incident_entities')?['kind']}",
                                                                    "type": "TextBlock",
                                                                    "weight": "Default"
                                                                }
                                                            }
                                                        },
                                                        "Append_to_name_array": {
                                                            "runAfter": {
                                                                "Append_to_kind_array": [
                                                                    "Succeeded"
                                                                ]
                                                            },
                                                            "type": "AppendToArrayVariable",
                                                            "inputs": {
                                                                "name": "entitiesNameArray",
                                                                "value": {
                                                                    "text": "@{items('Iterate_related_incident_entities')?['properties']?['friendlyName']}",
                                                                    "type": "TextBlock",
                                                                    "weight": "Default"
                                                                }
                                                            }
                                                        }
                                                    },
                                                    "runAfter": {
                                                        "Select_base_path_from_query": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "Foreach",
                                                    "runtimeConfiguration": {
                                                        "concurrency": {
                                                            "repetitions": 1
                                                        }
                                                    }
                                                },
                                                "Parse_Incident_Custom_Details": {
                                                    "type": "ParseJson",
                                                    "inputs": {
                                                        "content": "@variables('custom-details-json-string')",
                                                        "schema": {
                                                            "properties": {
                                                                "AuditClassID": {
                                                                    "items": {
                                                                        "type": "string"
                                                                    },
                                                                    "type": "array"
                                                                },
                                                                "BagOfDetails": {
                                                                    "items": {
                                                                        "properties": {
                                                                            "DestinationEmail": {
                                                                                "type": "string"
                                                                            },
                                                                            "MessageID": {
                                                                                "type": "string"
                                                                            },
                                                                            "Severity": {
                                                                                "type": "string"
                                                                            },
                                                                            "SystemID": {
                                                                                "type": "string"
                                                                            },
                                                                            "Tactics": {
                                                                                "type": "string"
                                                                            },
                                                                            "TeamsChannelID": {
                                                                                "properties": {
                                                                                    "channelID": {
                                                                                        "type": "string"
                                                                                    },
                                                                                    "teamID": {
                                                                                        "type": "string"
                                                                                    }
                                                                                },
                                                                                "type": "object"
                                                                            }
                                                                        },
                                                                        "required": [
                                                                            "MessageID",
                                                                            "Tactics",
                                                                            "SystemID",
                                                                            "Severity",
                                                                            "DestinationEmail",
                                                                            "TeamsChannelID"
                                                                        ],
                                                                        "type": "object"
                                                                    },
                                                                    "type": "array"
                                                                },
                                                                "DestinationEmail": {
                                                                    "items": {
                                                                        "type": "string"
                                                                    },
                                                                    "type": "array"
                                                                },
                                                                "IsProductionEnv": {
                                                                    "items": {
                                                                        "type": "string"
                                                                    },
                                                                    "type": "array"
                                                                },
                                                                "SAPAuditLogMessageID": {
                                                                    "items": {
                                                                        "type": "string"
                                                                    },
                                                                    "type": "array"
                                                                },
                                                                "SAPProcessType": {
                                                                    "items": {
                                                                        "type": "string"
                                                                    },
                                                                    "type": "array"
                                                                },
                                                                "SAPUser": {
                                                                    "items": {
                                                                        "type": "string"
                                                                    },
                                                                    "type": "array"
                                                                },
                                                                "SystemRole": {
                                                                    "items": {
                                                                        "type": "string"
                                                                    },
                                                                    "type": "array"
                                                                },
                                                                "SystemUsage": {
                                                                    "items": {
                                                                        "type": "string"
                                                                    },
                                                                    "type": "array"
                                                                },
                                                                "TeamsChannelID": {
                                                                    "items": {
                                                                        "properties": {
                                                                            "channelID": {
                                                                                "type": "string"
                                                                            },
                                                                            "teamID": {
                                                                                "type": "string"
                                                                            }
                                                                        },
                                                                        "required": [
                                                                            "teamID",
                                                                            "channelID"
                                                                        ],
                                                                        "type": "object"
                                                                    },
                                                                    "type": "array"
                                                                }
                                                            },
                                                            "type": "object"
                                                        }
                                                    }
                                                },
                                                "Run_query_to_select_sap_basepath": {
                                                    "runAfter": {
                                                        "Select_related_entities": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "ApiConnection",
                                                    "inputs": {
                                                        "body": "SAPSystems(SelectedSystems='@{variables('SID')}')| project tostring(todynamic(InterfaceAttributes).BasePath)",
                                                        "host": {
                                                            "connection": {
                                                                "name": "@parameters('$connections')['azuremonitorlogs_2']['connectionId']"
                                                            }
                                                        },
                                                        "method": "post",
                                                        "path": "/queryData",
                                                        "queries": {
                                                            "resourcegroups": "tamir-sentinel-sap-dev-rg",
                                                            "resourcename": "tamir-sentinel4sap-dev",
                                                            "resourcetype": "Log Analytics Workspace",
                                                            "subscriptions": "78ffdd91-611e-402f-8a7e-7ab0b209b7c6",
                                                            "timerange": "Last 24 hours"
                                                        }
                                                    }
                                                },
                                                "Select_base_path_from_query": {
                                                    "runAfter": {
                                                        "Run_query_to_select_sap_basepath": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "SetVariable",
                                                    "inputs": {
                                                        "name": "basePath",
                                                        "value": "@{body('Run_query_to_select_sap_basepath')?['value'][0]?['InterfaceAttributes_BasePath']}"
                                                    }
                                                },
                                                "Select_entities": {
                                                    "runAfter": {
                                                        "Parse_Incident_Custom_Details": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "Select",
                                                    "inputs": {
                                                        "from": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                                                        "select": {
                                                            "entity": "@item()?['properties']?['friendlyName']",
                                                            "entity-type": "@item()?['kind']"
                                                        }
                                                    }
                                                },
                                                "Select_related_entities": {
                                                    "foreach": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                                                    "actions": {
                                                        "Switch": {
                                                            "cases": {
                                                                "Case": {
                                                                    "case": "CloudApplication",
                                                                    "actions": {
                                                                        "Select_SID_from_Incident": {
                                                                            "type": "SetVariable",
                                                                            "inputs": {
                                                                                "name": "SID",
                                                                                "value": "@{items('Select_related_entities')?['properties']?['friendlyName']}"
                                                                            }
                                                                        },
                                                                        "Set_SAP_client_id": {
                                                                            "runAfter": {
                                                                                "Select_SID_from_Incident": [
                                                                                    "Succeeded"
                                                                                ]
                                                                            },
                                                                            "type": "SetVariable",
                                                                            "inputs": {
                                                                                "name": "sap-client-id",
                                                                                "value": "@{string(formatNumber(items('Select_related_entities')?['properties']?['appId'],'000'))}"
                                                                            }
                                                                        }
                                                                    }
                                                                },
                                                                "Case_2": {
                                                                    "case": "Account",
                                                                    "actions": {
                                                                        "Set_account_from_incident": {
                                                                            "type": "SetVariable",
                                                                            "inputs": {
                                                                                "name": "account",
                                                                                "value": "@{items('Select_related_entities')?['properties']?['friendlyName']}"
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            },
                                                            "expression": "@items('Select_related_entities')?['kind']",
                                                            "type": "Switch"
                                                        }
                                                    },
                                                    "runAfter": {
                                                        "Set_involved_SAP_user": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "Foreach",
                                                    "runtimeConfiguration": {
                                                        "concurrency": {
                                                            "repetitions": 2
                                                        }
                                                    }
                                                },
                                                "Set_involved_SAP_user": {
                                                    "runAfter": {
                                                        "Select_entities": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "SetVariable",
                                                    "inputs": {
                                                        "name": "SAP-user",
                                                        "value": "@{body('Parse_Incident_Custom_Details')?['SAP_User'][0]}"
                                                    }
                                                }
                                            },
                                            "runAfter": {
                                                "Initialize_email_body": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "Scope"
                                        },
                                        "Post_Audit_Log_activate_message_in_Channel": {
                                            "runAfter": {
                                                "Re-activate_SAP_Audit_Log": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "ApiConnection",
                                            "inputs": {
                                                "body": {
                                                    "messageBody": "{\n    \"type\": \"AdaptiveCard\",\n    \"body\": [\n        {\n            \"type\": \"Container\",\n            \"style\": \"emphasis\",\n            \"items\": [\n                {\n                    \"type\": \"ColumnSet\",\n                    \"columns\": [\n                        {\n                            \"type\": \"Column\",\n                            \"items\": [\n                                {\n                                    \"type\": \"TextBlock\",\n                                    \"size\": \"Large\",\n                                    \"weight\": \"Bolder\",\n                                    \"text\": \"New incident from Azure Sentinel!\"\n                                }\n                            ],\n                            \"width\": \"stretch\"\n                        },\n                        {\n                            \"type\": \"Column\",\n                            \"width\": \"auto\",\n                            \"style\": \"attention\",\n                            \"items\": [\n                                {\n                                    \"type\": \"RichTextBlock\",\n                                    \"inlines\": [\n                                        {\n                                            \"type\": \"TextRun\",\n                                            \"text\": \"@{triggerBody()?['object']?['properties']?['severity']}\"\n                                        }\n                                    ]\n                                }\n                            ]\n                        }\n                    ]\n                },\n                {\n                    \"type\": \"TextBlock\",\n                    \"spacing\": \"Medium\",\n                    \"size\": \"Medium\",\n                    \"weight\": \"Bolder\",\n                    \"color\": \"Accent\",\n                    \"text\": \"@{triggerBody()?['object']?['properties']?['title']}\"\n                },\n                {\n                    \"type\": \"ActionSet\",\n                    \"actions\": [\n                        {\n                            \"type\": \"Action.OpenUrl\",\n                            \"title\": \"View incident\",\n                            \"url\": \"@{triggerBody()?['object']?['properties']?['incidentUrl']}\",\n                            \"id\": \"openSentinel\"\n                        }\n                    ]\n                }\n            ],\n            \"bleed\": true\n        },\n        {\n            \"type\": \"Container\",\n            \"items\": [\n                {\n                    \"type\": \"FactSet\",\n                    \"spacing\": \"Large\",\n                    \"facts\": [\n                        {\n                            \"title\": \"Creation time (UTC)\",\n                            \"value\": \"@{triggerBody()?['object']?['properties']?['createdTimeUtc']}\"\n                        },\n                        {\n                            \"title\": \"Tactics\",\n                            \"value\": \"@{triggerBody()?['object']?['properties']?['additionalData']?['tactics'][0]}\"\n                        },\n                        {\n                            \"title\": \"Corrective Action\",\n                            \"value\": \"SAP Audit Log on  @{variables('SID')} has been automatically re-activated. This is a critical event! You need to investigate the root cause.\"\n                        }\n                    ]\n                },\n                {\n                    \"type\": \"TextBlock\",\n                    \"text\": \"@{replace(replace(triggerBody()?['object']?['properties']?['description'],'\"','\\\"'),'\\\\','\\')}\",\n                    \"wrap\": true\n                }\n            ]\n        },\n        {\n            \"type\": \"Container\",\n            \"spacing\": \"Large\",\n            \"style\": \"emphasis\",\n            \"items\": [\n                {\n                    \"type\": \"TextBlock\",\n                    \"text\": \"Related Entities\",\n                    \"wrap\": true,\n                    \"separator\": true,\n                    \"fontType\": \"Default\",\n                    \"size\": \"Medium\",\n                    \"weight\": \"Bolder\"\n                },\n                {\n                    \"type\": \"ColumnSet\",\n                    \"columns\": @{outputs('Compose_dynamic_json_for_entities_table')}\n                }\n            ],\n            \"bleed\": true\n        }\n    ],\n    \"$schema\": \"http://adaptivecards.io/schemas/adaptive-card.json\",\n    \"version\": \"1.4\",\n    \"fallbackText\": \"This card requires Adaptive Cards v1.4 support to be rendered properly.\"\n}",
                                                    "recipient": {
                                                        "channelId": "@{variables('TeamsChannel')?['channelID']}",
                                                        "groupId": "@{variables('TeamsChannel')?['teamID']}"
                                                    }
                                                },
                                                "host": {
                                                    "connection": {
                                                        "name": "@parameters('$connections')['teams']['connectionId']"
                                                    }
                                                },
                                                "method": "post",
                                                "path": "/v1.0/teams/conversation/adaptivecard/poster/Flow bot/location/@{encodeURIComponent('Channel')}"
                                            }
                                        },
                                        "Re-activate_SAP_Audit_Log": {
                                            "runAfter": {
                                                "Set_Audit_Log_active_in_payload": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "Http",
                                            "inputs": {
                                                "authentication": {
                                                    "password": "@body('Get_secret_for_SAP_SOAP')?['value']",
                                                    "type": "Basic",
                                                    "username": "@body('Get_secret_for_SAP_SOAP')?['name']"
                                                },
                                                "body": {
                                                    "rSAU_API_SET_PARAM": "@json(variables('updated-params'))"
                                                },
                                                "headers": {
                                                    "Content-Type": "application/json"
                                                },
                                                "method": "POST",
                                                "uri": "@{variables('basePath')}auditlog/sap-com:document:sap:rfc:functions:ZWS_RSAU_API_SET_PARAM:RSAU_API_SET_PARAMRequest"
                                            }
                                        },
                                        "Set_Audit_Log_active_in_payload": {
                                            "runAfter": {
                                                "Translate_SAP_Audit_log_parameters_for_Update_request": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "InitializeVariable",
                                            "inputs": {
                                                "variables": [
                                                    {
                                                        "name": "updated-params",
                                                        "type": "string",
                                                        "value": "@{replace(variables('sap-log-params'),'\"iD_ACTIV\":\"\"','\"iD_ACTIV\":\"X\"')}"
                                                    }
                                                ]
                                            }
                                        },
                                        "Translate_SAP_Audit_log_parameters_for_Update_request": {
                                            "runAfter": {
                                                "Parse_JSON": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "InitializeVariable",
                                            "inputs": {
                                                "variables": [
                                                    {
                                                        "name": "sap-log-params",
                                                        "type": "string",
                                                        "value": "@{trim(replace(string(body('Parse_JSON')),'eD','iD'))}"
                                                    }
                                                ]
                                            }
                                        }
                                    }
                                },
                                "parameters": {
                                    "$connections": {
                                        "value": {
                                            "azuremonitorlogs_2": {
                                                "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzuremonitorlogsConnectionName'))]",
                                                "connectionName": "[[variables('AzuremonitorlogsConnectionName')]",
                                                "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Azuremonitorlogs')]"
                                            },
                                            "azuresentinel": {
                                                "connectionId": "[[resourceId('Microsoft.Web/connections', variables('MicrosoftSentinelConnectionName'))]",
                                                "connectionName": "[[variables('MicrosoftSentinelConnectionName')]",
                                                "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Azuresentinel')]",
                                                "connectionProperties": {
                                                    "authentication": {
                                                        "type": "ManagedServiceIdentity"
                                                    }
                                                }
                                            },
                                            "keyvault": {
                                                "connectionId": "[[resourceId('Microsoft.Web/connections', variables('KeyvaultConnectionName'))]",
                                                "connectionName": "[[variables('KeyvaultConnectionName')]",
                                                "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Keyvault')]"
                                            },
                                            "teams": {
                                                "connectionId": "[[resourceId('Microsoft.Web/connections', variables('TeamsConnectionName'))]",
                                                "connectionName": "[[variables('TeamsConnectionName')]",
                                                "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/Teams')]"
                                            }
                                        }
                                    }
                                }
                            },
                            "name": "[[parameters('PlaybookName')]",
                            "type": "Microsoft.Logic/workflows",
                            "location": "[[variables('workspace-location-inline')]",
                            "identity": {
                                "type": "SystemAssigned"
                            },
                            "apiVersion": "2017-07-01",
                            "dependsOn": [
                                "[[resourceId('Microsoft.Web/connections', variables('AzuremonitorlogsConnectionName'))]",
                                "[[resourceId('Microsoft.Web/connections', variables('MicrosoftSentinelConnectionName'))]",
                                "[[resourceId('Microsoft.Web/connections', variables('KeyvaultConnectionName'))]",
                                "[[resourceId('Microsoft.Web/connections', variables('TeamsConnectionName'))]"
                            ],
                            "tags": {
                                "hidden-SentinelTemplateVersion": "2.0.65",
                                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
                            }
                        },
                        {
                            "type": "Microsoft.Web/connections",
                            "apiVersion": "2016-06-01",
                            "name": "[[variables('AzuremonitorlogsConnectionName')]",
                            "location": "[[variables('workspace-location-inline')]",
                            "kind": "V1",
                            "properties": {
                                "displayName": "[[variables('AzuremonitorlogsConnectionName')]",
                                "api": {
                                    "id": "[[variables('_connection-2')]"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.Web/connections",
                            "apiVersion": "2016-06-01",
                            "name": "[[variables('MicrosoftSentinelConnectionName')]",
                            "location": "[[variables('workspace-location-inline')]",
                            "kind": "V1",
                            "properties": {
                                "displayName": "[[variables('MicrosoftSentinelConnectionName')]",
                                "parameterValueType": "Alternative",
                                "api": {
                                    "id": "[[variables('_connection-3')]"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.Web/connections",
                            "apiVersion": "2016-06-01",
                            "name": "[[variables('KeyvaultConnectionName')]",
                            "location": "[[variables('workspace-location-inline')]",
                            "kind": "V1",
                            "properties": {
                                "displayName": "[[variables('KeyvaultConnectionName')]",
                                "api": {
                                    "id": "[[variables('_connection-4')]"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.Web/connections",
                            "apiVersion": "2016-06-01",
                            "name": "[[variables('TeamsConnectionName')]",
                            "location": "[[variables('workspace-location-inline')]",
                            "kind": "V1",
                            "properties": {
                                "displayName": "[[variables('TeamsConnectionName')]",
                                "api": {
                                    "id": "[[variables('_connection-5')]"
                                }
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId3'),'/'))))]",
                            "properties": {
                                "parentId": "[variables('playbookId3')]",
                                "contentId": "[variables('_playbookContentId3')]",
                                "kind": "Playbook",
                                "version": "[variables('playbookVersion3')]",
                                "source": {
                                    "kind": "Solution",
                                    "name": "SAP",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ],
                    "metadata": {
                        "title": "SAP Incident response- re-enable audit logging once deactivated",
                        "description": "This playbook provides automatic response to incidents created by the alert rule 'SAP - Deactivation of Security Audit Log' by sending an audit log enable request to the corresponding SAP system.SAP incident response can also be achieved in standard logic app based playbooks. See [SAP automation scenarios on GitHub](https://github.com/Azure/Azure-Sentinel/blob/master/Solutions/SAP/Playbooks/README.md) for more information.",
                        "prerequisites": [
                            "1. Once deployment is complete, you will need to authorize each connection.",
                            "2. Navigate to playbook --> API Connections --> Select connections one by one --> Edit API Connection --> (if required) Enter API key or credentials --> Save"
                        ],
                        "postDeployment": [
                            "1. Once deployment is complete, you will need to authorize each connection.",
                            "2. Navigate to playbook --> API Connections --> Select connections one by one --> Edit API Connection --> (if required) Enter API key or credentials --> Save"
                        ],
                        "lastUpdateTime": "2023-05-17T00:00:00Z",
                        "entities": [
                            "ip",
                            "Account"
                        ],
                        "tags": [
                            "workflow",
                            "SAP",
                            "Active directory",
                            "SAP User",
                            "Block SAP User",
                            "Block AD User"
                        ],
                        "releaseNotes": {
                            "version": "2.0.65",
                            "title": "[variables('blanks')]",
                            "notes": [
                                "Initial version"
                            ]
                        }
                    }
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('_playbookContentId3')]",
                "contentKind": "Playbook",
                "displayName": "SAPReEnableAuditLog",
                "contentProductId": "[variables('_playbookcontentProductId3')]",
                "id": "[variables('_playbookcontentProductId3')]",
                "version": "[variables('playbookVersion3')]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('parserTemplateSpecName1')]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAPAppLog Data Parser with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('parserObject1').parserVersion1]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "name": "[variables('parserObject1')._parserName1]",
                            "apiVersion": "2022-10-01",
                            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "eTag": "*",
                                "displayName": "SAPAppLog",
                                "category": "SAPFunctions",
                                "functionAlias": "SAPAppLog",
                                "query": "[replace(variables('SAPFunctionsSAPAppLogQuery'),'CWSQSAP.', if(equals(coalesce(parameters('CWSQSAPIdentifier'),''),'') , '', concat(variables('CWSQIdentifierPrefix'), parameters('CWSQSAPIdentifier'),variables('CWQSIdentifierSuffix'))))]",
                                "functionParameters": "",
                                "version": 2,
                                "tags": [
                                    {
                                        "name": "description",
                                        "value": "SAPAppLog"
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId1'),'/'))))]",
                            "dependsOn": [
                                "[variables('_parserId1')]"
                            ],
                            "properties": {
                                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPAppLog')]",
                                "contentId": "[variables('parserObject1').parserContentId1]",
                                "kind": "Parser",
                                "version": "[variables('parserObject1').parserVersion1]",
                                "source": {
                                    "name": "SAP",
                                    "kind": "Solution",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('parserObject1').parserContentId1]",
                "contentKind": "Parser",
                "displayName": "SAPAppLog",
                "contentProductId": "[variables('_parsercontentProductId1')]",
                "id": "[variables('_parsercontentProductId1')]",
                "version": "[variables('parserObject1').parserVersion1]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
            "apiVersion": "2022-10-01",
            "name": "[variables('parserObject1')._parserName1]",
            "location": "[parameters('workspace-location')]",
            "properties": {
                "eTag": "*",
                "displayName": "SAPAppLog",
                "category": "SAPFunctions",
                "functionAlias": "SAPAppLog",
                "query": "[replace(variables('SAPFunctionsSAPAppLogQuery'),'CWSQSAP.', if(equals(coalesce(parameters('CWSQSAPIdentifier'),''),'') , '', concat(variables('CWSQIdentifierPrefix'), parameters('CWSQSAPIdentifier'),variables('CWQSIdentifierSuffix'))))]",
                "functionParameters": "",
                "version": 2,
                "tags": [
                    {
                        "name": "description",
                        "value": "SAPAppLog"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
            "apiVersion": "2022-01-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId1'),'/'))))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[variables('_parserId1')]"
            ],
            "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPAppLog')]",
                "contentId": "[variables('parserObject1').parserContentId1]",
                "kind": "Parser",
                "version": "[variables('parserObject1').parserVersion1]",
                "source": {
                    "kind": "Solution",
                    "name": "SAP",
                    "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                    "name": "Microsoft",
                    "email": "[variables('_email')]"
                },
                "support": {
                    "tier": "Microsoft",
                    "name": "Microsoft Corporation",
                    "email": "support@microsoft.com",
                    "link": "https://support.microsoft.com/"
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('parserTemplateSpecName2')]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAPAuditLog Data Parser with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('parserObject2').parserVersion2]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "name": "[variables('parserObject2')._parserName2]",
                            "apiVersion": "2022-10-01",
                            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "eTag": "*",
                                "displayName": "SAPAuditLog",
                                "category": "SAPFunctions",
                                "functionAlias": "SAPAuditLog",
                                "query": "[replace(variables('SAPFunctionsSAPAuditLogQuery'),'CWSQSAP.', if(equals(coalesce(parameters('CWSQSAPIdentifier'),''),'') , '', concat(variables('CWSQIdentifierPrefix'), parameters('CWSQSAPIdentifier'),variables('CWQSIdentifierSuffix'))))]",
                                "functionParameters": "",
                                "version": 2,
                                "tags": [
                                    {
                                        "name": "description",
                                        "value": "SAPAuditLog"
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId2'),'/'))))]",
                            "dependsOn": [
                                "[variables('_parserId2')]"
                            ],
                            "properties": {
                                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPAuditLog')]",
                                "contentId": "[variables('parserObject2').parserContentId2]",
                                "kind": "Parser",
                                "version": "[variables('parserObject2').parserVersion2]",
                                "source": {
                                    "name": "SAP",
                                    "kind": "Solution",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('parserObject2').parserContentId2]",
                "contentKind": "Parser",
                "displayName": "SAPAuditLog",
                "contentProductId": "[variables('_parsercontentProductId2')]",
                "id": "[variables('_parsercontentProductId2')]",
                "version": "[variables('parserObject2').parserVersion2]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
            "apiVersion": "2022-10-01",
            "name": "[variables('parserObject2')._parserName2]",
            "location": "[parameters('workspace-location')]",
            "properties": {
                "eTag": "*",
                "displayName": "SAPAuditLog",
                "category": "SAPFunctions",
                "functionAlias": "SAPAuditLog",
                "query": "[replace(variables('SAPFunctionsSAPAuditLogQuery'),'CWSQSAP.', if(equals(coalesce(parameters('CWSQSAPIdentifier'),''),'') , '', concat(variables('CWSQIdentifierPrefix'), parameters('CWSQSAPIdentifier'),variables('CWQSIdentifierSuffix'))))]",
                "functionParameters": "",
                "version": 2,
                "tags": [
                    {
                        "name": "description",
                        "value": "SAPAuditLog"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
            "apiVersion": "2022-01-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId2'),'/'))))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[variables('_parserId2')]"
            ],
            "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPAuditLog')]",
                "contentId": "[variables('parserObject2').parserContentId2]",
                "kind": "Parser",
                "version": "[variables('parserObject2').parserVersion2]",
                "source": {
                    "kind": "Solution",
                    "name": "SAP",
                    "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                    "name": "Microsoft",
                    "email": "[variables('_email')]"
                },
                "support": {
                    "tier": "Microsoft",
                    "name": "Microsoft Corporation",
                    "email": "support@microsoft.com",
                    "link": "https://support.microsoft.com/"
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('parserTemplateSpecName3')]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAPAuditLogAnomalies Data Parser with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('parserObject3').parserVersion3]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "name": "[variables('parserObject3')._parserName3]",
                            "apiVersion": "2022-10-01",
                            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "eTag": "*",
                                "displayName": "SAPAuditLogAnomalies",
                                "category": "SAPFunctions",
                                "functionAlias": "SAPAuditLogAnomalies",
                                "query": "////// get anomalies from the SAPAuditLog\n//// Dynamic parameters\n// let LearningTime = 14d;\n// let DetectingTime = 1h;// use 1 h for alerting on anomalies // can also do // let DetectingTime = 0h;//0h for seeing anomalies across all training data\n// let SelectedSystems =  dynamic([\"All Systems\"]);//can also do// let SelectedSystems =  dynamic([\"S4P\", \"B4X\", \"ODT\"]);\n// let SelectedSystemRoles =  dynamic([\"All System Roles\"]); //can also do// let SelectedSystemRoles =  dynamic([\"Production\", \"UAT\"]);\n// let SelectedSeverities=  dynamic([\"High\", \"Medium\"]);//can also do dynamic([\"All Severities\"]), dynamic([\"High\", \"Medium\", \"Low\"])\n// let SelectedRuleTypes= dynamic([\"AnomaliesOnly\"]);\n// let SelectedPrefixMask = 24;\n// // other potential values can be:\n// // let SelectedRuleTypes= dynamic([\"Deterministic\"]);\n// // let SelectedRuleTypes = dynamic([\"All RuleTypes\"]);\n//// Static parameters\n// If DetectingTime==0h, we want anomalies to show across all training time as well\n// 1h hour detecting will spill over 2 hour bins\nlet ActualDetectingTime= iff(DetectingTime == 0h, LearningTime, DetectingTime + 1h);\nlet TestPoints= iff(DetectingTime == 0h, 0, toint((DetectingTime + 1h) / 1h));\nlet Now = now();\nlet AnomalyThreshold= 2;\nlet AnomalyTrendKind= 'linefit';// can be 'linefit', 'avg' or 'none'\nlet AnomalySeasonality= 24; // can be 0, or number of bins, -1 is AutoDetect\nlet AnomalyAD_method = 'ctukey'; // 'ctukey' = 10th-90th percentile, 'tukey' = 25th-75th percentile range\n// get special users for exclusion and in-focus analysis\nlet SAPUsersGottenVIP = materialize(SAPUsersGetVIP\n    | project User = SAPUser, TagsList);\nlet SAPUserRolesAndProfiles = (SAPUsersAssignments\n    | project-keep User, SystemID, DirectRoles, ChildRoles, Profiles\n    | summarize RolesAndProfiles = make_set(array_concat(DirectRoles, ChildRoles, Profiles), 120) by User, SystemID);\n// get the configuration from the \"SAPAuditLogConfiguration\" watchlist which allows\n// assigning severity levels per system Role (Production/ non-production), automatic team assignments and other configuration options\nlet AuditConfiguration= materialize(SAPAuditLogConfiguration(SelectedSystems, SelectedSystemRoles, SelectedSeverities= SelectedSeverities, SelectedRuleTypes= SelectedRuleTypes)\n    | extend FrequencyThreshold= Threshold);\n// get relevant audit events according to configuration\nlet AuditEvents = (SAPAuditLog\n        | where TimeGenerated > ago(LearningTime)\n        | where SystemID in ((AuditConfiguration | summarize  by SystemID))\n        | where MessageID in ((AuditConfiguration | summarize  by MessageID))\n        // Alerts coming from SAP as \"Low\" or missing User ID aren't very intersting\n        | where AlertSeverityText != \"Low\" and isnotempty(User)\n        | join kind= leftsemi AuditConfiguration on SystemID, MessageID\n        | project-away\n            AuditClassID,\n            AlertSeverityText,\n            MonitoringObjectName,\n            MonitorShortName,\n            AlertValue,\n            AlertSeverity,\n            Variable1,\n            Variable2,\n            Variable3,\n            Variable4,\n            Type,\n            SystemNumber\n        | extend HourOfDay= hourofday(TimeGenerated) * 1h + startofday(TimeGenerated));\n// create time-series\nlet TimeSeriesLog = AuditEvents\n    | where TimeGenerated > ago(LearningTime)\n    // aggregate by sub net\n    | extend IPRange = format_ipv4(TerminalIPv6, SelectedPrefixMask)\n    | make-series Count= count()\n        on TimeGenerated\n        from (startofday(ago(LearningTime)) + hourofday(Now) * 1h)to Now step 1h\n        by\n        SystemID, MessageID, User, IPRange\n        | lookup (AuditConfiguration | project SystemID, MessageID, FrequencyThreshold) on SystemID, MessageID;\n// detect anomalies at aggregated level\nlet TimeSeriesAlerts= TimeSeriesLog\n    | extend (anomalies, score, baseline) = series_decompose_anomalies(Count, Threshold= AnomalyThreshold, Seasonality= AnomalySeasonality, Trend= AnomalyTrendKind, Test_points= TestPoints)\n    // expand to hourly\n    | mv-expand\n        Count to typeof(double),\n        TimeGenerated to typeof(datetime),\n        anomalies to typeof(double),\n        score to typeof(double),\n        baseline to typeof(long)\n    | where TimeGenerated >= ago(ActualDetectingTime)\n    // apply anomaly filters + thesholds\n    | where anomalies > 0\n    | where score > 2\n    | where Count > FrequencyThreshold\n    | project-rename DiscoveredOn= TimeGenerated, AnomalCount= Count\n    | project\n        SystemID,\n        MessageID,\n        User,\n        DiscoveredOn,\n        score,\n        baseline,\n        AnomalCount,\n        FrequencyThreshold\n    // To reduce false positives, exclude users whos tags in the SAP_User_Config watchlist\n// match tags in the RolesTagsToExclude column in the SAP_Dynamic_Audit_Log_Monitor_Configuration\n// tags can be either strings representing a group such as Batch; Sensitive; Super; MassiveLogonsOK; MassiveRFCOK; GenericTablebyRFCOK\n// or SAP roles such as SAP_BC_TRANSPORT_ADMINISTRATOR, or SAP profiles like SAP_ALL\n    | lookup AuditConfiguration on MessageID, SystemID\n    | lookup SAPUsersGottenVIP on User\n    | lookup SAPUserRolesAndProfiles on User, SystemID\n    | extend RolesProfilesAndTags = array_concat(RolesAndProfiles, TagsList)\n    | extend TagsIntersect = set_intersect(split(RolesTagsToExclude, \";\"), RolesProfilesAndTags)\n    | extend IntersectionSize = array_length(TagsIntersect)\n    // keep only non-excluded users\n    | where IntersectionSize == 0 or isempty(IntersectionSize)\n    | project-away MessageText\n    // fetch detailed data for anomal combinations\n    | join kind= inner (AuditEvents\n        | where TimeGenerated > ago(ActualDetectingTime))\n        on User, SystemID, MessageID, $left.DiscoveredOn == $right.HourOfDay\n| summarize EventCount= count(), AnomalCount= max(AnomalCount), MinTime= min(TimeGenerated), MaxTime = max(TimeGenerated), Score= max(score)\n, take_any(Instance, MessageClass, ClientID, TerminalIPv6, TransactionCode, ABAPProgramName, SAPProcesType, SAPWPName, Email, Host, BagOfDetails, DetailedDescription, Threshold, CategoryName, DestinationEmail,  Tactics, TeamsChannelID, SystemRole, SystemUsage, IsProd, Severity, BagOfDetails, RolesTagsToExclude)\nby DiscoveredOn, SystemID, MessageText, User, MessageID\n| extend BagOfDetails = tostring(BagOfDetails);\nTimeSeriesAlerts\n",
                                "functionParameters": "LearningTime:timespan=14d,DetectingTime:timespan=1h,SelectedSystems:dynamic=dynamic([\"All Systems\"]),SelectedSystemRoles:dynamic=dynamic([\"All System Roles\"]),SelectedSeverities:dynamic=dynamic([\"High\", \"Medium\"]),SelectedPrefixMask:int=24,SelectedRuleTypes:dynamic=dynamic([\"AnomaliesOnly\"])",
                                "version": 2,
                                "tags": [
                                    {
                                        "name": "description",
                                        "value": "SAPAuditLogAnomalies"
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId3'),'/'))))]",
                            "dependsOn": [
                                "[variables('_parserId3')]"
                            ],
                            "properties": {
                                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPAuditLogAnomalies')]",
                                "contentId": "[variables('parserObject3').parserContentId3]",
                                "kind": "Parser",
                                "version": "[variables('parserObject3').parserVersion3]",
                                "source": {
                                    "name": "SAP",
                                    "kind": "Solution",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('parserObject3').parserContentId3]",
                "contentKind": "Parser",
                "displayName": "SAPAuditLogAnomalies",
                "contentProductId": "[variables('_parsercontentProductId3')]",
                "id": "[variables('_parsercontentProductId3')]",
                "version": "[variables('parserObject3').parserVersion3]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
            "apiVersion": "2022-10-01",
            "name": "[variables('parserObject3')._parserName3]",
            "location": "[parameters('workspace-location')]",
            "properties": {
                "eTag": "*",
                "displayName": "SAPAuditLogAnomalies",
                "category": "SAPFunctions",
                "functionAlias": "SAPAuditLogAnomalies",
                "query": "////// get anomalies from the SAPAuditLog\n//// Dynamic parameters\n// let LearningTime = 14d;\n// let DetectingTime = 1h;// use 1 h for alerting on anomalies // can also do // let DetectingTime = 0h;//0h for seeing anomalies across all training data\n// let SelectedSystems =  dynamic([\"All Systems\"]);//can also do// let SelectedSystems =  dynamic([\"S4P\", \"B4X\", \"ODT\"]);\n// let SelectedSystemRoles =  dynamic([\"All System Roles\"]); //can also do// let SelectedSystemRoles =  dynamic([\"Production\", \"UAT\"]);\n// let SelectedSeverities=  dynamic([\"High\", \"Medium\"]);//can also do dynamic([\"All Severities\"]), dynamic([\"High\", \"Medium\", \"Low\"])\n// let SelectedRuleTypes= dynamic([\"AnomaliesOnly\"]);\n// let SelectedPrefixMask = 24;\n// // other potential values can be:\n// // let SelectedRuleTypes= dynamic([\"Deterministic\"]);\n// // let SelectedRuleTypes = dynamic([\"All RuleTypes\"]);\n//// Static parameters\n// If DetectingTime==0h, we want anomalies to show across all training time as well\n// 1h hour detecting will spill over 2 hour bins\nlet ActualDetectingTime= iff(DetectingTime == 0h, LearningTime, DetectingTime + 1h);\nlet TestPoints= iff(DetectingTime == 0h, 0, toint((DetectingTime + 1h) / 1h));\nlet Now = now();\nlet AnomalyThreshold= 2;\nlet AnomalyTrendKind= 'linefit';// can be 'linefit', 'avg' or 'none'\nlet AnomalySeasonality= 24; // can be 0, or number of bins, -1 is AutoDetect\nlet AnomalyAD_method = 'ctukey'; // 'ctukey' = 10th-90th percentile, 'tukey' = 25th-75th percentile range\n// get special users for exclusion and in-focus analysis\nlet SAPUsersGottenVIP = materialize(SAPUsersGetVIP\n    | project User = SAPUser, TagsList);\nlet SAPUserRolesAndProfiles = (SAPUsersAssignments\n    | project-keep User, SystemID, DirectRoles, ChildRoles, Profiles\n    | summarize RolesAndProfiles = make_set(array_concat(DirectRoles, ChildRoles, Profiles), 120) by User, SystemID);\n// get the configuration from the \"SAPAuditLogConfiguration\" watchlist which allows\n// assigning severity levels per system Role (Production/ non-production), automatic team assignments and other configuration options\nlet AuditConfiguration= materialize(SAPAuditLogConfiguration(SelectedSystems, SelectedSystemRoles, SelectedSeverities= SelectedSeverities, SelectedRuleTypes= SelectedRuleTypes)\n    | extend FrequencyThreshold= Threshold);\n// get relevant audit events according to configuration\nlet AuditEvents = (SAPAuditLog\n        | where TimeGenerated > ago(LearningTime)\n        | where SystemID in ((AuditConfiguration | summarize  by SystemID))\n        | where MessageID in ((AuditConfiguration | summarize  by MessageID))\n        // Alerts coming from SAP as \"Low\" or missing User ID aren't very intersting\n        | where AlertSeverityText != \"Low\" and isnotempty(User)\n        | join kind= leftsemi AuditConfiguration on SystemID, MessageID\n        | project-away\n            AuditClassID,\n            AlertSeverityText,\n            MonitoringObjectName,\n            MonitorShortName,\n            AlertValue,\n            AlertSeverity,\n            Variable1,\n            Variable2,\n            Variable3,\n            Variable4,\n            Type,\n            SystemNumber\n        | extend HourOfDay= hourofday(TimeGenerated) * 1h + startofday(TimeGenerated));\n// create time-series\nlet TimeSeriesLog = AuditEvents\n    | where TimeGenerated > ago(LearningTime)\n    // aggregate by sub net\n    | extend IPRange = format_ipv4(TerminalIPv6, SelectedPrefixMask)\n    | make-series Count= count()\n        on TimeGenerated\n        from (startofday(ago(LearningTime)) + hourofday(Now) * 1h)to Now step 1h\n        by\n        SystemID, MessageID, User, IPRange\n        | lookup (AuditConfiguration | project SystemID, MessageID, FrequencyThreshold) on SystemID, MessageID;\n// detect anomalies at aggregated level\nlet TimeSeriesAlerts= TimeSeriesLog\n    | extend (anomalies, score, baseline) = series_decompose_anomalies(Count, Threshold= AnomalyThreshold, Seasonality= AnomalySeasonality, Trend= AnomalyTrendKind, Test_points= TestPoints)\n    // expand to hourly\n    | mv-expand\n        Count to typeof(double),\n        TimeGenerated to typeof(datetime),\n        anomalies to typeof(double),\n        score to typeof(double),\n        baseline to typeof(long)\n    | where TimeGenerated >= ago(ActualDetectingTime)\n    // apply anomaly filters + thesholds\n    | where anomalies > 0\n    | where score > 2\n    | where Count > FrequencyThreshold\n    | project-rename DiscoveredOn= TimeGenerated, AnomalCount= Count\n    | project\n        SystemID,\n        MessageID,\n        User,\n        DiscoveredOn,\n        score,\n        baseline,\n        AnomalCount,\n        FrequencyThreshold\n    // To reduce false positives, exclude users whos tags in the SAP_User_Config watchlist\n// match tags in the RolesTagsToExclude column in the SAP_Dynamic_Audit_Log_Monitor_Configuration\n// tags can be either strings representing a group such as Batch; Sensitive; Super; MassiveLogonsOK; MassiveRFCOK; GenericTablebyRFCOK\n// or SAP roles such as SAP_BC_TRANSPORT_ADMINISTRATOR, or SAP profiles like SAP_ALL\n    | lookup AuditConfiguration on MessageID, SystemID\n    | lookup SAPUsersGottenVIP on User\n    | lookup SAPUserRolesAndProfiles on User, SystemID\n    | extend RolesProfilesAndTags = array_concat(RolesAndProfiles, TagsList)\n    | extend TagsIntersect = set_intersect(split(RolesTagsToExclude, \";\"), RolesProfilesAndTags)\n    | extend IntersectionSize = array_length(TagsIntersect)\n    // keep only non-excluded users\n    | where IntersectionSize == 0 or isempty(IntersectionSize)\n    | project-away MessageText\n    // fetch detailed data for anomal combinations\n    | join kind= inner (AuditEvents\n        | where TimeGenerated > ago(ActualDetectingTime))\n        on User, SystemID, MessageID, $left.DiscoveredOn == $right.HourOfDay\n| summarize EventCount= count(), AnomalCount= max(AnomalCount), MinTime= min(TimeGenerated), MaxTime = max(TimeGenerated), Score= max(score)\n, take_any(Instance, MessageClass, ClientID, TerminalIPv6, TransactionCode, ABAPProgramName, SAPProcesType, SAPWPName, Email, Host, BagOfDetails, DetailedDescription, Threshold, CategoryName, DestinationEmail,  Tactics, TeamsChannelID, SystemRole, SystemUsage, IsProd, Severity, BagOfDetails, RolesTagsToExclude)\nby DiscoveredOn, SystemID, MessageText, User, MessageID\n| extend BagOfDetails = tostring(BagOfDetails);\nTimeSeriesAlerts\n",
                "functionParameters": "LearningTime:timespan=14d,DetectingTime:timespan=1h,SelectedSystems:dynamic=dynamic([\"All Systems\"]),SelectedSystemRoles:dynamic=dynamic([\"All System Roles\"]),SelectedSeverities:dynamic=dynamic([\"High\", \"Medium\"]),SelectedPrefixMask:int=24,SelectedRuleTypes:dynamic=dynamic([\"AnomaliesOnly\"])",
                "version": 2,
                "tags": [
                    {
                        "name": "description",
                        "value": "SAPAuditLogAnomalies"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
            "apiVersion": "2022-01-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId3'),'/'))))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[variables('_parserId3')]"
            ],
            "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPAuditLogAnomalies')]",
                "contentId": "[variables('parserObject3').parserContentId3]",
                "kind": "Parser",
                "version": "[variables('parserObject3').parserVersion3]",
                "source": {
                    "kind": "Solution",
                    "name": "SAP",
                    "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                    "name": "Microsoft",
                    "email": "[variables('_email')]"
                },
                "support": {
                    "tier": "Microsoft",
                    "name": "Microsoft Corporation",
                    "email": "support@microsoft.com",
                    "link": "https://support.microsoft.com/"
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('parserTemplateSpecName4')]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAPAuditLogConfigRecommend Data Parser with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('parserObject4').parserVersion4]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "name": "[variables('parserObject4')._parserName4]",
                            "apiVersion": "2022-10-01",
                            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "eTag": "*",
                                "displayName": "SAPAuditLogConfigRecommend",
                                "category": "SAPFunctions",
                                "functionAlias": "SAPAuditLogConfigRecommend",
                                "query": "// This query aims to give configuration recommendations related to the handling of the anomaly detection rules\n// performed on the SAP audit log\nlet LearningTime = 14d;\n// get anomalies from the last 14 days\nlet MaterAnoms= materialize(SAPAuditLogAnomalies(DetectingTime= 0h, LearningTime= LearningTime));\nlet UserRolesProfiles= SAPUsersAssignments()\n| summarize DirectRoles= make_set_if(DirectRoles, isnotempty( DirectRoles), 50) , ChildRoles= make_set_if(ChildRoles, isnotempty( ChildRoles),20), Profiles= make_set_if(Profiles, array_length(Profiles) > 0, 50) by User, SystemID, ClientID= Client\n| extend Roles= array_concat(DirectRoles, ChildRoles);\n// overview of all anomalies\nlet AnomalyCount= MaterAnoms\n    | summarize Count= count() * 1.00\n    | extend\n        Issue= strcat(\"Total Anomalies counted within the last \", format_timespan(LearningTime, 'd'), ' days'),\n        Recommendation= '',\n        Sort= 100;\n// daily average\nlet DailyAnomalyCount= MaterAnoms\n    | summarize Count= count() * (1d / LearningTime)\n    | extend\n        Issue= iff(Count > 10, strcat(\"Daily average anomaly count of \", toint(Count), \" is too high\"), strcat(\"Expected daily incident count is \", toint(Count))),\n        Recommendation= 'Consider the recommendations below to further configure your SAP audit log alerting',\n        Sort= 90;\nlet NoiseThreshold= max_of(toscalar(DailyAnomalyCount\n    | project Count) / 10, 10);\n//  Recommended tags to be added\nlet RecommendedTagsToAdd= MaterAnoms\n    | where isempty(RolesTagsToExclude)\n    | summarize Count= count() * 1.00 by MessageID\n    | where Count > NoiseThreshold\n    | extend\n        Issue= 'Noisey MessageIDs- add tags',\n        Recommendation= strcat(\"Create Tags for MessageID \", MessageID, \" using the SAP_Dynamic_Audit_Log_Monitor_Configuration watchlist\"),\n        Sort= 80;\n// recommended users to assign with tags\nlet RecommendedTagsPerUser= MaterAnoms\n    | where isnotempty(RolesTagsToExclude) and tostring(RolesTagsToExclude)!= '[\"nan\"]'\n    | summarize\n        Count= count() * 1.00,\n        Values= make_set_if(RolesTagsToExclude, isnotempty(RolesTagsToExclude) or tostring(RolesTagsToExclude)!= '[\"nan\"]', 50)\n        by User\n    | where Count > NoiseThreshold\n    | extend\n        Issue= 'Noisey Users',\n        Recommendation= strcat(\"Add the tags \", tostring(Values), \" to user \", User, \" using the SAP_User_Config watchlist\"),\n        Sort= 70;\n// recommended profiles to add to Message IDs\nlet RecommendedProfilesToAdd= MaterAnoms\n    | join kind= inner UserRolesProfiles on User, SystemID, ClientID\n    | where array_length(Profiles) > 0\n    | summarize\n        Count= count() * 1.00,\n        Values= make_set(Profiles, 50)\n        by MessageID\n    | where Count > NoiseThreshold\n    | extend\n        Issue= 'Noisey MessageIDs- add profiles',\n        Recommendation= strcat(\"Add the Profiles \", tostring(Values),\" as RolesTagsToExclude next to MessageID  \", MessageID, \" in the SAP_Dynamic_Audit_Log_Monitor_Configuration watchlist\"),\n        Sort= 60;\n// recommended Roles to add to Message IDs\nlet RecommendedRolesToAdd= MaterAnoms\n    | join kind= inner UserRolesProfiles on User, SystemID, ClientID\n    | where array_length(Roles) > 0\n    | summarize\n        Count= count() * 1.00,\n        Values= make_set(Roles, 50)\n        by MessageID\n    | where Count > NoiseThreshold\n    | extend\n        Issue= 'Noisey MessageIDs- add roles',\n        Recommendation= strcat(\"Add the Roles \", tostring(Values),\" as RolesTagsToExclude next to MessageID \", MessageID, \" in the SAP_Dynamic_Audit_Log_Monitor_Configuration watchlist\"),\n        Sort= 50;\n// query\nunion AnomalyCount, DailyAnomalyCount, RecommendedTagsPerUser, RecommendedTagsToAdd, RecommendedProfilesToAdd, RecommendedRolesToAdd\n| order by Sort, Count desc\n| project IncidentCount= toint(Count), Issue, Recommendation\n",
                                "functionParameters": "",
                                "version": 2,
                                "tags": [
                                    {
                                        "name": "description",
                                        "value": "SAPAuditLogConfigRecommend"
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId4'),'/'))))]",
                            "dependsOn": [
                                "[variables('_parserId4')]"
                            ],
                            "properties": {
                                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPAuditLogConfigRecommend')]",
                                "contentId": "[variables('parserObject4').parserContentId4]",
                                "kind": "Parser",
                                "version": "[variables('parserObject4').parserVersion4]",
                                "source": {
                                    "name": "SAP",
                                    "kind": "Solution",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('parserObject4').parserContentId4]",
                "contentKind": "Parser",
                "displayName": "SAPAuditLogConfigRecommend",
                "contentProductId": "[variables('_parsercontentProductId4')]",
                "id": "[variables('_parsercontentProductId4')]",
                "version": "[variables('parserObject4').parserVersion4]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
            "apiVersion": "2022-10-01",
            "name": "[variables('parserObject4')._parserName4]",
            "location": "[parameters('workspace-location')]",
            "properties": {
                "eTag": "*",
                "displayName": "SAPAuditLogConfigRecommend",
                "category": "SAPFunctions",
                "functionAlias": "SAPAuditLogConfigRecommend",
                "query": "// This query aims to give configuration recommendations related to the handling of the anomaly detection rules\n// performed on the SAP audit log\nlet LearningTime = 14d;\n// get anomalies from the last 14 days\nlet MaterAnoms= materialize(SAPAuditLogAnomalies(DetectingTime= 0h, LearningTime= LearningTime));\nlet UserRolesProfiles= SAPUsersAssignments()\n| summarize DirectRoles= make_set_if(DirectRoles, isnotempty( DirectRoles), 50) , ChildRoles= make_set_if(ChildRoles, isnotempty( ChildRoles),20), Profiles= make_set_if(Profiles, array_length(Profiles) > 0, 50) by User, SystemID, ClientID= Client\n| extend Roles= array_concat(DirectRoles, ChildRoles);\n// overview of all anomalies\nlet AnomalyCount= MaterAnoms\n    | summarize Count= count() * 1.00\n    | extend\n        Issue= strcat(\"Total Anomalies counted within the last \", format_timespan(LearningTime, 'd'), ' days'),\n        Recommendation= '',\n        Sort= 100;\n// daily average\nlet DailyAnomalyCount= MaterAnoms\n    | summarize Count= count() * (1d / LearningTime)\n    | extend\n        Issue= iff(Count > 10, strcat(\"Daily average anomaly count of \", toint(Count), \" is too high\"), strcat(\"Expected daily incident count is \", toint(Count))),\n        Recommendation= 'Consider the recommendations below to further configure your SAP audit log alerting',\n        Sort= 90;\nlet NoiseThreshold= max_of(toscalar(DailyAnomalyCount\n    | project Count) / 10, 10);\n//  Recommended tags to be added\nlet RecommendedTagsToAdd= MaterAnoms\n    | where isempty(RolesTagsToExclude)\n    | summarize Count= count() * 1.00 by MessageID\n    | where Count > NoiseThreshold\n    | extend\n        Issue= 'Noisey MessageIDs- add tags',\n        Recommendation= strcat(\"Create Tags for MessageID \", MessageID, \" using the SAP_Dynamic_Audit_Log_Monitor_Configuration watchlist\"),\n        Sort= 80;\n// recommended users to assign with tags\nlet RecommendedTagsPerUser= MaterAnoms\n    | where isnotempty(RolesTagsToExclude) and tostring(RolesTagsToExclude)!= '[\"nan\"]'\n    | summarize\n        Count= count() * 1.00,\n        Values= make_set_if(RolesTagsToExclude, isnotempty(RolesTagsToExclude) or tostring(RolesTagsToExclude)!= '[\"nan\"]', 50)\n        by User\n    | where Count > NoiseThreshold\n    | extend\n        Issue= 'Noisey Users',\n        Recommendation= strcat(\"Add the tags \", tostring(Values), \" to user \", User, \" using the SAP_User_Config watchlist\"),\n        Sort= 70;\n// recommended profiles to add to Message IDs\nlet RecommendedProfilesToAdd= MaterAnoms\n    | join kind= inner UserRolesProfiles on User, SystemID, ClientID\n    | where array_length(Profiles) > 0\n    | summarize\n        Count= count() * 1.00,\n        Values= make_set(Profiles, 50)\n        by MessageID\n    | where Count > NoiseThreshold\n    | extend\n        Issue= 'Noisey MessageIDs- add profiles',\n        Recommendation= strcat(\"Add the Profiles \", tostring(Values),\" as RolesTagsToExclude next to MessageID  \", MessageID, \" in the SAP_Dynamic_Audit_Log_Monitor_Configuration watchlist\"),\n        Sort= 60;\n// recommended Roles to add to Message IDs\nlet RecommendedRolesToAdd= MaterAnoms\n    | join kind= inner UserRolesProfiles on User, SystemID, ClientID\n    | where array_length(Roles) > 0\n    | summarize\n        Count= count() * 1.00,\n        Values= make_set(Roles, 50)\n        by MessageID\n    | where Count > NoiseThreshold\n    | extend\n        Issue= 'Noisey MessageIDs- add roles',\n        Recommendation= strcat(\"Add the Roles \", tostring(Values),\" as RolesTagsToExclude next to MessageID \", MessageID, \" in the SAP_Dynamic_Audit_Log_Monitor_Configuration watchlist\"),\n        Sort= 50;\n// query\nunion AnomalyCount, DailyAnomalyCount, RecommendedTagsPerUser, RecommendedTagsToAdd, RecommendedProfilesToAdd, RecommendedRolesToAdd\n| order by Sort, Count desc\n| project IncidentCount= toint(Count), Issue, Recommendation\n",
                "functionParameters": "",
                "version": 2,
                "tags": [
                    {
                        "name": "description",
                        "value": "SAPAuditLogConfigRecommend"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
            "apiVersion": "2022-01-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId4'),'/'))))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[variables('_parserId4')]"
            ],
            "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPAuditLogConfigRecommend')]",
                "contentId": "[variables('parserObject4').parserContentId4]",
                "kind": "Parser",
                "version": "[variables('parserObject4').parserVersion4]",
                "source": {
                    "kind": "Solution",
                    "name": "SAP",
                    "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                    "name": "Microsoft",
                    "email": "[variables('_email')]"
                },
                "support": {
                    "tier": "Microsoft",
                    "name": "Microsoft Corporation",
                    "email": "support@microsoft.com",
                    "link": "https://support.microsoft.com/"
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('parserTemplateSpecName5')]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAPAuditLogConfiguration Data Parser with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('parserObject5').parserVersion5]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "name": "[variables('parserObject5')._parserName5]",
                            "apiVersion": "2022-10-01",
                            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "eTag": "*",
                                "displayName": "SAPAuditLogConfiguration",
                                "category": "SAPFunctions",
                                "functionAlias": "SAPAuditLogConfiguration",
                                "query": "// optional parameters can look like this\n// let SelectedSystems =  dynamic([\"All Systems\"]);\n// let SelectedSystemRoles =  dynamic([\"All System Roles\"]);\n// let SelectedSeverities=  dynamic([\"High\", \"Medium\"]);\n// // let SelectedRuleTypes = dynamic([\"All RuleTypes\"]);\n// // let SelectedRuleTypes= dynamic([\"AnomaliesOnly\"]);\n// let SelectedRuleTypes= dynamic([\"Deterministic\"]);\n// // let SelectedSystems =  dynamic([\"S4P\", \"B4X\", \"ODT\"]);\n// // let SelectedSystemRoles =  dynamic([\"Production\", \"UAT\"]);\n// // let SelectedSeverities =  dynamic([\"All Severities\"]);\n\nlet Configuration = materialize (_GetWatchlist('SAP_Dynamic_Audit_Log_Monitor_Configuration')\n    | summarize arg_max(LastUpdatedTimeUTC, *) by SearchKey\n    | where (SelectedSeverities has ProductionSeverity or SelectedSeverities has NonProdSeverity or tostring(SelectedSeverities) == '[\"All Severities\"]')\n    | where (SelectedRuleTypes has RuleType or tostring(SelectedRuleTypes) == '[\"All RuleTypes\"]')\n    | extend DummyJoinField = 1);\n\nlet Systems = materialize (_GetWatchlist('SAP - Systems')\n    | where SearchKey in (SelectedSystems) or tostring(SelectedSystems) == '[\"All Systems\"]'\n    | where SystemRole in (SelectedSystemRoles) or tostring(SelectedSystemRoles) == '[\"All System Roles\"]'\n    | project-keep SearchKey, SystemRole, SystemUsage\n    | extend DummyJoinField = 1);\n\n\nlet SystemConfigurations =  Configuration\n    | join kind= inner Systems\n        on $left.DummyJoinField == $right.DummyJoinField;\n\n\nSystemConfigurations\n| project-rename SystemID = SearchKey1\n// | extend IsProd = iff((SystemRole == \"Production\" or ConsiderAsProd has SystemID) and not(ConsiderAsNonProd has SystemID), true, false)\n| extend IsProd = iff(SystemRole == \"Production\" , true, false)\n| extend Severity = iff(IsProd, ProductionSeverity, NonProdSeverity)\n| extend Threshold = tolong( iff(IsProd, ProductionThreshold, NonProdThreshold))\n| where (SelectedSeverities has Severity or  tostring(SelectedSeverities) == '[\"All Severities\"]')\n| extend BagOfDetails = bag_pack('MessageID', MessageID, 'Tactics', Tactics, 'SystemID', SystemID, 'Severity', Severity, 'DestinationEmail', DestinationEmail, 'TeamsChannelID', TeamsChannelID)\n// remove spaces\n| extend RolesTagsToExclude = replace_string(RolesTagsToExclude, ' ', '')\n\n\n| project-keep CategoryName\n, MessageID\n, MessageText\n, Tactics\n, SystemID\n, SystemRole\n, SystemUsage\n, DetailedDescription\n, Severity\n, DestinationEmail\n, TeamsChannelID\n, IsProd\n, BagOfDetails\n, Threshold\n, RolesTagsToExclude\n, RuleType\n// , VariablesDataTypes\n\n\n",
                                "functionParameters": "SelectedSystems:dynamic=dynamic([\"All Systems\"]),SelectedSystemRoles:dynamic=dynamic([\"All System Roles\"]),SelectedSeverities:dynamic=dynamic([\"High\", \"Medium\"]),SelectedRuleTypes:dynamic=dynamic([\"All RuleTypes\"])",
                                "version": 2,
                                "tags": [
                                    {
                                        "name": "description",
                                        "value": "SAPAuditLogConfiguration"
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId5'),'/'))))]",
                            "dependsOn": [
                                "[variables('_parserId5')]"
                            ],
                            "properties": {
                                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPAuditLogConfiguration')]",
                                "contentId": "[variables('parserObject5').parserContentId5]",
                                "kind": "Parser",
                                "version": "[variables('parserObject5').parserVersion5]",
                                "source": {
                                    "name": "SAP",
                                    "kind": "Solution",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('parserObject5').parserContentId5]",
                "contentKind": "Parser",
                "displayName": "SAPAuditLogConfiguration",
                "contentProductId": "[variables('_parsercontentProductId5')]",
                "id": "[variables('_parsercontentProductId5')]",
                "version": "[variables('parserObject5').parserVersion5]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
            "apiVersion": "2022-10-01",
            "name": "[variables('parserObject5')._parserName5]",
            "location": "[parameters('workspace-location')]",
            "properties": {
                "eTag": "*",
                "displayName": "SAPAuditLogConfiguration",
                "category": "SAPFunctions",
                "functionAlias": "SAPAuditLogConfiguration",
                "query": "// optional parameters can look like this\n// let SelectedSystems =  dynamic([\"All Systems\"]);\n// let SelectedSystemRoles =  dynamic([\"All System Roles\"]);\n// let SelectedSeverities=  dynamic([\"High\", \"Medium\"]);\n// // let SelectedRuleTypes = dynamic([\"All RuleTypes\"]);\n// // let SelectedRuleTypes= dynamic([\"AnomaliesOnly\"]);\n// let SelectedRuleTypes= dynamic([\"Deterministic\"]);\n// // let SelectedSystems =  dynamic([\"S4P\", \"B4X\", \"ODT\"]);\n// // let SelectedSystemRoles =  dynamic([\"Production\", \"UAT\"]);\n// // let SelectedSeverities =  dynamic([\"All Severities\"]);\n\nlet Configuration = materialize (_GetWatchlist('SAP_Dynamic_Audit_Log_Monitor_Configuration')\n    | summarize arg_max(LastUpdatedTimeUTC, *) by SearchKey\n    | where (SelectedSeverities has ProductionSeverity or SelectedSeverities has NonProdSeverity or tostring(SelectedSeverities) == '[\"All Severities\"]')\n    | where (SelectedRuleTypes has RuleType or tostring(SelectedRuleTypes) == '[\"All RuleTypes\"]')\n    | extend DummyJoinField = 1);\n\nlet Systems = materialize (_GetWatchlist('SAP - Systems')\n    | where SearchKey in (SelectedSystems) or tostring(SelectedSystems) == '[\"All Systems\"]'\n    | where SystemRole in (SelectedSystemRoles) or tostring(SelectedSystemRoles) == '[\"All System Roles\"]'\n    | project-keep SearchKey, SystemRole, SystemUsage\n    | extend DummyJoinField = 1);\n\n\nlet SystemConfigurations =  Configuration\n    | join kind= inner Systems\n        on $left.DummyJoinField == $right.DummyJoinField;\n\n\nSystemConfigurations\n| project-rename SystemID = SearchKey1\n// | extend IsProd = iff((SystemRole == \"Production\" or ConsiderAsProd has SystemID) and not(ConsiderAsNonProd has SystemID), true, false)\n| extend IsProd = iff(SystemRole == \"Production\" , true, false)\n| extend Severity = iff(IsProd, ProductionSeverity, NonProdSeverity)\n| extend Threshold = tolong( iff(IsProd, ProductionThreshold, NonProdThreshold))\n| where (SelectedSeverities has Severity or  tostring(SelectedSeverities) == '[\"All Severities\"]')\n| extend BagOfDetails = bag_pack('MessageID', MessageID, 'Tactics', Tactics, 'SystemID', SystemID, 'Severity', Severity, 'DestinationEmail', DestinationEmail, 'TeamsChannelID', TeamsChannelID)\n// remove spaces\n| extend RolesTagsToExclude = replace_string(RolesTagsToExclude, ' ', '')\n\n\n| project-keep CategoryName\n, MessageID\n, MessageText\n, Tactics\n, SystemID\n, SystemRole\n, SystemUsage\n, DetailedDescription\n, Severity\n, DestinationEmail\n, TeamsChannelID\n, IsProd\n, BagOfDetails\n, Threshold\n, RolesTagsToExclude\n, RuleType\n// , VariablesDataTypes\n\n\n",
                "functionParameters": "SelectedSystems:dynamic=dynamic([\"All Systems\"]),SelectedSystemRoles:dynamic=dynamic([\"All System Roles\"]),SelectedSeverities:dynamic=dynamic([\"High\", \"Medium\"]),SelectedRuleTypes:dynamic=dynamic([\"All RuleTypes\"])",
                "version": 2,
                "tags": [
                    {
                        "name": "description",
                        "value": "SAPAuditLogConfiguration"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
            "apiVersion": "2022-01-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId5'),'/'))))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[variables('_parserId5')]"
            ],
            "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPAuditLogConfiguration')]",
                "contentId": "[variables('parserObject5').parserContentId5]",
                "kind": "Parser",
                "version": "[variables('parserObject5').parserVersion5]",
                "source": {
                    "kind": "Solution",
                    "name": "SAP",
                    "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                    "name": "Microsoft",
                    "email": "[variables('_email')]"
                },
                "support": {
                    "tier": "Microsoft",
                    "name": "Microsoft Corporation",
                    "email": "support@microsoft.com",
                    "link": "https://support.microsoft.com/"
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('parserTemplateSpecName6')]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAPCRLog Data Parser with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('parserObject6').parserVersion6]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "name": "[variables('parserObject6')._parserName6]",
                            "apiVersion": "2022-10-01",
                            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "eTag": "*",
                                "displayName": "SAPCRLog",
                                "category": "SAPFunctions",
                                "functionAlias": "SAPCRLog",
                                "query": "[replace(variables('SAPFunctionsSAPCRLogQuery'),'CWSQSAP.', if(equals(coalesce(parameters('CWSQSAPIdentifier'),''),'') , '', concat(variables('CWSQIdentifierPrefix'), parameters('CWSQSAPIdentifier'),variables('CWQSIdentifierSuffix'))))]",
                                "functionParameters": "",
                                "version": 2,
                                "tags": [
                                    {
                                        "name": "description",
                                        "value": "SAPCRLog"
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId6'),'/'))))]",
                            "dependsOn": [
                                "[variables('_parserId6')]"
                            ],
                            "properties": {
                                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPCRLog')]",
                                "contentId": "[variables('parserObject6').parserContentId6]",
                                "kind": "Parser",
                                "version": "[variables('parserObject6').parserVersion6]",
                                "source": {
                                    "name": "SAP",
                                    "kind": "Solution",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('parserObject6').parserContentId6]",
                "contentKind": "Parser",
                "displayName": "SAPCRLog",
                "contentProductId": "[variables('_parsercontentProductId6')]",
                "id": "[variables('_parsercontentProductId6')]",
                "version": "[variables('parserObject6').parserVersion6]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
            "apiVersion": "2022-10-01",
            "name": "[variables('parserObject6')._parserName6]",
            "location": "[parameters('workspace-location')]",
            "properties": {
                "eTag": "*",
                "displayName": "SAPCRLog",
                "category": "SAPFunctions",
                "functionAlias": "SAPCRLog",
                "query": "[replace(variables('SAPFunctionsSAPCRLogQuery'),'CWSQSAP.', if(equals(coalesce(parameters('CWSQSAPIdentifier'),''),'') , '', concat(variables('CWSQIdentifierPrefix'), parameters('CWSQSAPIdentifier'),variables('CWQSIdentifierSuffix'))))]",
                "functionParameters": "",
                "version": 2,
                "tags": [
                    {
                        "name": "description",
                        "value": "SAPCRLog"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
            "apiVersion": "2022-01-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId6'),'/'))))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[variables('_parserId6')]"
            ],
            "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPCRLog')]",
                "contentId": "[variables('parserObject6').parserContentId6]",
                "kind": "Parser",
                "version": "[variables('parserObject6').parserVersion6]",
                "source": {
                    "kind": "Solution",
                    "name": "SAP",
                    "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                    "name": "Microsoft",
                    "email": "[variables('_email')]"
                },
                "support": {
                    "tier": "Microsoft",
                    "name": "Microsoft Corporation",
                    "email": "support@microsoft.com",
                    "link": "https://support.microsoft.com/"
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('parserTemplateSpecName7')]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAPChangeDocsLog Data Parser with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('parserObject7').parserVersion7]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "name": "[variables('parserObject7')._parserName7]",
                            "apiVersion": "2022-10-01",
                            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "eTag": "*",
                                "displayName": "SAPChangeDocsLog",
                                "category": "SAPFunctions",
                                "functionAlias": "SAPChangeDocsLog",
                                "query": "[replace(variables('SAPFunctionsSAPChangeDocsLogQuery'),'CWSQSAP.', if(equals(coalesce(parameters('CWSQSAPIdentifier'),''),'') , '', concat(variables('CWSQIdentifierPrefix'), parameters('CWSQSAPIdentifier'),variables('CWQSIdentifierSuffix'))))]",
                                "functionParameters": "",
                                "version": 2,
                                "tags": [
                                    {
                                        "name": "description",
                                        "value": "SAPChangeDocsLog"
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId7'),'/'))))]",
                            "dependsOn": [
                                "[variables('_parserId7')]"
                            ],
                            "properties": {
                                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPChangeDocsLog')]",
                                "contentId": "[variables('parserObject7').parserContentId7]",
                                "kind": "Parser",
                                "version": "[variables('parserObject7').parserVersion7]",
                                "source": {
                                    "name": "SAP",
                                    "kind": "Solution",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('parserObject7').parserContentId7]",
                "contentKind": "Parser",
                "displayName": "SAPChangeDocsLog",
                "contentProductId": "[variables('_parsercontentProductId7')]",
                "id": "[variables('_parsercontentProductId7')]",
                "version": "[variables('parserObject7').parserVersion7]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
            "apiVersion": "2022-10-01",
            "name": "[variables('parserObject7')._parserName7]",
            "location": "[parameters('workspace-location')]",
            "properties": {
                "eTag": "*",
                "displayName": "SAPChangeDocsLog",
                "category": "SAPFunctions",
                "functionAlias": "SAPChangeDocsLog",
                "query": "[replace(variables('SAPFunctionsSAPChangeDocsLogQuery'),'CWSQSAP.', if(equals(coalesce(parameters('CWSQSAPIdentifier'),''),'') , '', concat(variables('CWSQIdentifierPrefix'), parameters('CWSQSAPIdentifier'),variables('CWQSIdentifierSuffix'))))]",
                "functionParameters": "",
                "version": 2,
                "tags": [
                    {
                        "name": "description",
                        "value": "SAPChangeDocsLog"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
            "apiVersion": "2022-01-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId7'),'/'))))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[variables('_parserId7')]"
            ],
            "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPChangeDocsLog')]",
                "contentId": "[variables('parserObject7').parserContentId7]",
                "kind": "Parser",
                "version": "[variables('parserObject7').parserVersion7]",
                "source": {
                    "kind": "Solution",
                    "name": "SAP",
                    "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                    "name": "Microsoft",
                    "email": "[variables('_email')]"
                },
                "support": {
                    "tier": "Microsoft",
                    "name": "Microsoft Corporation",
                    "email": "support@microsoft.com",
                    "link": "https://support.microsoft.com/"
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('parserTemplateSpecName8')]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAPConnectorHealth Data Parser with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('parserObject8').parserVersion8]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "name": "[variables('parserObject8')._parserName8]",
                            "apiVersion": "2022-10-01",
                            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "eTag": "*",
                                "displayName": "SAPConnectorHealth",
                                "category": "SAPFunctions",
                                "functionAlias": "SAPConnectorHealth",
                                "query": "[replace(variables('SAPFunctionsSAPConnectorHealthQuery'),'CWSQSAP.', if(equals(coalesce(parameters('CWSQSAPIdentifier'),''),'') , '', concat(variables('CWSQIdentifierPrefix'), parameters('CWSQSAPIdentifier'),variables('CWQSIdentifierSuffix'))))]",
                                "functionParameters": "LatestAgentVersion:string='79099153'",
                                "version": 2,
                                "tags": [
                                    {
                                        "name": "description",
                                        "value": "SAPConnectorHealth"
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId8'),'/'))))]",
                            "dependsOn": [
                                "[variables('_parserId8')]"
                            ],
                            "properties": {
                                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPConnectorHealth')]",
                                "contentId": "[variables('parserObject8').parserContentId8]",
                                "kind": "Parser",
                                "version": "[variables('parserObject8').parserVersion8]",
                                "source": {
                                    "name": "SAP",
                                    "kind": "Solution",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('parserObject8').parserContentId8]",
                "contentKind": "Parser",
                "displayName": "SAPConnectorHealth",
                "contentProductId": "[variables('_parsercontentProductId8')]",
                "id": "[variables('_parsercontentProductId8')]",
                "version": "[variables('parserObject8').parserVersion8]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
            "apiVersion": "2022-10-01",
            "name": "[variables('parserObject8')._parserName8]",
            "location": "[parameters('workspace-location')]",
            "properties": {
                "eTag": "*",
                "displayName": "SAPConnectorHealth",
                "category": "SAPFunctions",
                "functionAlias": "SAPConnectorHealth",
                "query": "[replace(variables('SAPFunctionsSAPConnectorHealthQuery'),'CWSQSAP.', if(equals(coalesce(parameters('CWSQSAPIdentifier'),''),'') , '', concat(variables('CWSQIdentifierPrefix'), parameters('CWSQSAPIdentifier'),variables('CWQSIdentifierSuffix'))))]",
                "functionParameters": "LatestAgentVersion:string='79099153'",
                "version": 2,
                "tags": [
                    {
                        "name": "description",
                        "value": "SAPConnectorHealth"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
            "apiVersion": "2022-01-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId8'),'/'))))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[variables('_parserId8')]"
            ],
            "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPConnectorHealth')]",
                "contentId": "[variables('parserObject8').parserContentId8]",
                "kind": "Parser",
                "version": "[variables('parserObject8').parserVersion8]",
                "source": {
                    "kind": "Solution",
                    "name": "SAP",
                    "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                    "name": "Microsoft",
                    "email": "[variables('_email')]"
                },
                "support": {
                    "tier": "Microsoft",
                    "name": "Microsoft Corporation",
                    "email": "support@microsoft.com",
                    "link": "https://support.microsoft.com/"
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('parserTemplateSpecName9')]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAPConnectorOverview Data Parser with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('parserObject9').parserVersion9]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "name": "[variables('parserObject9')._parserName9]",
                            "apiVersion": "2022-10-01",
                            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "eTag": "*",
                                "displayName": "SAPConnectorOverview",
                                "category": "SAPFunctions",
                                "functionAlias": "SAPConnectorOverview",
                                "query": "union isfuzzy=true\nABAPAppLog_CL,\nABAPAuditLog_CL,\nABAPCRLogHeader_CL,\nABAPCRLogLine_CL,\nABAPCRLog_CL,\nABAPChangeDocsLog_CL,\nABAPFilesLogs_CL,\nABAPJobLog_CL,\nABAPOS_GW_CL,\nABAPOS_ICM_CL,\nABAPOS_Syslog_CL,\nABAPOS_WP_CL,\nABAPSpoolLog_CL,\nABAPSpoolOutputLog_CL,\nABAPTableDataLog_CL,\nABAPWorkflowLog_CL,\nABAP_ADCP_CL,\nABAP_ADR6_CL,\nABAP_AGR_1251_CL,\nABAP_AGR_AGRS_CL,\nABAP_AGR_DEFINE_CL,\nABAP_AGR_FLAGS_CL,\nABAP_AGR_PROF_CL,\nABAP_AGR_TCODES_CL,\nABAP_AGR_USERS_CL,\nABAP_DEVACCESS_CL,\nABAP_PAHI_CL,\nABAP_USGRP_USER_CL,\nABAP_USR01_CL,\nABAP_USR02_CL,\nABAP_USR05_CL,\nABAP_USR21_CL,\nABAP_UST04_CL,\nSAP_HeartBeat_CL,\nSecurityAlert\n| where Type != 'SecurityAlert'\n| where TimeGenerated > ago(DaysAgo)\n| extend SystemID_s= column_ifexists('SystemID_s','No system found')\n| project TimeGenerated, SystemID_s, Type\n",
                                "functionParameters": "DaysAgo:timespan=14d",
                                "version": 2,
                                "tags": [
                                    {
                                        "name": "description",
                                        "value": "SAPConnectorOverview"
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId9'),'/'))))]",
                            "dependsOn": [
                                "[variables('_parserId9')]"
                            ],
                            "properties": {
                                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPConnectorOverview')]",
                                "contentId": "[variables('parserObject9').parserContentId9]",
                                "kind": "Parser",
                                "version": "[variables('parserObject9').parserVersion9]",
                                "source": {
                                    "name": "SAP",
                                    "kind": "Solution",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('parserObject9').parserContentId9]",
                "contentKind": "Parser",
                "displayName": "SAPConnectorOverview",
                "contentProductId": "[variables('_parsercontentProductId9')]",
                "id": "[variables('_parsercontentProductId9')]",
                "version": "[variables('parserObject9').parserVersion9]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
            "apiVersion": "2022-10-01",
            "name": "[variables('parserObject9')._parserName9]",
            "location": "[parameters('workspace-location')]",
            "properties": {
                "eTag": "*",
                "displayName": "SAPConnectorOverview",
                "category": "SAPFunctions",
                "functionAlias": "SAPConnectorOverview",
                "query": "union isfuzzy=true\nABAPAppLog_CL,\nABAPAuditLog_CL,\nABAPCRLogHeader_CL,\nABAPCRLogLine_CL,\nABAPCRLog_CL,\nABAPChangeDocsLog_CL,\nABAPFilesLogs_CL,\nABAPJobLog_CL,\nABAPOS_GW_CL,\nABAPOS_ICM_CL,\nABAPOS_Syslog_CL,\nABAPOS_WP_CL,\nABAPSpoolLog_CL,\nABAPSpoolOutputLog_CL,\nABAPTableDataLog_CL,\nABAPWorkflowLog_CL,\nABAP_ADCP_CL,\nABAP_ADR6_CL,\nABAP_AGR_1251_CL,\nABAP_AGR_AGRS_CL,\nABAP_AGR_DEFINE_CL,\nABAP_AGR_FLAGS_CL,\nABAP_AGR_PROF_CL,\nABAP_AGR_TCODES_CL,\nABAP_AGR_USERS_CL,\nABAP_DEVACCESS_CL,\nABAP_PAHI_CL,\nABAP_USGRP_USER_CL,\nABAP_USR01_CL,\nABAP_USR02_CL,\nABAP_USR05_CL,\nABAP_USR21_CL,\nABAP_UST04_CL,\nSAP_HeartBeat_CL,\nSecurityAlert\n| where Type != 'SecurityAlert'\n| where TimeGenerated > ago(DaysAgo)\n| extend SystemID_s= column_ifexists('SystemID_s','No system found')\n| project TimeGenerated, SystemID_s, Type\n",
                "functionParameters": "DaysAgo:timespan=14d",
                "version": 2,
                "tags": [
                    {
                        "name": "description",
                        "value": "SAPConnectorOverview"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
            "apiVersion": "2022-01-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId9'),'/'))))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[variables('_parserId9')]"
            ],
            "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPConnectorOverview')]",
                "contentId": "[variables('parserObject9').parserContentId9]",
                "kind": "Parser",
                "version": "[variables('parserObject9').parserVersion9]",
                "source": {
                    "kind": "Solution",
                    "name": "SAP",
                    "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                    "name": "Microsoft",
                    "email": "[variables('_email')]"
                },
                "support": {
                    "tier": "Microsoft",
                    "name": "Microsoft Corporation",
                    "email": "support@microsoft.com",
                    "link": "https://support.microsoft.com/"
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('parserTemplateSpecName10')]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAPFilesLogs Data Parser with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('parserObject10').parserVersion10]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "name": "[variables('parserObject10')._parserName10]",
                            "apiVersion": "2022-10-01",
                            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "eTag": "*",
                                "displayName": "SAPFilesLogs",
                                "category": "SAPFunctions",
                                "functionAlias": "SAPFilesLogs",
                                "query": "[replace(variables('SAPFunctionsSAPFilesLogsQuery'),'CWSQSAP.', if(equals(coalesce(parameters('CWSQSAPIdentifier'),''),'') , '', concat(variables('CWSQIdentifierPrefix'), parameters('CWSQSAPIdentifier'),variables('CWQSIdentifierSuffix'))))]",
                                "functionParameters": "",
                                "version": 2,
                                "tags": [
                                    {
                                        "name": "description",
                                        "value": "SAPFilesLogs"
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId10'),'/'))))]",
                            "dependsOn": [
                                "[variables('_parserId10')]"
                            ],
                            "properties": {
                                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPFilesLogs')]",
                                "contentId": "[variables('parserObject10').parserContentId10]",
                                "kind": "Parser",
                                "version": "[variables('parserObject10').parserVersion10]",
                                "source": {
                                    "name": "SAP",
                                    "kind": "Solution",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('parserObject10').parserContentId10]",
                "contentKind": "Parser",
                "displayName": "SAPFilesLogs",
                "contentProductId": "[variables('_parsercontentProductId10')]",
                "id": "[variables('_parsercontentProductId10')]",
                "version": "[variables('parserObject10').parserVersion10]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
            "apiVersion": "2022-10-01",
            "name": "[variables('parserObject10')._parserName10]",
            "location": "[parameters('workspace-location')]",
            "properties": {
                "eTag": "*",
                "displayName": "SAPFilesLogs",
                "category": "SAPFunctions",
                "functionAlias": "SAPFilesLogs",
                "query": "[replace(variables('SAPFunctionsSAPFilesLogsQuery'),'CWSQSAP.', if(equals(coalesce(parameters('CWSQSAPIdentifier'),''),'') , '', concat(variables('CWSQIdentifierPrefix'), parameters('CWSQSAPIdentifier'),variables('CWQSIdentifierSuffix'))))]",
                "functionParameters": "",
                "version": 2,
                "tags": [
                    {
                        "name": "description",
                        "value": "SAPFilesLogs"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
            "apiVersion": "2022-01-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId10'),'/'))))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[variables('_parserId10')]"
            ],
            "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPFilesLogs')]",
                "contentId": "[variables('parserObject10').parserContentId10]",
                "kind": "Parser",
                "version": "[variables('parserObject10').parserVersion10]",
                "source": {
                    "kind": "Solution",
                    "name": "SAP",
                    "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                    "name": "Microsoft",
                    "email": "[variables('_email')]"
                },
                "support": {
                    "tier": "Microsoft",
                    "name": "Microsoft Corporation",
                    "email": "support@microsoft.com",
                    "link": "https://support.microsoft.com/"
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('parserTemplateSpecName11')]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAPGetDataTypes Data Parser with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('parserObject11').parserVersion11]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "name": "[variables('parserObject11')._parserName11]",
                            "apiVersion": "2022-10-01",
                            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "eTag": "*",
                                "displayName": "SAPGetDataTypes",
                                "category": "SAPFunctions",
                                "functionAlias": "SAPGetDataTypes",
                                "query": "// Function returns all keys and datatypes by default\n// let DataTypes = dynamic(['All DataTypes']);\n// let DataKeys = dynamic(['All DataKeys']);\n\n// multiple valus are also accepted\n// let DataTypes = dynamic(['LogonTypes', 'LogonFailureCauses']);\n// let DataKeys = dynamic(['A', 'B']);\n\n// single values are OK too\n// let DataTypes = dynamic(['LogonType']) ;//single value is also OK\n// let DataKeys = dynamic(['J']);//single value is also OK\n\nlet LogonTypes = datatable(Key: string , Value: string )\n[\"A\",\"Dialog logon (SAP GUI)\",\"B\",\"Background job start\",\"H\",\"HTTP logon\",\"U\",\"User switch (internal call)\",\"'\",\"' = Password check (API, internal call)\",\"M\",\"SMTP\",\"P\",\"ABAP Push Channel (APC)\",\"E\",\"Build of a shared object area (internal call)\",\"O\",\"AutoABAP (internal call)\",\"T\",\"Server startup procedure (internal call)\",\"V\",\"SAP start service (internal call)\",\"J\",\"JAVA virtual machine (internal call)\",\"W\",\"BGRFC watchdog (internal call)\", \"C\", \"CPIC call\",\"R\",\"external RFC call\",\"F\",\"internal RFC call\",\"S\",\"external RFC system call (function group SRFC\",\n\"I\",\"internal RFC system call (function group SRFC)\"]\n| extend DataType = 'LogonType';\n\nlet LogonFailureCauses = datatable(Key: string , Value: string )\n[\"0\",\"No error - successful logon\",\"1\",\"Incorrect logon data (client, user name, password)\",\"2\",\"User is locked (by administrator or incorrect logon attempts)\",\"3\",\"As 1 (connection to terminal also terminated)\",\"4\",\"Logon using emergency user SAP* (see SAP Note 2383)\",\"5\",\"Error creating the user buffer (==> may be a follow-on error)\",\"6\",\"User only exists in Central User Administration (CUA)\",\"7\",\"Invalid user type\",\"8\",\"User account is outside its validity period\",\"10\",\"Logon requires Secure Network Communication (SNC)\",\"11\",\"No SAP user exists in the system with this SNC ID\",\"12\",\"ACL entry missing for SNC-secured server-server connection\",\"13\",\"No matching SAP account found for SNC name\",\"14\",\"Ambiguous assignment between SNC name and SAP account\",\"15\",\"Unencrypted SAP GUI connection (was blocked)\",\"20\",\"Logon with logon ticket deactivated in general\",\"21\",\"Syntax error in received logon ticket\",\"22\",\"Check of logon ticket digital signature failed\",\"23\",\"Issuer of logon ticket is not in ACL table\",\"24\",\"Validity of logon ticket has expired\",\"25\",\"Unintended recipient (assertion ticket)\",\"26\",\"Ticket contains empty ABAP user ID\",\"27\",\"Ticket does not match current user\",\"28\",\"Ticket logon deactivated (security policy)\",\"30\",\"Logon by X.509 certificate deactivated in general\",\"31\",\"Syntax error in received X.509 certificate\",\"32\",\"X.509 certificate not from Internet Transaction Server\",\"34\",\"No matching SAP account found for X.509 certificate\",\"35\",\"Ambiguous assignment between X.509 certificate and SAP accounts\",\"36\",\"X.509 certificate rejected due to minimum validity period requirement\",\"40\",\"Logon using external ID deactivated generally\",\"41\",\"No matching SAP account found for external ID\",\"42\",\"Ambiguous assignment between external ID and SAP accounts\",\"50\",\"Logon using a password deactivated generally\",\"51\",\"Initial password not used for too long => no longer valid\",\"52\",\"User does not have a password => password logon not possible\",\"53\",\"Too many failed password logon attempts\",\"54\",\"Productive password not used for too long => no longer valid\",\"60\",\"SPNego logon deactivated\",\"61\",\"Invalid SPNego token (syntax)\",\"62\",\"NTLM token received instead of SPNego token\",\"63\",\"Missing/incorrect KeyTab entry\",\"64\",\"Expired SPNego token (time)\",\"65\",\"SPNego replay attack detected\",\"66\",\"Kerberos user name -> SNC name failed\",\"67\",\"SPNego: No SNC mapping found\",\"68\",\"SPNego: Multiple SNC mappings found\",\"100\",\"Client does not exist\",\"101\",\"Client is currently locked for logons (upgrade running)\",\"999\",\"Other error (see trace)\",\"1002\",\"Trusted system logon: Missing S_RFCACL authorization\"]\n| extend DataType = 'LogonFailureCause';\n\nlet LogonMethods = datatable(Key: string , Value: string )\n[\"P\",\"Password\",\"T\",\"Logon ticket\",\"t\",\"Assertion ticket\",\"X\",\"X.509 certificate\",\"S\",\"SNC\",\"R\",\"RFC ticket\",\"A\",\"Authorized impersonation (background processing)\",\"E\",\"External (EXTID)\",\"U\",\"User switch\",\"s\",\"HTTP security session\",\"2\",\"SAML2\",\"1\",\"SAML1\",\"o\",\"OAuth2\",\"N\",\"SPNego\",\"a\",\"APC session\"]\n| extend DataType = 'LogonMethod';\n\nlet UserTypes = datatable(Key: string , Value: string )\n[\"A\", \"Dialog\", \"B\", \"System\", \"C\", \"Communications Data\", \"L\", \"Reference (Logon not possible)\", \"S\", \"Service\"]\n| extend DataType = 'UserType';\n\n\nunion LogonTypes, LogonFailureCauses, LogonMethods, UserTypes\n| where tostring(DataKeys) == '[\"All DataKeys\"]' or Key == DataKeys[0] or (array_length( DataKeys) > 1 and tostring(DataKeys) contains_cs Key)\n| where tostring(DataTypes) == '[\"All DataTypes\"]' or DataType == DataTypes[0] or (array_length( DataTypes) > 1 and tostring(DataTypes) contains_cs DataType )\n",
                                "functionParameters": "DataTypes:dynamic=dynamic([\"All DataTypes\"]),DataKeys:dynamic=dynamic([\"All DataKeys\"])",
                                "version": 2,
                                "tags": [
                                    {
                                        "name": "description",
                                        "value": "SAPGetDataTypes"
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId11'),'/'))))]",
                            "dependsOn": [
                                "[variables('_parserId11')]"
                            ],
                            "properties": {
                                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPGetDataTypes')]",
                                "contentId": "[variables('parserObject11').parserContentId11]",
                                "kind": "Parser",
                                "version": "[variables('parserObject11').parserVersion11]",
                                "source": {
                                    "name": "SAP",
                                    "kind": "Solution",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('parserObject11').parserContentId11]",
                "contentKind": "Parser",
                "displayName": "SAPGetDataTypes",
                "contentProductId": "[variables('_parsercontentProductId11')]",
                "id": "[variables('_parsercontentProductId11')]",
                "version": "[variables('parserObject11').parserVersion11]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
            "apiVersion": "2022-10-01",
            "name": "[variables('parserObject11')._parserName11]",
            "location": "[parameters('workspace-location')]",
            "properties": {
                "eTag": "*",
                "displayName": "SAPGetDataTypes",
                "category": "SAPFunctions",
                "functionAlias": "SAPGetDataTypes",
                "query": "// Function returns all keys and datatypes by default\n// let DataTypes = dynamic(['All DataTypes']);\n// let DataKeys = dynamic(['All DataKeys']);\n\n// multiple valus are also accepted\n// let DataTypes = dynamic(['LogonTypes', 'LogonFailureCauses']);\n// let DataKeys = dynamic(['A', 'B']);\n\n// single values are OK too\n// let DataTypes = dynamic(['LogonType']) ;//single value is also OK\n// let DataKeys = dynamic(['J']);//single value is also OK\n\nlet LogonTypes = datatable(Key: string , Value: string )\n[\"A\",\"Dialog logon (SAP GUI)\",\"B\",\"Background job start\",\"H\",\"HTTP logon\",\"U\",\"User switch (internal call)\",\"'\",\"' = Password check (API, internal call)\",\"M\",\"SMTP\",\"P\",\"ABAP Push Channel (APC)\",\"E\",\"Build of a shared object area (internal call)\",\"O\",\"AutoABAP (internal call)\",\"T\",\"Server startup procedure (internal call)\",\"V\",\"SAP start service (internal call)\",\"J\",\"JAVA virtual machine (internal call)\",\"W\",\"BGRFC watchdog (internal call)\", \"C\", \"CPIC call\",\"R\",\"external RFC call\",\"F\",\"internal RFC call\",\"S\",\"external RFC system call (function group SRFC\",\n\"I\",\"internal RFC system call (function group SRFC)\"]\n| extend DataType = 'LogonType';\n\nlet LogonFailureCauses = datatable(Key: string , Value: string )\n[\"0\",\"No error - successful logon\",\"1\",\"Incorrect logon data (client, user name, password)\",\"2\",\"User is locked (by administrator or incorrect logon attempts)\",\"3\",\"As 1 (connection to terminal also terminated)\",\"4\",\"Logon using emergency user SAP* (see SAP Note 2383)\",\"5\",\"Error creating the user buffer (==> may be a follow-on error)\",\"6\",\"User only exists in Central User Administration (CUA)\",\"7\",\"Invalid user type\",\"8\",\"User account is outside its validity period\",\"10\",\"Logon requires Secure Network Communication (SNC)\",\"11\",\"No SAP user exists in the system with this SNC ID\",\"12\",\"ACL entry missing for SNC-secured server-server connection\",\"13\",\"No matching SAP account found for SNC name\",\"14\",\"Ambiguous assignment between SNC name and SAP account\",\"15\",\"Unencrypted SAP GUI connection (was blocked)\",\"20\",\"Logon with logon ticket deactivated in general\",\"21\",\"Syntax error in received logon ticket\",\"22\",\"Check of logon ticket digital signature failed\",\"23\",\"Issuer of logon ticket is not in ACL table\",\"24\",\"Validity of logon ticket has expired\",\"25\",\"Unintended recipient (assertion ticket)\",\"26\",\"Ticket contains empty ABAP user ID\",\"27\",\"Ticket does not match current user\",\"28\",\"Ticket logon deactivated (security policy)\",\"30\",\"Logon by X.509 certificate deactivated in general\",\"31\",\"Syntax error in received X.509 certificate\",\"32\",\"X.509 certificate not from Internet Transaction Server\",\"34\",\"No matching SAP account found for X.509 certificate\",\"35\",\"Ambiguous assignment between X.509 certificate and SAP accounts\",\"36\",\"X.509 certificate rejected due to minimum validity period requirement\",\"40\",\"Logon using external ID deactivated generally\",\"41\",\"No matching SAP account found for external ID\",\"42\",\"Ambiguous assignment between external ID and SAP accounts\",\"50\",\"Logon using a password deactivated generally\",\"51\",\"Initial password not used for too long => no longer valid\",\"52\",\"User does not have a password => password logon not possible\",\"53\",\"Too many failed password logon attempts\",\"54\",\"Productive password not used for too long => no longer valid\",\"60\",\"SPNego logon deactivated\",\"61\",\"Invalid SPNego token (syntax)\",\"62\",\"NTLM token received instead of SPNego token\",\"63\",\"Missing/incorrect KeyTab entry\",\"64\",\"Expired SPNego token (time)\",\"65\",\"SPNego replay attack detected\",\"66\",\"Kerberos user name -> SNC name failed\",\"67\",\"SPNego: No SNC mapping found\",\"68\",\"SPNego: Multiple SNC mappings found\",\"100\",\"Client does not exist\",\"101\",\"Client is currently locked for logons (upgrade running)\",\"999\",\"Other error (see trace)\",\"1002\",\"Trusted system logon: Missing S_RFCACL authorization\"]\n| extend DataType = 'LogonFailureCause';\n\nlet LogonMethods = datatable(Key: string , Value: string )\n[\"P\",\"Password\",\"T\",\"Logon ticket\",\"t\",\"Assertion ticket\",\"X\",\"X.509 certificate\",\"S\",\"SNC\",\"R\",\"RFC ticket\",\"A\",\"Authorized impersonation (background processing)\",\"E\",\"External (EXTID)\",\"U\",\"User switch\",\"s\",\"HTTP security session\",\"2\",\"SAML2\",\"1\",\"SAML1\",\"o\",\"OAuth2\",\"N\",\"SPNego\",\"a\",\"APC session\"]\n| extend DataType = 'LogonMethod';\n\nlet UserTypes = datatable(Key: string , Value: string )\n[\"A\", \"Dialog\", \"B\", \"System\", \"C\", \"Communications Data\", \"L\", \"Reference (Logon not possible)\", \"S\", \"Service\"]\n| extend DataType = 'UserType';\n\n\nunion LogonTypes, LogonFailureCauses, LogonMethods, UserTypes\n| where tostring(DataKeys) == '[\"All DataKeys\"]' or Key == DataKeys[0] or (array_length( DataKeys) > 1 and tostring(DataKeys) contains_cs Key)\n| where tostring(DataTypes) == '[\"All DataTypes\"]' or DataType == DataTypes[0] or (array_length( DataTypes) > 1 and tostring(DataTypes) contains_cs DataType )\n",
                "functionParameters": "DataTypes:dynamic=dynamic([\"All DataTypes\"]),DataKeys:dynamic=dynamic([\"All DataKeys\"])",
                "version": 2,
                "tags": [
                    {
                        "name": "description",
                        "value": "SAPGetDataTypes"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
            "apiVersion": "2022-01-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId11'),'/'))))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[variables('_parserId11')]"
            ],
            "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPGetDataTypes')]",
                "contentId": "[variables('parserObject11').parserContentId11]",
                "kind": "Parser",
                "version": "[variables('parserObject11').parserVersion11]",
                "source": {
                    "kind": "Solution",
                    "name": "SAP",
                    "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                    "name": "Microsoft",
                    "email": "[variables('_email')]"
                },
                "support": {
                    "tier": "Microsoft",
                    "name": "Microsoft Corporation",
                    "email": "support@microsoft.com",
                    "link": "https://support.microsoft.com/"
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('parserTemplateSpecName12')]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAPGetParameters Data Parser with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('parserObject12').parserVersion12]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "name": "[variables('parserObject12')._parserName12]",
                            "apiVersion": "2022-10-01",
                            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "eTag": "*",
                                "displayName": "SAPGetParameters",
                                "category": "SAPFunctions",
                                "functionAlias": "SAPGetParameters",
                                "query": "// let ParameterType= 'Static';\n// let ParameterName= 'UserMDLookBack';\nlet ParametersTable= datatable ( Parameter_Type: string, Parameter_Name: string, \tValueLow: string, ValueHigh: string , ValueOPT:string, ValueSIGN:string, Tags: dynamic )\n[ 'Static', 'UserMDLookBack', '36h', '', '', '', ''\n,'Static', 'UserHeaderAuditLookBack', '3d', '', '', '', ''\n,'Static', 'SolutionVersion', '2.00.75', '', '', '', ''\n];\nParametersTable\n| where Parameter_Type==ParameterType or ParameterType == '*'\n| where  Parameter_Name== ParameterName or ParameterName == '*'\n| project-rename ParameterName=Parameter_Name, ParameterType= Parameter_Type;\n",
                                "functionParameters": "ParameterName:string='*',ParameterType:string='*'",
                                "version": 2,
                                "tags": [
                                    {
                                        "name": "description",
                                        "value": "SAPGetParameters"
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId12'),'/'))))]",
                            "dependsOn": [
                                "[variables('_parserId12')]"
                            ],
                            "properties": {
                                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPGetParameters')]",
                                "contentId": "[variables('parserObject12').parserContentId12]",
                                "kind": "Parser",
                                "version": "[variables('parserObject12').parserVersion12]",
                                "source": {
                                    "name": "SAP",
                                    "kind": "Solution",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('parserObject12').parserContentId12]",
                "contentKind": "Parser",
                "displayName": "SAPGetParameters",
                "contentProductId": "[variables('_parsercontentProductId12')]",
                "id": "[variables('_parsercontentProductId12')]",
                "version": "[variables('parserObject12').parserVersion12]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
            "apiVersion": "2022-10-01",
            "name": "[variables('parserObject12')._parserName12]",
            "location": "[parameters('workspace-location')]",
            "properties": {
                "eTag": "*",
                "displayName": "SAPGetParameters",
                "category": "SAPFunctions",
                "functionAlias": "SAPGetParameters",
                "query": "// let ParameterType= 'Static';\n// let ParameterName= 'UserMDLookBack';\nlet ParametersTable= datatable ( Parameter_Type: string, Parameter_Name: string, \tValueLow: string, ValueHigh: string , ValueOPT:string, ValueSIGN:string, Tags: dynamic )\n[ 'Static', 'UserMDLookBack', '36h', '', '', '', ''\n,'Static', 'UserHeaderAuditLookBack', '3d', '', '', '', ''\n,'Static', 'SolutionVersion', '2.00.75', '', '', '', ''\n];\nParametersTable\n| where Parameter_Type==ParameterType or ParameterType == '*'\n| where  Parameter_Name== ParameterName or ParameterName == '*'\n| project-rename ParameterName=Parameter_Name, ParameterType= Parameter_Type;\n",
                "functionParameters": "ParameterName:string='*',ParameterType:string='*'",
                "version": 2,
                "tags": [
                    {
                        "name": "description",
                        "value": "SAPGetParameters"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
            "apiVersion": "2022-01-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId12'),'/'))))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[variables('_parserId12')]"
            ],
            "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPGetParameters')]",
                "contentId": "[variables('parserObject12').parserContentId12]",
                "kind": "Parser",
                "version": "[variables('parserObject12').parserVersion12]",
                "source": {
                    "kind": "Solution",
                    "name": "SAP",
                    "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                    "name": "Microsoft",
                    "email": "[variables('_email')]"
                },
                "support": {
                    "tier": "Microsoft",
                    "name": "Microsoft Corporation",
                    "email": "support@microsoft.com",
                    "link": "https://support.microsoft.com/"
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('parserTemplateSpecName13')]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAPGetSystemParameter Data Parser with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('parserObject13').parserVersion13]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "name": "[variables('parserObject13')._parserName13]",
                            "apiVersion": "2022-10-01",
                            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "eTag": "*",
                                "displayName": "SAPGetSystemParameter",
                                "category": "SAPFunctions",
                                "functionAlias": "SAPGetSystemParameter",
                                "query": "// we would like to offer a built in default for security related SAP parameters, but also allow customers to add/ modify those\n// let Parameter= \"auth/tcodes_not_checked\";\n// let Parameter= \"\";\n// these are values which are generatd by the solution, but can be overtaken by the values specified in the \"SAPSystemParameters\" watchlist\nlet DefaultParametersDT= datatable ( LastUpdatedTimeUTC: datetime, SearchKey: string, Comment: string, EnableAlerts: string, NonProdSeverity: string, NonProdValues: string, Option: string, ParameterName: string, ProductionSeverity: string, ProductionValues: string)[\"2023-02-21 15:20:24.2148582\",\"auth/tcodes_not_checked\",\"Disables Tcode checking for SU53 & SU56 auth analysis\",\"true\",\"High\",\"\",\"\",\"auth/tcodes_not_checked\",\"High\",\"\",\"2023-02-21 15:20:24.2148582\",\"login/create_sso2_ticket\",\"Create SSO tickets on  this  system\",\"true\",\"High\",\"3\",\"\",\"login/create_sso2_ticket\",\"High\",\"3\",\"2023-02-21 15:20:24.2148582\",\"login/password_downwards_compatibility\",\"password downwards compatibility (8 / 40 characters, case-sensitivity)\",\"true\",\"Medium\",\"0\",\"\",\"login/password_downwards_compatibility\",\"High\",\"0\",\"2023-02-21 15:20:24.2148582\",\"snc/accept_insecure_cpic\",\"Accept insecure CPIC-connections to SNC-enabled Server\",\"true\",\"Medium\",\"1\",\"\",\"snc/accept_insecure_cpic\",\"High\",\"0\",\"2023-02-21 15:20:24.2148582\",\"snc/data_protection/min\",\"Min. required data protection for incoming connections\",\"true\",\"Medium\",\"3\",\"\",\"snc/data_protection/min\",\"High\",\"3\",\"2023-02-21 15:20:24.2148582\",\"login/disable_multi_gui_login\",\"disable multiple sapgui logons (for same SAP account)\",\"true\",\"High\",\"1\",\"\",\"login/disable_multi_gui_login\",\"High\",\"1\",\"2023-02-21 15:20:24.2148582\",\"login/ticket_only_by_https\",\"generate ticket that will only be sent via https\",\"true\",\"Medium\",\"0\",\"\",\"login/ticket_only_by_https\",\"High\",\"1\",\"2023-02-21 15:20:24.2148582\",\"auth/object_disabling_active\",\"Value 'N' prohibits disabling of authorization objects\",\"true\",\"High\",\"Y\",\"\",\"auth/object_disabling_active\",\"High\",\"Y\",\"2023-02-21 15:20:24.2148582\",\"login/min_password_lng\",\"Minimum Password Length\",\"true\",\"Medium\",\"6\",\"GE\",\"login/min_password_lng\",\"High\",\"8\",\"2023-02-21 15:20:24.2148582\",\"gw/accept_remote_trace_level\",\"CPIC and RFC: adopt remote trace level?\",\"true\",\"High\",\"0\",\"\",\"gw/accept_remote_trace_level\",\"High\",\"0\",\"2023-02-21 15:20:24.2148582\",\"icm/accept_remote_trace_level\",\"Accept external switch of trace level\",\"true\",\"High\",\"0\",\"\",\"icm/accept_remote_trace_level\",\"High\",\"0\",\"2023-02-21 15:20:24.2148582\",\"login/failed_user_auto_unlock\",\"Enable automatic unlock off locked user at midnight\",\"true\",\"Medium\",\"0\",\"\",\"login/failed_user_auto_unlock\",\"High\",\"0\",\"2023-02-21 15:20:24.2148582\",\"login/min_password_digits\",\"min. number of digits in passwords\",\"true\",\"Medium\",\"0\",\"GE\",\"login/min_password_digits\",\"High\",\"2\",\"2023-02-21 15:20:24.2148582\",\"login/min_password_letters\",\"min. number of letters in passwords\",\"true\",\"Medium\",\"0\",\"GE\",\"login/min_password_letters\",\"High\",\"2\",\"2023-02-21 15:20:24.2148582\",\"login/min_password_lowercase\",\"minimum number of lower-case characters in passwords\",\"true\",\"Medium\",\"0\",\"GE\",\"login/min_password_lowercase\",\"High\",\"1\",\"2023-02-21 15:20:24.2148582\",\"login/min_password_uppercase\",\"minimum number of upper-case characters in passwords\",\"true\",\"Medium\",\"0\",\"GE\",\"login/min_password_uppercase\",\"High\",\"1\",\"2023-02-21 15:20:24.2148582\",\"login/no_automatic_user_sapstar\",\"Control of the automatic login user SAP*\",\"true\",\"Medium\",\"1\",\"\",\"login/no_automatic_user_sapstar\",\"High\",\"1\",\"2023-02-21 15:20:24.2148582\",\"login/password_change_for_SSO\",\"Handling of password change enforcements in Single Sign-On situations\",\"true\",\"Medium\",\"1\",\"\",\"login/password_change_for_SSO\",\"High\",\"1\",\"2023-02-21 15:20:24.2148582\",\"rsau/max_diskspace/per_day\",\"Maximum size of all security audit files per day\",\"true\",\"Medium\",\"1000000000\",\"\",\"rsau/max_diskspace/per_day\",\"High\",\"1500000000\",\"2023-02-21 15:20:24.2148582\",\"snc/accept_insecure_gui\",\"Accept insecure SAPGUI logins to SNC-enabled Server\",\"true\",\"Medium\",\"1\",\"\",\"snc/accept_insecure_gui\",\"High\",\"0\",\"2023-02-21 15:20:24.2148582\",\"snc/accept_insecure_r3int_rfc\",\"Accept insecure internal RFCs on SNC-enabled Server\",\"true\",\"Medium\",\"1\",\"\",\"snc/accept_insecure_r3int_rfc\",\"High\",\"0\",\"2023-02-21 15:20:24.2148582\",\"snc/extid_login_rfc\",\"Enable login with external identity (RFC)\",\"true\",\"Medium\",\"1\",\"\",\"snc/extid_login_rfc\",\"High\",\"1\",\"2023-02-21 15:20:24.2148582\",\"rfc/reject_expired_passwd\",\"Prevents logon with initial or expired Password via RFC\",\"true\",\"Medium\",\"1\",\"\",\"rfc/reject_expired_passwd\",\"High\",\"1\",\"2023-02-21 15:20:24.2148582\",\"gw/logging\",\"settings for gateway logging\",\"true\",\"Medium\",\"ACTION=Ss LOGFILE=gw_log-%y-%m-%d SWITCHTF=day MAXSIZEKB=100\",\"\",\"gw/logging\",\"High\",\"ACTION=Ss LOGFILE=gw_log-%y-%m-%d SWITCHTF=day MAXSIZEKB=100\",\"2023-02-21 15:20:24.2148582\",\"login/accept_sso2_ticket\",\"Accept SSO tickets for this (component) system\",\"true\",\"High\",\"1\",\"\",\"login/accept_sso2_ticket\",\"High\",\"1\",\"2023-02-21 15:20:24.2148582\",\"login/min_password_specials\",\"min. number of special characters in passwords\",\"true\",\"Medium\",\"0\",\"\",\"login/min_password_specials\",\"High\",\"0\",\"2023-02-21 15:20:24.2148582\",\"rsau/max_diskspace/local\",\"Maximum space for security audit file\",\"true\",\"Medium\",\"1000000000\",\"GE\",\"rsau/max_diskspace/local\",\"High\",\"1500000000\",\"2023-02-21 15:20:24.2148582\",\"rsau/max_diskspace/per_file\",\"Maximum size of one single security audit file\",\"true\",\"Medium\",\"1000000000\",\"\",\"rsau/max_diskspace/per_file\",\"High\",\"1500000000\",\"2023-02-21 15:20:24.2148582\",\"rsau/selection_slots\",\"Number of selection slots for security audit\",\"true\",\"High\",\"10\",\"\",\"rsau/selection_slots\",\"High\",\"10\",\"2023-02-21 15:20:24.2148582\",\"rspo/auth/pagelimit\",\"Activation of page limit check for spool devices\",\"true\",\"High\",\"0\",\"\",\"rspo/auth/pagelimit\",\"High\",\"0\",\"2023-02-21 15:20:24.2148582\",\"snc/data_protection/use\",\"Level of data protection for R/3 initiated connections\",\"true\",\"Medium\",\"3\",\"\",\"snc/data_protection/use\",\"High\",\"3\",\"2023-02-21 15:20:24.2148582\",\"gw/sim_mode\",\"start simulation mode for reg_info and sec_info\",\"true\",\"Medium\",\"0\",\"\",\"gw/sim_mode\",\"High\",\"0\",\"2023-02-21 15:20:24.2148582\",\"login/fails_to_user_lock\",\"Number of invalid login attempts until user lock\",\"true\",\"Medium\",\"5\",\"LE\",\"login/fails_to_user_lock\",\"High\",\"5\",\"2023-02-21 15:20:24.2148582\",\"login/multi_login_users\",\"list of exceptional users: multiple logon allowed\",\"true\",\"Medium\",\"\",\"\",\"login/multi_login_users\",\"High\",\"\",\"2023-02-21 15:20:24.2148582\",\"rsau/enable\",\"Enable Security Audit\",\"true\",\"High\",\"1\",\"\",\"rsau/enable\",\"High\",\"1\",\"2023-02-21 15:20:24.2148582\",\"snc/extid_login_diag\",\"Enable login with external identity (DIAG)\",\"true\",\"Medium\",\"1\",\"\",\"snc/extid_login_diag\",\"High\",\"1\",\"2023-02-21 15:20:24.2148582\",\"wdisp/ssl_encrypt\",\"SSL reencryption mode\",\"true\",\"High\",\"1\",\"\",\"wdisp/ssl_encrypt\",\"High\",\"1\",\"2023-02-21 15:20:24.2148582\",\"gw/acl_mode\",\"Mode for non existing ACL file\",\"true\",\"High\",\"1\",\"\",\"gw/acl_mode\",\"High\",\"0\",\"2023-02-21 15:20:24.2148582\",\"auth/no_check_in_some_cases\",\"Activation of the Profile Generator\",\"true\",\"High\",\"Y\",\"\",\"auth/no_check_in_some_cases\",\"High\",\"Y\",\"2023-02-21 15:20:24.2148582\",\"gw/monitor\",\"Enables or disables monitor commands\",\"true\",\"Medium\",\"1\",\"\",\"gw/monitor\",\"High\",\"1\",\"2023-02-21 15:20:24.2148582\",\"login/fails_to_session_end\",\"Number of invalid login attempts until session end\",\"true\",\"Medium\",\"3\",\"LE\",\"login/fails_to_session_end\",\"High\",\"3\",\"2023-02-21 15:20:24.2148582\",\"login/min_password_diff\",\"min. number of chars which differ between old and new password\",\"true\",\"Medium\",\"1\",\"LE\",\"login/min_password_diff\",\"High\",\"2\",\"2023-02-21 15:20:24.2148582\",\"login/password_compliance_to_current_policy\",\"current password needs to comply with current password policy\",\"true\",\"Medium\",\"0\",\"\",\"login/password_compliance_to_current_policy\",\"High\",\"0\",\"2023-02-21 15:20:24.2148582\",\"login/password_expiration_time\",\"Dates until password must be changed\",\"true\",\"Medium\",\"180\",\"LE\",\"login/password_expiration_time\",\"High\",\"90\",\"2023-02-21 15:20:24.2148582\",\"login/password_max_idle_initial\",\"maximum #days a password (set by the admin) can be unused (idle)\",\"true\",\"Medium\",\"7\",\"LE\",\"login/password_max_idle_initial\",\"High\",\"7\",\"2023-02-21 15:20:24.2148582\",\"rdisp/gui_auto_logout\",\"Maximum idle time for SAP GUI connections\",\"true\",\"Medium\",\"5400\",\"LE\",\"rdisp/gui_auto_logout\",\"High\",\"3600\",\"2023-02-21 15:20:24.2148582\",\"snc/accept_insecure_rfc\",\"Accept insecure RFC-connections to SNC-enabled Server\",\"true\",\"Medium\",\"1\",\"\",\"snc/accept_insecure_rfc\",\"High\",\"0\",\"2023-02-21 15:20:24.2148582\",\"snc/data_protection/max\",\"Limit for data protection of Secure Network Comm.\",\"true\",\"Medium\",\"3\",\"\",\"snc/data_protection/max\",\"High\",\"3\",\"2023-02-21 15:20:24.2148582\",\"snc/enable\",\"Enable SNC-Module (Secure Network Communications)\",\"true\",\"Medium\",\"1\",\"\",\"snc/enable\",\"High\",\"1\",\"2023-02-21 15:20:24.2148582\",\"rfc/ext_debugging\",\"Remote Function call debugging. See SAP KB 2909642 - Deletion of parameter rfc/ext_debugging\",\"true\",\"Medium\",\"2\",\"LE\",\"rfc/ext_debugging\",\"High\",\"2\",\"2023-02-21 15:20:24.2148582\",\"auth/rfc_authority_check\",\"Execution option for the RFC authority check\",\"true\",\"High\",\"1\",\"GE\",\"auth/rfc_authority_check\",\"High\",\"1\",\"2023-02-21 15:20:24.2148582\",\"login/password_change_waittime\",\"Password change possible after # days (since last change)\",\"true\",\"Medium\",\"1\",\"GE\",\"login/password_change_waittime\",\"High\",\"1\",\"2023-02-21 15:20:24.2148582\",\"login/password_history_size\",\"Number of records to be stored in the password history\",\"true\",\"Medium\",\"5\",\"GE\",\"login/password_history_size\",\"High\",\"5\"];\nlet CustomersParameters= _GetWatchlist(\"SAPSystemParameters\")\n| project-away _DTItemId\n| summarize arg_max(LastUpdatedTimeUTC, *) by SearchKey\n| where SearchKey == Parameter or Parameter == \"\"\n| extend Priority= 1;\nlet DefaultParameters= DefaultParametersDT\n| where SearchKey == Parameter or Parameter == \"\"\n| extend Priority = 2;\nlet RelevantParams= (CustomersParameters | union DefaultParameters\n| summarize arg_min(Priority, *) by SearchKey\n| extend Source= iff(Priority==1, \"'SAPSystemParameters' watchlist\", \"Sentinel built-in content\")\n| extend EnableAlerts= tolower(EnableAlerts)\n| extend EnableAlerts= iff(EnableAlerts == \"true\", true, false), DummyJoinField= 1);\nRelevantParams | join kind= inner SAPSystems() on DummyJoinField\n| extend Severity= iff(SystemRole == \"Production\", ProductionSeverity, NonProdSeverity)\n| extend ExpectedValue= iff(SystemRole == \"Production\", ProductionValues, NonProdValues)\n| project-away DummyJoinField1, SearchKey1, ProductionSeverity, NonProdSeverity, ProductionValues, NonProdValues, Priority\n| extend ExpectedNumeric= extract(\"([0-9.]+)\", 1, replace(\",\",\".\", ExpectedValue), typeof(real))\n| extend ExpectedAlpha= extract(\"([A-Z]+[a-z])\", 1, ExpectedValue, typeof(string))\n",
                                "functionParameters": "Parameter:string='\"\"'",
                                "version": 2,
                                "tags": [
                                    {
                                        "name": "description",
                                        "value": "SAPGetSystemParameter"
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId13'),'/'))))]",
                            "dependsOn": [
                                "[variables('_parserId13')]"
                            ],
                            "properties": {
                                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPGetSystemParameter')]",
                                "contentId": "[variables('parserObject13').parserContentId13]",
                                "kind": "Parser",
                                "version": "[variables('parserObject13').parserVersion13]",
                                "source": {
                                    "name": "SAP",
                                    "kind": "Solution",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('parserObject13').parserContentId13]",
                "contentKind": "Parser",
                "displayName": "SAPGetSystemParameter",
                "contentProductId": "[variables('_parsercontentProductId13')]",
                "id": "[variables('_parsercontentProductId13')]",
                "version": "[variables('parserObject13').parserVersion13]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
            "apiVersion": "2022-10-01",
            "name": "[variables('parserObject13')._parserName13]",
            "location": "[parameters('workspace-location')]",
            "properties": {
                "eTag": "*",
                "displayName": "SAPGetSystemParameter",
                "category": "SAPFunctions",
                "functionAlias": "SAPGetSystemParameter",
                "query": "// we would like to offer a built in default for security related SAP parameters, but also allow customers to add/ modify those\n// let Parameter= \"auth/tcodes_not_checked\";\n// let Parameter= \"\";\n// these are values which are generatd by the solution, but can be overtaken by the values specified in the \"SAPSystemParameters\" watchlist\nlet DefaultParametersDT= datatable ( LastUpdatedTimeUTC: datetime, SearchKey: string, Comment: string, EnableAlerts: string, NonProdSeverity: string, NonProdValues: string, Option: string, ParameterName: string, ProductionSeverity: string, ProductionValues: string)[\"2023-02-21 15:20:24.2148582\",\"auth/tcodes_not_checked\",\"Disables Tcode checking for SU53 & SU56 auth analysis\",\"true\",\"High\",\"\",\"\",\"auth/tcodes_not_checked\",\"High\",\"\",\"2023-02-21 15:20:24.2148582\",\"login/create_sso2_ticket\",\"Create SSO tickets on  this  system\",\"true\",\"High\",\"3\",\"\",\"login/create_sso2_ticket\",\"High\",\"3\",\"2023-02-21 15:20:24.2148582\",\"login/password_downwards_compatibility\",\"password downwards compatibility (8 / 40 characters, case-sensitivity)\",\"true\",\"Medium\",\"0\",\"\",\"login/password_downwards_compatibility\",\"High\",\"0\",\"2023-02-21 15:20:24.2148582\",\"snc/accept_insecure_cpic\",\"Accept insecure CPIC-connections to SNC-enabled Server\",\"true\",\"Medium\",\"1\",\"\",\"snc/accept_insecure_cpic\",\"High\",\"0\",\"2023-02-21 15:20:24.2148582\",\"snc/data_protection/min\",\"Min. required data protection for incoming connections\",\"true\",\"Medium\",\"3\",\"\",\"snc/data_protection/min\",\"High\",\"3\",\"2023-02-21 15:20:24.2148582\",\"login/disable_multi_gui_login\",\"disable multiple sapgui logons (for same SAP account)\",\"true\",\"High\",\"1\",\"\",\"login/disable_multi_gui_login\",\"High\",\"1\",\"2023-02-21 15:20:24.2148582\",\"login/ticket_only_by_https\",\"generate ticket that will only be sent via https\",\"true\",\"Medium\",\"0\",\"\",\"login/ticket_only_by_https\",\"High\",\"1\",\"2023-02-21 15:20:24.2148582\",\"auth/object_disabling_active\",\"Value 'N' prohibits disabling of authorization objects\",\"true\",\"High\",\"Y\",\"\",\"auth/object_disabling_active\",\"High\",\"Y\",\"2023-02-21 15:20:24.2148582\",\"login/min_password_lng\",\"Minimum Password Length\",\"true\",\"Medium\",\"6\",\"GE\",\"login/min_password_lng\",\"High\",\"8\",\"2023-02-21 15:20:24.2148582\",\"gw/accept_remote_trace_level\",\"CPIC and RFC: adopt remote trace level?\",\"true\",\"High\",\"0\",\"\",\"gw/accept_remote_trace_level\",\"High\",\"0\",\"2023-02-21 15:20:24.2148582\",\"icm/accept_remote_trace_level\",\"Accept external switch of trace level\",\"true\",\"High\",\"0\",\"\",\"icm/accept_remote_trace_level\",\"High\",\"0\",\"2023-02-21 15:20:24.2148582\",\"login/failed_user_auto_unlock\",\"Enable automatic unlock off locked user at midnight\",\"true\",\"Medium\",\"0\",\"\",\"login/failed_user_auto_unlock\",\"High\",\"0\",\"2023-02-21 15:20:24.2148582\",\"login/min_password_digits\",\"min. number of digits in passwords\",\"true\",\"Medium\",\"0\",\"GE\",\"login/min_password_digits\",\"High\",\"2\",\"2023-02-21 15:20:24.2148582\",\"login/min_password_letters\",\"min. number of letters in passwords\",\"true\",\"Medium\",\"0\",\"GE\",\"login/min_password_letters\",\"High\",\"2\",\"2023-02-21 15:20:24.2148582\",\"login/min_password_lowercase\",\"minimum number of lower-case characters in passwords\",\"true\",\"Medium\",\"0\",\"GE\",\"login/min_password_lowercase\",\"High\",\"1\",\"2023-02-21 15:20:24.2148582\",\"login/min_password_uppercase\",\"minimum number of upper-case characters in passwords\",\"true\",\"Medium\",\"0\",\"GE\",\"login/min_password_uppercase\",\"High\",\"1\",\"2023-02-21 15:20:24.2148582\",\"login/no_automatic_user_sapstar\",\"Control of the automatic login user SAP*\",\"true\",\"Medium\",\"1\",\"\",\"login/no_automatic_user_sapstar\",\"High\",\"1\",\"2023-02-21 15:20:24.2148582\",\"login/password_change_for_SSO\",\"Handling of password change enforcements in Single Sign-On situations\",\"true\",\"Medium\",\"1\",\"\",\"login/password_change_for_SSO\",\"High\",\"1\",\"2023-02-21 15:20:24.2148582\",\"rsau/max_diskspace/per_day\",\"Maximum size of all security audit files per day\",\"true\",\"Medium\",\"1000000000\",\"\",\"rsau/max_diskspace/per_day\",\"High\",\"1500000000\",\"2023-02-21 15:20:24.2148582\",\"snc/accept_insecure_gui\",\"Accept insecure SAPGUI logins to SNC-enabled Server\",\"true\",\"Medium\",\"1\",\"\",\"snc/accept_insecure_gui\",\"High\",\"0\",\"2023-02-21 15:20:24.2148582\",\"snc/accept_insecure_r3int_rfc\",\"Accept insecure internal RFCs on SNC-enabled Server\",\"true\",\"Medium\",\"1\",\"\",\"snc/accept_insecure_r3int_rfc\",\"High\",\"0\",\"2023-02-21 15:20:24.2148582\",\"snc/extid_login_rfc\",\"Enable login with external identity (RFC)\",\"true\",\"Medium\",\"1\",\"\",\"snc/extid_login_rfc\",\"High\",\"1\",\"2023-02-21 15:20:24.2148582\",\"rfc/reject_expired_passwd\",\"Prevents logon with initial or expired Password via RFC\",\"true\",\"Medium\",\"1\",\"\",\"rfc/reject_expired_passwd\",\"High\",\"1\",\"2023-02-21 15:20:24.2148582\",\"gw/logging\",\"settings for gateway logging\",\"true\",\"Medium\",\"ACTION=Ss LOGFILE=gw_log-%y-%m-%d SWITCHTF=day MAXSIZEKB=100\",\"\",\"gw/logging\",\"High\",\"ACTION=Ss LOGFILE=gw_log-%y-%m-%d SWITCHTF=day MAXSIZEKB=100\",\"2023-02-21 15:20:24.2148582\",\"login/accept_sso2_ticket\",\"Accept SSO tickets for this (component) system\",\"true\",\"High\",\"1\",\"\",\"login/accept_sso2_ticket\",\"High\",\"1\",\"2023-02-21 15:20:24.2148582\",\"login/min_password_specials\",\"min. number of special characters in passwords\",\"true\",\"Medium\",\"0\",\"\",\"login/min_password_specials\",\"High\",\"0\",\"2023-02-21 15:20:24.2148582\",\"rsau/max_diskspace/local\",\"Maximum space for security audit file\",\"true\",\"Medium\",\"1000000000\",\"GE\",\"rsau/max_diskspace/local\",\"High\",\"1500000000\",\"2023-02-21 15:20:24.2148582\",\"rsau/max_diskspace/per_file\",\"Maximum size of one single security audit file\",\"true\",\"Medium\",\"1000000000\",\"\",\"rsau/max_diskspace/per_file\",\"High\",\"1500000000\",\"2023-02-21 15:20:24.2148582\",\"rsau/selection_slots\",\"Number of selection slots for security audit\",\"true\",\"High\",\"10\",\"\",\"rsau/selection_slots\",\"High\",\"10\",\"2023-02-21 15:20:24.2148582\",\"rspo/auth/pagelimit\",\"Activation of page limit check for spool devices\",\"true\",\"High\",\"0\",\"\",\"rspo/auth/pagelimit\",\"High\",\"0\",\"2023-02-21 15:20:24.2148582\",\"snc/data_protection/use\",\"Level of data protection for R/3 initiated connections\",\"true\",\"Medium\",\"3\",\"\",\"snc/data_protection/use\",\"High\",\"3\",\"2023-02-21 15:20:24.2148582\",\"gw/sim_mode\",\"start simulation mode for reg_info and sec_info\",\"true\",\"Medium\",\"0\",\"\",\"gw/sim_mode\",\"High\",\"0\",\"2023-02-21 15:20:24.2148582\",\"login/fails_to_user_lock\",\"Number of invalid login attempts until user lock\",\"true\",\"Medium\",\"5\",\"LE\",\"login/fails_to_user_lock\",\"High\",\"5\",\"2023-02-21 15:20:24.2148582\",\"login/multi_login_users\",\"list of exceptional users: multiple logon allowed\",\"true\",\"Medium\",\"\",\"\",\"login/multi_login_users\",\"High\",\"\",\"2023-02-21 15:20:24.2148582\",\"rsau/enable\",\"Enable Security Audit\",\"true\",\"High\",\"1\",\"\",\"rsau/enable\",\"High\",\"1\",\"2023-02-21 15:20:24.2148582\",\"snc/extid_login_diag\",\"Enable login with external identity (DIAG)\",\"true\",\"Medium\",\"1\",\"\",\"snc/extid_login_diag\",\"High\",\"1\",\"2023-02-21 15:20:24.2148582\",\"wdisp/ssl_encrypt\",\"SSL reencryption mode\",\"true\",\"High\",\"1\",\"\",\"wdisp/ssl_encrypt\",\"High\",\"1\",\"2023-02-21 15:20:24.2148582\",\"gw/acl_mode\",\"Mode for non existing ACL file\",\"true\",\"High\",\"1\",\"\",\"gw/acl_mode\",\"High\",\"0\",\"2023-02-21 15:20:24.2148582\",\"auth/no_check_in_some_cases\",\"Activation of the Profile Generator\",\"true\",\"High\",\"Y\",\"\",\"auth/no_check_in_some_cases\",\"High\",\"Y\",\"2023-02-21 15:20:24.2148582\",\"gw/monitor\",\"Enables or disables monitor commands\",\"true\",\"Medium\",\"1\",\"\",\"gw/monitor\",\"High\",\"1\",\"2023-02-21 15:20:24.2148582\",\"login/fails_to_session_end\",\"Number of invalid login attempts until session end\",\"true\",\"Medium\",\"3\",\"LE\",\"login/fails_to_session_end\",\"High\",\"3\",\"2023-02-21 15:20:24.2148582\",\"login/min_password_diff\",\"min. number of chars which differ between old and new password\",\"true\",\"Medium\",\"1\",\"LE\",\"login/min_password_diff\",\"High\",\"2\",\"2023-02-21 15:20:24.2148582\",\"login/password_compliance_to_current_policy\",\"current password needs to comply with current password policy\",\"true\",\"Medium\",\"0\",\"\",\"login/password_compliance_to_current_policy\",\"High\",\"0\",\"2023-02-21 15:20:24.2148582\",\"login/password_expiration_time\",\"Dates until password must be changed\",\"true\",\"Medium\",\"180\",\"LE\",\"login/password_expiration_time\",\"High\",\"90\",\"2023-02-21 15:20:24.2148582\",\"login/password_max_idle_initial\",\"maximum #days a password (set by the admin) can be unused (idle)\",\"true\",\"Medium\",\"7\",\"LE\",\"login/password_max_idle_initial\",\"High\",\"7\",\"2023-02-21 15:20:24.2148582\",\"rdisp/gui_auto_logout\",\"Maximum idle time for SAP GUI connections\",\"true\",\"Medium\",\"5400\",\"LE\",\"rdisp/gui_auto_logout\",\"High\",\"3600\",\"2023-02-21 15:20:24.2148582\",\"snc/accept_insecure_rfc\",\"Accept insecure RFC-connections to SNC-enabled Server\",\"true\",\"Medium\",\"1\",\"\",\"snc/accept_insecure_rfc\",\"High\",\"0\",\"2023-02-21 15:20:24.2148582\",\"snc/data_protection/max\",\"Limit for data protection of Secure Network Comm.\",\"true\",\"Medium\",\"3\",\"\",\"snc/data_protection/max\",\"High\",\"3\",\"2023-02-21 15:20:24.2148582\",\"snc/enable\",\"Enable SNC-Module (Secure Network Communications)\",\"true\",\"Medium\",\"1\",\"\",\"snc/enable\",\"High\",\"1\",\"2023-02-21 15:20:24.2148582\",\"rfc/ext_debugging\",\"Remote Function call debugging. See SAP KB 2909642 - Deletion of parameter rfc/ext_debugging\",\"true\",\"Medium\",\"2\",\"LE\",\"rfc/ext_debugging\",\"High\",\"2\",\"2023-02-21 15:20:24.2148582\",\"auth/rfc_authority_check\",\"Execution option for the RFC authority check\",\"true\",\"High\",\"1\",\"GE\",\"auth/rfc_authority_check\",\"High\",\"1\",\"2023-02-21 15:20:24.2148582\",\"login/password_change_waittime\",\"Password change possible after # days (since last change)\",\"true\",\"Medium\",\"1\",\"GE\",\"login/password_change_waittime\",\"High\",\"1\",\"2023-02-21 15:20:24.2148582\",\"login/password_history_size\",\"Number of records to be stored in the password history\",\"true\",\"Medium\",\"5\",\"GE\",\"login/password_history_size\",\"High\",\"5\"];\nlet CustomersParameters= _GetWatchlist(\"SAPSystemParameters\")\n| project-away _DTItemId\n| summarize arg_max(LastUpdatedTimeUTC, *) by SearchKey\n| where SearchKey == Parameter or Parameter == \"\"\n| extend Priority= 1;\nlet DefaultParameters= DefaultParametersDT\n| where SearchKey == Parameter or Parameter == \"\"\n| extend Priority = 2;\nlet RelevantParams= (CustomersParameters | union DefaultParameters\n| summarize arg_min(Priority, *) by SearchKey\n| extend Source= iff(Priority==1, \"'SAPSystemParameters' watchlist\", \"Sentinel built-in content\")\n| extend EnableAlerts= tolower(EnableAlerts)\n| extend EnableAlerts= iff(EnableAlerts == \"true\", true, false), DummyJoinField= 1);\nRelevantParams | join kind= inner SAPSystems() on DummyJoinField\n| extend Severity= iff(SystemRole == \"Production\", ProductionSeverity, NonProdSeverity)\n| extend ExpectedValue= iff(SystemRole == \"Production\", ProductionValues, NonProdValues)\n| project-away DummyJoinField1, SearchKey1, ProductionSeverity, NonProdSeverity, ProductionValues, NonProdValues, Priority\n| extend ExpectedNumeric= extract(\"([0-9.]+)\", 1, replace(\",\",\".\", ExpectedValue), typeof(real))\n| extend ExpectedAlpha= extract(\"([A-Z]+[a-z])\", 1, ExpectedValue, typeof(string))\n",
                "functionParameters": "Parameter:string='\"\"'",
                "version": 2,
                "tags": [
                    {
                        "name": "description",
                        "value": "SAPGetSystemParameter"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
            "apiVersion": "2022-01-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId13'),'/'))))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[variables('_parserId13')]"
            ],
            "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPGetSystemParameter')]",
                "contentId": "[variables('parserObject13').parserContentId13]",
                "kind": "Parser",
                "version": "[variables('parserObject13').parserVersion13]",
                "source": {
                    "kind": "Solution",
                    "name": "SAP",
                    "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                    "name": "Microsoft",
                    "email": "[variables('_email')]"
                },
                "support": {
                    "tier": "Microsoft",
                    "name": "Microsoft Corporation",
                    "email": "support@microsoft.com",
                    "link": "https://support.microsoft.com/"
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('parserTemplateSpecName14')]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAPHeartBeat Data Parser with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('parserObject14').parserVersion14]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "name": "[variables('parserObject14')._parserName14]",
                            "apiVersion": "2022-10-01",
                            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "eTag": "*",
                                "displayName": "SAPHeartBeat",
                                "category": "SAPFunctions",
                                "functionAlias": "SAPHeartBeat",
                                "query": "[replace(variables('SAPFunctionsSAPHeartBeatQuery'),'CWSQSAP.', if(equals(coalesce(parameters('CWSQSAPIdentifier'),''),'') , '', concat(variables('CWSQIdentifierPrefix'), parameters('CWSQSAPIdentifier'),variables('CWQSIdentifierSuffix'))))]",
                                "functionParameters": "",
                                "version": 2,
                                "tags": [
                                    {
                                        "name": "description",
                                        "value": "SAPHeartBeat"
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId14'),'/'))))]",
                            "dependsOn": [
                                "[variables('_parserId14')]"
                            ],
                            "properties": {
                                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPHeartBeat')]",
                                "contentId": "[variables('parserObject14').parserContentId14]",
                                "kind": "Parser",
                                "version": "[variables('parserObject14').parserVersion14]",
                                "source": {
                                    "name": "SAP",
                                    "kind": "Solution",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('parserObject14').parserContentId14]",
                "contentKind": "Parser",
                "displayName": "SAPHeartBeat",
                "contentProductId": "[variables('_parsercontentProductId14')]",
                "id": "[variables('_parsercontentProductId14')]",
                "version": "[variables('parserObject14').parserVersion14]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
            "apiVersion": "2022-10-01",
            "name": "[variables('parserObject14')._parserName14]",
            "location": "[parameters('workspace-location')]",
            "properties": {
                "eTag": "*",
                "displayName": "SAPHeartBeat",
                "category": "SAPFunctions",
                "functionAlias": "SAPHeartBeat",
                "query": "[replace(variables('SAPFunctionsSAPHeartBeatQuery'),'CWSQSAP.', if(equals(coalesce(parameters('CWSQSAPIdentifier'),''),'') , '', concat(variables('CWSQIdentifierPrefix'), parameters('CWSQSAPIdentifier'),variables('CWQSIdentifierSuffix'))))]",
                "functionParameters": "",
                "version": 2,
                "tags": [
                    {
                        "name": "description",
                        "value": "SAPHeartBeat"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
            "apiVersion": "2022-01-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId14'),'/'))))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[variables('_parserId14')]"
            ],
            "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPHeartBeat')]",
                "contentId": "[variables('parserObject14').parserContentId14]",
                "kind": "Parser",
                "version": "[variables('parserObject14').parserVersion14]",
                "source": {
                    "kind": "Solution",
                    "name": "SAP",
                    "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                    "name": "Microsoft",
                    "email": "[variables('_email')]"
                },
                "support": {
                    "tier": "Microsoft",
                    "name": "Microsoft Corporation",
                    "email": "support@microsoft.com",
                    "link": "https://support.microsoft.com/"
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('parserTemplateSpecName15')]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAPJAVAFilesLogs Data Parser with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('parserObject15').parserVersion15]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "name": "[variables('parserObject15')._parserName15]",
                            "apiVersion": "2022-10-01",
                            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "eTag": "*",
                                "displayName": "SAPJAVAFilesLogs",
                                "category": "SAPFunctions",
                                "functionAlias": "SAPJAVAFilesLogs",
                                "query": "//generated function structure for custom log JAVAFilesLogs_CL\n//generated on 2022-05-07\n//Sentinel4SAP solution version 1.2.98\nlet D_JAVAFilesLogs_CL = datatable(TimeGenerated:datetime\n,Client:string\n,User:string\n,MNo:string\n,Pid:string\n,Terminal:string\n,Program:string\n,Session:string\n,InstanceNr:string\n,Sid:string\n,hostname:string\n,Severity:string\n,LogName:string\n,MessageText:string\n,Type:string\n)['1000-01-01T00:00:00Z','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString'];\n\nlet T_JAVAFilesLogs_CL = (JAVAFilesLogs_CL | project\nTimeGenerated = column_ifexists('TimeGenerated', '1000-01-01T00:00:00Z')\n,Client = column_ifexists('Client_s', 'initialString')\n,User = column_ifexists('User_s', 'initialString')\n,MNo = column_ifexists('MNo_s', 'initialString')\n,Pid = column_ifexists('Pid_s', 'initialString')\n,Terminal = column_ifexists('Terminal_s', 'initialString')\n,Program = column_ifexists('Program_s', 'initialString')\n,Session = column_ifexists('Session_s', 'initialString')\n,InstanceNr = column_ifexists('InstanceNr_s', 'initialString')\n,Sid = column_ifexists('Sid_s', 'initialString')\n,hostname = column_ifexists('hostname_s', 'initialString')\n,Severity = column_ifexists('Severity_s', 'initialString')\n,LogName = column_ifexists('LogName_s', 'initialString')\n,MessageText = column_ifexists('MessageText_s', 'initialString')\n,Type = column_ifexists('Type', 'initialString')\n);\n\nT_JAVAFilesLogs_CL | union isfuzzy= true (D_JAVAFilesLogs_CL  | where TimeGenerated != '1000-01-01T00:00:00Z')\n",
                                "functionParameters": "",
                                "version": 2,
                                "tags": [
                                    {
                                        "name": "description",
                                        "value": "SAPJAVAFilesLogs"
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId15'),'/'))))]",
                            "dependsOn": [
                                "[variables('_parserId15')]"
                            ],
                            "properties": {
                                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPJAVAFilesLogs')]",
                                "contentId": "[variables('parserObject15').parserContentId15]",
                                "kind": "Parser",
                                "version": "[variables('parserObject15').parserVersion15]",
                                "source": {
                                    "name": "SAP",
                                    "kind": "Solution",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('parserObject15').parserContentId15]",
                "contentKind": "Parser",
                "displayName": "SAPJAVAFilesLogs",
                "contentProductId": "[variables('_parsercontentProductId15')]",
                "id": "[variables('_parsercontentProductId15')]",
                "version": "[variables('parserObject15').parserVersion15]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
            "apiVersion": "2022-10-01",
            "name": "[variables('parserObject15')._parserName15]",
            "location": "[parameters('workspace-location')]",
            "properties": {
                "eTag": "*",
                "displayName": "SAPJAVAFilesLogs",
                "category": "SAPFunctions",
                "functionAlias": "SAPJAVAFilesLogs",
                "query": "//generated function structure for custom log JAVAFilesLogs_CL\n//generated on 2022-05-07\n//Sentinel4SAP solution version 1.2.98\nlet D_JAVAFilesLogs_CL = datatable(TimeGenerated:datetime\n,Client:string\n,User:string\n,MNo:string\n,Pid:string\n,Terminal:string\n,Program:string\n,Session:string\n,InstanceNr:string\n,Sid:string\n,hostname:string\n,Severity:string\n,LogName:string\n,MessageText:string\n,Type:string\n)['1000-01-01T00:00:00Z','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString'];\n\nlet T_JAVAFilesLogs_CL = (JAVAFilesLogs_CL | project\nTimeGenerated = column_ifexists('TimeGenerated', '1000-01-01T00:00:00Z')\n,Client = column_ifexists('Client_s', 'initialString')\n,User = column_ifexists('User_s', 'initialString')\n,MNo = column_ifexists('MNo_s', 'initialString')\n,Pid = column_ifexists('Pid_s', 'initialString')\n,Terminal = column_ifexists('Terminal_s', 'initialString')\n,Program = column_ifexists('Program_s', 'initialString')\n,Session = column_ifexists('Session_s', 'initialString')\n,InstanceNr = column_ifexists('InstanceNr_s', 'initialString')\n,Sid = column_ifexists('Sid_s', 'initialString')\n,hostname = column_ifexists('hostname_s', 'initialString')\n,Severity = column_ifexists('Severity_s', 'initialString')\n,LogName = column_ifexists('LogName_s', 'initialString')\n,MessageText = column_ifexists('MessageText_s', 'initialString')\n,Type = column_ifexists('Type', 'initialString')\n);\n\nT_JAVAFilesLogs_CL | union isfuzzy= true (D_JAVAFilesLogs_CL  | where TimeGenerated != '1000-01-01T00:00:00Z')\n",
                "functionParameters": "",
                "version": 2,
                "tags": [
                    {
                        "name": "description",
                        "value": "SAPJAVAFilesLogs"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
            "apiVersion": "2022-01-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId15'),'/'))))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[variables('_parserId15')]"
            ],
            "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPJAVAFilesLogs')]",
                "contentId": "[variables('parserObject15').parserContentId15]",
                "kind": "Parser",
                "version": "[variables('parserObject15').parserVersion15]",
                "source": {
                    "kind": "Solution",
                    "name": "SAP",
                    "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                    "name": "Microsoft",
                    "email": "[variables('_email')]"
                },
                "support": {
                    "tier": "Microsoft",
                    "name": "Microsoft Corporation",
                    "email": "support@microsoft.com",
                    "link": "https://support.microsoft.com/"
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('parserTemplateSpecName16')]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAPJobLog Data Parser with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('parserObject16').parserVersion16]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "name": "[variables('parserObject16')._parserName16]",
                            "apiVersion": "2022-10-01",
                            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "eTag": "*",
                                "displayName": "SAPJobLog",
                                "category": "SAPFunctions",
                                "functionAlias": "SAPJobLog",
                                "query": "[replace(variables('SAPFunctionsSAPJobLogQuery'),'CWSQSAP.', if(equals(coalesce(parameters('CWSQSAPIdentifier'),''),'') , '', concat(variables('CWSQIdentifierPrefix'), parameters('CWSQSAPIdentifier'),variables('CWQSIdentifierSuffix'))))]",
                                "functionParameters": "",
                                "version": 2,
                                "tags": [
                                    {
                                        "name": "description",
                                        "value": "SAPJobLog"
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId16'),'/'))))]",
                            "dependsOn": [
                                "[variables('_parserId16')]"
                            ],
                            "properties": {
                                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPJobLog')]",
                                "contentId": "[variables('parserObject16').parserContentId16]",
                                "kind": "Parser",
                                "version": "[variables('parserObject16').parserVersion16]",
                                "source": {
                                    "name": "SAP",
                                    "kind": "Solution",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('parserObject16').parserContentId16]",
                "contentKind": "Parser",
                "displayName": "SAPJobLog",
                "contentProductId": "[variables('_parsercontentProductId16')]",
                "id": "[variables('_parsercontentProductId16')]",
                "version": "[variables('parserObject16').parserVersion16]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
            "apiVersion": "2022-10-01",
            "name": "[variables('parserObject16')._parserName16]",
            "location": "[parameters('workspace-location')]",
            "properties": {
                "eTag": "*",
                "displayName": "SAPJobLog",
                "category": "SAPFunctions",
                "functionAlias": "SAPJobLog",
                "query": "[replace(variables('SAPFunctionsSAPJobLogQuery'),'CWSQSAP.', if(equals(coalesce(parameters('CWSQSAPIdentifier'),''),'') , '', concat(variables('CWSQIdentifierPrefix'), parameters('CWSQSAPIdentifier'),variables('CWQSIdentifierSuffix'))))]",
                "functionParameters": "",
                "version": 2,
                "tags": [
                    {
                        "name": "description",
                        "value": "SAPJobLog"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
            "apiVersion": "2022-01-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId16'),'/'))))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[variables('_parserId16')]"
            ],
            "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPJobLog')]",
                "contentId": "[variables('parserObject16').parserContentId16]",
                "kind": "Parser",
                "version": "[variables('parserObject16').parserVersion16]",
                "source": {
                    "kind": "Solution",
                    "name": "SAP",
                    "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                    "name": "Microsoft",
                    "email": "[variables('_email')]"
                },
                "support": {
                    "tier": "Microsoft",
                    "name": "Microsoft Corporation",
                    "email": "support@microsoft.com",
                    "link": "https://support.microsoft.com/"
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('parserTemplateSpecName17')]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAPOS_GW Data Parser with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('parserObject17').parserVersion17]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "name": "[variables('parserObject17')._parserName17]",
                            "apiVersion": "2022-10-01",
                            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "eTag": "*",
                                "displayName": "SAPOS_GW",
                                "category": "SAPFunctions",
                                "functionAlias": "SAPOS_GW",
                                "query": "[replace(variables('SAPFunctionsSAPOS_GWQuery'),'CWSQSAP.', if(equals(coalesce(parameters('CWSQSAPIdentifier'),''),'') , '', concat(variables('CWSQIdentifierPrefix'), parameters('CWSQSAPIdentifier'),variables('CWQSIdentifierSuffix'))))]",
                                "functionParameters": "",
                                "version": 2,
                                "tags": [
                                    {
                                        "name": "description",
                                        "value": "SAPOS_GW"
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId17'),'/'))))]",
                            "dependsOn": [
                                "[variables('_parserId17')]"
                            ],
                            "properties": {
                                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPOS_GW')]",
                                "contentId": "[variables('parserObject17').parserContentId17]",
                                "kind": "Parser",
                                "version": "[variables('parserObject17').parserVersion17]",
                                "source": {
                                    "name": "SAP",
                                    "kind": "Solution",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('parserObject17').parserContentId17]",
                "contentKind": "Parser",
                "displayName": "SAPOS_GW",
                "contentProductId": "[variables('_parsercontentProductId17')]",
                "id": "[variables('_parsercontentProductId17')]",
                "version": "[variables('parserObject17').parserVersion17]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
            "apiVersion": "2022-10-01",
            "name": "[variables('parserObject17')._parserName17]",
            "location": "[parameters('workspace-location')]",
            "properties": {
                "eTag": "*",
                "displayName": "SAPOS_GW",
                "category": "SAPFunctions",
                "functionAlias": "SAPOS_GW",
                "query": "[replace(variables('SAPFunctionsSAPOS_GWQuery'),'CWSQSAP.', if(equals(coalesce(parameters('CWSQSAPIdentifier'),''),'') , '', concat(variables('CWSQIdentifierPrefix'), parameters('CWSQSAPIdentifier'),variables('CWQSIdentifierSuffix'))))]",
                "functionParameters": "",
                "version": 2,
                "tags": [
                    {
                        "name": "description",
                        "value": "SAPOS_GW"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
            "apiVersion": "2022-01-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId17'),'/'))))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[variables('_parserId17')]"
            ],
            "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPOS_GW')]",
                "contentId": "[variables('parserObject17').parserContentId17]",
                "kind": "Parser",
                "version": "[variables('parserObject17').parserVersion17]",
                "source": {
                    "kind": "Solution",
                    "name": "SAP",
                    "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                    "name": "Microsoft",
                    "email": "[variables('_email')]"
                },
                "support": {
                    "tier": "Microsoft",
                    "name": "Microsoft Corporation",
                    "email": "support@microsoft.com",
                    "link": "https://support.microsoft.com/"
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('parserTemplateSpecName18')]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAPOS_ICM Data Parser with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('parserObject18').parserVersion18]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "name": "[variables('parserObject18')._parserName18]",
                            "apiVersion": "2022-10-01",
                            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "eTag": "*",
                                "displayName": "SAPOS_ICM",
                                "category": "SAPFunctions",
                                "functionAlias": "SAPOS_ICM",
                                "query": "[replace(variables('SAPFunctionsSAPOS_ICMQuery'),'CWSQSAP.', if(equals(coalesce(parameters('CWSQSAPIdentifier'),''),'') , '', concat(variables('CWSQIdentifierPrefix'), parameters('CWSQSAPIdentifier'),variables('CWQSIdentifierSuffix'))))]",
                                "functionParameters": "",
                                "version": 2,
                                "tags": [
                                    {
                                        "name": "description",
                                        "value": "SAPOS_ICM"
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId18'),'/'))))]",
                            "dependsOn": [
                                "[variables('_parserId18')]"
                            ],
                            "properties": {
                                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPOS_ICM')]",
                                "contentId": "[variables('parserObject18').parserContentId18]",
                                "kind": "Parser",
                                "version": "[variables('parserObject18').parserVersion18]",
                                "source": {
                                    "name": "SAP",
                                    "kind": "Solution",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('parserObject18').parserContentId18]",
                "contentKind": "Parser",
                "displayName": "SAPOS_ICM",
                "contentProductId": "[variables('_parsercontentProductId18')]",
                "id": "[variables('_parsercontentProductId18')]",
                "version": "[variables('parserObject18').parserVersion18]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
            "apiVersion": "2022-10-01",
            "name": "[variables('parserObject18')._parserName18]",
            "location": "[parameters('workspace-location')]",
            "properties": {
                "eTag": "*",
                "displayName": "SAPOS_ICM",
                "category": "SAPFunctions",
                "functionAlias": "SAPOS_ICM",
                "query": "[replace(variables('SAPFunctionsSAPOS_ICMQuery'),'CWSQSAP.', if(equals(coalesce(parameters('CWSQSAPIdentifier'),''),'') , '', concat(variables('CWSQIdentifierPrefix'), parameters('CWSQSAPIdentifier'),variables('CWQSIdentifierSuffix'))))]",
                "functionParameters": "",
                "version": 2,
                "tags": [
                    {
                        "name": "description",
                        "value": "SAPOS_ICM"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
            "apiVersion": "2022-01-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId18'),'/'))))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[variables('_parserId18')]"
            ],
            "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPOS_ICM')]",
                "contentId": "[variables('parserObject18').parserContentId18]",
                "kind": "Parser",
                "version": "[variables('parserObject18').parserVersion18]",
                "source": {
                    "kind": "Solution",
                    "name": "SAP",
                    "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                    "name": "Microsoft",
                    "email": "[variables('_email')]"
                },
                "support": {
                    "tier": "Microsoft",
                    "name": "Microsoft Corporation",
                    "email": "support@microsoft.com",
                    "link": "https://support.microsoft.com/"
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('parserTemplateSpecName19')]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAPOS_SAPCONTROL Data Parser with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('parserObject19').parserVersion19]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "name": "[variables('parserObject19')._parserName19]",
                            "apiVersion": "2022-10-01",
                            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "eTag": "*",
                                "displayName": "SAPOS_SAPCONTROL",
                                "category": "SAPFunctions",
                                "functionAlias": "SAPOS_SAPCONTROL",
                                "query": "//generated function structure for custom log ABAPOS_SAPCONTROL_CL\nlet D_ABAPOS_SAPCONTROL_CL = datatable(TimeGenerated:datetime\n,System:string\n,MessageText:string\n,Type:string)[];\nlet T_ABAPOS_SAPCONTROL_CL = (ABAPOS_SAPCONTROL_CL | project\nTimeGenerated = TimeGenerated\n,System = System_s\n,MessageText = MessageText_s\n,Type = Type);\nT_ABAPOS_SAPCONTROL_CL | union isfuzzy= true D_ABAPOS_SAPCONTROL_CL\n| extend SplitMessage= split(MessageText, \"\\t\")\n| extend Severity= SplitMessage[1]\n| extend LogType= SplitMessage[2]\n| extend SplitDateTime= split(tostring(SplitMessage[0]), \" \")\n| extend UpdatedOn= todatetime(strcat(SplitDateTime[0],\"-\", SplitDateTime[1], \"-\", SplitDateTime[2],\" \", substring(SplitDateTime[3],0,8), \".\",substring(SplitDateTime[3],9,11)))\n| extend MessageText= strcat_array(array_slice(SplitMessage, 3, -1),\"\")\n| project-away SplitMessage, SplitDateTime\n",
                                "functionParameters": "",
                                "version": 2,
                                "tags": [
                                    {
                                        "name": "description",
                                        "value": "SAPOS_SAPCONTROL"
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId19'),'/'))))]",
                            "dependsOn": [
                                "[variables('_parserId19')]"
                            ],
                            "properties": {
                                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPOS_SAPCONTROL')]",
                                "contentId": "[variables('parserObject19').parserContentId19]",
                                "kind": "Parser",
                                "version": "[variables('parserObject19').parserVersion19]",
                                "source": {
                                    "name": "SAP",
                                    "kind": "Solution",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('parserObject19').parserContentId19]",
                "contentKind": "Parser",
                "displayName": "SAPOS_SAPCONTROL",
                "contentProductId": "[variables('_parsercontentProductId19')]",
                "id": "[variables('_parsercontentProductId19')]",
                "version": "[variables('parserObject19').parserVersion19]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
            "apiVersion": "2022-10-01",
            "name": "[variables('parserObject19')._parserName19]",
            "location": "[parameters('workspace-location')]",
            "properties": {
                "eTag": "*",
                "displayName": "SAPOS_SAPCONTROL",
                "category": "SAPFunctions",
                "functionAlias": "SAPOS_SAPCONTROL",
                "query": "//generated function structure for custom log ABAPOS_SAPCONTROL_CL\nlet D_ABAPOS_SAPCONTROL_CL = datatable(TimeGenerated:datetime\n,System:string\n,MessageText:string\n,Type:string)[];\nlet T_ABAPOS_SAPCONTROL_CL = (ABAPOS_SAPCONTROL_CL | project\nTimeGenerated = TimeGenerated\n,System = System_s\n,MessageText = MessageText_s\n,Type = Type);\nT_ABAPOS_SAPCONTROL_CL | union isfuzzy= true D_ABAPOS_SAPCONTROL_CL\n| extend SplitMessage= split(MessageText, \"\\t\")\n| extend Severity= SplitMessage[1]\n| extend LogType= SplitMessage[2]\n| extend SplitDateTime= split(tostring(SplitMessage[0]), \" \")\n| extend UpdatedOn= todatetime(strcat(SplitDateTime[0],\"-\", SplitDateTime[1], \"-\", SplitDateTime[2],\" \", substring(SplitDateTime[3],0,8), \".\",substring(SplitDateTime[3],9,11)))\n| extend MessageText= strcat_array(array_slice(SplitMessage, 3, -1),\"\")\n| project-away SplitMessage, SplitDateTime\n",
                "functionParameters": "",
                "version": 2,
                "tags": [
                    {
                        "name": "description",
                        "value": "SAPOS_SAPCONTROL"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
            "apiVersion": "2022-01-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId19'),'/'))))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[variables('_parserId19')]"
            ],
            "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPOS_SAPCONTROL')]",
                "contentId": "[variables('parserObject19').parserContentId19]",
                "kind": "Parser",
                "version": "[variables('parserObject19').parserVersion19]",
                "source": {
                    "kind": "Solution",
                    "name": "SAP",
                    "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                    "name": "Microsoft",
                    "email": "[variables('_email')]"
                },
                "support": {
                    "tier": "Microsoft",
                    "name": "Microsoft Corporation",
                    "email": "support@microsoft.com",
                    "link": "https://support.microsoft.com/"
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('parserTemplateSpecName20')]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAPOS_Syslog Data Parser with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('parserObject20').parserVersion20]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "name": "[variables('parserObject20')._parserName20]",
                            "apiVersion": "2022-10-01",
                            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "eTag": "*",
                                "displayName": "SAPOS_Syslog",
                                "category": "SAPFunctions",
                                "functionAlias": "SAPOS_Syslog",
                                "query": "[replace(variables('SAPFunctionsSAPOS_SyslogQuery'),'CWSQSAP.', if(equals(coalesce(parameters('CWSQSAPIdentifier'),''),'') , '', concat(variables('CWSQIdentifierPrefix'), parameters('CWSQSAPIdentifier'),variables('CWQSIdentifierSuffix'))))]",
                                "functionParameters": "",
                                "version": 2,
                                "tags": [
                                    {
                                        "name": "description",
                                        "value": "SAPOS_Syslog"
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId20'),'/'))))]",
                            "dependsOn": [
                                "[variables('_parserId20')]"
                            ],
                            "properties": {
                                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPOS_Syslog')]",
                                "contentId": "[variables('parserObject20').parserContentId20]",
                                "kind": "Parser",
                                "version": "[variables('parserObject20').parserVersion20]",
                                "source": {
                                    "name": "SAP",
                                    "kind": "Solution",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('parserObject20').parserContentId20]",
                "contentKind": "Parser",
                "displayName": "SAPOS_Syslog",
                "contentProductId": "[variables('_parsercontentProductId20')]",
                "id": "[variables('_parsercontentProductId20')]",
                "version": "[variables('parserObject20').parserVersion20]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
            "apiVersion": "2022-10-01",
            "name": "[variables('parserObject20')._parserName20]",
            "location": "[parameters('workspace-location')]",
            "properties": {
                "eTag": "*",
                "displayName": "SAPOS_Syslog",
                "category": "SAPFunctions",
                "functionAlias": "SAPOS_Syslog",
                "query": "[replace(variables('SAPFunctionsSAPOS_SyslogQuery'),'CWSQSAP.', if(equals(coalesce(parameters('CWSQSAPIdentifier'),''),'') , '', concat(variables('CWSQIdentifierPrefix'), parameters('CWSQSAPIdentifier'),variables('CWQSIdentifierSuffix'))))]",
                "functionParameters": "",
                "version": 2,
                "tags": [
                    {
                        "name": "description",
                        "value": "SAPOS_Syslog"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
            "apiVersion": "2022-01-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId20'),'/'))))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[variables('_parserId20')]"
            ],
            "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPOS_Syslog')]",
                "contentId": "[variables('parserObject20').parserContentId20]",
                "kind": "Parser",
                "version": "[variables('parserObject20').parserVersion20]",
                "source": {
                    "kind": "Solution",
                    "name": "SAP",
                    "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                    "name": "Microsoft",
                    "email": "[variables('_email')]"
                },
                "support": {
                    "tier": "Microsoft",
                    "name": "Microsoft Corporation",
                    "email": "support@microsoft.com",
                    "link": "https://support.microsoft.com/"
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('parserTemplateSpecName21')]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAPOS_WP Data Parser with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('parserObject21').parserVersion21]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "name": "[variables('parserObject21')._parserName21]",
                            "apiVersion": "2022-10-01",
                            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "eTag": "*",
                                "displayName": "SAPOS_WP",
                                "category": "SAPFunctions",
                                "functionAlias": "SAPOS_WP",
                                "query": "[replace(variables('SAPFunctionsSAPOS_WPQuery'),'CWSQSAP.', if(equals(coalesce(parameters('CWSQSAPIdentifier'),''),'') , '', concat(variables('CWSQIdentifierPrefix'), parameters('CWSQSAPIdentifier'),variables('CWQSIdentifierSuffix'))))]",
                                "functionParameters": "",
                                "version": 2,
                                "tags": [
                                    {
                                        "name": "description",
                                        "value": "SAPOS_WP"
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId21'),'/'))))]",
                            "dependsOn": [
                                "[variables('_parserId21')]"
                            ],
                            "properties": {
                                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPOS_WP')]",
                                "contentId": "[variables('parserObject21').parserContentId21]",
                                "kind": "Parser",
                                "version": "[variables('parserObject21').parserVersion21]",
                                "source": {
                                    "name": "SAP",
                                    "kind": "Solution",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('parserObject21').parserContentId21]",
                "contentKind": "Parser",
                "displayName": "SAPOS_WP",
                "contentProductId": "[variables('_parsercontentProductId21')]",
                "id": "[variables('_parsercontentProductId21')]",
                "version": "[variables('parserObject21').parserVersion21]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
            "apiVersion": "2022-10-01",
            "name": "[variables('parserObject21')._parserName21]",
            "location": "[parameters('workspace-location')]",
            "properties": {
                "eTag": "*",
                "displayName": "SAPOS_WP",
                "category": "SAPFunctions",
                "functionAlias": "SAPOS_WP",
                "query": "[replace(variables('SAPFunctionsSAPOS_WPQuery'),'CWSQSAP.', if(equals(coalesce(parameters('CWSQSAPIdentifier'),''),'') , '', concat(variables('CWSQIdentifierPrefix'), parameters('CWSQSAPIdentifier'),variables('CWQSIdentifierSuffix'))))]",
                "functionParameters": "",
                "version": 2,
                "tags": [
                    {
                        "name": "description",
                        "value": "SAPOS_WP"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
            "apiVersion": "2022-01-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId21'),'/'))))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[variables('_parserId21')]"
            ],
            "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPOS_WP')]",
                "contentId": "[variables('parserObject21').parserContentId21]",
                "kind": "Parser",
                "version": "[variables('parserObject21').parserVersion21]",
                "source": {
                    "kind": "Solution",
                    "name": "SAP",
                    "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                    "name": "Microsoft",
                    "email": "[variables('_email')]"
                },
                "support": {
                    "tier": "Microsoft",
                    "name": "Microsoft Corporation",
                    "email": "support@microsoft.com",
                    "link": "https://support.microsoft.com/"
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('parserTemplateSpecName22')]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAPSpoolLog Data Parser with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('parserObject22').parserVersion22]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "name": "[variables('parserObject22')._parserName22]",
                            "apiVersion": "2022-10-01",
                            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "eTag": "*",
                                "displayName": "SAPSpoolLog",
                                "category": "SAPFunctions",
                                "functionAlias": "SAPSpoolLog",
                                "query": "[replace(variables('SAPFunctionsSAPSpoolLogQuery'),'CWSQSAP.', if(equals(coalesce(parameters('CWSQSAPIdentifier'),''),'') , '', concat(variables('CWSQIdentifierPrefix'), parameters('CWSQSAPIdentifier'),variables('CWQSIdentifierSuffix'))))]",
                                "functionParameters": "",
                                "version": 2,
                                "tags": [
                                    {
                                        "name": "description",
                                        "value": "SAPSpoolLog"
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId22'),'/'))))]",
                            "dependsOn": [
                                "[variables('_parserId22')]"
                            ],
                            "properties": {
                                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPSpoolLog')]",
                                "contentId": "[variables('parserObject22').parserContentId22]",
                                "kind": "Parser",
                                "version": "[variables('parserObject22').parserVersion22]",
                                "source": {
                                    "name": "SAP",
                                    "kind": "Solution",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('parserObject22').parserContentId22]",
                "contentKind": "Parser",
                "displayName": "SAPSpoolLog",
                "contentProductId": "[variables('_parsercontentProductId22')]",
                "id": "[variables('_parsercontentProductId22')]",
                "version": "[variables('parserObject22').parserVersion22]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
            "apiVersion": "2022-10-01",
            "name": "[variables('parserObject22')._parserName22]",
            "location": "[parameters('workspace-location')]",
            "properties": {
                "eTag": "*",
                "displayName": "SAPSpoolLog",
                "category": "SAPFunctions",
                "functionAlias": "SAPSpoolLog",
                "query": "[replace(variables('SAPFunctionsSAPSpoolLogQuery'),'CWSQSAP.', if(equals(coalesce(parameters('CWSQSAPIdentifier'),''),'') , '', concat(variables('CWSQIdentifierPrefix'), parameters('CWSQSAPIdentifier'),variables('CWQSIdentifierSuffix'))))]",
                "functionParameters": "",
                "version": 2,
                "tags": [
                    {
                        "name": "description",
                        "value": "SAPSpoolLog"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
            "apiVersion": "2022-01-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId22'),'/'))))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[variables('_parserId22')]"
            ],
            "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPSpoolLog')]",
                "contentId": "[variables('parserObject22').parserContentId22]",
                "kind": "Parser",
                "version": "[variables('parserObject22').parserVersion22]",
                "source": {
                    "kind": "Solution",
                    "name": "SAP",
                    "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                    "name": "Microsoft",
                    "email": "[variables('_email')]"
                },
                "support": {
                    "tier": "Microsoft",
                    "name": "Microsoft Corporation",
                    "email": "support@microsoft.com",
                    "link": "https://support.microsoft.com/"
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('parserTemplateSpecName23')]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAPSpoolOutputLog Data Parser with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('parserObject23').parserVersion23]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "name": "[variables('parserObject23')._parserName23]",
                            "apiVersion": "2022-10-01",
                            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "eTag": "*",
                                "displayName": "SAPSpoolOutputLog",
                                "category": "SAPFunctions",
                                "functionAlias": "SAPSpoolOutputLog",
                                "query": "[replace(variables('SAPFunctionsSAPSpoolOutputLogQuery'),'CWSQSAP.', if(equals(coalesce(parameters('CWSQSAPIdentifier'),''),'') , '', concat(variables('CWSQIdentifierPrefix'), parameters('CWSQSAPIdentifier'),variables('CWQSIdentifierSuffix'))))]",
                                "functionParameters": "",
                                "version": 2,
                                "tags": [
                                    {
                                        "name": "description",
                                        "value": "SAPSpoolOutputLog"
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId23'),'/'))))]",
                            "dependsOn": [
                                "[variables('_parserId23')]"
                            ],
                            "properties": {
                                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPSpoolOutputLog')]",
                                "contentId": "[variables('parserObject23').parserContentId23]",
                                "kind": "Parser",
                                "version": "[variables('parserObject23').parserVersion23]",
                                "source": {
                                    "name": "SAP",
                                    "kind": "Solution",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('parserObject23').parserContentId23]",
                "contentKind": "Parser",
                "displayName": "SAPSpoolOutputLog",
                "contentProductId": "[variables('_parsercontentProductId23')]",
                "id": "[variables('_parsercontentProductId23')]",
                "version": "[variables('parserObject23').parserVersion23]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
            "apiVersion": "2022-10-01",
            "name": "[variables('parserObject23')._parserName23]",
            "location": "[parameters('workspace-location')]",
            "properties": {
                "eTag": "*",
                "displayName": "SAPSpoolOutputLog",
                "category": "SAPFunctions",
                "functionAlias": "SAPSpoolOutputLog",
                "query": "[replace(variables('SAPFunctionsSAPSpoolOutputLogQuery'),'CWSQSAP.', if(equals(coalesce(parameters('CWSQSAPIdentifier'),''),'') , '', concat(variables('CWSQIdentifierPrefix'), parameters('CWSQSAPIdentifier'),variables('CWQSIdentifierSuffix'))))]",
                "functionParameters": "",
                "version": 2,
                "tags": [
                    {
                        "name": "description",
                        "value": "SAPSpoolOutputLog"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
            "apiVersion": "2022-01-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId23'),'/'))))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[variables('_parserId23')]"
            ],
            "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPSpoolOutputLog')]",
                "contentId": "[variables('parserObject23').parserContentId23]",
                "kind": "Parser",
                "version": "[variables('parserObject23').parserVersion23]",
                "source": {
                    "kind": "Solution",
                    "name": "SAP",
                    "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                    "name": "Microsoft",
                    "email": "[variables('_email')]"
                },
                "support": {
                    "tier": "Microsoft",
                    "name": "Microsoft Corporation",
                    "email": "support@microsoft.com",
                    "link": "https://support.microsoft.com/"
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('parserTemplateSpecName24')]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAPSyslog Data Parser with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('parserObject24').parserVersion24]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "name": "[variables('parserObject24')._parserName24]",
                            "apiVersion": "2022-10-01",
                            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "eTag": "*",
                                "displayName": "SAPSyslog",
                                "category": "SAPFunctions",
                                "functionAlias": "SAPSyslog",
                                "query": "//generated function structure for custom log Syslog\n//generated on 2022-05-07\n//Sentinel4SAP solution version 1.2.98\nlet D_Syslog = datatable(TimeGenerated:datetime\n,EventTime:datetime\n,Facility:string\n,HostName:string\n,SeverityLevel:string\n,SyslogMessage:string\n,ProcessID:int\n,HostIP:string\n,ProcessName:string\n,Type:string\n)['1000-01-01T00:00:00Z','1000-01-01T00:00:00Z','initialString','initialString','initialString','initialString',1,'initialString','initialString','initialString'];\n\nlet T_Syslog = (Syslog | project\nTimeGenerated = column_ifexists('TimeGenerated', '1000-01-01T00:00:00Z')\n,EventTime = column_ifexists('EventTime', '1000-01-01T00:00:00Z')\n,Facility = column_ifexists('Facility', 'initialString')\n,HostName = column_ifexists('HostName', 'initialString')\n,SeverityLevel = column_ifexists('SeverityLevel', 'initialString')\n,SyslogMessage = column_ifexists('SyslogMessage', 'initialString')\n,ProcessID = column_ifexists('ProcessID', 1)\n,HostIP = column_ifexists('HostIP', 'initialString')\n,ProcessName = column_ifexists('ProcessName', 'initialString')\n,Type = column_ifexists('Type', 'initialString')\n);\n\nT_Syslog | union isfuzzy= true (D_Syslog  | where TimeGenerated != '1000-01-01T00:00:00Z')\n",
                                "functionParameters": "",
                                "version": 2,
                                "tags": [
                                    {
                                        "name": "description",
                                        "value": "SAPSyslog"
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId24'),'/'))))]",
                            "dependsOn": [
                                "[variables('_parserId24')]"
                            ],
                            "properties": {
                                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPSyslog')]",
                                "contentId": "[variables('parserObject24').parserContentId24]",
                                "kind": "Parser",
                                "version": "[variables('parserObject24').parserVersion24]",
                                "source": {
                                    "name": "SAP",
                                    "kind": "Solution",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('parserObject24').parserContentId24]",
                "contentKind": "Parser",
                "displayName": "SAPSyslog",
                "contentProductId": "[variables('_parsercontentProductId24')]",
                "id": "[variables('_parsercontentProductId24')]",
                "version": "[variables('parserObject24').parserVersion24]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
            "apiVersion": "2022-10-01",
            "name": "[variables('parserObject24')._parserName24]",
            "location": "[parameters('workspace-location')]",
            "properties": {
                "eTag": "*",
                "displayName": "SAPSyslog",
                "category": "SAPFunctions",
                "functionAlias": "SAPSyslog",
                "query": "//generated function structure for custom log Syslog\n//generated on 2022-05-07\n//Sentinel4SAP solution version 1.2.98\nlet D_Syslog = datatable(TimeGenerated:datetime\n,EventTime:datetime\n,Facility:string\n,HostName:string\n,SeverityLevel:string\n,SyslogMessage:string\n,ProcessID:int\n,HostIP:string\n,ProcessName:string\n,Type:string\n)['1000-01-01T00:00:00Z','1000-01-01T00:00:00Z','initialString','initialString','initialString','initialString',1,'initialString','initialString','initialString'];\n\nlet T_Syslog = (Syslog | project\nTimeGenerated = column_ifexists('TimeGenerated', '1000-01-01T00:00:00Z')\n,EventTime = column_ifexists('EventTime', '1000-01-01T00:00:00Z')\n,Facility = column_ifexists('Facility', 'initialString')\n,HostName = column_ifexists('HostName', 'initialString')\n,SeverityLevel = column_ifexists('SeverityLevel', 'initialString')\n,SyslogMessage = column_ifexists('SyslogMessage', 'initialString')\n,ProcessID = column_ifexists('ProcessID', 1)\n,HostIP = column_ifexists('HostIP', 'initialString')\n,ProcessName = column_ifexists('ProcessName', 'initialString')\n,Type = column_ifexists('Type', 'initialString')\n);\n\nT_Syslog | union isfuzzy= true (D_Syslog  | where TimeGenerated != '1000-01-01T00:00:00Z')\n",
                "functionParameters": "",
                "version": 2,
                "tags": [
                    {
                        "name": "description",
                        "value": "SAPSyslog"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
            "apiVersion": "2022-01-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId24'),'/'))))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[variables('_parserId24')]"
            ],
            "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPSyslog')]",
                "contentId": "[variables('parserObject24').parserContentId24]",
                "kind": "Parser",
                "version": "[variables('parserObject24').parserVersion24]",
                "source": {
                    "kind": "Solution",
                    "name": "SAP",
                    "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                    "name": "Microsoft",
                    "email": "[variables('_email')]"
                },
                "support": {
                    "tier": "Microsoft",
                    "name": "Microsoft Corporation",
                    "email": "support@microsoft.com",
                    "link": "https://support.microsoft.com/"
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('parserTemplateSpecName25')]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAPSystems Data Parser with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('parserObject25').parserVersion25]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "name": "[variables('parserObject25')._parserName25]",
                            "apiVersion": "2022-10-01",
                            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "eTag": "*",
                                "displayName": "SAPSystems",
                                "category": "SAPFunctions",
                                "functionAlias": "SAPSystems",
                                "query": "[replace(variables('SAPFunctionsSAPSystemsQuery'),'CWSQSAP.', if(equals(coalesce(parameters('CWSQSAPIdentifier'),''),'') , '', concat(variables('CWSQIdentifierPrefix'), parameters('CWSQSAPIdentifier'),variables('CWQSIdentifierSuffix'))))]",
                                "functionParameters": "SelectedSystems:dynamic=dynamic([\"All Systems\"]),SelectedSystemRoles:dynamic=dynamic([\"All System Roles\"]),SelectedSystemUsage:dynamic=dynamic([\"All Usage Types\"])",
                                "version": 2,
                                "tags": [
                                    {
                                        "name": "description",
                                        "value": "SAPSystems"
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId25'),'/'))))]",
                            "dependsOn": [
                                "[variables('_parserId25')]"
                            ],
                            "properties": {
                                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPSystems')]",
                                "contentId": "[variables('parserObject25').parserContentId25]",
                                "kind": "Parser",
                                "version": "[variables('parserObject25').parserVersion25]",
                                "source": {
                                    "name": "SAP",
                                    "kind": "Solution",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('parserObject25').parserContentId25]",
                "contentKind": "Parser",
                "displayName": "SAPSystems",
                "contentProductId": "[variables('_parsercontentProductId25')]",
                "id": "[variables('_parsercontentProductId25')]",
                "version": "[variables('parserObject25').parserVersion25]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
            "apiVersion": "2022-10-01",
            "name": "[variables('parserObject25')._parserName25]",
            "location": "[parameters('workspace-location')]",
            "properties": {
                "eTag": "*",
                "displayName": "SAPSystems",
                "category": "SAPFunctions",
                "functionAlias": "SAPSystems",
                "query": "[replace(variables('SAPFunctionsSAPSystemsQuery'),'CWSQSAP.', if(equals(coalesce(parameters('CWSQSAPIdentifier'),''),'') , '', concat(variables('CWSQIdentifierPrefix'), parameters('CWSQSAPIdentifier'),variables('CWQSIdentifierSuffix'))))]",
                "functionParameters": "SelectedSystems:dynamic=dynamic([\"All Systems\"]),SelectedSystemRoles:dynamic=dynamic([\"All System Roles\"]),SelectedSystemUsage:dynamic=dynamic([\"All Usage Types\"])",
                "version": 2,
                "tags": [
                    {
                        "name": "description",
                        "value": "SAPSystems"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
            "apiVersion": "2022-01-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId25'),'/'))))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[variables('_parserId25')]"
            ],
            "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPSystems')]",
                "contentId": "[variables('parserObject25').parserContentId25]",
                "kind": "Parser",
                "version": "[variables('parserObject25').parserVersion25]",
                "source": {
                    "kind": "Solution",
                    "name": "SAP",
                    "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                    "name": "Microsoft",
                    "email": "[variables('_email')]"
                },
                "support": {
                    "tier": "Microsoft",
                    "name": "Microsoft Corporation",
                    "email": "support@microsoft.com",
                    "link": "https://support.microsoft.com/"
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('parserTemplateSpecName26')]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAPTableDataLog Data Parser with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('parserObject26').parserVersion26]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "name": "[variables('parserObject26')._parserName26]",
                            "apiVersion": "2022-10-01",
                            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "eTag": "*",
                                "displayName": "SAPTableDataLog",
                                "category": "SAPFunctions",
                                "functionAlias": "SAPTableDataLog",
                                "query": "[replace(variables('SAPFunctionsSAPTableDataLogQuery'),'CWSQSAP.', if(equals(coalesce(parameters('CWSQSAPIdentifier'),''),'') , '', concat(variables('CWSQIdentifierPrefix'), parameters('CWSQSAPIdentifier'),variables('CWQSIdentifierSuffix'))))]",
                                "functionParameters": "",
                                "version": 2,
                                "tags": [
                                    {
                                        "name": "description",
                                        "value": "SAPTableDataLog"
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId26'),'/'))))]",
                            "dependsOn": [
                                "[variables('_parserId26')]"
                            ],
                            "properties": {
                                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPTableDataLog')]",
                                "contentId": "[variables('parserObject26').parserContentId26]",
                                "kind": "Parser",
                                "version": "[variables('parserObject26').parserVersion26]",
                                "source": {
                                    "name": "SAP",
                                    "kind": "Solution",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('parserObject26').parserContentId26]",
                "contentKind": "Parser",
                "displayName": "SAPTableDataLog",
                "contentProductId": "[variables('_parsercontentProductId26')]",
                "id": "[variables('_parsercontentProductId26')]",
                "version": "[variables('parserObject26').parserVersion26]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
            "apiVersion": "2022-10-01",
            "name": "[variables('parserObject26')._parserName26]",
            "location": "[parameters('workspace-location')]",
            "properties": {
                "eTag": "*",
                "displayName": "SAPTableDataLog",
                "category": "SAPFunctions",
                "functionAlias": "SAPTableDataLog",
                "query": "[replace(variables('SAPFunctionsSAPTableDataLogQuery'),'CWSQSAP.', if(equals(coalesce(parameters('CWSQSAPIdentifier'),''),'') , '', concat(variables('CWSQIdentifierPrefix'), parameters('CWSQSAPIdentifier'),variables('CWQSIdentifierSuffix'))))]",
                "functionParameters": "",
                "version": 2,
                "tags": [
                    {
                        "name": "description",
                        "value": "SAPTableDataLog"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
            "apiVersion": "2022-01-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId26'),'/'))))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[variables('_parserId26')]"
            ],
            "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPTableDataLog')]",
                "contentId": "[variables('parserObject26').parserContentId26]",
                "kind": "Parser",
                "version": "[variables('parserObject26').parserVersion26]",
                "source": {
                    "kind": "Solution",
                    "name": "SAP",
                    "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                    "name": "Microsoft",
                    "email": "[variables('_email')]"
                },
                "support": {
                    "tier": "Microsoft",
                    "name": "Microsoft Corporation",
                    "email": "support@microsoft.com",
                    "link": "https://support.microsoft.com/"
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('parserTemplateSpecName27')]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAPThreatIntelligenceIndicator Data Parser with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('parserObject27').parserVersion27]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "name": "[variables('parserObject27')._parserName27]",
                            "apiVersion": "2022-10-01",
                            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "eTag": "*",
                                "displayName": "SAPThreatIntelligenceIndicator",
                                "category": "SAPFunctions",
                                "functionAlias": "SAPThreatIntelligenceIndicator",
                                "query": "[replace(variables('SAPFunctionsSAPThreatIntelligenceIndicatorQuery'),'CWSQSOC.', if(equals(coalesce(parameters('CWSQSOCIdentifier'),''),'') , '', concat(variables('CWSQIdentifierPrefix'), parameters('CWSQSOCIdentifier'),variables('CWQSIdentifierSuffix'))))]",
                                "functionParameters": "",
                                "version": 2,
                                "tags": [
                                    {
                                        "name": "description",
                                        "value": "SAPThreatIntelligenceIndicator"
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId27'),'/'))))]",
                            "dependsOn": [
                                "[variables('_parserId27')]"
                            ],
                            "properties": {
                                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPThreatIntelligenceIndicator')]",
                                "contentId": "[variables('parserObject27').parserContentId27]",
                                "kind": "Parser",
                                "version": "[variables('parserObject27').parserVersion27]",
                                "source": {
                                    "name": "SAP",
                                    "kind": "Solution",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('parserObject27').parserContentId27]",
                "contentKind": "Parser",
                "displayName": "SAPThreatIntelligenceIndicator",
                "contentProductId": "[variables('_parsercontentProductId27')]",
                "id": "[variables('_parsercontentProductId27')]",
                "version": "[variables('parserObject27').parserVersion27]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
            "apiVersion": "2022-10-01",
            "name": "[variables('parserObject27')._parserName27]",
            "location": "[parameters('workspace-location')]",
            "properties": {
                "eTag": "*",
                "displayName": "SAPThreatIntelligenceIndicator",
                "category": "SAPFunctions",
                "functionAlias": "SAPThreatIntelligenceIndicator",
                "query": "[replace(variables('SAPFunctionsSAPThreatIntelligenceIndicatorQuery'),'CWSQSOC.', if(equals(coalesce(parameters('CWSQSOCIdentifier'),''),'') , '', concat(variables('CWSQIdentifierPrefix'), parameters('CWSQSOCIdentifier'),variables('CWQSIdentifierSuffix'))))]",
                "functionParameters": "",
                "version": 2,
                "tags": [
                    {
                        "name": "description",
                        "value": "SAPThreatIntelligenceIndicator"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
            "apiVersion": "2022-01-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId27'),'/'))))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[variables('_parserId27')]"
            ],
            "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPThreatIntelligenceIndicator')]",
                "contentId": "[variables('parserObject27').parserContentId27]",
                "kind": "Parser",
                "version": "[variables('parserObject27').parserVersion27]",
                "source": {
                    "kind": "Solution",
                    "name": "SAP",
                    "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                    "name": "Microsoft",
                    "email": "[variables('_email')]"
                },
                "support": {
                    "tier": "Microsoft",
                    "name": "Microsoft Corporation",
                    "email": "support@microsoft.com",
                    "link": "https://support.microsoft.com/"
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('parserTemplateSpecName28')]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAPUsersAssignments Data Parser with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('parserObject28').parserVersion28]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "name": "[variables('parserObject28')._parserName28]",
                            "apiVersion": "2022-10-01",
                            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "eTag": "*",
                                "displayName": "SAPUsersAssignments",
                                "category": "SAPFunctions",
                                "functionAlias": "SAPUsersAssignments",
                                "query": "let UserMDTimeAgo = totimespan(toscalar(SAPGetParameters('UserMDLookBack')| project-keep ValueLow));\n// only show users which are not locked for over 180 days (for performance considerations)\nlet agoLocked = format_datetime(ago(180d), 'yyyyMMdd');\n// let SelectedSystemRoles =  dynamic([\"All System Roles\"]); //can also do// let SelectedSystemRoles =  dynamic([\"Production\", \"UAT\"]);\n// let SelectedSystems = dynamic([\"All Systems\"]); // can also do // let SelectedSystems = dynamic([\"BIP\", \"C4D\"]);\nlet Systems= SAPSystems(SelectedSystemRoles= SelectedSystemRoles, SelectedSystems=SelectedSystems)\n    | project SystemID= SearchKey, SystemRole, SystemUsage\n    | extend SystemRole= replace_string(SystemRole, 'Unknown (Production)', 'Unknown');\n// get assignments from change documents\nlet UserMDUpdates= SAP_AGR_USERS | where TimeGenerated > ago(UserMDTimeAgo)\n| where SystemID in (Systems)\n| summarize LastSynched= max(TimeGenerated) by SystemID, ClientID=MANDT;\nlet RoleAssignments =SAPChangeDocsLog\n| where TimeGenerated > ago(UserMDTimeAgo)\n| where SystemID in (Systems)\n| where UpdatedOn_t > ago(UserMDTimeAgo)\n| where (ObjectClass == \"PFCG\" and TableName == \"AGR_USERS\")\n| extend UserAssigned = trim_end(@\"[^\\w]+\" ,extract(@\"^.{1,33}\\s*?(.{1,12})\\s*?\\d{16}\", 1, ChangedTableKey))\n| project-rename Role=ObjectID, ChangedOn= UpdatedOn_t;\nlet ProfileAssignments =SAPChangeDocsLog\n| where TimeGenerated > ago(UserMDTimeAgo)\n| where SystemID in (Systems)\n| where UpdatedOn_t > ago(UserMDTimeAgo)\n| where (ObjectClass == \"IDENTITY\" and TableName == \"SUSR_UST04\")\n| extend UserAssigned = ObjectID\n| project-rename ChangedOn= UpdatedOn_t;\nlet UserRecordChanges= SAPAuditLog\n| where TimeGenerated> ago(UserMDTimeAgo + 1h)\n| where SystemID in (Systems)\n| where MessageID == \"AUB\" or MessageID == \"AUD\"\n| where ingestion_time() > ago(UserMDTimeAgo)\n| project-rename ChangedOn= UpdatedOn_t\n| summarize by ChangedOn, TerminalIPv6, User, Host, Email, Variable1;\nlet Assignments= UserRecordChanges\n| join kind=inner (RoleAssignments | union ProfileAssignments) on User, ChangedOn\n| extend Profile= iff(TableName == \"SUSR_UST04\", ChangedTableKey, \"\")\n| summarize LastChangedOn=arg_max(ChangedOn, *)\nby UserAssigned, Role, Profile, SystemID, ClientID\n| lookup UserMDUpdates on SystemID, ClientID\n| where LastChangedOn > LastSynched // drop the updates that are already included in user MD synch\n| summarize AddedProfiles=make_set_if(Profile,isnotempty(Profile) and TypeofChange_Item in(dynamic([\"I\", \"U\", \"J\"])))\n, RemovedProfiles=make_set_if(Profile,isnotempty(Profile) and TypeofChange_Item in(dynamic([\"E\", \"D\"])))\n, AddedRoles=make_set_if(Role,isnotempty(Role) and TypeofChange_Item in(dynamic([\"I\", \"U\", \"J\"])))\n, RemovedRoles=make_set_if(Role,isnotempty(Role) and TypeofChange_Item in(dynamic([\"E\", \"D\"])))\nby User= UserAssigned, SystemID, ClientID\n| extend Source= \"ChangeDocs\";\n// get logon Data (Kernel-Side Use)\nSAP_USR02 | where TimeGenerated > ago(UserMDTimeAgo)\n| where SystemID in (Systems)\n| extend Relevant= strcmp( GLTGB, agoLocked) > 0 or GLTGB == \"00000000\"\n| where Relevant\n| summarize any(ERDAT), arg_max(TimeGenerated, CLASS, UFLAG, TZONE, USTYP, TRDAT, LTIME, ERDAT) by BNAME, MANDT, SystemID\n// get profiles\n| join kind=leftouter (SAP_UST04| where TimeGenerated > ago(UserMDTimeAgo) | where SystemID in (Systems) | summarize arg_max(TimeGenerated, *), profiles = make_set(PROFILE, 50) by BNAME, MANDT, SystemID)\non BNAME, MANDT, SystemID\n// get Assignment of roles to users\n| join kind=leftouter hint.strategy=shuffle (SAP_AGR_USERS | where TimeGenerated > ago(UserMDTimeAgo) | where SystemID in (Systems) | summarize arg_max(TimeGenerated, UNAME, AGR_NAME, MANDT, SystemID, COL_FLAG) by UNAME, AGR_NAME, MANDT, SystemID, COL_FLAG\n// get the child roles as well\n| join kind= leftouter   (SAP_AGR_AGRS | where TimeGenerated > ago(UserMDTimeAgo) | where SystemID in (Systems) | summarize arg_max(TimeGenerated, MANDT, AGR_NAME, CHILD_AGR, SystemID) by MANDT, AGR_NAME, CHILD_AGR, SystemID)\non MANDT, SystemID, AGR_NAME\n| summarize DirectRoles = make_set_if(AGR_NAME, COL_FLAG != 'X',  50),// COL_FLAG==X -> indirect\nChildRoles = make_set_if(CHILD_AGR, isnotempty(CHILD_AGR) ,50)\nby UNAME, MANDT, SystemID)\non $left.BNAME == $right.UNAME\n, $left.MANDT == $right.MANDT\n, $left.SystemID == $right.SystemID\n// get User Name/Address Key Assignment\n| join kind=leftouter hint.strategy=shuffle ( (SAP_USR21 | where TimeGenerated > ago(UserMDTimeAgo)\n| summarize arg_max(TimeGenerated, BNAME, ADDRNUMBER, PERSNUMBER) by BNAME, MANDT, SystemID )\n// get E-Mail Addresses\n| join kind= inner hint.strategy=shuffle (SAP_ADR6| where TimeGenerated > ago(UserMDTimeAgo) | summarize arg_max(TimeGenerated, ADDRNUMBER, SMTP_ADDR) by CLIENT, ADDRNUMBER, PERSNUMBER, DATE_FROM, CONSNUMBER, SystemID)\non $left.ADDRNUMBER == $right.ADDRNUMBER\n, $left.MANDT == $right.CLIENT\n, $left.SystemID == $right.SystemID\n, $left.PERSNUMBER == $right.PERSNUMBER\n| summarize\narg_max(TimeGenerated1, SMTP_ADDR, MANDT, SystemID),\narg_max(TimeGenerated, BNAME, MANDT, SystemID)\nby BNAME, MANDT, SystemID)\non $left.BNAME == $right.BNAME\n, $left.MANDT == $right.MANDT\n, $left.SystemID == $right.SystemID\n| extend LastSeen = todatetime(strcat(TRDAT, LTIME))\n| extend CreatedOn = todatetime(ERDAT)\n| project-rename User= BNAME, ClientID = MANDT\n| lookup Assignments on SystemID, User, ClientID\n| extend DirectRoles= set_difference(set_union(DirectRoles, AddedRoles),RemovedRoles)\n| extend ChildRoles= set_difference(ChildRoles,RemovedRoles)\n| extend Profiles= set_difference(set_union(profiles, AddedProfiles), RemovedProfiles)\n| project User, Email = SMTP_ADDR, UserType = USTYP, Timezone = TZONE, LockedStatus = UFLAG, LastSeen, UserGroupAuth = CLASS, Profiles, DirectRoles, ChildRoles, CreatedOn, Client= ClientID, SystemID = SystemID, AddedRoles, RemovedRoles, AddedProfiles, RemovedProfiles, Roles=set_union(DirectRoles, ChildRoles), Source=coalesce(Source,\"UserMD\")\n",
                                "functionParameters": "SelectedSystems:dynamic=dynamic([\"All Systems\"]),SelectedSystemRoles:dynamic=dynamic([\"All System Roles\"])",
                                "version": 2,
                                "tags": [
                                    {
                                        "name": "description",
                                        "value": "SAPUsersAssignments"
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId28'),'/'))))]",
                            "dependsOn": [
                                "[variables('_parserId28')]"
                            ],
                            "properties": {
                                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPUsersAssignments')]",
                                "contentId": "[variables('parserObject28').parserContentId28]",
                                "kind": "Parser",
                                "version": "[variables('parserObject28').parserVersion28]",
                                "source": {
                                    "name": "SAP",
                                    "kind": "Solution",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('parserObject28').parserContentId28]",
                "contentKind": "Parser",
                "displayName": "SAPUsersAssignments",
                "contentProductId": "[variables('_parsercontentProductId28')]",
                "id": "[variables('_parsercontentProductId28')]",
                "version": "[variables('parserObject28').parserVersion28]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
            "apiVersion": "2022-10-01",
            "name": "[variables('parserObject28')._parserName28]",
            "location": "[parameters('workspace-location')]",
            "properties": {
                "eTag": "*",
                "displayName": "SAPUsersAssignments",
                "category": "SAPFunctions",
                "functionAlias": "SAPUsersAssignments",
                "query": "let UserMDTimeAgo = totimespan(toscalar(SAPGetParameters('UserMDLookBack')| project-keep ValueLow));\n// only show users which are not locked for over 180 days (for performance considerations)\nlet agoLocked = format_datetime(ago(180d), 'yyyyMMdd');\n// let SelectedSystemRoles =  dynamic([\"All System Roles\"]); //can also do// let SelectedSystemRoles =  dynamic([\"Production\", \"UAT\"]);\n// let SelectedSystems = dynamic([\"All Systems\"]); // can also do // let SelectedSystems = dynamic([\"BIP\", \"C4D\"]);\nlet Systems= SAPSystems(SelectedSystemRoles= SelectedSystemRoles, SelectedSystems=SelectedSystems)\n    | project SystemID= SearchKey, SystemRole, SystemUsage\n    | extend SystemRole= replace_string(SystemRole, 'Unknown (Production)', 'Unknown');\n// get assignments from change documents\nlet UserMDUpdates= SAP_AGR_USERS | where TimeGenerated > ago(UserMDTimeAgo)\n| where SystemID in (Systems)\n| summarize LastSynched= max(TimeGenerated) by SystemID, ClientID=MANDT;\nlet RoleAssignments =SAPChangeDocsLog\n| where TimeGenerated > ago(UserMDTimeAgo)\n| where SystemID in (Systems)\n| where UpdatedOn_t > ago(UserMDTimeAgo)\n| where (ObjectClass == \"PFCG\" and TableName == \"AGR_USERS\")\n| extend UserAssigned = trim_end(@\"[^\\w]+\" ,extract(@\"^.{1,33}\\s*?(.{1,12})\\s*?\\d{16}\", 1, ChangedTableKey))\n| project-rename Role=ObjectID, ChangedOn= UpdatedOn_t;\nlet ProfileAssignments =SAPChangeDocsLog\n| where TimeGenerated > ago(UserMDTimeAgo)\n| where SystemID in (Systems)\n| where UpdatedOn_t > ago(UserMDTimeAgo)\n| where (ObjectClass == \"IDENTITY\" and TableName == \"SUSR_UST04\")\n| extend UserAssigned = ObjectID\n| project-rename ChangedOn= UpdatedOn_t;\nlet UserRecordChanges= SAPAuditLog\n| where TimeGenerated> ago(UserMDTimeAgo + 1h)\n| where SystemID in (Systems)\n| where MessageID == \"AUB\" or MessageID == \"AUD\"\n| where ingestion_time() > ago(UserMDTimeAgo)\n| project-rename ChangedOn= UpdatedOn_t\n| summarize by ChangedOn, TerminalIPv6, User, Host, Email, Variable1;\nlet Assignments= UserRecordChanges\n| join kind=inner (RoleAssignments | union ProfileAssignments) on User, ChangedOn\n| extend Profile= iff(TableName == \"SUSR_UST04\", ChangedTableKey, \"\")\n| summarize LastChangedOn=arg_max(ChangedOn, *)\nby UserAssigned, Role, Profile, SystemID, ClientID\n| lookup UserMDUpdates on SystemID, ClientID\n| where LastChangedOn > LastSynched // drop the updates that are already included in user MD synch\n| summarize AddedProfiles=make_set_if(Profile,isnotempty(Profile) and TypeofChange_Item in(dynamic([\"I\", \"U\", \"J\"])))\n, RemovedProfiles=make_set_if(Profile,isnotempty(Profile) and TypeofChange_Item in(dynamic([\"E\", \"D\"])))\n, AddedRoles=make_set_if(Role,isnotempty(Role) and TypeofChange_Item in(dynamic([\"I\", \"U\", \"J\"])))\n, RemovedRoles=make_set_if(Role,isnotempty(Role) and TypeofChange_Item in(dynamic([\"E\", \"D\"])))\nby User= UserAssigned, SystemID, ClientID\n| extend Source= \"ChangeDocs\";\n// get logon Data (Kernel-Side Use)\nSAP_USR02 | where TimeGenerated > ago(UserMDTimeAgo)\n| where SystemID in (Systems)\n| extend Relevant= strcmp( GLTGB, agoLocked) > 0 or GLTGB == \"00000000\"\n| where Relevant\n| summarize any(ERDAT), arg_max(TimeGenerated, CLASS, UFLAG, TZONE, USTYP, TRDAT, LTIME, ERDAT) by BNAME, MANDT, SystemID\n// get profiles\n| join kind=leftouter (SAP_UST04| where TimeGenerated > ago(UserMDTimeAgo) | where SystemID in (Systems) | summarize arg_max(TimeGenerated, *), profiles = make_set(PROFILE, 50) by BNAME, MANDT, SystemID)\non BNAME, MANDT, SystemID\n// get Assignment of roles to users\n| join kind=leftouter hint.strategy=shuffle (SAP_AGR_USERS | where TimeGenerated > ago(UserMDTimeAgo) | where SystemID in (Systems) | summarize arg_max(TimeGenerated, UNAME, AGR_NAME, MANDT, SystemID, COL_FLAG) by UNAME, AGR_NAME, MANDT, SystemID, COL_FLAG\n// get the child roles as well\n| join kind= leftouter   (SAP_AGR_AGRS | where TimeGenerated > ago(UserMDTimeAgo) | where SystemID in (Systems) | summarize arg_max(TimeGenerated, MANDT, AGR_NAME, CHILD_AGR, SystemID) by MANDT, AGR_NAME, CHILD_AGR, SystemID)\non MANDT, SystemID, AGR_NAME\n| summarize DirectRoles = make_set_if(AGR_NAME, COL_FLAG != 'X',  50),// COL_FLAG==X -> indirect\nChildRoles = make_set_if(CHILD_AGR, isnotempty(CHILD_AGR) ,50)\nby UNAME, MANDT, SystemID)\non $left.BNAME == $right.UNAME\n, $left.MANDT == $right.MANDT\n, $left.SystemID == $right.SystemID\n// get User Name/Address Key Assignment\n| join kind=leftouter hint.strategy=shuffle ( (SAP_USR21 | where TimeGenerated > ago(UserMDTimeAgo)\n| summarize arg_max(TimeGenerated, BNAME, ADDRNUMBER, PERSNUMBER) by BNAME, MANDT, SystemID )\n// get E-Mail Addresses\n| join kind= inner hint.strategy=shuffle (SAP_ADR6| where TimeGenerated > ago(UserMDTimeAgo) | summarize arg_max(TimeGenerated, ADDRNUMBER, SMTP_ADDR) by CLIENT, ADDRNUMBER, PERSNUMBER, DATE_FROM, CONSNUMBER, SystemID)\non $left.ADDRNUMBER == $right.ADDRNUMBER\n, $left.MANDT == $right.CLIENT\n, $left.SystemID == $right.SystemID\n, $left.PERSNUMBER == $right.PERSNUMBER\n| summarize\narg_max(TimeGenerated1, SMTP_ADDR, MANDT, SystemID),\narg_max(TimeGenerated, BNAME, MANDT, SystemID)\nby BNAME, MANDT, SystemID)\non $left.BNAME == $right.BNAME\n, $left.MANDT == $right.MANDT\n, $left.SystemID == $right.SystemID\n| extend LastSeen = todatetime(strcat(TRDAT, LTIME))\n| extend CreatedOn = todatetime(ERDAT)\n| project-rename User= BNAME, ClientID = MANDT\n| lookup Assignments on SystemID, User, ClientID\n| extend DirectRoles= set_difference(set_union(DirectRoles, AddedRoles),RemovedRoles)\n| extend ChildRoles= set_difference(ChildRoles,RemovedRoles)\n| extend Profiles= set_difference(set_union(profiles, AddedProfiles), RemovedProfiles)\n| project User, Email = SMTP_ADDR, UserType = USTYP, Timezone = TZONE, LockedStatus = UFLAG, LastSeen, UserGroupAuth = CLASS, Profiles, DirectRoles, ChildRoles, CreatedOn, Client= ClientID, SystemID = SystemID, AddedRoles, RemovedRoles, AddedProfiles, RemovedProfiles, Roles=set_union(DirectRoles, ChildRoles), Source=coalesce(Source,\"UserMD\")\n",
                "functionParameters": "SelectedSystems:dynamic=dynamic([\"All Systems\"]),SelectedSystemRoles:dynamic=dynamic([\"All System Roles\"])",
                "version": 2,
                "tags": [
                    {
                        "name": "description",
                        "value": "SAPUsersAssignments"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
            "apiVersion": "2022-01-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId28'),'/'))))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[variables('_parserId28')]"
            ],
            "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPUsersAssignments')]",
                "contentId": "[variables('parserObject28').parserContentId28]",
                "kind": "Parser",
                "version": "[variables('parserObject28').parserVersion28]",
                "source": {
                    "kind": "Solution",
                    "name": "SAP",
                    "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                    "name": "Microsoft",
                    "email": "[variables('_email')]"
                },
                "support": {
                    "tier": "Microsoft",
                    "name": "Microsoft Corporation",
                    "email": "support@microsoft.com",
                    "link": "https://support.microsoft.com/"
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('parserTemplateSpecName29')]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAPUsersAuthorizations Data Parser with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('parserObject29').parserVersion29]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "name": "[variables('parserObject29')._parserName29]",
                            "apiVersion": "2022-10-01",
                            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "eTag": "*",
                                "displayName": "SAPUsersAuthorizations",
                                "category": "SAPFunctions",
                                "functionAlias": "SAPUsersAuthorizations",
                                "query": "// get the relevant user MD load frequency\nlet UserMDTimeAgo = totimespan(toscalar(SAPGetParameters('UserMDLookBack')| project-keep ValueLow));\n// let SnapshotAge= 0d;// allow to go back in time and see user MD snapshots\n// gather the authorizations per role\nlet Auths= SAP_AGR_1251\n| where TimeGenerated between (ago(UserMDTimeAgo+ SnapshotAge).. ago(SnapshotAge))\n| summarize arg_max(TimeGenerated, OBJECT, FIELD, LOW, HIGH, AUTH) by AGR_NAME, MANDT, COUNTER, SystemID;\nlet AuthsEQs= Auths\n| summarize Lows= make_set_if(LOW, isnotempty(LOW), 1500), Highs=make_set_if(HIGH, isnotempty(HIGH), 1500)\n// , FromAuths= make_set(AUTH,1000)\nby AGR_NAME, MANDT, SystemID, OBJECT, FIELD\n| extend Option= 'EQ'\n| extend EQs= set_union(Lows, Highs)\n| project-away Lows, Highs;\nlet AuthsBTs= Auths | where not(isempty(HIGH))\n| summarize\n// FromAuths= make_set(AUTH,1000)\nby AGR_NAME, MANDT, SystemID, OBJECT, FIELD, LOW, HIGH\n| extend Option= 'BT';\n// get the user role assignments, including child roles\nlet UserRoles= (SAP_AGR_USERS\n| where TimeGenerated > ago (7d)\n| summarize\narg_max(TimeGenerated, UNAME, AGR_NAME, MANDT, SystemID)\nby UNAME, AGR_NAME, MANDT, SystemID\n// get the child roles as well\n| join kind= leftouter   (SAP_AGR_AGRS\n| where TimeGenerated > ago(UserMDTimeAgo)\n| summarize arg_max(TimeGenerated, *) by AGR_NAME, CHILD_AGR, MANDT,SystemID)\non MANDT, SystemID, AGR_NAME\n// Role is the lowest level\n| extend Role = iff(isempty(CHILD_AGR), AGR_NAME, CHILD_AGR)\n| summarize by UNAME, MANDT, SystemID, Role);\n// query\nUserRoles | join kind= inner (AuthsEQs | union AuthsBTs | project-rename Role= AGR_NAME) on SystemID, MANDT, Role\n|summarize Roles=make_set(Role,100), EQs=make_set(EQs, 100) by ClientID = MANDT, SystemID, User=UNAME, Object=OBJECT, Field= FIELD, Option, Low= LOW, High= HIGH\n",
                                "functionParameters": "SnapshotAge:timespan=0d",
                                "version": 2,
                                "tags": [
                                    {
                                        "name": "description",
                                        "value": "SAPUsersAuthorizations"
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId29'),'/'))))]",
                            "dependsOn": [
                                "[variables('_parserId29')]"
                            ],
                            "properties": {
                                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPUsersAuthorizations')]",
                                "contentId": "[variables('parserObject29').parserContentId29]",
                                "kind": "Parser",
                                "version": "[variables('parserObject29').parserVersion29]",
                                "source": {
                                    "name": "SAP",
                                    "kind": "Solution",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('parserObject29').parserContentId29]",
                "contentKind": "Parser",
                "displayName": "SAPUsersAuthorizations",
                "contentProductId": "[variables('_parsercontentProductId29')]",
                "id": "[variables('_parsercontentProductId29')]",
                "version": "[variables('parserObject29').parserVersion29]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
            "apiVersion": "2022-10-01",
            "name": "[variables('parserObject29')._parserName29]",
            "location": "[parameters('workspace-location')]",
            "properties": {
                "eTag": "*",
                "displayName": "SAPUsersAuthorizations",
                "category": "SAPFunctions",
                "functionAlias": "SAPUsersAuthorizations",
                "query": "// get the relevant user MD load frequency\nlet UserMDTimeAgo = totimespan(toscalar(SAPGetParameters('UserMDLookBack')| project-keep ValueLow));\n// let SnapshotAge= 0d;// allow to go back in time and see user MD snapshots\n// gather the authorizations per role\nlet Auths= SAP_AGR_1251\n| where TimeGenerated between (ago(UserMDTimeAgo+ SnapshotAge).. ago(SnapshotAge))\n| summarize arg_max(TimeGenerated, OBJECT, FIELD, LOW, HIGH, AUTH) by AGR_NAME, MANDT, COUNTER, SystemID;\nlet AuthsEQs= Auths\n| summarize Lows= make_set_if(LOW, isnotempty(LOW), 1500), Highs=make_set_if(HIGH, isnotempty(HIGH), 1500)\n// , FromAuths= make_set(AUTH,1000)\nby AGR_NAME, MANDT, SystemID, OBJECT, FIELD\n| extend Option= 'EQ'\n| extend EQs= set_union(Lows, Highs)\n| project-away Lows, Highs;\nlet AuthsBTs= Auths | where not(isempty(HIGH))\n| summarize\n// FromAuths= make_set(AUTH,1000)\nby AGR_NAME, MANDT, SystemID, OBJECT, FIELD, LOW, HIGH\n| extend Option= 'BT';\n// get the user role assignments, including child roles\nlet UserRoles= (SAP_AGR_USERS\n| where TimeGenerated > ago (7d)\n| summarize\narg_max(TimeGenerated, UNAME, AGR_NAME, MANDT, SystemID)\nby UNAME, AGR_NAME, MANDT, SystemID\n// get the child roles as well\n| join kind= leftouter   (SAP_AGR_AGRS\n| where TimeGenerated > ago(UserMDTimeAgo)\n| summarize arg_max(TimeGenerated, *) by AGR_NAME, CHILD_AGR, MANDT,SystemID)\non MANDT, SystemID, AGR_NAME\n// Role is the lowest level\n| extend Role = iff(isempty(CHILD_AGR), AGR_NAME, CHILD_AGR)\n| summarize by UNAME, MANDT, SystemID, Role);\n// query\nUserRoles | join kind= inner (AuthsEQs | union AuthsBTs | project-rename Role= AGR_NAME) on SystemID, MANDT, Role\n|summarize Roles=make_set(Role,100), EQs=make_set(EQs, 100) by ClientID = MANDT, SystemID, User=UNAME, Object=OBJECT, Field= FIELD, Option, Low= LOW, High= HIGH\n",
                "functionParameters": "SnapshotAge:timespan=0d",
                "version": 2,
                "tags": [
                    {
                        "name": "description",
                        "value": "SAPUsersAuthorizations"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
            "apiVersion": "2022-01-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId29'),'/'))))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[variables('_parserId29')]"
            ],
            "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPUsersAuthorizations')]",
                "contentId": "[variables('parserObject29').parserContentId29]",
                "kind": "Parser",
                "version": "[variables('parserObject29').parserVersion29]",
                "source": {
                    "kind": "Solution",
                    "name": "SAP",
                    "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                    "name": "Microsoft",
                    "email": "[variables('_email')]"
                },
                "support": {
                    "tier": "Microsoft",
                    "name": "Microsoft Corporation",
                    "email": "support@microsoft.com",
                    "link": "https://support.microsoft.com/"
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('parserTemplateSpecName30')]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAPUsersEmail Data Parser with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('parserObject30').parserVersion30]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "name": "[variables('parserObject30')._parserName30]",
                            "apiVersion": "2022-10-01",
                            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "eTag": "*",
                                "displayName": "SAPUsersEmail",
                                "category": "SAPFunctions",
                                "functionAlias": "SAPUsersEmail",
                                "query": "let UserMDLookBack = totimespan(toscalar(SAPGetParameters('UserMDLookBack')| project-keep ValueLow));\n// older agents have to use USR21 to get the ADDRNUMBER, PERSNUMBER before getting the email address from ADR6\nlet AgentEmailsV1= SAP_USR21 | where TimeGenerated > ago(UserMDLookBack)\n| summarize arg_max(TimeGenerated, ADDRNUMBER, PERSNUMBER) by BNAME, MANDT, SystemID\n| project-rename CLIENT= MANDT\n| join kind= leftouter hint.strategy=shuffle\n(SAP_ADR6 | where TimeGenerated > ago(UserMDLookBack)\n| summarize arg_max(TimeGenerated, CONSNUMBER ) by CLIENT, DATE_FROM, ADDRNUMBER, PERSNUMBER, SystemID, SMTP_ADDR)\n on ADDRNUMBER, PERSNUMBER, SystemID, CLIENT\n| project SystemID, ClientID= CLIENT, User= BNAME, Email= iff(isempty(SMTP_ADDR), BNAME, SMTP_ADDR)\n| summarize Email= anyif(Email, isnotempty(Email) ) by ClientID, SystemID, User;\n\n// agents from version 60075287 have the join of USR21 and ADR6 performed\nlet AgentEmailsV2= SAP_ADR6 | where TimeGenerated > ago(UserMDLookBack)\n| summarize arg_max(TimeGenerated, SMTP_ADDR) by BNAME, ClientID= CLIENT, SystemID\n| project SystemID, ClientID, User= BNAME, Email= iff(isempty(SMTP_ADDR), BNAME, SMTP_ADDR)\n| summarize Email= anyif(Email, isnotempty(Email) ) by ClientID, SystemID, User;\n\nAgentEmailsV1 | union AgentEmailsV2\n",
                                "functionParameters": "",
                                "version": 2,
                                "tags": [
                                    {
                                        "name": "description",
                                        "value": "SAPUsersEmail"
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId30'),'/'))))]",
                            "dependsOn": [
                                "[variables('_parserId30')]"
                            ],
                            "properties": {
                                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPUsersEmail')]",
                                "contentId": "[variables('parserObject30').parserContentId30]",
                                "kind": "Parser",
                                "version": "[variables('parserObject30').parserVersion30]",
                                "source": {
                                    "name": "SAP",
                                    "kind": "Solution",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('parserObject30').parserContentId30]",
                "contentKind": "Parser",
                "displayName": "SAPUsersEmail",
                "contentProductId": "[variables('_parsercontentProductId30')]",
                "id": "[variables('_parsercontentProductId30')]",
                "version": "[variables('parserObject30').parserVersion30]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
            "apiVersion": "2022-10-01",
            "name": "[variables('parserObject30')._parserName30]",
            "location": "[parameters('workspace-location')]",
            "properties": {
                "eTag": "*",
                "displayName": "SAPUsersEmail",
                "category": "SAPFunctions",
                "functionAlias": "SAPUsersEmail",
                "query": "let UserMDLookBack = totimespan(toscalar(SAPGetParameters('UserMDLookBack')| project-keep ValueLow));\n// older agents have to use USR21 to get the ADDRNUMBER, PERSNUMBER before getting the email address from ADR6\nlet AgentEmailsV1= SAP_USR21 | where TimeGenerated > ago(UserMDLookBack)\n| summarize arg_max(TimeGenerated, ADDRNUMBER, PERSNUMBER) by BNAME, MANDT, SystemID\n| project-rename CLIENT= MANDT\n| join kind= leftouter hint.strategy=shuffle\n(SAP_ADR6 | where TimeGenerated > ago(UserMDLookBack)\n| summarize arg_max(TimeGenerated, CONSNUMBER ) by CLIENT, DATE_FROM, ADDRNUMBER, PERSNUMBER, SystemID, SMTP_ADDR)\n on ADDRNUMBER, PERSNUMBER, SystemID, CLIENT\n| project SystemID, ClientID= CLIENT, User= BNAME, Email= iff(isempty(SMTP_ADDR), BNAME, SMTP_ADDR)\n| summarize Email= anyif(Email, isnotempty(Email) ) by ClientID, SystemID, User;\n\n// agents from version 60075287 have the join of USR21 and ADR6 performed\nlet AgentEmailsV2= SAP_ADR6 | where TimeGenerated > ago(UserMDLookBack)\n| summarize arg_max(TimeGenerated, SMTP_ADDR) by BNAME, ClientID= CLIENT, SystemID\n| project SystemID, ClientID, User= BNAME, Email= iff(isempty(SMTP_ADDR), BNAME, SMTP_ADDR)\n| summarize Email= anyif(Email, isnotempty(Email) ) by ClientID, SystemID, User;\n\nAgentEmailsV1 | union AgentEmailsV2\n",
                "functionParameters": "",
                "version": 2,
                "tags": [
                    {
                        "name": "description",
                        "value": "SAPUsersEmail"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
            "apiVersion": "2022-01-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId30'),'/'))))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[variables('_parserId30')]"
            ],
            "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPUsersEmail')]",
                "contentId": "[variables('parserObject30').parserContentId30]",
                "kind": "Parser",
                "version": "[variables('parserObject30').parserVersion30]",
                "source": {
                    "kind": "Solution",
                    "name": "SAP",
                    "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                    "name": "Microsoft",
                    "email": "[variables('_email')]"
                },
                "support": {
                    "tier": "Microsoft",
                    "name": "Microsoft Corporation",
                    "email": "support@microsoft.com",
                    "link": "https://support.microsoft.com/"
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('parserTemplateSpecName31')]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAPUsersGetPrivileged Data Parser with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('parserObject31').parserVersion31]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "name": "[variables('parserObject31')._parserName31]",
                            "apiVersion": "2022-10-01",
                            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "eTag": "*",
                                "displayName": "SAPUsersGetPrivileged",
                                "category": "SAPFunctions",
                                "functionAlias": "SAPUsersGetPrivileged",
                                "query": "// this function returns privilileged user by default but can also return sensitive users\n// let IncludeSensitiveUsers= false;// can also do IncludeSensitive= true which will include users with sensitive profiles\n// privileged users are users which are directly named as such\nlet PrivelegedUsers = _GetWatchlist('SAP - Privileged Users');\nlet FixedUsers = datatable(User: string, Client: string, SystemID: string) [\"DDIC\", \"XXX\",\"001\"];\n// privileged users can also be such that carry a privileged role\nlet fixedRoles = datatable(Role: string) ['SAP_BC_BASIS_ADMIN', 'SAP_BC_AUTH_PROFILE_ADMIN'];\n// privileged users can also be such that carry a privileged profile\nlet fixedProfiles = datatable(Profile: string) [\"SAP_ALL\", \"SAP_NEW\"];\nlet AuditTimeAgo = totimespan(toscalar(SAPGetParameters('UserMDLookBack')| project-keep ValueLow));\nlet availableSystems= SAPAuditLog\n| where TimeGenerated > ago(AuditTimeAgo)\n| summarize by SystemID, Client= ClientID\n| extend dummy ='';\n// get the user assignments to roles and profiles\nlet UserAssignments= materialize(SAPUsersAssignments() | project User, ChildRoles, DirectRoles, Profiles, Client, SystemID);\n// privileged users\nlet PrivUsersByMD = UserAssignments\n| mv-expand ChildRoles, DirectRoles, Profiles\n| where DirectRoles in (fixedRoles) or ChildRoles in (fixedRoles) or Profiles in (fixedProfiles)\n| summarize by User, Client, SystemID\n| extend IsPrivileged= true;\n\n// cross join watchlist users with available systems and clients\nlet FixedUPriv = ((PrivelegedUsers\n    | union isfuzzy=true  FixedUsers\n    | summarize by User\n    | extend dummy = '')\n    | join kind= fullouter availableSystems\n        on $left.dummy == $right.dummy)\n    | extend IsPrivileged= true;\n\nFixedUPriv\n| union isfuzzy=true PrivUsersByMD, FixedUsers\n| where Client != \"XXX\"\n| summarize by User, Client, SystemID\n",
                                "functionParameters": "",
                                "version": 2,
                                "tags": [
                                    {
                                        "name": "description",
                                        "value": "SAPUsersGetPrivileged"
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId31'),'/'))))]",
                            "dependsOn": [
                                "[variables('_parserId31')]"
                            ],
                            "properties": {
                                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPUsersGetPrivileged')]",
                                "contentId": "[variables('parserObject31').parserContentId31]",
                                "kind": "Parser",
                                "version": "[variables('parserObject31').parserVersion31]",
                                "source": {
                                    "name": "SAP",
                                    "kind": "Solution",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('parserObject31').parserContentId31]",
                "contentKind": "Parser",
                "displayName": "SAPUsersGetPrivileged",
                "contentProductId": "[variables('_parsercontentProductId31')]",
                "id": "[variables('_parsercontentProductId31')]",
                "version": "[variables('parserObject31').parserVersion31]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
            "apiVersion": "2022-10-01",
            "name": "[variables('parserObject31')._parserName31]",
            "location": "[parameters('workspace-location')]",
            "properties": {
                "eTag": "*",
                "displayName": "SAPUsersGetPrivileged",
                "category": "SAPFunctions",
                "functionAlias": "SAPUsersGetPrivileged",
                "query": "// this function returns privilileged user by default but can also return sensitive users\n// let IncludeSensitiveUsers= false;// can also do IncludeSensitive= true which will include users with sensitive profiles\n// privileged users are users which are directly named as such\nlet PrivelegedUsers = _GetWatchlist('SAP - Privileged Users');\nlet FixedUsers = datatable(User: string, Client: string, SystemID: string) [\"DDIC\", \"XXX\",\"001\"];\n// privileged users can also be such that carry a privileged role\nlet fixedRoles = datatable(Role: string) ['SAP_BC_BASIS_ADMIN', 'SAP_BC_AUTH_PROFILE_ADMIN'];\n// privileged users can also be such that carry a privileged profile\nlet fixedProfiles = datatable(Profile: string) [\"SAP_ALL\", \"SAP_NEW\"];\nlet AuditTimeAgo = totimespan(toscalar(SAPGetParameters('UserMDLookBack')| project-keep ValueLow));\nlet availableSystems= SAPAuditLog\n| where TimeGenerated > ago(AuditTimeAgo)\n| summarize by SystemID, Client= ClientID\n| extend dummy ='';\n// get the user assignments to roles and profiles\nlet UserAssignments= materialize(SAPUsersAssignments() | project User, ChildRoles, DirectRoles, Profiles, Client, SystemID);\n// privileged users\nlet PrivUsersByMD = UserAssignments\n| mv-expand ChildRoles, DirectRoles, Profiles\n| where DirectRoles in (fixedRoles) or ChildRoles in (fixedRoles) or Profiles in (fixedProfiles)\n| summarize by User, Client, SystemID\n| extend IsPrivileged= true;\n\n// cross join watchlist users with available systems and clients\nlet FixedUPriv = ((PrivelegedUsers\n    | union isfuzzy=true  FixedUsers\n    | summarize by User\n    | extend dummy = '')\n    | join kind= fullouter availableSystems\n        on $left.dummy == $right.dummy)\n    | extend IsPrivileged= true;\n\nFixedUPriv\n| union isfuzzy=true PrivUsersByMD, FixedUsers\n| where Client != \"XXX\"\n| summarize by User, Client, SystemID\n",
                "functionParameters": "",
                "version": 2,
                "tags": [
                    {
                        "name": "description",
                        "value": "SAPUsersGetPrivileged"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
            "apiVersion": "2022-01-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId31'),'/'))))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[variables('_parserId31')]"
            ],
            "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPUsersGetPrivileged')]",
                "contentId": "[variables('parserObject31').parserContentId31]",
                "kind": "Parser",
                "version": "[variables('parserObject31').parserVersion31]",
                "source": {
                    "kind": "Solution",
                    "name": "SAP",
                    "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                    "name": "Microsoft",
                    "email": "[variables('_email')]"
                },
                "support": {
                    "tier": "Microsoft",
                    "name": "Microsoft Corporation",
                    "email": "support@microsoft.com",
                    "link": "https://support.microsoft.com/"
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('parserTemplateSpecName32')]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAPUsersGetSensitive Data Parser with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('parserObject32').parserVersion32]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "name": "[variables('parserObject32')._parserName32]",
                            "apiVersion": "2022-10-01",
                            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "eTag": "*",
                                "displayName": "SAPUsersGetSensitive",
                                "category": "SAPFunctions",
                                "functionAlias": "SAPUsersGetSensitive",
                                "query": "// this function returns privilileged and sensitive users\n// privileged users are users which are directly named as such\nlet PrivelegedUsers = _GetWatchlist('SAP - Privileged Users');\nlet FixedUsers = datatable(User: string, Client: string, SystemID: string) [\"DDIC\", \"XXX\",\"001\"];\n// privileged users can also be such that carry a privileged role\nlet fixedRoles = datatable(Role: string) ['SAP_BC_BASIS_ADMIN', 'SAP_BC_AUTH_PROFILE_ADMIN'];\n// privileged users can also be such that carry a privileged profile\nlet fixedProfiles = datatable(Profile: string) [\"SAP_ALL\", \"SAP_NEW\"];\n// sensitive users are such that hold a sensitive role:\nlet SensRoles = _GetWatchlist('SAP - Sensitive Roles') | summarize by SearchKey;\n// or a sensitive profile:\nlet SensProfiles = _GetWatchlist('SAP - Sensitive Profiles') | summarize by SearchKey;\n// get SAP systems which are relevant\nlet AuditTimeAgo = totimespan(toscalar(SAPGetParameters('UserMDLookBack')| project-keep ValueLow));\nlet availableSystems= SAPAuditLog\n| where TimeGenerated > ago(AuditTimeAgo)\n| summarize by SystemID, Client= ClientID\n| extend dummy ='';\n// get the user assignments to roles and profiles\nlet UserAssignments= materialize(SAPUsersAssignments() | project User, ChildRoles, DirectRoles, Profiles, Client, SystemID);\n// privileged users\nlet PrivUsersByMD = UserAssignments\n| mv-expand ChildRoles, DirectRoles, Profiles\n| where DirectRoles in (fixedRoles) or ChildRoles in (fixedRoles) or Profiles in (fixedProfiles)\n| summarize by User, Client, SystemID\n| extend IsPrivileged= true;\n// sensitive users\nlet SensitiveUsersByMD = UserAssignments\n| project User, ChildRoles, DirectRoles, Profiles, Client, SystemID\n| mv-expand ChildRoles, DirectRoles, Profiles\n| where DirectRoles in (SensRoles) or ChildRoles in (SensRoles) or Profiles in (SensProfiles)\n| summarize by User, Client, SystemID\n| extend IsPrivileged= false;\n// cross join watchlist users with available systems and clients\nlet FixedUPriv = ((PrivelegedUsers\n    | union isfuzzy=true  FixedUsers\n    | summarize by User\n    | extend dummy = '')\n    | join kind= fullouter availableSystems\n        on $left.dummy == $right.dummy)\n    | extend IsPrivileged= true;\nFixedUPriv\n| union isfuzzy=true PrivUsersByMD, SensitiveUsersByMD, FixedUsers\n| where Client != \"XXX\"\n| summarize IsPrivileged= max(IsPrivileged) by User, Client, SystemID\n",
                                "functionParameters": "",
                                "version": 2,
                                "tags": [
                                    {
                                        "name": "description",
                                        "value": "SAPUsersGetSensitive"
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId32'),'/'))))]",
                            "dependsOn": [
                                "[variables('_parserId32')]"
                            ],
                            "properties": {
                                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPUsersGetSensitive')]",
                                "contentId": "[variables('parserObject32').parserContentId32]",
                                "kind": "Parser",
                                "version": "[variables('parserObject32').parserVersion32]",
                                "source": {
                                    "name": "SAP",
                                    "kind": "Solution",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('parserObject32').parserContentId32]",
                "contentKind": "Parser",
                "displayName": "SAPUsersGetSensitive",
                "contentProductId": "[variables('_parsercontentProductId32')]",
                "id": "[variables('_parsercontentProductId32')]",
                "version": "[variables('parserObject32').parserVersion32]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
            "apiVersion": "2022-10-01",
            "name": "[variables('parserObject32')._parserName32]",
            "location": "[parameters('workspace-location')]",
            "properties": {
                "eTag": "*",
                "displayName": "SAPUsersGetSensitive",
                "category": "SAPFunctions",
                "functionAlias": "SAPUsersGetSensitive",
                "query": "// this function returns privilileged and sensitive users\n// privileged users are users which are directly named as such\nlet PrivelegedUsers = _GetWatchlist('SAP - Privileged Users');\nlet FixedUsers = datatable(User: string, Client: string, SystemID: string) [\"DDIC\", \"XXX\",\"001\"];\n// privileged users can also be such that carry a privileged role\nlet fixedRoles = datatable(Role: string) ['SAP_BC_BASIS_ADMIN', 'SAP_BC_AUTH_PROFILE_ADMIN'];\n// privileged users can also be such that carry a privileged profile\nlet fixedProfiles = datatable(Profile: string) [\"SAP_ALL\", \"SAP_NEW\"];\n// sensitive users are such that hold a sensitive role:\nlet SensRoles = _GetWatchlist('SAP - Sensitive Roles') | summarize by SearchKey;\n// or a sensitive profile:\nlet SensProfiles = _GetWatchlist('SAP - Sensitive Profiles') | summarize by SearchKey;\n// get SAP systems which are relevant\nlet AuditTimeAgo = totimespan(toscalar(SAPGetParameters('UserMDLookBack')| project-keep ValueLow));\nlet availableSystems= SAPAuditLog\n| where TimeGenerated > ago(AuditTimeAgo)\n| summarize by SystemID, Client= ClientID\n| extend dummy ='';\n// get the user assignments to roles and profiles\nlet UserAssignments= materialize(SAPUsersAssignments() | project User, ChildRoles, DirectRoles, Profiles, Client, SystemID);\n// privileged users\nlet PrivUsersByMD = UserAssignments\n| mv-expand ChildRoles, DirectRoles, Profiles\n| where DirectRoles in (fixedRoles) or ChildRoles in (fixedRoles) or Profiles in (fixedProfiles)\n| summarize by User, Client, SystemID\n| extend IsPrivileged= true;\n// sensitive users\nlet SensitiveUsersByMD = UserAssignments\n| project User, ChildRoles, DirectRoles, Profiles, Client, SystemID\n| mv-expand ChildRoles, DirectRoles, Profiles\n| where DirectRoles in (SensRoles) or ChildRoles in (SensRoles) or Profiles in (SensProfiles)\n| summarize by User, Client, SystemID\n| extend IsPrivileged= false;\n// cross join watchlist users with available systems and clients\nlet FixedUPriv = ((PrivelegedUsers\n    | union isfuzzy=true  FixedUsers\n    | summarize by User\n    | extend dummy = '')\n    | join kind= fullouter availableSystems\n        on $left.dummy == $right.dummy)\n    | extend IsPrivileged= true;\nFixedUPriv\n| union isfuzzy=true PrivUsersByMD, SensitiveUsersByMD, FixedUsers\n| where Client != \"XXX\"\n| summarize IsPrivileged= max(IsPrivileged) by User, Client, SystemID\n",
                "functionParameters": "",
                "version": 2,
                "tags": [
                    {
                        "name": "description",
                        "value": "SAPUsersGetSensitive"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
            "apiVersion": "2022-01-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId32'),'/'))))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[variables('_parserId32')]"
            ],
            "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPUsersGetSensitive')]",
                "contentId": "[variables('parserObject32').parserContentId32]",
                "kind": "Parser",
                "version": "[variables('parserObject32').parserVersion32]",
                "source": {
                    "kind": "Solution",
                    "name": "SAP",
                    "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                    "name": "Microsoft",
                    "email": "[variables('_email')]"
                },
                "support": {
                    "tier": "Microsoft",
                    "name": "Microsoft Corporation",
                    "email": "support@microsoft.com",
                    "link": "https://support.microsoft.com/"
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('parserTemplateSpecName33')]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAPUsersGetVIP Data Parser with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('parserObject33').parserVersion33]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "name": "[variables('parserObject33')._parserName33]",
                            "apiVersion": "2022-10-01",
                            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "eTag": "*",
                                "displayName": "SAPUsersGetVIP",
                                "category": "SAPFunctions",
                                "functionAlias": "SAPUsersGetVIP",
                                "query": "// function gets tags which can either be SAP roles, SAP Profiles or tags.\n// let SearchForTags= dynamic(['FireFighters', 'ContainsBoth', 'T-Z1220435']);\n// // let SearchForTags= todynamic('All Tags');\n// let SpecialFocusTags = split('SpecialAttention; SoonToLeave', ';');\n// get the SAP roles / SAP profiles that are relevant\nlet SAPUserRolesAndProfiles = SAPUsersAssignments\n| where (tostring(SearchForTags) == 'All Tags' or Profiles has_any (SearchForTags) or ChildRoles has_any (SearchForTags) or DirectRoles has_any (SearchForTags))\n| project-keep User, SystemID, DirectRoles, ChildRoles, Profiles\n| summarize RolesAndProfiles = make_set(array_concat(DirectRoles, ChildRoles, Profiles), 1000) by SAPUser= User\n| extend SearchKey= SAPUser;\nlet UserMDTimeAgo = totimespan(toscalar(SAPGetParameters('UserMDLookBack')| project-keep ValueLow));\nlet WildCards= materialize(_GetWatchlist('SAP_User_Config')\n| where SearchKey startswith '*' or SearchKey endswith '*' and SearchKey != 'SAP*'\n| extend SearchKind= case(SearchKey startswith '*' and SearchKey endswith '*', 'Both', SearchKey startswith '*', 'EndsWith', 'StartsWith')\n| extend SearchTerm= replace_string(SearchKey,'*','')\n| extend DummyJoinField= 1);\nlet UsersFromWildCards= SAP_USR01 | where TimeGenerated > ago(UserMDTimeAgo)\n| distinct SAPUser=BNAME\n| extend DummyJoinField= 1\n| join kind=inner  WildCards on DummyJoinField\n| where SAPUser contains SearchTerm and SearchKind == 'Both' or\nSAPUser startswith SearchTerm and SearchKind == 'StartsWith'\nor SAPUser endswith SearchTerm and SearchKind == 'EndsWith'\n| extend SearchKey= SAPUser;\n_GetWatchlist('SAP_User_Config') | union UsersFromWildCards\n| extend SearchKey= replace_string(SearchKey, ' ','')\n// remove spaces\n| extend Tags = replace_string(Tags, ' ', '')\n| extend TagsArr= split(Tags,';')\n| summarize Tags=make_set(Tags, 100), TagsList= make_set(TagsArr, 200), arg_max(LastUpdatedTimeUTC, SAPUser, ['User AAD Object Id'],\t['User Identifier'],\t['User On-Prem Sid'],\t['User Principal Name']) by SearchKey\n| join kind= fullouter SAPUserRolesAndProfiles on SAPUser\n| extend SAPUser= iff(isnotempty(SAPUser), SAPUser, SAPUser1)\n| extend SearchKey= SAPUser\n| extend TagsList = array_concat(TagsList, RolesAndProfiles)\n| extend TagsIntersect = set_intersect(TagsList, SearchForTags)\n| extend SpecialFocusTagged = iff(array_length(set_intersect(TagsList, SpecialFocusTags)) > 0, true, false)\n| extend IntersectionSize = array_length(TagsIntersect)\n| extend Tags= replace_string(tostring(Tags),',','; ')\n| extend Tags= translate('[]\"','', Tags)\n| where (IntersectionSize > 0 or tostring(SearchForTags) == 'All Tags' or SpecialFocusTagged == true)\n| project-away LastUpdatedTimeUTC, SAPUser1, SearchKey1\n| where SearchKey !startswith '*' and not(SearchKey endswith '*' and SearchKey != 'SAP*')\n",
                                "functionParameters": "SearchForTags:dynamic=dynamic('All Tags'),SpecialFocusTags:dynamic=dynamic([\"Do not return any in-focus users\"])",
                                "version": 2,
                                "tags": [
                                    {
                                        "name": "description",
                                        "value": "SAPUsersGetVIP"
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId33'),'/'))))]",
                            "dependsOn": [
                                "[variables('_parserId33')]"
                            ],
                            "properties": {
                                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPUsersGetVIP')]",
                                "contentId": "[variables('parserObject33').parserContentId33]",
                                "kind": "Parser",
                                "version": "[variables('parserObject33').parserVersion33]",
                                "source": {
                                    "name": "SAP",
                                    "kind": "Solution",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('parserObject33').parserContentId33]",
                "contentKind": "Parser",
                "displayName": "SAPUsersGetVIP",
                "contentProductId": "[variables('_parsercontentProductId33')]",
                "id": "[variables('_parsercontentProductId33')]",
                "version": "[variables('parserObject33').parserVersion33]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
            "apiVersion": "2022-10-01",
            "name": "[variables('parserObject33')._parserName33]",
            "location": "[parameters('workspace-location')]",
            "properties": {
                "eTag": "*",
                "displayName": "SAPUsersGetVIP",
                "category": "SAPFunctions",
                "functionAlias": "SAPUsersGetVIP",
                "query": "// function gets tags which can either be SAP roles, SAP Profiles or tags.\n// let SearchForTags= dynamic(['FireFighters', 'ContainsBoth', 'T-Z1220435']);\n// // let SearchForTags= todynamic('All Tags');\n// let SpecialFocusTags = split('SpecialAttention; SoonToLeave', ';');\n// get the SAP roles / SAP profiles that are relevant\nlet SAPUserRolesAndProfiles = SAPUsersAssignments\n| where (tostring(SearchForTags) == 'All Tags' or Profiles has_any (SearchForTags) or ChildRoles has_any (SearchForTags) or DirectRoles has_any (SearchForTags))\n| project-keep User, SystemID, DirectRoles, ChildRoles, Profiles\n| summarize RolesAndProfiles = make_set(array_concat(DirectRoles, ChildRoles, Profiles), 1000) by SAPUser= User\n| extend SearchKey= SAPUser;\nlet UserMDTimeAgo = totimespan(toscalar(SAPGetParameters('UserMDLookBack')| project-keep ValueLow));\nlet WildCards= materialize(_GetWatchlist('SAP_User_Config')\n| where SearchKey startswith '*' or SearchKey endswith '*' and SearchKey != 'SAP*'\n| extend SearchKind= case(SearchKey startswith '*' and SearchKey endswith '*', 'Both', SearchKey startswith '*', 'EndsWith', 'StartsWith')\n| extend SearchTerm= replace_string(SearchKey,'*','')\n| extend DummyJoinField= 1);\nlet UsersFromWildCards= SAP_USR01 | where TimeGenerated > ago(UserMDTimeAgo)\n| distinct SAPUser=BNAME\n| extend DummyJoinField= 1\n| join kind=inner  WildCards on DummyJoinField\n| where SAPUser contains SearchTerm and SearchKind == 'Both' or\nSAPUser startswith SearchTerm and SearchKind == 'StartsWith'\nor SAPUser endswith SearchTerm and SearchKind == 'EndsWith'\n| extend SearchKey= SAPUser;\n_GetWatchlist('SAP_User_Config') | union UsersFromWildCards\n| extend SearchKey= replace_string(SearchKey, ' ','')\n// remove spaces\n| extend Tags = replace_string(Tags, ' ', '')\n| extend TagsArr= split(Tags,';')\n| summarize Tags=make_set(Tags, 100), TagsList= make_set(TagsArr, 200), arg_max(LastUpdatedTimeUTC, SAPUser, ['User AAD Object Id'],\t['User Identifier'],\t['User On-Prem Sid'],\t['User Principal Name']) by SearchKey\n| join kind= fullouter SAPUserRolesAndProfiles on SAPUser\n| extend SAPUser= iff(isnotempty(SAPUser), SAPUser, SAPUser1)\n| extend SearchKey= SAPUser\n| extend TagsList = array_concat(TagsList, RolesAndProfiles)\n| extend TagsIntersect = set_intersect(TagsList, SearchForTags)\n| extend SpecialFocusTagged = iff(array_length(set_intersect(TagsList, SpecialFocusTags)) > 0, true, false)\n| extend IntersectionSize = array_length(TagsIntersect)\n| extend Tags= replace_string(tostring(Tags),',','; ')\n| extend Tags= translate('[]\"','', Tags)\n| where (IntersectionSize > 0 or tostring(SearchForTags) == 'All Tags' or SpecialFocusTagged == true)\n| project-away LastUpdatedTimeUTC, SAPUser1, SearchKey1\n| where SearchKey !startswith '*' and not(SearchKey endswith '*' and SearchKey != 'SAP*')\n",
                "functionParameters": "SearchForTags:dynamic=dynamic('All Tags'),SpecialFocusTags:dynamic=dynamic([\"Do not return any in-focus users\"])",
                "version": 2,
                "tags": [
                    {
                        "name": "description",
                        "value": "SAPUsersGetVIP"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
            "apiVersion": "2022-01-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId33'),'/'))))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[variables('_parserId33')]"
            ],
            "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPUsersGetVIP')]",
                "contentId": "[variables('parserObject33').parserContentId33]",
                "kind": "Parser",
                "version": "[variables('parserObject33').parserVersion33]",
                "source": {
                    "kind": "Solution",
                    "name": "SAP",
                    "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                    "name": "Microsoft",
                    "email": "[variables('_email')]"
                },
                "support": {
                    "tier": "Microsoft",
                    "name": "Microsoft Corporation",
                    "email": "support@microsoft.com",
                    "link": "https://support.microsoft.com/"
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('parserTemplateSpecName34')]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAPUsersHeader Data Parser with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('parserObject34').parserVersion34]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "name": "[variables('parserObject34')._parserName34]",
                            "apiVersion": "2022-10-01",
                            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "eTag": "*",
                                "displayName": "SAPUsersHeader",
                                "category": "SAPFunctions",
                                "functionAlias": "SAPUsersHeader",
                                "query": "// // optional parameters can look like this\n// let SelectedSystems =  dynamic([\"All Systems\"]);\n// let SelectedSystemRoles =  dynamic([\"All System Roles\"]);\n// let SelectedUsers = dynamic([\"All Users\"]);\n// let SelectedUser = \"All Users\";\n// let AccountNames= dynamic([\"sapvictim\", \"TestUser1\"]);\n// // let AccountNames= dynamic([\"All account names\"]);\n// // let SelectedSystems =  dynamic([\"S4P\", \"B4X\", \"ODT\"]);\n// // let SelectedSystemRoles =  dynamic([\"Production\", \"UAT\"]);\n// // let SelectedUsers = dynamic([\"DEVELOPER\",\"DDIC\"]);\n// // let SelectedUser = \"DDIC\";\nlet UserMDLookBack = totimespan(toscalar(SAPGetParameters('UserMDLookBack')| project-keep ValueLow));\nlet UserHeaderAuditLookBack = totimespan(toscalar(SAPGetParameters('UserHeaderAuditLookBack')| project-keep ValueLow));\nlet Now = now();\nlet Statuses= dynamic({\"0\": \"Not Locked\", \"32\": \"Locked Globally By Administrator\", \"64\": \"Locked Locally By Administrator\", \"128\":\t\"Locked Due To Incorrect Logons (Limited Term)\"});\nlet UserTypes = dynamic({\"A\": \"Dialog\", \"B\": \"System\", \"C\": \"Communications Data\", \"L\": \"Reference (Logon not possible)\", \"S\": \"Service\"});\nlet Systems = materialize (SAPSystems(SelectedSystemRoles= SelectedSystemRoles, SelectedSystems=SelectedSystems)\n    | project-keep SystemID, SystemRole, SystemUsage);\nlet AuditEvents= materialize(SAPAuditLog()\n| where TimeGenerated > ago(UserHeaderAuditLookBack)\n| where Email has_any(AccountNames) or tostring(AccountNames) contains \"All account names\"\n| summarize  TimeGenerated= arg_max(TimeGenerated, User, ClientID, SystemID, TerminalIPv6, Email) by User, ClientID, SystemID, TerminalIPv6, Email\n| lookup kind=inner Systems on SystemID\n| project-rename Client= ClientID);\nlet UserLockUnlockFromAudit= SAPAuditLog\n| where TimeGenerated > ago(UserHeaderAuditLookBack)\n| where MessageID == \"AU9\" or MessageID == \"AUA\"\n// | where Email has_any(AccountNames) or tostring(AccountNames) contains \"All account names\"\n| extend Action= iff(MessageID == \"AUA\", \"unlocked\", \"locked\")\n| summarize ChangedOn= arg_max(UpdatedOn_t, User, Action) by Variable1, SystemID, Client= ClientID\n| project-rename User=Variable1, ActingUser=User\n| extend Details= strcat(\"SAP user \", User, \" was \", Action, \" in system \", SystemID, \" - \", Client, \" by user \", ActingUser);\nlet LastKnownIPs = AuditEvents | where isnotempty(TerminalIPv6)| summarize LastUsedOn= arg_max(TimeGenerated, *) by User, Client, SystemID | project LastKnownIP= TerminalIPv6, User, Client, SystemID;\nlet KnownIPsAndEmails = AuditEvents\n| summarize Count= count() by User, Client, SystemID, TerminalIPv6, Email| order by Count desc\n| summarize KnownEmails= make_set_if(Email,isnotempty( Email), 10), KnownIPs = make_set_if(TerminalIPv6, isnotempty(TerminalIPv6), 10)\nby User, SystemID, Client\n| extend PrimaryEmail = KnownEmails[0], PrimaryIP= KnownIPs[0];\n// query\nSystems | join kind= inner\n// get logon Data (Kernel-Side Use)\n(SAP_USR02 | where TimeGenerated > ago(UserMDLookBack)\n| where (BNAME in (SelectedUsers) or tostring( SelectedUsers) == '[\"All Users\"]') and (BNAME == SelectedUser or SelectedUser == \"All Users\")\n| summarize StatusDateTime= arg_max(TimeGenerated, *) by BNAME, MANDT, SystemID )\non SystemID\n// get User Name/Address Key Assignment\n| join kind=leftouter hint.strategy=shuffle\n(SAP_USR21 | where TimeGenerated > ago(UserMDLookBack) | summarize arg_max(TimeGenerated, *) by BNAME, MANDT, SystemID)\non BNAME, MANDT, SystemID\n| project-rename CLIENT= MANDT\n// get E-Mail Addresses\n| join kind= leftouter hint.strategy=shuffle\n(SAP_ADR6 | where TimeGenerated > ago(UserMDLookBack)\n| summarize LastSynched= arg_max(TimeGenerated, CONSNUMBER ) by CLIENT, DATE_FROM, ADDRNUMBER, PERSNUMBER, SystemID, SMTP_ADDR)\n on ADDRNUMBER, PERSNUMBER, SystemID, CLIENT\n| project-rename User= BNAME, Client= CLIENT\n| lookup KnownIPsAndEmails on User, SystemID, Client\n| lookup LastKnownIPs on User, SystemID, Client\n| extend LastSeen = todatetime(strcat(TRDAT, LTIME))\n| extend LastSeenDaysAgo = datetime_diff('Day', Now, LastSeen)\n| project\nLastSynched=max_of(LastSynched, StatusDateTime),\nUser,\nEmail = SMTP_ADDR,\nUserType = USTYP,\nTimezone = TZONE,\nLockedStatus = UFLAG,\nLastSeen,\nLastSeenDaysAgo,\nPrimaryIP,\nLastKnownIP,\nPrimaryEmail,\nKnownIPs,\nKnownEmails,\nClient,\nSystemID,\nSystemRole,\nSystemUsage\n| lookup UserLockUnlockFromAudit on User, SystemID, Client\n| extend LockedStatus= case(isempty(Action),trim_start(\" \", LockedStatus),Action==\"unlocked\",\"0\",\"64\")\n| extend LockedStatusDescription= tostring(Statuses[LockedStatus])\n| extend UserTypeDescription= tostring(UserTypes[UserType])\n| extend LastSynched= max_of(LastSynched, ChangedOn)\n| where PrimaryEmail has_any(AccountNames) or tostring(AccountNames) contains \"All account names\"\n",
                                "functionParameters": "SelectedSystemRoles:dynamic=dynamic([\"All System Roles\"]),SelectedSystems:dynamic=dynamic([\"All Systems\"]),SelectedUsers:dynamic=dynamic([\"All Users\"]),SelectedUser:string='\"All Users\"',AccountNames:dynamic=dynamic([\"All account names\"])",
                                "version": 2,
                                "tags": [
                                    {
                                        "name": "description",
                                        "value": "SAPUsersHeader"
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId34'),'/'))))]",
                            "dependsOn": [
                                "[variables('_parserId34')]"
                            ],
                            "properties": {
                                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPUsersHeader')]",
                                "contentId": "[variables('parserObject34').parserContentId34]",
                                "kind": "Parser",
                                "version": "[variables('parserObject34').parserVersion34]",
                                "source": {
                                    "name": "SAP",
                                    "kind": "Solution",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('parserObject34').parserContentId34]",
                "contentKind": "Parser",
                "displayName": "SAPUsersHeader",
                "contentProductId": "[variables('_parsercontentProductId34')]",
                "id": "[variables('_parsercontentProductId34')]",
                "version": "[variables('parserObject34').parserVersion34]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
            "apiVersion": "2022-10-01",
            "name": "[variables('parserObject34')._parserName34]",
            "location": "[parameters('workspace-location')]",
            "properties": {
                "eTag": "*",
                "displayName": "SAPUsersHeader",
                "category": "SAPFunctions",
                "functionAlias": "SAPUsersHeader",
                "query": "// // optional parameters can look like this\n// let SelectedSystems =  dynamic([\"All Systems\"]);\n// let SelectedSystemRoles =  dynamic([\"All System Roles\"]);\n// let SelectedUsers = dynamic([\"All Users\"]);\n// let SelectedUser = \"All Users\";\n// let AccountNames= dynamic([\"sapvictim\", \"TestUser1\"]);\n// // let AccountNames= dynamic([\"All account names\"]);\n// // let SelectedSystems =  dynamic([\"S4P\", \"B4X\", \"ODT\"]);\n// // let SelectedSystemRoles =  dynamic([\"Production\", \"UAT\"]);\n// // let SelectedUsers = dynamic([\"DEVELOPER\",\"DDIC\"]);\n// // let SelectedUser = \"DDIC\";\nlet UserMDLookBack = totimespan(toscalar(SAPGetParameters('UserMDLookBack')| project-keep ValueLow));\nlet UserHeaderAuditLookBack = totimespan(toscalar(SAPGetParameters('UserHeaderAuditLookBack')| project-keep ValueLow));\nlet Now = now();\nlet Statuses= dynamic({\"0\": \"Not Locked\", \"32\": \"Locked Globally By Administrator\", \"64\": \"Locked Locally By Administrator\", \"128\":\t\"Locked Due To Incorrect Logons (Limited Term)\"});\nlet UserTypes = dynamic({\"A\": \"Dialog\", \"B\": \"System\", \"C\": \"Communications Data\", \"L\": \"Reference (Logon not possible)\", \"S\": \"Service\"});\nlet Systems = materialize (SAPSystems(SelectedSystemRoles= SelectedSystemRoles, SelectedSystems=SelectedSystems)\n    | project-keep SystemID, SystemRole, SystemUsage);\nlet AuditEvents= materialize(SAPAuditLog()\n| where TimeGenerated > ago(UserHeaderAuditLookBack)\n| where Email has_any(AccountNames) or tostring(AccountNames) contains \"All account names\"\n| summarize  TimeGenerated= arg_max(TimeGenerated, User, ClientID, SystemID, TerminalIPv6, Email) by User, ClientID, SystemID, TerminalIPv6, Email\n| lookup kind=inner Systems on SystemID\n| project-rename Client= ClientID);\nlet UserLockUnlockFromAudit= SAPAuditLog\n| where TimeGenerated > ago(UserHeaderAuditLookBack)\n| where MessageID == \"AU9\" or MessageID == \"AUA\"\n// | where Email has_any(AccountNames) or tostring(AccountNames) contains \"All account names\"\n| extend Action= iff(MessageID == \"AUA\", \"unlocked\", \"locked\")\n| summarize ChangedOn= arg_max(UpdatedOn_t, User, Action) by Variable1, SystemID, Client= ClientID\n| project-rename User=Variable1, ActingUser=User\n| extend Details= strcat(\"SAP user \", User, \" was \", Action, \" in system \", SystemID, \" - \", Client, \" by user \", ActingUser);\nlet LastKnownIPs = AuditEvents | where isnotempty(TerminalIPv6)| summarize LastUsedOn= arg_max(TimeGenerated, *) by User, Client, SystemID | project LastKnownIP= TerminalIPv6, User, Client, SystemID;\nlet KnownIPsAndEmails = AuditEvents\n| summarize Count= count() by User, Client, SystemID, TerminalIPv6, Email| order by Count desc\n| summarize KnownEmails= make_set_if(Email,isnotempty( Email), 10), KnownIPs = make_set_if(TerminalIPv6, isnotempty(TerminalIPv6), 10)\nby User, SystemID, Client\n| extend PrimaryEmail = KnownEmails[0], PrimaryIP= KnownIPs[0];\n// query\nSystems | join kind= inner\n// get logon Data (Kernel-Side Use)\n(SAP_USR02 | where TimeGenerated > ago(UserMDLookBack)\n| where (BNAME in (SelectedUsers) or tostring( SelectedUsers) == '[\"All Users\"]') and (BNAME == SelectedUser or SelectedUser == \"All Users\")\n| summarize StatusDateTime= arg_max(TimeGenerated, *) by BNAME, MANDT, SystemID )\non SystemID\n// get User Name/Address Key Assignment\n| join kind=leftouter hint.strategy=shuffle\n(SAP_USR21 | where TimeGenerated > ago(UserMDLookBack) | summarize arg_max(TimeGenerated, *) by BNAME, MANDT, SystemID)\non BNAME, MANDT, SystemID\n| project-rename CLIENT= MANDT\n// get E-Mail Addresses\n| join kind= leftouter hint.strategy=shuffle\n(SAP_ADR6 | where TimeGenerated > ago(UserMDLookBack)\n| summarize LastSynched= arg_max(TimeGenerated, CONSNUMBER ) by CLIENT, DATE_FROM, ADDRNUMBER, PERSNUMBER, SystemID, SMTP_ADDR)\n on ADDRNUMBER, PERSNUMBER, SystemID, CLIENT\n| project-rename User= BNAME, Client= CLIENT\n| lookup KnownIPsAndEmails on User, SystemID, Client\n| lookup LastKnownIPs on User, SystemID, Client\n| extend LastSeen = todatetime(strcat(TRDAT, LTIME))\n| extend LastSeenDaysAgo = datetime_diff('Day', Now, LastSeen)\n| project\nLastSynched=max_of(LastSynched, StatusDateTime),\nUser,\nEmail = SMTP_ADDR,\nUserType = USTYP,\nTimezone = TZONE,\nLockedStatus = UFLAG,\nLastSeen,\nLastSeenDaysAgo,\nPrimaryIP,\nLastKnownIP,\nPrimaryEmail,\nKnownIPs,\nKnownEmails,\nClient,\nSystemID,\nSystemRole,\nSystemUsage\n| lookup UserLockUnlockFromAudit on User, SystemID, Client\n| extend LockedStatus= case(isempty(Action),trim_start(\" \", LockedStatus),Action==\"unlocked\",\"0\",\"64\")\n| extend LockedStatusDescription= tostring(Statuses[LockedStatus])\n| extend UserTypeDescription= tostring(UserTypes[UserType])\n| extend LastSynched= max_of(LastSynched, ChangedOn)\n| where PrimaryEmail has_any(AccountNames) or tostring(AccountNames) contains \"All account names\"\n",
                "functionParameters": "SelectedSystemRoles:dynamic=dynamic([\"All System Roles\"]),SelectedSystems:dynamic=dynamic([\"All Systems\"]),SelectedUsers:dynamic=dynamic([\"All Users\"]),SelectedUser:string='\"All Users\"',AccountNames:dynamic=dynamic([\"All account names\"])",
                "version": 2,
                "tags": [
                    {
                        "name": "description",
                        "value": "SAPUsersHeader"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
            "apiVersion": "2022-01-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId34'),'/'))))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[variables('_parserId34')]"
            ],
            "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPUsersHeader')]",
                "contentId": "[variables('parserObject34').parserContentId34]",
                "kind": "Parser",
                "version": "[variables('parserObject34').parserVersion34]",
                "source": {
                    "kind": "Solution",
                    "name": "SAP",
                    "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                    "name": "Microsoft",
                    "email": "[variables('_email')]"
                },
                "support": {
                    "tier": "Microsoft",
                    "name": "Microsoft Corporation",
                    "email": "support@microsoft.com",
                    "link": "https://support.microsoft.com/"
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('parserTemplateSpecName35')]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAPWSAlertRuleMetaData Data Parser with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('parserObject35').parserVersion35]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "name": "[variables('parserObject35')._parserName35]",
                            "apiVersion": "2022-10-01",
                            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "eTag": "*",
                                "displayName": "SAPWSAlertRuleMetaData",
                                "category": "SAPWorkspaceManagement",
                                "functionAlias": "SAPWSAlertRuleMetaData",
                                "query": "let ARMetaDataConfig= _GetWatchlist(\"SAPAlertRulesMetadata\");\n//// zip it to save space\n// let PackedConfig= ARMetaDataConfig\n// | project-away SearchKey, LastUpdatedTimeUTC\n// | extend AnalyticsTemplateId=tostring(AnalyticsTemplateId)\n// | extend AllPacked= pack_all()\n// | summarize AllPacked= make_set(AllPacked)\n// | project ZippedPacked= zlib_compress_to_base64_string(tostring(AllPacked));\n// PackedConfig\nlet ZippedInitialConfig= \"eAHtXWtvG1eS/SsNftkMkBvc92O/OfYYMTBJjNiZXSAYLOq+ZCIUKZCUPdrF/vc5t0mJlCy2KIWyKGeAPGyRIrurT1edOvXo3/5v9D+v3r9ZltM3efSfo2CijoUnFrIUTBdnmBc5s6CLDSUnmYiPvh29mNLkYjlOv5xPyk90WvCb71687Vj3YrEYn0xPy3TZzWpH3aJMF+Pl+GPpzuazOp6UrV9evC+nZxNalv6bdZHSV0HMmJSYppiYL1UzU5Q30fIaUvvml7Ppcj6bvL84a1/6dl4+4ruofQNe/PHi5/nJ+h2v6XQ8ucB7XqRUFotu/ePFjbe9edWO/eooX5wvP8zm4//FJ86m3Y+z6XiJv05P8Fs/vXn3fvizr7+p/2SuvuPiO27w0i8lzU5hmVwy3lHHJ+fz/lvaxyw6mpQ5bDadXHTfTGafujrOZTJeXvyl/Sas3H8aXVl3VunKtBvLvvv5v+8++82b9j/397T4fYE39wc+P31VljSeLL5dX+73s/fjMpftffi/WIHhXUnnc5zA+qdy/dOfX47+/9vrmCvCqYB/mLc+Mm0qsSCtZT5KH3g1OmgxhLnv5+fL0r2ezVPpvvnl9cu/7MQY4JtU4IJlGzPTwgcWo6mMorY6p5q5C59hDCdb0hDAts70M2T9VJafZvPfO2qfsHrPH8CRkHfiaDxNQA5uv29OSx6fn94OpNhMVpvFvpnX9JfbobN1Xjcwc8tZPQAh39NivLgbHtFrV6wXLDoR2kWTjIKvTPHgtPS+yiCH4PGq9Ie5QjWc0uVpAe95vOz+NjvZ7ZNMjS5Ww5xXQCZ5x3xwmUVpqzEOx2Lj/fHy8gNNT0p3SlM6Ke1mvg04q4ObzE5OBrxP/x6a5g74mZ3DD8bx5DOQXeEH/+h74OfD+OTD7ejJWxad1cXantSOZtJb8xYw3XbSN1B185Qf1ek4SqVUJVkWUTEdpWGhOssqqSApOROMGkLVX/+Jr7qEFE27n+NiNsGV72bz9tc3094scEvn07T2p/l8KPyZ4rzOhnEtNNNcwh3WZJmp1klJMUeTDuua3kzhAE5Xt8XK//zBIKcOE+TKpWUR46aztVlnc5qO1zata5OeXlr0Xr7r1tN+VKghqNTquWSGq8q0tAYBJzowm8xBs1KQVe4PtW4rYH+P19/OZydzOt0JrMKLUSkGlhXYlHZJsQhsM8pWkgfYqq6HBdavizI/UMDj7vCYuuJNFOns7Mp69wLRzVN8AH5egblOZmdrV3gHhKSz4ME2sdoCoRbwVlEFA28Vk/NJqEplCEI/nk+W47NJ6d6CQiJ0527ljxe7qRIXyUbvmVUS/pEc4m9o3x0TzzmR97E+iI4PIWcdxu4Cz5sWoMZ1nFZ3cR8AwV3bD1c/2oEn8x33ByJQp2uDnq3tma7MeS8c3XLCj+qKApdOqVpZ9MIzrZHZxSoSyzETBRGNznUIRxvf83aOA56Uk5K7/mYAjWp/Hk93IgrESSglBHO60XwuLIscGA6Cc4qcF53jwRGFwxpPD+WMxGGc0VbidmnDc5hw0luwN+C9MPTZKT4eFZclmCwQRqrjhWmVwIejVky5mgsX2tphKv7u7U/lZNa9WC4p/b4TKNmrrG0IzEXwIa2rYF5aYipmZbhwQtKBs7S9UPIHvM5haPfibArr0aXxvjhIGiLuTuYL6KqPlglDiBs2R1w8V8B4UtWyeRg36GF+aKf/cTY5Py2N7pzNls3ANMEdtdGSMi2pK/88m82XJe/EEelcCkDKKrdAa7WVeacMnJ3NJelkiNQTUeofcaNTo279l+2Ejt/H5+wDnfbKyqizumXSK4s2g27Z88gJtc/Fk1SOWSkg4yhvGZWsmEwSimEmJUjuxYbenc1mk+7n8+XZ+XJDswdIkZCKfHbwfxJMPhKH/+OIY2SKkFwrreRXgKi9otglA1o0G856E5ZtCx45hkIMNlYJlZEHpEUSwjNxmRlVQkakvDPGD2Hop/Kpe/PyNRjR/OM4DRBpaVUhawQTPIFyeQJYDSWANdTErTElpgfRnr1kpHcXC5xxd+0i3y1r33j79jfcBir9HT+UMDktn8YJktKVUR8mJd192o9HkgQlZQ0EyuwEIqAGc4mhVDgrR1qIUIpV+3HsDT/sGkHEGf9ecHd2q2SjawF9OgMDmfcv75aWICx5LjhzpGzjU44B+4XlAPFU5RKA/uMm3nr0mMS7NyutjDqerk26tuixMnETFfLzCjcStUR6biXkyyxY8VoZC1ej5T00pd3y5V3qkiVbayiORWEd04EgE0DsYpxnytXKqPS/ZcuVLR8oNX350OiclSbK2EgVEvWkEbEkEnWPYAX10lfD6R70ag9elWtMqKlkZHxQJrUAgILVjokijG/yt+flT8mrnhOj0k4l4wJnRPAH2hs4BfghJgsnpaHxGDeoUa7Q8h7OePZxIJpJl/FFCK8IXq2GGz0j5w2TShgtkNJJ4n8WrPQYWW4sduyc25YMDoSkqaVs2qHGH3iDiS21oJzKq49DCHm1nfZ3dT47BRmCW83nqxLbYsX6zhegeHhlCee7aG/ezYyUDAmKFnMcAVRDFGCeACgZvLYonPAc6OixdHdvyX7Ue1sDaLaljWVXhu3tSttWPXK8IcHjVSLHAyEi1q4oC2SQhKkcOLTEgvrGMBO/2SlwI6NYZSI74VUIX58SJG7oUEybyFlMIrAKub0qFyF468dL/R6ng+A+BZQBKfNGz0Da/ph0adVn0EbASyVOPrHiKMClZUQjn1BsRdE3kg3eBTMEsfftbqKV+xovuvPpZJZ+H9A0lalVJ2RwqB23/rwE3i8LCoE1xYqIGGV4REh9KTXBHiY8LjfGHS+2THtEmsI9uuQirnNE8KzCw5lJZxilAgzIGJ0RVCylIaS92GqCmn/WFLUlZe12Z47r6KCWSThVMC8HYUM1JcsUy5Ur0gk3epxuqGOUsXZ7t63uqPn1XqmNtvUspS2ZDQQGF5gKksPb+dakmQTkcAolikpK5UECdzHFmabuxRT0ArdupEXJW9F1fRrdi3Z3704XNaQOpVAgtA7BVbuIena0qBI2IkmQ2Uz9PF18M4WqM17VN24F4q43rMnL5sVbi4O3v/7Z7x7Aq+WVEWllw96El2H0dGU/ujTfLQjbPpjPCNrmpfti6Nrv3uHIlA4iBMWyTLZxMQnxSFfm8EdhhU7JidFD2qG2Y+nLWd7tyFxwOXIOlYqa3GAgjUIKVfBm0jpVQ1LVjP6ULVFbETOtLPil26L2D4go8ylqgqP2Gc5IqIqrKDXLrchLghdbB3X2G52Z3bIshqrJrtgE0GTI+gmqGJR8pLEOsn6xqDtWgu9xxwsaeRjQXG+9vLLY8YJEllSMRYZPBtRcQ2ZEhm8j40Z7obRLQYYhkKwk/V5qOJ8iO8bVRMSarvrfR7tbnXwRCeW+6kNr12t9Mgq6QpQC2irJAso2eoo5g0ftYdkLQZNm0GbPjTk31jzeIQTFhQ25NdBaB2eTTaMcpFkTp62prmixXwPmu/OI81108aLvm9sJId66hkvx0MBBb7STAokesj1KwltBLlhpvz4I3a/5crGyZbx4SLHui8JHxmC9LlCiKrQCwAcqeRDQsMnpKimilBdHe9WE+9anBX3sey2XMxCgX9993+X56qLfjiXvIGRCjGIpgzRrqzULCdlbdtLYyCNyt+OXzN3oMMLTVsdTb8ZmRTpfxEsTPo2muU9rHTL9bBRcgkRxFdqP7tt4cRmVjvANKtsq9gPRL6gs3dkBHirlqKDRkyvArNMJaj0EhyzIo9jiLIkyeq4DmQci0VdwwseXwR7wZzCHqZCWgcgqllCKaQ3agVGNgTm4iZJ8sjEN1n1flXjei64rrQknM4AucpGQtCtGGhCDkOkYcdMqzUIZYyBy5QOPpbTqUcuWvxyl3m+Wbm002rbZvZzQbSf22AMpYCGl8lSYELyV8kRpjXSKVSuMNMrqWuveSfwG+vtOy+WgeSwFKqStrREztu6EQEyQ0RQsEnyX/0wZ/JUf+mOzcV80NfNJZh+hZVslACHeJnxbr0nCtfMJSrfkg6nZDy9+etG9+v6WCd+VoAg5aDwZSOdNUa3rs9oMBCmdoULFwlp7r642WOSHo2MSsx+jVLcXzHBKIALsupDdK47LtYWfZT1FVpNRu8tMVI0c3WTNIjI8cBxXLQBAUg5q2b9OaR2nQcV/KadgsLulyX39mi+egoGo7aprdWpTUDu2xFBcCYlHr0QSR+vXxIG2XMxrulWcfHLfdr8IqQMIeZXMBJTqdOFg6xoCApFJWhclUDLZj62/p4hct3s1nuMyr9OM7vuL7pfXL5s+Nds9cieNFBX+jEFLaEOcOUGHQu5ZoGRwZYNQ8akmYL4wpjYKd2/M3NuS+mOIFwDcZG3HI+9oMeSBJmR/UbSY2aoovjZhE/JiAh8y3AxT9KYepNlkssq2uw+FJssPXfpQBubxJNXAQwkQDTwEMBEgZHrw9eJ5LaFyXuvDBjef/yIMmHNjzZUxL235dM0r+2gJJGuWtmbmlAX9qSYwn3FNE4Ki09YkVQb5+1Uld58VBDW3MRcU+xJg25ZKIbH00jAkDIasNcEmf+Ru6ED1k8va7cM3DzxBO7h03mslmE0Fha+gepJsmHFcee8yofo/BJXX7992OOZu2tTiDWVqfRBlvlsgiFmBg1XOZCGoXQLiKXHXWjWTlkXLnB9hauWw65okPwxq6vIMBoT9NubbWO94RW8bZXFKyDYoCQbEW/UCAibyvdikphS8GeyN+3G86Dt507UMAeU4VBuuHNAtPZrrHGI3srgJmhRnCKS6SU/EfKAK7+QpCyGyDW50ZD10949wBxprOV1dhGvXAJL5h7J2ZTc7OU+vjP8ss8JsjA2Fw7sJk1tnAVh7W7lSNdQBCBKk4iBr77OMl/MCrC36y4XS1AL14k/DI3oCzC1krhhED/C66KFnQdRnNkulQ5tJlUe+G+Mw5ZlmpLSyHozXbAfTPdUo3j16MykrL6Eg2JRaibi1NGkQdJ6CihBOalZ1PylrdTjdi3yKw79WCBiYMG4dKW1wCvQKqUAK0GLhWsHlVFBtrUuOz3dz5oFagdci1mqBJjXr0k3jPs+iTZAmxJgzS7LtsQsW3FqWhj+nikaG6MvgIOhmUR1o2ppVXI+4O3HnfI3IGTKzos0VU0WBsE07mGKoVmGsojJ6Iob28hFaf/cC2tWSuuXZ2po3jXm8hM2ILJwg0aZkQNg8SitBKwVZXmayUkbu9X6S1bt2gVP3lpDhII+bdz/QYl1wzgOMv6haQ2QytthLqDp7VAEYJVlDjqg+uofh6ahazA+9RGrRm/rs0tIfaJGu7PwMlydEB+k9c5ZFaIplyqu1c9HJ6jgFCnywUWb3/ulWod8JPa4iks1UATiFAA6lFA5UAv6kkOaKKpKkZxtCH3X59NqszzN4GpFybCPLknTbPO0jC9mjJOQV4bL7EMQg2l7S2RK+ns0LoHTRfTyfTMt8nZm1RLW9Cx78vwrBUN1vL//+Vya5BMvnQv9jd1yFu1UWVR+BjLRNwysWIgd5QeGg3RzausPH1b0Vs4f3/4kDySHpmtWvGR3Rl85aP2lv8d/Sx3Ld4E8ite3p+kKQENM11FiPi62daIIX9K8MhSK50FYjDK7ef7nZCrN7T+NO0KlCURMqoSK7diuozDwK84wc6kcBtSKn4rP1gIfaTnS1I2bHJpln6wjbyj6TEP+Qv0Kvy0Ez7yDY++Cri8CllYOthZdqXBPt50iuxotG//aX5KwnroSGI9YxIYtp+kd0KEfA5yVPhIv2efz92ia68rbx9tLT1mYfPdUoFzc1B9QAmbNtwL118gVcMsYztzxW1AeJ9tQ9Ni073dvZZJwu7uxPrUXo0kQyb1st1Om2esgmJuGtsuIQzewDpri+4g6eTc/OWW/hwX7V45dqPZeeIzYxLaF4ocYAdwW1CwUi5JBVa6HTfiMZfQ9FP5Hx5u1OtEHTEEB5ZTm3ioYjBT6Gv4rAeQiuiiieZqRnrxh4uPmdy9mLvmFiES/GZ0ctaVRTuaoW6VxqDVU2Rhazlazk1FaXlUB6z575XV04r8YEW9zRiNPaVRHFMoPTAmCTIBas5yiFUVtAI0URT7Umbf8JjAMpZIOtOLm35jPpxkGEiY2XI+7EXrBCBBKhDWQYm6PhPKdhxo6vQaSfdNe16G6Taa8XjV6nhX+nyfluKcMWy4sDi6NS24w+iucBiixTltqidS2dzH92KSOtDX/d7huzM1Sdrr32cW3yZzrYIa3VqWmqRpa2LwGREoQeohr3xcrQyNrorq6xDxsFt8vn7bA/H/i42O0AoSiL/gEW1BygRa0sKGeZcMnXgLKZjAduAdp33GPNYhot2/Ygb6bLcjLfyc7EXltq9u0h24i2K8veHAq5uK8vfIqREDi9mF2NDLy8NezgP9GhElVV5FVGiFZ6sHqwDqS97+9oiY89W26WvF3bhLsTZjkKqaIpCPcJLE1R270lFIhhQogllVYaygFhdtAi+oEQtYmhazOu17ndLVUcxW5bb0OpNnhwa91Gw1CQomhCv+ehGkAqxsGs8ta85I5VbW1tvC8hM2UESl8kifnU4qdSSleSIYeHdZsdVe1JHQRfq22A6YAr256y4uSq0961PTC8Rci2iSYW0Sa1UYqCKyE/LH31HT+/9svFtjp+Nmu5dwsYTkoUmiSSkVZ50gboCwo4t1IJbowpkIBHf5Kmn9V2tsumn6sN3IvRUff9ZFUpSgnFMnIAKBnPAk+cKeeEsZS4sfogCUAPsk1tcyekwKViMOBVmaf2ZIwMN1ZIsuwcKkpZo6r1b/K/B/lv2KNtcz9T4m8zktBWTUfuB3xGB1m/FpaNU07r9oC3vfa1tUmjVwWy9HS4IwjBOQSU2piD0gKWH9qDWVDI1EhDUcQKxfOnWjTxNI3+8wpVf9tux74x10I6BYNmXDiEJKs8i0bG/mElUNijKsPU6zUIZvdq9gnevNVsutcr+v4jQW8ez84XUFi7FznPV6eyA0RVGEkgfdU3z+p8G00pUFWsyi7biHQxjo5dK7vPUubdkbE91jtfWbNn8aeXphyf0ZUhj3dniWt7bxI55gKV9vSbgovJDcuC1wz9Xgc+uKTtb+NaUKkAqtiqm2LWGqs/lTkK3cBMzyf7VTjr5d+7yVZtSwkoMei+oU2xGJS2AfRIUhhKlIp6RIL//nJp9mL05frI9qtpTy4tzFrrRDNvs+6WccfTK9M+jN1fO/lHlPq9aqo+SpBFIoWrSrHgRGWSXMyoDDknB7d9X9WDmhNbXHmxnYjS0pvsuGO1Nd3qtgTac3xfCYCYkj57r4/eTx34oRXNYS3yxnLHHu5QwBbREcId0KK9cgh3KrOUVYAOEH0dFkZfTsbt/rqX0qCl8cmIzJDvtUYbLlt3F2SyKJFL8BJcfgBsvkKZIfXGTV+JzCCtS468hTuybRFlW/7meRuG05SUhtQQB9d3b1olVrlgPyCy2tS6m0qpSFBloTCoNjmpnSssUA3MKM9jgpss4vCdhAfds6QPNsi2boLoM7t+/iMNDH48urJ+jzaH4AmilEfJuhUZU2iPT1EalWQLPEHdNm5wivLGgwq7H6CxTIZkKW2ogJfBIxWXW1+FZ2CacIoUPMRYBeR8BVLoozyw8MPGts/PQ8WgUtQolghHEAtsKu3Jvbj4AqIkXuTVxbuAtoRq1/h4EwzguafrNRPpj/RJdzuRWpRBwQeFAilaoQCHDLULGgeoXoRf1VVkN3qGjdIH2k4BaK6vB2SIzdX4Stunsy2i2raQO/O+xSa26SFIX1WGCEk04d8h+L7FDbZstezBp06PBp5JIEROhnGVQitaoeioSmFw1UpHLYsN4SvIBvbB3dnakrsfNX38mQFpaJW2BNYWKEFIr/Aq7Yk7JiorlC8li8HldBvtt9G1/1h0byEnf5rN82WbfnMHrTN6vFtN1ahhq4hyJHENyohUhUXR1r/mmoBsobLXo6+mPjQUZK/A09eEztamXGUDLeS2Yx4dV6XoH/8CRxc5UA==\";\nlet ExtractedInitialConfig= todynamic(zlib_decompress_from_base64_string(ZippedInitialConfig));\n// priority 2 is coming from this function to be used as fall back in case we want to add an item without risking overwriting an existing one\nlet UnpackedConfig= print InitialConfigArr= ExtractedInitialConfig\n| mv-expand bagexpansion= array InitialConfigArr\n| evaluate bag_unpack(InitialConfigArr)\n| extend _DTItemId = tostring(_DTItemId)\n| extend LastUpdatedTimeUTC= todatetime('20000101')\n| extend AnalyticsTemplateId = tostring(AnalyticsTemplateId)\n| extend Source= \"Function\";\n//  priority 1 is what is there on the watchlist. so when u edit a watchlist and it'll always overwrite\nlet ARMetaData= ARMetaDataConfig\n| extend AnalyticsTemplateId = tostring(AnalyticsTemplateId)\n| extend Source= \"Watchlist\"\n| summarize arg_max(LastUpdatedTimeUTC, *) by SearchKey\n| project-away SearchKey;\nlet Teams= materialize(_GetWatchlist(\"SAPSolutionConfig\") | where SearchKey  == \"Teams\" | project Team= ConfigKey, TeamsChannel, TeamsGroup, Email);\nARMetaData\n| union UnpackedConfig\n| summarize arg_max(LastUpdatedTimeUTC, *) by RuleID\n| lookup Teams on $left.Tier1 == $right.Team\n| project-rename Tier1TeamsChannel= TeamsChannel, Tier1TeamsGroup= TeamsGroup, Tier1Email= Email\n| lookup Teams on $left.Tier2 == $right.Team\n| project-rename Tier2TeamsChannel= TeamsChannel, Tier2TeamsGroup= TeamsGroup, Tier2Email= Email\n| project-rename ItemId= _DTItemId\n| extend AnalyticsTemplateId= coalesce(tostring(AnalyticsTemplateId), \"DefaultRule\")\n| extend PackedDetails= pack_all()\n",
                                "functionParameters": "",
                                "version": 2,
                                "tags": [
                                    {
                                        "name": "description",
                                        "value": "SAPWSAlertRuleMetaData"
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId35'),'/'))))]",
                            "dependsOn": [
                                "[variables('_parserId35')]"
                            ],
                            "properties": {
                                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPWSAlertRuleMetaData')]",
                                "contentId": "[variables('parserObject35').parserContentId35]",
                                "kind": "Parser",
                                "version": "[variables('parserObject35').parserVersion35]",
                                "source": {
                                    "name": "SAP",
                                    "kind": "Solution",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('parserObject35').parserContentId35]",
                "contentKind": "Parser",
                "displayName": "SAPWSAlertRuleMetaData",
                "contentProductId": "[variables('_parsercontentProductId35')]",
                "id": "[variables('_parsercontentProductId35')]",
                "version": "[variables('parserObject35').parserVersion35]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
            "apiVersion": "2022-10-01",
            "name": "[variables('parserObject35')._parserName35]",
            "location": "[parameters('workspace-location')]",
            "properties": {
                "eTag": "*",
                "displayName": "SAPWSAlertRuleMetaData",
                "category": "SAPWorkspaceManagement",
                "functionAlias": "SAPWSAlertRuleMetaData",
                "query": "let ARMetaDataConfig= _GetWatchlist(\"SAPAlertRulesMetadata\");\n//// zip it to save space\n// let PackedConfig= ARMetaDataConfig\n// | project-away SearchKey, LastUpdatedTimeUTC\n// | extend AnalyticsTemplateId=tostring(AnalyticsTemplateId)\n// | extend AllPacked= pack_all()\n// | summarize AllPacked= make_set(AllPacked)\n// | project ZippedPacked= zlib_compress_to_base64_string(tostring(AllPacked));\n// PackedConfig\nlet ZippedInitialConfig= \"eAHtXWtvG1eS/SsNftkMkBvc92O/OfYYMTBJjNiZXSAYLOq+ZCIUKZCUPdrF/vc5t0mJlCy2KIWyKGeAPGyRIrurT1edOvXo3/5v9D+v3r9ZltM3efSfo2CijoUnFrIUTBdnmBc5s6CLDSUnmYiPvh29mNLkYjlOv5xPyk90WvCb71687Vj3YrEYn0xPy3TZzWpH3aJMF+Pl+GPpzuazOp6UrV9evC+nZxNalv6bdZHSV0HMmJSYppiYL1UzU5Q30fIaUvvml7Ppcj6bvL84a1/6dl4+4ruofQNe/PHi5/nJ+h2v6XQ8ucB7XqRUFotu/ePFjbe9edWO/eooX5wvP8zm4//FJ86m3Y+z6XiJv05P8Fs/vXn3fvizr7+p/2SuvuPiO27w0i8lzU5hmVwy3lHHJ+fz/lvaxyw6mpQ5bDadXHTfTGafujrOZTJeXvyl/Sas3H8aXVl3VunKtBvLvvv5v+8++82b9j/397T4fYE39wc+P31VljSeLL5dX+73s/fjMpftffi/WIHhXUnnc5zA+qdy/dOfX47+/9vrmCvCqYB/mLc+Mm0qsSCtZT5KH3g1OmgxhLnv5+fL0r2ezVPpvvnl9cu/7MQY4JtU4IJlGzPTwgcWo6mMorY6p5q5C59hDCdb0hDAts70M2T9VJafZvPfO2qfsHrPH8CRkHfiaDxNQA5uv29OSx6fn94OpNhMVpvFvpnX9JfbobN1Xjcwc8tZPQAh39NivLgbHtFrV6wXLDoR2kWTjIKvTPHgtPS+yiCH4PGq9Ie5QjWc0uVpAe95vOz+NjvZ7ZNMjS5Ww5xXQCZ5x3xwmUVpqzEOx2Lj/fHy8gNNT0p3SlM6Ke1mvg04q4ObzE5OBrxP/x6a5g74mZ3DD8bx5DOQXeEH/+h74OfD+OTD7ejJWxad1cXantSOZtJb8xYw3XbSN1B185Qf1ek4SqVUJVkWUTEdpWGhOssqqSApOROMGkLVX/+Jr7qEFE27n+NiNsGV72bz9tc3094scEvn07T2p/l8KPyZ4rzOhnEtNNNcwh3WZJmp1klJMUeTDuua3kzhAE5Xt8XK//zBIKcOE+TKpWUR46aztVlnc5qO1zata5OeXlr0Xr7r1tN+VKghqNTquWSGq8q0tAYBJzowm8xBs1KQVe4PtW4rYH+P19/OZydzOt0JrMKLUSkGlhXYlHZJsQhsM8pWkgfYqq6HBdavizI/UMDj7vCYuuJNFOns7Mp69wLRzVN8AH5egblOZmdrV3gHhKSz4ME2sdoCoRbwVlEFA28Vk/NJqEplCEI/nk+W47NJ6d6CQiJ0527ljxe7qRIXyUbvmVUS/pEc4m9o3x0TzzmR97E+iI4PIWcdxu4Cz5sWoMZ1nFZ3cR8AwV3bD1c/2oEn8x33ByJQp2uDnq3tma7MeS8c3XLCj+qKApdOqVpZ9MIzrZHZxSoSyzETBRGNznUIRxvf83aOA56Uk5K7/mYAjWp/Hk93IgrESSglBHO60XwuLIscGA6Cc4qcF53jwRGFwxpPD+WMxGGc0VbidmnDc5hw0luwN+C9MPTZKT4eFZclmCwQRqrjhWmVwIejVky5mgsX2tphKv7u7U/lZNa9WC4p/b4TKNmrrG0IzEXwIa2rYF5aYipmZbhwQtKBs7S9UPIHvM5haPfibArr0aXxvjhIGiLuTuYL6KqPlglDiBs2R1w8V8B4UtWyeRg36GF+aKf/cTY5Py2N7pzNls3ANMEdtdGSMi2pK/88m82XJe/EEelcCkDKKrdAa7WVeacMnJ3NJelkiNQTUeofcaNTo279l+2Ejt/H5+wDnfbKyqizumXSK4s2g27Z88gJtc/Fk1SOWSkg4yhvGZWsmEwSimEmJUjuxYbenc1mk+7n8+XZ+XJDswdIkZCKfHbwfxJMPhKH/+OIY2SKkFwrreRXgKi9otglA1o0G856E5ZtCx45hkIMNlYJlZEHpEUSwjNxmRlVQkakvDPGD2Hop/Kpe/PyNRjR/OM4DRBpaVUhawQTPIFyeQJYDSWANdTErTElpgfRnr1kpHcXC5xxd+0i3y1r33j79jfcBir9HT+UMDktn8YJktKVUR8mJd192o9HkgQlZQ0EyuwEIqAGc4mhVDgrR1qIUIpV+3HsDT/sGkHEGf9ecHd2q2SjawF9OgMDmfcv75aWICx5LjhzpGzjU44B+4XlAPFU5RKA/uMm3nr0mMS7NyutjDqerk26tuixMnETFfLzCjcStUR6biXkyyxY8VoZC1ej5T00pd3y5V3qkiVbayiORWEd04EgE0DsYpxnytXKqPS/ZcuVLR8oNX350OiclSbK2EgVEvWkEbEkEnWPYAX10lfD6R70ag9elWtMqKlkZHxQJrUAgILVjokijG/yt+flT8mrnhOj0k4l4wJnRPAH2hs4BfghJgsnpaHxGDeoUa7Q8h7OePZxIJpJl/FFCK8IXq2GGz0j5w2TShgtkNJJ4n8WrPQYWW4sduyc25YMDoSkqaVs2qHGH3iDiS21oJzKq49DCHm1nfZ3dT47BRmCW83nqxLbYsX6zhegeHhlCee7aG/ezYyUDAmKFnMcAVRDFGCeACgZvLYonPAc6OixdHdvyX7Ue1sDaLaljWVXhu3tSttWPXK8IcHjVSLHAyEi1q4oC2SQhKkcOLTEgvrGMBO/2SlwI6NYZSI74VUIX58SJG7oUEybyFlMIrAKub0qFyF468dL/R6ng+A+BZQBKfNGz0Da/ph0adVn0EbASyVOPrHiKMClZUQjn1BsRdE3kg3eBTMEsfftbqKV+xovuvPpZJZ+H9A0lalVJ2RwqB23/rwE3i8LCoE1xYqIGGV4REh9KTXBHiY8LjfGHS+2THtEmsI9uuQirnNE8KzCw5lJZxilAgzIGJ0RVCylIaS92GqCmn/WFLUlZe12Z47r6KCWSThVMC8HYUM1JcsUy5Ur0gk3epxuqGOUsXZ7t63uqPn1XqmNtvUspS2ZDQQGF5gKksPb+dakmQTkcAolikpK5UECdzHFmabuxRT0ArdupEXJW9F1fRrdi3Z3704XNaQOpVAgtA7BVbuIena0qBI2IkmQ2Uz9PF18M4WqM17VN24F4q43rMnL5sVbi4O3v/7Z7x7Aq+WVEWllw96El2H0dGU/ujTfLQjbPpjPCNrmpfti6Nrv3uHIlA4iBMWyTLZxMQnxSFfm8EdhhU7JidFD2qG2Y+nLWd7tyFxwOXIOlYqa3GAgjUIKVfBm0jpVQ1LVjP6ULVFbETOtLPil26L2D4go8ylqgqP2Gc5IqIqrKDXLrchLghdbB3X2G52Z3bIshqrJrtgE0GTI+gmqGJR8pLEOsn6xqDtWgu9xxwsaeRjQXG+9vLLY8YJEllSMRYZPBtRcQ2ZEhm8j40Z7obRLQYYhkKwk/V5qOJ8iO8bVRMSarvrfR7tbnXwRCeW+6kNr12t9Mgq6QpQC2irJAso2eoo5g0ftYdkLQZNm0GbPjTk31jzeIQTFhQ25NdBaB2eTTaMcpFkTp62prmixXwPmu/OI81108aLvm9sJId66hkvx0MBBb7STAokesj1KwltBLlhpvz4I3a/5crGyZbx4SLHui8JHxmC9LlCiKrQCwAcqeRDQsMnpKimilBdHe9WE+9anBX3sey2XMxCgX9993+X56qLfjiXvIGRCjGIpgzRrqzULCdlbdtLYyCNyt+OXzN3oMMLTVsdTb8ZmRTpfxEsTPo2muU9rHTL9bBRcgkRxFdqP7tt4cRmVjvANKtsq9gPRL6gs3dkBHirlqKDRkyvArNMJaj0EhyzIo9jiLIkyeq4DmQci0VdwwseXwR7wZzCHqZCWgcgqllCKaQ3agVGNgTm4iZJ8sjEN1n1flXjei64rrQknM4AucpGQtCtGGhCDkOkYcdMqzUIZYyBy5QOPpbTqUcuWvxyl3m+Wbm002rbZvZzQbSf22AMpYCGl8lSYELyV8kRpjXSKVSuMNMrqWuveSfwG+vtOy+WgeSwFKqStrREztu6EQEyQ0RQsEnyX/0wZ/JUf+mOzcV80NfNJZh+hZVslACHeJnxbr0nCtfMJSrfkg6nZDy9+etG9+v6WCd+VoAg5aDwZSOdNUa3rs9oMBCmdoULFwlp7r642WOSHo2MSsx+jVLcXzHBKIALsupDdK47LtYWfZT1FVpNRu8tMVI0c3WTNIjI8cBxXLQBAUg5q2b9OaR2nQcV/KadgsLulyX39mi+egoGo7aprdWpTUDu2xFBcCYlHr0QSR+vXxIG2XMxrulWcfHLfdr8IqQMIeZXMBJTqdOFg6xoCApFJWhclUDLZj62/p4hct3s1nuMyr9OM7vuL7pfXL5s+Nds9cieNFBX+jEFLaEOcOUGHQu5ZoGRwZYNQ8akmYL4wpjYKd2/M3NuS+mOIFwDcZG3HI+9oMeSBJmR/UbSY2aoovjZhE/JiAh8y3AxT9KYepNlkssq2uw+FJssPXfpQBubxJNXAQwkQDTwEMBEgZHrw9eJ5LaFyXuvDBjef/yIMmHNjzZUxL235dM0r+2gJJGuWtmbmlAX9qSYwn3FNE4Ki09YkVQb5+1Uld58VBDW3MRcU+xJg25ZKIbH00jAkDIasNcEmf+Ru6ED1k8va7cM3DzxBO7h03mslmE0Fha+gepJsmHFcee8yofo/BJXX7992OOZu2tTiDWVqfRBlvlsgiFmBg1XOZCGoXQLiKXHXWjWTlkXLnB9hauWw65okPwxq6vIMBoT9NubbWO94RW8bZXFKyDYoCQbEW/UCAibyvdikphS8GeyN+3G86Dt507UMAeU4VBuuHNAtPZrrHGI3srgJmhRnCKS6SU/EfKAK7+QpCyGyDW50ZD10949wBxprOV1dhGvXAJL5h7J2ZTc7OU+vjP8ss8JsjA2Fw7sJk1tnAVh7W7lSNdQBCBKk4iBr77OMl/MCrC36y4XS1AL14k/DI3oCzC1krhhED/C66KFnQdRnNkulQ5tJlUe+G+Mw5ZlmpLSyHozXbAfTPdUo3j16MykrL6Eg2JRaibi1NGkQdJ6CihBOalZ1PylrdTjdi3yKw79WCBiYMG4dKW1wCvQKqUAK0GLhWsHlVFBtrUuOz3dz5oFagdci1mqBJjXr0k3jPs+iTZAmxJgzS7LtsQsW3FqWhj+nikaG6MvgIOhmUR1o2ppVXI+4O3HnfI3IGTKzos0VU0WBsE07mGKoVmGsojJ6Iob28hFaf/cC2tWSuuXZ2po3jXm8hM2ILJwg0aZkQNg8SitBKwVZXmayUkbu9X6S1bt2gVP3lpDhII+bdz/QYl1wzgOMv6haQ2QytthLqDp7VAEYJVlDjqg+uofh6ahazA+9RGrRm/rs0tIfaJGu7PwMlydEB+k9c5ZFaIplyqu1c9HJ6jgFCnywUWb3/ulWod8JPa4iks1UATiFAA6lFA5UAv6kkOaKKpKkZxtCH3X59NqszzN4GpFybCPLknTbPO0jC9mjJOQV4bL7EMQg2l7S2RK+ns0LoHTRfTyfTMt8nZm1RLW9Cx78vwrBUN1vL//+Vya5BMvnQv9jd1yFu1UWVR+BjLRNwysWIgd5QeGg3RzausPH1b0Vs4f3/4kDySHpmtWvGR3Rl85aP2lv8d/Sx3Ld4E8ite3p+kKQENM11FiPi62daIIX9K8MhSK50FYjDK7ef7nZCrN7T+NO0KlCURMqoSK7diuozDwK84wc6kcBtSKn4rP1gIfaTnS1I2bHJpln6wjbyj6TEP+Qv0Kvy0Ez7yDY++Cri8CllYOthZdqXBPt50iuxotG//aX5KwnroSGI9YxIYtp+kd0KEfA5yVPhIv2efz92ia68rbx9tLT1mYfPdUoFzc1B9QAmbNtwL118gVcMsYztzxW1AeJ9tQ9Ni073dvZZJwu7uxPrUXo0kQyb1st1Om2esgmJuGtsuIQzewDpri+4g6eTc/OWW/hwX7V45dqPZeeIzYxLaF4ocYAdwW1CwUi5JBVa6HTfiMZfQ9FP5Hx5u1OtEHTEEB5ZTm3ioYjBT6Gv4rAeQiuiiieZqRnrxh4uPmdy9mLvmFiES/GZ0ctaVRTuaoW6VxqDVU2Rhazlazk1FaXlUB6z575XV04r8YEW9zRiNPaVRHFMoPTAmCTIBas5yiFUVtAI0URT7Umbf8JjAMpZIOtOLm35jPpxkGEiY2XI+7EXrBCBBKhDWQYm6PhPKdhxo6vQaSfdNe16G6Taa8XjV6nhX+nyfluKcMWy4sDi6NS24w+iucBiixTltqidS2dzH92KSOtDX/d7huzM1Sdrr32cW3yZzrYIa3VqWmqRpa2LwGREoQeohr3xcrQyNrorq6xDxsFt8vn7bA/H/i42O0AoSiL/gEW1BygRa0sKGeZcMnXgLKZjAduAdp33GPNYhot2/Ygb6bLcjLfyc7EXltq9u0h24i2K8veHAq5uK8vfIqREDi9mF2NDLy8NezgP9GhElVV5FVGiFZ6sHqwDqS97+9oiY89W26WvF3bhLsTZjkKqaIpCPcJLE1R270lFIhhQogllVYaygFhdtAi+oEQtYmhazOu17ndLVUcxW5bb0OpNnhwa91Gw1CQomhCv+ehGkAqxsGs8ta85I5VbW1tvC8hM2UESl8kifnU4qdSSleSIYeHdZsdVe1JHQRfq22A6YAr256y4uSq0961PTC8Rci2iSYW0Sa1UYqCKyE/LH31HT+/9svFtjp+Nmu5dwsYTkoUmiSSkVZ50gboCwo4t1IJbowpkIBHf5Kmn9V2tsumn6sN3IvRUff9ZFUpSgnFMnIAKBnPAk+cKeeEsZS4sfogCUAPsk1tcyekwKViMOBVmaf2ZIwMN1ZIsuwcKkpZo6r1b/K/B/lv2KNtcz9T4m8zktBWTUfuB3xGB1m/FpaNU07r9oC3vfa1tUmjVwWy9HS4IwjBOQSU2piD0gKWH9qDWVDI1EhDUcQKxfOnWjTxNI3+8wpVf9tux74x10I6BYNmXDiEJKs8i0bG/mElUNijKsPU6zUIZvdq9gnevNVsutcr+v4jQW8ez84XUFi7FznPV6eyA0RVGEkgfdU3z+p8G00pUFWsyi7biHQxjo5dK7vPUubdkbE91jtfWbNn8aeXphyf0ZUhj3dniWt7bxI55gKV9vSbgovJDcuC1wz9Xgc+uKTtb+NaUKkAqtiqm2LWGqs/lTkK3cBMzyf7VTjr5d+7yVZtSwkoMei+oU2xGJS2AfRIUhhKlIp6RIL//nJp9mL05frI9qtpTy4tzFrrRDNvs+6WccfTK9M+jN1fO/lHlPq9aqo+SpBFIoWrSrHgRGWSXMyoDDknB7d9X9WDmhNbXHmxnYjS0pvsuGO1Nd3qtgTac3xfCYCYkj57r4/eTx34oRXNYS3yxnLHHu5QwBbREcId0KK9cgh3KrOUVYAOEH0dFkZfTsbt/rqX0qCl8cmIzJDvtUYbLlt3F2SyKJFL8BJcfgBsvkKZIfXGTV+JzCCtS468hTuybRFlW/7meRuG05SUhtQQB9d3b1olVrlgPyCy2tS6m0qpSFBloTCoNjmpnSssUA3MKM9jgpss4vCdhAfds6QPNsi2boLoM7t+/iMNDH48urJ+jzaH4AmilEfJuhUZU2iPT1EalWQLPEHdNm5wivLGgwq7H6CxTIZkKW2ogJfBIxWXW1+FZ2CacIoUPMRYBeR8BVLoozyw8MPGts/PQ8WgUtQolghHEAtsKu3Jvbj4AqIkXuTVxbuAtoRq1/h4EwzguafrNRPpj/RJdzuRWpRBwQeFAilaoQCHDLULGgeoXoRf1VVkN3qGjdIH2k4BaK6vB2SIzdX4Stunsy2i2raQO/O+xSa26SFIX1WGCEk04d8h+L7FDbZstezBp06PBp5JIEROhnGVQitaoeioSmFw1UpHLYsN4SvIBvbB3dnakrsfNX38mQFpaJW2BNYWKEFIr/Aq7Yk7JiorlC8li8HldBvtt9G1/1h0byEnf5rN82WbfnMHrTN6vFtN1ahhq4hyJHENyohUhUXR1r/mmoBsobLXo6+mPjQUZK/A09eEztamXGUDLeS2Yx4dV6XoH/8CRxc5UA==\";\nlet ExtractedInitialConfig= todynamic(zlib_decompress_from_base64_string(ZippedInitialConfig));\n// priority 2 is coming from this function to be used as fall back in case we want to add an item without risking overwriting an existing one\nlet UnpackedConfig= print InitialConfigArr= ExtractedInitialConfig\n| mv-expand bagexpansion= array InitialConfigArr\n| evaluate bag_unpack(InitialConfigArr)\n| extend _DTItemId = tostring(_DTItemId)\n| extend LastUpdatedTimeUTC= todatetime('20000101')\n| extend AnalyticsTemplateId = tostring(AnalyticsTemplateId)\n| extend Source= \"Function\";\n//  priority 1 is what is there on the watchlist. so when u edit a watchlist and it'll always overwrite\nlet ARMetaData= ARMetaDataConfig\n| extend AnalyticsTemplateId = tostring(AnalyticsTemplateId)\n| extend Source= \"Watchlist\"\n| summarize arg_max(LastUpdatedTimeUTC, *) by SearchKey\n| project-away SearchKey;\nlet Teams= materialize(_GetWatchlist(\"SAPSolutionConfig\") | where SearchKey  == \"Teams\" | project Team= ConfigKey, TeamsChannel, TeamsGroup, Email);\nARMetaData\n| union UnpackedConfig\n| summarize arg_max(LastUpdatedTimeUTC, *) by RuleID\n| lookup Teams on $left.Tier1 == $right.Team\n| project-rename Tier1TeamsChannel= TeamsChannel, Tier1TeamsGroup= TeamsGroup, Tier1Email= Email\n| lookup Teams on $left.Tier2 == $right.Team\n| project-rename Tier2TeamsChannel= TeamsChannel, Tier2TeamsGroup= TeamsGroup, Tier2Email= Email\n| project-rename ItemId= _DTItemId\n| extend AnalyticsTemplateId= coalesce(tostring(AnalyticsTemplateId), \"DefaultRule\")\n| extend PackedDetails= pack_all()\n",
                "functionParameters": "",
                "version": 2,
                "tags": [
                    {
                        "name": "description",
                        "value": "SAPWSAlertRuleMetaData"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
            "apiVersion": "2022-01-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId35'),'/'))))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[variables('_parserId35')]"
            ],
            "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPWSAlertRuleMetaData')]",
                "contentId": "[variables('parserObject35').parserContentId35]",
                "kind": "Parser",
                "version": "[variables('parserObject35').parserVersion35]",
                "source": {
                    "kind": "Solution",
                    "name": "SAP",
                    "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                    "name": "Microsoft",
                    "email": "[variables('_email')]"
                },
                "support": {
                    "tier": "Microsoft",
                    "name": "Microsoft Corporation",
                    "email": "support@microsoft.com",
                    "link": "https://support.microsoft.com/"
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('parserTemplateSpecName36')]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAPWSAlertsDetailed Data Parser with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('parserObject36').parserVersion36]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "name": "[variables('parserObject36')._parserName36]",
                            "apiVersion": "2022-10-01",
                            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "eTag": "*",
                                "displayName": "SAPWSAlertsDetailed",
                                "category": "SAPWorkspaceManagement",
                                "functionAlias": "SAPWSAlertsDetailed",
                                "query": "let AlertsWithEntities= SecurityAlert\n| summarize hint.strategy = shuffle arg_max(TimeGenerated, *), NumberOfUpdates = count() by SystemAlertId\n| project ExtendedProperties, TimeGenerated, SystemAlertId, Entities, DisplayName, StartTime, Tactics=parse_csv(replace_string(Tactics,\" \",\"\"))\n| extend ExtendedProperties = parse_json(ExtendedProperties)\n| extend AnalyticRuleId= tostring(todynamic(replace_regex(tostring(ExtendedProperties[\"Analytic Rule Ids\"]), \"\\\\r\", \"\"))[0])\n| extend AnalyticRuleName= tostring(ExtendedProperties[\"Analytic Rule Name\"])\n| extend AnalyticsTemplateId= tostring(ExtendedProperties[\"Analytics Template Id\"])\n| extend BagOfEntities= tostring(ExtendedProperties.Query), SystemAlertId\n| extend BagOfEntities= tostring(split(BagOfEntities, \"'\",1)[0])\n| extend BagOfEntities = todynamic(zlib_decompress_from_base64_string(BagOfEntities))\n| evaluate bag_unpack(BagOfEntities, ignoredProperties= dynamic([\"TimeGenerated\"]), columnsConflict= \"keep_source\")\n| mv-expand CustomDetails= parse_json(ExtendedProperties.[\"Custom Details\"])\n| mv-expand Entities = parse_json(Entities)\n| project-away ExtendedProperties\n| extend CustomDetailsReplaced = replace_regex(tostring(CustomDetails), \"\\\\r\", \"\"), AlertDisplayName= tostring(DisplayName), Entities, SystemAlertId, AnalyticRuleName\n| project-rename AlertStartTime = StartTime\n| extend SAP_User = tostring(parse_json(tostring(parse_json(CustomDetailsReplaced).SAP_User))[0])\n| extend Name= parse_json(tostring(Entities.Name))\n| extend ADAccountT= tostring(iff(Entities.Type == \"account\", Name, \"\"))\n| extend Address= tostring(parse_json(tostring(Entities.Address)))\n| extend IPAddressT= tostring(iff(Entities.Type == \"ip\", Address, \"\"))\n| extend SAPSystemT= tostring(iff(Entities.Type == \"cloud-application\", Name, \"\"))\n| project-away CustomDetailsReplaced, Entities, Name\n| summarize take_any(*), ADAccount= take_anyif(ADAccountT, isnotempty(ADAccountT)), IPAddress=take_anyif(IPAddressT, isnotempty( IPAddressT)), SAPSystem= take_anyif(SAPSystemT, isnotempty( SAPSystemT))\nby SystemAlertId\n| project-away ADAccountT, IPAddressT, SAPSystemT, CustomDetails\n| extend AlertRuleUniqueName= column_ifexists(\"AlertRuleUniqueName\",\"\")\n| project-reorder AnalyticRuleName\n| lookup (SAPWSAlertRuleMetaData | project AnalyticsTemplateId, RecommendedConfiguration) on AnalyticsTemplateId;\nAlertsWithEntities\n",
                                "functionParameters": "",
                                "version": 2,
                                "tags": [
                                    {
                                        "name": "description",
                                        "value": "SAPWSAlertsDetailed"
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId36'),'/'))))]",
                            "dependsOn": [
                                "[variables('_parserId36')]"
                            ],
                            "properties": {
                                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPWSAlertsDetailed')]",
                                "contentId": "[variables('parserObject36').parserContentId36]",
                                "kind": "Parser",
                                "version": "[variables('parserObject36').parserVersion36]",
                                "source": {
                                    "name": "SAP",
                                    "kind": "Solution",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('parserObject36').parserContentId36]",
                "contentKind": "Parser",
                "displayName": "SAPWSAlertsDetailed",
                "contentProductId": "[variables('_parsercontentProductId36')]",
                "id": "[variables('_parsercontentProductId36')]",
                "version": "[variables('parserObject36').parserVersion36]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
            "apiVersion": "2022-10-01",
            "name": "[variables('parserObject36')._parserName36]",
            "location": "[parameters('workspace-location')]",
            "properties": {
                "eTag": "*",
                "displayName": "SAPWSAlertsDetailed",
                "category": "SAPWorkspaceManagement",
                "functionAlias": "SAPWSAlertsDetailed",
                "query": "let AlertsWithEntities= SecurityAlert\n| summarize hint.strategy = shuffle arg_max(TimeGenerated, *), NumberOfUpdates = count() by SystemAlertId\n| project ExtendedProperties, TimeGenerated, SystemAlertId, Entities, DisplayName, StartTime, Tactics=parse_csv(replace_string(Tactics,\" \",\"\"))\n| extend ExtendedProperties = parse_json(ExtendedProperties)\n| extend AnalyticRuleId= tostring(todynamic(replace_regex(tostring(ExtendedProperties[\"Analytic Rule Ids\"]), \"\\\\r\", \"\"))[0])\n| extend AnalyticRuleName= tostring(ExtendedProperties[\"Analytic Rule Name\"])\n| extend AnalyticsTemplateId= tostring(ExtendedProperties[\"Analytics Template Id\"])\n| extend BagOfEntities= tostring(ExtendedProperties.Query), SystemAlertId\n| extend BagOfEntities= tostring(split(BagOfEntities, \"'\",1)[0])\n| extend BagOfEntities = todynamic(zlib_decompress_from_base64_string(BagOfEntities))\n| evaluate bag_unpack(BagOfEntities, ignoredProperties= dynamic([\"TimeGenerated\"]), columnsConflict= \"keep_source\")\n| mv-expand CustomDetails= parse_json(ExtendedProperties.[\"Custom Details\"])\n| mv-expand Entities = parse_json(Entities)\n| project-away ExtendedProperties\n| extend CustomDetailsReplaced = replace_regex(tostring(CustomDetails), \"\\\\r\", \"\"), AlertDisplayName= tostring(DisplayName), Entities, SystemAlertId, AnalyticRuleName\n| project-rename AlertStartTime = StartTime\n| extend SAP_User = tostring(parse_json(tostring(parse_json(CustomDetailsReplaced).SAP_User))[0])\n| extend Name= parse_json(tostring(Entities.Name))\n| extend ADAccountT= tostring(iff(Entities.Type == \"account\", Name, \"\"))\n| extend Address= tostring(parse_json(tostring(Entities.Address)))\n| extend IPAddressT= tostring(iff(Entities.Type == \"ip\", Address, \"\"))\n| extend SAPSystemT= tostring(iff(Entities.Type == \"cloud-application\", Name, \"\"))\n| project-away CustomDetailsReplaced, Entities, Name\n| summarize take_any(*), ADAccount= take_anyif(ADAccountT, isnotempty(ADAccountT)), IPAddress=take_anyif(IPAddressT, isnotempty( IPAddressT)), SAPSystem= take_anyif(SAPSystemT, isnotempty( SAPSystemT))\nby SystemAlertId\n| project-away ADAccountT, IPAddressT, SAPSystemT, CustomDetails\n| extend AlertRuleUniqueName= column_ifexists(\"AlertRuleUniqueName\",\"\")\n| project-reorder AnalyticRuleName\n| lookup (SAPWSAlertRuleMetaData | project AnalyticsTemplateId, RecommendedConfiguration) on AnalyticsTemplateId;\nAlertsWithEntities\n",
                "functionParameters": "",
                "version": 2,
                "tags": [
                    {
                        "name": "description",
                        "value": "SAPWSAlertsDetailed"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
            "apiVersion": "2022-01-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId36'),'/'))))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[variables('_parserId36')]"
            ],
            "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPWSAlertsDetailed')]",
                "contentId": "[variables('parserObject36').parserContentId36]",
                "kind": "Parser",
                "version": "[variables('parserObject36').parserVersion36]",
                "source": {
                    "kind": "Solution",
                    "name": "SAP",
                    "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                    "name": "Microsoft",
                    "email": "[variables('_email')]"
                },
                "support": {
                    "tier": "Microsoft",
                    "name": "Microsoft Corporation",
                    "email": "support@microsoft.com",
                    "link": "https://support.microsoft.com/"
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('parserTemplateSpecName37')]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAPWSIncidentsDetailed Data Parser with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('parserObject37').parserVersion37]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "name": "[variables('parserObject37')._parserName37]",
                            "apiVersion": "2022-10-01",
                            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "eTag": "*",
                                "displayName": "SAPWSIncidentsDetailed",
                                "category": "SAPWorkspaceManagement",
                                "functionAlias": "SAPWSIncidentsDetailed",
                                "query": "let DetailedIncidents= SecurityIncident\n| summarize arg_max(TimeGenerated, *) by IncidentNumber\n| project-away TenantId, IncidentName, RelatedAnalyticRuleIds\n| mv-expand AlertIds| extend AlertIds = tostring(AlertIds)\n| join kind= fullouter\nSAPWSAlertsDetailed\non $left.AlertIds == $right.SystemAlertId\n| extend IsPrivateIP= ipv4_is_private(IPAddress)\n| extend Owner = todynamic(Owner.assignedTo)\n| extend Product = todynamic((parse_json(tostring(AdditionalData.alertProductNames))[0]))\n| extend Tactics = set_union(todynamic(AdditionalData.tactics), todynamic(Tactics))\n| project-away AdditionalData;\nDetailedIncidents\n",
                                "functionParameters": "",
                                "version": 2,
                                "tags": [
                                    {
                                        "name": "description",
                                        "value": "SAPWSIncidentsDetailed"
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId37'),'/'))))]",
                            "dependsOn": [
                                "[variables('_parserId37')]"
                            ],
                            "properties": {
                                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPWSIncidentsDetailed')]",
                                "contentId": "[variables('parserObject37').parserContentId37]",
                                "kind": "Parser",
                                "version": "[variables('parserObject37').parserVersion37]",
                                "source": {
                                    "name": "SAP",
                                    "kind": "Solution",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('parserObject37').parserContentId37]",
                "contentKind": "Parser",
                "displayName": "SAPWSIncidentsDetailed",
                "contentProductId": "[variables('_parsercontentProductId37')]",
                "id": "[variables('_parsercontentProductId37')]",
                "version": "[variables('parserObject37').parserVersion37]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
            "apiVersion": "2022-10-01",
            "name": "[variables('parserObject37')._parserName37]",
            "location": "[parameters('workspace-location')]",
            "properties": {
                "eTag": "*",
                "displayName": "SAPWSIncidentsDetailed",
                "category": "SAPWorkspaceManagement",
                "functionAlias": "SAPWSIncidentsDetailed",
                "query": "let DetailedIncidents= SecurityIncident\n| summarize arg_max(TimeGenerated, *) by IncidentNumber\n| project-away TenantId, IncidentName, RelatedAnalyticRuleIds\n| mv-expand AlertIds| extend AlertIds = tostring(AlertIds)\n| join kind= fullouter\nSAPWSAlertsDetailed\non $left.AlertIds == $right.SystemAlertId\n| extend IsPrivateIP= ipv4_is_private(IPAddress)\n| extend Owner = todynamic(Owner.assignedTo)\n| extend Product = todynamic((parse_json(tostring(AdditionalData.alertProductNames))[0]))\n| extend Tactics = set_union(todynamic(AdditionalData.tactics), todynamic(Tactics))\n| project-away AdditionalData;\nDetailedIncidents\n",
                "functionParameters": "",
                "version": 2,
                "tags": [
                    {
                        "name": "description",
                        "value": "SAPWSIncidentsDetailed"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
            "apiVersion": "2022-01-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId37'),'/'))))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[variables('_parserId37')]"
            ],
            "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPWSIncidentsDetailed')]",
                "contentId": "[variables('parserObject37').parserContentId37]",
                "kind": "Parser",
                "version": "[variables('parserObject37').parserVersion37]",
                "source": {
                    "kind": "Solution",
                    "name": "SAP",
                    "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                    "name": "Microsoft",
                    "email": "[variables('_email')]"
                },
                "support": {
                    "tier": "Microsoft",
                    "name": "Microsoft Corporation",
                    "email": "support@microsoft.com",
                    "link": "https://support.microsoft.com/"
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('parserTemplateSpecName38')]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAPWorkflowLog Data Parser with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('parserObject38').parserVersion38]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "name": "[variables('parserObject38')._parserName38]",
                            "apiVersion": "2022-10-01",
                            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "eTag": "*",
                                "displayName": "SAPWorkflowLog",
                                "category": "SAPFunctions",
                                "functionAlias": "SAPWorkflowLog",
                                "query": "[replace(variables('SAPFunctionsSAPWorkflowLogQuery'),'CWSQSAP.', if(equals(coalesce(parameters('CWSQSAPIdentifier'),''),'') , '', concat(variables('CWSQIdentifierPrefix'), parameters('CWSQSAPIdentifier'),variables('CWQSIdentifierSuffix'))))]",
                                "functionParameters": "",
                                "version": 2,
                                "tags": [
                                    {
                                        "name": "description",
                                        "value": "SAPWorkflowLog"
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId38'),'/'))))]",
                            "dependsOn": [
                                "[variables('_parserId38')]"
                            ],
                            "properties": {
                                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPWorkflowLog')]",
                                "contentId": "[variables('parserObject38').parserContentId38]",
                                "kind": "Parser",
                                "version": "[variables('parserObject38').parserVersion38]",
                                "source": {
                                    "name": "SAP",
                                    "kind": "Solution",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('parserObject38').parserContentId38]",
                "contentKind": "Parser",
                "displayName": "SAPWorkflowLog",
                "contentProductId": "[variables('_parsercontentProductId38')]",
                "id": "[variables('_parsercontentProductId38')]",
                "version": "[variables('parserObject38').parserVersion38]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
            "apiVersion": "2022-10-01",
            "name": "[variables('parserObject38')._parserName38]",
            "location": "[parameters('workspace-location')]",
            "properties": {
                "eTag": "*",
                "displayName": "SAPWorkflowLog",
                "category": "SAPFunctions",
                "functionAlias": "SAPWorkflowLog",
                "query": "[replace(variables('SAPFunctionsSAPWorkflowLogQuery'),'CWSQSAP.', if(equals(coalesce(parameters('CWSQSAPIdentifier'),''),'') , '', concat(variables('CWSQIdentifierPrefix'), parameters('CWSQSAPIdentifier'),variables('CWQSIdentifierSuffix'))))]",
                "functionParameters": "",
                "version": 2,
                "tags": [
                    {
                        "name": "description",
                        "value": "SAPWorkflowLog"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
            "apiVersion": "2022-01-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId38'),'/'))))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[variables('_parserId38')]"
            ],
            "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPWorkflowLog')]",
                "contentId": "[variables('parserObject38').parserContentId38]",
                "kind": "Parser",
                "version": "[variables('parserObject38').parserVersion38]",
                "source": {
                    "kind": "Solution",
                    "name": "SAP",
                    "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                    "name": "Microsoft",
                    "email": "[variables('_email')]"
                },
                "support": {
                    "tier": "Microsoft",
                    "name": "Microsoft Corporation",
                    "email": "support@microsoft.com",
                    "link": "https://support.microsoft.com/"
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('parserTemplateSpecName39')]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAPXalAlerts Data Parser with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('parserObject39').parserVersion39]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "name": "[variables('parserObject39')._parserName39]",
                            "apiVersion": "2022-10-01",
                            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "eTag": "*",
                                "displayName": "SAPXalAlerts",
                                "category": "SAPFunctions",
                                "functionAlias": "SAPXalAlerts",
                                "query": "//generated function structure for custom log XalAlerts_CL\n//generated on 2023-02-26\n//Sentinel4SAP solution version 2.0.56\nlet Colors = dynamic (['Unclear','Green', 'Yellow', 'Red', 'Header',  'Footer']);\nlet D_XalAlerts_CL = datatable(TimeGenerated:datetime\n,RC:real\n,ALSYSID:string\n,MSEGNAME:string\n,ALUNIQNUM:string\n,ALINDEX:string\n,ALERTDATE:string\n,ALERTTIME:string\n,DUMMYALIGN:string\n,SystemID:string\n,MTMCNAME:string\n,MTNUMRANGE:string\n,MTUID:string\n,MTCLASS:string\n,MTINDEX:string\n,EXTINDEX:string\n,VALUE:real\n,Severity:int\n,STATUS:real\n,OBJECTNAME:string\n,FIELDNAME:string\n,ClientID:string\n,USERID:string\n,GONEDATE:string\n,GONETIME:string\n,GONEDUMMY:string\n,REPORTEDBY:string\n,STATCHGDAT:string\n,STATCHGTIM:string\n,STATCHGDUM:string\n,STATCHGBY:string\n,TIMEOUTDAT:string\n,TIMEOUTTIM:string\n,TIMEOUTDUM:string\n,MSGCLASS:string\n,MSGID:string\n,MSGARG1:string\n,ARGTYPE1:string\n,MSGARG2:string\n,ARGTYPE2:string\n,MSGARG3:string\n,ARGTYPE3:string\n,MSGARG4:string\n,ARGTYPE4:string\n,MSGTEXT:string\n,MSG:string\n,MSCGLID:string\n,MonitorName:string\n,MonitorSetName:string\n,Type:string\n)['1000-01-01T00:00:00Z',1.1111,'initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString',1.1111,1,1.1111,'initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString'];\nlet T_XalAlerts_CL = (XalAlerts_CL | project\nTimeGenerated = column_ifexists('TimeGenerated', '1000-01-01T00:00:00Z')\n,RC = column_ifexists('RC_d', 1.1111)\n,ALSYSID = column_ifexists('ALSYSID_s', 'initialString')\n,MSEGNAME = column_ifexists('MSEGNAME_s', 'initialString')\n,ALUNIQNUM = column_ifexists('ALUNIQNUM_s', 'initialString')\n,ALINDEX = column_ifexists('ALINDEX_s', 'initialString')\n,ALERTDATE = column_ifexists('ALERTDATE_s', 'initialString')\n,ALERTTIME = column_ifexists('ALERTTIME_s', 'initialString')\n,DUMMYALIGN = column_ifexists('DUMMYALIGN_s', 'initialString')\n,SystemID = column_ifexists('MTSYSID_s', 'initialString')\n,MTMCNAME = column_ifexists('MTMCNAME_s', 'initialString')\n,MTNUMRANGE = column_ifexists('MTNUMRANGE_s', 'initialString')\n,MTUID = column_ifexists('MTUID_s', 'initialString')\n,MTCLASS = column_ifexists('MTCLASS_s', 'initialString')\n,MTINDEX = column_ifexists('MTINDEX_s', 'initialString')\n,EXTINDEX = column_ifexists('EXTINDEX_s', 'initialString')\n,VALUE = column_ifexists('VALUE_d', 1.1111)\n,Severity = column_ifexists('Severity', 1)\n,STATUS = column_ifexists('STATUS_d', 1.1111)\n,OBJECTNAME = column_ifexists('OBJECTNAME_s', 'initialString')\n,FIELDNAME = column_ifexists('FIELDNAME_s', 'initialString')\n,ClientID = column_ifexists('MANDT_s', 'initialString')\n,USERID = column_ifexists('USERID_s', 'initialString')\n,GONEDATE = column_ifexists('GONEDATE_s', 'initialString')\n,GONETIME = column_ifexists('GONETIME_s', 'initialString')\n,GONEDUMMY = column_ifexists('GONEDUMMY_s', 'initialString')\n,REPORTEDBY = column_ifexists('REPORTEDBY_s', 'initialString')\n,STATCHGDAT = column_ifexists('STATCHGDAT_s', 'initialString')\n,STATCHGTIM = column_ifexists('STATCHGTIM_s', 'initialString')\n,STATCHGDUM = column_ifexists('STATCHGDUM_s', 'initialString')\n,STATCHGBY = column_ifexists('STATCHGBY_s', 'initialString')\n,TIMEOUTDAT = column_ifexists('TIMEOUTDAT_s', 'initialString')\n,TIMEOUTTIM = column_ifexists('TIMEOUTTIM_s', 'initialString')\n,TIMEOUTDUM = column_ifexists('TIMEOUTDUM_s', 'initialString')\n,MSGCLASS = column_ifexists('MSGCLASS_s', 'initialString')\n,MSGID = column_ifexists('MSGID_s', 'initialString')\n,MSGARG1 = column_ifexists('MSGARG1_s', 'initialString')\n,ARGTYPE1 = column_ifexists('ARGTYPE1_s', 'initialString')\n,MSGARG2 = column_ifexists('MSGARG2_s', 'initialString')\n,ARGTYPE2 = column_ifexists('ARGTYPE2_s', 'initialString')\n,MSGARG3 = column_ifexists('MSGARG3_s', 'initialString')\n,ARGTYPE3 = column_ifexists('ARGTYPE3_s', 'initialString')\n,MSGARG4 = column_ifexists('MSGARG4_s', 'initialString')\n,ARGTYPE4 = column_ifexists('ARGTYPE4_s', 'initialString')\n,MSGTEXT = column_ifexists('MSGTEXT_s', 'initialString')\n,MSG = column_ifexists('MSG_s', 'initialString')\n,MSCGLID = column_ifexists('MSCGLID_s', 'initialString')\n,MonitorName = column_ifexists('MonitorName_s', 'initialString')\n,MonitorSetName = column_ifexists('MonitorSetName_s', 'initialString')\n,Type = column_ifexists('Type', 'initialString')\n);\nlet XalAlerts= T_XalAlerts_CL | union isfuzzy= true (D_XalAlerts_CL);\nlet D_XalAlertsCompleted_CL = datatable(TimeGenerated:datetime\n,SystemID:string\n,MSEGNAME:string\n,ALUNIQNUM:string\n,ALINDEX:string\n,ALERTDATE:string\n,ALERTTIME:string\n,DUMMYALIGN:string\n,RC:real\n,RC_TEXT:string\n,Type:string\n)['1000-01-01T00:00:00Z','initialString','initialString','initialString','initialString','initialString','initialString','initialString',1.1111,'initialString','initialString'];\nlet T_XalAlertsCompleted_CL = (XalAlertsCompleted_CL | project\nTimeGenerated = column_ifexists('TimeGenerated', '1000-01-01T00:00:00Z')\n,SystemID = column_ifexists('ALSYSID_s', 'initialString')\n,MSEGNAME = column_ifexists('MSEGNAME_s', 'initialString')\n,ALUNIQNUM = column_ifexists('ALUNIQNUM_s', 'initialString')\n,ALINDEX = column_ifexists('ALINDEX_s', 'initialString')\n,ALERTDATE = column_ifexists('ALERTDATE_s', 'initialString')\n,ALERTTIME = column_ifexists('ALERTTIME_s', 'initialString')\n,DUMMYALIGN = column_ifexists('DUMMYALIGN_s', 'initialString')\n,RC = column_ifexists('RC_d', 1.1111)\n,RC_TEXT = column_ifexists('RC_TEXT_s', 'initialString')\n,Type = column_ifexists('Type', 'initialString'));\nlet XalCompleted= T_XalAlertsCompleted_CL | union isfuzzy= true (D_XalAlertsCompleted_CL);\nXalAlerts | join kind=leftouter (XalCompleted | project ALUNIQNUM, ALINDEX, RC_TEXT, SystemID)\non ALUNIQNUM, ALINDEX, SystemID\n| where SystemID != 'initialString'\n| project-away ALUNIQNUM1, ALINDEX1, SystemID1\n| project-rename AlertCompletionStatus= RC_TEXT\n| extend UpdatedOn= todatetime(strcat(ALERTDATE, ALERTTIME))\n| extend Color= Colors[toint(VALUE)]\n| summarize arg_max(UpdatedOn, *) by SystemID, MSEGNAME, ALUNIQNUM, ALINDEX, OBJECTNAME, FIELDNAME, MonitorName, MonitorSetName\n",
                                "functionParameters": "",
                                "version": 2,
                                "tags": [
                                    {
                                        "name": "description",
                                        "value": "SAPXalAlerts"
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId39'),'/'))))]",
                            "dependsOn": [
                                "[variables('_parserId39')]"
                            ],
                            "properties": {
                                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPXalAlerts')]",
                                "contentId": "[variables('parserObject39').parserContentId39]",
                                "kind": "Parser",
                                "version": "[variables('parserObject39').parserVersion39]",
                                "source": {
                                    "name": "SAP",
                                    "kind": "Solution",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('parserObject39').parserContentId39]",
                "contentKind": "Parser",
                "displayName": "SAPXalAlerts",
                "contentProductId": "[variables('_parsercontentProductId39')]",
                "id": "[variables('_parsercontentProductId39')]",
                "version": "[variables('parserObject39').parserVersion39]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
            "apiVersion": "2022-10-01",
            "name": "[variables('parserObject39')._parserName39]",
            "location": "[parameters('workspace-location')]",
            "properties": {
                "eTag": "*",
                "displayName": "SAPXalAlerts",
                "category": "SAPFunctions",
                "functionAlias": "SAPXalAlerts",
                "query": "//generated function structure for custom log XalAlerts_CL\n//generated on 2023-02-26\n//Sentinel4SAP solution version 2.0.56\nlet Colors = dynamic (['Unclear','Green', 'Yellow', 'Red', 'Header',  'Footer']);\nlet D_XalAlerts_CL = datatable(TimeGenerated:datetime\n,RC:real\n,ALSYSID:string\n,MSEGNAME:string\n,ALUNIQNUM:string\n,ALINDEX:string\n,ALERTDATE:string\n,ALERTTIME:string\n,DUMMYALIGN:string\n,SystemID:string\n,MTMCNAME:string\n,MTNUMRANGE:string\n,MTUID:string\n,MTCLASS:string\n,MTINDEX:string\n,EXTINDEX:string\n,VALUE:real\n,Severity:int\n,STATUS:real\n,OBJECTNAME:string\n,FIELDNAME:string\n,ClientID:string\n,USERID:string\n,GONEDATE:string\n,GONETIME:string\n,GONEDUMMY:string\n,REPORTEDBY:string\n,STATCHGDAT:string\n,STATCHGTIM:string\n,STATCHGDUM:string\n,STATCHGBY:string\n,TIMEOUTDAT:string\n,TIMEOUTTIM:string\n,TIMEOUTDUM:string\n,MSGCLASS:string\n,MSGID:string\n,MSGARG1:string\n,ARGTYPE1:string\n,MSGARG2:string\n,ARGTYPE2:string\n,MSGARG3:string\n,ARGTYPE3:string\n,MSGARG4:string\n,ARGTYPE4:string\n,MSGTEXT:string\n,MSG:string\n,MSCGLID:string\n,MonitorName:string\n,MonitorSetName:string\n,Type:string\n)['1000-01-01T00:00:00Z',1.1111,'initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString',1.1111,1,1.1111,'initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString','initialString'];\nlet T_XalAlerts_CL = (XalAlerts_CL | project\nTimeGenerated = column_ifexists('TimeGenerated', '1000-01-01T00:00:00Z')\n,RC = column_ifexists('RC_d', 1.1111)\n,ALSYSID = column_ifexists('ALSYSID_s', 'initialString')\n,MSEGNAME = column_ifexists('MSEGNAME_s', 'initialString')\n,ALUNIQNUM = column_ifexists('ALUNIQNUM_s', 'initialString')\n,ALINDEX = column_ifexists('ALINDEX_s', 'initialString')\n,ALERTDATE = column_ifexists('ALERTDATE_s', 'initialString')\n,ALERTTIME = column_ifexists('ALERTTIME_s', 'initialString')\n,DUMMYALIGN = column_ifexists('DUMMYALIGN_s', 'initialString')\n,SystemID = column_ifexists('MTSYSID_s', 'initialString')\n,MTMCNAME = column_ifexists('MTMCNAME_s', 'initialString')\n,MTNUMRANGE = column_ifexists('MTNUMRANGE_s', 'initialString')\n,MTUID = column_ifexists('MTUID_s', 'initialString')\n,MTCLASS = column_ifexists('MTCLASS_s', 'initialString')\n,MTINDEX = column_ifexists('MTINDEX_s', 'initialString')\n,EXTINDEX = column_ifexists('EXTINDEX_s', 'initialString')\n,VALUE = column_ifexists('VALUE_d', 1.1111)\n,Severity = column_ifexists('Severity', 1)\n,STATUS = column_ifexists('STATUS_d', 1.1111)\n,OBJECTNAME = column_ifexists('OBJECTNAME_s', 'initialString')\n,FIELDNAME = column_ifexists('FIELDNAME_s', 'initialString')\n,ClientID = column_ifexists('MANDT_s', 'initialString')\n,USERID = column_ifexists('USERID_s', 'initialString')\n,GONEDATE = column_ifexists('GONEDATE_s', 'initialString')\n,GONETIME = column_ifexists('GONETIME_s', 'initialString')\n,GONEDUMMY = column_ifexists('GONEDUMMY_s', 'initialString')\n,REPORTEDBY = column_ifexists('REPORTEDBY_s', 'initialString')\n,STATCHGDAT = column_ifexists('STATCHGDAT_s', 'initialString')\n,STATCHGTIM = column_ifexists('STATCHGTIM_s', 'initialString')\n,STATCHGDUM = column_ifexists('STATCHGDUM_s', 'initialString')\n,STATCHGBY = column_ifexists('STATCHGBY_s', 'initialString')\n,TIMEOUTDAT = column_ifexists('TIMEOUTDAT_s', 'initialString')\n,TIMEOUTTIM = column_ifexists('TIMEOUTTIM_s', 'initialString')\n,TIMEOUTDUM = column_ifexists('TIMEOUTDUM_s', 'initialString')\n,MSGCLASS = column_ifexists('MSGCLASS_s', 'initialString')\n,MSGID = column_ifexists('MSGID_s', 'initialString')\n,MSGARG1 = column_ifexists('MSGARG1_s', 'initialString')\n,ARGTYPE1 = column_ifexists('ARGTYPE1_s', 'initialString')\n,MSGARG2 = column_ifexists('MSGARG2_s', 'initialString')\n,ARGTYPE2 = column_ifexists('ARGTYPE2_s', 'initialString')\n,MSGARG3 = column_ifexists('MSGARG3_s', 'initialString')\n,ARGTYPE3 = column_ifexists('ARGTYPE3_s', 'initialString')\n,MSGARG4 = column_ifexists('MSGARG4_s', 'initialString')\n,ARGTYPE4 = column_ifexists('ARGTYPE4_s', 'initialString')\n,MSGTEXT = column_ifexists('MSGTEXT_s', 'initialString')\n,MSG = column_ifexists('MSG_s', 'initialString')\n,MSCGLID = column_ifexists('MSCGLID_s', 'initialString')\n,MonitorName = column_ifexists('MonitorName_s', 'initialString')\n,MonitorSetName = column_ifexists('MonitorSetName_s', 'initialString')\n,Type = column_ifexists('Type', 'initialString')\n);\nlet XalAlerts= T_XalAlerts_CL | union isfuzzy= true (D_XalAlerts_CL);\nlet D_XalAlertsCompleted_CL = datatable(TimeGenerated:datetime\n,SystemID:string\n,MSEGNAME:string\n,ALUNIQNUM:string\n,ALINDEX:string\n,ALERTDATE:string\n,ALERTTIME:string\n,DUMMYALIGN:string\n,RC:real\n,RC_TEXT:string\n,Type:string\n)['1000-01-01T00:00:00Z','initialString','initialString','initialString','initialString','initialString','initialString','initialString',1.1111,'initialString','initialString'];\nlet T_XalAlertsCompleted_CL = (XalAlertsCompleted_CL | project\nTimeGenerated = column_ifexists('TimeGenerated', '1000-01-01T00:00:00Z')\n,SystemID = column_ifexists('ALSYSID_s', 'initialString')\n,MSEGNAME = column_ifexists('MSEGNAME_s', 'initialString')\n,ALUNIQNUM = column_ifexists('ALUNIQNUM_s', 'initialString')\n,ALINDEX = column_ifexists('ALINDEX_s', 'initialString')\n,ALERTDATE = column_ifexists('ALERTDATE_s', 'initialString')\n,ALERTTIME = column_ifexists('ALERTTIME_s', 'initialString')\n,DUMMYALIGN = column_ifexists('DUMMYALIGN_s', 'initialString')\n,RC = column_ifexists('RC_d', 1.1111)\n,RC_TEXT = column_ifexists('RC_TEXT_s', 'initialString')\n,Type = column_ifexists('Type', 'initialString'));\nlet XalCompleted= T_XalAlertsCompleted_CL | union isfuzzy= true (D_XalAlertsCompleted_CL);\nXalAlerts | join kind=leftouter (XalCompleted | project ALUNIQNUM, ALINDEX, RC_TEXT, SystemID)\non ALUNIQNUM, ALINDEX, SystemID\n| where SystemID != 'initialString'\n| project-away ALUNIQNUM1, ALINDEX1, SystemID1\n| project-rename AlertCompletionStatus= RC_TEXT\n| extend UpdatedOn= todatetime(strcat(ALERTDATE, ALERTTIME))\n| extend Color= Colors[toint(VALUE)]\n| summarize arg_max(UpdatedOn, *) by SystemID, MSEGNAME, ALUNIQNUM, ALINDEX, OBJECTNAME, FIELDNAME, MonitorName, MonitorSetName\n",
                "functionParameters": "",
                "version": 2,
                "tags": [
                    {
                        "name": "description",
                        "value": "SAPXalAlerts"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
            "apiVersion": "2022-01-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId39'),'/'))))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[variables('_parserId39')]"
            ],
            "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPXalAlerts')]",
                "contentId": "[variables('parserObject39').parserContentId39]",
                "kind": "Parser",
                "version": "[variables('parserObject39').parserVersion39]",
                "source": {
                    "kind": "Solution",
                    "name": "SAP",
                    "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                    "name": "Microsoft",
                    "email": "[variables('_email')]"
                },
                "support": {
                    "tier": "Microsoft",
                    "name": "Microsoft Corporation",
                    "email": "support@microsoft.com",
                    "link": "https://support.microsoft.com/"
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('parserTemplateSpecName40')]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAPXalMonitorSetsTree Data Parser with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('parserObject40').parserVersion40]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "name": "[variables('parserObject40')._parserName40]",
                            "apiVersion": "2022-10-01",
                            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "eTag": "*",
                                "displayName": "SAPXalMonitorSetsTree",
                                "category": "SAPFunctions",
                                "functionAlias": "SAPXalMonitorSetsTree",
                                "query": "//generated function structure for custom log XalMonitorSetsTree_CL\n//generated on 2023-02-26\n//Sentinel4SAP solution version 2.0.56\nlet D_XalMonitorSetsTree_CL = datatable(TimeGenerated:datetime\n,MonitorSetName:string\n,MonitorName:string\n,Type:string\n)['1000-01-01T00:00:00Z','initialString','initialString','initialString'];\nlet T_XalMonitorSetsTree_CL = (XalMonitorSetsTree_CL | project\nTimeGenerated = column_ifexists('TimeGenerated', '1000-01-01T00:00:00Z')\n,MonitorSetName = column_ifexists('MonitorSetName_s', 'initialString')\n,MonitorName = column_ifexists('MonitorName_s', 'initialString')\n,Type = column_ifexists('Type', 'initialString'));\nT_XalMonitorSetsTree_CL | union isfuzzy= true (D_XalMonitorSetsTree_CL  | where TimeGenerated != '1000-01-01T00:00:00Z')\n| summarize TimeGenerated = arg_max(TimeGenerated, *) by MonitorSetName, MonitorName, Type\n",
                                "functionParameters": "",
                                "version": 2,
                                "tags": [
                                    {
                                        "name": "description",
                                        "value": "SAPXalMonitorSetsTree"
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId40'),'/'))))]",
                            "dependsOn": [
                                "[variables('_parserId40')]"
                            ],
                            "properties": {
                                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPXalMonitorSetsTree')]",
                                "contentId": "[variables('parserObject40').parserContentId40]",
                                "kind": "Parser",
                                "version": "[variables('parserObject40').parserVersion40]",
                                "source": {
                                    "name": "SAP",
                                    "kind": "Solution",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('parserObject40').parserContentId40]",
                "contentKind": "Parser",
                "displayName": "SAPXalMonitorSetsTree",
                "contentProductId": "[variables('_parsercontentProductId40')]",
                "id": "[variables('_parsercontentProductId40')]",
                "version": "[variables('parserObject40').parserVersion40]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
            "apiVersion": "2022-10-01",
            "name": "[variables('parserObject40')._parserName40]",
            "location": "[parameters('workspace-location')]",
            "properties": {
                "eTag": "*",
                "displayName": "SAPXalMonitorSetsTree",
                "category": "SAPFunctions",
                "functionAlias": "SAPXalMonitorSetsTree",
                "query": "//generated function structure for custom log XalMonitorSetsTree_CL\n//generated on 2023-02-26\n//Sentinel4SAP solution version 2.0.56\nlet D_XalMonitorSetsTree_CL = datatable(TimeGenerated:datetime\n,MonitorSetName:string\n,MonitorName:string\n,Type:string\n)['1000-01-01T00:00:00Z','initialString','initialString','initialString'];\nlet T_XalMonitorSetsTree_CL = (XalMonitorSetsTree_CL | project\nTimeGenerated = column_ifexists('TimeGenerated', '1000-01-01T00:00:00Z')\n,MonitorSetName = column_ifexists('MonitorSetName_s', 'initialString')\n,MonitorName = column_ifexists('MonitorName_s', 'initialString')\n,Type = column_ifexists('Type', 'initialString'));\nT_XalMonitorSetsTree_CL | union isfuzzy= true (D_XalMonitorSetsTree_CL  | where TimeGenerated != '1000-01-01T00:00:00Z')\n| summarize TimeGenerated = arg_max(TimeGenerated, *) by MonitorSetName, MonitorName, Type\n",
                "functionParameters": "",
                "version": 2,
                "tags": [
                    {
                        "name": "description",
                        "value": "SAPXalMonitorSetsTree"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
            "apiVersion": "2022-01-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId40'),'/'))))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[variables('_parserId40')]"
            ],
            "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPXalMonitorSetsTree')]",
                "contentId": "[variables('parserObject40').parserContentId40]",
                "kind": "Parser",
                "version": "[variables('parserObject40').parserVersion40]",
                "source": {
                    "kind": "Solution",
                    "name": "SAP",
                    "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                    "name": "Microsoft",
                    "email": "[variables('_email')]"
                },
                "support": {
                    "tier": "Microsoft",
                    "name": "Microsoft Corporation",
                    "email": "support@microsoft.com",
                    "link": "https://support.microsoft.com/"
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('parserTemplateSpecName41')]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAPXalPerformance Data Parser with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('parserObject41').parserVersion41]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "name": "[variables('parserObject41')._parserName41]",
                            "apiVersion": "2022-10-01",
                            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "eTag": "*",
                                "displayName": "SAPXalPerformance",
                                "category": "SAPFunctions",
                                "functionAlias": "SAPXalPerformance",
                                "query": "//generated function structure for custom log XalPerformance_CL\n//generated on 2023-02-26\n//Sentinel4SAP solution version 2.0.56\nlet Colors = dynamic (['Unclear','Green', 'Yellow', 'Red', 'Header',  'Footer']);\nlet D_XalPerformance_CL = datatable(TimeGenerated:datetime\n,MonitorName:string\n,MonitorSetName:string\n,MonitoringTypeName:string\n,ObjectName:string\n,RelevantMeasuredValue:real\n,DateOfRelevantMeasuredValue:string\n,TimeOfRelevantMeasuredValue:string\n,RelevantAlertStatus:real\n,LastReportedValue:real\n,AverageValueOfLastMinute:real\n,AverageValueOfLast5Minutes:real\n,AverageValueOfLast15Minutes:real\n,TotalValuesOfLastMinute:real\n,TotalValuesOfLast5Minutes:real\n,TotalValuesOfLast15Minutes:real\n,NumberOfMeasurementsAtLastMinute:real\n,NumberOfMeasurementsAtLast5Minutes:real\n,NumberOfMeasurementsAtLast15Minutes:real\n,MaxMeasuredValue:real\n,DateOfMaxMeasuredValue:string\n,TimeOfMaxMeasuredValue:string\n,MinMeasuredValue:real\n,DateOfMinMeasuredValue:string\n,TimeOfMinMeasuredValue:string\n,MTMCNAME:string\n,SystemID:string\n,Type:string\n)['1000-01-01T00:00:00Z','initialString','initialString','initialString','initialString',1.1111,'initialString','initialString',1.1111,1.1111,1.1111,1.1111,1.1111,1.1111,1.1111,1.1111,1.1111,1.1111,1.1111,1.1111,'initialString','initialString',1.1111,'initialString','initialString','initialString','initialString','initialString'];\nlet T_XalPerformance_CL = (XalPerformance_CL | project\nTimeGenerated = column_ifexists('TimeGenerated', '1000-01-01T00:00:00Z')\n,MonitorName = column_ifexists('MonitorName_s', 'initialString')\n,MonitorSetName = translate('[]\"','',column_ifexists('MonitorSetName_s', 'initialString'))\n,MonitoringTypeName = column_ifexists('MonitoringTypeName_s', 'initialString')\n,ObjectName = column_ifexists('ObjectName_s', 'initialString')\n,RelevantMeasuredValue = column_ifexists('RelevantMeasuredValue_d', 1.1111)\n,DateOfRelevantMeasuredValue = column_ifexists('DateOfRelevantMeasuredValue_s', 'initialString')\n,TimeOfRelevantMeasuredValue = column_ifexists('TimeOfRelevantMeasuredValue_s', 'initialString')\n,RelevantAlertStatus = column_ifexists('RelevantAlertStatus_d', 1.1111)\n,LastReportedValue = column_ifexists('LastReportedValue_d', 1.1111)\n,AverageValueOfLastMinute = column_ifexists('AverageValueOfLastMinute_d', 1.1111)\n,AverageValueOfLast5Minutes = column_ifexists('AverageValueOfLast5Minutes_d', 1.1111)\n,AverageValueOfLast15Minutes = column_ifexists('AverageValueOfLast15Minutes_d', 1.1111)\n,TotalValuesOfLastMinute = column_ifexists('TotalValuesOfLastMinute_d', 1.1111)\n,TotalValuesOfLast5Minutes = column_ifexists('TotalValuesOfLast5Minutes_d', 1.1111)\n,TotalValuesOfLast15Minutes = column_ifexists('TotalValuesOfLast15Minutes_d', 1.1111)\n,NumberOfMeasurementsAtLastMinute = column_ifexists('NumberOfMeasurementsAtLastMinute_d', 1.1111)\n,NumberOfMeasurementsAtLast5Minutes = column_ifexists('NumberOfMeasurementsAtLast5Minutes_d', 1.1111)\n,NumberOfMeasurementsAtLast15Minutes = column_ifexists('NumberOfMeasurementsAtLast15Minutes_d', 1.1111)\n,MaxMeasuredValue = column_ifexists('MaxMeasuredValue_d', 1.1111)\n,DateOfMaxMeasuredValue = column_ifexists('DateOfMaxMeasuredValue_s', 'initialString')\n,TimeOfMaxMeasuredValue = column_ifexists('TimeOfMaxMeasuredValue_s', 'initialString')\n,MinMeasuredValue = column_ifexists('MinMeasuredValue_d', 1.1111)\n,DateOfMinMeasuredValue = column_ifexists('DateOfMinMeasuredValue_s', 'initialString')\n,TimeOfMinMeasuredValue = column_ifexists('TimeOfMinMeasuredValue_s', 'initialString')\n,MTMCNAME = column_ifexists('MTMCNAME_s', 'initialString')\n,SystemID = column_ifexists('MTSYSID_s', 'initialString')\n,Type = column_ifexists('Type', 'initialString'));\nT_XalPerformance_CL | union isfuzzy= true (D_XalPerformance_CL  | where MonitorName != 'initialString')\n| extend UpdatedOn= iff(DateOfRelevantMeasuredValue startswith(\" \"), TimeGenerated, todatetime(strcat(DateOfRelevantMeasuredValue, TimeOfRelevantMeasuredValue)))\n| extend Color= Colors[toint(RelevantAlertStatus)]\n| extend MonitorSetName= substring(MonitorSetName, 4, strlen(MonitorSetName)-6)\n| summarize arg_max(TimeGenerated, *) by MonitorName, MonitorSetName, MonitoringTypeName, ObjectName, UpdatedOn\n| sort by MonitorName, MonitorSetName, ObjectName,MonitoringTypeName, UpdatedOn desc\n| extend MonitoringTypeNObject= strcat(MonitoringTypeName, ObjectName)\n| extend ReverseOrder= row_number(1, prev(MonitoringTypeNObject) != MonitoringTypeNObject)\n\n",
                                "functionParameters": "",
                                "version": 2,
                                "tags": [
                                    {
                                        "name": "description",
                                        "value": "SAPXalPerformance"
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId41'),'/'))))]",
                            "dependsOn": [
                                "[variables('_parserId41')]"
                            ],
                            "properties": {
                                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPXalPerformance')]",
                                "contentId": "[variables('parserObject41').parserContentId41]",
                                "kind": "Parser",
                                "version": "[variables('parserObject41').parserVersion41]",
                                "source": {
                                    "name": "SAP",
                                    "kind": "Solution",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('parserObject41').parserContentId41]",
                "contentKind": "Parser",
                "displayName": "SAPXalPerformance",
                "contentProductId": "[variables('_parsercontentProductId41')]",
                "id": "[variables('_parsercontentProductId41')]",
                "version": "[variables('parserObject41').parserVersion41]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
            "apiVersion": "2022-10-01",
            "name": "[variables('parserObject41')._parserName41]",
            "location": "[parameters('workspace-location')]",
            "properties": {
                "eTag": "*",
                "displayName": "SAPXalPerformance",
                "category": "SAPFunctions",
                "functionAlias": "SAPXalPerformance",
                "query": "//generated function structure for custom log XalPerformance_CL\n//generated on 2023-02-26\n//Sentinel4SAP solution version 2.0.56\nlet Colors = dynamic (['Unclear','Green', 'Yellow', 'Red', 'Header',  'Footer']);\nlet D_XalPerformance_CL = datatable(TimeGenerated:datetime\n,MonitorName:string\n,MonitorSetName:string\n,MonitoringTypeName:string\n,ObjectName:string\n,RelevantMeasuredValue:real\n,DateOfRelevantMeasuredValue:string\n,TimeOfRelevantMeasuredValue:string\n,RelevantAlertStatus:real\n,LastReportedValue:real\n,AverageValueOfLastMinute:real\n,AverageValueOfLast5Minutes:real\n,AverageValueOfLast15Minutes:real\n,TotalValuesOfLastMinute:real\n,TotalValuesOfLast5Minutes:real\n,TotalValuesOfLast15Minutes:real\n,NumberOfMeasurementsAtLastMinute:real\n,NumberOfMeasurementsAtLast5Minutes:real\n,NumberOfMeasurementsAtLast15Minutes:real\n,MaxMeasuredValue:real\n,DateOfMaxMeasuredValue:string\n,TimeOfMaxMeasuredValue:string\n,MinMeasuredValue:real\n,DateOfMinMeasuredValue:string\n,TimeOfMinMeasuredValue:string\n,MTMCNAME:string\n,SystemID:string\n,Type:string\n)['1000-01-01T00:00:00Z','initialString','initialString','initialString','initialString',1.1111,'initialString','initialString',1.1111,1.1111,1.1111,1.1111,1.1111,1.1111,1.1111,1.1111,1.1111,1.1111,1.1111,1.1111,'initialString','initialString',1.1111,'initialString','initialString','initialString','initialString','initialString'];\nlet T_XalPerformance_CL = (XalPerformance_CL | project\nTimeGenerated = column_ifexists('TimeGenerated', '1000-01-01T00:00:00Z')\n,MonitorName = column_ifexists('MonitorName_s', 'initialString')\n,MonitorSetName = translate('[]\"','',column_ifexists('MonitorSetName_s', 'initialString'))\n,MonitoringTypeName = column_ifexists('MonitoringTypeName_s', 'initialString')\n,ObjectName = column_ifexists('ObjectName_s', 'initialString')\n,RelevantMeasuredValue = column_ifexists('RelevantMeasuredValue_d', 1.1111)\n,DateOfRelevantMeasuredValue = column_ifexists('DateOfRelevantMeasuredValue_s', 'initialString')\n,TimeOfRelevantMeasuredValue = column_ifexists('TimeOfRelevantMeasuredValue_s', 'initialString')\n,RelevantAlertStatus = column_ifexists('RelevantAlertStatus_d', 1.1111)\n,LastReportedValue = column_ifexists('LastReportedValue_d', 1.1111)\n,AverageValueOfLastMinute = column_ifexists('AverageValueOfLastMinute_d', 1.1111)\n,AverageValueOfLast5Minutes = column_ifexists('AverageValueOfLast5Minutes_d', 1.1111)\n,AverageValueOfLast15Minutes = column_ifexists('AverageValueOfLast15Minutes_d', 1.1111)\n,TotalValuesOfLastMinute = column_ifexists('TotalValuesOfLastMinute_d', 1.1111)\n,TotalValuesOfLast5Minutes = column_ifexists('TotalValuesOfLast5Minutes_d', 1.1111)\n,TotalValuesOfLast15Minutes = column_ifexists('TotalValuesOfLast15Minutes_d', 1.1111)\n,NumberOfMeasurementsAtLastMinute = column_ifexists('NumberOfMeasurementsAtLastMinute_d', 1.1111)\n,NumberOfMeasurementsAtLast5Minutes = column_ifexists('NumberOfMeasurementsAtLast5Minutes_d', 1.1111)\n,NumberOfMeasurementsAtLast15Minutes = column_ifexists('NumberOfMeasurementsAtLast15Minutes_d', 1.1111)\n,MaxMeasuredValue = column_ifexists('MaxMeasuredValue_d', 1.1111)\n,DateOfMaxMeasuredValue = column_ifexists('DateOfMaxMeasuredValue_s', 'initialString')\n,TimeOfMaxMeasuredValue = column_ifexists('TimeOfMaxMeasuredValue_s', 'initialString')\n,MinMeasuredValue = column_ifexists('MinMeasuredValue_d', 1.1111)\n,DateOfMinMeasuredValue = column_ifexists('DateOfMinMeasuredValue_s', 'initialString')\n,TimeOfMinMeasuredValue = column_ifexists('TimeOfMinMeasuredValue_s', 'initialString')\n,MTMCNAME = column_ifexists('MTMCNAME_s', 'initialString')\n,SystemID = column_ifexists('MTSYSID_s', 'initialString')\n,Type = column_ifexists('Type', 'initialString'));\nT_XalPerformance_CL | union isfuzzy= true (D_XalPerformance_CL  | where MonitorName != 'initialString')\n| extend UpdatedOn= iff(DateOfRelevantMeasuredValue startswith(\" \"), TimeGenerated, todatetime(strcat(DateOfRelevantMeasuredValue, TimeOfRelevantMeasuredValue)))\n| extend Color= Colors[toint(RelevantAlertStatus)]\n| extend MonitorSetName= substring(MonitorSetName, 4, strlen(MonitorSetName)-6)\n| summarize arg_max(TimeGenerated, *) by MonitorName, MonitorSetName, MonitoringTypeName, ObjectName, UpdatedOn\n| sort by MonitorName, MonitorSetName, ObjectName,MonitoringTypeName, UpdatedOn desc\n| extend MonitoringTypeNObject= strcat(MonitoringTypeName, ObjectName)\n| extend ReverseOrder= row_number(1, prev(MonitoringTypeNObject) != MonitoringTypeNObject)\n\n",
                "functionParameters": "",
                "version": 2,
                "tags": [
                    {
                        "name": "description",
                        "value": "SAPXalPerformance"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
            "apiVersion": "2022-01-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId41'),'/'))))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[variables('_parserId41')]"
            ],
            "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAPXalPerformance')]",
                "contentId": "[variables('parserObject41').parserContentId41]",
                "kind": "Parser",
                "version": "[variables('parserObject41').parserVersion41]",
                "source": {
                    "kind": "Solution",
                    "name": "SAP",
                    "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                    "name": "Microsoft",
                    "email": "[variables('_email')]"
                },
                "support": {
                    "tier": "Microsoft",
                    "name": "Microsoft Corporation",
                    "email": "support@microsoft.com",
                    "link": "https://support.microsoft.com/"
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('parserTemplateSpecName42')]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP_ADCP Data Parser with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('parserObject42').parserVersion42]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "name": "[variables('parserObject42')._parserName42]",
                            "apiVersion": "2022-10-01",
                            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "eTag": "*",
                                "displayName": "SAP_ADCP",
                                "category": "SAPFunctions",
                                "functionAlias": "SAP_ADCP",
                                "query": "[replace(variables('SAPFunctionsSAP_ADCPQuery'),'CWSQSAP.', if(equals(coalesce(parameters('CWSQSAPIdentifier'),''),'') , '', concat(variables('CWSQIdentifierPrefix'), parameters('CWSQSAPIdentifier'),variables('CWQSIdentifierSuffix'))))]",
                                "functionParameters": "",
                                "version": 2,
                                "tags": [
                                    {
                                        "name": "description",
                                        "value": "SAP_ADCP"
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId42'),'/'))))]",
                            "dependsOn": [
                                "[variables('_parserId42')]"
                            ],
                            "properties": {
                                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAP_ADCP')]",
                                "contentId": "[variables('parserObject42').parserContentId42]",
                                "kind": "Parser",
                                "version": "[variables('parserObject42').parserVersion42]",
                                "source": {
                                    "name": "SAP",
                                    "kind": "Solution",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('parserObject42').parserContentId42]",
                "contentKind": "Parser",
                "displayName": "SAP_ADCP",
                "contentProductId": "[variables('_parsercontentProductId42')]",
                "id": "[variables('_parsercontentProductId42')]",
                "version": "[variables('parserObject42').parserVersion42]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
            "apiVersion": "2022-10-01",
            "name": "[variables('parserObject42')._parserName42]",
            "location": "[parameters('workspace-location')]",
            "properties": {
                "eTag": "*",
                "displayName": "SAP_ADCP",
                "category": "SAPFunctions",
                "functionAlias": "SAP_ADCP",
                "query": "[replace(variables('SAPFunctionsSAP_ADCPQuery'),'CWSQSAP.', if(equals(coalesce(parameters('CWSQSAPIdentifier'),''),'') , '', concat(variables('CWSQIdentifierPrefix'), parameters('CWSQSAPIdentifier'),variables('CWQSIdentifierSuffix'))))]",
                "functionParameters": "",
                "version": 2,
                "tags": [
                    {
                        "name": "description",
                        "value": "SAP_ADCP"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
            "apiVersion": "2022-01-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId42'),'/'))))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[variables('_parserId42')]"
            ],
            "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAP_ADCP')]",
                "contentId": "[variables('parserObject42').parserContentId42]",
                "kind": "Parser",
                "version": "[variables('parserObject42').parserVersion42]",
                "source": {
                    "kind": "Solution",
                    "name": "SAP",
                    "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                    "name": "Microsoft",
                    "email": "[variables('_email')]"
                },
                "support": {
                    "tier": "Microsoft",
                    "name": "Microsoft Corporation",
                    "email": "support@microsoft.com",
                    "link": "https://support.microsoft.com/"
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('parserTemplateSpecName43')]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP_ADR6 Data Parser with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('parserObject43').parserVersion43]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "name": "[variables('parserObject43')._parserName43]",
                            "apiVersion": "2022-10-01",
                            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "eTag": "*",
                                "displayName": "SAP_ADR6",
                                "category": "SAPFunctions",
                                "functionAlias": "SAP_ADR6",
                                "query": "[replace(variables('SAPFunctionsSAP_ADR6Query'),'CWSQSAP.', if(equals(coalesce(parameters('CWSQSAPIdentifier'),''),'') , '', concat(variables('CWSQIdentifierPrefix'), parameters('CWSQSAPIdentifier'),variables('CWQSIdentifierSuffix'))))]",
                                "functionParameters": "",
                                "version": 2,
                                "tags": [
                                    {
                                        "name": "description",
                                        "value": "SAP_ADR6"
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId43'),'/'))))]",
                            "dependsOn": [
                                "[variables('_parserId43')]"
                            ],
                            "properties": {
                                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAP_ADR6')]",
                                "contentId": "[variables('parserObject43').parserContentId43]",
                                "kind": "Parser",
                                "version": "[variables('parserObject43').parserVersion43]",
                                "source": {
                                    "name": "SAP",
                                    "kind": "Solution",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('parserObject43').parserContentId43]",
                "contentKind": "Parser",
                "displayName": "SAP_ADR6",
                "contentProductId": "[variables('_parsercontentProductId43')]",
                "id": "[variables('_parsercontentProductId43')]",
                "version": "[variables('parserObject43').parserVersion43]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
            "apiVersion": "2022-10-01",
            "name": "[variables('parserObject43')._parserName43]",
            "location": "[parameters('workspace-location')]",
            "properties": {
                "eTag": "*",
                "displayName": "SAP_ADR6",
                "category": "SAPFunctions",
                "functionAlias": "SAP_ADR6",
                "query": "[replace(variables('SAPFunctionsSAP_ADR6Query'),'CWSQSAP.', if(equals(coalesce(parameters('CWSQSAPIdentifier'),''),'') , '', concat(variables('CWSQIdentifierPrefix'), parameters('CWSQSAPIdentifier'),variables('CWQSIdentifierSuffix'))))]",
                "functionParameters": "",
                "version": 2,
                "tags": [
                    {
                        "name": "description",
                        "value": "SAP_ADR6"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
            "apiVersion": "2022-01-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId43'),'/'))))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[variables('_parserId43')]"
            ],
            "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAP_ADR6')]",
                "contentId": "[variables('parserObject43').parserContentId43]",
                "kind": "Parser",
                "version": "[variables('parserObject43').parserVersion43]",
                "source": {
                    "kind": "Solution",
                    "name": "SAP",
                    "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                    "name": "Microsoft",
                    "email": "[variables('_email')]"
                },
                "support": {
                    "tier": "Microsoft",
                    "name": "Microsoft Corporation",
                    "email": "support@microsoft.com",
                    "link": "https://support.microsoft.com/"
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('parserTemplateSpecName44')]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP_AGR_1251 Data Parser with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('parserObject44').parserVersion44]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "name": "[variables('parserObject44')._parserName44]",
                            "apiVersion": "2022-10-01",
                            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "eTag": "*",
                                "displayName": "SAP_AGR_1251",
                                "category": "SAPFunctions",
                                "functionAlias": "SAP_AGR_1251",
                                "query": "[replace(variables('SAPFunctionsSAP_AGR_1251Query'),'CWSQSAP.', if(equals(coalesce(parameters('CWSQSAPIdentifier'),''),'') , '', concat(variables('CWSQIdentifierPrefix'), parameters('CWSQSAPIdentifier'),variables('CWQSIdentifierSuffix'))))]",
                                "functionParameters": "",
                                "version": 2,
                                "tags": [
                                    {
                                        "name": "description",
                                        "value": "SAP_AGR_1251"
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId44'),'/'))))]",
                            "dependsOn": [
                                "[variables('_parserId44')]"
                            ],
                            "properties": {
                                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAP_AGR_1251')]",
                                "contentId": "[variables('parserObject44').parserContentId44]",
                                "kind": "Parser",
                                "version": "[variables('parserObject44').parserVersion44]",
                                "source": {
                                    "name": "SAP",
                                    "kind": "Solution",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('parserObject44').parserContentId44]",
                "contentKind": "Parser",
                "displayName": "SAP_AGR_1251",
                "contentProductId": "[variables('_parsercontentProductId44')]",
                "id": "[variables('_parsercontentProductId44')]",
                "version": "[variables('parserObject44').parserVersion44]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
            "apiVersion": "2022-10-01",
            "name": "[variables('parserObject44')._parserName44]",
            "location": "[parameters('workspace-location')]",
            "properties": {
                "eTag": "*",
                "displayName": "SAP_AGR_1251",
                "category": "SAPFunctions",
                "functionAlias": "SAP_AGR_1251",
                "query": "[replace(variables('SAPFunctionsSAP_AGR_1251Query'),'CWSQSAP.', if(equals(coalesce(parameters('CWSQSAPIdentifier'),''),'') , '', concat(variables('CWSQIdentifierPrefix'), parameters('CWSQSAPIdentifier'),variables('CWQSIdentifierSuffix'))))]",
                "functionParameters": "",
                "version": 2,
                "tags": [
                    {
                        "name": "description",
                        "value": "SAP_AGR_1251"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
            "apiVersion": "2022-01-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId44'),'/'))))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[variables('_parserId44')]"
            ],
            "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAP_AGR_1251')]",
                "contentId": "[variables('parserObject44').parserContentId44]",
                "kind": "Parser",
                "version": "[variables('parserObject44').parserVersion44]",
                "source": {
                    "kind": "Solution",
                    "name": "SAP",
                    "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                    "name": "Microsoft",
                    "email": "[variables('_email')]"
                },
                "support": {
                    "tier": "Microsoft",
                    "name": "Microsoft Corporation",
                    "email": "support@microsoft.com",
                    "link": "https://support.microsoft.com/"
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('parserTemplateSpecName45')]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP_AGR_AGRS Data Parser with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('parserObject45').parserVersion45]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "name": "[variables('parserObject45')._parserName45]",
                            "apiVersion": "2022-10-01",
                            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "eTag": "*",
                                "displayName": "SAP_AGR_AGRS",
                                "category": "SAPFunctions",
                                "functionAlias": "SAP_AGR_AGRS",
                                "query": "[replace(variables('SAPFunctionsSAP_AGR_AGRSQuery'),'CWSQSAP.', if(equals(coalesce(parameters('CWSQSAPIdentifier'),''),'') , '', concat(variables('CWSQIdentifierPrefix'), parameters('CWSQSAPIdentifier'),variables('CWQSIdentifierSuffix'))))]",
                                "functionParameters": "",
                                "version": 2,
                                "tags": [
                                    {
                                        "name": "description",
                                        "value": "SAP_AGR_AGRS"
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId45'),'/'))))]",
                            "dependsOn": [
                                "[variables('_parserId45')]"
                            ],
                            "properties": {
                                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAP_AGR_AGRS')]",
                                "contentId": "[variables('parserObject45').parserContentId45]",
                                "kind": "Parser",
                                "version": "[variables('parserObject45').parserVersion45]",
                                "source": {
                                    "name": "SAP",
                                    "kind": "Solution",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('parserObject45').parserContentId45]",
                "contentKind": "Parser",
                "displayName": "SAP_AGR_AGRS",
                "contentProductId": "[variables('_parsercontentProductId45')]",
                "id": "[variables('_parsercontentProductId45')]",
                "version": "[variables('parserObject45').parserVersion45]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
            "apiVersion": "2022-10-01",
            "name": "[variables('parserObject45')._parserName45]",
            "location": "[parameters('workspace-location')]",
            "properties": {
                "eTag": "*",
                "displayName": "SAP_AGR_AGRS",
                "category": "SAPFunctions",
                "functionAlias": "SAP_AGR_AGRS",
                "query": "[replace(variables('SAPFunctionsSAP_AGR_AGRSQuery'),'CWSQSAP.', if(equals(coalesce(parameters('CWSQSAPIdentifier'),''),'') , '', concat(variables('CWSQIdentifierPrefix'), parameters('CWSQSAPIdentifier'),variables('CWQSIdentifierSuffix'))))]",
                "functionParameters": "",
                "version": 2,
                "tags": [
                    {
                        "name": "description",
                        "value": "SAP_AGR_AGRS"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
            "apiVersion": "2022-01-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId45'),'/'))))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[variables('_parserId45')]"
            ],
            "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAP_AGR_AGRS')]",
                "contentId": "[variables('parserObject45').parserContentId45]",
                "kind": "Parser",
                "version": "[variables('parserObject45').parserVersion45]",
                "source": {
                    "kind": "Solution",
                    "name": "SAP",
                    "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                    "name": "Microsoft",
                    "email": "[variables('_email')]"
                },
                "support": {
                    "tier": "Microsoft",
                    "name": "Microsoft Corporation",
                    "email": "support@microsoft.com",
                    "link": "https://support.microsoft.com/"
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('parserTemplateSpecName46')]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP_AGR_DEFINE Data Parser with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('parserObject46').parserVersion46]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "name": "[variables('parserObject46')._parserName46]",
                            "apiVersion": "2022-10-01",
                            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "eTag": "*",
                                "displayName": "SAP_AGR_DEFINE",
                                "category": "SAPFunctions",
                                "functionAlias": "SAP_AGR_DEFINE",
                                "query": "[replace(variables('SAPFunctionsSAP_AGR_DEFINEQuery'),'CWSQSAP.', if(equals(coalesce(parameters('CWSQSAPIdentifier'),''),'') , '', concat(variables('CWSQIdentifierPrefix'), parameters('CWSQSAPIdentifier'),variables('CWQSIdentifierSuffix'))))]",
                                "functionParameters": "",
                                "version": 2,
                                "tags": [
                                    {
                                        "name": "description",
                                        "value": "SAP_AGR_DEFINE"
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId46'),'/'))))]",
                            "dependsOn": [
                                "[variables('_parserId46')]"
                            ],
                            "properties": {
                                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAP_AGR_DEFINE')]",
                                "contentId": "[variables('parserObject46').parserContentId46]",
                                "kind": "Parser",
                                "version": "[variables('parserObject46').parserVersion46]",
                                "source": {
                                    "name": "SAP",
                                    "kind": "Solution",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('parserObject46').parserContentId46]",
                "contentKind": "Parser",
                "displayName": "SAP_AGR_DEFINE",
                "contentProductId": "[variables('_parsercontentProductId46')]",
                "id": "[variables('_parsercontentProductId46')]",
                "version": "[variables('parserObject46').parserVersion46]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
            "apiVersion": "2022-10-01",
            "name": "[variables('parserObject46')._parserName46]",
            "location": "[parameters('workspace-location')]",
            "properties": {
                "eTag": "*",
                "displayName": "SAP_AGR_DEFINE",
                "category": "SAPFunctions",
                "functionAlias": "SAP_AGR_DEFINE",
                "query": "[replace(variables('SAPFunctionsSAP_AGR_DEFINEQuery'),'CWSQSAP.', if(equals(coalesce(parameters('CWSQSAPIdentifier'),''),'') , '', concat(variables('CWSQIdentifierPrefix'), parameters('CWSQSAPIdentifier'),variables('CWQSIdentifierSuffix'))))]",
                "functionParameters": "",
                "version": 2,
                "tags": [
                    {
                        "name": "description",
                        "value": "SAP_AGR_DEFINE"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
            "apiVersion": "2022-01-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId46'),'/'))))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[variables('_parserId46')]"
            ],
            "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAP_AGR_DEFINE')]",
                "contentId": "[variables('parserObject46').parserContentId46]",
                "kind": "Parser",
                "version": "[variables('parserObject46').parserVersion46]",
                "source": {
                    "kind": "Solution",
                    "name": "SAP",
                    "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                    "name": "Microsoft",
                    "email": "[variables('_email')]"
                },
                "support": {
                    "tier": "Microsoft",
                    "name": "Microsoft Corporation",
                    "email": "support@microsoft.com",
                    "link": "https://support.microsoft.com/"
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('parserTemplateSpecName47')]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP_AGR_FLAGS Data Parser with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('parserObject47').parserVersion47]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "name": "[variables('parserObject47')._parserName47]",
                            "apiVersion": "2022-10-01",
                            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "eTag": "*",
                                "displayName": "SAP_AGR_FLAGS",
                                "category": "SAPFunctions",
                                "functionAlias": "SAP_AGR_FLAGS",
                                "query": "[replace(variables('SAPFunctionsSAP_AGR_FLAGSQuery'),'CWSQSAP.', if(equals(coalesce(parameters('CWSQSAPIdentifier'),''),'') , '', concat(variables('CWSQIdentifierPrefix'), parameters('CWSQSAPIdentifier'),variables('CWQSIdentifierSuffix'))))]",
                                "functionParameters": "",
                                "version": 2,
                                "tags": [
                                    {
                                        "name": "description",
                                        "value": "SAP_AGR_FLAGS"
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId47'),'/'))))]",
                            "dependsOn": [
                                "[variables('_parserId47')]"
                            ],
                            "properties": {
                                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAP_AGR_FLAGS')]",
                                "contentId": "[variables('parserObject47').parserContentId47]",
                                "kind": "Parser",
                                "version": "[variables('parserObject47').parserVersion47]",
                                "source": {
                                    "name": "SAP",
                                    "kind": "Solution",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('parserObject47').parserContentId47]",
                "contentKind": "Parser",
                "displayName": "SAP_AGR_FLAGS",
                "contentProductId": "[variables('_parsercontentProductId47')]",
                "id": "[variables('_parsercontentProductId47')]",
                "version": "[variables('parserObject47').parserVersion47]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
            "apiVersion": "2022-10-01",
            "name": "[variables('parserObject47')._parserName47]",
            "location": "[parameters('workspace-location')]",
            "properties": {
                "eTag": "*",
                "displayName": "SAP_AGR_FLAGS",
                "category": "SAPFunctions",
                "functionAlias": "SAP_AGR_FLAGS",
                "query": "[replace(variables('SAPFunctionsSAP_AGR_FLAGSQuery'),'CWSQSAP.', if(equals(coalesce(parameters('CWSQSAPIdentifier'),''),'') , '', concat(variables('CWSQIdentifierPrefix'), parameters('CWSQSAPIdentifier'),variables('CWQSIdentifierSuffix'))))]",
                "functionParameters": "",
                "version": 2,
                "tags": [
                    {
                        "name": "description",
                        "value": "SAP_AGR_FLAGS"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
            "apiVersion": "2022-01-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId47'),'/'))))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[variables('_parserId47')]"
            ],
            "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAP_AGR_FLAGS')]",
                "contentId": "[variables('parserObject47').parserContentId47]",
                "kind": "Parser",
                "version": "[variables('parserObject47').parserVersion47]",
                "source": {
                    "kind": "Solution",
                    "name": "SAP",
                    "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                    "name": "Microsoft",
                    "email": "[variables('_email')]"
                },
                "support": {
                    "tier": "Microsoft",
                    "name": "Microsoft Corporation",
                    "email": "support@microsoft.com",
                    "link": "https://support.microsoft.com/"
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('parserTemplateSpecName48')]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP_AGR_PROF Data Parser with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('parserObject48').parserVersion48]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "name": "[variables('parserObject48')._parserName48]",
                            "apiVersion": "2022-10-01",
                            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "eTag": "*",
                                "displayName": "SAP_AGR_PROF",
                                "category": "SAPFunctions",
                                "functionAlias": "SAP_AGR_PROF",
                                "query": "[replace(variables('SAPFunctionsSAP_AGR_PROFQuery'),'CWSQSAP.', if(equals(coalesce(parameters('CWSQSAPIdentifier'),''),'') , '', concat(variables('CWSQIdentifierPrefix'), parameters('CWSQSAPIdentifier'),variables('CWQSIdentifierSuffix'))))]",
                                "functionParameters": "",
                                "version": 2,
                                "tags": [
                                    {
                                        "name": "description",
                                        "value": "SAP_AGR_PROF"
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId48'),'/'))))]",
                            "dependsOn": [
                                "[variables('_parserId48')]"
                            ],
                            "properties": {
                                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAP_AGR_PROF')]",
                                "contentId": "[variables('parserObject48').parserContentId48]",
                                "kind": "Parser",
                                "version": "[variables('parserObject48').parserVersion48]",
                                "source": {
                                    "name": "SAP",
                                    "kind": "Solution",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('parserObject48').parserContentId48]",
                "contentKind": "Parser",
                "displayName": "SAP_AGR_PROF",
                "contentProductId": "[variables('_parsercontentProductId48')]",
                "id": "[variables('_parsercontentProductId48')]",
                "version": "[variables('parserObject48').parserVersion48]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
            "apiVersion": "2022-10-01",
            "name": "[variables('parserObject48')._parserName48]",
            "location": "[parameters('workspace-location')]",
            "properties": {
                "eTag": "*",
                "displayName": "SAP_AGR_PROF",
                "category": "SAPFunctions",
                "functionAlias": "SAP_AGR_PROF",
                "query": "[replace(variables('SAPFunctionsSAP_AGR_PROFQuery'),'CWSQSAP.', if(equals(coalesce(parameters('CWSQSAPIdentifier'),''),'') , '', concat(variables('CWSQIdentifierPrefix'), parameters('CWSQSAPIdentifier'),variables('CWQSIdentifierSuffix'))))]",
                "functionParameters": "",
                "version": 2,
                "tags": [
                    {
                        "name": "description",
                        "value": "SAP_AGR_PROF"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
            "apiVersion": "2022-01-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId48'),'/'))))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[variables('_parserId48')]"
            ],
            "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAP_AGR_PROF')]",
                "contentId": "[variables('parserObject48').parserContentId48]",
                "kind": "Parser",
                "version": "[variables('parserObject48').parserVersion48]",
                "source": {
                    "kind": "Solution",
                    "name": "SAP",
                    "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                    "name": "Microsoft",
                    "email": "[variables('_email')]"
                },
                "support": {
                    "tier": "Microsoft",
                    "name": "Microsoft Corporation",
                    "email": "support@microsoft.com",
                    "link": "https://support.microsoft.com/"
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('parserTemplateSpecName49')]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP_AGR_TCODES Data Parser with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('parserObject49').parserVersion49]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "name": "[variables('parserObject49')._parserName49]",
                            "apiVersion": "2022-10-01",
                            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "eTag": "*",
                                "displayName": "SAP_AGR_TCODES",
                                "category": "SAPFunctions",
                                "functionAlias": "SAP_AGR_TCODES",
                                "query": "[replace(variables('SAPFunctionsSAP_AGR_TCODESQuery'),'CWSQSAP.', if(equals(coalesce(parameters('CWSQSAPIdentifier'),''),'') , '', concat(variables('CWSQIdentifierPrefix'), parameters('CWSQSAPIdentifier'),variables('CWQSIdentifierSuffix'))))]",
                                "functionParameters": "",
                                "version": 2,
                                "tags": [
                                    {
                                        "name": "description",
                                        "value": "SAP_AGR_TCODES"
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId49'),'/'))))]",
                            "dependsOn": [
                                "[variables('_parserId49')]"
                            ],
                            "properties": {
                                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAP_AGR_TCODES')]",
                                "contentId": "[variables('parserObject49').parserContentId49]",
                                "kind": "Parser",
                                "version": "[variables('parserObject49').parserVersion49]",
                                "source": {
                                    "name": "SAP",
                                    "kind": "Solution",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('parserObject49').parserContentId49]",
                "contentKind": "Parser",
                "displayName": "SAP_AGR_TCODES",
                "contentProductId": "[variables('_parsercontentProductId49')]",
                "id": "[variables('_parsercontentProductId49')]",
                "version": "[variables('parserObject49').parserVersion49]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
            "apiVersion": "2022-10-01",
            "name": "[variables('parserObject49')._parserName49]",
            "location": "[parameters('workspace-location')]",
            "properties": {
                "eTag": "*",
                "displayName": "SAP_AGR_TCODES",
                "category": "SAPFunctions",
                "functionAlias": "SAP_AGR_TCODES",
                "query": "[replace(variables('SAPFunctionsSAP_AGR_TCODESQuery'),'CWSQSAP.', if(equals(coalesce(parameters('CWSQSAPIdentifier'),''),'') , '', concat(variables('CWSQIdentifierPrefix'), parameters('CWSQSAPIdentifier'),variables('CWQSIdentifierSuffix'))))]",
                "functionParameters": "",
                "version": 2,
                "tags": [
                    {
                        "name": "description",
                        "value": "SAP_AGR_TCODES"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
            "apiVersion": "2022-01-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId49'),'/'))))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[variables('_parserId49')]"
            ],
            "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAP_AGR_TCODES')]",
                "contentId": "[variables('parserObject49').parserContentId49]",
                "kind": "Parser",
                "version": "[variables('parserObject49').parserVersion49]",
                "source": {
                    "kind": "Solution",
                    "name": "SAP",
                    "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                    "name": "Microsoft",
                    "email": "[variables('_email')]"
                },
                "support": {
                    "tier": "Microsoft",
                    "name": "Microsoft Corporation",
                    "email": "support@microsoft.com",
                    "link": "https://support.microsoft.com/"
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('parserTemplateSpecName50')]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP_AGR_USERS Data Parser with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('parserObject50').parserVersion50]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "name": "[variables('parserObject50')._parserName50]",
                            "apiVersion": "2022-10-01",
                            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "eTag": "*",
                                "displayName": "SAP_AGR_USERS",
                                "category": "SAPFunctions",
                                "functionAlias": "SAP_AGR_USERS",
                                "query": "[replace(variables('SAPFunctionsSAP_AGR_USERSQuery'),'CWSQSAP.', if(equals(coalesce(parameters('CWSQSAPIdentifier'),''),'') , '', concat(variables('CWSQIdentifierPrefix'), parameters('CWSQSAPIdentifier'),variables('CWQSIdentifierSuffix'))))]",
                                "functionParameters": "",
                                "version": 2,
                                "tags": [
                                    {
                                        "name": "description",
                                        "value": "SAP_AGR_USERS"
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId50'),'/'))))]",
                            "dependsOn": [
                                "[variables('_parserId50')]"
                            ],
                            "properties": {
                                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAP_AGR_USERS')]",
                                "contentId": "[variables('parserObject50').parserContentId50]",
                                "kind": "Parser",
                                "version": "[variables('parserObject50').parserVersion50]",
                                "source": {
                                    "name": "SAP",
                                    "kind": "Solution",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('parserObject50').parserContentId50]",
                "contentKind": "Parser",
                "displayName": "SAP_AGR_USERS",
                "contentProductId": "[variables('_parsercontentProductId50')]",
                "id": "[variables('_parsercontentProductId50')]",
                "version": "[variables('parserObject50').parserVersion50]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
            "apiVersion": "2022-10-01",
            "name": "[variables('parserObject50')._parserName50]",
            "location": "[parameters('workspace-location')]",
            "properties": {
                "eTag": "*",
                "displayName": "SAP_AGR_USERS",
                "category": "SAPFunctions",
                "functionAlias": "SAP_AGR_USERS",
                "query": "[replace(variables('SAPFunctionsSAP_AGR_USERSQuery'),'CWSQSAP.', if(equals(coalesce(parameters('CWSQSAPIdentifier'),''),'') , '', concat(variables('CWSQIdentifierPrefix'), parameters('CWSQSAPIdentifier'),variables('CWQSIdentifierSuffix'))))]",
                "functionParameters": "",
                "version": 2,
                "tags": [
                    {
                        "name": "description",
                        "value": "SAP_AGR_USERS"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
            "apiVersion": "2022-01-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId50'),'/'))))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[variables('_parserId50')]"
            ],
            "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAP_AGR_USERS')]",
                "contentId": "[variables('parserObject50').parserContentId50]",
                "kind": "Parser",
                "version": "[variables('parserObject50').parserVersion50]",
                "source": {
                    "kind": "Solution",
                    "name": "SAP",
                    "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                    "name": "Microsoft",
                    "email": "[variables('_email')]"
                },
                "support": {
                    "tier": "Microsoft",
                    "name": "Microsoft Corporation",
                    "email": "support@microsoft.com",
                    "link": "https://support.microsoft.com/"
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('parserTemplateSpecName51')]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP_DEVACCESS Data Parser with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('parserObject51').parserVersion51]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "name": "[variables('parserObject51')._parserName51]",
                            "apiVersion": "2022-10-01",
                            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "eTag": "*",
                                "displayName": "SAP_DEVACCESS",
                                "category": "SAPFunctions",
                                "functionAlias": "SAP_DEVACCESS",
                                "query": "[replace(variables('SAPFunctionsSAP_DEVACCESSQuery'),'CWSQSAP.', if(equals(coalesce(parameters('CWSQSAPIdentifier'),''),'') , '', concat(variables('CWSQIdentifierPrefix'), parameters('CWSQSAPIdentifier'),variables('CWQSIdentifierSuffix'))))]",
                                "functionParameters": "",
                                "version": 2,
                                "tags": [
                                    {
                                        "name": "description",
                                        "value": "SAP_DEVACCESS"
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId51'),'/'))))]",
                            "dependsOn": [
                                "[variables('_parserId51')]"
                            ],
                            "properties": {
                                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAP_DEVACCESS')]",
                                "contentId": "[variables('parserObject51').parserContentId51]",
                                "kind": "Parser",
                                "version": "[variables('parserObject51').parserVersion51]",
                                "source": {
                                    "name": "SAP",
                                    "kind": "Solution",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('parserObject51').parserContentId51]",
                "contentKind": "Parser",
                "displayName": "SAP_DEVACCESS",
                "contentProductId": "[variables('_parsercontentProductId51')]",
                "id": "[variables('_parsercontentProductId51')]",
                "version": "[variables('parserObject51').parserVersion51]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
            "apiVersion": "2022-10-01",
            "name": "[variables('parserObject51')._parserName51]",
            "location": "[parameters('workspace-location')]",
            "properties": {
                "eTag": "*",
                "displayName": "SAP_DEVACCESS",
                "category": "SAPFunctions",
                "functionAlias": "SAP_DEVACCESS",
                "query": "[replace(variables('SAPFunctionsSAP_DEVACCESSQuery'),'CWSQSAP.', if(equals(coalesce(parameters('CWSQSAPIdentifier'),''),'') , '', concat(variables('CWSQIdentifierPrefix'), parameters('CWSQSAPIdentifier'),variables('CWQSIdentifierSuffix'))))]",
                "functionParameters": "",
                "version": 2,
                "tags": [
                    {
                        "name": "description",
                        "value": "SAP_DEVACCESS"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
            "apiVersion": "2022-01-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId51'),'/'))))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[variables('_parserId51')]"
            ],
            "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAP_DEVACCESS')]",
                "contentId": "[variables('parserObject51').parserContentId51]",
                "kind": "Parser",
                "version": "[variables('parserObject51').parserVersion51]",
                "source": {
                    "kind": "Solution",
                    "name": "SAP",
                    "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                    "name": "Microsoft",
                    "email": "[variables('_email')]"
                },
                "support": {
                    "tier": "Microsoft",
                    "name": "Microsoft Corporation",
                    "email": "support@microsoft.com",
                    "link": "https://support.microsoft.com/"
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('parserTemplateSpecName52')]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP_PAHI Data Parser with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('parserObject52').parserVersion52]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "name": "[variables('parserObject52')._parserName52]",
                            "apiVersion": "2022-10-01",
                            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "eTag": "*",
                                "displayName": "SAP_PAHI",
                                "category": "SAPFunctions",
                                "functionAlias": "SAP_PAHI",
                                "query": "[replace(variables('SAPFunctionsSAP_PAHIQuery'),'CWSQSAP.', if(equals(coalesce(parameters('CWSQSAPIdentifier'),''),'') , '', concat(variables('CWSQIdentifierPrefix'), parameters('CWSQSAPIdentifier'),variables('CWQSIdentifierSuffix'))))]",
                                "functionParameters": "",
                                "version": 2,
                                "tags": [
                                    {
                                        "name": "description",
                                        "value": "SAP_PAHI"
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId52'),'/'))))]",
                            "dependsOn": [
                                "[variables('_parserId52')]"
                            ],
                            "properties": {
                                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAP_PAHI')]",
                                "contentId": "[variables('parserObject52').parserContentId52]",
                                "kind": "Parser",
                                "version": "[variables('parserObject52').parserVersion52]",
                                "source": {
                                    "name": "SAP",
                                    "kind": "Solution",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('parserObject52').parserContentId52]",
                "contentKind": "Parser",
                "displayName": "SAP_PAHI",
                "contentProductId": "[variables('_parsercontentProductId52')]",
                "id": "[variables('_parsercontentProductId52')]",
                "version": "[variables('parserObject52').parserVersion52]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
            "apiVersion": "2022-10-01",
            "name": "[variables('parserObject52')._parserName52]",
            "location": "[parameters('workspace-location')]",
            "properties": {
                "eTag": "*",
                "displayName": "SAP_PAHI",
                "category": "SAPFunctions",
                "functionAlias": "SAP_PAHI",
                "query": "[replace(variables('SAPFunctionsSAP_PAHIQuery'),'CWSQSAP.', if(equals(coalesce(parameters('CWSQSAPIdentifier'),''),'') , '', concat(variables('CWSQIdentifierPrefix'), parameters('CWSQSAPIdentifier'),variables('CWQSIdentifierSuffix'))))]",
                "functionParameters": "",
                "version": 2,
                "tags": [
                    {
                        "name": "description",
                        "value": "SAP_PAHI"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
            "apiVersion": "2022-01-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId52'),'/'))))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[variables('_parserId52')]"
            ],
            "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAP_PAHI')]",
                "contentId": "[variables('parserObject52').parserContentId52]",
                "kind": "Parser",
                "version": "[variables('parserObject52').parserVersion52]",
                "source": {
                    "kind": "Solution",
                    "name": "SAP",
                    "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                    "name": "Microsoft",
                    "email": "[variables('_email')]"
                },
                "support": {
                    "tier": "Microsoft",
                    "name": "Microsoft Corporation",
                    "email": "support@microsoft.com",
                    "link": "https://support.microsoft.com/"
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('parserTemplateSpecName53')]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP_USGRP_USER Data Parser with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('parserObject53').parserVersion53]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "name": "[variables('parserObject53')._parserName53]",
                            "apiVersion": "2022-10-01",
                            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "eTag": "*",
                                "displayName": "SAP_USGRP_USER",
                                "category": "SAPFunctions",
                                "functionAlias": "SAP_USGRP_USER",
                                "query": "[replace(variables('SAPFunctionsSAP_USGRP_USERQuery'),'CWSQSAP.', if(equals(coalesce(parameters('CWSQSAPIdentifier'),''),'') , '', concat(variables('CWSQIdentifierPrefix'), parameters('CWSQSAPIdentifier'),variables('CWQSIdentifierSuffix'))))]",
                                "functionParameters": "",
                                "version": 2,
                                "tags": [
                                    {
                                        "name": "description",
                                        "value": "SAP_USGRP_USER"
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId53'),'/'))))]",
                            "dependsOn": [
                                "[variables('_parserId53')]"
                            ],
                            "properties": {
                                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAP_USGRP_USER')]",
                                "contentId": "[variables('parserObject53').parserContentId53]",
                                "kind": "Parser",
                                "version": "[variables('parserObject53').parserVersion53]",
                                "source": {
                                    "name": "SAP",
                                    "kind": "Solution",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('parserObject53').parserContentId53]",
                "contentKind": "Parser",
                "displayName": "SAP_USGRP_USER",
                "contentProductId": "[variables('_parsercontentProductId53')]",
                "id": "[variables('_parsercontentProductId53')]",
                "version": "[variables('parserObject53').parserVersion53]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
            "apiVersion": "2022-10-01",
            "name": "[variables('parserObject53')._parserName53]",
            "location": "[parameters('workspace-location')]",
            "properties": {
                "eTag": "*",
                "displayName": "SAP_USGRP_USER",
                "category": "SAPFunctions",
                "functionAlias": "SAP_USGRP_USER",
                "query": "[replace(variables('SAPFunctionsSAP_USGRP_USERQuery'),'CWSQSAP.', if(equals(coalesce(parameters('CWSQSAPIdentifier'),''),'') , '', concat(variables('CWSQIdentifierPrefix'), parameters('CWSQSAPIdentifier'),variables('CWQSIdentifierSuffix'))))]",
                "functionParameters": "",
                "version": 2,
                "tags": [
                    {
                        "name": "description",
                        "value": "SAP_USGRP_USER"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
            "apiVersion": "2022-01-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId53'),'/'))))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[variables('_parserId53')]"
            ],
            "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAP_USGRP_USER')]",
                "contentId": "[variables('parserObject53').parserContentId53]",
                "kind": "Parser",
                "version": "[variables('parserObject53').parserVersion53]",
                "source": {
                    "kind": "Solution",
                    "name": "SAP",
                    "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                    "name": "Microsoft",
                    "email": "[variables('_email')]"
                },
                "support": {
                    "tier": "Microsoft",
                    "name": "Microsoft Corporation",
                    "email": "support@microsoft.com",
                    "link": "https://support.microsoft.com/"
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('parserTemplateSpecName54')]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP_USR01 Data Parser with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('parserObject54').parserVersion54]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "name": "[variables('parserObject54')._parserName54]",
                            "apiVersion": "2022-10-01",
                            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "eTag": "*",
                                "displayName": "SAP_USR01",
                                "category": "SAPFunctions",
                                "functionAlias": "SAP_USR01",
                                "query": "[replace(variables('SAPFunctionsSAP_USR01Query'),'CWSQSAP.', if(equals(coalesce(parameters('CWSQSAPIdentifier'),''),'') , '', concat(variables('CWSQIdentifierPrefix'), parameters('CWSQSAPIdentifier'),variables('CWQSIdentifierSuffix'))))]",
                                "functionParameters": "",
                                "version": 2,
                                "tags": [
                                    {
                                        "name": "description",
                                        "value": "SAP_USR01"
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId54'),'/'))))]",
                            "dependsOn": [
                                "[variables('_parserId54')]"
                            ],
                            "properties": {
                                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAP_USR01')]",
                                "contentId": "[variables('parserObject54').parserContentId54]",
                                "kind": "Parser",
                                "version": "[variables('parserObject54').parserVersion54]",
                                "source": {
                                    "name": "SAP",
                                    "kind": "Solution",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('parserObject54').parserContentId54]",
                "contentKind": "Parser",
                "displayName": "SAP_USR01",
                "contentProductId": "[variables('_parsercontentProductId54')]",
                "id": "[variables('_parsercontentProductId54')]",
                "version": "[variables('parserObject54').parserVersion54]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
            "apiVersion": "2022-10-01",
            "name": "[variables('parserObject54')._parserName54]",
            "location": "[parameters('workspace-location')]",
            "properties": {
                "eTag": "*",
                "displayName": "SAP_USR01",
                "category": "SAPFunctions",
                "functionAlias": "SAP_USR01",
                "query": "[replace(variables('SAPFunctionsSAP_USR01Query'),'CWSQSAP.', if(equals(coalesce(parameters('CWSQSAPIdentifier'),''),'') , '', concat(variables('CWSQIdentifierPrefix'), parameters('CWSQSAPIdentifier'),variables('CWQSIdentifierSuffix'))))]",
                "functionParameters": "",
                "version": 2,
                "tags": [
                    {
                        "name": "description",
                        "value": "SAP_USR01"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
            "apiVersion": "2022-01-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId54'),'/'))))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[variables('_parserId54')]"
            ],
            "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAP_USR01')]",
                "contentId": "[variables('parserObject54').parserContentId54]",
                "kind": "Parser",
                "version": "[variables('parserObject54').parserVersion54]",
                "source": {
                    "kind": "Solution",
                    "name": "SAP",
                    "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                    "name": "Microsoft",
                    "email": "[variables('_email')]"
                },
                "support": {
                    "tier": "Microsoft",
                    "name": "Microsoft Corporation",
                    "email": "support@microsoft.com",
                    "link": "https://support.microsoft.com/"
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('parserTemplateSpecName55')]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP_USR02 Data Parser with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('parserObject55').parserVersion55]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "name": "[variables('parserObject55')._parserName55]",
                            "apiVersion": "2022-10-01",
                            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "eTag": "*",
                                "displayName": "SAP_USR02",
                                "category": "SAPFunctions",
                                "functionAlias": "SAP_USR02",
                                "query": "[replace(variables('SAPFunctionsSAP_USR02Query'),'CWSQSAP.', if(equals(coalesce(parameters('CWSQSAPIdentifier'),''),'') , '', concat(variables('CWSQIdentifierPrefix'), parameters('CWSQSAPIdentifier'),variables('CWQSIdentifierSuffix'))))]",
                                "functionParameters": "",
                                "version": 2,
                                "tags": [
                                    {
                                        "name": "description",
                                        "value": "SAP_USR02"
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId55'),'/'))))]",
                            "dependsOn": [
                                "[variables('_parserId55')]"
                            ],
                            "properties": {
                                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAP_USR02')]",
                                "contentId": "[variables('parserObject55').parserContentId55]",
                                "kind": "Parser",
                                "version": "[variables('parserObject55').parserVersion55]",
                                "source": {
                                    "name": "SAP",
                                    "kind": "Solution",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('parserObject55').parserContentId55]",
                "contentKind": "Parser",
                "displayName": "SAP_USR02",
                "contentProductId": "[variables('_parsercontentProductId55')]",
                "id": "[variables('_parsercontentProductId55')]",
                "version": "[variables('parserObject55').parserVersion55]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
            "apiVersion": "2022-10-01",
            "name": "[variables('parserObject55')._parserName55]",
            "location": "[parameters('workspace-location')]",
            "properties": {
                "eTag": "*",
                "displayName": "SAP_USR02",
                "category": "SAPFunctions",
                "functionAlias": "SAP_USR02",
                "query": "[replace(variables('SAPFunctionsSAP_USR02Query'),'CWSQSAP.', if(equals(coalesce(parameters('CWSQSAPIdentifier'),''),'') , '', concat(variables('CWSQIdentifierPrefix'), parameters('CWSQSAPIdentifier'),variables('CWQSIdentifierSuffix'))))]",
                "functionParameters": "",
                "version": 2,
                "tags": [
                    {
                        "name": "description",
                        "value": "SAP_USR02"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
            "apiVersion": "2022-01-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId55'),'/'))))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[variables('_parserId55')]"
            ],
            "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAP_USR02')]",
                "contentId": "[variables('parserObject55').parserContentId55]",
                "kind": "Parser",
                "version": "[variables('parserObject55').parserVersion55]",
                "source": {
                    "kind": "Solution",
                    "name": "SAP",
                    "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                    "name": "Microsoft",
                    "email": "[variables('_email')]"
                },
                "support": {
                    "tier": "Microsoft",
                    "name": "Microsoft Corporation",
                    "email": "support@microsoft.com",
                    "link": "https://support.microsoft.com/"
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('parserTemplateSpecName56')]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP_USR05 Data Parser with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('parserObject56').parserVersion56]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "name": "[variables('parserObject56')._parserName56]",
                            "apiVersion": "2022-10-01",
                            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "eTag": "*",
                                "displayName": "SAP_USR05",
                                "category": "SAPFunctions",
                                "functionAlias": "SAP_USR05",
                                "query": "[replace(variables('SAPFunctionsSAP_USR05Query'),'CWSQSAP.', if(equals(coalesce(parameters('CWSQSAPIdentifier'),''),'') , '', concat(variables('CWSQIdentifierPrefix'), parameters('CWSQSAPIdentifier'),variables('CWQSIdentifierSuffix'))))]",
                                "functionParameters": "",
                                "version": 2,
                                "tags": [
                                    {
                                        "name": "description",
                                        "value": "SAP_USR05"
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId56'),'/'))))]",
                            "dependsOn": [
                                "[variables('_parserId56')]"
                            ],
                            "properties": {
                                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAP_USR05')]",
                                "contentId": "[variables('parserObject56').parserContentId56]",
                                "kind": "Parser",
                                "version": "[variables('parserObject56').parserVersion56]",
                                "source": {
                                    "name": "SAP",
                                    "kind": "Solution",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('parserObject56').parserContentId56]",
                "contentKind": "Parser",
                "displayName": "SAP_USR05",
                "contentProductId": "[variables('_parsercontentProductId56')]",
                "id": "[variables('_parsercontentProductId56')]",
                "version": "[variables('parserObject56').parserVersion56]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
            "apiVersion": "2022-10-01",
            "name": "[variables('parserObject56')._parserName56]",
            "location": "[parameters('workspace-location')]",
            "properties": {
                "eTag": "*",
                "displayName": "SAP_USR05",
                "category": "SAPFunctions",
                "functionAlias": "SAP_USR05",
                "query": "[replace(variables('SAPFunctionsSAP_USR05Query'),'CWSQSAP.', if(equals(coalesce(parameters('CWSQSAPIdentifier'),''),'') , '', concat(variables('CWSQIdentifierPrefix'), parameters('CWSQSAPIdentifier'),variables('CWQSIdentifierSuffix'))))]",
                "functionParameters": "",
                "version": 2,
                "tags": [
                    {
                        "name": "description",
                        "value": "SAP_USR05"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
            "apiVersion": "2022-01-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId56'),'/'))))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[variables('_parserId56')]"
            ],
            "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAP_USR05')]",
                "contentId": "[variables('parserObject56').parserContentId56]",
                "kind": "Parser",
                "version": "[variables('parserObject56').parserVersion56]",
                "source": {
                    "kind": "Solution",
                    "name": "SAP",
                    "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                    "name": "Microsoft",
                    "email": "[variables('_email')]"
                },
                "support": {
                    "tier": "Microsoft",
                    "name": "Microsoft Corporation",
                    "email": "support@microsoft.com",
                    "link": "https://support.microsoft.com/"
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('parserTemplateSpecName57')]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP_USR21 Data Parser with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('parserObject57').parserVersion57]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "name": "[variables('parserObject57')._parserName57]",
                            "apiVersion": "2022-10-01",
                            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "eTag": "*",
                                "displayName": "SAP_USR21",
                                "category": "SAPFunctions",
                                "functionAlias": "SAP_USR21",
                                "query": "[replace(variables('SAPFunctionsSAP_USR21Query'),'CWSQSAP.', if(equals(coalesce(parameters('CWSQSAPIdentifier'),''),'') , '', concat(variables('CWSQIdentifierPrefix'), parameters('CWSQSAPIdentifier'),variables('CWQSIdentifierSuffix'))))]",
                                "functionParameters": "",
                                "version": 2,
                                "tags": [
                                    {
                                        "name": "description",
                                        "value": "SAP_USR21"
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId57'),'/'))))]",
                            "dependsOn": [
                                "[variables('_parserId57')]"
                            ],
                            "properties": {
                                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAP_USR21')]",
                                "contentId": "[variables('parserObject57').parserContentId57]",
                                "kind": "Parser",
                                "version": "[variables('parserObject57').parserVersion57]",
                                "source": {
                                    "name": "SAP",
                                    "kind": "Solution",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('parserObject57').parserContentId57]",
                "contentKind": "Parser",
                "displayName": "SAP_USR21",
                "contentProductId": "[variables('_parsercontentProductId57')]",
                "id": "[variables('_parsercontentProductId57')]",
                "version": "[variables('parserObject57').parserVersion57]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
            "apiVersion": "2022-10-01",
            "name": "[variables('parserObject57')._parserName57]",
            "location": "[parameters('workspace-location')]",
            "properties": {
                "eTag": "*",
                "displayName": "SAP_USR21",
                "category": "SAPFunctions",
                "functionAlias": "SAP_USR21",
                "query": "[replace(variables('SAPFunctionsSAP_USR21Query'),'CWSQSAP.', if(equals(coalesce(parameters('CWSQSAPIdentifier'),''),'') , '', concat(variables('CWSQIdentifierPrefix'), parameters('CWSQSAPIdentifier'),variables('CWQSIdentifierSuffix'))))]",
                "functionParameters": "",
                "version": 2,
                "tags": [
                    {
                        "name": "description",
                        "value": "SAP_USR21"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
            "apiVersion": "2022-01-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId57'),'/'))))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[variables('_parserId57')]"
            ],
            "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAP_USR21')]",
                "contentId": "[variables('parserObject57').parserContentId57]",
                "kind": "Parser",
                "version": "[variables('parserObject57').parserVersion57]",
                "source": {
                    "kind": "Solution",
                    "name": "SAP",
                    "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                    "name": "Microsoft",
                    "email": "[variables('_email')]"
                },
                "support": {
                    "tier": "Microsoft",
                    "name": "Microsoft Corporation",
                    "email": "support@microsoft.com",
                    "link": "https://support.microsoft.com/"
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
            "apiVersion": "2023-04-01-preview",
            "name": "[variables('parserTemplateSpecName58')]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
            ],
            "properties": {
                "description": "SAP_UST04 Data Parser with template version 3.0.0",
                "mainTemplate": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "[variables('parserObject58').parserVersion58]",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "name": "[variables('parserObject58')._parserName58]",
                            "apiVersion": "2022-10-01",
                            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
                            "location": "[parameters('workspace-location')]",
                            "properties": {
                                "eTag": "*",
                                "displayName": "SAP_UST04",
                                "category": "SAPFunctions",
                                "functionAlias": "SAP_UST04",
                                "query": "[replace(variables('SAPFunctionsSAP_UST04Query'),'CWSQSAP.', if(equals(coalesce(parameters('CWSQSAPIdentifier'),''),'') , '', concat(variables('CWSQIdentifierPrefix'), parameters('CWSQSAPIdentifier'),variables('CWQSIdentifierSuffix'))))]",
                                "functionParameters": "",
                                "version": 2,
                                "tags": [
                                    {
                                        "name": "description",
                                        "value": "SAP_UST04"
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                            "apiVersion": "2022-01-01-preview",
                            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId58'),'/'))))]",
                            "dependsOn": [
                                "[variables('_parserId58')]"
                            ],
                            "properties": {
                                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAP_UST04')]",
                                "contentId": "[variables('parserObject58').parserContentId58]",
                                "kind": "Parser",
                                "version": "[variables('parserObject58').parserVersion58]",
                                "source": {
                                    "name": "SAP",
                                    "kind": "Solution",
                                    "sourceId": "[variables('_solutionId')]"
                                },
                                "author": {
                                    "name": "Microsoft",
                                    "email": "[variables('_email')]"
                                },
                                "support": {
                                    "tier": "Microsoft",
                                    "name": "Microsoft Corporation",
                                    "email": "support@microsoft.com",
                                    "link": "https://support.microsoft.com/"
                                }
                            }
                        }
                    ]
                },
                "packageKind": "Solution",
                "packageVersion": "[variables('_solutionVersion')]",
                "packageName": "[variables('_solutionName')]",
                "packageId": "[variables('_solutionId')]",
                "contentSchemaVersion": "3.0.0",
                "contentId": "[variables('parserObject58').parserContentId58]",
                "contentKind": "Parser",
                "displayName": "SAP_UST04",
                "contentProductId": "[variables('_parsercontentProductId58')]",
                "id": "[variables('_parsercontentProductId58')]",
                "version": "[variables('parserObject58').parserVersion58]"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
            "apiVersion": "2022-10-01",
            "name": "[variables('parserObject58')._parserName58]",
            "location": "[parameters('workspace-location')]",
            "properties": {
                "eTag": "*",
                "displayName": "SAP_UST04",
                "category": "SAPFunctions",
                "functionAlias": "SAP_UST04",
                "query": "[replace(variables('SAPFunctionsSAP_UST04Query'),'CWSQSAP.', if(equals(coalesce(parameters('CWSQSAPIdentifier'),''),'') , '', concat(variables('CWSQIdentifierPrefix'), parameters('CWSQSAPIdentifier'),variables('CWQSIdentifierSuffix'))))]",
                "functionParameters": "",
                "version": 2,
                "tags": [
                    {
                        "name": "description",
                        "value": "SAP_UST04"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
            "apiVersion": "2022-01-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId58'),'/'))))]",
            "location": "[parameters('workspace-location')]",
            "dependsOn": [
                "[variables('_parserId58')]"
            ],
            "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'SAP_UST04')]",
                "contentId": "[variables('parserObject58').parserContentId58]",
                "kind": "Parser",
                "version": "[variables('parserObject58').parserVersion58]",
                "source": {
                    "kind": "Solution",
                    "name": "SAP",
                    "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                    "name": "Microsoft",
                    "email": "[variables('_email')]"
                },
                "support": {
                    "tier": "Microsoft",
                    "name": "Microsoft Corporation",
                    "email": "support@microsoft.com",
                    "link": "https://support.microsoft.com/"
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/Watchlists",
            "apiVersion": "2023-02-01",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/SAP - Critical Authorizations')]",
            "properties": {
                "description": "Critical Authorizations object which their assignment should be governed.",
                "displayName": "SAP - Critical Authorizations",
                "source": "ContentHub",
                "provider": "Microsoft",
                "numberOfLinesToSkip": 0,
                "itemsSearchKey": "AuthorizationObject",
                "rawContent": "AuthorizationObject,AuthorizationField,AuthorizationValue,ActivityField,Activity,Description\nS_DEVELOP,OBJTYPE,DEBUG,ACTVT,02,Debug Change Authorizations\nS_DEVELOP,OBJTYPE,*,ACTVT,02,All development activities - include debug\nS_DEVELOP,OBJTYPE,DEBUG,ACTVT,*,Debug All Activites (Including Change)\nS_DEVELOP,OBJTYPE,*,ACTVT,*,All development activities - include debug\nS_RFC,RFCNAME,*,ACTVT,16,Execution of all RFC Services\nS_RFC,RFCNAME,*,ACTVT,*,Execution of all RFC Services\nS_TCODE,TCD,*,NOT_IN_USE,,All Transaction Codes - Example without Activity\nS_TZONE,ACTVT,*,NOT_IN_USE,,Maintain System Time Zone - Example only with Activity\n",
                "watchlistAlias": "SAP - Critical Authorizations",
                "contentType": "text/csv"
            },
            "condition": "[parameters('wl_1_creation_required')]"
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/Watchlists",
            "apiVersion": "2023-02-01",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/SAP - Excluded Networks')]",
            "properties": {
                "description": "Internal and maintenance of excluded networks for ignoring web dispatchers, terminal servers etc.",
                "displayName": "SAP - Excluded Networks",
                "source": "ContentHub",
                "provider": "Microsoft",
                "numberOfLinesToSkip": 0,
                "itemsSearchKey": "Network",
                "rawContent": "Network,Description\n255.68.255.0/32,My  Dummy Terminal Server\n255.138.157.0/32,My Dummy Citrix\n",
                "watchlistAlias": "SAP - Excluded Networks",
                "contentType": "text/csv"
            },
            "condition": "[parameters('wl_2_creation_required')]"
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/Watchlists",
            "apiVersion": "2023-02-01",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/SAP - Excluded Users')]",
            "properties": {
                "description": "System users which are logged in the systems need to be ignored. (for example Multiple logons by user alert)",
                "displayName": "SAP - Excluded Users",
                "source": "ContentHub",
                "provider": "Microsoft",
                "numberOfLinesToSkip": 0,
                "itemsSearchKey": "User",
                "rawContent": "User,Description\nSYSWF,WF\n",
                "watchlistAlias": "SAP - Excluded Users",
                "contentType": "text/csv"
            },
            "condition": "[parameters('wl_3_creation_required')]"
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/Watchlists",
            "apiVersion": "2023-02-01",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/SAP - FTP Servers')]",
            "properties": {
                "description": "FTP Servers for identification of unauthorized connections.",
                "displayName": "SAP - FTP Servers",
                "source": "ContentHub",
                "provider": "Microsoft",
                "numberOfLinesToSkip": 0,
                "itemsSearchKey": "Client",
                "rawContent": "Client,FTP_Server_Name,FTP_Server_Port,Description\n100,http://ourorgftpserver.com/,22,description\n",
                "watchlistAlias": "SAP - FTP Servers",
                "contentType": "text/csv"
            },
            "condition": "[parameters('wl_4_creation_required')]"
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/Watchlists",
            "apiVersion": "2023-02-01",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/SAP - Networks')]",
            "properties": {
                "description": "Internal and maintenance networks for identification of unauthorized logins.",
                "displayName": "SAP - Networks",
                "source": "ContentHub",
                "provider": "Microsoft",
                "numberOfLinesToSkip": 0,
                "itemsSearchKey": "Network",
                "rawContent": "Network,Description\n111.68.128.0/17,(Dummy) Our internal Network\n5.8.0.0/19,(Dummy) SAP Support Network\n223.255.254.0/24,(Dummy) Our Support Network\n",
                "watchlistAlias": "SAP - Networks",
                "contentType": "text/csv"
            },
            "condition": "[parameters('wl_5_creation_required')]"
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/Watchlists",
            "apiVersion": "2023-02-01",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/SAP - Obsolete Function Modules')]",
            "properties": {
                "description": "Obsolete Function Modules which their execution should be governed.",
                "displayName": "SAP - Obsolete Function Modules",
                "source": "ContentHub",
                "provider": "Microsoft",
                "numberOfLinesToSkip": 0,
                "itemsSearchKey": "FunctionModule",
                "rawContent": "FunctionModule,Description\nTH_SAPREL,Get SAP Release Information\nTH_SAPREL2,Get SAP Release Information\nTH_SAPREL3,Get SAP Release Information\nSUSR_RFC_USER_INTERFACE,Users from External Systems\nRFC_ABAP_INSTALL_AND_RUN,Install ABAP Program\n",
                "watchlistAlias": "SAP - Obsolete Function Modules",
                "contentType": "text/csv"
            },
            "condition": "[parameters('wl_6_creation_required')]"
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/Watchlists",
            "apiVersion": "2023-02-01",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/SAP - Obsolete Programs')]",
            "properties": {
                "description": "Obsolete ABAP programs (reports) which their execution should be governed.",
                "displayName": "SAP - Obsolete Programs",
                "source": "ContentHub",
                "provider": "Microsoft",
                "numberOfLinesToSkip": 0,
                "itemsSearchKey": "ABAPProgram",
                "rawContent": "ABAPProgram,Description\nExample_Program,just an example\n",
                "watchlistAlias": "SAP - Obsolete Programs",
                "contentType": "text/csv"
            },
            "condition": "[parameters('wl_7_creation_required')]"
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/Watchlists",
            "apiVersion": "2023-02-01",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/SAP - Privileged Users')]",
            "properties": {
                "description": "Privileged users which are under extra restrictions.",
                "displayName": "SAP - Privileged Users",
                "source": "ContentHub",
                "provider": "Microsoft",
                "numberOfLinesToSkip": 0,
                "itemsSearchKey": "User",
                "rawContent": "User,Description\nSAP*,SAP*\nDDIC,Dictionary, Internal\nALEREMOTE,BW User\nBWREMOTE,BW User\nSAPSYS,SAP System, Internal\nWF-BATCH,Workflow Batch\n",
                "watchlistAlias": "SAP - Privileged Users",
                "contentType": "text/csv"
            },
            "condition": "[parameters('wl_8_creation_required')]"
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/Watchlists",
            "apiVersion": "2023-02-01",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/SAP - Sensitive ABAP Programs')]",
            "properties": {
                "description": "Sensitive ABAP programs (reports) which their execution should be governed.",
                "displayName": "SAP - Sensitive ABAP Programs",
                "source": "ContentHub",
                "provider": "Microsoft",
                "numberOfLinesToSkip": 0,
                "itemsSearchKey": "ABAPProgram",
                "rawContent": "ABAPProgram,Description,UsersExcluded\nRSPFLDOC,Profile Parameter Maintenance,\n/1BCDWB/DBUSR02,Data Browser - USR02,\n/1BCDWB/DBUSH02,Data Browser - USH02,\n/1BCDWB/DBUSRPWDHISTORY,Data Browser - USRPWDHISTORY,\nRSBDCOS0,Execute OS Command (Logged in SYSLOG and Trace Files),\nRSCDOK99,Delete Change Documents,\nRSTBPDEL,Table Log Database Management: Delete Logs,BASIS_ADM\nRSENQRR2,Display and Management of Lock Entries,\n",
                "watchlistAlias": "SAP - Sensitive ABAP Programs",
                "contentType": "text/csv"
            },
            "condition": "[parameters('wl_9_creation_required')]"
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/Watchlists",
            "apiVersion": "2023-02-01",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/SAP - Sensitive Function Modules')]",
            "properties": {
                "description": "Sensitive Function Modules which their execution should be governed.",
                "displayName": "SAP - Sensitive Function Modules",
                "source": "ContentHub",
                "provider": "Microsoft",
                "numberOfLinesToSkip": 0,
                "itemsSearchKey": "FunctionModule",
                "rawContent": "FunctionModule,Description,UsersExcluded\nRSAU_CLEAR_AUDIT_LOG,Delete Audit Log,\nBAPI_USER_CREATE,Create User,\nBAPI_USER_CREATE1,Create User,\nBAPI_USER_DELETE,Delete user,\nBAPI_USER_GET_DETAIL,Read User Details,MySentinelUser; BATCH_000\nBAPI_USER_PROFILES_ASSIGN,Change User-Profile Assignments,\nEPS_GET_DIRECTORY_LISTING,,\nPFL_CHECK_OS_FILE_EXISTENCE,,\nPRGN_INTERFACE_USER,,\nRFC_ABAP_INSTALL_AND_RUN,,\nRFC_GET_TABLE_ENTRIES,Read table entries,\nRFC_READ_TABLE,External access to R/3 tables via RFC,MySentinelUser\nRS_FUNCTIONMODULE_INSERT,,\nRZL_READ_DIR_LOCAL,,\nSUSR_RFC_USER_INTERFACE,,\nSXPG_CALL_SYSTEM,Execute an External Command,\nSXPG_COMMAND_EXECUTE,Execute an External Command,\nSXPG_COMMAND_EXECUTE_LONG,Execute an External Command,\nTABLE_ENTRIES_GET_VIA_RFC,,\nTH_REMOTE_TRANSACTION,Start Remote Transaction,\nTH_SAPREL,,\nTMS_CI_START_SERVICE,,TMSADM\nSWNC_COLLECTOR_DEL_AGGREGATES,Delete logs,\nSUSR_PASSWORD_CHANGE_DIALOG,Change User Password,\n",
                "watchlistAlias": "SAP - Sensitive Function Modules",
                "contentType": "text/csv"
            },
            "condition": "[parameters('wl_10_creation_required')]"
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/Watchlists",
            "apiVersion": "2023-02-01",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/SAP - Sensitive Profiles')]",
            "properties": {
                "description": "Sensitive profiles which their assignment should be governed.",
                "displayName": "SAP - Sensitive Profiles",
                "source": "ContentHub",
                "provider": "Microsoft",
                "numberOfLinesToSkip": 0,
                "itemsSearchKey": "Profile",
                "rawContent": "Profile,Description\nSAP_ALL,All SAP Systems Authorizations\nSAP_NEW,New Authorizations Checks\n",
                "watchlistAlias": "SAP - Sensitive Profiles",
                "contentType": "text/csv"
            },
            "condition": "[parameters('wl_11_creation_required')]"
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/Watchlists",
            "apiVersion": "2023-02-01",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/SAP - Sensitive Roles')]",
            "properties": {
                "description": "Sensitive roles which their assignment should be governed.",
                "displayName": "SAP - Sensitive Roles",
                "source": "ContentHub",
                "provider": "Microsoft",
                "numberOfLinesToSkip": 0,
                "itemsSearchKey": "Role",
                "rawContent": "Role,Description\nZ_FIGL_POSTING_ADMIN,Custom example role\nSAP_BC_AUTH_DATA_ADMIN,Authorization Data Administrator\nSAP_BC_AUTH_PROFILE_ADMIN,Authorization Profile Administrator\nSAP_BC_BASIS_ADMIN,System Administrator\n",
                "watchlistAlias": "SAP - Sensitive Roles",
                "contentType": "text/csv"
            },
            "condition": "[parameters('wl_12_creation_required')]"
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/Watchlists",
            "apiVersion": "2023-02-01",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/SAP - Sensitive Tables')]",
            "properties": {
                "description": "Sensitive tables which their access should be governed.",
                "displayName": "SAP - Sensitive Tables",
                "source": "ContentHub",
                "provider": "Microsoft",
                "numberOfLinesToSkip": 0,
                "itemsSearchKey": "Table",
                "rawContent": "Table,Description\nADR6,E-Mail Addresses \nADRC,Business Addresses\nBAS tables,Business address services tables\nBC001,Assign vendor  partner\nBD001,Assign customer  partner\nBP000,Business partner master (general data)\nBP001,FS-specific attributes\nBP030,Address\nBP1000,Roles\nBUT000,General data I\nBUT001,General data II\nBUT020,BP: addresses\nBUT021,BP: address usage\nBUT0BANK,Bank details\nBUT0BK,BP: bank details\nBUT100,BP roles\nKNA1,Customer MD\nKNB1,Customer MD\nKNBK,Bank details\nKNVV,Customer MD\nLFA1,Vendor MD\nLFB1,Vendor MD\nLFBK,Vendor MD\nPA0008,Basic Pay Infotype\nSANS1,Addresses\nTable,Description\nTIBAN,IBAN data\nUSH02,Change history for logon data\nUSR02,Logon Data\nUSRPWDHISTORY,Change History for Logon Data: Last Entries from Archive\nANONYMIZATION,ANONYMIZATION\nQ0002,Screen Fields: Infotype 0002 (Personal Data)\nPA0002,HR Master Record: Infotype 0002 (Personal Data)\nTF644,Fair Value Adjustments: Cons Chart of Accounts-sensitive\nTADIR,Directory of Repository Objects\nTF643,Fair Value Adjustments: Version/Date-sensitive\nTBE31,Publish&Subscribe BTE: SAP Enhancement\nT77UA,User Authorizations\nCRMT_BSP_IBASE_CS_F4,IBase: Structure for Context-sensitiveSearch\nSNODE,Workbench: Object List Node Description\nUSR40,Table for illegal passwords\nT000,Clients\n",
                "watchlistAlias": "SAP - Sensitive Tables",
                "contentType": "text/csv"
            },
            "condition": "[parameters('wl_13_creation_required')]"
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/Watchlists",
            "apiVersion": "2023-02-01",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/SAP - Sensitive Transactions')]",
            "properties": {
                "description": "Sensitive transactions which their execution should be governed.",
                "displayName": "SAP - Sensitive Transactions",
                "source": "ContentHub",
                "provider": "Microsoft",
                "numberOfLinesToSkip": 0,
                "itemsSearchKey": "TransactionCode",
                "rawContent": "TransactionCode,Description\nRSAU_CONFIG,Audit Log Configuration\nRZ11,Profile Parameter Maintenance\nRZ10, Profile Maintenance\nRZ12, RFC Server Group Maintenance\nSM18, Delete Audit Log\nSCU3, Delete Table Log\nSLG2, delete application log\nSM49, Execute external OS Commands\nSM69, Execute external OS Commands\nSCC1 , Client Import\nSCC4, Client Overview\nSCC5, Delete Client\nSE06, Set Up Transport Organizer\nSE03, Transport Organizer Tools\nSE38, ABAP Program Editor\nSE80, ABAP Workbench\nSA38, ABAP Program Editor\nSE37, Execute Function Modules\nSLDB,Logical Database Builder\nSM12,Lock Manager\nRSUSR000,Loggedon users\nAL08,User Sessions\n",
                "watchlistAlias": "SAP - Sensitive Transactions",
                "contentType": "text/csv"
            },
            "condition": "[parameters('wl_14_creation_required')]"
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/Watchlists",
            "apiVersion": "2023-02-01",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/SAP - Systems')]",
            "properties": {
                "description": "Describes the landscape of SAP systems according to role and usage.",
                "displayName": "SAP - Systems",
                "source": "ContentHub",
                "provider": "Microsoft",
                "numberOfLinesToSkip": 0,
                "itemsSearchKey": "SystemID",
                "rawContent": "SystemID,SystemRole,SystemUsage,InterfaceAttributes\nA4H,Production,ERP,{'BasePath': 'https://api.integration-center.co.in/lock/urn:sap-com:document:sap:rfc:functions:'}\n",
                "watchlistAlias": "SAP - Systems",
                "contentType": "text/csv"
            },
            "condition": "[parameters('wl_15_creation_required')]"
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/Watchlists",
            "apiVersion": "2023-02-01",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/SAP - Transactions for ABAP Generations')]",
            "properties": {
                "description": "Transactions for ABAP generations which their execution should be governed.",
                "displayName": "SAP - Transactions for ABAP Generations",
                "source": "ContentHub",
                "provider": "Microsoft",
                "numberOfLinesToSkip": 0,
                "itemsSearchKey": "TransactionCode",
                "rawContent": "TransactionCode,Description\nSE11, ABAP Dictionary Maintenance\nSE12, ABAP Dictionary Display\nSE16, Data Browser\nSE16N, General Table Display\nPFCG, Role Maintenance\nSM30, Call View Maintenance\nSM36, Schedule Background Job\nSM37, Overview of job selection\nST03, Workload and Performance Statistics\nSU01, User Maintenance\n",
                "watchlistAlias": "SAP - Transactions for ABAP Generations",
                "contentType": "text/csv"
            },
            "condition": "[parameters('wl_16_creation_required')]"
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/Watchlists",
            "apiVersion": "2023-02-01",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/SAPAlertRulesMetadata')]",
            "properties": {
                "description": "Allows for specifying local properties of the OOTB alert rules, like default responding team,  SOX or NIST control framework associations. These controls are conveniently modifiable from configuration section on the SAP Audit Controls workbook.",
                "displayName": "SAPAlertRulesMetadata",
                "source": "ContentHub",
                "provider": "Microsoft",
                "numberOfLinesToSkip": 0,
                "itemsSearchKey": "RuleID",
                "rawContent": "RuleID,AnalyticRuleName,AnalyticsTemplateId,RecommendedConfiguration,NISTControlFamily,NISTControlID,MyOrgControlFamily,MyOrgControlID,SOXControlFamily,SOXControlID,ControlType,Tasks,Tier1,Tier2\nDefaultRule,DefaultRule,DefaultRule,As alert only (low fidelity),N/A,N/A,N/A,N/A,N/A,N/A,,,,\nactivationordeactivationoficfservice,SAP - Activation or Deactivation of ICF Service,e704b794-2f22-417a-b3ac-25e6037e2717,As incident (high fidelity),Configuration Management,03.04.02,Change management,System Configuration Monitoring,Change management,System Configuration Monitoring,Detective,ConfirmDetails, AssignToTier2,SAPBasis,SAPSOC\nassignmentofasensitiveprofile,SAP - Assignment of a sensitive profile,4e228f1a-55cc-4abc-8ef4-5e385b60f9c0,As alert only (low fidelity),Access Control,03.01.05,Access Controls,Sensitive Authorization Monitoring,Access Controls,Sensitive Authorization Monitoring,Preventative,ConfirmDetails, AssignToTier2,SAPSecurity,SAPSOC\nassignmentofasensitiverole,SAP - Assignment of a sensitive role,03b9a2cf-8434-44ad-b42f-9a35701f1c2a,As alert only (low fidelity),Access Control,03.01.05,Access Controls,Sensitive Authorization Monitoring,Access Controls,Sensitive Authorization Monitoring,Preventative,ConfirmDetails, AssignToTier2,SAPSecurity,SAPSOC\nbruteforce(rfc),SAP - Brute Force (RFC),c2cc3901-d6bd-4189-bb5f-ab464dcfd079,As incident (medium fidelity),Access Control,03.01.12,Security,Network activity,Security,Network activity,Detective,ConfirmDetails, AssignToTier2,SAPBasis,SAPSOC\ncapture-replayvulnerabilityinsapnetweaver[cve-2023-0014],SAP - Capture-replay vulnerability in SAP NetWeaver [CVE-2023-0014],7c2d366a-1cb8-41f3-9b0b-a5c469ad467e,As alert only (low fidelity),Identification and Authentication,03.05.10,Security,Information Access,Security,Information Access,Preventative,ConfirmDetails, AssignToTier2,SAPBasis,SAPSOC\nchangeinasensitiveprivilegeduser,SAP - Change in a Sensitive Privileged User,3eab4a41-1d7b-453d-8631-a7d74936973b,As incident (medium fidelity),Access Control,03.01.02,Access Controls,Sensitive Authorization Monitoring,Access Controls,Sensitive Authorization Monitoring,Preventative,ConfirmDetails, AssignToTier2,SAPSecurity,SAPSOC\nclientconfigurationchange,SAP - Client Configuration Change,4258c51d-59db-4502-9b02-fb2ab20e97d4,As incident (high fidelity),Configuration Management,03.04.03,Change management,System Configuration Monitoring,Change management,System Configuration Monitoring,Detective,ConfirmDetails, AssignToTier2,SAPBasis,SAPSOC\ncriticalauthorizationsassignment-newauthorizationvalue,SAP - Critical authorizations assignment - New Authorization Value,6e60e742-aef0-47aa-95e5-36a100a4272d,As alert only (low fidelity),Access Control,03.01.05,Access Controls,Sensitive Authorization Monitoring,Access Controls,Sensitive Authorization Monitoring,Preventative,ConfirmDetails, AssignToTier2,SAPSecurity,SAPSOC\ncriticalauthorizationsassignment-newuserassignment,SAP - Critical authorizations assignment - New User Assignment,8f9b9576-d0cd-43da-8ea2-d77366d4a70d,As alert only (low fidelity),Access Control,03.01.05,Access Controls,Sensitive Authorization Monitoring,Access Controls,Sensitive Authorization Monitoring,Preventative,ConfirmDetails, AssignToTier2,SAPSecurity,SAPSOC\ndatacollectionhealthcheck,SAP - Data collection health check,2af909e9-9c84-4198-b8c7-e80fe9f00ffb,As incident (high fidelity),Audit and Accountability,03.03.04,Change management,Audit logging,Change management,Audit logging,Preventative,ConfirmDetails, AssignToTier2,SAPSOC,SAPSOC\ndataexportedfromaproductionsystemusingatransport,SAP - Data exported from a production system using a transport,4329c5d1-7062-4ec4-8ab8-29846e0e0d9a,As incident (medium fidelity),Media Protection,03.08.05,Security,Information Access,Security,Information Access,Detective,ConfirmDetails, AssignToTier2,SAPSecurity,SAPSOC\ndatahaschangedduringdebuggingactivity,SAP - Data has Changed during Debugging Activity,9a55136c-fa19-46d4-9376-17c8f96cc2b8,As incident (high fidelity),System and Information Integrity,03.14.06,Security,Database activity,Security,Database activity,Detective,ConfirmDetails, AssignToTier2,SAPDevelopment,SAPSOC\ndeactivationofsecurityauditlog,SAP - Deactivation of Security Audit Log,45fb7bf5-783b-4a87-897d-b26f5574186b,As incident (high fidelity),Audit and Accountability,03.03.04,Change management,Audit logging,Change management,Audit logging,Detective,ConfirmDetails, AssignToTier2,SAPSecurity,SAPSOC\ndebuggingactivities,SAP - Debugging Activities,a7babb63-a466-4ec7-a056-a213555f18df,As incident (high fidelity),Access Control,03.01.02,Security,Database activity,Security,Database activity,Detective,ConfirmDetails, AssignToTier2,SAPDevelopment,SAPSOC\ndialoglogonattemptfromaprivilegeduser,SAP - Dialog logon attempt from a privileged user,db123b5e-bcc2-43a5-9e13-8ac1e1a3c530,As incident (high fidelity),Access Control,03.01.06,Security,Login activity,Security,Login activity,Detective,ConfirmDetails, AssignToTier2,SAPBasis,SAPSOC\ndynamicabapprogram,SAP - Dynamic ABAP Program,fd655ec6-cb11-4e79-a825-0935a66596c8,As alert only (low fidelity),Access Control,03.01.12,Security,Information Access,Security,Information Access,Detective,ConfirmDetails, AssignToTier2,SAPSecurity,SAPSOC\ndynamicanomalybasedauditlogmonitoralerts,SAP - Dynamic Anomaly based Audit Log Monitor Alerts,49fd3399-67c5-47bf-bb61-8b6efa27a5fe,As alert only (low fidelity),Inherited,Inherited,Inherited,Inherited,Inherited,Inherited,Inherited,ConfirmDetails, AssignToTier2,Inherited,SAPSOC\ndynamicdeterministicauditlogmonitor,SAP - Dynamic Deterministic Audit Log Monitor,68a03140-24bc-4985-8b77-ca5cc8aadeda,As alert only (low fidelity),Inherited,Inherited,Inherited,Inherited,Dynamic,Inherited,Inherited,ConfirmDetails, AssignToTier2,Inherited,SAPSOC\ndynamicrfcdestination,SAP - Dynamic RFC Destination,57e99014-746b-4696-ae6a-447aecc9e800,As alert only (low fidelity),Access Control,03.01.12,Security,Information Access,Security,Information Access,Detective,ConfirmDetails, AssignToTier2,SAPSecurity,SAPSOC\nexecutionofanobsoleteoraninsecurefunctionmodule,SAP - Execution of an Obsolete or an Insecure Function Module,45e784d5-0414-4029-8fc6-5f6722abdb5c,As alert only (low fidelity),Access Control,03.01.03,Security,Information Access,Security,Information Access,Detective,ConfirmDetails, AssignToTier2,SAPSecurity,SAPSOC\nexecutionofanobsoleteoraninsecureprogram,SAP - Execution of an Obsolete or an Insecure Program,6a6ff9e7-b167-49a1-bff8-00dadf62b34c,As alert only (low fidelity),Access Control,03.01.03,Security,Information Access,Security,Information Access,Detective,ConfirmDetails, AssignToTier2,SAPSecurity,SAPSOC\nexecutionofasensitiveabapprogram,SAP - Execution of a Sensitive ABAP Program,e0e53cb9-d3f4-47c3-b953-ad62a8414f4f,As alert only (low fidelity),Access Control,03.01.07,Security,User activity,Security,User activity,Detective,ConfirmDetails, AssignToTier2,SAPDevelopment,SAPSOC\nexecutionofasensitivetransactioncode,SAP - Execution of a Sensitive Transaction Code,797db008-0a53-4510-9883-b32673f9c3f5,As alert only (low fidelity),Access Control,03.01.07,Security,User activity,Security,User activity,Detective,ConfirmDetails, AssignToTier2,SAPSecurity,SAPSOC\nexecutionofsensitivefunctionmodule,SAP - Execution of Sensitive Function Module,d940bee2-46ff-4bb5-869a-1a54a967977d,As alert only (low fidelity),Access Control,03.01.07,Security,User activity,Security,User activity,Detective,ConfirmDetails, AssignToTier2,SAPSecurity,SAPSOC\nfiledownloadedfromamaliciousipaddress,SAP - File Downloaded From a Malicious IP Address,5f152aa1-f82c-4789-8dea-d63d7d6bf96b,As incident (high fidelity),Media Protection,03.08.05,Security,Information Access,Security,Information Access,Detective,ConfirmDetails, AssignToTier2,SAPSOC,SAPSOC\nftpfornonauthorizedservers,SAP - FTP for non authorized servers,bd39a2f0-2eaa-41e6-a071-70c42e42dd21,As alert only (low fidelity),Access Control,03.01.20,Security,Network activity,Security,Network activity,Preventative,ConfirmDetails, AssignToTier2,SAPBasis,SAPSOC\nfunctionmoduletested,SAP - Function Module tested,7e6cb00d-d7cb-4411-837f-6e62c2fab6e7,As alert only (low fidelity),Access Control,03.01.02,Security,User activity,Security,User activity,Detective,ConfirmDetails, AssignToTier2,SAPSecurity,SAPSOC\nhanadb-assignadminauthorizations,SAP - HANA DB - Assign Admin Authorizations,2d7cbb53-cb18-4c9e-8855-c5393aa91db0,As alert only (low fidelity),Access Control,03.01.06,Access Controls,Sensitive Authorization Monitoring,Access Controls,Sensitive Authorization Monitoring,Preventative,ConfirmDetails, AssignToTier2,SAPSecurity,SAPSOC\nhanadb-audittrailpolicychanges,SAP - HANA DB - Audit Trail Policy Changes,fe14e4b9-8616-4741-bf6c-2936d30afa65,As alert only (low fidelity),Audit and Accountability,03.03.08,Change management,System Configuration Monitoring,Change management,System Configuration Monitoring,Detective,ConfirmDetails, AssignToTier2,SAPSecurity,SAPSOC\nhanadb-deactivationofaudittrail,SAP - HANA DB - Deactivation of Audit Trail,7e5e321a-f6df-434d-b1be-a8d74f696481,As alert only (low fidelity),Audit and Accountability,03.03.08,Change management,System Configuration Monitoring,Change management,System Configuration Monitoring,Detective,ConfirmDetails, AssignToTier2,SAPSecurity,SAPSOC\nhanadb-useradminactions,SAP - HANA DB - User Admin actions,3ba35622-3071-477e-9af9-5380bce25e1e,As alert only (low fidelity),Access Control,03.04.03,Security,Database activity,Security,Database activity,Preventative,ConfirmDetails, AssignToTier2,SAPSecurity,SAPSOC\nhighvolumeofpotentiallysensitivedataexported,SAP - High volume of potentially sensitive data exported,a4dee43c-f06e-4f6f-8735-db6dec4c5aa3,As incident (high fidelity),Media Protection,03.08.01,Security,Information Access,Security,Information Access,Detective,ConfirmDetails, AssignToTier2,SAPSecurity,SAPSOC\ninsecureftpserversconfiguration,SAP - Insecure FTP servers configuration,78fbdc7d-6136-4afc-9cc5-5e5aff1563ae,As alert only (low fidelity),Configuration Management,03.04.02,Security,Network activity,Security,Network activity,Preventative,ConfirmDetails, AssignToTier2,SAPBasis,SAPSOC\nlifecycle-sapnoteswereimplementedinsystem,SAP - Lifecycle - SAP Notes were implemented in system,7f364fac-c6a9-4935-a73b-ba215acace31,As incident (medium fidelity),Configuration Management,03.04.01,Change management,Transports,Change management,Transports,Preventative,ConfirmDetails, AssignToTier2,SAPBasis,SAPSOC\nloginfromunexpectednetwork,SAP - Login from unexpected network,978e1cc8-f891-41c7-83b8-b21762a2ebb7,As alert only (low fidelity),Identification and Authentication,03.05.04,Security,Network activity,Security,Network activity,Detective,ConfirmDetails, AssignToTier2,SAPBasis,SAPSOC\nmissingconfigurationinthedynamicsecurityauditlogmonitor,SAP - Missing configuration in the Dynamic Security Audit Log Monitor,b0594a30-5da4-4eca-89af-cb8ad111d697,As alert only (low fidelity),Audit and Accountability,03.03.03,Change management,System Configuration Monitoring,Change management,System Configuration Monitoring,Preventative,ConfirmDetails, AssignToTier2,SAPSecurity,SAPSOC\nmultiplefilesdownload,SAP - Multiple Files Download,4285d707-f969-4a8c-801f-e9c6a328d884,As alert only (low fidelity),Media Protection,03.08.01,Security,Information Access,Security,Information Access,Detective,ConfirmDetails, AssignToTier2,SAPSecurity,SAPSOC\nmultiplelogonsbyip,SAP - Multiple Logons by IP,e5a176ef-dd12-47a3-a5ef-1900997f1b17,As alert only (low fidelity),Access Control,03.05.04,Security,Network activity,Security,Network activity,Detective,ConfirmDetails, AssignToTier2,SAPBasis,SAPSOC\nmultiplepasswordchanges,SAP - Multiple Password Changes,c01c6b88-6323-4a71-b981-4bc0ddca88bf,As incident (medium fidelity),Identification and Authentication,03.05.08,Security,Account activity,Security,Account activity,Preventative,ConfirmDetails, AssignToTier2,SAPSecurity,SAPSOC\nmultiplespoolexecutions,SAP - Multiple Spool Executions,dfbcb26d-7b53-41f8-9647-1e158722a80e,As alert only (low fidelity),Media Protection,03.08.01,Security,Information Access,Security,Information Access,Detective,ConfirmDetails, AssignToTier2,SAPSecurity,SAPSOC\nmultiplespooloutputexecutions,SAP - Multiple Spool Output Executions,c123a8d7-f72f-4ba0-8b06-ba5e12043432,As alert only (low fidelity),Media Protection,03.08.01,Security,Information Access,Security,Information Access,Detective,ConfirmDetails, AssignToTier2,SAPSecurity,SAPSOC\nmultiplesubnetsbyuser,SAP - Multiple Subnets by User,0079fee8-1ebf-4721-92c2-ac1861a79626,As incident (medium fidelity),Identification and Authentication,03.05.04,Security,Network activity,Security,Network activity,Detective,ConfirmDetails, AssignToTier2,SAPBasis,SAPSOC\nnewicfservicehandlers,SAP - New ICF Service Handlers,45ae0492-fe7d-4ba8-addd-ca984ea30bc1,As incident (medium fidelity),Configuration Management,03.04.02,Change management,System Configuration Monitoring,Change management,System Configuration Monitoring,Preventative,ConfirmDetails, AssignToTier2,SAPBasis,SAPSOC\nnewicfservices,SAP - New ICF Services,263ea651-10c8-48a6-a5ac-2c9fc0655ebc,As incident (medium fidelity),Configuration Management,03.04.02,Change management,System Configuration Monitoring,Change management,System Configuration Monitoring,Preventative,ConfirmDetails, AssignToTier2,SAPBasis,SAPSOC\nnewtrustedrfcconnectioncapture-replayvulnerabilityinsapnetweaver[cve-2023-0014],SAP - New trusted RFC connection capture-replay vulnerability in SAP NetWeaver [CVE-2023-0014] ,e35db198-2146-446c-8eb7-a77b6344f1d7,As incident (high fidelity),Identification and Authentication,03.05.04,Security,Information Access,Security,Information Access,Preventative,ConfirmDetails, AssignToTier2,SAPBasis,SAPSOC\nprintingofpotentiallysensitivedata,SAP - Printing of potentially sensitive data,49f11dc5-03c9-4ea3-83ee-33434b42e699,As incident (high fidelity),Media Protection,03.08.01,Security,Information Access,Security,Information Access,Detective,ConfirmDetails, AssignToTier2,SAPSecurity,SAPSOC\nrfcexecutionofasensitivefunctionmodule,SAP - Unauthorized Remote Execution of a Sensitive Function Module,8e8a95c5-7f78-435e-9e6a-7e29c0b831c1,As alert only (low fidelity),Access Control,03.01.15,Security,User activity,Security,User activity,Detective,ConfirmDetails, AssignToTier2,SAPDevelopment,SAPSOC\nsecurityauditlogconfigurationchange,SAP - Security Audit Log Configuration Change,ea0f2cc5-9ee4-45b0-bc19-fdbdf37b4db4,As incident (high fidelity),Audit and Accountability,03.03.08,Change management,Audit logging,Change management,Audit logging,Preventative,ConfirmDetails, AssignToTier2,SAPSecurity,SAPSOC\nsensitivedatasavedintoausbdrive,SAP - Sensitive data saved into a USB drive,870d9ea0-cd99-4644-9c7a-d7256b0b37e0,As incident (high fidelity),Media Protection,03.08.07,Security,Information Access,Security,Information Access,Detective,ConfirmDetails, AssignToTier2,SAPSOC,SAPSOC\nsensitiveprivilegeduserloggedin,SAP - Sensitive Privileged User Logged in,97d13311-748b-4016-b095-9100ab00e4db,As alert only (low fidelity),Access Control,03.01.01,Security,Login activity,Security,Login activity,Preventative,ConfirmDetails, AssignToTier2,SAPBasis,SAPSOC\nsensitiveprivilegedusermakesachangeinanotheruser,SAP - Sensitive privileged user makes a change in another user,47848010-7a36-44f7-96be-d988f3de9421,As alert only (low fidelity),Access Control,03.01.04,Security,Login activity,Security,Login activity,Preventative,ConfirmDetails, AssignToTier2,SAPBasis,SAPSOC\nsensitiverolechanges,SAP - Sensitive Role Changes,9fadb366-a7ec-474c-90e1-d1a823176a1e,As alert only (low fidelity),Access Control,03.01.07,Access Controls,Sensitive Authorization Monitoring,Access Controls,Sensitive Authorization Monitoring,Preventative,ConfirmDetails, AssignToTier2,SAPSecurity,SAPSOC\nsensitivestaticparameterhaschanged,SAP - Sensitive Static Parameter Has Changed,bde3ff9b-2b5d-4aec-8402-ac2f9dbbca7e,As alert only (low fidelity),Configuration Management,03.04.01,Change management,System Configuration Monitoring,Change management,System Configuration Monitoring,Preventative,ConfirmDetails, AssignToTier2,SAPBasis,SAPSOC\nsensitivetablesdirectaccessbydialoglogon,SAP - Sensitive Tables Direct Access By Dialog Logon,940baadd-fe19-4c1a-9680-63a9c5d21e1c,As alert only (low fidelity),Media Protection,03.08.02,Security,Information Access,Security,Information Access,Detective,ConfirmDetails, AssignToTier2,SAPSecurity,SAPSOC\nsensitivetablesdirectaccessbyrfclogon,SAP - Sensitive Tables Direct Access By RFC Logon,2521fd74-79f3-4adc-8350-edf4036913b3,As alert only (low fidelity),Access Control,03.01.15,Security,Information Access,Security,Information Access,Detective,ConfirmDetails, AssignToTier2,SAPSecurity,SAPSOC\nsensitiveuserspasswordchangeandlogin,SAP - Sensitive User's Password Change and Log in,4cc23b15-a048-45f1-b1e8-2dfc40013d84,As incident (medium fidelity),Access Control,03.01.07,Security,Login activity,Security,Login activity,Preventative,ConfirmDetails, AssignToTier2,SAPSecurity,SAPSOC\nspnegoattack,SAP - SPNego Attack,d83d4699-7bd5-44f1-826a-3bd3501712a9,As incident (high fidelity),Identification and Authentication,03.05.04,Security,Login activity,Security,Login activity,Detective,ConfirmDetails, AssignToTier2,SAPSOC,SAPSOC\nspooltakeover,SAP - Spool Takeover,27d73c8f-88fd-41b8-a785-231541aa32a0,As alert only (low fidelity),Media Protection,03.08.01,Security,Information Access,Security,Information Access,Detective,ConfirmDetails, AssignToTier2,SAPSecurity,SAPSOC\nsystemconfigurationchange,SAP - System Configuration Change,f4da8e9d-3515-4a2a-8cf0-43334fa29d91,As incident (high fidelity),Configuration Management,03.04.03,Change management,System Configuration Monitoring,Change management,System Configuration Monitoring,Preventative,ConfirmDetails, AssignToTier2,SAPBasis,SAPSOC\ntransactionisunlocked,SAP - Transaction is unlocked,35ff4cf7-ed01-4ec2-92e5-ffcbf88fb294,As alert only (low fidelity),Configuration Management,03.04.06,Change management,System Configuration Monitoring,Change management,System Configuration Monitoring,Preventative,ConfirmDetails, AssignToTier2,SAPSecurity,SAPSOC\nusercreatesandusesnewuser,SAP - User Creates and uses new user,12509d03-0206-4b85-84b9-6d2349afa42b,As incident (high fidelity),Access Control,03.01.07,Security,Login activity,Security,Login activity,Preventative,ConfirmDetails, AssignToTier2,SAPSecurity,SAPSOC\nuserunlocksandusesotherusers,SAP - User Unlocks and uses other users,7224ad22-e2cf-459d-9359-62310555e716,As incident (high fidelity),Access Control,03.01.07,Security,Login activity,Security,Login activity,Preventative,ConfirmDetails, AssignToTier2,SAPSecurity,SAPSOC\n",
                "watchlistAlias": "SAPAlertRulesMetadata",
                "contentType": "text/csv"
            },
            "condition": "[parameters('wl_17_creation_required')]"
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/Watchlists",
            "apiVersion": "2023-02-01",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/SAPSolutionConfig')]",
            "properties": {
                "description": "A local data base designed to store various configuration options.",
                "displayName": "SAPSolutionConfig",
                "source": "ContentHub",
                "provider": "Microsoft",
                "numberOfLinesToSkip": 0,
                "itemsSearchKey": "ConfigType",
                "rawContent": "ConfigType,ConfigKey,TeamsGroup,TeamsChannel,Email\nTeams,SAPSecurity,cc5ab7fd-7656-4d01-809c-cddb180ddb46,19:3a8d3cf10784fa47b894d8c6cc46217541@thread.tacv2,Sentinel4SAPSecurity@microsoft.com\nTeams,SAPBasis,cc5ab7fd-7656-4d01-809c-cddb180ddb46,19:36ba6517299a4e8aabe014ed1545bf7d@thread.tacv2,Sentinel4SAPBasis@microsoft.com\nTeams,SAPDevelopment,cc5ab7fd-7656-4d01-809c-cddb180ddb46,19:3a8d6fdf2df5214395929d44c52afccd09@thread.tacv2,Sentinel4SAPDevelopment@microsoft.com\nTeams,SAPSOC,cc5ab7fd-7656-4d01-809c-cddb180ddb46,19:3ae688a5db3c6b4657bc49139f88d24ece@thread.tacv2,Sentinel4SAPSOC@microsoft.com\n",
                "watchlistAlias": "SAPSolutionConfig",
                "contentType": "text/csv"
            },
            "condition": "[parameters('wl_18_creation_required')]"
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/Watchlists",
            "apiVersion": "2023-02-01",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/SAPSystemParameters')]",
            "properties": {
                "description": "Parameters to watch for. This watch list comes prefilled with best practice, and can be extended by you to include additional parameters. Parameters that you wish not be alerted on can be set with 'EnableAlerts' == 'false'",
                "displayName": "SAPSystemParameters",
                "source": "ContentHub",
                "provider": "Microsoft",
                "numberOfLinesToSkip": 0,
                "itemsSearchKey": "ParameterName",
                "rawContent": "ParameterName,Comment,EnableAlerts,Option,ProductionValues,NonProdValues,ProductionSeverity,NonProdSeverity\ngw/accept_remote_trace_level,CPIC and RFC: adopt remote trace level?,True,,0,0,High,High\nlogin/password_change_for_SSO,Handling of password change enforcements in Single Sign-On situations,True,,1,1,High,Medium\nicm/accept_remote_trace_level,Accept external switch of trace level,True,,0,0,High,High\nrdisp/gui_auto_logout,Maximum idle time for SAP GUI connections,True,LE,3600,5400,High,Medium\nrsau/enable,Enable Security Audit,True,,1,1,High,High\nlogin/min_password_diff,min. number of chars which differ between old and new password,True,LE,2,1,High,Medium\nlogin/min_password_digits,min. number of digits in passwords,True,GE,2,0,High,Medium\nlogin/ticket_only_by_https,generate ticket that will only be sent via https,True,,1,0,High,Medium\nauth/rfc_authority_check,Execution option for the RFC authority check,True,GE,1,1,High,High\ngw/acl_mode,Mode for non existing ACL file,True,,0,1,High,High\ngw/logging,settings for gateway logging,True,AlertOnAnyChange,,,High,Medium\nlogin/fails_to_session_end,Number of invalid login attempts until session end,True,LE,3,3,High,Medium\nwdisp/ssl_encrypt,SSL reencryption mode,True,,1,1,High,High\nlogin/no_automatic_user_sapstar,Control of the automatic login user SAP*,True,,1,1,High,Medium\nrsau/max_diskspace/local,Maximum space for security audit file,True,GE,1500000000,1000000000,High,Medium\nsnc/extid_login_diag,Enable login with external identity (DIAG),True,,1,1,High,Medium\nlogin/password_change_waittime,Password change possible after # days (since last change),True,GE,1,1,High,Medium\nsnc/accept_insecure_cpic,Accept insecure CPIC-connections to SNC-enabled Server,True,,0,1,High,Medium\nsnc/accept_insecure_r3int_rfc,Accept insecure internal RFCs on SNC-enabled Server,True,,0,1,High,Medium\nsnc/accept_insecure_rfc,Accept insecure RFC-connections to SNC-enabled Server,True,,0,1,High,Medium\nsnc/data_protection/max,Limit for data protection of Secure Network Comm.,True,,3,3,High,Medium\nrspo/auth/pagelimit,Activation of page limit check for spool devices,True,,0,0,High,High\nsnc/accept_insecure_gui,Accept insecure SAPGUI logins to SNC-enabled Server,True,,0,1,High,Medium\nlogin/accept_sso2_ticket,Accept SSO tickets for this (component) system,True,,1,1,High,High\nlogin/multi_login_users,list of exceptional users: multiple logon allowed,True,,,,High,Medium\nlogin/password_expiration_time,Dates until password must be changed,True,LE,90,180,High,Medium\nlogin/password_max_idle_initial,maximum #days a password (set by the admin) can be unused (idle),True,LE,7,7,High,Medium\nlogin/password_history_size,Number of records to be stored in the password history,True,GE,5,5,High,Medium\nsnc/data_protection/use,Level of data protection for R/3 initiated connections,True,,3,3,High,Medium\nrsau/max_diskspace/per_day,Maximum size of all security audit files per day,True,GE,1500000000,1000000000,High,Medium\nsnc/enable,Enable SNC-Module (Secure Network Communications),True,,1,1,High,Medium\nauth/no_check_in_some_cases,Activation of the Profile Generator,True,,Y,Y,High,High\nauth/object_disabling_active,Value 'N' prohibits disabling of authorization objects,True,,Y,Y,High,High\nlogin/disable_multi_gui_login,disable multiple sapgui logons (for same SAP account),True,,1,1,High,High\nlogin/min_password_lng,Minimum Password Length,True,GE,8,6,High,Medium\nrfc/reject_expired_passwd,Prevents logon with initial or expired Password via RFC,True,,1,1,High,Medium\nrsau/max_diskspace/per_file,Maximum size of one single security audit file,True,GE,1500000000,1000000000,High,Medium\nlogin/min_password_letters,min. number of letters in passwords,True,GE,2,0,High,Medium\nrsau/selection_slots,Number of selection slots for security audit,True,,10,10,High,High\ngw/sim_mode,start simulation mode for reg_info and sec_info,True,,0,0,High,Medium\nlogin/fails_to_user_lock,Number of invalid login attempts until user lock,True,LE,5,5,High,Medium\nlogin/password_compliance_to_current_policy,current password needs to comply with current password policy,True,,0,0,High,Medium\nrfc/ext_debugging,Remote Function call debugging. See SAP KB 2909642 - Deletion of parameter rfc/ext_debugging,True,LE,2,2,High,Medium\ngw/monitor,Enables or disables monitor commands,True,,1,1,High,Medium\nlogin/create_sso2_ticket,Create SSO tickets on  this  system,True,,3,3,High,High\nlogin/failed_user_auto_unlock,Enable automatic unlock off locked user at midnight,True,,0,0,High,Medium\nlogin/min_password_uppercase,minimum number of upper-case characters in passwords,True,GE,1,0,High,Medium\nlogin/min_password_specials,min. number of special characters in passwords,True,,0,0,High,Medium\nsnc/extid_login_rfc,Enable login with external identity (RFC),True,,1,1,High,Medium\nlogin/min_password_lowercase,minimum number of lower-case characters in passwords,True,GE,1,0,High,Medium\nlogin/password_downwards_compatibility,password downwards compatibility (8 / 40 characters, case-sensitivity),True,,0,0,High,Medium\nsnc/data_protection/min,Min. required data protection for incoming connections,True,,3,3,High,Medium\nDIR_AUDIT,Directory for Security Audit Files,True,AlertOnAnyChange,,,High,Medium\n",
                "watchlistAlias": "SAPSystemParameters",
                "contentType": "text/csv"
            },
            "condition": "[parameters('wl_19_creation_required')]"
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/Watchlists",
            "apiVersion": "2023-02-01",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/SAP_Dynamic_Audit_Log_Monitor_Configuration')]",
            "properties": {
                "description": "Configure the SAP audit log alerts by assigning each message ID a severity level as required by you, per system role (production, non-production). This watchlist also allows for configuring a designated team to handle each of the messages. Configure the SAP audit log alerts by assigning each message ID a severity level as required by you, per system role (production, non-production). This watchlist also allows for configuring a designated team to handle each of the messages, and excluding users by SAP roles or by tags from the SAPVIPUsers watchlist.",
                "displayName": "SAP_Dynamic_Audit_Log_Monitor_Configuration",
                "source": "ContentHub",
                "provider": "Microsoft",
                "numberOfLinesToSkip": 0,
                "itemsSearchKey": "MessageID",
                "rawContent": "MessageID,MessageText,DetailedDescription,CategoryName,StandardEventWeighting,ProductionSeverity,NonProdSeverity,ProductionThreshold,NonProdThreshold,RuleType,Tactics,TeamsChannelID,DestinationEmail,RolesTagsToExclude\nAU0,\"Audit - Test. Text: &A\",\"Audit - Test. Text: &A\",Other,Non-Critical,Low,Low,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nAU1,\"Logon successful (type=&A  method=&C)\",\"Logon successful (type=&A; method=&C)\",Logon,Severe,Low,Low,30,60,AnomaliesOnly,,TeamChannelID,,MassiveLogonsOK; ZZZ_ALL_TRUSTED_RFC\nAU2,\"Logon failed (reason=&B  type=&A  method=&C)\",\"Logon failed (reason=&B; type=&A; method=&C)\",Logon,Critical,High,High,6,30,AnomaliesOnly,Initial Access,,,\nAU3,\"Transaction &A started.\",\"Transaction &A started.\",Transaction Start,Non-Critical,Low,Low,0,0,AnomaliesOnly,,,AuthTeam@MyOrg.COM,\nAU4,\"Start of transaction &A failed (Reason=&B)\",\"<strong>The user attempted to start the transaction specified in the message. However; starting the transaction failed; that is; the transaction was not executed.</strong> <p>Possible Reasons</p><oul><li>0 - Cause unknown</li><li>1 - Error in call parameters when calling the kernel function</li><li>2 - Transaction does not exist</li><li>3 - Transaktion & is locked (in transaction SM01)</li><li>4 - Transaction is an area menu and therefore cannot be executed</li><li>5 - Parameter transaction is an area menu and therefore cannot be executed</li><li>6 - User is not authorized for this transaction</li></ul>\",Transaction Start,Critical,Low,Low,0,0,AnomaliesOnly,,,AuthTeam@MyOrg.COM,\nAU5,\"RFC/CPIC logon successful (type=&A  method=&C)\",\"RFC/CPIC logon successful (type=&A; method=&C)\",RFC Login,Non-Critical,Medium,Disabled,300,1000,Disabled,,,SOCTeam@MyOrg.COM,\nAU6,\"RFC/CPIC logon failed  reason=&B  type=&A  method=&C\",\"RFC/CPIC logon failed; reason=&B; type=&A; method=&C\",RFC Login,Critical,Disabled,Disabled,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,MassiveRFCOK\nAU7,\"User &A created.\",\"User &A created.\",User Master Record Change,Critical,High,Low,10,0,AnomaliesOnly,,,AuthTeam@MyOrg.COM,\nAU8,\"User &A deleted.\",\"User &A deleted.\",User Master Record Change,Severe,Medium,Medium,10,0,AnomaliesOnly,Impact,,AuthTeam@MyOrg.COM,\nAU9,\"User &A locked.\",\"User &A locked.\",User Master Record Change,Severe,Medium,Medium,10,0,AnomaliesOnly,Impact; Privilege Escalation,,AuthTeam@MyOrg.COM,MassiveAuthChangesOK\nAUA,\"User &A unlocked.\",\"User &A unlocked.\",User Master Record Change,Severe,Medium,Medium,10,0,AnomaliesOnly,Privilege Escalation,,AuthTeam@MyOrg.COM,MassiveAuthChangesOK\nDUQ,\"Active scenario &A for switchable authorization checks changed - &B\",\"Active scenario &A for switchable authorization checks changed - &B\",Other,Critical with Monitor Alert,High,High,0,0,AnomaliesOnly,Initial Access,,AuthTeam@MyOrg.COM,\nAUC,\"User Logoff\",\"User Logoff\",Logon,Non-Critical,Low,Low,0,0,AnomaliesOnly,,                                                                                                ,,\nAUD,\"User master record &A changed.\",\"User master record &A changed.\",User Master Record Change,Severe,Medium,Disabled,60,6,AnomaliesOnly,,,AuthTeam@MyOrg.COM,MassiveAuthChangesOK\nAUE,\"Audit configuration changed\",\"Audit configuration changed\",System,Critical,High,High,0,0,Deterministic,Defense Evasion,,BasisTeam@MyOrg.COM,\nAUF,\"Audit: Slot &A: Class &B  Severity &C  User &D  Client &E  &F\",\"Audit: Slot &A: Class &B; Severity &C; User &D; Client &E; &F\",System,Critical,High,High,0,0,AnomaliesOnly,Defense Evasion,,BasisTeam@MyOrg.COM,\nAUG,\"Application server started\",\"Application server started\",System,Critical,High,High,0,0,Deterministic,Impact,,BasisTeam@MyOrg.COM,\nAUH,\"Application server stopped\",\"Application server stopped\",System,Critical,High,High,0,0,Deterministic,Impact,,BasisTeam@MyOrg.COM,\nAUI,\"Audit: Slot &A Inactive\",\"Audit: Slot &A Inactive\",System,Critical,High,High,0,0,AnomaliesOnly,Impact,,BasisTeam@MyOrg.COM,\nAUJ,\"Audit: Active status set to &1\",\"Audit: Active status set to &1\",System,Critical with Monitor Alert,High,High,0,0,AnomaliesOnly,Impact,,BasisTeam@MyOrg.COM,\nAUK,\"Successful RFC call &C (function group = &A)\",\"Successful RFC call &C (function group = &A)\",RFC Start,Non-Critical,Medium,Disabled,1000,1000,Disabled,,,SOCTeam@MyOrg.COM,MassiveRFCOK\nAUL,\"Failed RFC call &C (function group = &A)\",\"Failed RFC call &C (function group = &A)\",RFC Start,Critical,Medium,Disabled,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nAUM,\"User &B locked in client &A after errors in password checks\",\"User &B locked in client &A after errors in password checks\",Logon,Critical with Monitor Alert,High,High,0,6,Deterministic,Reconnaissance,,,\nAUN,\"User &B unlocked in client &A after entering wrong password\",\"User &B unlocked in client &A after entering wrong password\",Logon,Critical,High,High,0,0,Deterministic,Reconnaissance,,,\nAUO,\"Logon failed (reason = &B  type = &A)\",\"Logon failed (reason = &B; type = &A)\",Logon,Severe,Medium,Medium,6,30,AnomaliesOnly,Reconnaissance,,,\nAUP,\"Transaction &A locked\",\"Transaction &A locked\",Transaction Start,Severe,Medium,Medium,0,0,AnomaliesOnly,Exfiltration,,AuthTeam@MyOrg.COM,\nAUQ,\"Transaction &A unlocked\",\"Transaction &A unlocked\",Transaction Start,Severe,Medium,Medium,0,0,AnomaliesOnly,Resource Development,,AuthTeam@MyOrg.COM,\nAUR,\"&A &B created\",\"&A &B created\",User Master Record Change,Severe,Medium,Medium,10,10,AnomaliesOnly,Privilege Escalation,,AuthTeam@MyOrg.COM,MassiveAuthChangesOK\nAUS,\"&A &B deleted\",\"&A &B deleted\",User Master Record Change,Severe,Medium,Medium,10,10,AnomaliesOnly,Impact,,AuthTeam@MyOrg.COM,MassiveAuthChangesOK\nAUT,\"&A &B changed\",\"&A &B changed\",User Master Record Change,Severe,Medium,Medium,10,10,AnomaliesOnly,Privilege Escalation,,AuthTeam@MyOrg.COM,MassiveAuthChangesOK\nAUU,\"&A &B activated\",\"&A &B activated\",User Master Record Change,Critical,High,High,10,10,AnomaliesOnly,Privilege Escalation,,AuthTeam@MyOrg.COM,\nAUV,\"Digital signature error (reason = &A  ID = &B)\",\"Digital signature error (reason = &A; ID = &B)\",Other,Critical,High,High,0,0,Deterministic,,,SOCTeam@MyOrg.COM,\nAUW,\"Report &A started\",\"Report &A started\",Report Start,Non-Critical,Disabled,Disabled,0,0,AnomaliesOnly,,,AuthTeam@MyOrg.COM,\nAUX,\"Start of report &A failed (reason = &B)\",\"<strong>The user attempted to start the report specified in the message. The report could not be started and therefore could not be executed.</strong><p>Possible reasons:</p><oul><li>User exit - The user does not have the authorizations checked in the user exit when the report is started.</li><li>No authorization The user does not have authorization for the authorization group of the report (authorization object S_PROGRAM).</li>\",Report Start,Severe,Medium,Low,10,0,AnomaliesOnly,,,AuthTeam@MyOrg.COM,\nAUY,\"Download &A Bytes to File &C\",\"Download &A Bytes to File &C\",Other,Severe,Low,Low,15,20,AnomaliesOnly,Exfiltration,High False positives. Should be grouped by,SOCTeam@MyOrg.COM,MassiveDownloadsOK\nAUZ,\"Digital Signature (Reason = &A  ID = &B)\",\"Digital Signature (Reason = &A; ID = &B)\",Other,Severe,Medium,Medium,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nBU0,\"RAL configuration access: Action: &A  type: &B  name &C\",\"RAL configuration access: Action: &A; type: &B; name &C\",Other,Critical with Monitor Alert,High,High,0,0,AnomaliesOnly,Resource Development,,SOCTeam@MyOrg.COM,\nBU1,\"Password check failed for user &B in client &A\",\"Password check failed for user &B in client &A\",Other,Critical with Monitor Alert,High,Medium,6,30,AnomaliesOnly,Initial Access,,SOCTeam@MyOrg.COM,\nBU2,\"Password changed for user &B in client &A\",\"Password changed for user &B in client &A\",User Master Record Change,Non-Critical,Low,Low,0,0,AnomaliesOnly,,,AuthTeam@MyOrg.COM,\nBU3,\"Security check changed in export: Old value &A  new value &B\",\"Security check changed in export: Old value &A; new value &B\",Other,Critical with Monitor Alert,High,High,0,0,AnomaliesOnly,Resource Development,,SOCTeam@MyOrg.COM,\nBU4,\"Dynamic ABAP code: Event &A  event type &B  check total &C\",\"Dynamic ABAP code: Event &A; event type &B; check total &C\",Other,Non-Critical,Low,Low,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nBU5,\"ICF recorder entry executed for user &A (activity &B)\",\"ICF recorder entry executed for user &A (activity &B)\",Other,Severe,Medium,Medium,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nBU6,\"ICF recorder entry executed by user &A (&B  &C) (activity &D).\",\"ICF recorder entry executed by user &A (&B; &C) (activity &D).\",Other,Severe,Medium,Medium,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nBU7,\"Administration setting was changed for ICF Recorder (Activity: &A)\",\"Administration setting was changed for ICF Recorder (Activity: &A)\",Other,Severe,Medium,Medium,0,0,AnomaliesOnly,Resource Development,,SOCTeam@MyOrg.COM,\nBU8,\"Virus Scan Interface: Virus &C found by profile &A (step &B)\",\"Virus Scan Interface: Virus &C found by profile &A (step &B)\",Other,Critical,High,High,0,0,Deterministic,Exfiltration,,SOCTeam@MyOrg.COM,\nBU9,\"Virus Scan Interface: Error &C occurred in profile &A (step &B)\",\"Virus Scan Interface: Error &C occurred in profile &A (step &B)\",Other,Severe,Medium,Medium,0,0,AnomaliesOnly,Exfiltration,,SOCTeam@MyOrg.COM,\nBUA,\"WS: Signature check error (reason &B  WP &C). Refer to Web service log &A.\",\"WS: Signature check error (reason &B; WP &C). Refer to Web service log &A.\",Other,Severe,Medium,Medium,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nBUB,\"WS: Signature insufficient (WP &C). Refer to Web service log &A.\",\"WS: Signature insufficient (WP &C). Refer to Web service log &A.\",Other,Severe,Medium,Medium,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nBUC,\"WS: Time stamp is invalid. Refer to Web service log &A.\",\"WS: Time stamp is invalid. Refer to Web service log &A.\",Other,Severe,Medium,Medium,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nBUD,\"WS: Delayed logon failed (type &B  WP &C). Refer to Web service log &A.\",\"WS: Delayed logon failed (type &B; WP &C). Refer to Web service log &A.\",Logon,Critical,High,High,0,0,AnomaliesOnly,Reconnaissance,,,\nBUE,\"WS: Delayed logon successful (type &B  WP &C). Refer to Web service log &A.\",\"WS: Delayed logon successful (type &B; WP &C). Refer to Web service log &A.\",Logon,Critical,High,High,0,0,AnomaliesOnly,Reconnaissance,,,\nBUF,\"HTTP Security Session Management was activated for client &A.\",\"HTTP Security Session Management was activated for client &A.\",Other,Non-Critical,Low,Low,0,0,AnomaliesOnly,,,BasisTeam@MyOrg.COM,\nBUG,\"HTTP Security Session Management was deactivated for client &A.\",\"HTTP Security Session Management was deactivated for client &A.\",Other,Critical with Monitor Alert,High,High,0,0,Deterministic,Resource Development,,BasisTeam@MyOrg.COM,\nBUH,\"HTTP Security Session of user &A (client &B) was hard exited\",\"HTTP Security Session of user &A (client &B) was hard exited\",Other,Severe with Monitor Alert,Medium,Medium,0,0,AnomaliesOnly,Defense Evasion,,SOCTeam@MyOrg.COM,\nBUI,\"SPNego replay attack detected (UPN=&A)\",\"SPNego replay attack detected (UPN=&A)\",Logon,Critical,High,High,0,0,Deterministic,Initial Access,,,\nBUJ,\"Non-encrypted &A communication (&B)\",\"Non-encrypted &A communication (&B)\",Other,Severe,Disabled,Disabled,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nBUK,\"&A assertion used\",\"&A assertion used\",Logon,Non-Critical,Low,Low,0,0,AnomaliesOnly,,,,\nBUL,\"&A: &B\",\"&A: &B\",Logon,Non-Critical,Low,Low,0,0,AnomaliesOnly,,,,\nBUM,\"Name ID of a subject\",\"Name ID of a subject\",Logon,Non-Critical,Low,Low,0,0,AnomaliesOnly,,,,\nBUN,\"Attribute\",\"Attribute\",Logon,Non-Critical,Low,Low,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nBUO,\"Authentication assertion\",\"Authentication assertion\",Logon,Non-Critical,Low,Low,0,0,AnomaliesOnly,,,AuthTeam@MyOrg.COM,\nBUP,\"&A\",\"&A\",Logon,Non-Critical,Low,Low,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nBUQ,\"Signed LogoutRequest accepted\",\"Signed LogoutRequest accepted\",Logon,Non-Critical,Low,Low,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nBUR,\"Unsigned LogoutRequest accepted\",\"Unsigned LogoutRequest accepted\",Logon,Non-Critical,Low,Low,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nBUS,\"&A: Request without sufficient security characteristic of address &B.\",\"&A: Request without sufficient security characteristic of address &B.\",Other,Critical,High,High,0,0,AnomaliesOnly,Initial Access,,SOCTeam@MyOrg.COM,\nBUT,\"CRL download failed with error code &A\",\"CRL download failed with error code &A\",Other,Severe,Medium,Medium,0,0,AnomaliesOnly,Exfiltration,,SOCTeam@MyOrg.COM,\nBUU,\"Certificate check for subject &A with profile &B failed (status &C)\",\"Certificate check for subject &A with profile &B failed (status &C)\",Other,Critical,High,High,0,0,Deterministic,Exfiltration,,SOCTeam@MyOrg.COM,\nBUV,\"Invalid hash value &A. The context contains &B.\",\"Invalid hash value &A. The context contains &B.\",User Master Record Change,Critical,High,High,0,0,AnomaliesOnly,Defense Evasion,,AuthTeam@MyOrg.COM,\nBUW,\"A refresh token issued to client &A was used by client &B.\",\"A refresh token issued to client &A was used by client &B.\",User Master Record Change,Critical,High,High,0,0,Deterministic,Defense Evasion,,AuthTeam@MyOrg.COM,\nBUX,\"Test message\",\"Test message\",Transaction Start,Severe,Medium,Medium,0,0,AnomaliesOnly,,,AuthTeam@MyOrg.COM,\nBUY,\"Field contents changed: &5&9&9&9&9&9\",\"Field contents changed: &5&9&9&9&9&9\",Other,Critical,High,High,0,0,AnomaliesOnly,Execution,,SOCTeam@MyOrg.COM,\nBUZ,\"> in program &A  line &B  event &C\",\"> in program &A; line &B; event &C\",Other,Critical,Disabled,Disabled,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nCU0,\"RAL Log Access: Action: &A\",\"RAL Log Access: Action: &A\",Other,Critical,High,High,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nCU1,\"CU Test Message\",\"CU Test Message\",Other,Severe,Medium,Medium,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nCU2,\"OAuth 2.0: Invalid access token received (reason=&A)\",\"OAuth 2.0: Invalid access token received (reason=&A)\",Logon,Severe,Medium,Medium,6,30,AnomaliesOnly,Reconnaissance,,AuthTeam@MyOrg.COM,\nCU3,\"OAuth 2.0: Insufficient OAuth 2.0 scope for requested resource (user=&A)\",\"OAuth 2.0: Insufficient OAuth 2.0 scope for requested resource (user=&A)\",Logon,Severe,Medium,Medium,6,30,AnomaliesOnly,Reconnaissance,,AuthTeam@MyOrg.COM,\nCU4,\"OAuth 2.0: Logged-on client user &A not same as parameter client ID &B\",\"OAuth 2.0: Logged-on client user &A not same as parameter client ID &B\",Logon,Critical,High,High,0,0,Deterministic,Reconnaissance,,AuthTeam@MyOrg.COM,\nCU5,\"OAuth 2.0: Client &A requested invalid access grant type &B\",\"OAuth 2.0: Client &A requested invalid access grant type &B\",Logon,Severe,Medium,Medium,6,30,AnomaliesOnly,Reconnaissance,,AuthTeam@MyOrg.COM,\nCU6,\"OAuth 2.0: Client ID &A in SAML assertion not same as client ID &B in request\",\"OAuth 2.0: Client ID &A in SAML assertion not same as client ID &B in request\",Logon,Critical,High,High,0,0,Deterministic,Reconnaissance,,AuthTeam@MyOrg.COM,\nCU7,\"OAuth 2.0: Scope &B not permitted for client &C  user &D (cause=&A)\",\"OAuth 2.0: Scope &B not permitted for client &C; user &D (cause=&A)\",Logon,Severe,Medium,Medium,6,30,AnomaliesOnly,Reconnaissance,,AuthTeam@MyOrg.COM,\nCU8,\"OAuth 2.0: Access token issued (client=&A  user=&B  grant type=&C)\",\"OAuth 2.0: Access token issued (client=&A; user=&B; grant type=&C)\",Logon,Non-Critical,Low,Low,0,0,AnomaliesOnly,,,AuthTeam@MyOrg.COM,\nCU9,\"OAuth 2.0: Valid access token received for user &A\",\"OAuth 2.0: Valid access token received for user &A\",Logon,Non-Critical,Low,Low,0,0,AnomaliesOnly,,,AuthTeam@MyOrg.COM,\nCUA,\"Rejected Assertion\",\"Rejected Assertion\",Logon,Severe,Medium,Medium,0,0,AnomaliesOnly,Reconnaissance,,SOCTeam@MyOrg.COM,\nCUB,\"&A: &B\",\"&A: &B\",Logon,Severe,Medium,Medium,0,0,AnomaliesOnly,Initial Access,,SOCTeam@MyOrg.COM,UnsafeSAML_OK\nCUC,\"&A\",\"&A\",Logon,Severe,Medium,Medium,0,0,AnomaliesOnly,Initial Access,,SOCTeam@MyOrg.COM,\nCUD,\"Name ID of a subject\",\"Name ID of a subject\",Logon,Severe,Medium,Medium,0,0,AnomaliesOnly,Initial Access,,SOCTeam@MyOrg.COM,\nCUE,\"Attribute\",\"Attribute\",Logon,Severe,Medium,Medium,0,0,AnomaliesOnly,Initial Access,,SOCTeam@MyOrg.COM,\nCUF,\"Authentication Assertion\",\"Authentication Assertion\",Logon,Severe,Medium,Medium,0,0,AnomaliesOnly,Initial Access,,AuthTeam@MyOrg.COM,\nCUG,\"Signed LogoutRequest rejected\",\"Signed LogoutRequest rejected\",Logon,Severe,Medium,Medium,0,0,AnomaliesOnly,Initial Access,,SOCTeam@MyOrg.COM,\nCUH,\"Unsigned LogoutRequest rejected\",\"Unsigned LogoutRequest rejected\",Logon,Severe,Medium,Medium,0,0,AnomaliesOnly,Initial Access,,SOCTeam@MyOrg.COM,\nCUI,\"Application &A started\",\"Application &A started\",Transaction Start,Non-Critical,Low,Low,0,0,AnomaliesOnly,,,BasisTeam@MyOrg.COM,\nCUJ,\"Failed to start application &A (reason =&B)\",\"Failed to start application &A (reason =&B)\",Transaction Start,Critical,High,High,0,0,AnomaliesOnly,Initial Access,,BasisTeam@MyOrg.COM,\nCUK,\"C debugging activated\",\"C debugging activated\",Other,Critical,High,Low,0,0,Deterministic,,,BasisTeam@MyOrg.COM,\nCUL,\"Field content in debugger changed by user &A: &B (&C)\",\"Field content in debugger changed by user &A: &B (&C)\",Other,Critical,High,Low,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nCUM,\"Jump to ABAP Debugger by user &A: &B (&C)\",\"<strong>In the ABAP Debugger; the user set the instruction pointer to anotherline or statement. </strong>    </br>This changed the program flow. </br>During the continued execution of the program you may pass through parts of the program thatwould usually not have been executed; or at least not under theseconditions.\",Other,Critical,High,Low,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nCUN,\"A process was stopped from the debugger by user &A (&C)\",\"A process was stopped from the debugger by user &A (&C)\",Other,Critical,High,Low,0,0,Deterministic,,,SOCTeam@MyOrg.COM,\nCUO,\"Explicit database operation in debugger by user &A: &B (&C)\",\"Explicit database operation in debugger by user &A: &B (&C)\",Other,Critical,High,Medium,0,0,Deterministic,,,SOCTeam@MyOrg.COM,\nCUP,\"Non-exclusive debugging session started by user &A (&C)\",\"Non-exclusive debugging session started by user &A (&C)\",Other,Critical,High,Low,0,0,Deterministic,,,SOCTeam@MyOrg.COM,\nCUQ,\"Logical file name &A not configured. Physical file name &B not checked.\",\"Logical file name &A not configured. Physical file name &B not checked.\",Other,Severe,Medium,Medium,0,0,AnomaliesOnly,Exfiltration,,SOCTeam@MyOrg.COM,\nCUR,\"Physical file name &B does not fulfill requirements from logical file name &A\",\"Physical file name &B does not fulfill requirements from logical file name &A\",Other,Severe,Medium,Medium,0,0,AnomaliesOnly,Exfiltration,,SOCTeam@MyOrg.COM,\nCUS,\"Logical file name &B is not a valid alias for logical file name &A\",\"Logical file name &B is not a valid alias for logical file name &A\",Other,Severe,Medium,Medium,0,0,AnomaliesOnly,Exfiltration,,SOCTeam@MyOrg.COM,\nCUT,\"Validation for logical file name &A is not active\",\"Validation for logical file name &A is not active\",Other,Severe,Medium,Medium,0,0,AnomaliesOnly,Exfiltration,,SOCTeam@MyOrg.COM,\nCUU,\"Payload of PI/WS message &A was read | &B\",\"Payload of PI/WS message &A was read | &B\",Other,Non-Critical,Low,Low,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nCUV,\"Successful WS Call (service = &A  operation &B)\",\"Successful WS Call (service = &A; operation &B)\",RFC Start,Non-Critical,Low,Low,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nCUW,\"Failed Web service call (service = &A  operation = &B  reason = &C)\",\"Failed Web service call (service = &A; operation = &B; reason = &C)\",RFC Start,Critical,High,High,0,0,AnomaliesOnly,Lateral Movement,,SOCTeam@MyOrg.COM,\nCUX,\"Payload of postprocessing request &A read\",\"Payload of postprocessing request &A read\",Other,Non-Critical,Low,Low,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nCUY,\"> &A\",\"> &A\",Other,Non-Critical,Low,Low,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nCUZ,\"Generic table access by RFC to &A with activity &B\",\"Generic table access by RFC to &A with activity &B\",RFC Start,Critical,High,Medium,6,6,AnomaliesOnly,,,SOCTeam@MyOrg.COM,GenericTablebyRFCOK\nDU0,\"Invalid SAP GUI data\",\"Invalid SAP GUI data\",Logon,Critical with Monitor Alert,High,High,0,0,AnomaliesOnly,Initial Access,,SOCTeam@MyOrg.COM,\nDU1,\"FTP server allowlist is empty\",\"FTP server allowlist is empty\",RFC Start,Severe,Medium,Medium,0,0,AnomaliesOnly,Lateral Movement,,SOCTeam@MyOrg.COM,\nDU2,\"FTP server allowlist is non-secure due to use of placeholders\",\"FTP server allowlist is non-secure due to use of placeholders\",RFC Start,Severe,Medium,Medium,0,0,AnomaliesOnly,Lateral Movement,,SOCTeam@MyOrg.COM,\nDU3,\"Server &A is not contained in the allowlist\",\"Server &A is not contained in the allowlist\",RFC Start,Critical,High,High,0,0,AnomaliesOnly,Lateral Movement,,SOCTeam@MyOrg.COM,\nDU4,\"Connection to server &A failed\",\"Connection to server &A failed\",RFC Start,Critical,High,High,0,0,AnomaliesOnly,Lateral Movement,,SOCTeam@MyOrg.COM,\nDU5,\"There is no logical file name for path &A\",\"There is no logical file name for path &A\",RFC Start,Critical,High,High,0,0,AnomaliesOnly,Exfiltration,,SOCTeam@MyOrg.COM,\nDU6,\"Validation for &A successful\",\"Validation for &A successful\",RFC Start,Non-Critical,Low,Low,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nDU7,\"Validation for &A failed\",\"Validation for &A failed\",RFC Start,Critical with Monitor Alert,High,High,0,0,AnomaliesOnly,Lateral Movement,,SOCTeam@MyOrg.COM,\nDU8,\"FTP connection request for server &A successful\",\"FTP connection request for server &A successful\",RFC Start,Non-Critical,Low,Low,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nDU9,\"Generic table access call to &A with activity &B (auth. check: &C )\",\"Generic table access call to &A with activity &B (auth. check: &C )\",Transaction Start,Non-Critical,Low,Low,0,0,AnomaliesOnly,,,AuthTeam@MyOrg.COM,\nDUA,\"EHS-SADM: Service &A created on host &B\",\"EHS-SADM: Service &A created on host &B\",Other,Severe,Medium,Medium,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nDUB,\"EHS-SADM: Service &A started on host &B\",\"EHS-SADM: Service &A started on host &B\",Other,Severe,Medium,Medium,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nDUC,\"EHS-SADM: Service &A ended on host &B\",\"EHS-SADM: Service &A ended on host &B\",Other,Severe,Medium,Medium,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nDUD,\"EHS-SADM: Service &A deleted on host &B\",\"EHS-SADM: Service &A deleted on host &B\",Other,Severe,Medium,Medium,0,0,AnomaliesOnly,Impact,,BasisTeam@MyOrg.COM,\nDUE,\"EHS-SADM: Configuration of service &A changed on host &B\",\"EHS-SADM: Configuration of service &A changed on host &B\",Other,Non-Critical,Low,Low,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nDUF,\"EHS-SADM: File &A transferred from host &B\",\"EHS-SADM: File &A transferred from host &B\",Other,Non-Critical,Low,Low,0,0,AnomaliesOnly,Exfiltration,,SOCTeam@MyOrg.COM,\nDUG,\"EHS-SADM: File &A transferred to host &B\",\"EHS-SADM: File &A transferred to host &B\",Other,Non-Critical,Low,Low,0,0,AnomaliesOnly,Exfiltration,,SOCTeam@MyOrg.COM,\nDUH,\"OAuth 2.0: Token declared invalid (OAuth client=&A  user=&B  token type=&C)\",\"OAuth 2.0: Token declared invalid (OAuth client=&A; user=&B; token type=&C)\",User Master Record Change,Severe with Monitor Alert,Medium,Medium,0,0,AnomaliesOnly,Defense Evasion,,AuthTeam@MyOrg.COM,\nDUI,\"RFC callback executed (destination &A  called &B  callback &C)\",\"RFC callback executed (destination &A; called &B; callback &C)\",RFC Start,Non-Critical,Medium,Medium,100,1000,AnomaliesOnly,Lateral Movement,,SOCTeam@MyOrg.COM,\nDUJ,\"RFC callback rejected (destination &A  called &B  callback &C)\",\"RFC callback rejected (destination &A; called &B; callback &C)\",RFC Start,Critical,High,High,0,0,AnomaliesOnly,Lateral Movement,,SOCTeam@MyOrg.COM,\nDUK,\"RFC callback in simulation mode (destination &A  called &B  callback &C)\",\"RFC callback in simulation mode (destination &A; called &B; callback &C)\",RFC Start,Critical,High,High,0,0,AnomaliesOnly,Lateral Movement,,SOCTeam@MyOrg.COM,\nDUL,\"Check for &A in allowlist &B was successful\",\"Check for &A in allowlist &B was successful\",Other,Non-Critical,Low,Low,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nDUM,\"Check for &A in allowlist &B failed\",\"Check for &A in allowlist &B failed\",Other,Severe with Monitor Alert,Medium,Medium,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nDUN,\"Active allowlist &A changed ( &B )\",\"Active allowlist &A changed ( &B )\",Other,Critical with Monitor Alert,High,High,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nDUP,\"Authorization check for object &A in scenario &B failed\",\"Authorization check for object &A in scenario &B failed\",Other,Non-Critical,Low,Low,0,0,AnomaliesOnly,Initial Access,,AuthTeam@MyOrg.COM,\nDUO,\"Authorization check for object &A in scenario &B successful\",\"Authorization check for object &A in scenario &B successful\",Other,Non-Critical,Low,Low,0,0,AnomaliesOnly,Initial Access,,AuthTeam@MyOrg.COM,\nDUV,\"Authorization check for user &C on object &A in scenario &B failed\",\"Authorization check for user &C on object &A in scenario &B failed\",Other,Non-Critical,Low,Low,0,0,AnomaliesOnly,Initial Access,,AuthTeam@MyOrg.COM,\nDUR,\"JSON RPC call of function module &A succeeded\",\"JSON RPC call of function module &A succeeded\",RFC Start,Non-Critical,Low,Low,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nDUS,\"JSON RPC call of function module &A failed\",\"JSON RPC call of function module &A failed\",RFC Start,Non-Critical,Low,Low,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nDUU,\"Authorization check for user &C on object &A in scenario &B successful\",\"Authorization check for user &C on object &A in scenario &B successful\",Other,Non-Critical,Low,Low,0,0,AnomaliesOnly,Initial Access,,AuthTeam@MyOrg.COM,\nAUB,\"Authorizations for user &A changed.\",\"The authorizations of the user specified in the message were changed.\",User Master Record Change,Severe,Medium,Medium,30,60,AnomaliesOnly,Initial Access,,AuthTeam@MyOrg.COM,MassiveAuthChangesOK\nEUH,\"Authorizations of user &A for authorization object &B detected\",\"Authorizations of user &A for authorization object &B detected\",User Master Record Change,Non-Critical,Low,Low,0,0,AnomaliesOnly,Initial Access,,AuthTeam@MyOrg.COM,\nDUW,\"Data target accessed in BW &A\",\"Data target accessed in BW &A\",Other,Non-Critical,Low,Low,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nDUX,\"TEMP: Customer-specific event DUX &A &B &C &D\",\"TEMP: Customer-specific event DUX &A &B &C &D\",Other,Non-Critical,Low,Low,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nDUY,\"TEMP: Customer-specific event DUY &A &B &C &D\",\"TEMP: Customer-specific event DUY &A &B &C &D\",Other,Non-Critical,Low,Low,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nDUZ,\"TEMP: Customer-specific event DUZ &A &B &C &D\",\"TEMP: Customer-specific event DUZ &A &B &C &D\",Other,Non-Critical,Low,Low,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nEU0,\"Test Message for Class EU\",\"Test Message for Class EU\",Other,Non-Critical,Low,Low,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nEU1,\"System change options changed ( &A to &B )\",\"System change options changed ( &A to &B )\",System,Critical,Low,High,0,0,Deterministic,Defense Evasion,,BasisTeam@MyOrg.COM,\nEU2,\"Client &A settings changed ( &B )\",\"Client &A settings changed ( &B )\",System,Critical,High,High,0,0,Deterministic,Defense Evasion,,BasisTeam@MyOrg.COM,\nEU3,\"&A change documents deleted without archiving (&B)\",\"&A change documents deleted without archiving (&B)\",Other,Critical,High,High,0,0,Deterministic,Impact,,BasisTeam@MyOrg.COM,\nEU4,\"Validation successful for logical file name &A (physical: &B)\",\"Validation successful for logical file name &A (physical: &B)\",Other,Non-Critical,Low,Low,0,0,AnomaliesOnly,Exfiltration,,SOCTeam@MyOrg.COM,\nEU5,\"Audit log data of &A was deleted (&B data records)\",\"Audit log data of &A was deleted (&B data records)\",System,Non-Critical,Low,Low,0,0,AnomaliesOnly,,,BasisTeam@MyOrg.COM,\nEUA,\"S/2 Cloud SDK ABAP component called\",\"S/2 Cloud SDK ABAP component called\",Transaction Start,Non-Critical,Low,Low,0,0,AnomaliesOnly,,,AuthTeam@MyOrg.COM,\nEUB,\"Could not verify the digital signature: &A\",\"Could not verify the digital signature: &A\",Other,Critical,High,High,0,0,Deterministic,,,SOCTeam@MyOrg.COM,\nEUC,\"OAuth scope &A not assigned to the user\",\"OAuth scope &A not assigned to the user\",Logon,Critical,High,High,0,0,Deterministic,Initial Access,,AuthTeam@MyOrg.COM,\nEUD,\"HTTP request not received from trustworthy cloud connector (reason &A)\",\"HTTP request not received from trustworthy cloud connector (reason &A)\",Logon,Critical,High,High,0,0,Deterministic,Credential Access,,SOCTeam@MyOrg.COM,\nEUE,\"RFC function module &A called successfully\",\"RFC function module &A called successfully\",RFC Start,Non-Critical,Low,Low,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nEUF,\"Could not call RFC function module &A\",\"Could not call RFC function module &A\",RFC Start,Non-Critical,Low,Low,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nDUT,\"Critical JSON RPC call of function module &A (S_RFC * authorization)\",\"Critical JSON RPC call of function module &A (S_RFC * authorization)\",RFC Start,Critical,High,High,0,0,AnomaliesOnly,Initial Access,,AuthTeam@MyOrg.COM,\nEUG,\"User does not have authorization to run RFC function module &A\",\"User does not have authorization to run RFC function module &A\",RFC Start,Non-Critical,Low,Low,0,0,AnomaliesOnly,Initial Access,,AuthTeam@MyOrg.COM,\nEUI,\"Setup of UCON HTTP allowlist changed\",\"Setup of UCON HTTP allowlist changed\",RFC Start,Severe,Medium,Medium,0,0,AnomaliesOnly,Lateral Movement,,SOCTeam@MyOrg.COM,\nEUJ,\"Phase of UCON HTTP allowlist of context type &A changed\",\"Phase of UCON HTTP allowlist of context type &A changed\",RFC Start,Severe,Medium,Medium,0,0,AnomaliesOnly,Lateral Movement,,SOCTeam@MyOrg.COM,\nEUK,\"Access to UCON HTTP allowlist of context type &A was refused\",\"Access to UCON HTTP allowlist of context type &A was refused\",RFC Start,Critical,High,High,0,0,AnomaliesOnly,Lateral Movement,,SOCTeam@MyOrg.COM,\nEUL,\"HTTP security header register was changed for &A\",\"HTTP security header register was changed for &A\",RFC Start,Severe,Medium,Medium,0,0,AnomaliesOnly,Credential Access,,SOCTeam@MyOrg.COM,\nEUM,\"Trusted site list &A for HTTP security header was changed\",\"Trusted site list &A for HTTP security header was changed\",RFC Start,Severe,Medium,Medium,0,0,AnomaliesOnly,Credential Access,,SOCTeam@MyOrg.COM,\nEUN,\"Content security policy for service &A was violated\",\"Content security policy for service &A was violated\",RFC Start,Critical,High,High,0,0,Deterministic,Credential Access,,SOCTeam@MyOrg.COM,\nEUO,\"UCON HTTP allowlist of context type &A was changed\",\"UCON HTTP allowlist of context type &A was changed\",RFC Start,Severe,Medium,Medium,0,0,AnomaliesOnly,Credential Access,,SOCTeam@MyOrg.COM,\nEUP,\"Virtual user client=&A type=&B action=&C &D\",\"Virtual user client=&A type=&B action=&C &D\",Logon,Critical,High,High,0,0,AnomaliesOnly,Credential Access,,SOCTeam@MyOrg.COM,\nEUV,\"CDS view &A (field &B) was published\",\"CDS view &A (field &B) was published\",Other,Non-Critical,Low,Low,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nEUW,\"blocklisting is activated (connection/table/field: &A &B &C)\",\"blocklisting is activated (connection/table/field: &A &B &C)\",Other,Non-Critical,Low,Low,0,0,AnomaliesOnly,,,BasisTeam@MyOrg.COM,\nEUX,\"blocklisting is deactivated (connection/table/field: &A &B &C)\",\"blocklisting is deactivated (connection/table/field: &A &B &C)\",Other,Non-Critical,Low,Low,0,0,AnomaliesOnly,,,BasisTeam@MyOrg.COM,\nEUY,\"Data blocking activated for &A\",\"Data blocking activated for &A\",Other,Non-Critical,Low,Low,0,0,AnomaliesOnly,,,BasisTeam@MyOrg.COM,\nEUZ,\"Data blocking deactivated for &A\",\"Data blocking deactivated for &A\",Other,Non-Critical,Low,Low,0,0,AnomaliesOnly,,,BasisTeam@MyOrg.COM,\nFU0,\"Exclusive security audit log medium changed (new status &A)\",\"Exclusive security audit log medium changed (new status &A)\",System,Critical,High,High,0,0,Deterministic,Defense Evasion,,BasisTeam@MyOrg.COM,\nFU1,\"RFC function &B with dynamic destination &C was called in program &A\",\"RFC function &B with dynamic destination &C was called in program &A\",RFC Start,Non-Critical,Low,Low,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nFU2,\"Parsing of an XML data stream canceled for security reasons (reason = &A)\",\"Parsing of an XML data stream canceled for security reasons (reason = &A)\",Other,Severe,Medium,Medium,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nFU3,\"Template &A (&B) loaded\",\"Template &A (&B) loaded\",Other,Non-Critical,Low,Low,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nFU4,\"Could not upload template &A\",\"Could not upload template &A\",Other,Severe,Medium,Medium,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nFU8,\"Lock entry deleted for user &A\",\"Lock entry deleted for user &A\",User Master Record Change,Severe,Medium,Medium,0,0,AnomaliesOnly,Impact,,AuthTeam@MyOrg.COM,\nFUA,\"Audit alert:  &A | &B &C &D\",\"Audit alert:  &A | &B &C &D\",Other,Critical,High,High,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nFUB,\"TEMP: Customer-specific event FUB &A &B &C &D\",\"TEMP: Customer-specific event FUB &A &B &C &D\",Other,Critical,High,High,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nFUC,\"Attempted read on output document &A for object &B ( &C )\",\"Attempted read on output document &A for object &B ( &C )\",Other,Non-Critical,Low,Low,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nFUD,\"Successful read on output document &A for object &B ( &C )\",\"Successful read on output document &A for object &B ( &C )\",Other,Non-Critical,Low,Low,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nFUE,\"Failed read on output document &A for object &B ( &C )\",\"Failed read on output document &A for object &B ( &C )\",Other,Non-Critical,Low,Low,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nNU0,\"Audit - Test. Text: &A\",\"Audit - Test. Text: &A\",Other,Non-Critical,Low,Low,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\nWEBDYNPRO_RT 007,\"Web Dynpro ABAP\",\"Web Dynpro ABAP\",Web Dynpro ABAP,Low,Low,Low,0,0,AnomaliesOnly,,,SOCTeam@MyOrg.COM,\n",
                "watchlistAlias": "SAP_Dynamic_Audit_Log_Monitor_Configuration",
                "contentType": "text/csv"
            },
            "condition": "[parameters('wl_20_creation_required')]"
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/Watchlists",
            "apiVersion": "2023-02-01",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/SAP_User_Config')]",
            "properties": {
                "description": "SAP VIP Users allows for fine tunning alerts by excluding users and including users in specific contexts.",
                "displayName": "SAP_User_Config",
                "source": "ContentHub",
                "provider": "Microsoft",
                "numberOfLinesToSkip": 0,
                "itemsSearchKey": "SAPUser",
                "rawContent": "SAPUser,User Identifier,User AAD Object Id,User On-Prem Sid,User Principal Name,Tags\nALEREMOTE,-,-,-,SAP batch user,Sensitive; Super; Batch; MassiveLogonsOK; MassiveRFCOK; GenericTablebyRFCOK\nBWREMOTE,,,,,Sensitive; Super; Batch; MassiveLogonsOK; MassiveRFCOK; GenericTablebyRFCOK\nDDIC,-,-,-,SAP dictionary user,Sensitive; Super; MassiveLogonsOK; MassiveRFCOK; GenericTablebyRFCOK\nSAP_SYSTEM,,,,,Automation; MassiveLogonsOK; MassiveRFCOK; GenericTablebyRFCOK\nOSS,,,,,SpecialAttention\nSENTINEL,,,,,Automation; MassiveLogonsOK; MassiveRFCOK; GenericTablebyRFCOK\nEmployeeSoonToLeave,,,,,SoonToLeave\n",
                "watchlistAlias": "SAP_User_Config",
                "contentType": "text/csv"
            },
            "condition": "[parameters('wl_21_creation_required')]"
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/contentPackages",
            "apiVersion": "2023-04-01-preview",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('_solutionId'))]",
            "location": "[parameters('workspace-location')]",
            "properties": {
                "version": "3.0.0",
                "kind": "Solution",
                "contentSchemaVersion": "3.0.0",
                "displayName": "SAP",
                "publisherDisplayName": "Microsoft Sentinel, Microsoft Corporation",
                "descriptionHtml": "<p><strong>Note:</strong> <em>There may be <a href=\"https://aka.ms/sentinelsolutionsknownissues\">known issues</a> pertaining to this Solution, please refer to them before installing.</em></p>\n<p>SAP is synonymous with enterprise business. It drives multiple business applications and is the custodian for massive amounts of critical, sensitive data. SAP systems are growing in complexity as organizations expand beyond the base capabilities. This growth causes security risk to rise and allows threats to emerge across modules, so threat correlation is an important part of ensuring SAP security. The Microsoft Sentinel Continuous Threat Monitoring for SAP provides comprehensive and continuous threat detection and analytics, effectively identifying real threats and malicious behaviours. Microsoft Sentinel has built-in API connectors to natively collect transaction logs necessary for monitoring SAP and includes out of the box security content (detections, dashboard) for securing SAP NetWeaver system in Azure and outside of Azure as well. The Microsoft Sentinel solution for SAP applications is SAP Certified for Integration with RISE with SAP, S/4HANA Cloud and SAP NetWeaver.</p>\n<p><strong>Data Connectors:</strong> 1, <strong>Parsers:</strong> 58, <strong>Workbooks:</strong> 3, <strong>Analytic Rules:</strong> 62, <strong>Watchlists:</strong> 21, <strong>Playbooks:</strong> 3</p>\n<p><a href=\"https://aka.ms/azuresentinel\">Learn more about Microsoft Sentinel</a> | <a href=\"https://aka.ms/azuresentinelsolutionsdoc\">Learn more about Solutions</a></p>\n",
                "contentKind": "Solution",
                "contentProductId": "[variables('_solutioncontentProductId')]",
                "id": "[variables('_solutioncontentProductId')]",
                "icon": "<img src=\"https://store-images.s-microsoft.com/image/apps.34104.ee2d31a6-a2e0-4211-aa4a-6c9256ad6fc3.6f2e173b-d2d4-4e34-9e50-f9bee1dcd1c1.42c18ca4-8388-413d-b4ee-37df356efe27\" width=\"75px\" height=\"75px\">",
                "contentId": "[variables('_solutionId')]",
                "parentId": "[variables('_solutionId')]",
                "source": {
                    "kind": "Solution",
                    "name": "SAP",
                    "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                    "name": "Microsoft",
                    "email": "[variables('_email')]"
                },
                "support": {
                    "name": "Microsoft Corporation",
                    "email": "support@microsoft.com",
                    "tier": "Microsoft",
                    "link": "https://support.microsoft.com/"
                },
                "dependencies": {
                    "operator": "AND",
                    "criteria": [
                        {
                            "kind": "DataConnector",
                            "contentId": "[variables('_dataConnectorContentId1')]",
                            "version": "[variables('dataConnectorVersion1')]"
                        },
                        {
                            "kind": "Workbook",
                            "contentId": "[variables('_workbookContentId1')]",
                            "version": "[variables('workbookVersion1')]"
                        },
                        {
                            "kind": "Workbook",
                            "contentId": "[variables('_workbookContentId2')]",
                            "version": "[variables('workbookVersion2')]"
                        },
                        {
                            "kind": "Workbook",
                            "contentId": "[variables('_workbookContentId3')]",
                            "version": "[variables('workbookVersion3')]"
                        },
                        {
                            "kind": "AnalyticsRule",
                            "contentId": "[variables('analyticRuleObject1')._analyticRulecontentId1]",
                            "version": "[variables('analyticRuleObject1').analyticRuleVersion1]"
                        },
                        {
                            "kind": "AnalyticsRule",
                            "contentId": "[variables('analyticRuleObject2')._analyticRulecontentId2]",
                            "version": "[variables('analyticRuleObject2').analyticRuleVersion2]"
                        },
                        {
                            "kind": "AnalyticsRule",
                            "contentId": "[variables('analyticRuleObject3')._analyticRulecontentId3]",
                            "version": "[variables('analyticRuleObject3').analyticRuleVersion3]"
                        },
                        {
                            "kind": "AnalyticsRule",
                            "contentId": "[variables('analyticRuleObject4')._analyticRulecontentId4]",
                            "version": "[variables('analyticRuleObject4').analyticRuleVersion4]"
                        },
                        {
                            "kind": "AnalyticsRule",
                            "contentId": "[variables('analyticRuleObject5')._analyticRulecontentId5]",
                            "version": "[variables('analyticRuleObject5').analyticRuleVersion5]"
                        },
                        {
                            "kind": "AnalyticsRule",
                            "contentId": "[variables('analyticRuleObject6')._analyticRulecontentId6]",
                            "version": "[variables('analyticRuleObject6').analyticRuleVersion6]"
                        },
                        {
                            "kind": "AnalyticsRule",
                            "contentId": "[variables('analyticRuleObject7')._analyticRulecontentId7]",
                            "version": "[variables('analyticRuleObject7').analyticRuleVersion7]"
                        },
                        {
                            "kind": "AnalyticsRule",
                            "contentId": "[variables('analyticRuleObject8')._analyticRulecontentId8]",
                            "version": "[variables('analyticRuleObject8').analyticRuleVersion8]"
                        },
                        {
                            "kind": "AnalyticsRule",
                            "contentId": "[variables('analyticRuleObject9')._analyticRulecontentId9]",
                            "version": "[variables('analyticRuleObject9').analyticRuleVersion9]"
                        },
                        {
                            "kind": "AnalyticsRule",
                            "contentId": "[variables('analyticRuleObject10')._analyticRulecontentId10]",
                            "version": "[variables('analyticRuleObject10').analyticRuleVersion10]"
                        },
                        {
                            "kind": "AnalyticsRule",
                            "contentId": "[variables('analyticRuleObject11')._analyticRulecontentId11]",
                            "version": "[variables('analyticRuleObject11').analyticRuleVersion11]"
                        },
                        {
                            "kind": "AnalyticsRule",
                            "contentId": "[variables('analyticRuleObject12')._analyticRulecontentId12]",
                            "version": "[variables('analyticRuleObject12').analyticRuleVersion12]"
                        },
                        {
                            "kind": "AnalyticsRule",
                            "contentId": "[variables('analyticRuleObject13')._analyticRulecontentId13]",
                            "version": "[variables('analyticRuleObject13').analyticRuleVersion13]"
                        },
                        {
                            "kind": "AnalyticsRule",
                            "contentId": "[variables('analyticRuleObject14')._analyticRulecontentId14]",
                            "version": "[variables('analyticRuleObject14').analyticRuleVersion14]"
                        },
                        {
                            "kind": "AnalyticsRule",
                            "contentId": "[variables('analyticRuleObject15')._analyticRulecontentId15]",
                            "version": "[variables('analyticRuleObject15').analyticRuleVersion15]"
                        },
                        {
                            "kind": "AnalyticsRule",
                            "contentId": "[variables('analyticRuleObject16')._analyticRulecontentId16]",
                            "version": "[variables('analyticRuleObject16').analyticRuleVersion16]"
                        },
                        {
                            "kind": "AnalyticsRule",
                            "contentId": "[variables('analyticRuleObject17')._analyticRulecontentId17]",
                            "version": "[variables('analyticRuleObject17').analyticRuleVersion17]"
                        },
                        {
                            "kind": "AnalyticsRule",
                            "contentId": "[variables('analyticRuleObject18')._analyticRulecontentId18]",
                            "version": "[variables('analyticRuleObject18').analyticRuleVersion18]"
                        },
                        {
                            "kind": "AnalyticsRule",
                            "contentId": "[variables('analyticRuleObject19')._analyticRulecontentId19]",
                            "version": "[variables('analyticRuleObject19').analyticRuleVersion19]"
                        },
                        {
                            "kind": "AnalyticsRule",
                            "contentId": "[variables('analyticRuleObject20')._analyticRulecontentId20]",
                            "version": "[variables('analyticRuleObject20').analyticRuleVersion20]"
                        },
                        {
                            "kind": "AnalyticsRule",
                            "contentId": "[variables('analyticRuleObject21')._analyticRulecontentId21]",
                            "version": "[variables('analyticRuleObject21').analyticRuleVersion21]"
                        },
                        {
                            "kind": "AnalyticsRule",
                            "contentId": "[variables('analyticRuleObject22')._analyticRulecontentId22]",
                            "version": "[variables('analyticRuleObject22').analyticRuleVersion22]"
                        },
                        {
                            "kind": "AnalyticsRule",
                            "contentId": "[variables('analyticRuleObject23')._analyticRulecontentId23]",
                            "version": "[variables('analyticRuleObject23').analyticRuleVersion23]"
                        },
                        {
                            "kind": "AnalyticsRule",
                            "contentId": "[variables('analyticRuleObject24')._analyticRulecontentId24]",
                            "version": "[variables('analyticRuleObject24').analyticRuleVersion24]"
                        },
                        {
                            "kind": "AnalyticsRule",
                            "contentId": "[variables('analyticRuleObject25')._analyticRulecontentId25]",
                            "version": "[variables('analyticRuleObject25').analyticRuleVersion25]"
                        },
                        {
                            "kind": "AnalyticsRule",
                            "contentId": "[variables('analyticRuleObject26')._analyticRulecontentId26]",
                            "version": "[variables('analyticRuleObject26').analyticRuleVersion26]"
                        },
                        {
                            "kind": "AnalyticsRule",
                            "contentId": "[variables('analyticRuleObject27')._analyticRulecontentId27]",
                            "version": "[variables('analyticRuleObject27').analyticRuleVersion27]"
                        },
                        {
                            "kind": "AnalyticsRule",
                            "contentId": "[variables('analyticRuleObject28')._analyticRulecontentId28]",
                            "version": "[variables('analyticRuleObject28').analyticRuleVersion28]"
                        },
                        {
                            "kind": "AnalyticsRule",
                            "contentId": "[variables('analyticRuleObject29')._analyticRulecontentId29]",
                            "version": "[variables('analyticRuleObject29').analyticRuleVersion29]"
                        },
                        {
                            "kind": "AnalyticsRule",
                            "contentId": "[variables('analyticRuleObject30')._analyticRulecontentId30]",
                            "version": "[variables('analyticRuleObject30').analyticRuleVersion30]"
                        },
                        {
                            "kind": "AnalyticsRule",
                            "contentId": "[variables('analyticRuleObject31')._analyticRulecontentId31]",
                            "version": "[variables('analyticRuleObject31').analyticRuleVersion31]"
                        },
                        {
                            "kind": "AnalyticsRule",
                            "contentId": "[variables('analyticRuleObject32')._analyticRulecontentId32]",
                            "version": "[variables('analyticRuleObject32').analyticRuleVersion32]"
                        },
                        {
                            "kind": "AnalyticsRule",
                            "contentId": "[variables('analyticRuleObject33')._analyticRulecontentId33]",
                            "version": "[variables('analyticRuleObject33').analyticRuleVersion33]"
                        },
                        {
                            "kind": "AnalyticsRule",
                            "contentId": "[variables('analyticRuleObject34')._analyticRulecontentId34]",
                            "version": "[variables('analyticRuleObject34').analyticRuleVersion34]"
                        },
                        {
                            "kind": "AnalyticsRule",
                            "contentId": "[variables('analyticRuleObject35')._analyticRulecontentId35]",
                            "version": "[variables('analyticRuleObject35').analyticRuleVersion35]"
                        },
                        {
                            "kind": "AnalyticsRule",
                            "contentId": "[variables('analyticRuleObject36')._analyticRulecontentId36]",
                            "version": "[variables('analyticRuleObject36').analyticRuleVersion36]"
                        },
                        {
                            "kind": "AnalyticsRule",
                            "contentId": "[variables('analyticRuleObject37')._analyticRulecontentId37]",
                            "version": "[variables('analyticRuleObject37').analyticRuleVersion37]"
                        },
                        {
                            "kind": "AnalyticsRule",
                            "contentId": "[variables('analyticRuleObject38')._analyticRulecontentId38]",
                            "version": "[variables('analyticRuleObject38').analyticRuleVersion38]"
                        },
                        {
                            "kind": "AnalyticsRule",
                            "contentId": "[variables('analyticRuleObject39')._analyticRulecontentId39]",
                            "version": "[variables('analyticRuleObject39').analyticRuleVersion39]"
                        },
                        {
                            "kind": "AnalyticsRule",
                            "contentId": "[variables('analyticRuleObject40')._analyticRulecontentId40]",
                            "version": "[variables('analyticRuleObject40').analyticRuleVersion40]"
                        },
                        {
                            "kind": "AnalyticsRule",
                            "contentId": "[variables('analyticRuleObject41')._analyticRulecontentId41]",
                            "version": "[variables('analyticRuleObject41').analyticRuleVersion41]"
                        },
                        {
                            "kind": "AnalyticsRule",
                            "contentId": "[variables('analyticRuleObject42')._analyticRulecontentId42]",
                            "version": "[variables('analyticRuleObject42').analyticRuleVersion42]"
                        },
                        {
                            "kind": "AnalyticsRule",
                            "contentId": "[variables('analyticRuleObject43')._analyticRulecontentId43]",
                            "version": "[variables('analyticRuleObject43').analyticRuleVersion43]"
                        },
                        {
                            "kind": "AnalyticsRule",
                            "contentId": "[variables('analyticRuleObject44')._analyticRulecontentId44]",
                            "version": "[variables('analyticRuleObject44').analyticRuleVersion44]"
                        },
                        {
                            "kind": "AnalyticsRule",
                            "contentId": "[variables('analyticRuleObject45')._analyticRulecontentId45]",
                            "version": "[variables('analyticRuleObject45').analyticRuleVersion45]"
                        },
                        {
                            "kind": "AnalyticsRule",
                            "contentId": "[variables('analyticRuleObject46')._analyticRulecontentId46]",
                            "version": "[variables('analyticRuleObject46').analyticRuleVersion46]"
                        },
                        {
                            "kind": "AnalyticsRule",
                            "contentId": "[variables('analyticRuleObject47')._analyticRulecontentId47]",
                            "version": "[variables('analyticRuleObject47').analyticRuleVersion47]"
                        },
                        {
                            "kind": "AnalyticsRule",
                            "contentId": "[variables('analyticRuleObject48')._analyticRulecontentId48]",
                            "version": "[variables('analyticRuleObject48').analyticRuleVersion48]"
                        },
                        {
                            "kind": "AnalyticsRule",
                            "contentId": "[variables('analyticRuleObject49')._analyticRulecontentId49]",
                            "version": "[variables('analyticRuleObject49').analyticRuleVersion49]"
                        },
                        {
                            "kind": "AnalyticsRule",
                            "contentId": "[variables('analyticRuleObject50')._analyticRulecontentId50]",
                            "version": "[variables('analyticRuleObject50').analyticRuleVersion50]"
                        },
                        {
                            "kind": "AnalyticsRule",
                            "contentId": "[variables('analyticRuleObject51')._analyticRulecontentId51]",
                            "version": "[variables('analyticRuleObject51').analyticRuleVersion51]"
                        },
                        {
                            "kind": "AnalyticsRule",
                            "contentId": "[variables('analyticRuleObject52')._analyticRulecontentId52]",
                            "version": "[variables('analyticRuleObject52').analyticRuleVersion52]"
                        },
                        {
                            "kind": "AnalyticsRule",
                            "contentId": "[variables('analyticRuleObject53')._analyticRulecontentId53]",
                            "version": "[variables('analyticRuleObject53').analyticRuleVersion53]"
                        },
                        {
                            "kind": "AnalyticsRule",
                            "contentId": "[variables('analyticRuleObject54')._analyticRulecontentId54]",
                            "version": "[variables('analyticRuleObject54').analyticRuleVersion54]"
                        },
                        {
                            "kind": "AnalyticsRule",
                            "contentId": "[variables('analyticRuleObject55')._analyticRulecontentId55]",
                            "version": "[variables('analyticRuleObject55').analyticRuleVersion55]"
                        },
                        {
                            "kind": "AnalyticsRule",
                            "contentId": "[variables('analyticRuleObject56')._analyticRulecontentId56]",
                            "version": "[variables('analyticRuleObject56').analyticRuleVersion56]"
                        },
                        {
                            "kind": "AnalyticsRule",
                            "contentId": "[variables('analyticRuleObject57')._analyticRulecontentId57]",
                            "version": "[variables('analyticRuleObject57').analyticRuleVersion57]"
                        },
                        {
                            "kind": "AnalyticsRule",
                            "contentId": "[variables('analyticRuleObject58')._analyticRulecontentId58]",
                            "version": "[variables('analyticRuleObject58').analyticRuleVersion58]"
                        },
                        {
                            "kind": "AnalyticsRule",
                            "contentId": "[variables('analyticRuleObject59')._analyticRulecontentId59]",
                            "version": "[variables('analyticRuleObject59').analyticRuleVersion59]"
                        },
                        {
                            "kind": "AnalyticsRule",
                            "contentId": "[variables('analyticRuleObject60')._analyticRulecontentId60]",
                            "version": "[variables('analyticRuleObject60').analyticRuleVersion60]"
                        },
                        {
                            "kind": "AnalyticsRule",
                            "contentId": "[variables('analyticRuleObject61')._analyticRulecontentId61]",
                            "version": "[variables('analyticRuleObject61').analyticRuleVersion61]"
                        },
                        {
                            "kind": "AnalyticsRule",
                            "contentId": "[variables('analyticRuleObject62')._analyticRulecontentId62]",
                            "version": "[variables('analyticRuleObject62').analyticRuleVersion62]"
                        },
                        {
                            "kind": "Playbook",
                            "contentId": "[variables('_SAPLockUser-Advanced')]",
                            "version": "[variables('playbookVersion1')]"
                        },
                        {
                            "kind": "Playbook",
                            "contentId": "[variables('_SAPLockUser-Basic')]",
                            "version": "[variables('playbookVersion2')]"
                        },
                        {
                            "kind": "Playbook",
                            "contentId": "[variables('_SAPReEnableAuditLog')]",
                            "version": "[variables('playbookVersion3')]"
                        },
                        {
                            "kind": "Parser",
                            "contentId": "[variables('parserObject1').parserContentId1]",
                            "version": "[variables('parserObject1').parserVersion1]"
                        },
                        {
                            "kind": "Parser",
                            "contentId": "[variables('parserObject2').parserContentId2]",
                            "version": "[variables('parserObject2').parserVersion2]"
                        },
                        {
                            "kind": "Parser",
                            "contentId": "[variables('parserObject3').parserContentId3]",
                            "version": "[variables('parserObject3').parserVersion3]"
                        },
                        {
                            "kind": "Parser",
                            "contentId": "[variables('parserObject4').parserContentId4]",
                            "version": "[variables('parserObject4').parserVersion4]"
                        },
                        {
                            "kind": "Parser",
                            "contentId": "[variables('parserObject5').parserContentId5]",
                            "version": "[variables('parserObject5').parserVersion5]"
                        },
                        {
                            "kind": "Parser",
                            "contentId": "[variables('parserObject6').parserContentId6]",
                            "version": "[variables('parserObject6').parserVersion6]"
                        },
                        {
                            "kind": "Parser",
                            "contentId": "[variables('parserObject7').parserContentId7]",
                            "version": "[variables('parserObject7').parserVersion7]"
                        },
                        {
                            "kind": "Parser",
                            "contentId": "[variables('parserObject8').parserContentId8]",
                            "version": "[variables('parserObject8').parserVersion8]"
                        },
                        {
                            "kind": "Parser",
                            "contentId": "[variables('parserObject9').parserContentId9]",
                            "version": "[variables('parserObject9').parserVersion9]"
                        },
                        {
                            "kind": "Parser",
                            "contentId": "[variables('parserObject10').parserContentId10]",
                            "version": "[variables('parserObject10').parserVersion10]"
                        },
                        {
                            "kind": "Parser",
                            "contentId": "[variables('parserObject11').parserContentId11]",
                            "version": "[variables('parserObject11').parserVersion11]"
                        },
                        {
                            "kind": "Parser",
                            "contentId": "[variables('parserObject12').parserContentId12]",
                            "version": "[variables('parserObject12').parserVersion12]"
                        },
                        {
                            "kind": "Parser",
                            "contentId": "[variables('parserObject13').parserContentId13]",
                            "version": "[variables('parserObject13').parserVersion13]"
                        },
                        {
                            "kind": "Parser",
                            "contentId": "[variables('parserObject14').parserContentId14]",
                            "version": "[variables('parserObject14').parserVersion14]"
                        },
                        {
                            "kind": "Parser",
                            "contentId": "[variables('parserObject15').parserContentId15]",
                            "version": "[variables('parserObject15').parserVersion15]"
                        },
                        {
                            "kind": "Parser",
                            "contentId": "[variables('parserObject16').parserContentId16]",
                            "version": "[variables('parserObject16').parserVersion16]"
                        },
                        {
                            "kind": "Parser",
                            "contentId": "[variables('parserObject17').parserContentId17]",
                            "version": "[variables('parserObject17').parserVersion17]"
                        },
                        {
                            "kind": "Parser",
                            "contentId": "[variables('parserObject18').parserContentId18]",
                            "version": "[variables('parserObject18').parserVersion18]"
                        },
                        {
                            "kind": "Parser",
                            "contentId": "[variables('parserObject19').parserContentId19]",
                            "version": "[variables('parserObject19').parserVersion19]"
                        },
                        {
                            "kind": "Parser",
                            "contentId": "[variables('parserObject20').parserContentId20]",
                            "version": "[variables('parserObject20').parserVersion20]"
                        },
                        {
                            "kind": "Parser",
                            "contentId": "[variables('parserObject21').parserContentId21]",
                            "version": "[variables('parserObject21').parserVersion21]"
                        },
                        {
                            "kind": "Parser",
                            "contentId": "[variables('parserObject22').parserContentId22]",
                            "version": "[variables('parserObject22').parserVersion22]"
                        },
                        {
                            "kind": "Parser",
                            "contentId": "[variables('parserObject23').parserContentId23]",
                            "version": "[variables('parserObject23').parserVersion23]"
                        },
                        {
                            "kind": "Parser",
                            "contentId": "[variables('parserObject24').parserContentId24]",
                            "version": "[variables('parserObject24').parserVersion24]"
                        },
                        {
                            "kind": "Parser",
                            "contentId": "[variables('parserObject25').parserContentId25]",
                            "version": "[variables('parserObject25').parserVersion25]"
                        },
                        {
                            "kind": "Parser",
                            "contentId": "[variables('parserObject26').parserContentId26]",
                            "version": "[variables('parserObject26').parserVersion26]"
                        },
                        {
                            "kind": "Parser",
                            "contentId": "[variables('parserObject27').parserContentId27]",
                            "version": "[variables('parserObject27').parserVersion27]"
                        },
                        {
                            "kind": "Parser",
                            "contentId": "[variables('parserObject28').parserContentId28]",
                            "version": "[variables('parserObject28').parserVersion28]"
                        },
                        {
                            "kind": "Parser",
                            "contentId": "[variables('parserObject29').parserContentId29]",
                            "version": "[variables('parserObject29').parserVersion29]"
                        },
                        {
                            "kind": "Parser",
                            "contentId": "[variables('parserObject30').parserContentId30]",
                            "version": "[variables('parserObject30').parserVersion30]"
                        },
                        {
                            "kind": "Parser",
                            "contentId": "[variables('parserObject31').parserContentId31]",
                            "version": "[variables('parserObject31').parserVersion31]"
                        },
                        {
                            "kind": "Parser",
                            "contentId": "[variables('parserObject32').parserContentId32]",
                            "version": "[variables('parserObject32').parserVersion32]"
                        },
                        {
                            "kind": "Parser",
                            "contentId": "[variables('parserObject33').parserContentId33]",
                            "version": "[variables('parserObject33').parserVersion33]"
                        },
                        {
                            "kind": "Parser",
                            "contentId": "[variables('parserObject34').parserContentId34]",
                            "version": "[variables('parserObject34').parserVersion34]"
                        },
                        {
                            "kind": "Parser",
                            "contentId": "[variables('parserObject35').parserContentId35]",
                            "version": "[variables('parserObject35').parserVersion35]"
                        },
                        {
                            "kind": "Parser",
                            "contentId": "[variables('parserObject36').parserContentId36]",
                            "version": "[variables('parserObject36').parserVersion36]"
                        },
                        {
                            "kind": "Parser",
                            "contentId": "[variables('parserObject37').parserContentId37]",
                            "version": "[variables('parserObject37').parserVersion37]"
                        },
                        {
                            "kind": "Parser",
                            "contentId": "[variables('parserObject38').parserContentId38]",
                            "version": "[variables('parserObject38').parserVersion38]"
                        },
                        {
                            "kind": "Parser",
                            "contentId": "[variables('parserObject39').parserContentId39]",
                            "version": "[variables('parserObject39').parserVersion39]"
                        },
                        {
                            "kind": "Parser",
                            "contentId": "[variables('parserObject40').parserContentId40]",
                            "version": "[variables('parserObject40').parserVersion40]"
                        },
                        {
                            "kind": "Parser",
                            "contentId": "[variables('parserObject41').parserContentId41]",
                            "version": "[variables('parserObject41').parserVersion41]"
                        },
                        {
                            "kind": "Parser",
                            "contentId": "[variables('parserObject42').parserContentId42]",
                            "version": "[variables('parserObject42').parserVersion42]"
                        },
                        {
                            "kind": "Parser",
                            "contentId": "[variables('parserObject43').parserContentId43]",
                            "version": "[variables('parserObject43').parserVersion43]"
                        },
                        {
                            "kind": "Parser",
                            "contentId": "[variables('parserObject44').parserContentId44]",
                            "version": "[variables('parserObject44').parserVersion44]"
                        },
                        {
                            "kind": "Parser",
                            "contentId": "[variables('parserObject45').parserContentId45]",
                            "version": "[variables('parserObject45').parserVersion45]"
                        },
                        {
                            "kind": "Parser",
                            "contentId": "[variables('parserObject46').parserContentId46]",
                            "version": "[variables('parserObject46').parserVersion46]"
                        },
                        {
                            "kind": "Parser",
                            "contentId": "[variables('parserObject47').parserContentId47]",
                            "version": "[variables('parserObject47').parserVersion47]"
                        },
                        {
                            "kind": "Parser",
                            "contentId": "[variables('parserObject48').parserContentId48]",
                            "version": "[variables('parserObject48').parserVersion48]"
                        },
                        {
                            "kind": "Parser",
                            "contentId": "[variables('parserObject49').parserContentId49]",
                            "version": "[variables('parserObject49').parserVersion49]"
                        },
                        {
                            "kind": "Parser",
                            "contentId": "[variables('parserObject50').parserContentId50]",
                            "version": "[variables('parserObject50').parserVersion50]"
                        },
                        {
                            "kind": "Parser",
                            "contentId": "[variables('parserObject51').parserContentId51]",
                            "version": "[variables('parserObject51').parserVersion51]"
                        },
                        {
                            "kind": "Parser",
                            "contentId": "[variables('parserObject52').parserContentId52]",
                            "version": "[variables('parserObject52').parserVersion52]"
                        },
                        {
                            "kind": "Parser",
                            "contentId": "[variables('parserObject53').parserContentId53]",
                            "version": "[variables('parserObject53').parserVersion53]"
                        },
                        {
                            "kind": "Parser",
                            "contentId": "[variables('parserObject54').parserContentId54]",
                            "version": "[variables('parserObject54').parserVersion54]"
                        },
                        {
                            "kind": "Parser",
                            "contentId": "[variables('parserObject55').parserContentId55]",
                            "version": "[variables('parserObject55').parserVersion55]"
                        },
                        {
                            "kind": "Parser",
                            "contentId": "[variables('parserObject56').parserContentId56]",
                            "version": "[variables('parserObject56').parserVersion56]"
                        },
                        {
                            "kind": "Parser",
                            "contentId": "[variables('parserObject57').parserContentId57]",
                            "version": "[variables('parserObject57').parserVersion57]"
                        },
                        {
                            "kind": "Parser",
                            "contentId": "[variables('parserObject58').parserContentId58]",
                            "version": "[variables('parserObject58').parserVersion58]"
                        },
                        {
                            "kind": "Watchlist",
                            "contentId": "[variables('_SAP - Critical Authorizations')]",
                            "version": "3.0.0"
                        },
                        {
                            "kind": "Watchlist",
                            "contentId": "[variables('_SAP - Excluded Networks')]",
                            "version": "3.0.0"
                        },
                        {
                            "kind": "Watchlist",
                            "contentId": "[variables('_SAP - Excluded Users')]",
                            "version": "3.0.0"
                        },
                        {
                            "kind": "Watchlist",
                            "contentId": "[variables('_SAP - FTP Servers')]",
                            "version": "3.0.0"
                        },
                        {
                            "kind": "Watchlist",
                            "contentId": "[variables('_SAP - Networks')]",
                            "version": "3.0.0"
                        },
                        {
                            "kind": "Watchlist",
                            "contentId": "[variables('_SAP - Obsolete Function Modules')]",
                            "version": "3.0.0"
                        },
                        {
                            "kind": "Watchlist",
                            "contentId": "[variables('_SAP - Obsolete Programs')]",
                            "version": "3.0.0"
                        },
                        {
                            "kind": "Watchlist",
                            "contentId": "[variables('_SAP - Privileged Users')]",
                            "version": "3.0.0"
                        },
                        {
                            "kind": "Watchlist",
                            "contentId": "[variables('_SAP - Sensitive ABAP Programs')]",
                            "version": "3.0.0"
                        },
                        {
                            "kind": "Watchlist",
                            "contentId": "[variables('_SAP - Sensitive Function Modules')]",
                            "version": "3.0.0"
                        },
                        {
                            "kind": "Watchlist",
                            "contentId": "[variables('_SAP - Sensitive Profiles')]",
                            "version": "3.0.0"
                        },
                        {
                            "kind": "Watchlist",
                            "contentId": "[variables('_SAP - Sensitive Roles')]",
                            "version": "3.0.0"
                        },
                        {
                            "kind": "Watchlist",
                            "contentId": "[variables('_SAP - Sensitive Tables')]",
                            "version": "3.0.0"
                        },
                        {
                            "kind": "Watchlist",
                            "contentId": "[variables('_SAP - Sensitive Transactions')]",
                            "version": "3.0.0"
                        },
                        {
                            "kind": "Watchlist",
                            "contentId": "[variables('_SAP - Systems')]",
                            "version": "3.0.0"
                        },
                        {
                            "kind": "Watchlist",
                            "contentId": "[variables('_SAP - Transactions for ABAP Generations')]",
                            "version": "3.0.0"
                        },
                        {
                            "kind": "Watchlist",
                            "contentId": "[variables('_SAPAlertRulesMetadata')]",
                            "version": "3.0.0"
                        },
                        {
                            "kind": "Watchlist",
                            "contentId": "[variables('_SAPSolutionConfig')]",
                            "version": "3.0.0"
                        },
                        {
                            "kind": "Watchlist",
                            "contentId": "[variables('_SAPSystemParameters')]",
                            "version": "3.0.0"
                        },
                        {
                            "kind": "Watchlist",
                            "contentId": "[variables('_SAP_Dynamic_Audit_Log_Monitor_Configuration')]",
                            "version": "3.0.0"
                        },
                        {
                            "kind": "Watchlist",
                            "contentId": "[variables('_SAP_User_Config')]",
                            "version": "3.0.0"
                        }
                    ]
                },
                "firstPublishDate": "2022-05-06",
                "providers": [
                    "Microsoft"
                ],
                "categories": {
                    "domains": [
                        "Security - Threat Protection",
                        "Identity"
                    ]
                }
            }
        }
    ],
    "outputs": {}
}